<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Malta LC Guessing Game</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script src="https://unpkg.com/shpjs@latest/dist/shp.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pangolin&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>


    <style>
        /* Ensure the map and body take up the full screen */
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Pangolin', 'Inter', sans-serif;
        }

        #map {
            height: 100%;
            width: 100%;
            background-color: #00071d;
        }

        /* Custom Leaflet popup styling */
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
        }

        .leaflet-popup-content {
            margin: 15px;
            font-size: 14px;
        }


        /* Custom transition for UI elements */
        .transition-all {
            transition: all 0.3s ease-in-out;
        }

        /* Start Overlay Styles */
        #start-overlay {
            transition: opacity 1s;
        }

        #countdown {
            animation: pulse 0.305s infinite linear;
        }

        button {
            display: flex;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            100% {
                transform: scale(0.5);
                opacity: 0;
            }
        }

        dialog {
            z-index: 1001;
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translate(-50%, 0);
            background: none;
            transform-origin: 0 500%;
            opacity: 0.9;

            transition: display 0.2s allow-discrete, overlay 1s allow-discrete;

            animation: close 0.2s cubic-bezier(0.075, 0.82, 0.165, 1);

            &[open] {
                animation: open 0.6s cubic-bezier(0.075, 0.82, 0.165, 1);
            }
        }

        @keyframes open {
            from {
                opacity: 0;
                scale: 0.9;
            }

            to {
                opacity: 0.9;
                scale: 1;
            }
        }

        @keyframes close {
            from {
                opacity: 0.9;
                scale: 1;
            }

            to {
                opacity: 0;
                scale: 0.9;
            }
        }

        #guess-input {
            font-size: 2em;
            width: 90vw;
            text-align: center;
            background-color: black;
            color: white;
            z-index: 1001;
        }

        button:hover {
            color: rgb(132, 158, 255);
            text-decoration: underline;
        }

        .fixed-logo {
            z-index: 5002;
            width: fit-content;
            position: fixed;
            left: 0;
            top: 0;
        }

        .fixed-logo:hover {
            scale: 1.05;
        }
    </style>
</head>

<body class="bg-gray-100">
    <div style="position: fixed; bottom: 0; right: 0; z-index: 1001; color: white;"><img
            onclick="backgroundMusic.volume = (backgroundMusic.volume == 0) ? 0.2 : 0; musictoggle.src = (backgroundMusic.volume == 0) ? 'musicoff.png' : 'musicon.png'; "
            id="musictoggle" src="musicon.png" width="32" height="32"></div>

    <iframe style="display: none;" id="achievementsIframe" src="/achievements.html"></iframe>

    <a href="/" class="fixed-logo"><img id="logoimg" src="/assets/joe-logo.webp" width="100" alt="Logo"
            class="logo" /></a>
    <p href="/" style="color: white; margin-left: 100px; margin-top: 15px; scale: 1; pointer-events: none;"
        class="fixed-logo">Malta Local Council Guesser</p>

    <div id="start-overlay" class="fixed inset-0 bg-black z-[2000] flex items-center justify-center">
        <div s class="text-white text-5xl font-bold tracking-wider">
            <div style="font-size: 120px;" id="countdown" class="hidden">3</div>
            <div id="noncountdown" style="display: flex; flex-direction: column; gap: 0.2em;">
                <button style="display: none;" id="continueLastSave">Continue last save</button>
                <button onclick="handleStartClick(GAMEMODE.normal)">Normal Mode</button>
                <button onclick="handleStartClick(GAMEMODE.mouseless)">Mouseless
                    Mode</button>
                <button onclick="handleStartClick(GAMEMODE.flags)">Guess the Flag</button>
            </div>
        </div>
    </div>

    <div id="map"></div>


    <div id="flag-container" style="    border-top-right-radius: 10px; z-index: 1001;
    border-bottom-right-radius: 10px;
    overflow: hidden;
    position: fixed;
    left: 0;
    bottom: 70px;" class="hidden my-4 p-2 bg-white/70 backdrop-blur-sm">
        <img id="flag-image" src="" alt="Local Council Flag" class="h-40">
    </div>

    <div style="    width: 50vw; z-index: 1001;
    border-bottom-left-radius: 10px;
    border-bottom-right-radius: 10px;
    overflow: hidden;
    position: fixed;
    right: 10px;
    top: 0;" class="bg-white/70 backdrop-blur-sm shadow-lg max-w-lg w-full text-center transition-all" id="info-box">

        <div id="progress-container" class="mt-4">
            <p class="text-lg font-semibold text-gray-700">Time: <span style="font-family:monospace;" class="text-blue-600" id="stopwatch">00:00.00</span><br>Progress: <span id="progress-text"
                    class="font-bold text-blue-600">0 / 0</span></p>
            <div class="w-full bg-gray-200 h-2.5 mt-2">
                <div id="progress-bar" class="bg-blue-600 h-2.5" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <dialog id="guess-dialog">
        <input autocomplete="off" type="text" id="guess-input" style="opacity: 1;"
            class="w-full px-4 py-2 border border-gray-300 rounded-full focus:ring-2 focus:ring-blue-500 focus:outline-none"
            placeholder="Enter name...">
    </dialog>


    <div id="win-modal"
        class="hidden absolute inset-0 z-[1002] bg-green-500/80 flex items-center justify-center p-4 text-white text-center">
        <div class="transform transition-all scale-95 opacity-0" id="win-modal-content">
            <h1 class="text-6xl font-bold mb-4">ðŸŽ‰ You Win! ðŸŽ‰</h1>
            <p class="text-2xl mb-6">You've successfully named all the shapes!</p>
            <p class="text-2xl mb-6">Final Time: <span id="final-time">00:00.00</span></p>
            <button id="play-again"
                class="bg-white text-green-600 font-bold py-3 px-8 rounded-full text-lg hover:bg-gray-100 transition-transform hover:scale-105">Play
                Again</button>
        </div>
    </div>

    <script>
        // --- Global Variables ---
        let map;
        let geoJsonLayer;
        let selectedLayer;
        let totalShapes = 0;
        let guessedShapes = 0;
        let backgroundMusic;
        let currentFlagLayer = null; // To store the layer for the current flag guess

        const progressContainer = document.getElementById('progress-container');
        const progressText = document.getElementById('progress-text');
        const progressBar = document.getElementById('progress-bar');
        const infoBox = document.getElementById('info-box');

        const guessDialog = document.getElementById('guess-dialog');
        const guessInput = document.getElementById('guess-input');

        const winModal = document.getElementById('win-modal');
        const winModalContent = document.getElementById('win-modal-content');
        const playAgainBtn = document.getElementById('play-again');

        const startOverlay = document.getElementById('start-overlay');
        const countdown = document.getElementById('countdown');

        // New DOM elements for Flag Mode
        const flagContainer = document.getElementById('flag-container');
        const flagImage = document.getElementById('flag-image');

        // --- Styles for Shapes ---
        const defaultStyle = { color: "#3388ff", weight: 2, opacity: 1, fillColor: "#3388ff", fillOpacity: 0.3 };
        const highlightStyle = { color: "#ff7800", weight: 4, fillOpacity: 0.5 };
        const guessedStyle = { color: "#28a745", weight: 2, opacity: 1, fillColor: "#28a745", fillOpacity: 0.6, interactive: false };

        // --- Map Initialization (Blank Background) ---
        function initializeMap() {
            if (map) map.remove();


            // Initialize the map, restricting it to the bounds of Malta
            var myRenderer = L.svg({ padding: 1 });
            map = L.map('map', {
                wheelDebounceTime: 1,
                zoomAnimation: false,
                doubleClickZoom: false,
                minZoom: 10,
                renderer: myRenderer,
                zoomControl: true,
                attributionControl: false,
                wheelPxPerZoomLevel: 100,
            });



            map.on('load', function (e) {
                hideGuessModal();
            });
            map.on('movestart', function (e) {
                if (chosenGamemode === GAMEMODE.normal) {
                    hideGuessModal();
                }
            });

        }



        // --- Input Normalization ---
        /**
         * Normalizes a string for comparison by making it lowercase,
         * replacing special Maltese characters and diacritics, and handling hyphens.
         * Also ignores anything before the first dash (e.g., "l-isla" becomes "isla").
         * @param {string} str The string to normalize.
         * @returns {string} The normalized string.
         */
        function normalizeString(str) {
            if (!str) return '';
            let normalized = str.toLowerCase();

            // Specific Maltese character replacements
            normalized = normalized.replace(/Ä¡/g, 'g');
            normalized = normalized.replace(/Ä§/g, 'h');
            normalized = normalized.replace(/Ä‹/g, 'c');
            normalized = normalized.replace(/Å¼/g, 'z');

            // General diacritic removal
            normalized = normalized.normalize('NFD').replace(/[\u0300-\u036f]/g, '');

            // Replace hyphens and dashes with a space
            normalized = normalized.replace(/[-â€“â€”]/g, ' ');

            // Remove apostrophes
            normalized = normalized.replace(/[']/g, '');

            // Remove extra spaces and trim
            normalized = normalized.replace(/\s+/g, ' ').trim();

            // **Remove all letters before the last space unless "san" is present**
            if (!normalized.includes('san') && !normalized.includes('bay')) {
                const lastSpaceIndex = normalized.lastIndexOf(' ');
                if (lastSpaceIndex !== -1) {
                    normalized = normalized.substring(lastSpaceIndex + 1);
                }
            }

            return normalized;
        }



        // --- Game Logic ---
        function loadShapefile(buffer) {
            shp(buffer).then(function (geojson) {
                if (!geojson || (geojson.features && geojson.features.length === 0)) {
                    return;
                }
                const firstProps = geojson.features[0].properties;
                if (!firstProps || (firstProps.LAU_Name === undefined && firstProps.LAU_Latin === undefined)) {
                    return;
                }
                geoJsonLayer = L.geoJSON(geojson, { style: defaultStyle, onEachFeature }).addTo(map);
                map.fitBounds(geoJsonLayer.getBounds());
                map.panBy([0, 20]);
                totalShapes = geojson.features.length;
                updateProgress();

                progressContainer.classList.remove('hidden');
                infoBox.classList.add('md:w-auto');

                // If loading from save, apply saved progress
                if (shouldLoadSave) {
                    const { guessedIds } = loadProgressFromLocalStorage();
                    applySavedProgress(guessedIds);
                }

                // Start game based on mode after setup is complete
                if (chosenGamemode === GAMEMODE.flags) {
                    startNextFlagRound();
                } else if (chosenGamemode === GAMEMODE.mouseless) {
                    selectRandomUnguessedFeature();
                }

            }).catch(function (err) {
                console.error("Shapefile parsing error:", err);
            });
        }

        function onEachFeature(feature, layer) {
            layer.maltalocalityid = feature.properties.LocalityId || '';
            layer.isGuessed = false;
            layer.on({
                mouseover: highlightFeature,
                mouseout: resetHighlight,
                click: handleLayerClick
            });
        }

        // --- Feature Interaction ---
        function highlightFeature(e) {
            const layer = e.target;
            if (!layer.isGuessed) {
                layer.setStyle(highlightStyle);
                layer.bringToFront();
            }
        }

        function resetHighlight(e) {
            if (geoJsonLayer) {
                const layer = e.target;
                if (!layer.isGuessed && layer !== selectedLayer) {
                    geoJsonLayer.resetStyle(layer);
                }
            }
        }


        // NEW: Function to handle clicks based on game mode
        function handleLayerClick(e) {
            const clickedLayer = e.target;
            if (clickedLayer.isGuessed) return;

            if (chosenGamemode === GAMEMODE.flags) {
                // In flag mode, check if the clicked layer is the correct one for the current flag
                if (currentFlagLayer && clickedLayer.maltalocalityid === currentFlagLayer.maltalocalityid) {
                    selectFeatureForGuessing(e); // Correct shape, now prompt for the name
                } else {
                    // Optional: Visual feedback for a wrong click
                    clickedLayer.setStyle({ color: 'red', weight: 3 });
                    setTimeout(() => {
                        if (!clickedLayer.isGuessed) {
                            geoJsonLayer.resetStyle(clickedLayer);
                        }
                    }, 300);
                }
            } else {
                // For normal and mouseless modes, any click on an unguessed shape is valid
                selectFeatureForGuessing(e);
            }
        }


        function selectRandomUnguessedFeature() {
            if (!geoJsonLayer) return;

            const unguessedLayers = [];
            geoJsonLayer.eachLayer(layer => {
                if (!layer.isGuessed) {
                    unguessedLayers.push(layer);
                }
            });

            if (unguessedLayers.length > 0) {
                const randomLayer = unguessedLayers[Math.floor(Math.random() * unguessedLayers.length)];
                selectFeatureForGuessing({ target: randomLayer });
            }
        }

        function selectFeatureForGuessing(e) {
            guessInput.value = '';


            if (selectedLayer && !selectedLayer.isGuessed) {
                geoJsonLayer.resetStyle(selectedLayer);
            }
            selectedLayer = e.target;
            if (selectedLayer.isGuessed) {
                selectedLayer = null;
                return;
            }
            selectedLayer.setStyle(highlightStyle);
            selectedLayer.bringToFront();

            setTimeout(() => {
                selectedLayer.setStyle(highlightStyle);
                selectedLayer.bringToFront();
            }, 10);
            showGuessModal();

        }

        // --- Guessing Logic ---
        function handleCorrectGuess() {
            if (!selectedLayer || selectedLayer.isGuessed) return; // Prevent double processing

            selectedLayer.isGuessed = true;
            selectedLayer.setStyle(guessedStyle);
            selectedLayer.unbindPopup();
            selectedLayer.off('click mouseover mouseout');

            guessedShapes++;
            updateProgress();
            saveProgressToLocalStorage();
            hideGuessModal(); // Just closes the dialog now

            const correctAudio = new Audio('correct.mp3');
            correctAudio.play();

            if (guessedShapes === totalShapes) {
                showWinScreen();
            } else {
                // Move to the next round based on game mode
                if (chosenGamemode === GAMEMODE.flags) {
                    startNextFlagRound();
                } else if (chosenGamemode === GAMEMODE.mouseless) {
                    selectRandomUnguessedFeature();
                }
            }
        }

        let altNamesData = null;

        async function loadAltNames() {
            try {
                const response = await fetch('altnames.json');
                altNamesData = await response.json();
                console.log('altnames.json loaded');
            } catch (error) {
                console.error('Failed to load altnames.json:', error);
            }
        }

        function getLocalityNames(localityId) {
            if (!altNamesData) {
                return [];
            }
            const locality = altNamesData.find(item => item.LocalityId === localityId);
            if (!locality) {
                return [];
            }
            return [...new Set(locality.Names.split(',').map(name => name.trim()).filter(name => name.length > 0))];
        }

        window.addEventListener('load', () => {
            loadAltNames();
        });


        function liveCheckGuess() {
            const userGuess = guessInput.value;
            if (!userGuess || !selectedLayer) return;

            const normalizedGuess = normalizeString(userGuess);
            const names = getLocalityNames(selectedLayer.maltalocalityid);
            const normalizedNames = names.map(name => normalizeString(name));

            let isCorrect = normalizedNames.includes(normalizedGuess)

            if (isCorrect) {
                handleCorrectGuess();
            }
        }


        // --- UI Management ---
        function updateProgress() {
            progressText.textContent = `${guessedShapes} / ${totalShapes}`;
            const percentage = totalShapes > 0 ? (guessedShapes / totalShapes) * 100 : 0;
            progressBar.style.width = `${percentage}%`;
        }

        function showGuessModal() {
            guessDialog.show();
            guessInput.focus();
        }

        // MODIFIED: This function is now simpler and just handles the UI
        function hideGuessModal() {
            guessDialog.close();

            if (selectedLayer && !selectedLayer.isGuessed) {
                geoJsonLayer.resetStyle(selectedLayer);
            }
            selectedLayer = null;

            setTimeout(() => {
                guessInput.value = '';
                guessInput.placeholder = 'Enter name...';
                guessInput.classList.remove('border-red-500');
            }, 200);
        }

        let stopwatchInterval = null;
        let startTimestamp = null;

        // --- Stopwatch Helpers ---
        function startStopwatch() {
            startTimestamp = Date.now();
            localStorage.setItem('lcgame_startTime', startTimestamp);
            updateStopwatchDisplay();
            stopwatchInterval = setInterval(updateStopwatchDisplay, 33);
        }

        function updateStopwatchDisplay() {
            const now = Date.now();
            const elapsed = now - (startTimestamp || now);
            document.getElementById('stopwatch').textContent = formatTime(elapsed);
        }

        function formatTime(ms) {
            const totalSeconds = ms / 1000;
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = Math.floor(totalSeconds % 60);
            const centiseconds = Math.floor((totalSeconds * 100) % 100);
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}.${centiseconds.toString().padStart(2, '0')}`;
        }

        function stopStopwatch() {
            if (stopwatchInterval) clearInterval(stopwatchInterval);
            stopwatchInterval = null;
        }

        // --- Win Screen Update ---
        function showWinScreen() {
            stopStopwatch();
            const now = Date.now();
            const elapsed = now - (startTimestamp || now);
            document.getElementById('final-time').textContent = formatTime(elapsed);
            achievementsIframe.contentWindow.postMessage({ type: 'registerAchievement', achievement: "won-local-council-game" }, '*');

            if (chosenGamemode === GAMEMODE.flags) {
                flagContainer.classList.add('hidden');
            }

            winModal.classList.remove('hidden');
            winModal.classList.add('flex');
            setTimeout(() => {
                winModalContent.classList.remove('scale-95', 'opacity-0');
                winModalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        // NEW: Function to manage the flag guessing rounds
        function startNextFlagRound() {
            if (!geoJsonLayer) return;

            hideGuessModal(); // Close any open input dialog

            const unguessedLayers = [];
            geoJsonLayer.eachLayer(layer => {
                if (!layer.isGuessed) {
                    unguessedLayers.push(layer);
                }
            });

            if (unguessedLayers.length === 0) {
                if (guessedShapes === totalShapes) showWinScreen();
                return;
            }

            // Select a new random layer for the flag
            currentFlagLayer = unguessedLayers[Math.floor(Math.random() * unguessedLayers.length)];

            const localityId = currentFlagLayer.maltalocalityid;
            flagImage.src = `coat-of-arms/${localityId}.png`;
            flagContainer.classList.remove('hidden');
        }


        // --- Start Game ---
        function startGame() {
            document.getElementById("noncountdown").style.display = 'none';

            if (shouldLoadSave) {
                startOverlay.style.display = 'none';
                backgroundMusic = new Audio('music.mp3');
                backgroundMusic.loop = true;
                backgroundMusic.volume = 0.2;
                backgroundMusic.play();

                startTimestamp = parseInt(localStorage.getItem('lcgame_startTime'), 10) || Date.now();
                updateStopwatchDisplay();
                stopwatchInterval = setInterval(updateStopwatchDisplay, 33);
                autoLoadFile();
                return;
            }

            const countdownAudio = new Audio('321.mp3');
            countdownAudio.play();
            setTimeout(() => {
                backgroundMusic = new Audio('music.mp3');
                backgroundMusic.loop = true;
                backgroundMusic.volume = 0.2;

                countdown.style.display = 'block';

                let count = 3;
                countdown.textContent = count;
                autoLoadFile();
                const countInterval = setInterval(() => {
                    count--;
                    if (count > 0) {
                        countdown.textContent = count;
                    } else {
                        clearInterval(countInterval);
                        startOverlay.style.display = 'none';
                        backgroundMusic.play();

                        if (!shouldLoadSave) {
                            startStopwatch();
                        } else {
                            startTimestamp = parseInt(localStorage.getItem('lcgame_startTime'), 10) || Date.now();
                            updateStopwatchDisplay();
                            stopwatchInterval = setInterval(updateStopwatchDisplay, 33);
                        }
                    }
                }, 300);
            }, 350);

        }
        const GAMEMODE = {
            normal: 0,
            mouseless: 1,
            flags: 2
        }
        let chosenGamemode = 0;
        // --- LocalStorage Helpers ---
        function saveProgressToLocalStorage() {
            if (!geoJsonLayer) return;
            const guessedIds = [];
            geoJsonLayer.eachLayer(layer => {
                if (layer.isGuessed) guessedIds.push(layer.maltalocalityid);
            });
            localStorage.setItem('lcgame_guessedIds', JSON.stringify(guessedIds));
            localStorage.setItem('lcgame_gamemode', chosenGamemode);
        }

        function loadProgressFromLocalStorage() {
            const guessedIds = JSON.parse(localStorage.getItem('lcgame_guessedIds') || '[]');
            const savedGamemode = parseInt(localStorage.getItem('lcgame_gamemode'), 10);
            return { guessedIds, savedGamemode };
        }

        function applySavedProgress(guessedIds) {
            if (!geoJsonLayer) return;
            guessedShapes = 0;
            geoJsonLayer.eachLayer(layer => {
                if (guessedIds.includes(layer.maltalocalityid)) {
                    layer.isGuessed = true;
                    layer.setStyle(guessedStyle);
                    layer.unbindPopup();
                    layer.off('click mouseover mouseout');
                    guessedShapes++;
                }
            });
            updateProgress();
        }

        function handleStartClick(mode, loadSave = false) {
            chosenGamemode = mode;
            shouldLoadSave = loadSave;
            startGame();
        }

        document.addEventListener('DOMContentLoaded', () => {
            const continueBtn = document.getElementById("continueLastSave")
            let progress = loadProgressFromLocalStorage()
            if (progress.guessedIds.length > 0) {
                continueBtn.style.display = "flex"
            }
            if (continueBtn) {
                continueBtn.onclick = () => {
                    const { savedGamemode } = progress;
                    handleStartClick(savedGamemode || GAMEMODE.normal, true);
                };
            }
        });

        // --- Event Listeners ---
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (chosenGamemode === GAMEMODE.flags && guessedShapes < totalShapes) {
                    startNextFlagRound(); // Skips to the next flag
                } else {
                    hideGuessModal(); // Original behavior for other modes
                }
            }
        });

        guessInput.addEventListener('input', liveCheckGuess);
        playAgainBtn.addEventListener('click', () => {
            window.location.reload()
        });

        // --- Initial Setup ---
        window.onload = () => {
            initializeMap();
            startOverlay.style.opacity = '1';
            startOverlay.style.transition = 'opacity 1s';
        };

        function autoLoadFile() {
            fetch('Malta-LAU2.zip')
                .then(response => response.arrayBuffer())
                .then(buffer => loadShapefile(buffer))
                .catch(err => {
                    console.error("Fetch error:", err);
                });
        }
    </script>
</body>

</html>