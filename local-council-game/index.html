<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Malta LC Guessing Game</title>

    <!-- Leaflet.js for mapping -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- shapefile-js for parsing shapefiles -->
    <script src="https://unpkg.com/shpjs@latest/dist/shp.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pangolin&display=swap" rel="stylesheet">

    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>


    <style>
        /* Ensure the map and body take up the full screen */
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Pangolin', 'Inter', sans-serif;
        }

        #map {
            height: 100%;
            width: 100%;
            background-color: #00071d;
        }

        /* Custom Leaflet popup styling */
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
        }

        .leaflet-popup-content {
            margin: 15px;
            font-size: 14px;
        }


        /* Custom transition for UI elements */
        .transition-all {
            transition: all 0.3s ease-in-out;
        }

        /* Start Overlay Styles */
        #start-overlay {
            transition: opacity 1s;
        }

        #countdown {
            animation: pulse 0.305s infinite linear;
        }

        button {
            display: flex;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            100% {
                transform: scale(0.5);
                opacity: 0;
            }
        }

        dialog {
            z-index: 1001;
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translate(-50%, 0);
            background: none;
            transform-origin: 0 500%;
            opacity: 0.9;

            transition: display 0.2s allow-discrete, overlay 1s allow-discrete;

            animation: close 0.2s cubic-bezier(0.075, 0.82, 0.165, 1);

            &[open] {
                animation: open 0.6s cubic-bezier(0.075, 0.82, 0.165, 1);
            }
        }

        @keyframes open {
            from {
                opacity: 0;
                scale: 0.9;
            }

            to {
                opacity: 0.9;
                scale: 1;
            }
        }

        @keyframes close {
            from {
                opacity: 0.9;
                scale: 1;
            }

            to {
                opacity: 0;
                scale: 0.9;
            }
        }

        #guess-input {
            font-size: 2em;
            width: 90vw;
            text-align: center;
            background-color: black;
            color: white;
            z-index: 1001;
        }

        button:hover {
            color: rgb(132, 158, 255);
            text-decoration: underline;
        }

        .fixed-logo {
            z-index: 5002;
            width: fit-content;
            position: fixed;
            left: 0;
            top: 0;
        }

        .fixed-logo:hover {
            scale: 1.05;
        }
    </style>
</head>

<body class="bg-gray-100">
    <iframe style="display: none;" id="achievementsIframe" src="/achievements.html"></iframe>

    <a href="/" class="fixed-logo"><img id="logoimg" src="/assets/joe-logo.webp" width="100" alt="Logo"
            class="logo" /></a>
    <p href="/" style="color: white; margin-left: 100px; margin-top: 15px; scale: 1; pointer-events: none;"
        class="fixed-logo">Malta Local Council Guesser</p>

    <!-- Start Overlay -->
    <div id="start-overlay" class="fixed inset-0 bg-black z-[2000] flex items-center justify-center">
        <div s class="text-white text-5xl font-bold tracking-wider">
            <div style="font-size: 120px;" id="countdown" class="hidden">3</div>
            <div id="noncountdown" style="display: flex; flex-direction: column; gap: 0.2em;">
                <button style="display: none;" id="continueLastSave">Continue last save</button>
                <button onclick="handleStartClick(GAMEMODE.normal)">Normal Mode</button>
                <button onclick="handleStartClick(GAMEMODE.mouseless)">Mouseless Random
                    Mode</button>
            </div>
        </div>
    </div>

    <!-- The main map container -->
    <div id="map"></div>

    <!-- UI Overlay: File Upload and Game Info -->
    <div id="ui-overlay" class="absolute top-0 left-0 right-0 z-[1000] flex flex-col">
        <div style="margin-left: auto; margin-right: 10px; width: 50vw; border-bottom-left-radius: 10px; border-bottom-right-radius: 10px; overflow: hidden;"
            class="bg-white/70 backdrop-blur-sm shadow-lg max-w-lg w-full text-center transition-all" id="info-box">

            <!-- File input -->
            <input type="file" id="file-input" style="display: none;"
                class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                accept=".zip">

            <!-- Game progress display (initially hidden) -->
            <div id="progress-container" class="hidden mt-4">
                <p class="text-lg font-semibold text-gray-700">Progress: <span id="progress-text"
                        class="font-bold text-blue-600">0 / 0</span></p>
                <div class="w-full bg-gray-200 h-2.5 mt-2">
                    <div id="progress-bar" class="bg-blue-600 h-2.5" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Guessing Modal (initially hidden) -->
    <dialog id="guess-dialog">
        <input autocomplete="off" type="text" id="guess-input" style="opacity: 1;"
            class="w-full px-4 py-2 border border-gray-300 rounded-full focus:ring-2 focus:ring-blue-500 focus:outline-none"
            placeholder="Enter name...">
    </dialog>


    <!-- Win Modal (initially hidden) -->
    <div id="win-modal"
        class="hidden absolute inset-0 z-[1002] bg-green-500/80 flex items-center justify-center p-4 text-white text-center">
        <div class="transform transition-all scale-95 opacity-0" id="win-modal-content">
            <h1 class="text-6xl font-bold mb-4">ðŸŽ‰ You Win! ðŸŽ‰</h1>
            <p class="text-2xl mb-6">You've successfully named all the shapes!</p>
            <button id="play-again"
                class="bg-white text-green-600 font-bold py-3 px-8 rounded-full text-lg hover:bg-gray-100 transition-transform hover:scale-105">Play
                Again</button>
        </div>
    </div>

    <script>
        // --- Global Variables ---
        let map;
        let geoJsonLayer;
        let selectedLayer;
        let totalShapes = 0;
        let guessedShapes = 0;
        let backgroundMusic;

        // --- DOM Elements ---
        const fileInput = document.getElementById('file-input');
        const progressContainer = document.getElementById('progress-container');
        const progressText = document.getElementById('progress-text');
        const progressBar = document.getElementById('progress-bar');
        const infoBox = document.getElementById('info-box');

        const guessDialog = document.getElementById('guess-dialog');
        const guessInput = document.getElementById('guess-input');

        const winModal = document.getElementById('win-modal');
        const winModalContent = document.getElementById('win-modal-content');
        const playAgainBtn = document.getElementById('play-again');

        const startOverlay = document.getElementById('start-overlay');
        const countdown = document.getElementById('countdown');


        // --- Styles for Shapes ---
        const defaultStyle = { color: "#3388ff", weight: 2, opacity: 1, fillColor: "#3388ff", fillOpacity: 0.3 };
        const highlightStyle = { color: "#ff7800", weight: 4, fillOpacity: 0.5 };
        const guessedStyle = { color: "#28a745", weight: 2, opacity: 1, fillColor: "#28a745", fillOpacity: 0.6, interactive: false };

        // --- Map Initialization (Blank Background) ---
        function initializeMap() {
            if (map) map.remove();


            // Initialize the map, restricting it to the bounds of Malta
            var myRenderer = L.svg({ padding: 1 });
            map = L.map('map', {
                wheelDebounceTime: 1,
                zoomAnimation: false,
                doubleClickZoom: false,
                minZoom: 10,
                renderer: myRenderer,
                zoomControl: false,
                attributionControl: false,
                wheelPxPerZoomLevel: 100,
            });



            map.on('load', function (e) {
                hideGuessModal();
            });
            map.on('movestart', function (e) {
                if (chosenGamemode === GAMEMODE.normal) {
                    hideGuessModal();
                }
            });

        }



        // --- Input Normalization ---
        /**
         * Normalizes a string for comparison by making it lowercase,
         * replacing special Maltese characters and diacritics, and handling hyphens.
         * Also ignores anything before the first dash (e.g., "l-isla" becomes "isla").
         * @param {string} str The string to normalize.
         * @returns {string} The normalized string.
         */
        function normalizeString(str) {
            if (!str) return '';
            let normalized = str.toLowerCase();
            // Specific Maltese character replacements
            normalized = normalized.replace(/Ä¡/g, 'g');
            normalized = normalized.replace(/Ä§/g, 'h');
            normalized = normalized.replace(/Ä‹/g, 'c');
            normalized = normalized.replace(/Å¼/g, 'z');
            // General diacritic removal for characters like Ã , Ã©, etc.
            normalized = normalized.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            // Replace hyphens and different dash types with a space
            normalized = normalized.replace(/[-â€“â€”]/g, ' ');
            normalized = normalized.replace(/[']/g, '');
            // Remove consecutive spaces and trim
            normalized = normalized.replace(/\s+/g, ' ').trim();
            return normalized;
        }

        // --- Game Logic ---
        function handleFile(e) {
            const file = e.target.files[0];
            if (!file) return;


            resetGame();

            const reader = new FileReader();
            reader.onload = (event) => loadShapefile(event.target.result);
            reader.onerror = (err) => {
                console.error("FileReader error:", err);

            }
            reader.readAsArrayBuffer(file);
        }

        function loadShapefile(buffer) {
            shp(buffer).then(function (geojson) {
                if (!geojson || (geojson.features && geojson.features.length === 0)) {

                    return;
                }

                // Check if features have at least one of the required name properties
                const firstProps = geojson.features[0].properties;
                if (!firstProps || (firstProps.LAU_Name === undefined && firstProps.LAU_Latin === undefined)) {

                    return;
                }

                geoJsonLayer = L.geoJSON(geojson, { style: defaultStyle, onEachFeature }).addTo(map);
                map.fitBounds(geoJsonLayer.getBounds());
                map.panBy([0, 20]);
                totalShapes = geojson.features.length;
                updateProgress();

                fileInput.classList.add('hidden');
                progressContainer.classList.remove('hidden');
                infoBox.classList.add('md:w-auto');
            }).catch(function (err) {
                console.error("Shapefile parsing error:", err);

            });
        }

        function onEachFeature(feature, layer) {
            layer.maltalocalityid = feature.properties.LocalityId || '';
            layer.isGuessed = false;
            layer.on({ mouseover: highlightFeature, mouseout: resetHighlight, click: selectFeatureForGuessing });
        }

        // --- Feature Interaction ---
        function highlightFeature(e) {
            const layer = e.target;
            if (!layer.isGuessed) {
                layer.setStyle(highlightStyle);
                layer.bringToFront();
            }
        }

        function resetHighlight(e) {
            if (geoJsonLayer) {
                const layer = e.target;
                if (!layer.isGuessed && layer !== selectedLayer) {
                    geoJsonLayer.resetStyle(layer);
                }
            }
        }

        // Add this function before selectFeatureForGuessing
        function selectRandomUnguessedFeature() {
            if (!geoJsonLayer) return;

            const unguessedLayers = [];
            geoJsonLayer.eachLayer(layer => {
                if (!layer.isGuessed) {
                    unguessedLayers.push(layer);
                }
            });

            if (unguessedLayers.length > 0) {
                const randomLayer = unguessedLayers[Math.floor(Math.random() * unguessedLayers.length)];
                selectFeatureForGuessing({ target: randomLayer });
            }
        }

        function selectFeatureForGuessing(e) {
            guessInput.value = '';


            if (selectedLayer && !selectedLayer.isGuessed) {
                geoJsonLayer.resetStyle(selectedLayer);
            }
            selectedLayer = e.target;
            if (selectedLayer.isGuessed) {
                selectedLayer = null;
                return;
            }
            selectedLayer.setStyle(highlightStyle);
            selectedLayer.bringToFront();

            setTimeout(() => {
                selectedLayer.setStyle(highlightStyle);
                selectedLayer.bringToFront();
            }, 10);
            showGuessModal();

        }

        // --- Guessing Logic ---
        function handleCorrectGuess() {
            if (!selectedLayer || selectedLayer.isGuessed) return; // Prevent double processing



            selectedLayer.isGuessed = true;
            selectedLayer.setStyle(guessedStyle);
            selectedLayer.unbindPopup();
            selectedLayer.off('click mouseover mouseout');

            guessedShapes++;
            updateProgress();
            saveProgressToLocalStorage(); // <-- Save progress here
            hideGuessModal();

            if (guessedShapes === totalShapes) {
                showWinScreen();
            }

            // Play correct sound
            const correctAudio = new Audio('correct.mp3');
            correctAudio.play();
        }

        let altNamesData = null;

        // Load altnames.json once on page load
        async function loadAltNames() {
            try {
                const response = await fetch('altnames.json');
                altNamesData = await response.json();
                console.log('altnames.json loaded');
            } catch (error) {
                console.error('Failed to load altnames.json:', error);
            }
        }

        // Get names from the cached data
        function getLocalityNames(localityId) {
            if (!altNamesData) {
                console.warn('Data not loaded yet.');
                return [];
            }

            const locality = altNamesData.find(item => item.LocalityId === localityId);

            if (!locality) {
                console.warn(`Locality with ID ${localityId} not found.`);
                return [];
            }

            // Split, trim, and deduplicate
            return [...new Set(
                locality.Names.split(',')
                    .map(name => name.trim())
                    .filter(name => name.length > 0)
            )];
        }

        // Load data once when the page starts
        window.addEventListener('load', () => {
            loadAltNames();
        });


        function liveCheckGuess() {
            const userGuess = guessInput.value;
            if (!userGuess || !selectedLayer) return;

            const normalizedGuess = normalizeString(userGuess);
            const names = getLocalityNames(selectedLayer.maltalocalityid);

            // Normalize the names array
            const normalizedNames = names.map(name => normalizeString(name));

            // Check if any of the normalized names matches the user's guess
            const isCorrect = normalizedNames.includes(normalizedGuess);

            if (isCorrect) {
                handleCorrectGuess();
            }
        }


        // --- UI Management ---
        function updateProgress() {
            progressText.textContent = `${guessedShapes} / ${totalShapes}`;
            const percentage = totalShapes > 0 ? (guessedShapes / totalShapes) * 100 : 0;
            progressBar.style.width = `${percentage}%`;
        }

        function showGuessModal() {
            guessDialog.show();
            guessInput.focus();
        }

        function hideGuessModal() {


            guessDialog.close();

            if (selectedLayer && !selectedLayer.isGuessed) {
                geoJsonLayer.resetStyle(selectedLayer);
            }
            selectedLayer = null;


            if (chosenGamemode === GAMEMODE.mouseless) {
                selectRandomUnguessedFeature();
            }
            else {
                setTimeout(() => {
                    guessInput.value = '';
                    guessInput.placeholder = 'Enter name...';
                    guessInput.classList.remove('border-red-500');
                }, 200);
            }
        }

        function showWinScreen() {
            achievementsIframe.contentWindow.postMessage({ type: 'registerAchievement', achievement: "won-local-council-game" }, '*');
            winModal.classList.remove('hidden');
            winModal.classList.add('flex');
            setTimeout(() => {
                winModalContent.classList.remove('scale-95', 'opacity-0');
                winModalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function startGame() {

            // document.body.requestFullscreen().catch(err => {
            //     console.error("Error attempting to enable full-screen mode:", err);
            // });

            document.getElementById("noncountdown").style.display = 'none';
            const countdownAudio = new Audio('321.mp3');
            countdownAudio.play();
            setTimeout(() => {
                // Initialize background music
                backgroundMusic = new Audio('music.mp3');
                backgroundMusic.loop = true;
                backgroundMusic.volume = 0.2;

                countdown.style.display = 'block';




                let count = 3;
                countdown.textContent = count;
                autoLoadFile();
                const countInterval = setInterval(() => {
                    count--;
                    if (count > 0) {
                        countdown.textContent = count;
                    } else {
                        clearInterval(countInterval);
                        startOverlay.style.display = 'none';
                        backgroundMusic.play();
                    }
                }, 300);
            }, 350);

        }
        const GAMEMODE = {
            normal: 0,
            mouseless: 1
        }
        let chosenGamemode = 0;
        // --- LocalStorage Helpers ---
        function saveProgressToLocalStorage() {
            if (!geoJsonLayer) return;
            const guessedIds = [];
            geoJsonLayer.eachLayer(layer => {
                if (layer.isGuessed) guessedIds.push(layer.maltalocalityid);
            });
            localStorage.setItem('lcgame_guessedIds', JSON.stringify(guessedIds));
            localStorage.setItem('lcgame_gamemode', chosenGamemode);
        }

        function loadProgressFromLocalStorage() {
            const guessedIds = JSON.parse(localStorage.getItem('lcgame_guessedIds') || '[]');
            const savedGamemode = parseInt(localStorage.getItem('lcgame_gamemode'), 10);
            return { guessedIds, savedGamemode };
        }

        function applySavedProgress(guessedIds) {
            if (!geoJsonLayer) return;
            guessedShapes = 0;
            geoJsonLayer.eachLayer(layer => {
                if (guessedIds.includes(layer.maltalocalityid)) {
                    layer.isGuessed = true;
                    layer.setStyle(guessedStyle);
                    layer.unbindPopup();
                    layer.off('click mouseover mouseout');
                    guessedShapes++;
                }
            });
            updateProgress();
        }

        function handleStartClick(mode, loadSave = false) {
            chosenGamemode = mode;
            shouldLoadSave = loadSave;
            startGame();
        }

        // --- Start Overlay Button ---
        document.addEventListener('DOMContentLoaded', () => {
            const continueBtn = document.getElementById("continueLastSave")
            let progress = loadProgressFromLocalStorage()
            if (progress.guessedIds.length > 0) {
                continueBtn.style.display = "flex"
            }
            if (continueBtn) {
                continueBtn.onclick = () => {
                    const { savedGamemode } = progress;
                    handleStartClick(savedGamemode || GAMEMODE.normal, true);
                };
            }
        });

        // --- Start Game ---
        function startGame() {
            document.getElementById("noncountdown").style.display = 'none';
            const countdownAudio = new Audio('321.mp3');
            countdownAudio.play();
            setTimeout(() => {
                backgroundMusic = new Audio('music.mp3');
                backgroundMusic.loop = true;
                backgroundMusic.volume = 0.2;

                countdown.style.display = 'block';

                let count = 3;
                countdown.textContent = count;
                autoLoadFile();
                const countInterval = setInterval(() => {
                    count--;
                    if (count > 0) {
                        countdown.textContent = count;
                    } else {
                        clearInterval(countInterval);
                        startOverlay.style.display = 'none';
                        backgroundMusic.play();
                    }
                }, 300);
            }, 350);
        }

        // --- Auto Load File ---
        function loadShapefile(buffer) {
            shp(buffer).then(function (geojson) {
                if (!geojson || (geojson.features && geojson.features.length === 0)) {
                    return;
                }
                const firstProps = geojson.features[0].properties;
                if (!firstProps || (firstProps.LAU_Name === undefined && firstProps.LAU_Latin === undefined)) {
                    return;
                }
                geoJsonLayer = L.geoJSON(geojson, { style: defaultStyle, onEachFeature }).addTo(map);
                map.fitBounds(geoJsonLayer.getBounds());
                map.panBy([0, 20]);
                totalShapes = geojson.features.length;
                updateProgress();

                fileInput.classList.add('hidden');
                progressContainer.classList.remove('hidden');
                infoBox.classList.add('md:w-auto');

                // If loading from save, apply saved progress
                if (shouldLoadSave) {
                    const { guessedIds } = loadProgressFromLocalStorage();
                    applySavedProgress(guessedIds);
                }
            }).catch(function (err) {
                console.error("Shapefile parsing error:", err);
            });
        }

        // --- Event Listeners ---
        // fileInput.addEventListener('change', handleFile);
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') { hideGuessModal(); }
        });
        guessInput.addEventListener('input', liveCheckGuess); // Check on every keystroke
        guessInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') manualCheckGuess(); });
        playAgainBtn.addEventListener('click', () => {
            window.location.reload()
        });

        // --- Initial Setup ---
        window.onload = () => {
            initializeMap();
            // Only autoload file after countdown
            startOverlay.style.opacity = '1';
            startOverlay.style.transition = 'opacity 1s';
        };

        // Add a new function to load the default file automatically
        function autoLoadFile() {
            fetch('Malta-LAU2.zip')
                .then(response => response.arrayBuffer())
                .then(buffer => loadShapefile(buffer))
                .catch(err => {
                    console.error("Fetch error:", err);
                });
        }
    </script>
</body>

</html>