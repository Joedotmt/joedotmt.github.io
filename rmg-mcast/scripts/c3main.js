import "./../box2d.wasm.js";
// Generated by Construct, the game and animation creation tool
// Visit: https://www.construct.net

{let vt=function(t){s=t},Rt=function(t){return t*n},At=function(t,s){return Math.abs(t-s)<=e*Math.max(1,Math.abs(t),Math.abs(s))},Dt=function(){var t=new s(4);return s!=Float32Array&&(t[1]=0,t[2]=0),t[0]=1,t[3]=1,t},Et=function(t){var e=new s(4);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},Ft=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},Ot=function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t},Bt=function(t,e,i,r){var n=new s(4);return n[0]=t,n[1]=e,n[2]=i,n[3]=r,n},Lt=function(t,e,s,i,r){return t[0]=e,t[1]=s,t[2]=i,t[3]=r,t},kt=function(t,e){if(t===e){var s=e[1];t[1]=e[2],t[2]=s}else t[0]=e[0],t[1]=e[2],t[2]=e[1],t[3]=e[3];return t},Nt=function(t,e){var s=e[0],i=e[1],r=e[2],n=e[3],a=s*n-r*i;return a?(a=1/a,t[0]=n*a,t[1]=-i*a,t[2]=-r*a,t[3]=s*a,t):null},Ut=function(t,e){var s=e[0];return t[0]=e[3],t[1]=-e[1],t[2]=-e[2],t[3]=s,t},Wt=function(t){return t[0]*t[3]-t[2]*t[1]},jt=function(t,e,s){var i=e[0],r=e[1],n=e[2],a=e[3],o=s[0],h=s[1],l=s[2],c=s[3];return t[0]=i*o+n*h,t[1]=r*o+a*h,t[2]=i*l+n*c,t[3]=r*l+a*c,t},Vt=function(t,e,s){var i=e[0],r=e[1],n=e[2],a=e[3],o=Math.sin(s),h=Math.cos(s);return t[0]=i*h+n*o,t[1]=r*h+a*o,t[2]=i*-o+n*h,t[3]=r*-o+a*h,t},zt=function(t,e,s){var i=e[0],r=e[1],n=e[2],a=e[3],o=s[0],h=s[1];return t[0]=i*o,t[1]=r*o,t[2]=n*h,t[3]=a*h,t},Ht=function(t,e){var s=Math.sin(e),i=Math.cos(e);return t[0]=i,t[1]=s,t[2]=-s,t[3]=i,t},Yt=function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=e[1],t},Xt=function(t){return"mat2("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"},qt=function(t){return Math.hypot(t[0],t[1],t[2],t[3])},Jt=function(t,e,s,i){return t[2]=i[2]/i[0],s[0]=i[0],s[1]=i[1],s[3]=i[3]-t[2]*s[1],[t,e,s]},Qt=function(t,e,s){return t[0]=e[0]+s[0],t[1]=e[1]+s[1],t[2]=e[2]+s[2],t[3]=e[3]+s[3],t},Kt=function(t,e,s){return t[0]=e[0]-s[0],t[1]=e[1]-s[1],t[2]=e[2]-s[2],t[3]=e[3]-s[3],t},Zt=function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]},$t=function(t,s){var i=t[0],r=t[1],n=t[2],a=t[3],o=s[0],h=s[1],l=s[2],c=s[3];return Math.abs(i-o)<=e*Math.max(1,Math.abs(i),Math.abs(o))&&Math.abs(r-h)<=e*Math.max(1,Math.abs(r),Math.abs(h))&&Math.abs(n-l)<=e*Math.max(1,Math.abs(n),Math.abs(l))&&Math.abs(a-c)<=e*Math.max(1,Math.abs(a),Math.abs(c))},te=function(t,e,s){return t[0]=e[0]*s,t[1]=e[1]*s,t[2]=e[2]*s,t[3]=e[3]*s,t},ee=function(t,e,s,i){return t[0]=e[0]+s[0]*i,t[1]=e[1]+s[1]*i,t[2]=e[2]+s[2]*i,t[3]=e[3]+s[3]*i,t},se=function(){var t=new s(6);return s!=Float32Array&&(t[1]=0,t[2]=0,t[4]=0,t[5]=0),t[0]=1,t[3]=1,t},ie=function(t){var e=new s(6);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e},re=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t},ne=function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=0,t[5]=0,t},ae=function(t,e,i,r,n,a){var o=new s(6);return o[0]=t,o[1]=e,o[2]=i,o[3]=r,o[4]=n,o[5]=a,o},oe=function(t,e,s,i,r,n,a){return t[0]=e,t[1]=s,t[2]=i,t[3]=r,t[4]=n,t[5]=a,t},he=function(t,e){var s=e[0],i=e[1],r=e[2],n=e[3],a=e[4],o=e[5],h=s*n-i*r;return h?(h=1/h,t[0]=n*h,t[1]=-i*h,t[2]=-r*h,t[3]=s*h,t[4]=(r*o-n*a)*h,t[5]=(i*a-s*o)*h,t):null},le=function(t){return t[0]*t[3]-t[1]*t[2]},ce=function(t,e,s){var i=e[0],r=e[1],n=e[2],a=e[3],o=e[4],h=e[5],l=s[0],c=s[1],u=s[2],_=s[3],d=s[4],p=s[5];return t[0]=i*l+n*c,t[1]=r*l+a*c,t[2]=i*u+n*_,t[3]=r*u+a*_,t[4]=i*d+n*p+o,t[5]=r*d+a*p+h,t},ue=function(t,e,s){var i=e[0],r=e[1],n=e[2],a=e[3],o=e[4],h=e[5],l=Math.sin(s),c=Math.cos(s);return t[0]=i*c+n*l,t[1]=r*c+a*l,t[2]=i*-l+n*c,t[3]=r*-l+a*c,t[4]=o,t[5]=h,t},_e=function(t,e,s){var i=e[0],r=e[1],n=e[2],a=e[3],o=e[4],h=e[5],l=s[0],c=s[1];return t[0]=i*l,t[1]=r*l,t[2]=n*c,t[3]=a*c,t[4]=o,t[5]=h,t},de=function(t,e,s){var i=e[0],r=e[1],n=e[2],a=e[3],o=e[4],h=e[5],l=s[0],c=s[1];return t[0]=i,t[1]=r,t[2]=n,t[3]=a,t[4]=i*l+n*c+o,t[5]=r*l+a*c+h,t},pe=function(t,e){var s=Math.sin(e),i=Math.cos(e);return t[0]=i,t[1]=s,t[2]=-s,t[3]=i,t[4]=0,t[5]=0,t},fe=function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=e[1],t[4]=0,t[5]=0,t},ge=function(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=e[0],t[5]=e[1],t},me=function(t){return"mat2d("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+")"},Se=function(t){return Math.hypot(t[0],t[1],t[2],t[3],t[4],t[5],1)},ye=function(t,e,s){return t[0]=e[0]+s[0],t[1]=e[1]+s[1],t[2]=e[2]+s[2],t[3]=e[3]+s[3],t[4]=e[4]+s[4],t[5]=e[5]+s[5],t},Ge=function(t,e,s){return t[0]=e[0]-s[0],t[1]=e[1]-s[1],t[2]=e[2]-s[2],t[3]=e[3]-s[3],t[4]=e[4]-s[4],t[5]=e[5]-s[5],t},Te=function(t,e,s){return t[0]=e[0]*s,t[1]=e[1]*s,t[2]=e[2]*s,t[3]=e[3]*s,t[4]=e[4]*s,t[5]=e[5]*s,t},Ie=function(t,e,s,i){return t[0]=e[0]+s[0]*i,t[1]=e[1]+s[1]*i,t[2]=e[2]+s[2]*i,t[3]=e[3]+s[3]*i,t[4]=e[4]+s[4]*i,t[5]=e[5]+s[5]*i,t},Ce=function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]},be=function(t,s){var i=t[0],r=t[1],n=t[2],a=t[3],o=t[4],h=t[5],l=s[0],c=s[1],u=s[2],_=s[3],d=s[4],p=s[5];return Math.abs(i-l)<=e*Math.max(1,Math.abs(i),Math.abs(l))&&Math.abs(r-c)<=e*Math.max(1,Math.abs(r),Math.abs(c))&&Math.abs(n-u)<=e*Math.max(1,Math.abs(n),Math.abs(u))&&Math.abs(a-_)<=e*Math.max(1,Math.abs(a),Math.abs(_))&&Math.abs(o-d)<=e*Math.max(1,Math.abs(o),Math.abs(d))&&Math.abs(h-p)<=e*Math.max(1,Math.abs(h),Math.abs(p))},xe=function(){var t=new s(9);return s!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[5]=0,t[6]=0,t[7]=0),t[0]=1,t[4]=1,t[8]=1,t},we=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t},Me=function(t){var e=new s(9);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},Pe=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},ve=function(t,e,i,r,n,a,o,h,l){var c=new s(9);return c[0]=t,c[1]=e,c[2]=i,c[3]=r,c[4]=n,c[5]=a,c[6]=o,c[7]=h,c[8]=l,c},Re=function(t,e,s,i,r,n,a,o,h,l){return t[0]=e,t[1]=s,t[2]=i,t[3]=r,t[4]=n,t[5]=a,t[6]=o,t[7]=h,t[8]=l,t},Ae=function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},De=function(t,e){if(t===e){var s=e[1],i=e[2],r=e[5];t[1]=e[3],t[2]=e[6],t[3]=s,t[5]=e[7],t[6]=i,t[7]=r}else t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8];return t},Ee=function(t,e){var s=e[0],i=e[1],r=e[2],n=e[3],a=e[4],o=e[5],h=e[6],l=e[7],c=e[8],u=c*a-o*l,_=-c*n+o*h,d=l*n-a*h,p=s*u+i*_+r*d;return p?(p=1/p,t[0]=u*p,t[1]=(-c*i+r*l)*p,t[2]=(o*i-r*a)*p,t[3]=_*p,t[4]=(c*s-r*h)*p,t[5]=(-o*s+r*n)*p,t[6]=d*p,t[7]=(-l*s+i*h)*p,t[8]=(a*s-i*n)*p,t):null},Fe=function(t,e){var s=e[0],i=e[1],r=e[2],n=e[3],a=e[4],o=e[5],h=e[6],l=e[7],c=e[8];return t[0]=a*c-o*l,t[1]=r*l-i*c,t[2]=i*o-r*a,t[3]=o*h-n*c,t[4]=s*c-r*h,t[5]=r*n-s*o,t[6]=n*l-a*h,t[7]=i*h-s*l,t[8]=s*a-i*n,t},Oe=function(t){var e=t[0],s=t[1],i=t[2],r=t[3],n=t[4],a=t[5],o=t[6],h=t[7],l=t[8];return e*(l*n-a*h)+s*(-l*r+a*o)+i*(h*r-n*o)},Be=function(t,e,s){var i=e[0],r=e[1],n=e[2],a=e[3],o=e[4],h=e[5],l=e[6],c=e[7],u=e[8],_=s[0],d=s[1],p=s[2],f=s[3],g=s[4],m=s[5],S=s[6],y=s[7],G=s[8];return t[0]=_*i+d*a+p*l,t[1]=_*r+d*o+p*c,t[2]=_*n+d*h+p*u,t[3]=f*i+g*a+m*l,t[4]=f*r+g*o+m*c,t[5]=f*n+g*h+m*u,t[6]=S*i+y*a+G*l,t[7]=S*r+y*o+G*c,t[8]=S*n+y*h+G*u,t},Le=function(t,e,s){var i=e[0],r=e[1],n=e[2],a=e[3],o=e[4],h=e[5],l=e[6],c=e[7],u=e[8],_=s[0],d=s[1];return t[0]=i,t[1]=r,t[2]=n,t[3]=a,t[4]=o,t[5]=h,t[6]=_*i+d*a+l,t[7]=_*r+d*o+c,t[8]=_*n+d*h+u,t},ke=function(t,e,s){var i=e[0],r=e[1],n=e[2],a=e[3],o=e[4],h=e[5],l=e[6],c=e[7],u=e[8],_=Math.sin(s),d=Math.cos(s);return t[0]=d*i+_*a,t[1]=d*r+_*o,t[2]=d*n+_*h,t[3]=d*a-_*i,t[4]=d*o-_*r,t[5]=d*h-_*n,t[6]=l,t[7]=c,t[8]=u,t},Ne=function(t,e,s){var i=s[0],r=s[1];return t[0]=i*e[0],t[1]=i*e[1],t[2]=i*e[2],t[3]=r*e[3],t[4]=r*e[4],t[5]=r*e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},Ue=function(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=e[0],t[7]=e[1],t[8]=1,t},We=function(t,e){var s=Math.sin(e),i=Math.cos(e);return t[0]=i,t[1]=s,t[2]=0,t[3]=-s,t[4]=i,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},je=function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=e[1],t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},Ve=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=0,t[3]=e[2],t[4]=e[3],t[5]=0,t[6]=e[4],t[7]=e[5],t[8]=1,t},ze=function(t,e){var s=e[0],i=e[1],r=e[2],n=e[3],a=s+s,o=i+i,h=r+r,l=s*a,c=i*a,u=i*o,_=r*a,d=r*o,p=r*h,f=n*a,g=n*o,m=n*h;return t[0]=1-u-p,t[3]=c-m,t[6]=_+g,t[1]=c+m,t[4]=1-l-p,t[7]=d-f,t[2]=_-g,t[5]=d+f,t[8]=1-l-u,t},He=function(t,e){var s=e[0],i=e[1],r=e[2],n=e[3],a=e[4],o=e[5],h=e[6],l=e[7],c=e[8],u=e[9],_=e[10],d=e[11],p=e[12],f=e[13],g=e[14],m=e[15],S=s*o-i*a,y=s*h-r*a,G=s*l-n*a,T=i*h-r*o,I=i*l-n*o,C=r*l-n*h,b=c*f-u*p,x=c*g-_*p,w=c*m-d*p,M=u*g-_*f,P=u*m-d*f,v=_*m-d*g,R=S*v-y*P+G*M+T*w-I*x+C*b;return R?(R=1/R,t[0]=(o*v-h*P+l*M)*R,t[1]=(h*w-a*v-l*x)*R,t[2]=(a*P-o*w+l*b)*R,t[3]=(r*P-i*v-n*M)*R,t[4]=(s*v-r*w+n*x)*R,t[5]=(i*w-s*P-n*b)*R,t[6]=(f*C-g*I+m*T)*R,t[7]=(g*G-p*C-m*y)*R,t[8]=(p*I-f*G+m*S)*R,t):null},Ye=function(t,e,s){return t[0]=2/e,t[1]=0,t[2]=0,t[3]=0,t[4]=-2/s,t[5]=0,t[6]=-1,t[7]=1,t[8]=1,t},Xe=function(t){return"mat3("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+")"},qe=function(t){return Math.hypot(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8])},Je=function(t,e,s){return t[0]=e[0]+s[0],t[1]=e[1]+s[1],t[2]=e[2]+s[2],t[3]=e[3]+s[3],t[4]=e[4]+s[4],t[5]=e[5]+s[5],t[6]=e[6]+s[6],t[7]=e[7]+s[7],t[8]=e[8]+s[8],t},Qe=function(t,e,s){return t[0]=e[0]-s[0],t[1]=e[1]-s[1],t[2]=e[2]-s[2],t[3]=e[3]-s[3],t[4]=e[4]-s[4],t[5]=e[5]-s[5],t[6]=e[6]-s[6],t[7]=e[7]-s[7],t[8]=e[8]-s[8],t},Ke=function(t,e,s){return t[0]=e[0]*s,t[1]=e[1]*s,t[2]=e[2]*s,t[3]=e[3]*s,t[4]=e[4]*s,t[5]=e[5]*s,t[6]=e[6]*s,t[7]=e[7]*s,t[8]=e[8]*s,t},Ze=function(t,e,s,i){return t[0]=e[0]+s[0]*i,t[1]=e[1]+s[1]*i,t[2]=e[2]+s[2]*i,t[3]=e[3]+s[3]*i,t[4]=e[4]+s[4]*i,t[5]=e[5]+s[5]*i,t[6]=e[6]+s[6]*i,t[7]=e[7]+s[7]*i,t[8]=e[8]+s[8]*i,t},$e=function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]},ts=function(t,s){var i=t[0],r=t[1],n=t[2],a=t[3],o=t[4],h=t[5],l=t[6],c=t[7],u=t[8],_=s[0],d=s[1],p=s[2],f=s[3],g=s[4],m=s[5],S=s[6],y=s[7],G=s[8];return Math.abs(i-_)<=e*Math.max(1,Math.abs(i),Math.abs(_))&&Math.abs(r-d)<=e*Math.max(1,Math.abs(r),Math.abs(d))&&Math.abs(n-p)<=e*Math.max(1,Math.abs(n),Math.abs(p))&&Math.abs(a-f)<=e*Math.max(1,Math.abs(a),Math.abs(f))&&Math.abs(o-g)<=e*Math.max(1,Math.abs(o),Math.abs(g))&&Math.abs(h-m)<=e*Math.max(1,Math.abs(h),Math.abs(m))&&Math.abs(l-S)<=e*Math.max(1,Math.abs(l),Math.abs(S))&&Math.abs(c-y)<=e*Math.max(1,Math.abs(c),Math.abs(y))&&Math.abs(u-G)<=e*Math.max(1,Math.abs(u),Math.abs(G))},es=function(){var t=new s(16);return s!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t},ss=function(t){var e=new s(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},is=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},rs=function(t,e,i,r,n,a,o,h,l,c,u,_,d,p,f,g){var m=new s(16);return m[0]=t,m[1]=e,m[2]=i,m[3]=r,m[4]=n,m[5]=a,m[6]=o,m[7]=h,m[8]=l,m[9]=c,m[10]=u,m[11]=_,m[12]=d,m[13]=p,m[14]=f,m[15]=g,m},ns=function(t,e,s,i,r,n,a,o,h,l,c,u,_,d,p,f,g){return t[0]=e,t[1]=s,t[2]=i,t[3]=r,t[4]=n,t[5]=a,t[6]=o,t[7]=h,t[8]=l,t[9]=c,t[10]=u,t[11]=_,t[12]=d,t[13]=p,t[14]=f,t[15]=g,t},as=function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},os=function(t,e){if(t===e){var s=e[1],i=e[2],r=e[3],n=e[6],a=e[7],o=e[11];t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=s,t[6]=e[9],t[7]=e[13],t[8]=i,t[9]=n,t[11]=e[14],t[12]=r,t[13]=a,t[14]=o}else t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15];return t},hs=function(t,e){var s=e[0],i=e[1],r=e[2],n=e[3],a=e[4],o=e[5],h=e[6],l=e[7],c=e[8],u=e[9],_=e[10],d=e[11],p=e[12],f=e[13],g=e[14],m=e[15],S=s*o-i*a,y=s*h-r*a,G=s*l-n*a,T=i*h-r*o,I=i*l-n*o,C=r*l-n*h,b=c*f-u*p,x=c*g-_*p,w=c*m-d*p,M=u*g-_*f,P=u*m-d*f,v=_*m-d*g,R=S*v-y*P+G*M+T*w-I*x+C*b;return R?(R=1/R,t[0]=(o*v-h*P+l*M)*R,t[1]=(r*P-i*v-n*M)*R,t[2]=(f*C-g*I+m*T)*R,t[3]=(_*I-u*C-d*T)*R,t[4]=(h*w-a*v-l*x)*R,t[5]=(s*v-r*w+n*x)*R,t[6]=(g*G-p*C-m*y)*R,t[7]=(c*C-_*G+d*y)*R,t[8]=(a*P-o*w+l*b)*R,t[9]=(i*w-s*P-n*b)*R,t[10]=(p*I-f*G+m*S)*R,t[11]=(u*G-c*I-d*S)*R,t[12]=(o*x-a*M-h*b)*R,t[13]=(s*M-i*x+r*b)*R,t[14]=(f*y-p*T-g*S)*R,t[15]=(c*T-u*y+_*S)*R,t):null},ls=function(t,e){var s=e[0],i=e[1],r=e[2],n=e[3],a=e[4],o=e[5],h=e[6],l=e[7],c=e[8],u=e[9],_=e[10],d=e[11],p=e[12],f=e[13],g=e[14],m=e[15],S=s*o-i*a,y=s*h-r*a,G=s*l-n*a,T=i*h-r*o,I=i*l-n*o,C=r*l-n*h,b=c*f-u*p,x=c*g-_*p,w=c*m-d*p,M=u*g-_*f,P=u*m-d*f,v=_*m-d*g;return t[0]=o*v-h*P+l*M,t[1]=r*P-i*v-n*M,t[2]=f*C-g*I+m*T,t[3]=_*I-u*C-d*T,t[4]=h*w-a*v-l*x,t[5]=s*v-r*w+n*x,t[6]=g*G-p*C-m*y,t[7]=c*C-_*G+d*y,t[8]=a*P-o*w+l*b,t[9]=i*w-s*P-n*b,t[10]=p*I-f*G+m*S,t[11]=u*G-c*I-d*S,t[12]=o*x-a*M-h*b,t[13]=s*M-i*x+r*b,t[14]=f*y-p*T-g*S,t[15]=c*T-u*y+_*S,t},cs=function(t){var e=t[0],s=t[1],i=t[2],r=t[3],n=t[4],a=t[5],o=t[6],h=t[7],l=t[8],c=t[9],u=t[10],_=t[11],d=t[12],p=t[13],f=t[14],g=e*a-s*n,m=e*o-i*n,S=s*o-i*a,y=l*p-c*d,G=l*f-u*d,T=c*f-u*p;return h*(e*T-s*G+i*y)-r*(n*T-a*G+o*y)+t[15]*(l*S-c*m+u*g)-_*(d*S-p*m+f*g)},us=function(t,e,s){var i=e[0],r=e[1],n=e[2],a=e[3],o=e[4],h=e[5],l=e[6],c=e[7],u=e[8],_=e[9],d=e[10],p=e[11],f=e[12],g=e[13],m=e[14],S=e[15],y=s[0],G=s[1],T=s[2],I=s[3];return t[0]=y*i+G*o+T*u+I*f,t[1]=y*r+G*h+T*_+I*g,t[2]=y*n+G*l+T*d+I*m,t[3]=y*a+G*c+T*p+I*S,y=s[4],G=s[5],T=s[6],I=s[7],t[4]=y*i+G*o+T*u+I*f,t[5]=y*r+G*h+T*_+I*g,t[6]=y*n+G*l+T*d+I*m,t[7]=y*a+G*c+T*p+I*S,y=s[8],G=s[9],T=s[10],I=s[11],t[8]=y*i+G*o+T*u+I*f,t[9]=y*r+G*h+T*_+I*g,t[10]=y*n+G*l+T*d+I*m,t[11]=y*a+G*c+T*p+I*S,y=s[12],G=s[13],T=s[14],I=s[15],t[12]=y*i+G*o+T*u+I*f,t[13]=y*r+G*h+T*_+I*g,t[14]=y*n+G*l+T*d+I*m,t[15]=y*a+G*c+T*p+I*S,t},_s=function(t,e,s){var i,r,n,a,o,h,l,c,u,_,d,p,f=s[0],g=s[1],m=s[2];return e===t?(t[12]=e[0]*f+e[4]*g+e[8]*m+e[12],t[13]=e[1]*f+e[5]*g+e[9]*m+e[13],t[14]=e[2]*f+e[6]*g+e[10]*m+e[14],t[15]=e[3]*f+e[7]*g+e[11]*m+e[15]):(i=e[0],r=e[1],n=e[2],a=e[3],o=e[4],h=e[5],l=e[6],c=e[7],u=e[8],_=e[9],d=e[10],p=e[11],t[0]=i,t[1]=r,t[2]=n,t[3]=a,t[4]=o,t[5]=h,t[6]=l,t[7]=c,t[8]=u,t[9]=_,t[10]=d,t[11]=p,t[12]=i*f+o*g+u*m+e[12],t[13]=r*f+h*g+_*m+e[13],t[14]=n*f+l*g+d*m+e[14],t[15]=a*f+c*g+p*m+e[15]),t},ds=function(t,e,s){var i=s[0],r=s[1],n=s[2];return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t[3]=e[3]*i,t[4]=e[4]*r,t[5]=e[5]*r,t[6]=e[6]*r,t[7]=e[7]*r,t[8]=e[8]*n,t[9]=e[9]*n,t[10]=e[10]*n,t[11]=e[11]*n,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},ps=function(t,s,i,r){var n,a,o,h,l,c,u,_,d,p,f,g,m,S,y,G,T,I,C,b,x,w,M,P,v=r[0],R=r[1],A=r[2],D=Math.hypot(v,R,A);return D<e?null:(v*=D=1/D,R*=D,A*=D,n=Math.sin(i),o=1-(a=Math.cos(i)),h=s[0],l=s[1],c=s[2],u=s[3],_=s[4],d=s[5],p=s[6],f=s[7],g=s[8],m=s[9],S=s[10],y=s[11],G=v*v*o+a,T=R*v*o+A*n,I=A*v*o-R*n,C=v*R*o-A*n,b=R*R*o+a,x=A*R*o+v*n,w=v*A*o+R*n,M=R*A*o-v*n,P=A*A*o+a,t[0]=h*G+_*T+g*I,t[1]=l*G+d*T+m*I,t[2]=c*G+p*T+S*I,t[3]=u*G+f*T+y*I,t[4]=h*C+_*b+g*x,t[5]=l*C+d*b+m*x,t[6]=c*C+p*b+S*x,t[7]=u*C+f*b+y*x,t[8]=h*w+_*M+g*P,t[9]=l*w+d*M+m*P,t[10]=c*w+p*M+S*P,t[11]=u*w+f*M+y*P,s!==t&&(t[12]=s[12],t[13]=s[13],t[14]=s[14],t[15]=s[15]),t)},fs=function(t,e,s){var i=Math.sin(s),r=Math.cos(s),n=e[4],a=e[5],o=e[6],h=e[7],l=e[8],c=e[9],u=e[10],_=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=n*r+l*i,t[5]=a*r+c*i,t[6]=o*r+u*i,t[7]=h*r+_*i,t[8]=l*r-n*i,t[9]=c*r-a*i,t[10]=u*r-o*i,t[11]=_*r-h*i,t},gs=function(t,e,s){var i=Math.sin(s),r=Math.cos(s),n=e[0],a=e[1],o=e[2],h=e[3],l=e[8],c=e[9],u=e[10],_=e[11];return e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=n*r-l*i,t[1]=a*r-c*i,t[2]=o*r-u*i,t[3]=h*r-_*i,t[8]=n*i+l*r,t[9]=a*i+c*r,t[10]=o*i+u*r,t[11]=h*i+_*r,t},ms=function(t,e,s){var i=Math.sin(s),r=Math.cos(s),n=e[0],a=e[1],o=e[2],h=e[3],l=e[4],c=e[5],u=e[6],_=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=n*r+l*i,t[1]=a*r+c*i,t[2]=o*r+u*i,t[3]=h*r+_*i,t[4]=l*r-n*i,t[5]=c*r-a*i,t[6]=u*r-o*i,t[7]=_*r-h*i,t},Ss=function(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1,t},ys=function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e[1],t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=e[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},Gs=function(t,s,i){var r,n,a,o=i[0],h=i[1],l=i[2],c=Math.hypot(o,h,l);return c<e?null:(o*=c=1/c,h*=c,l*=c,r=Math.sin(s),a=1-(n=Math.cos(s)),t[0]=o*o*a+n,t[1]=h*o*a+l*r,t[2]=l*o*a-h*r,t[3]=0,t[4]=o*h*a-l*r,t[5]=h*h*a+n,t[6]=l*h*a+o*r,t[7]=0,t[8]=o*l*a+h*r,t[9]=h*l*a-o*r,t[10]=l*l*a+n,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t)},Ts=function(t,e){var s=Math.sin(e),i=Math.cos(e);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=i,t[6]=s,t[7]=0,t[8]=0,t[9]=-s,t[10]=i,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},Is=function(t,e){var s=Math.sin(e),i=Math.cos(e);return t[0]=i,t[1]=0,t[2]=-s,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=s,t[9]=0,t[10]=i,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},Cs=function(t,e){var s=Math.sin(e),i=Math.cos(e);return t[0]=i,t[1]=s,t[2]=0,t[3]=0,t[4]=-s,t[5]=i,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},bs=function(t,e,s){var i=e[0],r=e[1],n=e[2],a=e[3],o=i+i,h=r+r,l=n+n,c=i*o,u=i*h,_=i*l,d=r*h,p=r*l,f=n*l,g=a*o,m=a*h,S=a*l;return t[0]=1-(d+f),t[1]=u+S,t[2]=_-m,t[3]=0,t[4]=u-S,t[5]=1-(c+f),t[6]=p+g,t[7]=0,t[8]=_+m,t[9]=p-g,t[10]=1-(c+d),t[11]=0,t[12]=s[0],t[13]=s[1],t[14]=s[2],t[15]=1,t},xs=function(t,e){var i=new s(3),r=-e[0],n=-e[1],a=-e[2],o=e[3],h=e[4],l=e[5],c=e[6],u=e[7],_=r*r+n*n+a*a+o*o;return _>0?(i[0]=2*(h*o+u*r+l*a-c*n)/_,i[1]=2*(l*o+u*n+c*r-h*a)/_,i[2]=2*(c*o+u*a+h*n-l*r)/_):(i[0]=2*(h*o+u*r+l*a-c*n),i[1]=2*(l*o+u*n+c*r-h*a),i[2]=2*(c*o+u*a+h*n-l*r)),bs(t,e,i),t},ws=function(t,e){return t[0]=e[12],t[1]=e[13],t[2]=e[14],t},Ms=function(t,e){var s=e[0],i=e[1],r=e[2],n=e[4],a=e[5],o=e[6],h=e[8],l=e[9],c=e[10];return t[0]=Math.hypot(s,i,r),t[1]=Math.hypot(n,a,o),t[2]=Math.hypot(h,l,c),t},Ps=function(t,e){var i=new s(3);Ms(i,e);var r=1/i[0],n=1/i[1],a=1/i[2],o=e[0]*r,h=e[1]*n,l=e[2]*a,c=e[4]*r,u=e[5]*n,_=e[6]*a,d=e[8]*r,p=e[9]*n,f=e[10]*a,g=o+u+f,m=0;return g>0?(m=2*Math.sqrt(g+1),t[3]=.25*m,t[0]=(_-p)/m,t[1]=(d-l)/m,t[2]=(h-c)/m):o>u&&o>f?(m=2*Math.sqrt(1+o-u-f),t[3]=(_-p)/m,t[0]=.25*m,t[1]=(h+c)/m,t[2]=(d+l)/m):u>f?(m=2*Math.sqrt(1+u-o-f),t[3]=(d-l)/m,t[0]=(h+c)/m,t[1]=.25*m,t[2]=(_+p)/m):(m=2*Math.sqrt(1+f-o-u),t[3]=(h-c)/m,t[0]=(d+l)/m,t[1]=(_+p)/m,t[2]=.25*m),t},vs=function(t,e,s,i){e[0]=i[12],e[1]=i[13],e[2]=i[14];var r=i[0],n=i[1],a=i[2],o=i[4],h=i[5],l=i[6],c=i[8],u=i[9],_=i[10];s[0]=Math.hypot(r,n,a),s[1]=Math.hypot(o,h,l),s[2]=Math.hypot(c,u,_);var d=1/s[0],p=1/s[1],f=1/s[2],g=r*d,m=n*p,S=a*f,y=o*d,G=h*p,T=l*f,I=c*d,C=u*p,b=_*f,x=g+G+b,w=0;return x>0?(w=2*Math.sqrt(x+1),t[3]=.25*w,t[0]=(T-C)/w,t[1]=(I-S)/w,t[2]=(m-y)/w):g>G&&g>b?(w=2*Math.sqrt(1+g-G-b),t[3]=(T-C)/w,t[0]=.25*w,t[1]=(m+y)/w,t[2]=(I+S)/w):G>b?(w=2*Math.sqrt(1+G-g-b),t[3]=(I-S)/w,t[0]=(m+y)/w,t[1]=.25*w,t[2]=(T+C)/w):(w=2*Math.sqrt(1+b-g-G),t[3]=(m-y)/w,t[0]=(I+S)/w,t[1]=(T+C)/w,t[2]=.25*w),t},Rs=function(t,e,s,i){var r=e[0],n=e[1],a=e[2],o=e[3],h=r+r,l=n+n,c=a+a,u=r*h,_=r*l,d=r*c,p=n*l,f=n*c,g=a*c,m=o*h,S=o*l,y=o*c,G=i[0],T=i[1],I=i[2];return t[0]=(1-(p+g))*G,t[1]=(_+y)*G,t[2]=(d-S)*G,t[3]=0,t[4]=(_-y)*T,t[5]=(1-(u+g))*T,t[6]=(f+m)*T,t[7]=0,t[8]=(d+S)*I,t[9]=(f-m)*I,t[10]=(1-(u+p))*I,t[11]=0,t[12]=s[0],t[13]=s[1],t[14]=s[2],t[15]=1,t},As=function(t,e,s,i,r){var n=e[0],a=e[1],o=e[2],h=e[3],l=n+n,c=a+a,u=o+o,_=n*l,d=n*c,p=n*u,f=a*c,g=a*u,m=o*u,S=h*l,y=h*c,G=h*u,T=i[0],I=i[1],C=i[2],b=r[0],x=r[1],w=r[2],M=(1-(f+m))*T,P=(d+G)*T,v=(p-y)*T,R=(d-G)*I,A=(1-(_+m))*I,D=(g+S)*I,E=(p+y)*C,F=(g-S)*C,O=(1-(_+f))*C;return t[0]=M,t[1]=P,t[2]=v,t[3]=0,t[4]=R,t[5]=A,t[6]=D,t[7]=0,t[8]=E,t[9]=F,t[10]=O,t[11]=0,t[12]=s[0]+b-(M*b+R*x+E*w),t[13]=s[1]+x-(P*b+A*x+F*w),t[14]=s[2]+w-(v*b+D*x+O*w),t[15]=1,t},Ds=function(t,e){var s=e[0],i=e[1],r=e[2],n=e[3],a=s+s,o=i+i,h=r+r,l=s*a,c=i*a,u=i*o,_=r*a,d=r*o,p=r*h,f=n*a,g=n*o,m=n*h;return t[0]=1-u-p,t[1]=c+m,t[2]=_-g,t[3]=0,t[4]=c-m,t[5]=1-l-p,t[6]=d+f,t[7]=0,t[8]=_+g,t[9]=d-f,t[10]=1-l-u,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},Es=function(t,e,s,i,r,n,a){var o=1/(s-e),h=1/(r-i),l=1/(n-a);return t[0]=2*n*o,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=2*n*h,t[6]=0,t[7]=0,t[8]=(s+e)*o,t[9]=(r+i)*h,t[10]=(a+n)*l,t[11]=-1,t[12]=0,t[13]=0,t[14]=a*n*2*l,t[15]=0,t},Fs=function(t,e,s,i,r){var n=1/Math.tan(e/2);if(t[0]=n/s,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=n,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=r&&r!==1/0){var a=1/(i-r);t[10]=(r+i)*a,t[14]=2*r*i*a}else t[10]=-1,t[14]=-2*i;return t},Os=function(t,e,s,i,r){var n=1/Math.tan(e/2);if(t[0]=n/s,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=n,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=r&&r!==1/0){var a=1/(i-r);t[10]=r*a,t[14]=r*i*a}else t[10]=-1,t[14]=-i;return t},Bs=function(t,e,s,i){var r=Math.tan(e.upDegrees*Math.PI/180),n=Math.tan(e.downDegrees*Math.PI/180),a=Math.tan(e.leftDegrees*Math.PI/180),o=Math.tan(e.rightDegrees*Math.PI/180),h=2/(a+o),l=2/(r+n);return t[0]=h,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=l,t[6]=0,t[7]=0,t[8]=-(a-o)*h*.5,t[9]=(r-n)*l*.5,t[10]=i/(s-i),t[11]=-1,t[12]=0,t[13]=0,t[14]=i*s/(s-i),t[15]=0,t},Ls=function(t,e,s,i,r,n,a){var o=1/(e-s),h=1/(i-r),l=1/(n-a);return t[0]=-2*o,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*h,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*l,t[11]=0,t[12]=(e+s)*o,t[13]=(r+i)*h,t[14]=(a+n)*l,t[15]=1,t},ks=function(t,e,s,i,r,n,a){var o=1/(e-s),h=1/(i-r),l=1/(n-a);return t[0]=-2*o,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*h,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=l,t[11]=0,t[12]=(e+s)*o,t[13]=(r+i)*h,t[14]=n*l,t[15]=1,t},Ns=function(t,s,i,r){var n,a,o,h,l,c,u,_,d,p,f=s[0],g=s[1],m=s[2],S=r[0],y=r[1],G=r[2],T=i[0],I=i[1],C=i[2];return Math.abs(f-T)<e&&Math.abs(g-I)<e&&Math.abs(m-C)<e?as(t):(u=f-T,_=g-I,d=m-C,n=y*(d*=p=1/Math.hypot(u,_,d))-G*(_*=p),a=G*(u*=p)-S*d,o=S*_-y*u,(p=Math.hypot(n,a,o))?(n*=p=1/p,a*=p,o*=p):(n=0,a=0,o=0),h=_*o-d*a,l=d*n-u*o,c=u*a-_*n,(p=Math.hypot(h,l,c))?(h*=p=1/p,l*=p,c*=p):(h=0,l=0,c=0),t[0]=n,t[1]=h,t[2]=u,t[3]=0,t[4]=a,t[5]=l,t[6]=_,t[7]=0,t[8]=o,t[9]=c,t[10]=d,t[11]=0,t[12]=-(n*f+a*g+o*m),t[13]=-(h*f+l*g+c*m),t[14]=-(u*f+_*g+d*m),t[15]=1,t)},Us=function(t,e,s,i){var r=e[0],n=e[1],a=e[2],o=i[0],h=i[1],l=i[2],c=r-s[0],u=n-s[1],_=a-s[2],d=c*c+u*u+_*_;d>0&&(c*=d=1/Math.sqrt(d),u*=d,_*=d);var p=h*_-l*u,f=l*c-o*_,g=o*u-h*c;return(d=p*p+f*f+g*g)>0&&(p*=d=1/Math.sqrt(d),f*=d,g*=d),t[0]=p,t[1]=f,t[2]=g,t[3]=0,t[4]=u*g-_*f,t[5]=_*p-c*g,t[6]=c*f-u*p,t[7]=0,t[8]=c,t[9]=u,t[10]=_,t[11]=0,t[12]=r,t[13]=n,t[14]=a,t[15]=1,t},Ws=function(t){return"mat4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+", "+t[9]+", "+t[10]+", "+t[11]+", "+t[12]+", "+t[13]+", "+t[14]+", "+t[15]+")"},js=function(t){return Math.hypot(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15])},Vs=function(t,e,s){return t[0]=e[0]+s[0],t[1]=e[1]+s[1],t[2]=e[2]+s[2],t[3]=e[3]+s[3],t[4]=e[4]+s[4],t[5]=e[5]+s[5],t[6]=e[6]+s[6],t[7]=e[7]+s[7],t[8]=e[8]+s[8],t[9]=e[9]+s[9],t[10]=e[10]+s[10],t[11]=e[11]+s[11],t[12]=e[12]+s[12],t[13]=e[13]+s[13],t[14]=e[14]+s[14],t[15]=e[15]+s[15],t},zs=function(t,e,s){return t[0]=e[0]-s[0],t[1]=e[1]-s[1],t[2]=e[2]-s[2],t[3]=e[3]-s[3],t[4]=e[4]-s[4],t[5]=e[5]-s[5],t[6]=e[6]-s[6],t[7]=e[7]-s[7],t[8]=e[8]-s[8],t[9]=e[9]-s[9],t[10]=e[10]-s[10],t[11]=e[11]-s[11],t[12]=e[12]-s[12],t[13]=e[13]-s[13],t[14]=e[14]-s[14],t[15]=e[15]-s[15],t},Hs=function(t,e,s){return t[0]=e[0]*s,t[1]=e[1]*s,t[2]=e[2]*s,t[3]=e[3]*s,t[4]=e[4]*s,t[5]=e[5]*s,t[6]=e[6]*s,t[7]=e[7]*s,t[8]=e[8]*s,t[9]=e[9]*s,t[10]=e[10]*s,t[11]=e[11]*s,t[12]=e[12]*s,t[13]=e[13]*s,t[14]=e[14]*s,t[15]=e[15]*s,t},Ys=function(t,e,s,i){return t[0]=e[0]+s[0]*i,t[1]=e[1]+s[1]*i,t[2]=e[2]+s[2]*i,t[3]=e[3]+s[3]*i,t[4]=e[4]+s[4]*i,t[5]=e[5]+s[5]*i,t[6]=e[6]+s[6]*i,t[7]=e[7]+s[7]*i,t[8]=e[8]+s[8]*i,t[9]=e[9]+s[9]*i,t[10]=e[10]+s[10]*i,t[11]=e[11]+s[11]*i,t[12]=e[12]+s[12]*i,t[13]=e[13]+s[13]*i,t[14]=e[14]+s[14]*i,t[15]=e[15]+s[15]*i,t},Xs=function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]&&t[9]===e[9]&&t[10]===e[10]&&t[11]===e[11]&&t[12]===e[12]&&t[13]===e[13]&&t[14]===e[14]&&t[15]===e[15]},qs=function(t,s){var i=t[0],r=t[1],n=t[2],a=t[3],o=t[4],h=t[5],l=t[6],c=t[7],u=t[8],_=t[9],d=t[10],p=t[11],f=t[12],g=t[13],m=t[14],S=t[15],y=s[0],G=s[1],T=s[2],I=s[3],C=s[4],b=s[5],x=s[6],w=s[7],M=s[8],P=s[9],v=s[10],R=s[11],A=s[12],D=s[13],E=s[14],F=s[15];return Math.abs(i-y)<=e*Math.max(1,Math.abs(i),Math.abs(y))&&Math.abs(r-G)<=e*Math.max(1,Math.abs(r),Math.abs(G))&&Math.abs(n-T)<=e*Math.max(1,Math.abs(n),Math.abs(T))&&Math.abs(a-I)<=e*Math.max(1,Math.abs(a),Math.abs(I))&&Math.abs(o-C)<=e*Math.max(1,Math.abs(o),Math.abs(C))&&Math.abs(h-b)<=e*Math.max(1,Math.abs(h),Math.abs(b))&&Math.abs(l-x)<=e*Math.max(1,Math.abs(l),Math.abs(x))&&Math.abs(c-w)<=e*Math.max(1,Math.abs(c),Math.abs(w))&&Math.abs(u-M)<=e*Math.max(1,Math.abs(u),Math.abs(M))&&Math.abs(_-P)<=e*Math.max(1,Math.abs(_),Math.abs(P))&&Math.abs(d-v)<=e*Math.max(1,Math.abs(d),Math.abs(v))&&Math.abs(p-R)<=e*Math.max(1,Math.abs(p),Math.abs(R))&&Math.abs(f-A)<=e*Math.max(1,Math.abs(f),Math.abs(A))&&Math.abs(g-D)<=e*Math.max(1,Math.abs(g),Math.abs(D))&&Math.abs(m-E)<=e*Math.max(1,Math.abs(m),Math.abs(E))&&Math.abs(S-F)<=e*Math.max(1,Math.abs(S),Math.abs(F))},Js=function(){var t=new s(3);return s!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t},Qs=function(t){var e=new s(3);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e},Ks=function(t){var e=t[0],s=t[1],i=t[2];return Math.hypot(e,s,i)},Zs=function(t,e,i){var r=new s(3);return r[0]=t,r[1]=e,r[2]=i,r},$s=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},ti=function(t,e,s,i){return t[0]=e,t[1]=s,t[2]=i,t},ei=function(t,e,s){return t[0]=e[0]+s[0],t[1]=e[1]+s[1],t[2]=e[2]+s[2],t},si=function(t,e,s){return t[0]=e[0]-s[0],t[1]=e[1]-s[1],t[2]=e[2]-s[2],t},ii=function(t,e,s){return t[0]=e[0]*s[0],t[1]=e[1]*s[1],t[2]=e[2]*s[2],t},ri=function(t,e,s){return t[0]=e[0]/s[0],t[1]=e[1]/s[1],t[2]=e[2]/s[2],t},ni=function(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t[2]=Math.ceil(e[2]),t},ai=function(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t[2]=Math.floor(e[2]),t},oi=function(t,e,s){return t[0]=Math.min(e[0],s[0]),t[1]=Math.min(e[1],s[1]),t[2]=Math.min(e[2],s[2]),t},hi=function(t,e,s){return t[0]=Math.max(e[0],s[0]),t[1]=Math.max(e[1],s[1]),t[2]=Math.max(e[2],s[2]),t},li=function(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t[2]=Math.round(e[2]),t},ci=function(t,e,s){return t[0]=e[0]*s,t[1]=e[1]*s,t[2]=e[2]*s,t},ui=function(t,e,s,i){return t[0]=e[0]+s[0]*i,t[1]=e[1]+s[1]*i,t[2]=e[2]+s[2]*i,t},_i=function(t,e){var s=e[0]-t[0],i=e[1]-t[1],r=e[2]-t[2];return Math.hypot(s,i,r)},di=function(t,e){var s=e[0]-t[0],i=e[1]-t[1],r=e[2]-t[2];return s*s+i*i+r*r},pi=function(t){var e=t[0],s=t[1],i=t[2];return e*e+s*s+i*i},fi=function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t},gi=function(t,e){return t[0]=1/e[0],t[1]=1/e[1],t[2]=1/e[2],t},mi=function(t,e){var s=e[0],i=e[1],r=e[2],n=s*s+i*i+r*r;return n>0&&(n=1/Math.sqrt(n)),t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t},Si=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]},yi=function(t,e,s){var i=e[0],r=e[1],n=e[2],a=s[0],o=s[1],h=s[2];return t[0]=r*h-n*o,t[1]=n*a-i*h,t[2]=i*o-r*a,t},Gi=function(t,e,s,i){var r=e[0],n=e[1],a=e[2];return t[0]=r+i*(s[0]-r),t[1]=n+i*(s[1]-n),t[2]=a+i*(s[2]-a),t},Ti=function(t,e,s,i){var r=Math.acos(Math.min(Math.max(Si(e,s),-1),1)),n=Math.sin(r),a=Math.sin((1-i)*r)/n,o=Math.sin(i*r)/n;return t[0]=a*e[0]+o*s[0],t[1]=a*e[1]+o*s[1],t[2]=a*e[2]+o*s[2],t},Ii=function(t,e,s,i,r,n){var a=n*n,o=a*(2*n-3)+1,h=a*(n-2)+n,l=a*(n-1),c=a*(3-2*n);return t[0]=e[0]*o+s[0]*h+i[0]*l+r[0]*c,t[1]=e[1]*o+s[1]*h+i[1]*l+r[1]*c,t[2]=e[2]*o+s[2]*h+i[2]*l+r[2]*c,t},Ci=function(t,e,s,i,r,n){var a=1-n,o=a*a,h=n*n,l=o*a,c=3*n*o,u=3*h*a,_=h*n;return t[0]=e[0]*l+s[0]*c+i[0]*u+r[0]*_,t[1]=e[1]*l+s[1]*c+i[1]*u+r[1]*_,t[2]=e[2]*l+s[2]*c+i[2]*u+r[2]*_,t},bi=function(t,e){e=e||1;var s=2*i()*Math.PI,r=2*i()-1,n=Math.sqrt(1-r*r)*e;return t[0]=Math.cos(s)*n,t[1]=Math.sin(s)*n,t[2]=r*e,t},xi=function(t,e,s){var i=e[0],r=e[1],n=e[2],a=s[3]*i+s[7]*r+s[11]*n+s[15];return a=a||1,t[0]=(s[0]*i+s[4]*r+s[8]*n+s[12])/a,t[1]=(s[1]*i+s[5]*r+s[9]*n+s[13])/a,t[2]=(s[2]*i+s[6]*r+s[10]*n+s[14])/a,t},wi=function(t,e,s){var i=e[0],r=e[1],n=e[2];return t[0]=i*s[0]+r*s[3]+n*s[6],t[1]=i*s[1]+r*s[4]+n*s[7],t[2]=i*s[2]+r*s[5]+n*s[8],t},Mi=function(t,e,s){var i=s[0],r=s[1],n=s[2],a=s[3],o=e[0],h=e[1],l=e[2],c=r*l-n*h,u=n*o-i*l,_=i*h-r*o,d=r*_-n*u,p=n*c-i*_,f=i*u-r*c,g=2*a;return c*=g,u*=g,_*=g,d*=2,p*=2,f*=2,t[0]=o+c+d,t[1]=h+u+p,t[2]=l+_+f,t},Pi=function(t,e,s,i){var r=[],n=[];return r[0]=e[0]-s[0],r[1]=e[1]-s[1],r[2]=e[2]-s[2],n[0]=r[0],n[1]=r[1]*Math.cos(i)-r[2]*Math.sin(i),n[2]=r[1]*Math.sin(i)+r[2]*Math.cos(i),t[0]=n[0]+s[0],t[1]=n[1]+s[1],t[2]=n[2]+s[2],t},vi=function(t,e,s,i){var r=[],n=[];return r[0]=e[0]-s[0],r[1]=e[1]-s[1],r[2]=e[2]-s[2],n[0]=r[2]*Math.sin(i)+r[0]*Math.cos(i),n[1]=r[1],n[2]=r[2]*Math.cos(i)-r[0]*Math.sin(i),t[0]=n[0]+s[0],t[1]=n[1]+s[1],t[2]=n[2]+s[2],t},Ri=function(t,e,s,i){var r=[],n=[];return r[0]=e[0]-s[0],r[1]=e[1]-s[1],r[2]=e[2]-s[2],n[0]=r[0]*Math.cos(i)-r[1]*Math.sin(i),n[1]=r[0]*Math.sin(i)+r[1]*Math.cos(i),n[2]=r[2],t[0]=n[0]+s[0],t[1]=n[1]+s[1],t[2]=n[2]+s[2],t},Ai=function(t,e){var s=t[0],i=t[1],r=t[2],n=e[0],a=e[1],o=e[2],h=Math.sqrt((s*s+i*i+r*r)*(n*n+a*a+o*o)),l=h&&Si(t,e)/h;return Math.acos(Math.min(Math.max(l,-1),1))},Di=function(t){return t[0]=0,t[1]=0,t[2]=0,t},Ei=function(t){return"vec3("+t[0]+", "+t[1]+", "+t[2]+")"},Fi=function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]},Oi=function(t,s){var i=t[0],r=t[1],n=t[2],a=s[0],o=s[1],h=s[2];return Math.abs(i-a)<=e*Math.max(1,Math.abs(i),Math.abs(a))&&Math.abs(r-o)<=e*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(n-h)<=e*Math.max(1,Math.abs(n),Math.abs(h))},Bi=function(){var t=new s(4);return s!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t},Li=function(t){var e=new s(4);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},ki=function(t,e,i,r){var n=new s(4);return n[0]=t,n[1]=e,n[2]=i,n[3]=r,n},Ni=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},Ui=function(t,e,s,i,r){return t[0]=e,t[1]=s,t[2]=i,t[3]=r,t},Wi=function(t,e,s){return t[0]=e[0]+s[0],t[1]=e[1]+s[1],t[2]=e[2]+s[2],t[3]=e[3]+s[3],t},ji=function(t,e,s){return t[0]=e[0]-s[0],t[1]=e[1]-s[1],t[2]=e[2]-s[2],t[3]=e[3]-s[3],t},Vi=function(t,e,s){return t[0]=e[0]*s[0],t[1]=e[1]*s[1],t[2]=e[2]*s[2],t[3]=e[3]*s[3],t},zi=function(t,e,s){return t[0]=e[0]/s[0],t[1]=e[1]/s[1],t[2]=e[2]/s[2],t[3]=e[3]/s[3],t},Hi=function(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t[2]=Math.ceil(e[2]),t[3]=Math.ceil(e[3]),t},Yi=function(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t[2]=Math.floor(e[2]),t[3]=Math.floor(e[3]),t},Xi=function(t,e,s){return t[0]=Math.min(e[0],s[0]),t[1]=Math.min(e[1],s[1]),t[2]=Math.min(e[2],s[2]),t[3]=Math.min(e[3],s[3]),t},qi=function(t,e,s){return t[0]=Math.max(e[0],s[0]),t[1]=Math.max(e[1],s[1]),t[2]=Math.max(e[2],s[2]),t[3]=Math.max(e[3],s[3]),t},Ji=function(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t[2]=Math.round(e[2]),t[3]=Math.round(e[3]),t},Qi=function(t,e,s){return t[0]=e[0]*s,t[1]=e[1]*s,t[2]=e[2]*s,t[3]=e[3]*s,t},Ki=function(t,e,s,i){return t[0]=e[0]+s[0]*i,t[1]=e[1]+s[1]*i,t[2]=e[2]+s[2]*i,t[3]=e[3]+s[3]*i,t},Zi=function(t,e){var s=e[0]-t[0],i=e[1]-t[1],r=e[2]-t[2],n=e[3]-t[3];return Math.hypot(s,i,r,n)},$i=function(t,e){var s=e[0]-t[0],i=e[1]-t[1],r=e[2]-t[2],n=e[3]-t[3];return s*s+i*i+r*r+n*n},tr=function(t){var e=t[0],s=t[1],i=t[2],r=t[3];return Math.hypot(e,s,i,r)},er=function(t){var e=t[0],s=t[1],i=t[2],r=t[3];return e*e+s*s+i*i+r*r},sr=function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t},ir=function(t,e){return t[0]=1/e[0],t[1]=1/e[1],t[2]=1/e[2],t[3]=1/e[3],t},rr=function(t,e){var s=e[0],i=e[1],r=e[2],n=e[3],a=s*s+i*i+r*r+n*n;return a>0&&(a=1/Math.sqrt(a)),t[0]=s*a,t[1]=i*a,t[2]=r*a,t[3]=n*a,t},nr=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]},ar=function(t,e,s,i){var r=s[0]*i[1]-s[1]*i[0],n=s[0]*i[2]-s[2]*i[0],a=s[0]*i[3]-s[3]*i[0],o=s[1]*i[2]-s[2]*i[1],h=s[1]*i[3]-s[3]*i[1],l=s[2]*i[3]-s[3]*i[2],c=e[0],u=e[1],_=e[2],d=e[3];return t[0]=u*l-_*h+d*o,t[1]=-c*l+_*a-d*n,t[2]=c*h-u*a+d*r,t[3]=-c*o+u*n-_*r,t},or=function(t,e,s,i){var r=e[0],n=e[1],a=e[2],o=e[3];return t[0]=r+i*(s[0]-r),t[1]=n+i*(s[1]-n),t[2]=a+i*(s[2]-a),t[3]=o+i*(s[3]-o),t},hr=function(t,e){var s,r,n,a,o,h;e=e||1;do{o=(s=2*i()-1)*s+(r=2*i()-1)*r}while(o>=1);do{h=(n=2*i()-1)*n+(a=2*i()-1)*a}while(h>=1);var l=Math.sqrt((1-o)/h);return t[0]=e*s,t[1]=e*r,t[2]=e*n*l,t[3]=e*a*l,t},lr=function(t,e,s){var i=e[0],r=e[1],n=e[2],a=e[3];return t[0]=s[0]*i+s[4]*r+s[8]*n+s[12]*a,t[1]=s[1]*i+s[5]*r+s[9]*n+s[13]*a,t[2]=s[2]*i+s[6]*r+s[10]*n+s[14]*a,t[3]=s[3]*i+s[7]*r+s[11]*n+s[15]*a,t},cr=function(t,e,s){var i=e[0],r=e[1],n=e[2],a=s[0],o=s[1],h=s[2],l=s[3],c=l*i+o*n-h*r,u=l*r+h*i-a*n,_=l*n+a*r-o*i,d=-a*i-o*r-h*n;return t[0]=c*l+d*-a+u*-h-_*-o,t[1]=u*l+d*-o+_*-a-c*-h,t[2]=_*l+d*-h+c*-o-u*-a,t[3]=e[3],t},ur=function(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=0,t},_r=function(t){return"vec4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"},dr=function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]},pr=function(t,s){var i=t[0],r=t[1],n=t[2],a=t[3],o=s[0],h=s[1],l=s[2],c=s[3];return Math.abs(i-o)<=e*Math.max(1,Math.abs(i),Math.abs(o))&&Math.abs(r-h)<=e*Math.max(1,Math.abs(r),Math.abs(h))&&Math.abs(n-l)<=e*Math.max(1,Math.abs(n),Math.abs(l))&&Math.abs(a-c)<=e*Math.max(1,Math.abs(a),Math.abs(c))},fr=function(){var t=new s(4);return s!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t},gr=function(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t},mr=function(t,e,s){s*=.5;var i=Math.sin(s);return t[0]=i*e[0],t[1]=i*e[1],t[2]=i*e[2],t[3]=Math.cos(s),t},Sr=function(t,s){var i=2*Math.acos(s[3]),r=Math.sin(i/2);return r>e?(t[0]=s[0]/r,t[1]=s[1]/r,t[2]=s[2]/r):(t[0]=1,t[1]=0,t[2]=0),i},yr=function(t,e){var s=Y(t,e);return Math.acos(2*s*s-1)},Gr=function(t,e,s){var i=e[0],r=e[1],n=e[2],a=e[3],o=s[0],h=s[1],l=s[2],c=s[3];return t[0]=i*c+a*o+r*l-n*h,t[1]=r*c+a*h+n*o-i*l,t[2]=n*c+a*l+i*h-r*o,t[3]=a*c-i*o-r*h-n*l,t},Tr=function(t,e,s){s*=.5;var i=e[0],r=e[1],n=e[2],a=e[3],o=Math.sin(s),h=Math.cos(s);return t[0]=i*h+a*o,t[1]=r*h+n*o,t[2]=n*h-r*o,t[3]=a*h-i*o,t},Ir=function(t,e,s){s*=.5;var i=e[0],r=e[1],n=e[2],a=e[3],o=Math.sin(s),h=Math.cos(s);return t[0]=i*h-n*o,t[1]=r*h+a*o,t[2]=n*h+i*o,t[3]=a*h-r*o,t},Cr=function(t,e,s){s*=.5;var i=e[0],r=e[1],n=e[2],a=e[3],o=Math.sin(s),h=Math.cos(s);return t[0]=i*h+r*o,t[1]=r*h-i*o,t[2]=n*h+a*o,t[3]=a*h-n*o,t},br=function(t,e){var s=e[0],i=e[1],r=e[2];return t[0]=s,t[1]=i,t[2]=r,t[3]=Math.sqrt(Math.abs(1-s*s-i*i-r*r)),t},xr=function(t,e){var s=e[0],i=e[1],r=e[2],n=e[3],a=Math.sqrt(s*s+i*i+r*r),o=Math.exp(n),h=a>0?o*Math.sin(a)/a:0;return t[0]=s*h,t[1]=i*h,t[2]=r*h,t[3]=o*Math.cos(a),t},wr=function(t,e){var s=e[0],i=e[1],r=e[2],n=e[3],a=Math.sqrt(s*s+i*i+r*r),o=a>0?Math.atan2(a,n)/a:0;return t[0]=s*o,t[1]=i*o,t[2]=r*o,t[3]=.5*Math.log(s*s+i*i+r*r+n*n),t},Mr=function(t,e,s){return wr(t,e),H(t,t,s),xr(t,t),t},Pr=function(t,s,i,r){var n,a,o,h,l,c=s[0],u=s[1],_=s[2],d=s[3],p=i[0],f=i[1],g=i[2],m=i[3];return(a=c*p+u*f+_*g+d*m)<0&&(a=-a,p=-p,f=-f,g=-g,m=-m),1-a>e?(n=Math.acos(a),o=Math.sin(n),h=Math.sin((1-r)*n)/o,l=Math.sin(r*n)/o):(h=1-r,l=r),t[0]=h*c+l*p,t[1]=h*u+l*f,t[2]=h*_+l*g,t[3]=h*d+l*m,t},vr=function(t){var e=i(),s=i(),r=i(),n=Math.sqrt(1-e),a=Math.sqrt(e);return t[0]=n*Math.sin(2*Math.PI*s),t[1]=n*Math.cos(2*Math.PI*s),t[2]=a*Math.sin(2*Math.PI*r),t[3]=a*Math.cos(2*Math.PI*r),t},Rr=function(t,e){var s=e[0],i=e[1],r=e[2],n=e[3],a=s*s+i*i+r*r+n*n,o=a?1/a:0;return t[0]=-s*o,t[1]=-i*o,t[2]=-r*o,t[3]=n*o,t},Ar=function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t},Dr=function(t,e){var s,i=e[0]+e[4]+e[8];if(i>0)s=Math.sqrt(i+1),t[3]=.5*s,s=.5/s,t[0]=(e[5]-e[7])*s,t[1]=(e[6]-e[2])*s,t[2]=(e[1]-e[3])*s;else{var r=0;e[4]>e[0]&&(r=1),e[8]>e[3*r+r]&&(r=2);var n=(r+1)%3,a=(r+2)%3;s=Math.sqrt(e[3*r+r]-e[3*n+n]-e[3*a+a]+1),t[r]=.5*s,s=.5/s,t[3]=(e[3*n+a]-e[3*a+n])*s,t[n]=(e[3*n+r]+e[3*r+n])*s,t[a]=(e[3*a+r]+e[3*r+a])*s}return t},Er=function(t,e,s,i){var n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:r,a=Math.PI/360;e*=a,i*=a,s*=a;var o=Math.sin(e),h=Math.cos(e),l=Math.sin(s),c=Math.cos(s),u=Math.sin(i),_=Math.cos(i);switch(n){case"xyz":t[0]=o*c*_+h*l*u,t[1]=h*l*_-o*c*u,t[2]=h*c*u+o*l*_,t[3]=h*c*_-o*l*u;break;case"xzy":t[0]=o*c*_-h*l*u,t[1]=h*l*_-o*c*u,t[2]=h*c*u+o*l*_,t[3]=h*c*_+o*l*u;break;case"yxz":t[0]=o*c*_+h*l*u,t[1]=h*l*_-o*c*u,t[2]=h*c*u-o*l*_,t[3]=h*c*_+o*l*u;break;case"yzx":t[0]=o*c*_+h*l*u,t[1]=h*l*_+o*c*u,t[2]=h*c*u-o*l*_,t[3]=h*c*_-o*l*u;break;case"zxy":t[0]=o*c*_-h*l*u,t[1]=h*l*_+o*c*u,t[2]=h*c*u+o*l*_,t[3]=h*c*_-o*l*u;break;case"zyx":t[0]=o*c*_-h*l*u,t[1]=h*l*_+o*c*u,t[2]=h*c*u-o*l*_,t[3]=h*c*_+o*l*u;break;default:throw new Error("Unknown angle order "+n)}return t},Fr=function(t){return"quat("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"},Or=function(t,s){return Math.abs(nr(t,s))>=1-e},Br=function(){var t=new s(8);return s!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[4]=0,t[5]=0,t[6]=0,t[7]=0),t[3]=1,t},Lr=function(t){var e=new s(8);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e},kr=function(t,e,i,r,n,a,o,h){var l=new s(8);return l[0]=t,l[1]=e,l[2]=i,l[3]=r,l[4]=n,l[5]=a,l[6]=o,l[7]=h,l},Nr=function(t,e,i,r,n,a,o){var h=new s(8);h[0]=t,h[1]=e,h[2]=i,h[3]=r;var l=.5*n,c=.5*a,u=.5*o;return h[4]=l*r+c*i-u*e,h[5]=c*r+u*t-l*i,h[6]=u*r+l*e-c*t,h[7]=-l*t-c*e-u*i,h},Ur=function(t,e,s){var i=.5*s[0],r=.5*s[1],n=.5*s[2],a=e[0],o=e[1],h=e[2],l=e[3];return t[0]=a,t[1]=o,t[2]=h,t[3]=l,t[4]=i*l+r*h-n*o,t[5]=r*l+n*a-i*h,t[6]=n*l+i*o-r*a,t[7]=-i*a-r*o-n*h,t},Wr=function(t,e){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t[4]=.5*e[0],t[5]=.5*e[1],t[6]=.5*e[2],t[7]=0,t},jr=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=0,t[5]=0,t[6]=0,t[7]=0,t},Vr=function(t,e){var i=fr();Ps(i,e);var r=new s(3);return ws(r,e),Ur(t,i,r),t},zr=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t},Hr=function(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t[4]=0,t[5]=0,t[6]=0,t[7]=0,t},Yr=function(t,e,s,i,r,n,a,o,h){return t[0]=e,t[1]=s,t[2]=i,t[3]=r,t[4]=n,t[5]=a,t[6]=o,t[7]=h,t},Xr=function(t,e){return t[0]=e[4],t[1]=e[5],t[2]=e[6],t[3]=e[7],t},qr=function(t,e){return t[4]=e[0],t[5]=e[1],t[6]=e[2],t[7]=e[3],t},Jr=function(t,e){var s=e[4],i=e[5],r=e[6],n=e[7],a=-e[0],o=-e[1],h=-e[2],l=e[3];return t[0]=2*(s*l+n*a+i*h-r*o),t[1]=2*(i*l+n*o+r*a-s*h),t[2]=2*(r*l+n*h+s*o-i*a),t},Qr=function(t,e,s){var i=e[0],r=e[1],n=e[2],a=e[3],o=.5*s[0],h=.5*s[1],l=.5*s[2],c=e[4],u=e[5],_=e[6],d=e[7];return t[0]=i,t[1]=r,t[2]=n,t[3]=a,t[4]=a*o+r*l-n*h+c,t[5]=a*h+n*o-i*l+u,t[6]=a*l+i*h-r*o+_,t[7]=-i*o-r*h-n*l+d,t},Kr=function(t,e,s){var i=-e[0],r=-e[1],n=-e[2],a=e[3],o=e[4],h=e[5],l=e[6],c=e[7],u=o*a+c*i+h*n-l*r,_=h*a+c*r+l*i-o*n,d=l*a+c*n+o*r-h*i,p=c*a-o*i-h*r-l*n;return Tr(t,e,s),i=t[0],r=t[1],n=t[2],a=t[3],t[4]=u*a+p*i+_*n-d*r,t[5]=_*a+p*r+d*i-u*n,t[6]=d*a+p*n+u*r-_*i,t[7]=p*a-u*i-_*r-d*n,t},Zr=function(t,e,s){var i=-e[0],r=-e[1],n=-e[2],a=e[3],o=e[4],h=e[5],l=e[6],c=e[7],u=o*a+c*i+h*n-l*r,_=h*a+c*r+l*i-o*n,d=l*a+c*n+o*r-h*i,p=c*a-o*i-h*r-l*n;return Ir(t,e,s),i=t[0],r=t[1],n=t[2],a=t[3],t[4]=u*a+p*i+_*n-d*r,t[5]=_*a+p*r+d*i-u*n,t[6]=d*a+p*n+u*r-_*i,t[7]=p*a-u*i-_*r-d*n,t},$r=function(t,e,s){var i=-e[0],r=-e[1],n=-e[2],a=e[3],o=e[4],h=e[5],l=e[6],c=e[7],u=o*a+c*i+h*n-l*r,_=h*a+c*r+l*i-o*n,d=l*a+c*n+o*r-h*i,p=c*a-o*i-h*r-l*n;return Cr(t,e,s),i=t[0],r=t[1],n=t[2],a=t[3],t[4]=u*a+p*i+_*n-d*r,t[5]=_*a+p*r+d*i-u*n,t[6]=d*a+p*n+u*r-_*i,t[7]=p*a-u*i-_*r-d*n,t},tn=function(t,e,s){var i=s[0],r=s[1],n=s[2],a=s[3],o=e[0],h=e[1],l=e[2],c=e[3];return t[0]=o*a+c*i+h*n-l*r,t[1]=h*a+c*r+l*i-o*n,t[2]=l*a+c*n+o*r-h*i,t[3]=c*a-o*i-h*r-l*n,o=e[4],h=e[5],l=e[6],c=e[7],t[4]=o*a+c*i+h*n-l*r,t[5]=h*a+c*r+l*i-o*n,t[6]=l*a+c*n+o*r-h*i,t[7]=c*a-o*i-h*r-l*n,t},en=function(t,e,s){var i=e[0],r=e[1],n=e[2],a=e[3],o=s[0],h=s[1],l=s[2],c=s[3];return t[0]=i*c+a*o+r*l-n*h,t[1]=r*c+a*h+n*o-i*l,t[2]=n*c+a*l+i*h-r*o,t[3]=a*c-i*o-r*h-n*l,o=s[4],h=s[5],l=s[6],c=s[7],t[4]=i*c+a*o+r*l-n*h,t[5]=r*c+a*h+n*o-i*l,t[6]=n*c+a*l+i*h-r*o,t[7]=a*c-i*o-r*h-n*l,t},sn=function(t,s,i,r){if(Math.abs(r)<e)return zr(t,s);var n=Math.hypot(i[0],i[1],i[2]);r*=.5;var a=Math.sin(r),o=a*i[0]/n,h=a*i[1]/n,l=a*i[2]/n,c=Math.cos(r),u=s[0],_=s[1],d=s[2],p=s[3];t[0]=u*c+p*o+_*l-d*h,t[1]=_*c+p*h+d*o-u*l,t[2]=d*c+p*l+u*h-_*o,t[3]=p*c-u*o-_*h-d*l;var f=s[4],g=s[5],m=s[6],S=s[7];return t[4]=f*c+S*o+g*l-m*h,t[5]=g*c+S*h+m*o-f*l,t[6]=m*c+S*l+f*h-g*o,t[7]=S*c-f*o-g*h-m*l,t},rn=function(t,e,s){return t[0]=e[0]+s[0],t[1]=e[1]+s[1],t[2]=e[2]+s[2],t[3]=e[3]+s[3],t[4]=e[4]+s[4],t[5]=e[5]+s[5],t[6]=e[6]+s[6],t[7]=e[7]+s[7],t},nn=function(t,e,s){var i=e[0],r=e[1],n=e[2],a=e[3],o=s[4],h=s[5],l=s[6],c=s[7],u=e[4],_=e[5],d=e[6],p=e[7],f=s[0],g=s[1],m=s[2],S=s[3];return t[0]=i*S+a*f+r*m-n*g,t[1]=r*S+a*g+n*f-i*m,t[2]=n*S+a*m+i*g-r*f,t[3]=a*S-i*f-r*g-n*m,t[4]=i*c+a*o+r*l-n*h+u*S+p*f+_*m-d*g,t[5]=r*c+a*h+n*o-i*l+_*S+p*g+d*f-u*m,t[6]=n*c+a*l+i*h-r*o+d*S+p*m+u*g-_*f,t[7]=a*c-i*o-r*h-n*l+p*S-u*f-_*g-d*m,t},an=function(t,e,s){return t[0]=e[0]*s,t[1]=e[1]*s,t[2]=e[2]*s,t[3]=e[3]*s,t[4]=e[4]*s,t[5]=e[5]*s,t[6]=e[6]*s,t[7]=e[7]*s,t},on=function(t,e,s,i){var r=1-i;return ot(e,s)<0&&(i=-i),t[0]=e[0]*r+s[0]*i,t[1]=e[1]*r+s[1]*i,t[2]=e[2]*r+s[2]*i,t[3]=e[3]*r+s[3]*i,t[4]=e[4]*r+s[4]*i,t[5]=e[5]*r+s[5]*i,t[6]=e[6]*r+s[6]*i,t[7]=e[7]*r+s[7]*i,t},hn=function(t,e){var s=ct(e);return t[0]=-e[0]/s,t[1]=-e[1]/s,t[2]=-e[2]/s,t[3]=e[3]/s,t[4]=-e[4]/s,t[5]=-e[5]/s,t[6]=-e[6]/s,t[7]=e[7]/s,t},ln=function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t[4]=-e[4],t[5]=-e[5],t[6]=-e[6],t[7]=e[7],t},cn=function(t,e){var s=ct(e);if(s>0){s=Math.sqrt(s);var i=e[0]/s,r=e[1]/s,n=e[2]/s,a=e[3]/s,o=e[4],h=e[5],l=e[6],c=e[7],u=i*o+r*h+n*l+a*c;t[0]=i,t[1]=r,t[2]=n,t[3]=a,t[4]=(o-i*u)/s,t[5]=(h-r*u)/s,t[6]=(l-n*u)/s,t[7]=(c-a*u)/s}return t},un=function(t){return"quat2("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+")"},_n=function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]},dn=function(t,s){var i=t[0],r=t[1],n=t[2],a=t[3],o=t[4],h=t[5],l=t[6],c=t[7],u=s[0],_=s[1],d=s[2],p=s[3],f=s[4],g=s[5],m=s[6],S=s[7];return Math.abs(i-u)<=e*Math.max(1,Math.abs(i),Math.abs(u))&&Math.abs(r-_)<=e*Math.max(1,Math.abs(r),Math.abs(_))&&Math.abs(n-d)<=e*Math.max(1,Math.abs(n),Math.abs(d))&&Math.abs(a-p)<=e*Math.max(1,Math.abs(a),Math.abs(p))&&Math.abs(o-f)<=e*Math.max(1,Math.abs(o),Math.abs(f))&&Math.abs(h-g)<=e*Math.max(1,Math.abs(h),Math.abs(g))&&Math.abs(l-m)<=e*Math.max(1,Math.abs(l),Math.abs(m))&&Math.abs(c-S)<=e*Math.max(1,Math.abs(c),Math.abs(S))},pn=function(){var t=new s(2);return s!=Float32Array&&(t[0]=0,t[1]=0),t},fn=function(t){var e=new s(2);return e[0]=t[0],e[1]=t[1],e},gn=function(t,e){var i=new s(2);return i[0]=t,i[1]=e,i},mn=function(t,e){return t[0]=e[0],t[1]=e[1],t},Sn=function(t,e,s){return t[0]=e,t[1]=s,t},yn=function(t,e,s){return t[0]=e[0]+s[0],t[1]=e[1]+s[1],t},Gn=function(t,e,s){return t[0]=e[0]-s[0],t[1]=e[1]-s[1],t},Tn=function(t,e,s){return t[0]=e[0]*s[0],t[1]=e[1]*s[1],t},In=function(t,e,s){return t[0]=e[0]/s[0],t[1]=e[1]/s[1],t},Cn=function(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t},bn=function(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t},xn=function(t,e,s){return t[0]=Math.min(e[0],s[0]),t[1]=Math.min(e[1],s[1]),t},wn=function(t,e,s){return t[0]=Math.max(e[0],s[0]),t[1]=Math.max(e[1],s[1]),t},Mn=function(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t},Pn=function(t,e,s){return t[0]=e[0]*s,t[1]=e[1]*s,t},vn=function(t,e,s,i){return t[0]=e[0]+s[0]*i,t[1]=e[1]+s[1]*i,t},Rn=function(t,e){var s=e[0]-t[0],i=e[1]-t[1];return Math.hypot(s,i)},An=function(t,e){var s=e[0]-t[0],i=e[1]-t[1];return s*s+i*i},Dn=function(t){var e=t[0],s=t[1];return Math.hypot(e,s)},En=function(t){var e=t[0],s=t[1];return e*e+s*s},Fn=function(t,e){return t[0]=-e[0],t[1]=-e[1],t},On=function(t,e){return t[0]=1/e[0],t[1]=1/e[1],t},Bn=function(t,e){var s=e[0],i=e[1],r=s*s+i*i;return r>0&&(r=1/Math.sqrt(r)),t[0]=e[0]*r,t[1]=e[1]*r,t},Ln=function(t,e){return t[0]*e[0]+t[1]*e[1]},kn=function(t,e,s){var i=e[0]*s[1]-e[1]*s[0];return t[0]=t[1]=0,t[2]=i,t},Nn=function(t,e,s,i){var r=e[0],n=e[1];return t[0]=r+i*(s[0]-r),t[1]=n+i*(s[1]-n),t},Un=function(t,e){e=e||1;var s=2*i()*Math.PI;return t[0]=Math.cos(s)*e,t[1]=Math.sin(s)*e,t},Wn=function(t,e,s){var i=e[0],r=e[1];return t[0]=s[0]*i+s[2]*r,t[1]=s[1]*i+s[3]*r,t},jn=function(t,e,s){var i=e[0],r=e[1];return t[0]=s[0]*i+s[2]*r+s[4],t[1]=s[1]*i+s[3]*r+s[5],t},Vn=function(t,e,s){var i=e[0],r=e[1];return t[0]=s[0]*i+s[3]*r+s[6],t[1]=s[1]*i+s[4]*r+s[7],t},zn=function(t,e,s){var i=e[0],r=e[1];return t[0]=s[0]*i+s[4]*r+s[12],t[1]=s[1]*i+s[5]*r+s[13],t},Hn=function(t,e,s,i){var r=e[0]-s[0],n=e[1]-s[1],a=Math.sin(i),o=Math.cos(i);return t[0]=r*o-n*a+s[0],t[1]=r*a+n*o+s[1],t},Yn=function(t,e){var s=t[0],i=t[1],r=e[0],n=e[1],a=Math.sqrt((s*s+i*i)*(r*r+n*n)),o=a&&(s*r+i*n)/a;return Math.acos(Math.min(Math.max(o,-1),1))},Xn=function(t){return t[0]=0,t[1]=0,t},qn=function(t){return"vec2("+t[0]+", "+t[1]+")"},Jn=function(t,e){return t[0]===e[0]&&t[1]===e[1]},Qn=function(t,s){var i=t[0],r=t[1],n=s[0],a=s[1];return Math.abs(i-n)<=e*Math.max(1,Math.abs(i),Math.abs(n))&&Math.abs(r-a)<=e*Math.max(1,Math.abs(r),Math.abs(a))};e=1e-6,s="undefined"!=typeof Float32Array?Float32Array:Array,i=Math.random,r="zyx",n=Math.PI/180,Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)}),a={__proto__:null,EPSILON:e,get ARRAY_TYPE(){return s},RANDOM:i,ANGLE_ORDER:r,setMatrixArrayType:vt,toRadian:Rt,equals:At},o=jt,h=Kt,l=Object.freeze({__proto__:null,create:Dt,clone:Et,copy:Ft,identity:Ot,fromValues:Bt,set:Lt,transpose:kt,invert:Nt,adjoint:Ut,determinant:Wt,multiply:jt,rotate:Vt,scale:zt,fromRotation:Ht,fromScaling:Yt,str:Xt,frob:qt,LDU:Jt,add:Qt,subtract:Kt,exactEquals:Zt,equals:$t,multiplyScalar:te,multiplyScalarAndAdd:ee,mul:o,sub:h}),c=ce,u=Ge,_=Object.freeze({__proto__:null,create:se,clone:ie,copy:re,identity:ne,fromValues:ae,set:oe,invert:he,determinant:le,multiply:ce,rotate:ue,scale:_e,translate:de,fromRotation:pe,fromScaling:fe,fromTranslation:ge,str:me,frob:Se,add:ye,subtract:Ge,multiplyScalar:Te,multiplyScalarAndAdd:Ie,exactEquals:Ce,equals:be,mul:c,sub:u}),d=Be,p=Qe,f=Object.freeze({__proto__:null,create:xe,fromMat4:we,clone:Me,copy:Pe,fromValues:ve,set:Re,identity:Ae,transpose:De,invert:Ee,adjoint:Fe,determinant:Oe,multiply:Be,translate:Le,rotate:ke,scale:Ne,fromTranslation:Ue,fromRotation:We,fromScaling:je,fromMat2d:Ve,fromQuat:ze,normalFromMat4:He,projection:Ye,str:Xe,frob:qe,add:Je,subtract:Qe,multiplyScalar:Ke,multiplyScalarAndAdd:Ze,exactEquals:$e,equals:ts,mul:d,sub:p}),g=Fs,m=Ls,S=us,y=zs,G=Object.freeze({__proto__:null,create:es,clone:ss,copy:is,fromValues:rs,set:ns,identity:as,transpose:os,invert:hs,adjoint:ls,determinant:cs,multiply:us,translate:_s,scale:ds,rotate:ps,rotateX:fs,rotateY:gs,rotateZ:ms,fromTranslation:Ss,fromScaling:ys,fromRotation:Gs,fromXRotation:Ts,fromYRotation:Is,fromZRotation:Cs,fromRotationTranslation:bs,fromQuat2:xs,getTranslation:ws,getScaling:Ms,getRotation:Ps,decompose:vs,fromRotationTranslationScale:Rs,fromRotationTranslationScaleOrigin:As,fromQuat:Ds,frustum:Es,perspectiveNO:Fs,perspective:g,perspectiveZO:Os,perspectiveFromFieldOfView:Bs,orthoNO:Ls,ortho:m,orthoZO:ks,lookAt:Ns,targetTo:Us,str:Ws,frob:js,add:Vs,subtract:zs,multiplyScalar:Hs,multiplyScalarAndAdd:Ys,exactEquals:Xs,equals:qs,mul:S,sub:y}),T=si,I=ii,C=ri,b=_i,x=di,w=Ks,M=pi,t=Js(),P=function(e,s,i,r,n,a){var o,h;for(s||(s=3),i||(i=0),h=r?Math.min(r*s+i,e.length):e.length,o=i;o<h;o+=s)t[0]=e[o],t[1]=e[o+1],t[2]=e[o+2],n(t,t,a),e[o]=t[0],e[o+1]=t[1],e[o+2]=t[2];return e},v=Object.freeze({__proto__:null,create:Js,clone:Qs,length:Ks,fromValues:Zs,copy:$s,set:ti,add:ei,subtract:si,multiply:ii,divide:ri,ceil:ni,floor:ai,min:oi,max:hi,round:li,scale:ci,scaleAndAdd:ui,distance:_i,squaredDistance:di,squaredLength:pi,negate:fi,inverse:gi,normalize:mi,dot:Si,cross:yi,lerp:Gi,slerp:Ti,hermite:Ii,bezier:Ci,random:bi,transformMat4:xi,transformMat3:wi,transformQuat:Mi,rotateX:Pi,rotateY:vi,rotateZ:Ri,angle:Ai,zero:Di,str:Ei,exactEquals:Fi,equals:Oi,sub:T,mul:I,div:C,dist:b,sqrDist:x,len:w,sqrLen:M,forEach:P}),R=ji,A=Vi,D=zi,E=Zi,F=$i,O=tr,B=er,L=function(){var t=Bi();return function(e,s,i,r,n,a){var o,h;for(s||(s=4),i||(i=0),h=r?Math.min(r*s+i,e.length):e.length,o=i;o<h;o+=s)t[0]=e[o],t[1]=e[o+1],t[2]=e[o+2],t[3]=e[o+3],n(t,t,a),e[o]=t[0],e[o+1]=t[1],e[o+2]=t[2],e[o+3]=t[3];return e}}(),k=Object.freeze({__proto__:null,create:Bi,clone:Li,fromValues:ki,copy:Ni,set:Ui,add:Wi,subtract:ji,multiply:Vi,divide:zi,ceil:Hi,floor:Yi,min:Xi,max:qi,round:Ji,scale:Qi,scaleAndAdd:Ki,distance:Zi,squaredDistance:$i,length:tr,squaredLength:er,negate:sr,inverse:ir,normalize:rr,dot:nr,cross:ar,lerp:or,random:hr,transformMat4:lr,transformQuat:cr,zero:ur,str:_r,exactEquals:dr,equals:pr,sub:R,mul:A,div:D,dist:E,sqrDist:F,len:O,sqrLen:B,forEach:L}),N=Li,U=ki,W=Ni,j=Ui,V=Wi,z=Gr,H=Qi,Y=nr,X=or,J=q=tr,K=Q=er,Z=rr,$=dr,tt=function(){var t=Js(),e=Zs(1,0,0),s=Zs(0,1,0);return function(i,r,n){var a=Si(r,n);return a<-.999999?(yi(t,e,r),w(t)<1e-6&&yi(t,s,r),mi(t,t),mr(i,t,Math.PI),i):a>.999999?(i[0]=0,i[1]=0,i[2]=0,i[3]=1,i):(yi(t,r,n),i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=1+a,Z(i,i))}}(),et=function(){var t=fr(),e=fr();return function(s,i,r,n,a,o){return Pr(t,i,a,o),Pr(e,r,n,o),Pr(s,t,e,2*o*(1-o)),s}}(),st=function(){var t=xe();return function(e,s,i,r){return t[0]=i[0],t[3]=i[1],t[6]=i[2],t[1]=r[0],t[4]=r[1],t[7]=r[2],t[2]=-s[0],t[5]=-s[1],t[8]=-s[2],Z(e,Dr(e,t))}}(),it=Object.freeze({__proto__:null,create:fr,identity:gr,setAxisAngle:mr,getAxisAngle:Sr,getAngle:yr,multiply:Gr,rotateX:Tr,rotateY:Ir,rotateZ:Cr,calculateW:br,exp:xr,ln:wr,pow:Mr,slerp:Pr,random:vr,invert:Rr,conjugate:Ar,fromMat3:Dr,fromEuler:Er,str:Fr,clone:N,fromValues:U,copy:W,set:j,add:V,mul:z,scale:H,dot:Y,lerp:X,length:q,len:J,squaredLength:Q,sqrLen:K,normalize:Z,exactEquals:$,equals:Or,rotationTo:tt,sqlerp:et,setAxes:st}),rt=W,nt=W,at=nn,ot=Y,lt=ht=q,ut=ct=Q,_t=Object.freeze({__proto__:null,create:Br,clone:Lr,fromValues:kr,fromRotationTranslationValues:Nr,fromRotationTranslation:Ur,fromTranslation:Wr,fromRotation:jr,fromMat4:Vr,copy:zr,identity:Hr,set:Yr,getReal:rt,getDual:Xr,setReal:nt,setDual:qr,getTranslation:Jr,translate:Qr,rotateX:Kr,rotateY:Zr,rotateZ:$r,rotateByQuatAppend:tn,rotateByQuatPrepend:en,rotateAroundAxis:sn,add:rn,multiply:nn,mul:at,scale:an,dot:ot,lerp:on,invert:hn,conjugate:ln,length:ht,len:lt,squaredLength:ct,sqrLen:ut,normalize:cn,str:un,exactEquals:_n,equals:dn}),dt=Dn,pt=Gn,ft=Tn,gt=In,mt=Rn,St=An,yt=En,Gt=function(){var t=pn();return function(e,s,i,r,n,a){var o,h;for(s||(s=2),i||(i=0),h=r?Math.min(r*s+i,e.length):e.length,o=i;o<h;o+=s)t[0]=e[o],t[1]=e[o+1],n(t,t,a),e[o]=t[0],e[o+1]=t[1];return e}}(),Tt=Object.freeze({__proto__:null,create:pn,clone:fn,fromValues:gn,copy:mn,set:Sn,add:yn,subtract:Gn,multiply:Tn,divide:In,ceil:Cn,floor:bn,min:xn,max:wn,round:Mn,scale:Pn,scaleAndAdd:vn,distance:Rn,squaredDistance:An,length:Dn,squaredLength:En,negate:Fn,inverse:On,normalize:Bn,dot:Ln,cross:kn,lerp:Nn,random:Un,transformMat2:Wn,transformMat2d:jn,transformMat3:Vn,transformMat4:zn,rotate:Hn,angle:Yn,zero:Xn,str:qn,exactEquals:Jn,equals:Qn,len:dt,sub:pt,mul:ft,div:gt,dist:mt,sqrDist:St,sqrLen:yt,forEach:Gt}),globalThis.glMatrix=a,globalThis.glMatrix.mat2=l,globalThis.glMatrix.mat2d=_,globalThis.glMatrix.mat3=f,globalThis.glMatrix.mat4=G,globalThis.glMatrix.quat=it,globalThis.glMatrix.quat2=_t,globalThis.glMatrix.vec2=Tt,globalThis.glMatrix.vec3=v,globalThis.glMatrix.vec4=k}var t,e,s,i,r,n,a,o,h,l,c,u,_,d,p,f,g,m,S,y,G,T,I,C,b,x,w,M,P,v,R,A,D,E,F,O,B,L,k,N,U,W,j,V,z,H,Y,X,q,J,Q,K,Z,$,tt,et,st,it,rt,nt,at,ot,ht,lt,ct,ut,_t,dt,pt,ft,gt,mt,St,yt,Gt,Tt,It,Ct,bt,xt;{let Kn=function(t,e,s){s=s||0;var i,r,n,a,o,h,l,c=[0,0];return i=t[1][1]-t[0][1],r=t[0][0]-t[1][0],n=i*t[0][0]+r*t[0][1],a=e[1][1]-e[0][1],o=e[0][0]-e[1][0],h=a*e[0][0]+o*e[0][1],Ca(l=i*o-a*r,0,s)||(c[0]=(o*n-r*h)/l,c[1]=(i*h-a*n)/l),c},Zn=function(t,e,s,i){var r=e[0]-t[0],n=e[1]-t[1],a=i[0]-s[0],o=i[1]-s[1];if(a*n-o*r===0)return!1;var h=(r*(s[1]-t[1])+n*(t[0]-s[0]))/(a*n-o*r),l=(a*(t[1]-s[1])+o*(s[0]-t[0]))/(o*r-a*n);return h>=0&&h<=1&&l>=0&&l<=1},$n=function(t,e,s){return(e[0]-t[0])*(s[1]-t[1])-(s[0]-t[0])*(e[1]-t[1])},ta=function(t,e,s){return $n(t,e,s)>0},ea=function(t,e,s){return $n(t,e,s)>=0},sa=function(t,e,s){return $n(t,e,s)<0},ia=function(t,e,s){return $n(t,e,s)<=0},ra=function(t,e,s,i){if(i){var r=It,n=Ct;r[0]=e[0]-t[0],r[1]=e[1]-t[1],n[0]=s[0]-e[0],n[1]=s[1]-e[1];var a=r[0]*n[0]+r[1]*n[1],o=Math.sqrt(r[0]*r[0]+r[1]*r[1]),h=Math.sqrt(n[0]*n[0]+n[1]*n[1]);return Math.acos(a/(o*h))<i}return 0===$n(t,e,s)},na=function(t,e){var s=e[0]-t[0],i=e[1]-t[1];return s*s+i*i},aa=function(t,e){var s=t.length;return t[e<0?e%s+s:e%s]},oa=function(t){t.length=0},ha=function(t,e,s,i){for(var r=s;r<i;r++)t.push(e[r])},la=function(t){for(var e=0,s=t,i=1;i<t.length;++i)(s[i][1]<s[e][1]||s[i][1]===s[e][1]&&s[i][0]>s[e][0])&&(e=i);return!ta(aa(t,e-1),aa(t,e),aa(t,e+1))&&(ca(t),!0)},ca=function(t){for(var e=[],s=t.length,i=0;i!==s;i++)e.push(t.pop());for(i=0;i!==s;i++)t[i]=e[i]},ua=function(t,e){return sa(aa(t,e-1),aa(t,e),aa(t,e+1))},_a=function(t,e,s){var i,r,n=bt,a=xt;if(ea(aa(t,e+1),aa(t,e),aa(t,s))&&ia(aa(t,e-1),aa(t,e),aa(t,s)))return!1;r=na(aa(t,e),aa(t,s));for(var o=0;o!==t.length;++o)if((o+1)%t.length!==e&&o!==e&&ea(aa(t,e),aa(t,s),aa(t,o+1))&&ia(aa(t,e),aa(t,s),aa(t,o))&&(n[0]=aa(t,e),n[1]=aa(t,s),a[0]=aa(t,o),a[1]=aa(t,o+1),i=Kn(n,a),na(aa(t,e),i)<r))return!1;return!0},da=function(t,e,s){for(var i=0;i!==t.length;++i)if(i!==e&&i!==s&&(i+1)%t.length!==e&&(i+1)%t.length!==s&&Zn(aa(t,e),aa(t,s),aa(t,i),aa(t,i+1)))return!1;return!0},pa=function(t,e,s,i){var r=i||[];if(oa(r),e<s)for(var n=e;n<=s;n++)r.push(t[n]);else{for(n=0;n<=s;n++)r.push(t[n]);for(n=e;n<t.length;n++)r.push(t[n])}return r},fa=function(t){for(var e=[],s=[],i=[],r=[],n=Number.MAX_VALUE,a=0;a<t.length;++a)if(ua(t,a))for(var o=0;o<t.length;++o)if(_a(t,a,o)){s=fa(pa(t,a,o,r)),i=fa(pa(t,o,a,r));for(var h=0;h<i.length;h++)s.push(i[h]);s.length<n&&(e=s,n=s.length,e.push([aa(t,a),aa(t,o)]))}return e},ga=function(t){var e=fa(t);return e.length>0?ma(t,e):[t]},ma=function(t,e){if(0===e.length)return[t];if(e instanceof Array&&e.length&&e[0]instanceof Array&&2===e[0].length&&e[0][0]instanceof Array){for(var s=[t],i=0;i<e.length;i++)for(var r=e[i],n=0;n<s.length;n++){var a=ma(s[n],r);if(a){s.splice(n,1),s.push(a[0],a[1]);break}}return s}return r=e,i=t.indexOf(r[0]),n=t.indexOf(r[1]),-1!==i&&-1!==n&&[pa(t,i,n),pa(t,n,i)]},Sa=function(t){var e,s=t;for(e=0;e<s.length-1;e++)for(var i=0;i<e-1;i++)if(Zn(s[e],s[e+1],s[i],s[i+1]))return!1;for(e=1;e<s.length-2;e++)if(Zn(s[0],s[s.length-1],s[e],s[e+1]))return!1;return!0},ya=function(t,e,s,i,r){r=r||0;var n=e[1]-t[1],a=t[0]-e[0],o=n*t[0]+a*t[1],h=i[1]-s[1],l=s[0]-i[0],c=h*s[0]+l*s[1],u=n*l-h*a;return Ca(u,0,r)?[0,0]:[(l*o-a*c)/u,(n*c-h*o)/u]},Ga=function(t,e,s,i,r,n,a){n=n||100,a=a||0,r=r||25,e=void 0!==e?e:[],s=s||[],i=i||[];var o=[0,0],h=[0,0],l=[0,0],c=0,u=0,_=0,d=0,p=0,f=0,g=0,m=[],S=[],y=t,G=t;if(G.length<3)return e;if(++a>n)return console.warn("quickDecomp: max level ("+n+") reached."),e;for(var T=0;T<t.length;++T)if(ua(y,T)){s.push(y[T]),c=u=Number.MAX_VALUE;for(var I=0;I<t.length;++I)ta(aa(y,T-1),aa(y,T),aa(y,I))&&ia(aa(y,T-1),aa(y,T),aa(y,I-1))&&(l=ya(aa(y,T-1),aa(y,T),aa(y,I),aa(y,I-1)),sa(aa(y,T+1),aa(y,T),l)&&(_=na(y[T],l))<u&&(u=_,h=l,f=I)),ta(aa(y,T+1),aa(y,T),aa(y,I+1))&&ia(aa(y,T+1),aa(y,T),aa(y,I))&&(l=ya(aa(y,T+1),aa(y,T),aa(y,I),aa(y,I+1)),ta(aa(y,T-1),aa(y,T),l)&&(_=na(y[T],l))<c&&(c=_,o=l,p=I));if(f===(p+1)%t.length)l[0]=(h[0]+o[0])/2,l[1]=(h[1]+o[1])/2,i.push(l),T<p?(ha(m,y,T,p+1),m.push(l),S.push(l),0!==f&&ha(S,y,f,y.length),ha(S,y,0,T+1)):(0!==T&&ha(m,y,T,y.length),ha(m,y,0,p+1),m.push(l),S.push(l),ha(S,y,f,T+1));else{if(f>p&&(p+=t.length),d=Number.MAX_VALUE,p<f)return e;for(I=f;I<=p;++I)ea(aa(y,T-1),aa(y,T),aa(y,I))&&ia(aa(y,T+1),aa(y,T),aa(y,I))&&(_=na(aa(y,T),aa(y,I)))<d&&da(y,T,I)&&(d=_,g=I%t.length);T<g?(ha(m,y,T,g+1),0!==g&&ha(S,y,g,G.length),ha(S,y,0,T+1)):(0!==T&&ha(m,y,T,G.length),ha(m,y,0,g+1),ha(S,y,g,T+1))}return m.length<S.length?(Ga(m,e,s,i,r,n,a),Ga(S,e,s,i,r,n,a)):(Ga(S,e,s,i,r,n,a),Ga(m,e,s,i,r,n,a)),e}return e.push(t),e},Ta=function(t,e){for(var s=0,i=t.length-1;t.length>3&&i>=0;--i)ra(aa(t,i-1),aa(t,i),aa(t,i+1),e)&&(t.splice(i%t.length,1),s++);return s},Ia=function(t,e){for(var s=t.length-1;s>=1;--s)for(var i=t[s],r=s-1;r>=0;--r)ba(i,t[r],e)&&t.splice(s,1)},Ca=function(t,e,s){return s=s||0,Math.abs(t-e)<=s},ba=function(t,e,s){return Ca(t[0],e[0],s)&&Ca(t[1],e[1],s)};It=[],Ct=[],bt=[],xt=[],self.polyDecomp={decomp:ga,quickDecomp:Ga,isSimple:Sa,removeCollinearPoints:Ta,removeDuplicatePoints:Ia,makeCCW:la}}{let xa=!1,wa=!1,Ma="dev";const Pa=Symbol("Construct internal API token");let va=16;const Ra=self.C3=class{constructor(){throw TypeError("static class can't be instantiated")}static _GetInternalAPIToken(){if(va<=0)throw new Error("cannot obtain internal API token");return--va,Pa}static SetReady(){xa=!0}static IsReady(){return xa}static SetAppStarted(){wa=!0}static HasAppStarted(){return wa}static SetBuildMode(t){Ma=t}static GetBuildMode(){return Ma}static IsReleaseBuild(){return"final"===Ma}};Ra.isDebug=!1,Ra.isDebugDefend=!1,Ra.hardwareConcurrency=navigator.hardwareConcurrency||2,self.C3X={}}{const Aa=self.C3;Aa.QueryParser=class{constructor(t){this._queryString=t,this._parameters=new Map,this._Parse()}_Parse(){let t=this._queryString;(t.startsWith("?")||t.startsWith("#"))&&(t=t.substr(1));const e=t.split("&");for(const t of e)this._ParseParameter(t)}_ParseParameter(t){if(!t)return;if(!t.includes("="))return void this._parameters.set(t,null);const e=t.indexOf("="),s=decodeURIComponent(t.substring(0,e)),i=decodeURIComponent(t.substring(e+1));this._parameters.set(s,i)}LogAll(){for(const t of this._parameters)console.log("[QueryParser] Parameter '"+t[0]+"' = "+(null===t[1]?"null":"'"+t[1]+"'"))}Has(t){return this._parameters.has(t)}Get(t){const e=this._parameters.get(t);return void 0===e?null:e}ClearHash(){history.replaceState("",document.title,location.pathname+location.search)}Reparse(t){this._queryString=t,this._parameters.clear(),this._Parse()}},Aa.QueryString=new Aa.QueryParser(location.search),Aa.LocationHashString=new Aa.QueryParser(location.hash),Aa.QueryString.Has("perf")&&(Aa.isPerformanceProfiling=!0),"dev"!==Aa.QueryString.Get("mode")&&Aa.SetBuildMode("final")}{let Da=function(t){const e=parseFloat(t);return Oa.get(e)||(e>=13?"11":"NT "+t)};0;const Ea=self.C3,Fa="(unknown)";Ea.Platform={OS:Fa,OSVersion:Fa,Browser:Fa,BrowserVersion:Fa,BrowserVersionNumber:NaN,BrowserEngine:Fa,Context:"browser",IsDesktop:!0,IsMobile:!1,IsAppleOS:!1,IsIpadOS:!1,GetDetailedInfo:async()=>{}};const Oa=new Map([[5,"2000"],[5.1,"XP"],[5.2,"XP"],[6,"Vista"],[6.1,"7"],[6.2,"8"],[6.3,"8.1"],[10,"10"]]),Ba=navigator.userAgent,La=navigator.userAgentData;if(La&&La.brands.length>0){let ka=function(t){let e="",s="",i="",r="";for(const n of t){const t=Na.get(n.brand);!e&&t&&(e=t,s=n.version);const a=Ua.get(n.brand);!i&&a&&(i=a,r=n.version)}e||"Chromium"!==i||(Ea.Platform.Browser="Chromium",Ea.Platform.BrowserVersion=r),Ea.Platform.Browser=e||Fa,Ea.Platform.BrowserVersion=s||Fa,Ea.Platform.BrowserEngine=i||Fa};Ea.Platform.OS=La.platform,Ea.Platform.IsMobile=La.mobile,Ea.Platform.IsDesktop=!Ea.Platform.IsMobile;const Na=new Map([["Google Chrome","Chrome"],["Microsoft Edge","Edge"],["Opera","Opera"],["Opera GX","Opera GX"],["Mozilla Firefox","Firefox"],["Apple Safari","Safari"],["NW.js","NW.js"]]),Ua=new Map([["Chromium","Chromium"],["Gecko","Gecko"],["WebKit","WebKit"]]);ka(La.brands);let Wa=!1;Ea.Platform.GetDetailedInfo=async()=>{if(!Wa)try{const t=await navigator.userAgentData.getHighEntropyValues(["platformVersion","fullVersionList"]);ka(t.fullVersionList),"Windows"===Ea.Platform.OS?Ea.Platform.OSVersion=Da(t.platformVersion):Ea.Platform.OSVersion=t.platformVersion,Wa=!0}catch(t){console.warn("Failed to get detailed user agent information: ",t)}}}else{let ja=function(t,e){const s=Array.isArray(t)?t:[t];for(const t of s){const s=t.exec(Ba);if(s){e(s);break}}};ja(/windows\s+nt\s+([\d\.]+)/i,t=>{Ea.Platform.OS="Windows";const e=t[1];Ea.Platform.OSVersion=Da(e)}),ja(/mac\s+os\s+x\s+([\d\._]+)/i,t=>{Ea.Platform.OS="macOS",Ea.Platform.OSVersion=t[1].replace(/_/g,".")}),ja(/CrOS/,()=>{Ea.Platform.OS="Chrome OS"}),ja(/linux|openbsd|freebsd|netbsd/i,()=>{Ea.Platform.OS="Linux"}),ja(/android/i,()=>{Ea.Platform.OS="Android"}),ja(/android\s+([\d\.]+)/i,t=>{Ea.Platform.OS="Android",Ea.Platform.OSVersion=t[1]}),Ea.Platform.OS===Fa&&(ja(/(iphone|ipod|ipad)/i,t=>{Ea.Platform.OS="iOS"}),ja([/iphone\s+os\s+([\d\._]+)/i,/ipad[^)]*os\s+([\d\._]+)/i],t=>{Ea.Platform.OS="iOS",Ea.Platform.OSVersion=t[1].replace(/_/g,".")}));const Va=/chrome\//i.test(Ba),za=/chromium\//i.test(Ba),Ha=/edg\//i.test(Ba),Ya=/OPR\//.test(Ba),Xa=/nwjs/i.test(Ba),qa=/safari\//i.test(Ba),Ja=/webkit/i.test(Ba);Ha||Ya||ja(/chrome\/([\d\.]+)/i,t=>{Ea.Platform.Browser="Chrome",Ea.Platform.BrowserVersion=t[1],Ea.Platform.BrowserEngine="Chromium"}),ja(/edg\/([\d\.]+)/i,t=>{Ea.Platform.Browser="Edge",Ea.Platform.BrowserVersion=t[1],Ea.Platform.BrowserEngine="Chromium"}),ja(/OPR\/([\d\.]+)/,t=>{Ea.Platform.Browser="Opera",Ea.Platform.BrowserVersion=t[1],Ea.Platform.BrowserEngine="Chromium"}),ja(/chromium\/([\d\.]+)/i,t=>{Ea.Platform.Browser="Chromium",Ea.Platform.BrowserVersion=t[1],Ea.Platform.BrowserEngine="Chromium"}),ja(/nwjs\/[0-9.]+/i,t=>{Ea.Platform.Browser="NW.js",Ea.Platform.BrowserVersion=t[1],Ea.Platform.BrowserEngine="Chromium",Ea.Platform.Context="nwjs"}),ja(/firefox\/([\d\.]+)/i,t=>{Ea.Platform.Browser="Firefox",Ea.Platform.BrowserVersion=t[1],Ea.Platform.BrowserEngine="Gecko"}),!qa||Va||za||Ha||Ya||Xa||(Ea.Platform.Browser="Safari",Ea.Platform.BrowserEngine="WebKit",ja(/version\/([\d\.]+)/i,t=>{Ea.Platform.BrowserVersion=t[1]}),ja(/crios\/([\d\.]+)/i,t=>{Ea.Platform.Browser="Chrome for iOS",Ea.Platform.BrowserVersion=t[1]}),ja(/fxios\/([\d\.]+)/i,t=>{Ea.Platform.Browser="Firefox for iOS",Ea.Platform.BrowserVersion=t[1]}),ja(/edgios\/([\d\.]+)/i,t=>{Ea.Platform.Browser="Edge for iOS",Ea.Platform.BrowserVersion=t[1]})),Ea.Platform.BrowserEngine===Fa&&Ja&&(Ea.Platform.BrowserEngine="WebKit"),"Android"===Ea.Platform.OS&&"Safari"===Ea.Platform.Browser&&(Ea.Platform.Browser="Stock");const Qa=new Set(["Windows","macOS","Linux","Chrome OS"]).has(Ea.Platform.OS)||"nwjs"===Ea.Platform.Context;Ea.Platform.IsDesktop=Qa,Ea.Platform.IsMobile=!Qa}"Chrome"===Ea.Platform.Browser&&"browser"===Ea.Platform.Context&&/wv\)/.test(Ba)&&(Ea.Platform.Context="webview"),"nwjs"!==Ea.Platform.Context&&"undefined"!=typeof window&&(window.matchMedia&&window.matchMedia("(display-mode: standalone)").matches||navigator.standalone)&&(Ea.Platform.Context="webapp"),Ea.Platform.BrowserVersionNumber=parseFloat(Ea.Platform.BrowserVersion);"macOS"===Ea.Platform.OS&&navigator.maxTouchPoints&&navigator.maxTouchPoints>2&&(Ea.Platform.OS="iOS",Ea.Platform.OSVersion=Ea.Platform.BrowserVersion,Ea.Platform.IsDesktop=!1,Ea.Platform.IsMobile=!0,Ea.Platform.IsIpadOS=!0),Ea.Platform.IsAppleOS="macOS"===Ea.Platform.OS||"iOS"===Ea.Platform.OS}{let Ka=function(t){return new Promise((e,s)=>{t.onsuccess=()=>e(t.result),t.onerror=()=>s(t.error)})},Za=function(t){return new Promise((e,s)=>{t.oncomplete=()=>e(),t.onerror=()=>s(t.error),t.onabort=()=>s(t.error)})},$a=function(t,e){return lo(t,e)},to=function(t,e){return lo(t,e,!0)},eo=function(t){so(t);let e=ao.get(t);return e instanceof Promise||(e=co(t),ao.set(t,e),e.catch(e=>ao.delete(t))),e},so=function(t){if("string"!=typeof t)throw new TypeError("expected string")},io=function(t,e){const s=t.objectStore(no).openCursor();return new Promise(t=>{const i=[];s.onsuccess=s=>{const r=s.target.result;if(r){switch(e){case"entries":i.push([r.key,r.value]);break;case"keys":i.push(r.key);break;case"values":i.push(r.value)}r.continue()}else t(i)}})};0;const ro=2,no="keyvaluepairs",ao=new Map,oo="undefined"!=typeof IDBObjectStore&&"function"==typeof IDBObjectStore.prototype.getAll,ho="undefined"!=typeof IDBObjectStore&&"function"==typeof IDBObjectStore.prototype.getAllKeys;async function lo(t,e,s=!1,i=!0){const r=await eo(t);try{return e(r.transaction([no],s?"readwrite":"readonly"))}catch(r){if(i&&"InvalidStateError"===r.name)return ao.delete(t),lo(t,e,s,!1);throw r}}async function co(t){so(t);const e=indexedDB.open(t,ro);return e.addEventListener("upgradeneeded",e=>{try{e.target.result.createObjectStore(no)}catch(e){console.error(`Failed to create objectstore for database ${t}`,e)}}),Ka(e)}class uo{constructor(t){so(t),this.name=t}async ready(){await eo(this.name)}set(t,e){return so(t),to(this.name,async s=>{const i=Ka(s.objectStore(no).put(e,t)),r=Za(s);await Promise.all([r,i])})}get(t){return so(t),$a(this.name,async e=>{const s=Ka(e.objectStore(no).get(t)),i=Za(e),[r,n]=await Promise.all([i,s]);return n})}delete(t){return so(t),to(this.name,async e=>{const s=Ka(e.objectStore(no).delete(t)),i=Za(e);await Promise.all([i,s])})}clear(){return to(this.name,async t=>{const e=Ka(t.objectStore(no).clear()),s=Za(t);await Promise.all([s,e])})}keys(){return $a(this.name,async t=>{let e;e=ho?Ka(t.objectStore(no).getAllKeys()):io(t,"keys");const s=Za(t),[i,r]=await Promise.all([s,e]);return r})}values(){return $a(this.name,async t=>{let e;e=oo?Ka(t.objectStore(no).getAll()):io(t,"values");const s=Za(t),[i,r]=await Promise.all([s,e]);return r})}entries(){return $a(this.name,async t=>{const e=io(t,"entries"),s=Za(t),[i,r]=await Promise.all([s,e]);return r})}}self.KVStorageContainer=uo}{let _o=function(t){throw new Error(`"${t}" is not implemented`)},po=function(t){if("function"==typeof t)throw new Error("localforage callback API is not implemented; please use the promise API instead")},fo=function(t){return"object"==typeof t?new Promise(e=>{const{port1:s,port2:i}=new MessageChannel;i.onmessage=t=>e(t.data),s.postMessage(t)}):Promise.resolve(t)};0;const go=self.KVStorageContainer,mo=[/no available storage method found/i,/an attempt was made to break through the security policy of the user agent/i,/the user denied permission to access the database/i,/a mutation operation was attempted on a database that did not allow mutations/i,/idbfactory\.open\(\) called in an invalid security context/i];class So{constructor(t){this._inst=t,this._isInMemory=!this._inst,this._isInMemory||"undefined"!=typeof indexedDB||(this._isInMemory=!0,console.warn("Unable to use local storage because IndexedDB API is not available")),this._memoryStorage=new Map}_MaybeSwitchToMemoryFallback(t){if(!this._isInMemory)for(const e of mo)if(t&&e.test(t.message)){console.error("Unable to use local storage, reverting to in-memory store: ",t,t.message),this._isInMemory=!0;break}}async _getItemFallback(t){const e=this._memoryStorage.get(t),s=await fo(e);return void 0===s?null:s}async _setItemFallback(t,e){e=await fo(e),this._memoryStorage.set(t,e)}_removeItemFallback(t){this._memoryStorage.delete(t)}_clearFallback(){this._memoryStorage.clear()}_keysFallback(){return Array.from(this._memoryStorage.keys())}IsInMemory(){return this._isInMemory}GetMemoryStorage(){return this._memoryStorage}SetMemoryStorage(t){this._memoryStorage=t}async getItem(t,e){if(po(e),this._isInMemory)return await this._getItemFallback(t);let s;try{s=await this._inst.get(t)}catch(e){return this._MaybeSwitchToMemoryFallback(e),this._isInMemory?await this._getItemFallback(t):(console.error(`Error reading '${t}' from storage, returning null: `,e),null)}return void 0===s?null:s}async setItem(t,e,s){if(po(s),void 0===e&&(e=null),this._isInMemory)await this._setItemFallback(t,e);else try{await this._inst.set(t,e)}catch(s){if(this._MaybeSwitchToMemoryFallback(s),!this._isInMemory)throw s;await this._setItemFallback(t,e)}}async removeItem(t,e){if(po(e),this._isInMemory)this._removeItemFallback(t);else try{await this._inst.delete(t)}catch(e){this._MaybeSwitchToMemoryFallback(e),this._isInMemory?this._removeItemFallback(t):console.error(`Error removing '${t}' from storage: `,e)}}async clear(t){if(po(t),this._isInMemory)this._clearFallback();else try{await this._inst.clear()}catch(t){this._MaybeSwitchToMemoryFallback(t),this._isInMemory?this._clearFallback():console.error("Error clearing storage: ",t)}}async keys(t){if(po(t),this._isInMemory)return this._keysFallback();let e=[];try{e=await this._inst.keys()}catch(t){if(this._MaybeSwitchToMemoryFallback(t),this._isInMemory)return this._keysFallback();console.error("Error getting storage keys: ",t)}return e}ready(t){return po(t),this._isInMemory?Promise.resolve(!0):this._inst.ready()}createInstance(t){if(t.forceInMemoryFallback)return new So(null);{const e=t.name;if("string"!=typeof e)throw new TypeError("invalid store name");const s=new go(e);return new So(s)}}length(t){_o("localforage.length()")}key(t,e){_o("localforage.key()")}iterate(t,e){_o("localforage.iterate()")}setDriver(t){_o("localforage.setDriver()")}config(t){_o("localforage.config()")}defineDriver(t){_o("localforage.defineDriver()")}driver(){_o("localforage.driver()")}supports(t){_o("localforage.supports()")}dropInstance(){_o("localforage.dropInstance()")}}self.localforage=new So(new go("localforage"))}{const yo=self.C3;if(yo.Supports={},yo.Supports.WebAnimations=(()=>{try{if("undefined"==typeof document)return!1;const t=document.createElement("div");return void 0!==t.animate&&void 0!==t.animate([{opacity:"0"},{opacity:"1"}],1e3).reverse}catch(t){return!1}})(),yo.Supports.DialogElement="undefined"!=typeof HTMLDialogElement,yo.Supports.RequestIdleCallback=!!self.requestIdleCallback,yo.Supports.ImageBitmap=!!self.createImageBitmap,yo.Supports.ImageBitmapOptions=!1,yo.Supports.ImageBitmapOptionsResize=!1,yo.Supports.ImageBitmap){try{self.createImageBitmap(new ImageData(32,32),{premultiplyAlpha:"none"}).then(()=>{yo.Supports.ImageBitmapOptions=!0}).catch(()=>{yo.Supports.ImageBitmapOptions=!1})}catch(Go){yo.Supports.ImageBitmapOptions=!1}try{self.createImageBitmap(new ImageData(32,32),{resizeWidth:10,resizeHeight:10}).then(t=>{yo.Supports.ImageBitmapOptionsResize=10===t.width&&10===t.height}).catch(()=>{yo.Supports.ImageBitmapOptionsResize=!1})}catch(To){yo.Supports.ImageBitmapOptionsResize=!1}}if(yo.Supports.ClipboardReadText=!(!navigator.clipboard||!navigator.clipboard.readText),yo.Supports.PermissionsQuery=!(!navigator.permissions||!navigator.permissions.query),yo.Supports.ClipboardPermissionsQuery=!1,yo.Supports.PermissionsQuery){const Io={name:"clipboard-read"};navigator.permissions.query(Io).then(()=>{yo.Supports.ClipboardPermissionsQuery=!0}).catch(()=>{yo.Supports.ClipboardPermissionsQuery=!1})}yo.Supports.AsyncClipboardApi=!!(navigator.permissions&&navigator.clipboard&&self.ClipboardItem),yo.Supports.Proxies="undefined"!=typeof Proxy,yo.Supports.DownloadAttribute="undefined"!=typeof document&&void 0!==document.createElement("a").download,yo.Supports.Fetch="function"==typeof fetch,yo.Supports.PersistentStorage=!!(self.isSecureContext&&"Opera"!==yo.Platform.Browser&&navigator.storage&&navigator.storage.persist),yo.Supports.StorageQuotaEstimate=!!(self.isSecureContext&&navigator.storage&&navigator.storage.estimate),yo.Supports.Fullscreen=(()=>{if("undefined"==typeof document)return!1;if("iOS"===yo.Platform.OS)return!1;const t=document.documentElement;return!!(t.requestFullscreen||t.msRequestFullscreen||t.mozRequestFullScreen||t.webkitRequestFullscreen)})(),yo.Supports.ImageDecoder=void 0!==self.ImageDecoder,yo.Supports.WebCodecs=!!self.VideoEncoder,yo.Supports.NativeFileSystemAPI=!!self.showOpenFilePicker,yo.Supports.QueryLocalFonts=!!self.queryLocalFonts,yo.Supports.UserActivation=!!navigator.userActivation,yo.Supports.CanvasToBlobWebP=!1,(async()=>{let t;"undefined"==typeof document?t=new OffscreenCanvas(32,32):(t=document.createElement("canvas"),t.width=32,t.height=32);const e=t.getContext("2d");e.fillStyle="blue",e.fillRect(0,0,32,32);let s=null;try{t.convertToBlob?s=await t.convertToBlob({type:"image/webp",quality:1}):t.toBlob&&(s=await new Promise(e=>t.toBlob(e,"image/webp",1))),yo.Supports.CanvasToBlobWebP=s&&"image/webp"===s.type}catch(t){yo.Supports.CanvasToBlobWebP=!1}})()}{const Co=self.C3;String.prototype.replaceAll||(String.prototype.replaceAll=function(t,e){return this.replace(new RegExp(Co.EscapeRegex(t),"g"),e)}),Array.prototype.at||(Array.prototype.at=function(t){if((t=Math.trunc(t)||0)<0&&(t+=this.length),!(t<0||t>=this.length))return this[t]}),String.prototype.at||(String.prototype.at=function(t){if((t=Math.trunc(t)||0)<0&&(t+=this.length),!(t<0||t>=this.length))return this[t]}),RegExp.escape||(RegExp.escape=function(t){return String(t).replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}),Set.prototype.isSubsetOf||(Set.prototype.isSubsetOf=function(t){if(!(t instanceof Set))throw new TypeError("argument must be a Set");for(const e of this)if(!t.has(e))return!1;return!0}),navigator.storage&&!navigator.storage.estimate&&navigator.webkitTemporaryStorage&&navigator.webkitTemporaryStorage.queryUsageAndQuota&&(navigator.storage.estimate=function(){return new Promise((t,e)=>navigator.webkitTemporaryStorage.queryUsageAndQuota((e,s)=>t({usage:e,quota:s}),e))})}{let bo=function(t){let e="Assertion failure: "+t+"\n\nStack trace:\n"+xo.GetCallStack();console.error(e)};0;const xo=self.C3;self.assert=function(t,e){t||bo(e)}}{const wo=self.C3,Mo=self.C3X;wo.IsNumber=function(t){return"number"==typeof t},wo.IsFiniteNumber=function(t){return wo.IsNumber(t)&&isFinite(t)},wo.RequireNumber=function(t){if(!wo.IsNumber(t))throw new TypeError("expected number")},wo.RequireOptionalNumber=function(t){wo.IsNullOrUndefined(t)},wo.RequireNumberInRange=function(t,e,s){if(!wo.IsNumber(t)||isNaN(t)||e>t||s<t)throw new RangeError("number outside of range")},wo.RequireAllNumber=function(...t){for(let e of t);},wo.RequireFiniteNumber=function(t){if(!wo.IsFiniteNumber(t))throw new TypeError("expected finite number")},wo.RequireOptionalFiniteNumber=function(t){wo.IsNullOrUndefined(t)},wo.RequireAllFiniteNumber=function(...t){for(let e of t);},wo.IsString=function(t){return"string"==typeof t},wo.RequireString=function(t){if(!wo.IsString(t))throw new TypeError("expected string")},wo.RequireOptionalString=function(t){wo.IsNullOrUndefined(t)},wo.RequireAllString=function(...t){for(let e of t);},wo.IsSimpleObject=function(t){if("object"!=typeof t||null===t)return!1;let e=Object.getPrototypeOf(t);return e?e.constructor===Object:null===e},wo.RequireSimpleObject=function(t){if(!wo.IsSimpleObject(t))throw new TypeError("expected simple object")},wo.RequireOptionalSimpleObject=function(t){if(!wo.IsNullOrUndefined(t)&&!wo.IsSimpleObject(t))throw new TypeError("expected simple object")},wo.IsObject=function(t){return"object"==typeof t&&null!==t&&!Array.isArray(t)},wo.RequireObject=function(t){if(!wo.IsObject(t))throw new TypeError("expected object")},wo.RequireOptionalObject=function(t){wo.IsNullOrUndefined(t)},wo.RequireAllObject=function(...t){for(let e of t);},wo.IsFileLike=function(t){return wo.WeakIsInstanceOf(t,Blob)&&"string"==typeof t.name},wo.RequireFileLike=function(t){if(!wo.IsFileLike(t))throw new TypeError("expected file")},wo.RequireOptionalFileLike=function(t){wo.IsNullOrUndefined(t)},wo.IsArray=function(t){return Array.isArray(t)},wo.RequireArray=function(t){if(!wo.IsArray(t))throw new TypeError("expected array")},wo.RequireOptionalArray=function(t){wo.IsNullOrUndefined(t)},wo.RequireAllArray=function(...t){for(let e of t);},wo.Is2DArray=function(t){return!(!wo.IsArray(t)||t.length&&!wo.IsArray(t[0]))},wo.Require2DArray=function(t){if(!wo.Is2DArray(t))throw new TypeError("expected 2d array");for(let e of t)if(!wo.IsArray(e))throw new TypeError("expected 2d array")},wo.RequireOptional2DArray=function(t){wo.IsNullOrUndefined(t)},wo.IsFunction=function(t){return"function"==typeof t},wo.RequireFunction=function(t,e){if(!wo.IsFunction(t))throw new TypeError("expected function");if(!wo.IsNullOrUndefined(e)&&t!==e)throw new TypeError("expected same function reference")},wo.RequireOptionalFunction=function(t){wo.IsNullOrUndefined(t)},wo.RequireAllFunction=function(...t){for(let e of t);},wo.RequireAnyFunction=function(t,...e){if(!wo.IsFunction(t))throw new TypeError("expected function");if(!e.length)throw new Error("missing comparison functions");for(let s of e)if(!wo.IsNullOrUndefined(s)&&t===s)return;throw new TypeError("expected same function reference")},wo.RequireOptionalAllFunction=function(...t){if(!wo.IsNullOrUndefined(t))for(let e of t);},wo.IsInstanceOf=function(t,e){return t instanceof e},wo.IsInstanceOfAny=function(t,...e){for(let s of e)if(wo.IsInstanceOf(t,s))return!0;return!1},wo.RequireInstanceOf=function(t,e){if(!wo.IsInstanceOf(t,e))throw new TypeError("unexpected type")},wo.RequireOptionalInstanceOf=function(t,e){wo.IsNullOrUndefined(t)},wo.RequireAllInstanceOf=function(t,...e){for(let t of e);},wo.RequireAnyInstanceOf=function(t,...e){if(!wo.IsInstanceOfAny(t,...e))throw new TypeError("unexpected type")},wo.RequireAnyOptionalInstanceOf=function(t,...e){if(!wo.IsNullOrUndefined(t)&&!wo.IsInstanceOfAny(t,...e))throw new TypeError("unexpected type")},wo.IsArrayOf=function(t,e){for(let s of t)if(!wo.IsInstanceOf(s,e))return!1;return!0},wo.IsArrayOfFiniteNumbers=function(t){for(let e of t)if(!wo.IsFiniteNumber(e))return!1;return!0},wo.RequireArrayOf=function(t,e){for(let e of t);},wo.RequireOptionalArrayOf=function(t,e){if(!wo.IsNullOrUndefined(t))for(let e of t);},wo.RequireOptionalArrayOfFunctions=function(t,e){if(!wo.IsNullOrUndefined(t))for(let e of t);},wo.RequireArrayOfAny=function(t,...e){for(let e of t);},wo.RequireOptionalArrayOfAny=function(t,...e){if(!wo.IsNullOrUndefined(t))for(let e of t);},wo.IsDOMNode=function(t,e){return!(wo.IsNullOrUndefined(t)||!wo.IsString(t.nodeName))&&(!e||wo.equalsNoCase(t.nodeName,e))},wo.RequireDOMNode=function(t,e){if(wo.IsNullOrUndefined(t)||!wo.IsString(t.nodeName))throw new TypeError("expected DOM node");if(e&&!wo.equalsNoCase(t.nodeName,e))throw new TypeError(`expected DOM '${e}' node`)},wo.RequireOptionalDOMNode=function(t,e){wo.IsNullOrUndefined(t)},wo.IsHTMLElement=function(t,e){return!(wo.IsNullOrUndefined(t)||!wo.IsString(t.tagName))&&(!e||wo.equalsNoCase(t.tagName,e))},wo.RequireHTMLElement=function(t,e){if(wo.IsNullOrUndefined(t)||!wo.IsString(t.tagName))throw new TypeError("expected HTML element");if(e&&!wo.equalsNoCase(t.tagName,e))throw new TypeError(`expected HTML '${e}' element`)},wo.RequireOptionalHTMLElement=function(t,e){wo.IsNullOrUndefined(t)},wo.IsDrawable=function(t){return wo.IsHTMLElement(t,"img")||wo.IsHTMLElement(t,"canvas")||wo.IsHTMLElement(t,"video")||"undefined"!=typeof OffscreenCanvas&&t instanceof OffscreenCanvas||"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap},wo.RequireDrawable=function(t){if(!wo.IsDrawable(t))throw new TypeError("expected drawable")},wo.RequireOptionalDrawable=function(t){wo.IsNullOrUndefined(t)},wo.IsDrawableOrImageData=function(t){return t instanceof ImageData||wo.IsDrawable(t)},wo.RequireDrawableOrImageData=function(t){if(!wo.IsDrawableOrImageData(t))throw new TypeError("expected drawable or image data")},wo.RequireOptionalDrawableOrImageData=function(t){if(!wo.IsNullOrUndefined(t)&&!wo.IsDrawableOrImageData(t))throw new TypeError("expected drawable or image data")},wo.IsStringLike=function(t){return"string"==typeof t||wo.HtmlString&&t instanceof wo.HtmlString||t instanceof wo.BBString},wo.RequireStringLike=function(t){if(!wo.IsStringLike(t))throw new TypeError("expected string-like")},wo.RequireOptionalStringLike=function(t){wo.IsNullOrUndefined(t)},wo.RequireAllStringLike=function(...t){for(let e of t);},wo.RequireOverride=function(){throw new Error("must be overridden")},wo.NotYetImplemented=function(){throw new Error("not yet implemented")},wo.IsGeneratorFunction=function(t){return t.constructor===function*(){}.constructor},wo.RequireGeneratorFunction=function(t){if(!wo.IsGeneratorFunction(t))throw new Error("expected generator function")},wo.IsIterable=function(t){return"function"===t[Symbol.iterator]},wo.RequireIterable=function(t){if(!wo.IsIterable(t))throw new Error("expected iterable")},wo.IsDefined=function(t){return!wo.IsNullOrUndefined(t)},wo.IsNullOrUndefined=function(t){return null==t},wo.AreArrayElementsOfSameType=function(t){let e=t[0].constructor;for(let s of t)if(s.constructor!==e)return!1;return e},wo.AreArrayElementsOfType=function(t,e){for(let s of t)if(!(s instanceof e))return!1;return!0};const Po=Object.getPrototypeOf(Uint8Array);wo.IsTypedArray=function(t){return wo.IsInstanceOf(t,Po)},wo.RequireTypedArray=function(t){},wo.WeakRequireTypedArray=function(t){wo.WeakRequireInstanceOf(t,Po)},wo.WeakRequireAnyInstanceOf=function(t,...e){if(!wo.WeakIsAnyInstanceOf(t,...e))throw new TypeError("unexpected type")},wo.WeakIsAnyInstanceOf=function(t,...e){for(const s of e)if(wo.WeakIsInstanceOf(t,s))return!0;return!1},wo.WeakRequireInstanceOf=function(t,e){if(!wo.WeakIsInstanceOf(t,e))throw new TypeError("unexpected type")},wo.WeakIsInstanceOf=function(t,e){for(;t=Object.getPrototypeOf(t);)if(t.constructor.name===e.name)return!0;return!1},Mo.RequireNumber=wo.RequireNumber,Mo.RequireOptionalNumber=wo.RequireOptionalNumber,Mo.RequireFiniteNumber=wo.RequireFiniteNumber,Mo.RequireOptionalFiniteNumber=wo.RequireOptionalFiniteNumber,Mo.RequireString=wo.RequireString,Mo.RequireOptionalString=wo.RequireOptionalString,Mo.RequireObject=wo.RequireObject,Mo.RequireOptionalObject=wo.RequireOptionalObject,Mo.RequireArray=wo.RequireArray,Mo.RequireOptionalArray=wo.RequireOptionalArray,Mo.RequireFunction=wo.RequireFunction,Mo.RequireOptionalFunction=wo.RequireOptionalFunction,Mo.RequireInstanceOf=wo.RequireInstanceOf,Mo.RequireOptionalInstanceOf=wo.RequireOptionalInstanceOf,Mo.IsNullOrUndefined=wo.IsNullOrUndefined}{let vo=function(t,e){let s=Fo.getType(t),i=Fo.getType(e);return"null"===s||"null"===i||"undefined"!==s&&"undefined"!==i&&s===i},Ro=function(t){console.warn("[Defence] "+t+" @",Fo.GetCallStack())},Ao=function(){if(jo=-1,Lo.size>0||ko.size>0){let t=[...new Set([...Lo.keys()].map(t=>Fo.getName(t)))].join(",");console.warn(`An object derived from DefendedBase was not protected with debugDefend(). This will disable some checks. See the coding guidelines! Possible affected class names: ${t}`),Lo.clear(),ko.clear()}},Do=function(t){let e=new Set;for(let s in t)e.add(s);return e},Eo=function(t,e){let s=Do(e),i=Vo.get(t);if(i){let e=[];for(let t of i.values())s.has(t)?s.delete(t):e.push(t);Fo.appendArray(e,[...s]),e.length&&console.warn(`[Defence] '${Fo.getName(t)}' constructor creates inconsistent properties: ${e.join(", ")}`)}else Vo.set(t,s)};0;const Fo=self.C3,Oo=new Map;let Bo;Fo.ColorLog=function(t,e){console.log(`%c${t}`,`font-weight: bold; color:${e}`)},Fo.RafLog=function(t,...e){Oo.has(t)||Oo.set(t,-1),-1===Oo.get(t)&&Oo.set(t,requestAnimationFrame(()=>{console.log(`%c${t}`,"font-weight: bold",...e),Oo.set(t,-1)}))},Fo.StartMeasure=function(t){performance.mark(t),Bo||(Bo=new Map),Bo.has(t)||Bo.set(t,{current:0,total:0,average:0,calls:1,toString:function(){return`${t} :: current => ${this.current.toPrecision(3)} :: average => ${this.average.toPrecision(3)} :: calls => ${this.calls}`}})},Fo.EndMeasure=function(t){performance.measure(`measure-${t}`,t);const e=performance.getEntriesByName(`measure-${t}`)[0],s=Bo.get(t);s.current=e.duration,s.total+=s.current,s.average=s.total/s.calls,console.log(s.toString()),s.calls++,performance.clearMarks(t),performance.clearMeasures(`measure-${t}`)},Fo.GetCallStack=function(){return(new Error).stack},Fo.Debugger=function(){},Fo.cast=function(t,e){return t&&t instanceof e?t:null},Fo.getName=function(t){return void 0===t?"undefined":null===t?"null":"boolean"==typeof t?"<boolean>":Fo.IsNumber(t)?"<number>":Fo.IsString(t)?"<string>":Fo.IsArray(t)?"<array>":"symbol"==typeof t?"<"+t.toString()+">":Fo.IsFunction(t)?t.name&&"Function"!==t.name?t.name:"<anonymous function>":"object"==typeof t?t.constructor&&t.constructor.name&&"Object"!==t.constructor.name?t.constructor.name:"<anonymous object>":"<unknown>"},Fo.getType=function(t){return null===t?"null":Array.isArray(t)?"array":typeof t},Fo.range=function*(t,e){if(!isFinite(Math.abs(t-e)))throw new Error("Invalid parameters");if(t>e)for(let s=t-1;s>=e;s--)yield s;else for(let s=t;s<e;s++)yield s};let Lo=new Map,ko=new Map,No=new WeakMap,Uo=new WeakMap;Fo.DefendHandler={};const Wo=new Set(["then","splice"]);Fo.DefendHandler.get=function(t,e){return e in t||"symbol"==typeof e||Wo.has(e)||Ro(`Accessed missing property '${e}' from defended object '${Fo.getName(t)}', returning undefined`),Uo.has(t)&&"symbol"!=typeof e&&!Wo.has(e)&&Ro(`Accessed property '${e}' on a released object '${Fo.getName(t)}'\nObject was originally released at: ${Uo.get(t)})\nCall stack at access: `),t[e]},Fo.DefendHandler.set=function(t,e,s){return e in t||Lo.has(t)||Ro(`Set non-existent property '${e}' to '${s}' on defended object '${Fo.getName(t)}'`),vo(t[e],s)||Lo.has(t)||Ro(`Set '${Fo.getType(t[e])}' property '${e}' to type '${Fo.getType(s)}' on defended object '${Fo.getName(t)}'`),Uo.has(t)&&Ro(`Set property '${e}' on a released object '${Fo.getName(t)}'\nObject was originally released at: ${Uo.get(t)})\nCall stack at access: `),t[e]=s,!0},Fo.DefendHandler.deleteProperty=function(t,e){throw new ReferenceError(`Cannot delete property '${e}' from defended object '${Fo.getName(t)}'`)},Fo.DefendHandler.defineProperty=function(t,e,s){throw new ReferenceError(`Cannot define property '${e}' on defended object '${Fo.getName(t)}'`)},Fo.DefendHandler.enumerate=function(t){throw new ReferenceError(`Cannot enumerate defended object '${Fo.getName(t)}'`)};let jo=-1;Fo.DefendedBase=class{constructor(){if(!Fo.isDebugDefend||!Fo.Supports.Proxies)return;let t=new.target,e=Object.create(t.prototype),s=new Proxy(e,Fo.DefendHandler);return Lo.set(e,s),ko.set(s,e),No.set(s,e),-1===jo&&(jo=requestAnimationFrame(Ao)),s}},Fo.debugDefend=function(t){if(Fo.isDebugDefend&&Fo.Supports.Proxies&&t instanceof Fo.DefendedBase){if(!ko.has(t))return t;let e=ko.get(t);return ko.delete(t),Lo.delete(e),t}return Fo.isDebug?Object.seal(t):t},Fo.New=function(t,...e){let s;try{s=new t(...e)}catch(t){throw ko.clear(),Lo.clear(),t}return Fo.isDebugDefend&&Eo(t,s),Fo.debugDefend(s)},Fo.Release=function(t){let e=No.get(t);e&&Uo.set(e,Fo.GetCallStack())},Fo.WasReleased=function(t){let e=No.get(t);return!!e&&!!Uo.get(e)};let Vo=new Map;Fo.PerfMark=class{constructor(t){this._name="",t&&this.start(t)}start(t){Fo.isPerformanceProfiling&&(this._name=t,performance.mark(this._name+"-Start"))}end(){Fo.isPerformanceProfiling&&(performance.mark(this._name+"-End"),performance.measure(this._name,this._name+"-Start",this._name+"-End"))}next(t){Fo.isPerformanceProfiling&&(this.end(),this._name=t,performance.mark(this._name+"-Start"))}}}{let zo=function(t){return 0===t&&1/t<0};0;const Ho=self.C3,Yo=2*Math.PI,Xo=Math.PI/180,qo=180/Math.PI;Ho.wrap=function(t,e,s){t=Math.floor(t),e=Math.floor(e);const i=(s=Math.floor(s))-e;if(0===i)return s;if(t<e){const r=s-(e-t)%i;return r===s?0:r}return e+(t-e)%i},Ho.mapToRange=function(t,e,s,i,r){const n=s-e;return 0===n&&0===i?t:(t-e)*(r-i)/n+i},Ho.normalize=function(t,e,s){return e-s===0?1:(t-e)/(s-e)},Ho.clamp=function(t,e,s){return t<e?e:t>s?s:t},Ho.clampAngle=function(t){return(t%=Yo)<0&&(t+=Yo),t},Ho.toRadians=function(t){return t*Xo},Ho.toDegrees=function(t){return t*qo},Ho.hypot2DFast=function(t,e){return Math.sqrt(t*t+e*e)},Ho.hypot3DFast=function(t,e,s){return Math.sqrt(t*t+e*e+s*s)},Ho.distanceTo=function(t,e,s,i){return Ho.hypot2DFast(s-t,i-e)},Ho.distanceSquared=function(t,e,s,i){const r=s-t,n=i-e;return r*r+n*n},Ho.angleTo=function(t,e,s,i){return Math.atan2(i-e,s-t)},Ho.angleDiff=function(t,e){if(t===e)return 0;let s=Math.sin(t),i=Math.cos(t),r=s*Math.sin(e)+i*Math.cos(e);return r>=1?0:r<=-1?Math.PI:Math.acos(r)},Ho.angleRotate=function(t,e,s){let i=Math.sin(t),r=Math.cos(t),n=Math.sin(e),a=Math.cos(e);return Math.acos(i*n+r*a)>s?r*n-i*a>0?Ho.clampAngle(t+s):Ho.clampAngle(t-s):Ho.clampAngle(e)},Ho.angleClockwise=function(t,e){let s=Math.sin(t);return Math.cos(t)*Math.sin(e)-s*Math.cos(e)<=0},Ho.angleLerp=function(t,e,s,i=0){let r=Ho.angleDiff(t,e);const n=Yo*i;return Ho.angleClockwise(e,t)?Ho.clampAngle(t+(r+n)*s):Ho.clampAngle(t-(r+n)*s)},Ho.angleLerpClockwise=function(t,e,s,i=0){const r=Ho.angleDiff(t,e),n=Yo*i;return Ho.angleClockwise(e,t)?Ho.clampAngle(t+(r+n)*s):Ho.clampAngle(t+(Yo-r+n)*s)},Ho.angleLerpAntiClockwise=function(t,e,s,i=0){const r=Ho.angleDiff(t,e),n=Yo*i;return Ho.angleClockwise(e,t)?Ho.clampAngle(t-(-Yo+r-n)*s):Ho.clampAngle(t-(r+n)*s)},Ho.angleReflect=function(t,e){const s=Ho.angleDiff(t,e);return Ho.angleClockwise(t,e)?Ho.clampAngle(e-s):Ho.clampAngle(e+s)},Ho.lerp=function(t,e,s){return t+s*(e-t)},Ho.unlerp=function(t,e,s){return t===e?0:(s-t)/(e-t)},Ho.relerp=function(t,e,s,i,r){return Ho.lerp(i,r,Ho.unlerp(t,e,s))},Ho.qarp=function(t,e,s,i){return Ho.lerp(Ho.lerp(t,e,i),Ho.lerp(e,s,i),i)},Ho.cubic=function(t,e,s,i,r){return Ho.lerp(Ho.qarp(t,e,s,r),Ho.qarp(e,s,i,r),r)},Ho.cosp=function(t,e,s){return(t+e+(t-e)*Math.cos(s*Math.PI))/2},Ho.isPOT=function(t){return t>0&&!(t-1&t)},Ho.nextHighestPowerOfTwo=function(t){--t;for(let e=1;e<32;e<<=1)t|=t>>e;return t+1},Ho.roundToNearestFraction=function(t,e){return Math.round(t*e)/e},Ho.floorToNearestFraction=function(t,e){return Math.floor(t*e)/e},Ho.roundToDp=function(t,e){e=Math.max(Math.floor(e),0);const s=Math.pow(10,e);return Math.round(t*s)/s},Ho.countDecimals=function(t){return Math.floor(t)!==t&&t.toString().split(".")[1].length||0},Ho.toFixed=function(t,e){let s=t.toFixed(e),i=s.length-1;for(;i>=0&&"0"===s.charAt(i);--i);return i>=0&&"."===s.charAt(i)&&--i,i<0?s:s.substr(0,i+1)},Ho.PackRGB=function(t,e,s){return Ho.clamp(t,0,255)|Ho.clamp(e,0,255)<<8|Ho.clamp(s,0,255)<<16};Ho.PackRGBAEx=function(t,e,s,i){return(t=Ho.clamp(Math.floor(1024*t),-8192,8191))<0&&(t+=16384),(e=Ho.clamp(Math.floor(1024*e),-8192,8191))<0&&(e+=16384),(s=Ho.clamp(Math.floor(1024*s),-8192,8191))<0&&(s+=16384),-(16384*t*16384*1024+16384*e*1024+1024*s+(i=Ho.clamp(Math.floor(1023*i),0,1023)))},Ho.PackRGBEx=function(t,e,s){return Ho.PackRGBAEx(t,e,s,1)},Ho.GetRValue=function(t){if(t>=0)return(255&t)/255;{let e=Math.floor(-t/274877906944);return e>8191&&(e-=16384),e/1024}},Ho.GetGValue=function(t){if(t>=0)return((65280&t)>>8)/255;{let e=Math.floor(-t%274877906944/16777216);return e>8191&&(e-=16384),e/1024}},Ho.GetBValue=function(t){if(t>=0)return((16711680&t)>>16)/255;{let e=Math.floor(-t%16777216/1024);return e>8191&&(e-=16384),e/1024}},Ho.GetAValue=function(t){return zo(t)?0:t>=0?1:Math.floor(-t%1024)/1023},Ho.greatestCommonDivisor=function(t,e){for(t=Math.floor(t),e=Math.floor(e);0!==e;){let s=e;e=t%e,t=s}return t};const Jo=[[3,2],[4,3],[5,4],[5,3],[6,5],[14,9],[16,9],[16,10],[21,9]];Ho.getAspectRatio=function(t,e){if((t=Math.floor(t))===(e=Math.floor(e)))return[1,1];for(let s of Jo){let i=t/s[0]*s[1];if(Math.abs(e-i)<1)return s.slice(0);if(i=t/s[1]*s[0],Math.abs(e-i)<1)return[s[1],s[0]]}let s=Ho.greatestCommonDivisor(t,e);return[t/s,e/s]},Ho.segmentsIntersect=function(t,e,s,i,r,n,a,o){const h=Math.min(t,s),l=Math.max(t,s),c=Math.min(r,a),u=Math.max(r,a);if(l<c||h>u)return!1;const _=Math.min(e,i),d=Math.max(e,i),p=Math.min(n,o),f=Math.max(n,o);if(d<p||_>f)return!1;const g=r-t+a-s,m=n-e+o-i,S=s-t,y=i-e,G=a-r,T=o-n,I=Math.abs(y*G-T*S),C=G*m-T*g;if(Math.abs(C)>I)return!1;const b=S*m-y*g;return Math.abs(b)<=I},Ho.segmentsIntersectPreCalc=function(t,e,s,i,r,n,a,o,h,l,c,u){const _=Math.min(h,c),d=Math.max(h,c);if(n<_||r>d)return!1;const p=Math.min(l,u),f=Math.max(l,u);if(o<p||a>f)return!1;const g=h-t+c-s,m=l-e+u-i,S=s-t,y=i-e,G=c-h,T=u-l,I=Math.abs(y*G-T*S),C=G*m-T*g;if(Math.abs(C)>I)return!1;const b=S*m-y*g;return Math.abs(b)<=I},Ho.segmentIntersectsQuad=function(t,e,s,i,r){const n=Math.min(t,s),a=Math.max(t,s),o=Math.min(e,i),h=Math.max(e,i),l=r.getTlx(),c=r.getTly(),u=r.getTrx(),_=r.getTry(),d=r.getBrx(),p=r.getBry(),f=r.getBlx(),g=r.getBly();return Ho.segmentsIntersectPreCalc(t,e,s,i,n,a,o,h,l,c,u,_)||Ho.segmentsIntersectPreCalc(t,e,s,i,n,a,o,h,u,_,d,p)||Ho.segmentsIntersectPreCalc(t,e,s,i,n,a,o,h,d,p,f,g)||Ho.segmentsIntersectPreCalc(t,e,s,i,n,a,o,h,f,g,l,c)},Ho.segmentIntersectsAnyN=function(t,e,s,i,r){const n=Math.min(t,s),a=Math.max(t,s),o=Math.min(e,i),h=Math.max(e,i);let l=0;for(let c=r.length-4;l<=c;l+=2)if(Ho.segmentsIntersectPreCalc(t,e,s,i,n,a,o,h,r[l],r[l+1],r[l+2],r[l+3]))return!0;return Ho.segmentsIntersectPreCalc(t,e,s,i,n,a,o,h,r[l],r[l+1],r[0],r[1])};Ho.rayIntersect=function(t,e,s,i,r,n,a,o){const h=s-t,l=o-n,c=h*l-(i-e)*(a-r);if(0===c)return 2;const u=((e-i)*(a-t)+h*(o-e))/c;return 0<u&&u<1.000001?(l*(a-t)+(r-a)*(o-e))/c:2},Ho.rayIntersectExtended=function(t,e,s,i,r,n,a,o,h){const l=(a-r)*h,c=(o-n)*h;return Ho.rayIntersect(t,e,s,i,r-l,n-c,a+l,o+c)},Ho.isPointInTriangleInclusive=function(t,e,s,i,r,n,a,o){const h=r-s,l=n-i,c=a-s,u=o-i,_=t-s,d=e-i,p=h*h+l*l,f=h*c+l*u,g=h*_+l*d,m=c*c+u*u,S=c*_+u*d,y=1/(p*m-f*f),G=(m*g-f*S)*y,T=(p*S-f*g)*y;return G>=0&&T>=0&&G+T<=1},Ho.triangleCartesianToBarycentric=function(t,e,s,i,r,n,a,o){const h=r-s,l=n-i,c=a-s,u=o-i,_=t-s,d=e-i,p=h*h+l*l,f=h*c+l*u,g=c*c+u*u,m=_*h+d*l,S=_*c+d*u,y=p*g-f*f,G=(g*m-f*S)/y,T=(p*S-f*m)/y;return[1-G-T,G,T]},Ho.triangleBarycentricToCartesian3d=function(t,e,s,i,r,n,a,o,h,l,c,u){return[t*i+e*a+s*l,t*r+e*o+s*c,t*n+e*h+s*u]}}{const Qo=self.C3;let Ko=null,Zo="";if("undefined"!=typeof document){Ko=document;const rh=document.querySelector("base");Zo=rh&&rh.hasAttribute("href")?rh.getAttribute("href"):"",Zo&&(Zo.startsWith("/")&&(Zo=Zo.substr(1)),Zo.endsWith("/")||(Zo+="/"))}Qo.GetBaseHref=function(){return Zo},Qo.GetBaseURL=function(){if(!Ko)return"";const t=Ko.location;return Qo.GetPathFromURL(t.origin+t.pathname)+Zo},Qo.GetPathFromURL=function(t){if(!t.length)return t;if(t.endsWith("/")||t.endsWith("\\"))return t;const e=Math.max(t.lastIndexOf("/"),t.lastIndexOf("\\"));return-1===e?"":t.substr(0,e+1)},Qo.GetFilenameFromURL=function(t){if(!t.length)return t;if(t.endsWith("/")||t.endsWith("\\"))return"";const e=Math.max(t.lastIndexOf("/"),t.lastIndexOf("\\"));return-1===e?t:t.substr(e+1)},Qo.GetFileExtension=function(t){let e=t.lastIndexOf(".");return e<1?"":t.substr(e)},Qo.SetFileExtension=function(t,e){const s=t.lastIndexOf(".");return-1===s?t+"."+e:t.substr(0,s+1)+e},Qo.GetFileNamePart=function(t){let e=t.lastIndexOf(".");return e<1?t:t.substr(0,e)},Qo.NormalizeFileSeparator=function(t){return t.replace(/\\/g,"/")},Qo.IsFileExtension=function(t,e){return e===(t?Qo.GetFileExtension(t).slice(1):"")},Qo.FileNameEquals=function(t,e){let s,i;return Qo.IsFileLike(t)&&(s=Qo.GetFileNamePart(t.name)),Qo.IsString(t)&&(s=Qo.GetFileNamePart(t)),Qo.IsFileLike(e)&&(i=Qo.GetFileNamePart(e.name)),Qo.IsString(e)&&(i=Qo.GetFileNamePart(e)),s===i},Qo.ParseFilePath=function(t){t=Qo.NormalizeFileSeparator(t);let e=/^\w\:\//.exec(t);e?(e=e[0],"/"!==(t=t.slice(3))[0]&&(t="/"+t)):e="",(t=t.replace(/\/{2,}/g,"/")).length>1&&"/"===t.slice(-1)&&(t=t.slice(0,-1));const s=t.lastIndexOf("/")+1;let i,r="",n=t,a="";s>0&&(r=t.slice(0,s),n=t.slice(s)),i=n;const o=n.lastIndexOf(".");return o>0&&(a=n.slice(o),i=n.slice(0,-a.length)),{dir:r,base:n,name:i,root:e,ext:a,full:e+r+n}},Qo.Wait=function(t,e){return new Promise((s,i)=>{self.setTimeout(s,t,e)})},Qo.swallowException=function(t){try{t()}catch(t){Qo.isDebug&&console.warn("Swallowed exception: ",t)}},Qo.noop=function(){},Qo.equalsNoCase=function(t,e){return"string"==typeof t&&"string"==typeof e&&(t===e||t.normalize().toLowerCase()===e.normalize().toLowerCase())},Qo.equalsCase=function(t,e){return"string"==typeof t&&"string"==typeof e&&(t===e||t.normalize()===e.normalize())},Qo.typedArraySet16=function(t,e,s){t[s++]=e[0],t[s++]=e[1],t[s++]=e[2],t[s++]=e[3],t[s++]=e[4],t[s++]=e[5],t[s++]=e[6],t[s++]=e[7],t[s++]=e[8],t[s++]=e[9],t[s++]=e[10],t[s++]=e[11],t[s++]=e[12],t[s++]=e[13],t[s++]=e[14],t[s]=e[15]},Qo.truncateArray=function(t,e){t.length=e},Qo.clearArray=function(t){t&&0!==t.length&&Qo.truncateArray(t,0)},Qo.clear2DArray=function(t){if(t){for(let e=0;e<t.length;e++){let s=t[e];Qo.truncateArray(s,0)}Qo.truncateArray(t,0)}},Qo.extendArray=function(t,e,s){e|=0;const i=t.length;if(!(e<=i))for(let r=i;r<e;++r)t.push(s)},Qo.resizeArray=function(t,e,s){e|=0;const i=t.length;e<i?Qo.truncateArray(t,e):e>i&&Qo.extendArray(t,e,s)},Qo.shallowAssignArray=function(t,e){Qo.clearArray(t),Qo.appendArray(t,e)},Qo.appendArray=function(t,e){if(e.length<1e4)t.push(...e);else for(let s=0,i=e.length;s<i;++s)t.push(e[s])},Qo.arrayRemove=function(t,e){if((e=Math.floor(e))<0||e>=t.length)return;let s=t.length-1;for(let i=e;i<s;++i)t[i]=t[i+1];Qo.truncateArray(t,s)},Qo.arrayFindRemove=function(t,e){let s=t.indexOf(e);s>=0&&t.splice(s,1)},Qo.arraysEqual=function(t,e){let s=t.length;if(e.length!==s)return!1;for(let i=0;i<s;++i)if(t[i]!==e[i])return!1;return!0},Qo.arrayFilterOut=function(t,e){let s=[],i=0;for(let r=0,n=t.length;r<n;++r){let n=t[r];e(n)?s.push(n):(t[i]=n,++i)}return Qo.truncateArray(t,i),s},Qo.arrayRemoveAllInSet=function(t,e){const s=t.length;let i=0;for(let s=0,r=t.length;s<r;++s){let r=t[s];e.has(r)||(t[i++]=r)}return Qo.truncateArray(t,i),s-i},Qo.isArrayIndexInBounds=function(t,e){return t===Math.floor(t)&&t>=0&&t<e.length},Qo.validateArrayIndex=function(t,e){if(!Qo.isArrayIndexInBounds(t,e))throw new RangeError("array index out of bounds")},Qo.cloneArray=function(t){return t.slice()},Qo.deepCloneArray=function(t,e){let s=[];for(let i of t)if(Qo.IsObject(i)){let t=e(i);if(!t)throw new Error("missing clone");if(t.constructor!==i.constructor)throw new Error("object is not a clone");s.push(t)}else Qo.IsArray(i)?s.push(Qo.deepCloneArray(i,e)):s.push(i);return s},Qo.clone2DArray=function(t){let e=[];for(let s of t)e.push(s.slice());return e},Qo.splitStringAndNormalize=function(t,e=" "){return t?t.split(e).map(t=>t.trim()).filter(t=>!!t):[]},Qo.filterSet=function(t,e,s){const i=new Set;for(const r of t.values())e(r)&&(s?i.add(s(r)):i.add(r));return i},Qo.mergeSets=function(t,e){return t.union?t.union(e):new Set([...t,...e])},Qo.mergeSetsInPlace=function(t,e){for(const s of e)t.add(s);return t},Qo.first=function(t){for(let e of t)return e;return null},Qo.xor=function(t,e){return!t!=!e},Qo.compare=function(t,e,s){switch(e){case 0:return t===s;case 1:return t!==s;case 2:return t<s;case 3:return t<=s;case 4:return t>s;case 5:return t>=s;default:return!1}},Qo.hasAnyOwnProperty=function(t){for(let e in t)if(t.hasOwnProperty(e))return!0;return!1},Qo.PromiseAllWithProgress=function(t,e){return t.length?new Promise((s,i)=>{const r=[];let n=0,a=!1;for(let o=0,h=t.length;o<h;++o)r.push(void 0),t[o].then(i=>{a||(r[o]=i,++n,n===t.length?s(r):e(n,t.length))}).catch(t=>{a=!0,i(t)})}):Promise.resolve([])};let $o=[];Qo.AddLibraryMemoryCallback=function(t){$o.push(t)},Qo.GetEstimatedLibraryMemoryUsage=function(){let t=0;for(let e of $o)t+=e();return Math.floor(t)};let th=1;const eh=new Map,sh=new MessageChannel;sh.port2.onmessage=function(t){const e=t.data,s=eh.get(e);eh.delete(e),s&&s(performance.now())},Qo.RequestUnlimitedAnimationFrame=function(t){const e=th++;return eh.set(e,t),sh.port1.postMessage(e),e},Qo.CancelUnlimitedAnimationFrame=function(t){eh.delete(t)},Qo.PostTask=Qo.RequestUnlimitedAnimationFrame,Qo.WaitForNextTask=function(){return new Promise(t=>Qo.PostTask(t))};const ih=new Set;Qo.RequestPostAnimationFrame=function(t){const e=self.requestAnimationFrame(async s=>{await Qo.WaitForNextTask(),ih.has(e)&&(ih.delete(e),t(s))});return ih.add(e),e},Qo.CancelPostAnimationFrame=function(t){ih.has(t)&&(self.cancelAnimationFrame(t),ih.delete(t))}}{const nh=self.C3;nh.IsAbsoluteURL=function(t){return/^(?:[a-z\-]+:)?\/\//.test(t)||"data:"===t.substr(0,5)||"blob:"===t.substr(0,5)},nh.IsRelativeURL=function(t){return!nh.IsAbsoluteURL(t)},nh.ThrowIfNotOk=function(t){if(!t.ok)throw new Error(`fetch '${t.url}' response returned ${t.status} ${t.statusText}`)},nh.FetchOk=function(t,e){return fetch(t,e).then(t=>(nh.ThrowIfNotOk(t),t))},nh.FetchText=function(t){return nh.FetchOk(t).then(t=>t.text())},nh.FetchJson=function(t){return nh.FetchOk(t).then(t=>t.json())},nh.FetchBlob=function(t){return nh.FetchOk(t).then(t=>t.blob())},nh.FetchArrayBuffer=function(t){return nh.FetchOk(t).then(t=>t.arrayBuffer())},nh.FetchImage=function(t){return new Promise((e,s)=>{const i=new Image;i.onload=()=>e(i),i.onerror=t=>s(t),i.src=t})},nh.BlobToArrayBuffer=function(t){return"function"==typeof t.arrayBuffer?t.arrayBuffer():new Promise((e,s)=>{const i=new FileReader;i.onload=()=>e(i.result),i.onerror=()=>s(i.error),i.readAsArrayBuffer(t)})},nh.BlobToString=function(t){return"function"==typeof t.text?t.text():new Promise((e,s)=>{const i=new FileReader;i.onload=()=>e(i.result),i.onerror=()=>s(i.error),i.readAsText(t)})},nh.BlobToJson=function(t){return nh.BlobToString(t).then(t=>JSON.parse(t))},nh.BlobToImage=async function(t,e){let s=URL.createObjectURL(t);try{const t=await nh.FetchImage(s);return URL.revokeObjectURL(s),s="",e&&"function"==typeof t.decode&&await t.decode(),t}finally{s&&URL.revokeObjectURL(s)}},nh.CreateCanvas=function(t,e){if("undefined"!=typeof document&&"function"==typeof document.createElement){const s=document.createElement("canvas");return s.width=t,s.height=e,s}return new OffscreenCanvas(t,e)},nh.CanvasToBlob=function(t,e,s){if("number"!=typeof s&&(s=1),e=e||"image/png",s=nh.clamp(s,0,1),t.convertToBlob)return t.convertToBlob({type:e,quality:s});if(t.toBlob)return new Promise(i=>t.toBlob(i,e,s));throw new Error("could not convert canvas to blob")},nh.DrawableToBlob=function(t,e,s){const i=nh.CreateCanvas(t.width,t.height);return i.getContext("2d").drawImage(t,0,0),nh.CanvasToBlob(i,e,s)},nh.ImageDataToBlob=function(t,e,s){if(nh.Supports.ImageBitmapOptions)return createImageBitmap(t,{premultiplyAlpha:"none"}).then(t=>nh.DrawableToBlob(t,e,s));if(nh.Supports.ImageBitmap)return createImageBitmap(t).then(t=>nh.DrawableToBlob(t,e,s));{const i=nh.CreateCanvas(t.width,t.height);return i.getContext("2d").putImageData(t,0,0),nh.CanvasToBlob(i,e,s)}},nh.CopySet=function(t,e){t.clear();for(const s of e)t.add(s)},nh.MapToObject=function(t){const e=Object.create(null);for(const[s,i]of t.entries())e[s]=i;return e},nh.ObjectToMap=function(t,e){e.clear();for(const[s,i]of Object.entries(t))e.set(s,i)},nh.ToSuperJSON=function t(e){if("object"==typeof e&&null!==e){if(e instanceof Set)return{_c3type_:"set",data:[...e].map(e=>t(e))};if(e instanceof Map)return{_c3type_:"map",data:[...e].map(e=>[e[0],t(e[1])])};{const s=Object.create(null);for(const[i,r]of Object.entries(e))s[i]=t(r);return s}}return e},nh.FromSuperJSON=function t(e){if("object"==typeof e&null!==e){if("set"===e._c3type_)return new Set(e.data.map(e=>t(e)));if("map"===e._c3type_)return new Map(e.data.map(e=>[e[0],t(e[1])]));{const s=Object.create(null);for(const[i,r]of Object.entries(e))s[i]=t(r);return s}}return e},nh.CSSToCamelCase=function(t){if(t.startsWith("--"))return t;let e="",s=!1,i=0;for(const r of t)"-"===r?i>0&&(s=!0):s?(e+=r.toUpperCase(),s=!1):e+=r,++i;return e},nh.IsIterator=function(t){return"object"==typeof t&&"function"==typeof t.next},nh.MakeFilledArray=function(t,e){const s=[];if("function"==typeof e)for(let i=0;i<t;++i)s.push(e());else for(let i=0;i<t;++i)s.push(e);return s}}{let ah=function(t){return 0===t.length?"00":1===t.length?"0"+t:t},oh=function(t,e,s){return s<0&&(s+=1),s>1&&(s-=1),s<1/6?t+6*(e-t)*s:s<.5?e:s<2/3?t+(e-t)*(2/3-s)*6:t};0;const hh=self.C3,lh=/([0-9.]+),([0-9.]+)\%?,([0-9.]+)\%?/i,ch=/([0-9.]+),([0-9.]+)\%?,([0-9.]+)\%?,([0-9.])/i;hh.Color=class{constructor(t,e,s,i){this._r=NaN,this._g=NaN,this._b=NaN,this._a=NaN,this._r=0,this._g=0,this._b=0,this._a=0,t instanceof hh.Color?this.set(t):this.setRgba(t||0,e||0,s||0,i||0)}setRgb(t,e,s){return this._r=+t,this._g=+e,this._b=+s,this.clamp(),this}setRgba(t,e,s,i){return this._r=+t,this._g=+e,this._b=+s,this._a=+i,this.clamp(),this}set(t){return this._r=t._r,this._g=t._g,this._b=t._b,this._a=t._a,this}copy(t){return this.set(t)}add(t){this._r+=t._r,this._g+=t._g,this._b+=t._b,this._a+=t._a,this.clamp()}addRgb(t,e,s,i=0){this._r+=+t,this._g+=+e,this._b+=+s,this._a+=+i,this.clamp()}diff(t){this.setR(Math.max(this._r,t._r)-Math.min(this._r,t._r)),this.setG(Math.max(this._g,t._g)-Math.min(this._g,t._g)),this.setB(Math.max(this._b,t._b)-Math.min(this._b,t._b)),this.setA(Math.max(this._a,t._a)-Math.min(this._a,t._a)),this.clamp()}copyRgb(t){this._r=t._r,this._g=t._g,this._b=t._b}setR(t){this._r=hh.clamp(+t,0,1)}getR(){return this._r}setG(t){this._g=hh.clamp(+t,0,1)}getG(){return this._g}setB(t){this._b=hh.clamp(+t,0,1)}getB(){return this._b}setA(t){this._a=hh.clamp(+t,0,1)}getA(){return this._a}clone(){return hh.New(hh.Color,this._r,this._g,this._b,this._a)}toArray(){return[this._r,this._g,this._b,this._a]}toTypedArray(){return new Float64Array(this.toArray())}writeToTypedArray(t,e){t[e++]=this._r,t[e++]=this._g,t[e++]=this._b,t[e]=this._a}writeToTypedArrayx4(t,e){const s=this._r,i=this._g,r=this._b,n=this._a;for(let a=0;a<4;++a)t[e++]=s,t[e++]=i,t[e++]=r,t[e++]=n}writeRGBToTypedArray(t,e){t[e++]=this._r,t[e++]=this._g,t[e]=this._b}equals(t){return this._r===t._r&&this._g===t._g&&this._b===t._b&&this._a===t._a}equalsIgnoringAlpha(t){return this._r===t._r&&this._g===t._g&&this._b===t._b}equalsRgb(t,e,s){return this._r===t&&this._g===e&&this._b===s}equalsRgba(t,e,s,i){return this._r===t&&this._g===e&&this._b===s&&this._a===i}equalsF32Array(t,e){return t[e]===Math.fround(this._r)&&t[e+1]===Math.fround(this._g)&&t[e+2]===Math.fround(this._b)&&t[e+3]===Math.fround(this._a)}equalsRGBF32Array(t,e){return t[e]===Math.fround(this._r)&&t[e+1]===Math.fround(this._g)&&t[e+2]===Math.fround(this._b)}multiply(t){this._r*=t._r,this._g*=t._g,this._b*=t._b,this._a*=t._a}multiplyAlpha(t){this._r*=t,this._g*=t,this._b*=t,this._a*=t}premultiply(){return this._r*=this._a,this._g*=this._a,this._b*=this._a,this}unpremultiply(){return this._r/=this._a,this._g/=this._a,this._b/=this._a,this}clamp(){return this._r=hh.clamp(this._r,0,1),this._g=hh.clamp(this._g,0,1),this._b=hh.clamp(this._b,0,1),this._a=hh.clamp(this._a,0,1),this}setFromRgbValue(t){this._r=hh.GetRValue(t),this._g=hh.GetGValue(t),this._b=hh.GetBValue(t),this._a=hh.GetAValue(t)}getCssRgb(t,e,s){return`rgb(${100*(hh.IsFiniteNumber(t)?t:this.getR())}%, ${100*(hh.IsFiniteNumber(e)?e:this.getG())}%, ${100*(hh.IsFiniteNumber(s)?s:this.getB())}%)`}getCssRgba(t,e,s,i){return`rgba(${100*(hh.IsFiniteNumber(t)?t:this.getR())}%, ${100*(hh.IsFiniteNumber(e)?e:this.getG())}%, ${100*(hh.IsFiniteNumber(s)?s:this.getB())}%, ${hh.IsFiniteNumber(i)?i:this.getA()})`}toHexString(t=!1){const e=Math.round(255*this.getR()),s=Math.round(255*this.getG()),i=Math.round(255*this.getB());let r="#"+ah(e.toString(16))+ah(s.toString(16))+ah(i.toString(16));return t&&(r+=ah(Math.round(255*this.getA()).toString(16))),r}parseHexString(t){if("string"!=typeof t)return!1;let e,s,i,r;if("#"===(t=t.trim()).charAt(0)&&(t=t.substr(1)),3===t.length||4===t.length)e=parseInt(t[0],16)/15,s=parseInt(t[1],16)/15,i=parseInt(t[2],16)/15,4===t.length&&(r=parseInt(t[3],16)/15);else{if(6!==t.length&&8!==t.length)return!1;e=parseInt(t.substr(0,2),16)/255,s=parseInt(t.substr(2,2),16)/255,i=parseInt(t.substr(4,2),16)/255,8===t.length&&(r=parseInt(t.substr(6,2),16)/255)}return!!(Number.isFinite(e)&&Number.isFinite(s)&&Number.isFinite(i))&&(this.setRgb(e,s,i),Number.isFinite(r)?this.setA(r):this.setA(1),!0)}toCommaSeparatedRgb(){return`${Math.round(255*this.getR())}, ${Math.round(255*this.getG())}, ${Math.round(255*this.getB())}`}toRgbArray(){return[Math.round(255*this.getR()),Math.round(255*this.getG()),Math.round(255*this.getB())]}parseCommaSeparatedRgb(t){if("string"!=typeof t)return!1;const e=(t=t.replace(/^rgb\(|\)|%/,"")).split(",");if(e.length<3)return!1;const s=parseInt(e[0].trim(),10)/255,i=parseInt(e[1].trim(),10)/255,r=parseInt(e[2].trim(),10)/255;return isFinite(s)&&this.setR(s),isFinite(i)&&this.setG(i),isFinite(r)&&this.setB(r),this.setA(1),!0}parseCommaSeparatedPercentageRgb(t){if("string"!=typeof t)return!1;const e=(t=t.replace(/^rgb\(|\)|%/,"")).split(",");if(e.length<3)return!1;const s=parseInt(e[0].trim(),10)/100,i=parseInt(e[1].trim(),10)/100,r=parseInt(e[2].trim(),10)/100;return isFinite(s)&&this.setR(s),isFinite(i)&&this.setG(i),isFinite(r)&&this.setB(r),this.setA(1),!0}parseCommaSeparatedRgba(t){if("string"!=typeof t)return!1;const e=(t=t.replace(/^rgba\(|\)|%/,"")).split(",");if(e.length<4)return!1;const s=parseInt(e[0].trim(),10)/255,i=parseInt(e[1].trim(),10)/255,r=parseInt(e[2].trim(),10)/255,n=parseFloat(e[3].trim());return isFinite(s)&&this.setR(s),isFinite(i)&&this.setG(i),isFinite(r)&&this.setB(r),isFinite(n)&&this.setA(n),!0}parseCommaSeparatedPercentageRgba(t){if("string"!=typeof t)return!1;const e=(t=t.replace(/^rgba\(|\)|%/,"")).split(",");if(e.length<4)return!1;const s=parseInt(e[0].trim(),10)/100,i=parseInt(e[1].trim(),10)/100,r=parseInt(e[2].trim(),10)/100,n=parseFloat(e[3].trim());return isFinite(s)&&this.setR(s),isFinite(i)&&this.setG(i),isFinite(r)&&this.setB(r),isFinite(n)&&this.setA(n),!0}parseString(t){if("string"!=typeof t)return!1;if((t=t.replace(/\s+/,"")).includes(",")){if(t.startsWith("rgb("))return t.includes("%")?this.parseCommaSeparatedPercentageRgb(t):this.parseCommaSeparatedRgb(t);if(t.startsWith("rgba("))return t.includes("%")?this.parseCommaSeparatedPercentageRgba(t):this.parseCommaSeparatedRgba(t);if(t.startsWith("hsl(")||t.startsWith("hsla("))return this.parseHSLString(t);{const e=t.split(",");return t.includes("%")?3===e.length?this.parseCommaSeparatedPercentageRgb(t):4===e.length&&this.parseCommaSeparatedPercentageRgba(t):3===e.length?this.parseCommaSeparatedRgb(t):4===e.length&&this.parseCommaSeparatedRgba(t)}}return this.parseHexString(t)}toJSON(){return[this._r,this._g,this._b,this._a]}setFromHSLA(t,e,s,i){let r,n,a;if(t%=360,e=hh.clamp(e,0,100),s=hh.clamp(s,0,100),i=hh.clamp(i,0,1),t/=360,s/=100,0==(e/=100))r=n=a=s;else{const i=s<.5?s*(1+e):s+e-s*e,o=2*s-i;r=oh(o,i,t+1/3),n=oh(o,i,t),a=oh(o,i,t-1/3)}return this.setR(r),this.setG(n),this.setB(a),this.setA(i),this}parseHSLString(t){const e=t.replace(/ |hsl|hsla|\(|\)|;/gi,""),s=lh.exec(e),i=ch.exec(e);return s&&4===s.length?(this.setFromHSLA(+s[1],+s[2],+s[3],1),!0):!(!i||5!==i.length||(this.setFromHSLA(+s[1],+s[2],+s[3],+s[4]),0))}toHSLAString(){const t=this._r,e=this._g,s=this._b,i=this._a;return`hsla(${hh.Color.GetHue(t,e,s)}, ${hh.Color.GetSaturation(t,e,s)}%, ${hh.Color.GetLuminosity(t,e,s)}%, ${i})`}toHSLAArray(){const t=this._r,e=this._g,s=this._b;return[hh.Color.GetHue(t,e,s),hh.Color.GetSaturation(t,e,s),hh.Color.GetLuminosity(t,e,s),this._a]}setFromJSON(t){Array.isArray(t)&&(t.length<3||(this._r=t[0],this._g=t[1],this._b=t[2],t.length>=4?this._a=t[3]:this._a=1))}set r(t){this.setR(t)}get r(){return this.getR()}set g(t){this.setG(t)}get g(){return this.getG()}set b(t){this.setB(t)}get b(){return this.getB()}set a(t){this.setA(t)}get a(){return this.getA()}setAtIndex(t,e){switch(t){case 0:this.setR(e);break;case 1:this.setG(e);break;case 2:this.setB(e);break;case 3:this.setA(e);break;default:throw new RangeError("invalid color index")}}getAtIndex(t){switch(t){case 0:return this.getR();case 1:return this.getG();case 2:return this.getB();case 3:return this.getA();default:throw new RangeError("invalid color index")}}static Equals(t,e){let s,i;if(Array.isArray(t))s=new hh.Color,s.setFromJSON(t);else{if(!(t instanceof hh.Color))throw new Error("unexpected type");s=t}if(Array.isArray(e))i=new hh.Color,i.setFromJSON(e);else{if(!(e instanceof hh.Color))throw new Error("unexpected type");i=e}return s.equals(i)}static DiffChannel(t,e){return hh.clamp(Math.max(t,e)-Math.min(t,e),0,1)}static Diff(t,e){const s=new hh.Color;return s.setR(Math.max(t._r,e._r)-Math.min(t._r,e._r)),s.setG(Math.max(t._g,e._g)-Math.min(t._g,e._g)),s.setB(Math.max(t._b,e._b)-Math.min(t._b,e._b)),s.setA(Math.max(t._a,e._a)-Math.min(t._a,e._a)),s}static DiffNoAlpha(t,e){const s=new hh.Color(0,0,0,1);return s.setR(Math.max(t._r,e._r)-Math.min(t._r,e._r)),s.setG(Math.max(t._g,e._g)-Math.min(t._g,e._g)),s.setB(Math.max(t._b,e._b)-Math.min(t._b,e._b)),s}static GetHue(t,e,s){const i=Math.max(t,e,s),r=Math.min(t,e,s);if(i===r)return 0;let n=0;switch(i){case t:n=(e-s)/(i-r)+(e<s?6:0);break;case e:n=(s-t)/(i-r)+2;break;case s:n=(t-e)/(i-r)+4}return Math.round(n/6*360)}static GetSaturation(t,e,s){const i=Math.max(t,e,s),r=Math.min(t,e,s);if(i===r)return 0;const n=i-r,a=(i+r)/2>.5?n/(2-i-r):n/(i+r);return Math.round(100*a)}static GetLuminosity(t,e,s){const i=Math.max(t,e,s),r=(i+Math.min(t,e,s))/2;return i?Math.round(100*r):0}},hh.Color.White=Object.freeze(hh.New(hh.Color,1,1,1,1)),hh.Color.Black=Object.freeze(hh.New(hh.Color,0,0,0,1)),hh.Color.TransparentBlack=Object.freeze(hh.New(hh.Color,0,0,0,0))}{const uh=self.C3;uh.Vector2=class{constructor(t,e){this._x=0,this._y=0,t instanceof uh.Vector2?this.copy(t):this.set(t||0,e||0)}set(t,e){this._x=+t,this._y=+e}copy(t){this._x=t._x,this._y=t._y}equals(t){return this._x===t._x&&this._y===t._y}equalsValues(t,e){return this._x===t&&this._y===e}equalsF32Array(t,e){return t[e]===Math.fround(this._x)&&t[e+1]===Math.fround(this._y)}setX(t){this._x=+t}getX(){return this._x}setY(t){this._y=+t}getY(){return this._y}toArray(){return[this._x,this._y]}toTypedArray(){return new Float64Array(this.toArray())}writeToTypedArray(t,e){t[e++]=this._x,t[e]=this._y}offset(t,e){this._x+=+t,this._y+=+e}scale(t,e){this._x*=t,this._y*=e}divide(t,e){this._x/=t,this._y/=e}round(){this._x=Math.round(this._x),this._y=Math.round(this._y)}floor(){this._x=Math.floor(this._x),this._y=Math.floor(this._y)}ceil(){this._x=Math.ceil(this._x),this._y=Math.ceil(this._y)}angle(){return uh.angleTo(0,0,this._x,this._y)}lengthSquared(){return this._x*this._x+this._y*this._y}length(){return uh.hypot2DFast(this._x,this._y)}rotatePrecalc(t,e){const s=this._x*e-this._y*t;this._y=this._y*e+this._x*t,this._x=s}rotate(t){0!==t&&this.rotatePrecalc(Math.sin(t),Math.cos(t))}rotateAbout(t,e,s){0===t||e===this._x&&s===this._y||(this._x-=e,this._y-=s,this.rotatePrecalc(Math.sin(t),Math.cos(t)),this._x+=+e,this._y+=+s)}move(t,e){0!==e&&(this._x+=Math.cos(t)*e,this._y+=Math.sin(t)*e)}normalize(){const t=this.length();0!==t&&1!==t&&(this._x/=t,this._y/=t)}clamp(t,e){this._x=uh.clamp(this._x,t,e),this._y=uh.clamp(this._y,t,e)}dot(t){return this._x*t._x+this._y*t._y}reverse(){this._x=-this._x,this._y=-this._y}perp(){let t=this._x;return this._x=this._y,this._y=-t,this}}}{const _h=self.C3;_h.Rect=class{constructor(t,e,s,i){this._left=NaN,this._top=NaN,this._right=NaN,this._bottom=NaN,this._left=0,this._top=0,this._right=0,this._bottom=0,t instanceof _h.Rect?this.copy(t):this.set(t||0,e||0,s||0,i||0)}set(t,e,s,i){this._left=+t,this._top=+e,this._right=+s,this._bottom=+i}setWH(t,e,s,i){t=+t,e=+e,this._left=t,this._top=e,this._right=t+ +s,this._bottom=e+ +i}copy(t){this._left=+t._left,this._top=+t._top,this._right=+t._right,this._bottom=+t._bottom}clone(){return new _h.Rect(this._left,this._top,this._right,this._bottom)}static Merge(t,e){const s=new _h.Rect;return s.setLeft(Math.min(t._left,e._left)),s.setTop(Math.min(t._top,e._top)),s.setRight(Math.max(t._right,e._right)),s.setBottom(Math.max(t._bottom,e._bottom)),s}static FromObject(t){return new _h.Rect(t.left,t.top,t.right,t.bottom)}equals(t){return this._left===t._left&&this._top===t._top&&this._right===t._right&&this._bottom===t._bottom}equalsWH(t,e,s,i){return this._left===t&&this._top===e&&this.width()===s&&this.height()===i}equalsF32Array(t,e){return t[e]===Math.fround(this._left)&&t[e+1]===Math.fround(this._top)&&t[e+2]===Math.fround(this._right)&&t[e+3]===Math.fround(this._bottom)}setLeft(t){this._left=+t}getLeft(){return this._left}setTop(t){this._top=+t}getTop(){return this._top}setRight(t){this._right=+t}getRight(){return this._right}setBottom(t){this._bottom=+t}getBottom(){return this._bottom}toArray(){return[this._left,this._top,this._right,this._bottom]}toTypedArray(){return new Float64Array(this.toArray())}toDOMRect(){return new DOMRect(this._left,this._top,this.width(),this.height())}static fromDOMRect(t){return _h.New(_h.Rect,t.left,t.top,t.right,t.bottom)}writeToTypedArray(t,e){t[e++]=this._left,t[e++]=this._top,t[e++]=this._right,t[e]=this._bottom}writeAsQuadToTypedArray(t,e){t[e++]=this._left,t[e++]=this._top,t[e++]=this._right,t[e++]=this._top,t[e++]=this._right,t[e++]=this._bottom,t[e++]=this._left,t[e]=this._bottom}writeAsQuadToTypedArray3D(t,e,s){t[e++]=this._left,t[e++]=this._top,t[e++]=s,t[e++]=this._right,t[e++]=this._top,t[e++]=s,t[e++]=this._right,t[e++]=this._bottom,t[e++]=s,t[e++]=this._left,t[e++]=this._bottom,t[e]=s}width(){return this._right-this._left}height(){return this._bottom-this._top}midX(){return(this._left+this._right)/2}midY(){return(this._top+this._bottom)/2}offset(t,e){t=+t,e=+e,this._left+=t,this._top+=e,this._right+=t,this._bottom+=e}offsetLeft(t){this._left+=+t}offsetTop(t){this._top+=+t}offsetRight(t){this._right+=+t}offsetBottom(t){this._bottom+=+t}toSquare(t){if("x"!==t)throw new Error("invalid axis, only 'x' supported");this._top<this._bottom?this._left<this._right?this._bottom=this._top+this.width():this._bottom=this._top-this.width():this._left<this._right?this._bottom=this._top-this.width():this._bottom=this._top+this.width()}inflate(t,e){t=+t,e=+e,this._left-=t,this._top-=e,this._right+=t,this._bottom+=e}deflate(t,e){t=+t,e=+e,this._left+=t,this._top+=e,this._right-=t,this._bottom-=e}multiply(t,e){this._left*=t,this._top*=e,this._right*=t,this._bottom*=e}divide(t,e){this._left/=t,this._top/=e,this._right/=t,this._bottom/=e}mirrorAround(t){this._left=+t-this._left,this._right=+t-this._right}flipAround(t){this._top=+t-this._top,this._bottom=+t-this._bottom}rotate90DegreesAround(t,e){const s=this.width(),i=this.height(),r=this.getLeft()+s*t,n=this.getTop()+i*e;this.setWH(r-i*e,n-s*t,i,s)}swapLeftRight(){const t=this._left;this._left=this._right,this._right=t}swapTopBottom(){const t=this._top;this._top=this._bottom,this._bottom=t}shuntY(t){const e=this._top;this._top=+t-this._bottom,this._bottom=+t-e}round(){this._left=Math.round(this._left),this._top=Math.round(this._top),this._right=Math.round(this._right),this._bottom=Math.round(this._bottom)}roundInner(){this._left=Math.ceil(this._left),this._top=Math.ceil(this._top),this._right=Math.floor(this._right),this._bottom=Math.floor(this._bottom)}roundOuter(){this._left=Math.floor(this._left),this._top=Math.floor(this._top),this._right=Math.ceil(this._right),this._bottom=Math.ceil(this._bottom)}floor(){this._left=Math.floor(this._left),this._top=Math.floor(this._top),this._right=Math.floor(this._right),this._bottom=Math.floor(this._bottom)}ceil(){this._left=Math.ceil(this._left),this._top=Math.ceil(this._top),this._right=Math.ceil(this._right),this._bottom=Math.ceil(this._bottom)}clamp(t,e,s,i){this._left=Math.max(this._left,+t),this._top=Math.max(this._top,+e),this._right=Math.min(this._right,+s),this._bottom=Math.min(this._bottom,+i)}clampBoth(t,e,s,i){t=+t,e=+e,s=+s,i=+i,this._left=_h.clamp(this._left,t,s),this._top=_h.clamp(this._top,e,i),this._right=_h.clamp(this._right,t,s),this._bottom=_h.clamp(this._bottom,e,i)}normalize(){this._left>this._right&&this.swapLeftRight(),this._top>this._bottom&&this.swapTopBottom()}intersectsRect(t){return!(t._right<this._left||t._bottom<this._top||t._left>this._right||t._top>this._bottom)}intersectsRectOffset(t,e,s){return!(t._right+e<this._left||t._bottom+s<this._top||t._left+e>this._right||t._top+s>this._bottom)}containsPoint(t,e){return t>=this._left&&t<=this._right&&e>=this._top&&e<=this._bottom}containsRect(t){return t._left>=this._left&&t._top>=this._top&&t._right<=this._right&&t._bottom<=this._bottom}expandToContain(t){t._left<this._left&&(this._left=+t._left),t._top<this._top&&(this._top=+t._top),t._right>this._right&&(this._right=+t._right),t._bottom>this._bottom&&(this._bottom=+t._bottom)}lerpInto(t){this._left=_h.lerp(t._left,t._right,this._left),this._top=_h.lerp(t._top,t._bottom,this._top),this._right=_h.lerp(t._left,t._right,this._right),this._bottom=_h.lerp(t._top,t._bottom,this._bottom)}}}{const dh=self.C3;dh.Quad=class{constructor(t,e,s,i,r,n,a,o){this._tlx=NaN,this._tly=NaN,this._trx=NaN,this._try=NaN,this._brx=NaN,this._bry=NaN,this._blx=NaN,this._bly=NaN,this._tlx=0,this._tly=0,this._trx=0,this._try=0,this._brx=0,this._bry=0,this._blx=0,this._bly=0,t instanceof dh.Quad?this.copy(t):this.set(t||0,e||0,s||0,i||0,r||0,n||0,a||0,o||0)}set(t,e,s,i,r,n,a,o){this._tlx=+t,this._tly=+e,this._trx=+s,this._try=+i,this._brx=+r,this._bry=+n,this._blx=+a,this._bly=+o}setRect(t,e,s,i){this.set(t,e,s,e,s,i,t,i)}copy(t){this._tlx=t._tlx,this._tly=t._tly,this._trx=t._trx,this._try=t._try,this._brx=t._brx,this._bry=t._bry,this._blx=t._blx,this._bly=t._bly}equals(t){return this._tlx===t._tlx&&this._tly===t._tly&&this._trx===t._trx&&this._try===t._try&&this._brx===t._brx&&this._bry===t._bry&&this._blx===t._blx&&this._bly===t._bly}setTlx(t){this._tlx=+t}getTlx(){return this._tlx}setTly(t){this._tly=+t}getTly(){return this._tly}setTrx(t){this._trx=+t}getTrx(){return this._trx}setTry(t){this._try=+t}getTry(){return this._try}setBrx(t){this._brx=+t}getBrx(){return this._brx}setBry(t){this._bry=+t}getBry(){return this._bry}setBlx(t){this._blx=+t}getBlx(){return this._blx}setBly(t){this._bly=+t}getBly(){return this._bly}toDOMQuad(){return new DOMQuad(new DOMPoint(this._tlx,this._tly),new DOMPoint(this._trx,this._try),new DOMPoint(this._brx,this._bry),new DOMPoint(this._blx,this._bly))}static fromDOMQuad(t){return dh.New(dh.Quad,t.p1.x,t.p1.y,t.p2.x,t.p2.y,t.p3.x,t.p3.y,t.p4.x,t.p4.y)}toArray(){return[this._tlx,this._tly,this._trx,this._try,this._brx,this._bry,this._blx,this._bly]}toTypedArray(){return new Float64Array(this.toArray())}writeToTypedArray(t,e){t[e++]=this._tlx,t[e++]=this._tly,t[e++]=this._trx,t[e++]=this._try,t[e++]=this._brx,t[e++]=this._bry,t[e++]=this._blx,t[e]=this._bly}writeToTypedArray3D(t,e,s){t[e++]=this._tlx,t[e++]=this._tly,t[e++]=s,t[e++]=this._trx,t[e++]=this._try,t[e++]=s,t[e++]=this._brx,t[e++]=this._bry,t[e++]=s,t[e++]=this._blx,t[e++]=this._bly,t[e]=s}offset(t,e){t=+t,e=+e,this._tlx+=t,this._tly+=e,this._trx+=t,this._try+=e,this._brx+=t,this._bry+=e,this._blx+=t,this._bly+=e}round(){this._tlx=Math.round(this._tlx),this._tly=Math.round(this._tly),this._trx=Math.round(this._trx),this._try=Math.round(this._try),this._brx=Math.round(this._brx),this._bry=Math.round(this._bry),this._blx=Math.round(this._blx),this._bly=Math.round(this._bly)}floor(){this._tlx=Math.floor(this._tlx),this._tly=Math.floor(this._tly),this._trx=Math.floor(this._trx),this._try=Math.floor(this._try),this._brx=Math.floor(this._brx),this._bry=Math.floor(this._bry),this._blx=Math.floor(this._blx),this._bly=Math.floor(this._bly)}ceil(){this._tlx=Math.ceil(this._tlx),this._tly=Math.ceil(this._tly),this._trx=Math.ceil(this._trx),this._try=Math.ceil(this._try),this._brx=Math.ceil(this._brx),this._bry=Math.ceil(this._bry),this._blx=Math.ceil(this._blx),this._bly=Math.ceil(this._bly)}setFromRect(t){this._tlx=t._left,this._tly=t._top,this._trx=t._right,this._try=t._top,this._brx=t._right,this._bry=t._bottom,this._blx=t._left,this._bly=t._bottom}setFromRotatedRect(t,e){0===e?this.setFromRect(t):this.setFromRotatedRectPrecalc(t,Math.sin(e),Math.cos(e))}setFromRotatedRectPrecalc(t,e,s){const i=t._left*e,r=t._top*e,n=t._right*e,a=t._bottom*e,o=t._left*s,h=t._top*s,l=t._right*s,c=t._bottom*s;this._tlx=o-r,this._tly=h+i,this._trx=l-r,this._try=h+n,this._brx=l-a,this._bry=c+n,this._blx=o-a,this._bly=c+i}getBoundingBox(t){t.set(Math.min(this._tlx,this._trx,this._brx,this._blx),Math.min(this._tly,this._try,this._bry,this._bly),Math.max(this._tlx,this._trx,this._brx,this._blx),Math.max(this._tly,this._try,this._bry,this._bly))}containsPoint(t,e){let s=this._trx-this._tlx,i=this._try-this._tly;const r=this._brx-this._tlx,n=this._bry-this._tly,a=t-this._tlx,o=e-this._tly;let h=s*s+i*i,l=s*r+i*n,c=s*a+i*o;const u=r*r+n*n,_=r*a+n*o;let d=1/(h*u-l*l),p=(u*c-l*_)*d,f=(h*_-l*c)*d;return p>=0&&f>0&&p+f<1||(s=this._blx-this._tlx,i=this._bly-this._tly,h=s*s+i*i,l=s*r+i*n,c=s*a+i*o,d=1/(h*u-l*l),p=(u*c-l*_)*d,f=(h*_-l*c)*d,p>=0&&f>0&&p+f<1)}midX(){return(this._tlx+this._trx+this._brx+this._blx)/4}midY(){return(this._tly+this._try+this._bry+this._bly)/4}intersectsSegment(t,e,s,i){return!(!this.containsPoint(t,e)&&!this.containsPoint(s,i))||dh.segmentIntersectsQuad(t,e,s,i,this)}intersectsQuad(t){let e=t.midX(),s=t.midY();if(this.containsPoint(e,s))return!0;if(e=this.midX(),s=this.midY(),t.containsPoint(e,s))return!0;const i=this._tlx,r=this._tly,n=this._trx,a=this._try,o=this._brx,h=this._bry,l=this._blx,c=this._bly;return dh.segmentIntersectsQuad(i,r,n,a,t)||dh.segmentIntersectsQuad(n,a,o,h,t)||dh.segmentIntersectsQuad(o,h,l,c,t)||dh.segmentIntersectsQuad(l,c,i,r,t)}rotatePointsAnticlockwise(){const t=this._tlx,e=this._tly;this._tlx=this._trx,this._tly=this._try,this._trx=this._brx,this._try=this._bry,this._brx=this._blx,this._bry=this._bly,this._blx=t,this._bly=e}mirror(){this._swap(0,2),this._swap(1,3),this._swap(6,4),this._swap(7,5)}flip(){this._swap(0,6),this._swap(1,7),this._swap(2,4),this._swap(3,5)}diag(){this._swap(2,6),this._swap(3,7)}_swap(t,e){const s=this._getAtIndex(t);this._setAtIndex(t,this._getAtIndex(e)),this._setAtIndex(e,s)}_getAtIndex(t){switch(t){case 0:return this._tlx;case 1:return this._tly;case 2:return this._trx;case 3:return this._try;case 4:return this._brx;case 5:return this._bry;case 6:return this._blx;case 7:return this._bly;default:throw new RangeError("invalid quad point index")}}_setAtIndex(t,e){switch(e=+e,t){case 0:this._tlx=e;break;case 1:this._tly=e;break;case 2:this._trx=e;break;case 3:this._try=e;break;case 4:this._brx=e;break;case 5:this._bry=e;break;case 6:this._blx=e;break;case 7:this._bly=e;break;default:throw new RangeError("invalid quad point index")}}divide(t,e){this._tlx/=t,this._tly/=e,this._trx/=t,this._try/=e,this._brx/=t,this._bry/=e,this._blx/=t,this._bly/=e}}}{const ph=self.C3,fh=(self.assert,[0,0,1,0,1,1,0,1]),gh=ph.New(ph.Quad);ph.CollisionPoly=class extends ph.DefendedBase{constructor(t,e=!0){super(),t||(t=fh),this._ptsArr=Float64Array.from(t),this._bbox=new ph.Rect,this._isBboxChanged=!0,this._enabled=e}Release(){}pointsArr(){return this._ptsArr}pointCount(){return this._ptsArr.length/2}setPoints(t){this._ptsArr.length===t.length?this._ptsArr.set(t):this._ptsArr=Float64Array.from(t),this._isBboxChanged=!0}setDefaultPoints(){this.setPoints(fh)}copy(t){this.setPoints(t._ptsArr)}setBboxChanged(){this._isBboxChanged=!0}_updateBbox(){if(!this._isBboxChanged)return;const t=this._ptsArr;let e=t[0],s=t[1],i=e,r=s;for(let n=0,a=t.length;n<a;n+=2){const a=t[n],o=t[n+1];a<e&&(e=a),a>i&&(i=a),o<s&&(s=o),o>r&&(r=o)}this._bbox.set(e,s,i,r),this._isBboxChanged=!1}setFromRect(t,e,s){let i=this._ptsArr;8!==i.length&&(i=new Float64Array(8),this._ptsArr=i),i[0]=t.getLeft()-e,i[1]=t.getTop()-s,i[2]=t.getRight()-e,i[3]=t.getTop()-s,i[4]=t.getRight()-e,i[5]=t.getBottom()-s,i[6]=t.getLeft()-e,i[7]=t.getBottom()-s,this._bbox.copy(t),0===e&&0===s||this._bbox.offset(-e,-s),this._isBboxChanged=!1}setFromQuad(t,e,s){gh.copy(t),gh.offset(e,s),this.setPoints(gh.toArray()),this._isBboxChanged=!0}transform(t,e,s){let i=0,r=1;0!==s&&(i=Math.sin(s),r=Math.cos(s)),this.transformPrecalc(t,e,i,r)}transformPrecalc(t,e,s,i){const r=this._ptsArr;for(let n=0,a=r.length;n<a;n+=2){const a=n+1,o=r[n]*t,h=r[a]*e;r[n]=o*i-h*s,r[a]=h*i+o*s}this._isBboxChanged=!0}offset(t,e){const s=this._ptsArr;for(let i=0,r=s.length;i<r;i+=2)s[i]+=t,s[i+1]+=e}containsPoint(t,e){const s=this._ptsArr;if(t===s[0]&&e===s[1])return!0;this._updateBbox();const i=this._bbox,r=i.getLeft()-110,n=i.getTop()-101,a=i.getRight()+131,o=i.getBottom()+120;let h=0,l=0,c=0,u=0,_=0,d=0,p=0,f=0;r<t?(h=r,c=t):(h=t,c=r),n<e?(l=n,u=e):(l=e,u=n),a<t?(_=a,p=t):(_=t,p=a),o<e?(d=o,f=e):(d=e,f=o);let g=0,m=0;for(let i=0,S=s.length;i<S;i+=2){const y=(i+2)%S,G=s[i],T=s[i+1],I=s[y],C=s[y+1];ph.segmentsIntersectPreCalc(r,n,t,e,h,c,l,u,G,T,I,C)&&++g,ph.segmentsIntersectPreCalc(a,o,t,e,_,p,d,f,G,T,I,C)&&++m}return g%2==1||m%2==1}intersectsPoly(t,e,s){const i=t._ptsArr,r=this._ptsArr;if(this.containsPoint(i[0]+e,i[1]+s))return!0;if(t.containsPoint(r[0]-e,r[1]-s))return!0;for(let t=0,n=r.length;t<n;t+=2){const a=(t+2)%n,o=r[t],h=r[t+1],l=r[a],c=r[a+1];let u=0,_=0,d=0,p=0;o<l?(u=o,d=l):(u=l,d=o),h<c?(_=h,p=c):(_=c,p=h);for(let t=0,r=i.length;t<r;t+=2){const n=(t+2)%r,a=i[t]+e,f=i[t+1]+s,g=i[n]+e,m=i[n+1]+s;if(ph.segmentsIntersectPreCalc(o,h,l,c,u,d,_,p,a,f,g,m))return!0}}return!1}intersectsSegment(t,e,s,i,r,n){if(this.containsPoint(s-t,i-e))return!0;if(this.containsPoint(r-t,n-e))return!0;let a=0,o=0,h=0,l=0;s<r?(a=s,h=r):(a=r,h=s),i<n?(o=i,l=n):(o=n,l=i);const c=this._ptsArr;for(let u=0,_=c.length;u<_;u+=2){const d=(u+2)%_,p=c[u]+t,f=c[u+1]+e,g=c[d]+t,m=c[d+1]+e;if(ph.segmentsIntersectPreCalc(s,i,r,n,a,h,o,l,p,f,g,m))return!0}return!1}mirror(t){const e=this._ptsArr;for(let s=0,i=e.length;s<i;s+=2)e[s]=2*t-e[s];this._isBboxChanged=!0}flip(t){const e=this._ptsArr;for(let s=0,i=e.length;s<i;s+=2){const i=s+1;e[i]=2*t-e[i]}this._isBboxChanged=!0}diag(){const t=this._ptsArr;for(let e=0,s=t.length;e<s;e+=2){const s=e+1,i=t[e];t[e]=t[s],t[s]=i}this._isBboxChanged=!0}GetMidX(){const t=this._ptsArr;let e=0;for(let s=0,i=t.length;s<i;s+=2)e+=t[s];return e/this.pointCount()}GetMidY(){const t=this._ptsArr;let e=0;for(let s=0,i=t.length;s<i;s+=2)e+=t[s+1];return e/this.pointCount()}GetPointsArray(){return this._ptsArr}GetPointCount(){return this.pointCount()}IsEnabled(){return this._enabled}}}{const mh=self.C3;mh.PairMap=class extends mh.DefendedBase{constructor(t){if(super(),this._firstMap=new Map,t)for(const[e,s,i]of t)this.Set(e,s,i)}Release(){this.Clear(),this._firstMap=null}IsEmpty(){return 0===this._firstMap.size}Clear(){const t=this._firstMap;for(const e of t.values())e.clear();t.clear()}Set(t,e,s){const i=this._firstMap;let r=i.get(t);r||(r=new Map,i.set(t,r)),r.set(e,s)}Get(t,e){const s=this._firstMap.get(t);return s?s.get(e):s}Has(t,e){const s=this._firstMap.get(t);return!!s&&s.has(e)}Delete(t,e){const s=this._firstMap,i=s.get(t);if(!i)return!1;const r=i.delete(e);return r&&0===i.size&&s.delete(t),r}DeleteEither(t){const e=this._firstMap,s=e.get(t);s&&(s.clear(),e.delete(t));for(const[s,i]of e.entries())i.delete(t)&&0===i.size&&e.delete(s)}GetSize(){let t=0;for(const e of this._firstMap.values())t+=e.size;return t}*values(){for(const t of this._firstMap.values())yield*t.values()}*keyPairs(){for(const[t,e]of this._firstMap.entries())for(const s of e.keys())yield[t,s]}*entries(){for(const[t,e]of this._firstMap.entries())for(const[s,i]of e.entries())yield[t,s,i]}}}{const Sh=self.C3;Sh.ArraySet=class extends Sh.DefendedBase{constructor(){super(),this._set=new Set,this._arr=[],this._needToRebuildArray=!1}Release(){this.Clear()}Clear(){this._set.clear(),Sh.clearArray(this._arr),this._needToRebuildArray=!1}Add(t){this._set.has(t)||(this._set.add(t),this._needToRebuildArray||this._arr.push(t))}Has(t){return this._set.has(t)}Delete(t){this._set.delete(t)&&(this._needToRebuildArray=!0)}GetSize(){return this._set.size}IsEmpty(){return 0===this._set.size}GetArray(){return this._needToRebuildArray&&(this._RebuildArray(),this._needToRebuildArray=!1),this._arr}_RebuildArray(){const t=this._arr;Sh.clearArray(t);for(const e of this._set)t.push(e)}}}{const yh=self.C3,Gh=new Map,Th=new Map,Ih=new Map,Ch=new Map,bh=new Map,xh=new Map,wh=new Map,Mh=new Map,Ph=new Map;Ph.set("linear","noease"),Ph.set("default","noease");const vh=["default","noease","easeinquad","easeoutquad","easeinoutquad","easeincubic","easeoutcubic","easeinoutcubic","easeinquart","easeoutquart","easeinoutquart","easeinquint","easeoutquint","easeinoutquint","easeinsine","easeoutsine","easeinoutsine","easeinexpo","easeoutexpo","easeinoutexpo","easeincirc","easeoutcirc","easeinoutcirc","easeinelastic","easeoutelastic","easeinoutelastic","easeinback","easeoutback","easeinoutback","easeinbounce","easeoutbounce","easeinoutbounce"],Rh=["default","noease","quad","cubic","quart","quint","sine","expo","circ","elastic","back","bounce"],Ah=new Map([["linear","noease"],["in-sine","easeinsine"],["out-sine","easeoutsine"],["in-out-sine","easeinoutsine"],["in-elastic","easeinelastic"],["out-elastic","easeoutelastic"],["in-out-elastic","easeinoutelastic"],["in-back","easeinback"],["out-back","easeoutback"],["in-out-back","easeinoutback"],["in-bounce","easeinbounce"],["out-bounce","easeoutbounce"],["in-out-bounce","easeinoutbounce"],["in-cubic","easeincubic"],["out-cubic","easeoutcubic"],["in-out-cubic","easeinoutcubic"],["in-quadratic","easeinquad"],["out-quadratic","easeoutquad"],["in-out-quadratic","easeinoutquad"],["in-quartic","easeinquart"],["out-quartic","easeoutquart"],["in-out-quartic","easeinoutquart"],["in-quintic","easeinquint"],["out-quintic","easeoutquint"],["in-out-quintic","easeinoutquint"],["in-circular","easeincirc"],["out-circular","easeoutcirc"],["in-out-circular","easeinoutcirc"],["in-exponential","easeinexpo"],["out-exponential","easeoutexpo"],["in-out-exponential","easeinoutexpo"]]);self.Ease=class t{constructor(){}static InheritEase(){return"default"}static DefaultEase(){return"noease"}static ToInternal(t){return Ah.get(t)}static GetEditorEaseNames(e,...s){let i,r;this._CreateEaseMap(),e?(Ih.has(e)||Ih.set(e,new Map),i=Ih.get(e),r=[...i.keys()].filter(s=>!t.GetEditorEaseData(s,e)||t.GetEditorEaseData(s,e).transition.IsForAnyPurpose())):(i=bh,r=[...i.keys()]);const n=r.sort();return[...Th.keys()].concat(n).filter(t=>!s.includes(t))}static GetRuntimeEaseNames(){this._CreateEaseMap();const t=[...bh.keys()];return t.sort(),[...Th.keys()].concat(t)}static GetCustomRuntimeEaseNames(){this._CreateEaseMap();const t=[...bh.keys()];return t.sort(),t}static IsPredefinedTranslatedName(t){for(const e of vh)if(self.lang(`ui.bars.timeline.eases.${e}`)===t)return!0;for(const e of Rh)if(self.lang(`ui.bars.timeline.short-eases.${e}`)===t)return!0}static IsNamePredefined(t){return this._CreateEaseMap(),[...Th.keys()].includes(t)}static _GetEase(e){const s=Ph.get(e);return s?Gh.get(s):t.IsNamePredefined(e)?Gh.get(e):wh.has(e)?wh.get(e):void 0}static GetBuiltInTransition(t){return this._CreateEaseMap(),Mh.get(t)}static GetEditorEase(e,s){this._CreateEaseMap();const i=t._GetEase(e);if(i)return i;if(!s)throw new Error("missing ease function");return Ih.get(s).get(e)}static GetEditorEaseData(t,e){this._CreateEaseMap();const s=Ch.get(e);if(s)return s.get(t)}static HasEditorEase(e,s){return this._CreateEaseMap(),!!t._GetEase(e)||!!Ih.get(s).get(e)}static GetRuntimeEase(e){this._CreateEaseMap();return t._GetEase(e)||bh.get(e)}static GetRuntimeEaseData(t){return this._CreateEaseMap(),xh.get(t)}static GetEaseFromIndex(t){return this._CreateEaseMap(),this.GetRuntimeEaseNames()[t]}static GetIndexForEase(t,e){return this._CreateEaseMap(),this.GetEditorEaseNames(e).indexOf(t)}static GetIndexForEaseAtRuntime(t){return this.GetIndexForEase(t)}static _CreateEaseMap(){0===Gh.size&&(this._AddPredifinedEase("default",()=>{}),this._AddPredifinedEase("noease",[{x:0,y:0,sax:.336,say:0,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.336,eay:0,se:!1,ee:!0}],!0),this._AddPredifinedEase("easeinsine",[{x:0,y:0,sax:.485,say:0,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.038,eay:0,se:!1,ee:!0}]),this._AddPredifinedEase("easeoutsine",[{x:0,y:0,sax:.038,say:0,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.485,eay:0,se:!1,ee:!0}]),this._AddPredifinedEase("easeinoutsine",[{x:0,y:0,sax:.336,say:0,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.336,eay:0,se:!1,ee:!0}]),this._AddPredifinedEase("easeinelastic",[{x:0,y:0,sax:.018,say:0,eax:0,eay:0,se:!0,ee:!1},{x:.116,y:.002,sax:.025,say:0,eax:-.025,eay:0,se:!0,ee:!0},{x:.266,y:-.005,sax:.024,say:0,eax:-.021,eay:0,se:!0,ee:!0},{x:.416,y:.016,sax:.024,say:0,eax:-.026,eay:0,se:!0,ee:!0},{x:.566,y:-.045,sax:.061,say:0,eax:-.025,eay:0,se:!0,ee:!0},{x:.716,y:.132,sax:.072,say:-.004,eax:-.045,eay:0,se:!0,ee:!0},{x:.866,y:-.373,sax:.06,say:0,eax:-.049,eay:-.002,se:!0,ee:!0},{x:1,y:1,sax:0,say:0,eax:-.038,eay:-.263,se:!1,ee:!0}]),this._AddPredifinedEase("easeoutelastic",[{x:0,y:0,sax:.038,say:.263,eax:0,eay:0,se:!0,ee:!1},{x:.136,y:1.373,sax:.049,say:.002,eax:-.06,eay:0,se:!0,ee:!0},{x:.286,y:.868,sax:.045,say:0,eax:-.072,eay:.004,se:!0,ee:!0},{x:.436,y:1.045,sax:.025,say:0,eax:-.061,eay:0,se:!0,ee:!0},{x:.586,y:.984,sax:.026,say:0,eax:-.024,eay:0,se:!0,ee:!0},{x:.736,y:1.005,sax:.021,say:0,eax:-.024,eay:0,se:!0,ee:!0},{x:.886,y:.998,sax:.025,say:0,eax:-.025,eay:0,se:!0,ee:!0},{x:1,y:1,sax:0,say:0,eax:-.018,eay:0,se:!1,ee:!0}]),this._AddPredifinedEase("easeinoutelastic",[{x:0,y:0,sax:.025,say:0,eax:0,eay:0,se:!0,ee:!1},{x:.067,y:.001,sax:.025,say:0,eax:-.025,eay:0,se:!0,ee:!0},{x:.18,y:-.005,sax:.025,say:0,eax:-.025,eay:0,se:!0,ee:!0},{x:.292,y:.025,sax:.053,say:0,eax:-.025,eay:0,se:!0,ee:!0},{x:.405,y:-.118,sax:.069,say:0,eax:-.027,eay:0,se:!0,ee:!0},{x:.597,y:1.118,sax:.027,say:0,eax:-.069,eay:0,se:!0,ee:!0},{x:.71,y:.975,sax:.025,say:0,eax:-.053,eay:0,se:!0,ee:!0},{x:.822,y:1.005,sax:.025,say:0,eax:-.025,eay:0,se:!0,ee:!0},{x:.935,y:.999,sax:.025,say:0,eax:-.025,eay:0,se:!0,ee:!0},{x:1,y:1,sax:0,say:0,eax:-.025,eay:0,se:!1,ee:!0}]),this._AddPredifinedEase("easeinback",[{x:0,y:0,sax:.35,say:0,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.34,eay:-1.579,se:!1,ee:!0}]),this._AddPredifinedEase("easeoutback",[{x:0,y:0,sax:.34,say:1.579,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.35,eay:0,se:!1,ee:!0}]),this._AddPredifinedEase("easeinoutback",[{x:0,y:0,sax:.035,say:0,eax:0,eay:0,se:!0,ee:!1},{x:.242,y:-.1,sax:.258,say:0,eax:-.025,eay:0,se:!0,ee:!0},{x:.76,y:1.1,sax:.025,say:0,eax:-.26,eay:0,se:!0,ee:!0},{x:1,y:1,sax:0,say:0,eax:-.035,eay:0,se:!1,ee:!0}]),this._AddPredifinedEase("easeinbounce",[{x:0,y:0,sax:.033,say:.025,eax:0,eay:0,se:!0,ee:!1},{x:.092,y:0,sax:.026,say:.078,eax:-.033,eay:.025,se:!0,ee:!0},{x:.274,y:0,sax:.097,say:.319,eax:-.026,eay:.078,se:!0,ee:!0},{x:.637,y:0,sax:.105,say:.625,eax:-.097,eay:.319,se:!0,ee:!0},{x:1,y:1,sax:0,say:0,eax:-.125,eay:-.004,se:!1,ee:!0}]),this._AddPredifinedEase("easeoutbounce",[{x:0,y:0,sax:.125,say:.004,eax:0,eay:0,se:!0,ee:!1},{x:.365,y:1,sax:.097,say:-.319,eax:-.105,eay:-.625,se:!0,ee:!0},{x:.728,y:1,sax:.026,say:-.078,eax:-.097,eay:-.319,se:!0,ee:!0},{x:.91,y:1,sax:.033,say:-.025,eax:-.026,eay:-.078,se:!0,ee:!0},{x:1,y:1,sax:0,say:0,eax:-.033,eay:-.025,se:!1,ee:!0}]),this._AddPredifinedEase("easeinoutbounce",[{x:0,y:0,sax:.01,say:.006,eax:0,eay:0,se:!0,ee:!1},{x:.046,y:0,sax:.021,say:.038,eax:-.01,eay:.006,se:!0,ee:!0},{x:.137,y:0,sax:.059,say:.158,eax:-.021,eay:.038,se:!0,ee:!0},{x:.319,y:0,sax:.117,say:.744,eax:-.059,eay:.158,se:!0,ee:!0},{x:.683,y:1,sax:.059,say:-.158,eax:-.117,eay:-.744,se:!0,ee:!0},{x:.865,y:1,sax:.021,say:-.038,eax:-.059,eay:-.158,se:!0,ee:!0},{x:.956,y:1,sax:.01,say:-.006,eax:-.021,eay:-.038,se:!0,ee:!0},{x:1,y:1,sax:0,say:0,eax:-.01,eay:-.006,se:!1,ee:!0}]),this._AddPredifinedEase("easeincubic",[{x:0,y:0,sax:.75,say:0,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.138,eay:-.321,se:!1,ee:!0}]),this._AddPredifinedEase("easeoutcubic",[{x:0,y:0,sax:.138,say:.321,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.75,eay:0,se:!1,ee:!0}]),this._AddPredifinedEase("easeinoutcubic",[{x:0,y:0,sax:.285,say:0,eax:0,eay:0,se:!0,ee:!1},{x:.5,y:.5,sax:.081,say:.272,eax:-.081,eay:-.272,se:!0,ee:!0},{x:1,y:1,sax:0,say:0,eax:-.285,eay:0,se:!1,ee:!0}]),this._AddPredifinedEase("easeinquad",[{x:0,y:0,sax:.4,say:0,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.178,eay:-.392,se:!1,ee:!0}]),this._AddPredifinedEase("easeoutquad",[{x:0,y:0,sax:.178,say:.392,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.4,eay:0,se:!1,ee:!0}]),this._AddPredifinedEase("easeinoutquad",[{x:0,y:0,sax:.25,say:0,eax:0,eay:0,se:!0,ee:!1},{x:.5,y:.5,sax:.03,say:.065,eax:-.03,eay:-.065,se:!0,ee:!0},{x:1,y:1,sax:0,say:0,eax:-.25,eay:0,se:!1,ee:!0}]),this._AddPredifinedEase("easeinquart",[{x:0,y:0,sax:.5,say:0,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.25,eay:-1,se:!1,ee:!0}]),this._AddPredifinedEase("easeoutquart",[{x:0,y:0,sax:.25,say:1,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.5,eay:0,se:!1,ee:!0}]),this._AddPredifinedEase("easeinoutquart",[{x:0,y:0,sax:.765,say:.03,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.765,eay:-.03,se:!1,ee:!0}]),this._AddPredifinedEase("easeinquint",[{x:0,y:0,sax:.6,say:0,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.2,eay:-1,se:!1,ee:!0}]),this._AddPredifinedEase("easeoutquint",[{x:0,y:0,sax:.2,say:1,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.6,eay:0,se:!1,ee:!0}]),this._AddPredifinedEase("easeinoutquint",[{eax:0,eay:0,ee:!1,sax:.84,say:0,se:!0,x:0,y:0},{eax:-.84,eay:0,ee:!0,sax:0,say:0,se:!1,x:1,y:1}]),this._AddPredifinedEase("easeincirc",[{x:0,y:0,sax:.25,say:0,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.024,eay:-.808,se:!1,ee:!0}]),this._AddPredifinedEase("easeoutcirc",[{x:0,y:0,sax:.024,say:.808,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.25,eay:0,se:!1,ee:!0}]),this._AddPredifinedEase("easeinoutcirc",[{x:0,y:0,sax:.125,say:0,eax:0,eay:0,se:!0,ee:!1},{x:.5,y:.5,sax:.02,say:.428,eax:-.02,eay:-.428,se:!0,ee:!0},{x:1,y:1,sax:0,say:0,eax:-.125,eay:0,se:!1,ee:!0}]),this._AddPredifinedEase("easeinexpo",[{x:0,y:0,sax:.66,say:0,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.14,eay:-1,se:!1,ee:!0}]),this._AddPredifinedEase("easeoutexpo",[{x:0,y:0,sax:.14,say:1,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.66,eay:0,se:!1,ee:!0}]),this._AddPredifinedEase("easeinoutexpo",[{eax:0,eay:0,ee:!1,sax:.345,say:0,se:!0,x:0,y:0},{eax:-.06,eay:-.5,ee:!0,sax:.06,say:.5,se:!0,x:.5,y:.5},{eax:-.335,eay:0,ee:!0,sax:0,say:0,se:!1,x:1,y:1}]),this._AddPrivateCustomEase("cubicbezier",this.EaseCubicBezier),this._AddPrivateCustomEase("spline",this.EaseSpline))}static _AddPredifinedEase(e,s,i=!1){if("function"==typeof s)t._AddEase(e,s,"predefined");else{if(!yh.IsArray(s))throw new Error("unexpected arguments");if(self.BuiltInTransition){const r=yh.New(self.BuiltInTransition,e,i);r.SetFromJson(s),t._AddEase(e,(t,e,s,i)=>r.Interpolate(t,e,s,i),"predefined"),Mh.set(e,r)}else{const r=yh.New(yh.Transition,[e,s.map(t=>[t.x,t.y,t.sax,t.say,t.eax,t.eay,t.se,t.ee])],!1);r.MakeLinear(i),t._AddEase(e,(t,e,s,i)=>r.Interpolate(t,e,s,i),"predefined")}}}static _AddPrivateCustomEase(e,s){t._AddEase(e,s,"private")}static AddCustomEase(e,s,i,r){this._CreateEaseMap(),t._AddEase(e,s,"custom",i,r)}static RemoveCustomEase(t,e){if(this.IsNamePredefined(t))return;if([...wh.keys()].includes(t))return;const s=Ih.get(e);s&&s.delete(t);const i=Ch.get(e);i&&i.delete(t)}static _AddEase(t,e,s,i,r){switch(s){case"predefined":Gh.set(t,e),Th.set(t,e);break;case"custom":i?(Ih.has(i)||Ih.set(i,new Map),Ch.has(i)||Ch.set(i,new Map),Ih.get(i).set(t,e),Ch.get(i).set(t,r)):(bh.set(t,e),xh.set(t,r));break;case"private":Gh.set(t,e),wh.set(t,e);break;default:throw new Error("unexpected ease mode")}}static NoEase(t,e,s,i){return 0===i?e:s*t/i+e}static EaseCubicBezier(t,e,s,i,r){return e+3*t*(s-e)+3*t**2*(e+i-2*s)+t**3*(r-e+3*s-3*i)}static EaseSpline(t,e,s,i,r,n,a,o,h,l){if(i===r&&n===a)return t;const c=Nh(t,e,i,n,o,l),u=Fh(s,r,a,h),_=Oh(s,r,a,h),d=Bh(s,r,a,h);return Lh(c,u,_,d)}static GetBezierSamples(t,e,s,i){const r=[],n=Fh(t,e,s,i),a=Oh(t,e,s,i),o=Bh(t,e,s,i);for(let t=0;t<Dh;++t){const e=Lh(t*Eh,n,a,o);r.push(e)}return r}};const Dh=11,Eh=1/(Dh-1),Fh=(t,e,s,i)=>i-3*s+3*e-t,Oh=(t,e,s,i)=>3*s-6*e+3*t,Bh=(t,e,s,i)=>3*(e-t),Lh=(t,e,s,i)=>((e*t+s)*t+i)*t,kh=(t,e,s,i)=>3*e*t*t+2*s*t+i,Nh=(t,e,s,i,r,n)=>{if(1==t)return 1;let a=0,o=1,h=n[o],l=Dh-1;for(n[Dh-1];o!=l&&h<=t;)o++,h=n[o],a+=Eh;o--,h=n[o];let c=a+(t-h)/(n[o+1]-h)*Eh;const u=Fh(e,s,i,r),_=Oh(e,s,i,r),d=Bh(e,s,i,r),p=kh(c,u,_,d);if(0===p)return c;if(p>=.01){for(let e=0;e<4;++e)c-=(Lh(c,u,_,d)-t)/kh(c,u,_,d);return c}{let e,s,i=a,r=a+Eh,n=0;do{c=i+(r-i)/2;let a=Lh(c,u,_,d)-t;a>0?r=c:i=c,e=Math.abs(a)>1e-7,s=++n<10}while(e&&s);return c}}}{let Uh=function(t){Wh.IsString(t)};0;const Wh=self.C3;Wh.ProbabilityTable=class{constructor(t){this._items=[],this._name=t||"",this._totalWeight=0}Release(){this.Clear(),this._items=null}GetName(){return this._name}Clear(){Wh.clear2DArray(this._items),this._totalWeight=0}GetTotalWeight(){return this._totalWeight}Sample(t=Math.random()*this.GetTotalWeight()){let e=0;for(const[s,i]of this._items)if(e+=s,t<e)return i;return 0}HasItems(){return!!this._items.length}AddItem(t,e){Uh(e),this._totalWeight+=t,this._items.push([t,e])}RemoveItem(t,e){Uh(e);const s=0===t;for(let i=0;i<this._items.length;i++){const r=this._items[i],n=s||r[0]===t,a=r[1]===e;if(n&&a){this._items.splice(i,1),this._totalWeight-=r[0];break}}}asJSON(){return JSON.stringify(this._items)}static fromJSON(t,e){const s=new Wh.ProbabilityTable(e),i=JSON.parse(t);for(const t of i){const e=t[0],i=t[1];s.AddItem(e,i)}return s}}}{const jh=self.C3;let Vh=0;jh.ScreenReaderText=class{constructor(t,e){this._runtime=t,this._text=e,this._id=Vh++,this._runtime.PostComponentMessageToDOM("runtime","screen-reader-text",{type:"create",id:this._id,text:this._text})}Release(){this._runtime.PostComponentMessageToDOM("runtime","screen-reader-text",{type:"release",id:this._id}),this._runtime=null,this._text="",this._id=-1}SetText(t){this._text!==t&&(this._text=t,this._runtime.PostComponentMessageToDOM("runtime","screen-reader-text",{type:"update",id:this._id,text:this._text}))}}}self.C3.Event=class{constructor(t,e){this.type=t,this.cancelable=!!e,this.defaultPrevented=!1,this.propagationStopped=!1,this.isAsync=!1}preventDefault(){if(!this.cancelable)throw new Error(`event '${this.type}' is not cancelable`);this.defaultPrevented=!0}stopPropagation(){if(!this.cancelable)throw new Error(`event '${this.type}' cannot be stopped`);if(this.isAsync)throw new Error(`cannot stop async event '${this.type}' propagation`);this.propagationStopped=!0}};{const zh=self.C3;self.assert;zh.Event.Handler=class extends zh.DefendedBase{constructor(t){super(),this._type=t,this._captureListeners=[],this._captureListenersSet=new Set,this._listeners=[],this._listenersSet=new Set,this._fireDepth=0,this._queueModifyListeners=[]}Release(){this._fireDepth>0||(zh.clearArray(this._captureListeners),this._captureListenersSet.clear(),zh.clearArray(this._listeners),this._listenersSet.clear(),zh.clearArray(this._queueModifyListeners),zh.Release(this))}_AddListener(t,e){if(this._IsFiring())this._queueModifyListeners.push({op:"add",func:t,capture:e});else if(e){if(this._captureListenersSet.has(t))return;this._captureListeners.push(t),this._captureListenersSet.add(t)}else{if(this._listenersSet.has(t))return;this._listeners.push(t),this._listenersSet.add(t)}}_RemoveListener(t,e){this._IsFiring()?this._queueModifyListeners.push({op:"remove",func:t,capture:e}):e?this._captureListenersSet.has(t)&&(this._captureListenersSet.delete(t),zh.arrayFindRemove(this._captureListeners,t)):this._listenersSet.has(t)&&(this._listenersSet.delete(t),zh.arrayFindRemove(this._listeners,t))}_IsEmpty(){return!this._captureListeners.length&&!this._listeners.length}_IsFiring(){return this._fireDepth>0}_ProcessQueuedListeners(){const t=new Set,e=new Set;for(const s of this._queueModifyListeners)if("add"===s.op)this._AddListener(s.func,s.capture),s.capture?e.delete(s.func):t.delete(s.func);else{if("remove"!==s.op)throw new Error("invalid op");s.capture?(this._captureListenersSet.delete(s.func),e.add(s.func)):(this._listenersSet.delete(s.func),t.add(s.func))}zh.arrayRemoveAllInSet(this._listeners,t),zh.arrayRemoveAllInSet(this._captureListeners,e),zh.clearArray(this._queueModifyListeners)}_FireCancellable(t){this._IncreaseFireDepth();let e=!1;for(let s=0,i=this._captureListeners.length;s<i;++s)if(this._captureListeners[s](t),t.propagationStopped){e=!0;break}if(!e)for(let e=0,s=this._listeners.length;e<s&&(this._listeners[e](t),!t.propagationStopped);++e);return this._DecreaseFireDepth(),!t.defaultPrevented}_FireNonCancellable(t){this._IncreaseFireDepth();for(let e=0,s=this._captureListeners.length;e<s;++e)this._captureListeners[e](t);for(let e=0,s=this._listeners.length;e<s;++e)this._listeners[e](t);return this._DecreaseFireDepth(),!0}_IncreaseFireDepth(){this._fireDepth++}_DecreaseFireDepth(){this._fireDepth--,0===this._fireDepth&&this._queueModifyListeners.length>0&&this._ProcessQueuedListeners()}SetDelayRemoveEventsEnabled(t){t?this._IncreaseFireDepth():this._DecreaseFireDepth()}_FireAsync(t){let e=[];for(let s=0,i=this._captureListeners.length;s<i;++s){let i=this._captureListeners[s];e.push(zh.Asyncify(()=>i(t)))}for(let s=0,i=this._listeners.length;s<i;++s){let i=this._listeners[s];e.push(zh.Asyncify(()=>i(t)))}return Promise.all(e).then(()=>!t.defaultPrevented)}_FireAndWait_AsyncOptional(t){const e=[];this._IncreaseFireDepth();for(let s=0,i=this._captureListeners.length;s<i;++s){const i=this._captureListeners[s](t);i instanceof Promise&&e.push(i)}for(let s=0,i=this._listeners.length;s<i;++s){const i=this._listeners[s](t);i instanceof Promise&&e.push(i)}return this._DecreaseFireDepth(),e.length?Promise.all(e).then(()=>!t.defaultPrevented):!t.defaultPrevented}async _FireAndWaitAsync(t){return await this._FireAndWait_AsyncOptional(t)}async _FireAndWaitAsyncSequential(t){this._IncreaseFireDepth();for(let e=0,s=this._captureListeners.length;e<s;++e){const s=this._captureListeners[e](t);s instanceof Promise&&await s}for(let e=0,s=this._listeners.length;e<s;++e){const s=this._listeners[e](t);s instanceof Promise&&await s}return this._DecreaseFireDepth(),!t.defaultPrevented}*_FireAsGenerator(t){this._IncreaseFireDepth();for(let e=0,s=this._captureListeners.length;e<s;++e){const s=this._captureListeners[e](t);zh.IsIterator(s)&&(yield*s)}for(let e=0,s=this._listeners.length;e<s;++e){const s=this._listeners[e](t);zh.IsIterator(s)&&(yield*s)}this._DecreaseFireDepth()}}}{const Hh=self.C3;Hh.Event.Dispatcher=class extends Hh.DefendedBase{constructor(){super(),this._eventHandlers=new Map,this._dispatcherWasReleased=!1}Release(){if(this._dispatcherWasReleased)throw new Error("already released");this.ClearEvents(),this._dispatcherWasReleased=!0,Hh.Release(this)}WasReleased(){return this._dispatcherWasReleased}ClearEvents(){if(this._eventHandlers){for(let t of this._eventHandlers.values())t.Release();this._eventHandlers.clear()}}_GetHandlerByType(t,e){let s=this._eventHandlers.get(t);return s||(e?(s=Hh.New(Hh.Event.Handler,t),this._eventHandlers.set(t,s),s):null)}HasAnyHandlerFor(t){return this._eventHandlers.has(t)}addEventListener(t,e,s){this._GetHandlerByType(t,!0)._AddListener(e,!!s)}removeEventListener(t,e,s){let i=this._GetHandlerByType(t,!1);i&&(i._RemoveListener(e,!!s),i._IsEmpty()&&this._eventHandlers.delete(t))}dispatchEvent(t){const e=this._GetHandlerByType(t.type,!1);return!e||(t.cancelable?e._FireCancellable(t):e._FireNonCancellable(t))}dispatchEventAsync(t){const e=this._GetHandlerByType(t.type,!1);return e?(t.isAsync=!0,e._FireAsync(t)):Promise.resolve(!0)}async dispatchEventAndClearAsync(t){const e=this._GetHandlerByType(t.type,!1);if(!e)return!0;this._eventHandlers.delete(t.type),t.isAsync=!0;const s=await e._FireAsync(t);return e.Release(),s}async dispatchEventAndWaitAsync(t){const e=this._GetHandlerByType(t.type,!1);return!e||await e._FireAndWaitAsync(t)}dispatchEventAndWait_AsyncOptional(t){const e=this._GetHandlerByType(t.type,!1);return!e||e._FireAndWait_AsyncOptional(t)}async dispatchEventAndWaitAsyncSequential(t){const e=this._GetHandlerByType(t.type,!1);return!e||await e._FireAndWaitAsyncSequential(t)}dispatchGeneratorEvent(t){const e=this._GetHandlerByType(t.type,!1);if(!e)return null;if(t.cancelable)throw new Error("not supported");return e._FireAsGenerator(t)}SetDelayRemoveEventsEnabled(t){for(const e of this._eventHandlers.values())e.SetDelayRemoveEventsEnabled(t)}}}{let Yh=function(t){Zh=Qh&&0===$h?requestIdleCallback(Xh,{timeout:35}):setTimeout(Xh,$h>0?1:t)},Xh=function(t){if(Zh=-1,!Kh.length)return;let e=performance.now(),s=e,i=0,r=0;do{qh(Kh.shift()),s=performance.now(),++i,r=(s-e)/i*1.1}while(Kh.length&&(Qh&&0===$h&&void 0!==t?r<t.timeRemaining():s-e+r<12));if(-1===Zh&&Kh.length){let t=s-e;Yh(Math.max(16-t,4))}},qh=function(t){let e;try{e=t.func()}catch(e){return void t.reject(e)}t.resolve(e)};0;const Jh=self.C3,Qh="undefined"!=typeof requestIdleCallback;let Kh=[],Zh=-1,$h=0,tl=Jh.QueryString.Has("disable-asyncify");tl&&console.warn("[Asyncify] Asyncify has been disabled due to disable-asyncify in the query string. Some work will now be done synchronously."),Jh.Asyncify=function(t){let e=null;return Jh.isDebug&&(e=Jh.GetCallStack()),new Promise((s,i)=>{Kh.push({func:t,resolve:s,reject:i,stack:e}),tl?qh(Kh.pop()):-1===Zh&&Yh(16)})},Jh.Asyncify.SetHighThroughputMode=function(t){if(t)++$h;else if(--$h,$h<0)throw new Error("already turned off high throughput mode")}}{let el=function(){rl=-1},sl=function(){nl=-1,al=-1;let t=Date.now();for(let e of ol)if(e._CheckTimeout(t)){let t=e._GetDeadline();(-1===al||t<al)&&(al=t)}else ol.delete(e);if(-1!==al){let e=Math.max(al-t+100,1e3);nl=self.setTimeout(sl,e)}};0;const il=self.C3;let rl=-1;il.FastGetDateNow=function(){return-1===rl&&(rl=Date.now(),self.setTimeout(el,16)),rl};let nl=-1,al=-1,ol=new Set;il.IdleTimeout=class{constructor(t,e){this._callback=t,this._timeout=1e3*e,this._deadline=0,this._isActive=!1}Reset(){let t=il.FastGetDateNow();this._deadline=t+this._timeout,this._isActive||(ol.add(this),this._isActive=!0),-1===nl?(al=this._deadline,nl=self.setTimeout(sl,this._timeout+100)):this._deadline<al&&al>t+1e3&&(self.clearTimeout(nl),al=this._deadline,nl=self.setTimeout(sl,this._timeout+100))}_CheckTimeout(t){return!(t>=this._deadline&&(this._callback()?(this._deadline=t+this._timeout,0):(this._isActive=!1,1)))}_GetDeadline(){return this._deadline}Cancel(){this._isActive&&(ol.delete(this),this._isActive=!1,0===ol.size&&-1!==nl&&(self.clearTimeout(nl),nl=-1,al=-1))}Release(){this.Cancel(),this._callback=null}}}{const hl=self.C3;hl.Disposable=class t{constructor(t){this._disposed=!1,this._disposeAction=t}Dispose(){this._disposed||(this._disposed=!0,this._disposeAction&&(this._disposeAction(),this._disposeAction=null))}IsDisposed(){return this._disposed}Release(){this.Dispose()}static Release(e){return new t(()=>e.Release())}static From(t,e,s,i,r){if("string"!=typeof e&&!Array.isArray(e))throw new TypeError("expected string or array");if(null==i)i=!1;else if("boolean"!=typeof i&&"object"!=typeof i)throw new TypeError("invalid event listener options");if(r&&(s=s.bind(r)),Array.isArray(e)||e.includes(" ")){"string"==typeof e&&(e=e.split(" "));const r=new hl.CompositeDisposable;for(const n of e)t.addEventListener(n,s,i),r.Add(hl.New(hl.Disposable,()=>t.removeEventListener(n,s,i)));return r}return t.addEventListener(e,s,i),hl.New(hl.Disposable,()=>t.removeEventListener(e,s,i))}},hl.StubDisposable=class extends hl.Disposable{SetAction(t){this._disposeAction=t}},hl.CompositeDisposable=class extends hl.Disposable{constructor(...t){super(),this._disposables=new Set;for(let e of t)this.Add(e)}Add(...t){if(this._disposed)throw new Error("already disposed");for(let e of t)this._disposables.add(e)}Remove(t){if(this._disposed)throw new Error("already disposed");this._disposables.delete(t)}RemoveAll(){if(this._disposed)throw new Error("already disposed");if(this._disposables){for(let t of this._disposables)t.Dispose();this._disposables.clear()}}IsDisposed(){return this._disposed}Dispose(){if(this._disposed)throw new Error("already disposed");this._disposed=!0;for(let t of this._disposables)t.Dispose();this._disposables.clear(),this._disposables=null}Release(){this.Dispose()}}}{const ll=self.C3;ll.KahanSum=class extends ll.DefendedBase{constructor(){super(),this._c=0,this._y=0,this._t=0,this._sum=0}Add(t){t=+t,this._y=t-this._c,this._t=this._sum+this._y,this._c=this._t-this._sum-this._y,this._sum=this._t}Subtract(t){this._sum-=+t}Get(){return this._sum}Reset(){this._c=0,this._y=0,this._t=0,this._sum=0}Set(t){this._c=0,this._y=0,this._t=0,this._sum=+t}Copy(t){this._c=t._c,this._y=t._y,this._t=t._t,this._sum=t._sum}Release(){}}}{const cl=self.C3,ul={},_l=!0;ul.RBnode=function(t){this.tree=t,this.right=this.tree.sentinel,this.left=this.tree.sentinel,this.parent=null,this.color=!1,this.key=null},ul.RedBlackSet=function(t){this.size=0,this.sentinel=new ul.RBnode(this),this.sentinel.color=!1,this.root=this.sentinel,this.root.parent=this.sentinel,this.compare=t||this.default_compare},ul.RedBlackSet.prototype.default_compare=function(t,e){return t<e?-1:e<t?1:0},ul.RedBlackSet.prototype.clone=function(){var t=new ul.RedBlackSet(this.compare);return t.insertAll(this),t},ul.RedBlackSet.prototype.clear=function(){this.size=0,this.sentinel=new ul.RBnode(this),this.sentinel.color=!1,this.root=this.sentinel,this.root.parent=this.sentinel},ul.RedBlackSet.prototype.leftRotate=function(t){var e=t.right;t.right=e.left,e.left!=this.sentinel&&(e.left.parent=t),e.parent=t.parent,t.parent==this.sentinel?this.root=e:t==t.parent.left?t.parent.left=e:t.parent.right=e,e.left=t,t.parent=e},ul.RedBlackSet.prototype.rightRotate=function(t){var e=t.left;t.left=e.right,e.right!=this.sentinel&&(e.right.parent=t),e.parent=t.parent,t.parent==this.sentinel?this.root=e:t==t.parent.right?t.parent.right=e:t.parent.left=e,e.right=t,t.parent=e},ul.RedBlackSet.prototype.insert=function(t){if(this.contains(t))this.get_(t).key=t;else{var e=new ul.RBnode(this);e.key=t;for(var s=this.sentinel,i=this.root;i!=this.sentinel;)s=i,i=this.compare(e.key,i.key)<0?i.left:i.right;e.parent=s,s==this.sentinel?this.root=e:this.compare(e.key,s.key)<0?s.left=e:s.right=e,e.left=this.sentinel,e.right=this.sentinel,e.color=_l,this.insertFixup(e),this.size++}},ul.RedBlackSet.prototype.insertFixup=function(t){for(;t!=this.sentinel&&t!=this.root&&t.parent.color==_l;){var e;t.parent==t.parent.parent.left?(e=t.parent.parent.right).color==_l?(t.parent.color=!1,e.color=!1,t.parent.parent.color=_l,t=t.parent.parent):(t==t.parent.right&&(t=t.parent,this.leftRotate(t)),t.parent.color=!1,t.parent.parent.color=_l,t.parent.parent!=this.sentinel&&this.rightRotate(t.parent.parent)):(e=t.parent.parent.left).color==_l?(t.parent.color=!1,e.color=!1,t.parent.parent.color=_l,t=t.parent.parent):(t==t.parent.left&&(t=t.parent,this.rightRotate(t)),t.parent.color=!1,t.parent.parent.color=_l,t.parent.parent!=this.sentinel&&this.leftRotate(t.parent.parent))}this.root.color=!1},ul.RedBlackSet.prototype.delete_=function(t){var e,s;(s=(e=t.left==this.sentinel||t.right==this.sentinel?t:this.successor_(t)).left!=this.sentinel?e.left:e.right).parent=e.parent,e.parent==this.sentinel?this.root=s:e==e.parent.left?e.parent.left=s:e.parent.right=s,e!=t&&(t.key=e.key),0==e.color&&this.deleteFixup(s),this.size--},ul.RedBlackSet.prototype.deleteFixup=function(t){for(;t!=this.root&&0==t.color;){var e;t==t.parent.left?((e=t.parent.right).color==_l&&(e.color=!1,t.parent.color=_l,this.leftRotate(t.parent),e=t.parent.right),0==e.left.color&&0==e.right.color?(e.color=_l,t=t.parent):(0==e.right.color&&(e.left.color=!1,e.color=_l,this.rightRotate(e),e=t.parent.right),e.color=t.parent.color,t.parent.color=!1,e.right.color=!1,this.leftRotate(t.parent),t=this.root)):((e=t.parent.left).color==_l&&(e.color=!1,t.parent.color=_l,this.rightRotate(t.parent),e=t.parent.left),0==e.right.color&&0==e.left.color?(e.color=_l,t=t.parent):(0==e.left.color&&(e.right.color=!1,e.color=_l,this.leftRotate(e),e=t.parent.left),e.color=t.parent.color,t.parent.color=!1,e.left.color=!1,this.rightRotate(t.parent),t=this.root))}t.color=!1},ul.RedBlackSet.prototype.remove=function(t){var e=this.get_(t);if(e!=this.sentinel){var s=e.key;return this.delete_(e),s}return null},ul.RedBlackSet.prototype.removeSwapped=function(t,e){this.remove(e)},ul.RedBlackSet.prototype.min=function(t){for(;t.left!=this.sentinel;)t=t.left;return t},ul.RedBlackSet.prototype.max=function(t){for(;t.right!=this.sentinel;)t=t.right;return t},ul.RedBlackSet.prototype.successor_=function(t){if(t.right!=this.sentinel)return this.min(t.right);for(var e=t.parent;e!=this.sentinel&&t==e.right;)t=e,e=e.parent;return e},ul.RedBlackSet.prototype.predeccessor_=function(t){if(t.left!=this.sentinel)return this.max(t.left);for(var e=t.parent;e!=this.sentinel&&t==e.left;)t=e,e=e.parent;return e},ul.RedBlackSet.prototype.successor=function(t){if(this.size>0){var e=this.get_(t);if(e==this.sentinel)return null;if(e.right!=this.sentinel)return this.min(e.right).key;for(var s=e.parent;s!=this.sentinel&&e==s.right;)e=s,s=s.parent;return s!=this.sentinel?s.key:null}return null},ul.RedBlackSet.prototype.predecessor=function(t){if(this.size>0){var e=this.get_(t);if(e==this.sentinel)return null;if(e.left!=this.sentinel)return this.max(e.left).key;for(var s=e.parent;s!=this.sentinel&&e==s.left;)e=s,s=s.parent;return s!=this.sentinel?s.key:null}return null},ul.RedBlackSet.prototype.getMin=function(){return this.min(this.root).key},ul.RedBlackSet.prototype.getMax=function(){return this.max(this.root).key},ul.RedBlackSet.prototype.get_=function(t){for(var e=this.root;e!=this.sentinel&&0!=this.compare(e.key,t);)e=this.compare(t,e.key)<0?e.left:e.right;return e},ul.RedBlackSet.prototype.contains=function(t){return null!=this.get_(t).key},ul.RedBlackSet.prototype.getValues=function(){var t=[];return this.forEach(function(e){t.push(e)}),t},ul.RedBlackSet.prototype.insertAll=function(t){if("array"==ul.typeOf(t))for(var e=0;e<t.length;e++)this.insert(t[e]);else if("function"==ul.typeOf(t.forEach))t.forEach(this.insert,this);else if("function"==ul.typeOf(t.getValues)){var s=t.getValues();for(e=0;e<s.length;e++)this.insert(s[e])}else if("object"==ul.typeOf(t))for(var i in t)this.insert(t[i])},ul.RedBlackSet.prototype.removeAll=function(t){if("array"==ul.typeOf(t))for(var e=0;e<t.length;e++)this.remove(t[e]);else if("function"==ul.typeOf(t.forEach))t.forEach(this.removeSwapped,this);else if("function"==ul.typeOf(t.getValues)){var s=t.getValues();for(e=0;e<s.length;e++)this.remove(s[e])}else if("object"==ul.typeOf(t))for(var i in t)this.remove(t[i])},ul.RedBlackSet.prototype.containsAll=function(t){if("array"==ul.typeOf(t)){for(var e=0;e<t.length;e++)if(!this.contains(t[e]))return!1;return!0}if("function"==ul.typeOf(t.forEach))return t.every(this.contains,this);if("function"==ul.typeOf(t.getValues)){var s=t.getValues();for(e=0;e<s.length;e++)if(!this.contains(s[e]))return!1;return!0}if("object"==ul.typeOf(t)){for(var i in t)if(!this.contains(t[i]))return!1;return!0}},ul.RedBlackSet.prototype.range=function(t,e){var s=[];return this.traverseFromTo(function(t){s.push(t)},t,e),s},ul.RedBlackSet.prototype.traverse=function(t,e){if(!this.isEmpty())for(var s=this.min(this.root);s!=this.sentinel;){if(t.call(e,s.key,this))return;s=this.successor_(s)}},ul.RedBlackSet.prototype.traverseFrom=function(t,e,s){if(!this.isEmpty())for(var i=this.get_(e);i!=this.sentinel;){if(t.call(s,i.key,this))return;i=this.successor_(i)}},ul.RedBlackSet.prototype.traverseTo=function(t,e,s){if(!this.isEmpty())for(var i=this.min(this.root),r=this.get_(e);i!=r;){if(t.call(s,i.key,this))return;i=this.successor_(i)}},ul.RedBlackSet.prototype.traverseFromTo=function(t,e,s,i){if(!this.isEmpty())for(var r=this.get_(e),n=this.get_(s);r!=n;){if(t.call(i,r.key,this))return;r=this.successor_(r)}},ul.RedBlackSet.prototype.traverseBackwards=function(t,e){if(!this.isEmpty())for(var s=this.max(this.root);s!=this.sentinel;){if(t.call(e,s.key,this))return;s=this.predeccessor_(s)}},ul.RedBlackSet.prototype.forEach=function(t,e){if(!this.isEmpty())for(var s=this.min(this.root);s!=this.sentinel;s=this.successor_(s))t.call(e,s.key,s.key,this)},ul.RedBlackSet.prototype.some=function(t,e){if(this.isEmpty())return!1;for(var s=this.min(this.root);s!=this.sentinel;s=this.successor_(s))if(t.call(e,s.key,s.key,this))return!0;return!1},ul.RedBlackSet.prototype.every=function(t,e){if(this.isEmpty())return!1;for(var s=this.min(this.root);s!=this.sentinel;s=this.successor_(s))if(!t.call(e,s.key,s.key,this))return!1;return!0},ul.RedBlackSet.prototype.map=function(t,e){var s=[];if(this.isEmpty())return s;for(var i=this.min(this.root);i!=this.sentinel;i=this.successor_(i))s.push(t.call(e,i.key,i.key,this));return s},ul.RedBlackSet.prototype.filter=function(t,e){var s=[];if(this.isEmpty())return s;for(var i=this.min(this.root);i!=this.sentinel;i=this.successor_(i))t.call(e,i.key,i.key,this)&&s.push(i.key);return s},ul.RedBlackSet.prototype.getCount=function(){return this.size},ul.RedBlackSet.prototype.isEmpty=function(){return 0==this.size},ul.RedBlackSet.prototype.isSubsetOf=function(t){var e=ul.getCount(t);if(this.getCount()>e)return!1;var s=0;if(this.isEmpty())return!0;for(var i=this.min(this.root);i!=this.sentinel;i=this.successor_(i))ul.contains.call(t,t,i.key)&&s++;return s==this.getCount()},ul.RedBlackSet.prototype.intersection=function(t){var e=new ul.RedBlackSet(this.compare);if(this.isEmpty())return e;for(var s=this.min(this.root);s!=this.sentinel;s=this.successor_(s))t.contains.call(t,s.key,s.key,this)&&e.insert(s.key);return e},cl.RedBlackSet=class extends cl.DefendedBase{constructor(t){super(),this._rbSet=new ul.RedBlackSet(t),this._enableQueue=!1,this._queueInsert=new Set,this._queueRemove=new Set}Add(t){this._enableQueue?this._rbSet.contains(t)?this._queueRemove.delete(t):this._queueInsert.add(t):this._rbSet.insert(t)}Remove(t){this._enableQueue?this._rbSet.contains(t)?this._queueRemove.add(t):this._queueInsert.delete(t):this._rbSet.remove(t)}Has(t){return this._enableQueue?!!this._queueInsert.has(t)||!this._queueRemove.has(t)&&this._rbSet.contains(t):this._rbSet.contains(t)}Clear(){this._rbSet.clear(),this._queueInsert.clear(),this._queueRemove.clear()}toArray(){if(this._enableQueue)throw new Error("cannot be used in queueing mode");return this._rbSet.getValues()}GetSize(){return this._rbSet.getCount()+this._queueInsert.size-this._queueRemove.size}IsEmpty(){return 0===this.GetSize()}Front(){if(this.IsEmpty())throw new Error("empty set");if(this._enableQueue)throw new Error("cannot be used in queueing mode");const t=this._rbSet;return t.min(t.root).key}Shift(){if(this.IsEmpty())throw new Error("empty set");if(this._enableQueue)throw new Error("cannot be used in queueing mode");const t=this.Front();return this.Remove(t),t}SetQueueingEnabled(t){if(t=!!t,this._enableQueue!==t&&(this._enableQueue=t,!t)){for(const t of this._queueRemove)this._rbSet.remove(t);this._queueRemove.clear();for(const t of this._queueInsert)this._rbSet.insert(t);this._queueInsert.clear()}}ForEach(t){this._rbSet.forEach(t)}*values(){if(this.IsEmpty())return;const t=this._rbSet;for(let e=t.min(t.root);e!=t.sentinel;e=t.successor_(e))yield e.key}[Symbol.iterator](){return this.values()}}}{const dl=self.C3;dl.PromiseThrottle=class{constructor(t=dl.hardwareConcurrency){this._maxParallel=t,this._queue=[],this._activeCount=0}Add(t,e){return new Promise((s,i)=>{const r={func:t,resolve:s,reject:i,opts:e};e?.signal&&e.signal.aborted?i(new Error("abort")):(e?.signal&&(r.onabort=()=>{const t=this._queue.indexOf(r);-1!==t&&(this._queue.splice(t,1),i(new Error("abort")))},e.signal.addEventListener("abort",r.onabort)),this._queue.push(r),this._MaybeStartNext())})}_FindInQueue(t){for(let e=0,s=this._queue.length;e<s;++e)if(this._queue[e].func===t)return e;return-1}RemoveAndResolve(t,e){const s=this._FindInQueue(t);if(-1===s)throw new Error("cannot find promise to resolve");this._queue[s].resolve(e),this._queue.splice(s,1)}RemoveAndReject(t,e){const s=this._FindInQueue(t);if(-1===s)throw new Error("cannot find promise to reject");this._queue[s].reject(e),this._queue.splice(s,1)}async _MaybeStartNext(){if(!this._queue.length)return;if(this._activeCount>=this._maxParallel)return;this._activeCount++;const t=this._queue.shift();t.opts?.signal&&t.onabort&&t.opts.signal.removeEventListener("abort",t.onabort);try{const e=await t.func();t.resolve(e)}catch(e){t.reject(e)}this._activeCount--,this._MaybeStartNext()}}}{const pl=self.C3;pl.RateLimiter=class{constructor(t,e,s){this._callback=t,this._interval=e,this._intervalOnBattery=s||2*e,this._timerId=-1,this._lastCallTime=-1/0,this._timerCallFunc=()=>this._OnTimer(),this._ignoreReset=!1,this._canRunImmediate=!1,this._callbackArguments=null}SetCanRunImmediate(t){this._canRunImmediate=!!t}_GetInterval(){return void 0!==pl.Battery&&pl.Battery.IsOnBatteryPower()?this._intervalOnBattery:this._interval}Call(...t){if(-1!==this._timerId)return;this._callbackArguments=t;let e=pl.FastGetDateNow(),s=e-this._lastCallTime,i=this._GetInterval();s>=i&&this._canRunImmediate?(this._lastCallTime=e,this._RunCallback()):this._timerId=self.setTimeout(this._timerCallFunc,Math.max(i-s,4))}_RunCallback(){this._ignoreReset=!0;const t=this._callbackArguments;this._callbackArguments=null,t?this._callback(...t):this._callback(),this._ignoreReset=!1}Reset(){this._ignoreReset||(this._CancelTimer(),this._callbackArguments=null,this._lastCallTime=pl.FastGetDateNow())}_OnTimer(){this._timerId=-1,this._lastCallTime=pl.FastGetDateNow(),this._RunCallback()}_CancelTimer(){-1!==this._timerId&&(self.clearTimeout(this._timerId),this._timerId=-1)}Release(){this._CancelTimer(),this._callback=null,this._callbackArguments=null,this._timerCallFunc=null}}}{const fl=self.C3;fl.SVGRasterManager=class{constructor(){this._images=new Map,this._allowNpotSurfaces=!1,this._getBaseSizeCallback=null,this._rasterAtSizeCallback=null,this._releaseResultCallback=null,this._redrawCallback=null}SetNpotSurfaceAllowed(t){this._allowNpotSurfaces=!!t}IsNpotSurfaceAllowed(){return this._allowNpotSurfaces}SetGetBaseSizeCallback(t){this._getBaseSizeCallback=t}GetBaseSize(t){if(!this._getBaseSizeCallback)throw new Error("no get base size callback set");return this._getBaseSizeCallback(t)}SetRasterAtSizeCallback(t){this._rasterAtSizeCallback=t}RasterAtSize(t,e,s,i,r,n){if(!this._rasterAtSizeCallback)throw new Error("no raster at size callback set");return this._rasterAtSizeCallback(t,e,s,i,r,n)}SetReleaseResultCallback(t){this._releaseResultCallback=t}ReleaseResult(t){if(!this._releaseResultCallback)throw new Error("no release result callback set");this._releaseResultCallback(t)}SetRedrawCallback(t){this._redrawCallback=t}Redraw(){if(!this._redrawCallback)throw new Error("no redraw callback set");this._redrawCallback()}AddImage(t){let e=this._images.get(t);return e||(e=fl.New(fl.SVGRasterImage,this,t),this._images.set(t,e)),e.IncReference(),e}_RemoveImage(t){this._images.delete(t.GetDataSource())}OnTexturesChanged(){for(const t of this._images.values())t.ReleaseRasterizedResult(),t.ForceRasterAgain()}}}{const gl=self.C3;gl.SVGRasterImage=class{constructor(t,e){this._manager=t,this._dataSource=e,this._refCount=0,this._baseWidth=0,this._baseHeight=0,this._getBaseSizePromise=this._manager.GetBaseSize(e).then(t=>{this._manager&&(this._baseWidth=t[0],this._baseHeight=t[1],this._manager.Redraw())}).catch(t=>{console.error("[SVG] Error loading SVG: ",t),this._hadError=!0,this._manager&&this._manager.Redraw()}),this._rasterSurfaceWidth=0,this._rasterSurfaceHeight=0,this._rasterImageWidth=0,this._rasterImageHeight=0,this._isRasterizing=!1,this._rasterizedResult=null,this._forceRaster=!1,this._hadError=!1}Release(){if(this._refCount<=0)throw new Error("already released");this._refCount--,0===this._refCount&&this._Release()}ReleaseRasterizedResult(){this._rasterizedResult&&(this._manager.ReleaseResult(this._rasterizedResult),this._rasterizedResult=null)}_Release(){this.ReleaseRasterizedResult(),this._manager._RemoveImage(this),this._manager=null}GetDataSource(){return this._dataSource}IncReference(){this._refCount++}HasReferences(){return this._refCount>0}GetRasterizedResult(){return this._rasterizedResult}ForceRasterAgain(){this._forceRaster=!0}async StartRasterForSize(t,e,s){if(0===e||0===s||this._hadError)return;if(this._isRasterizing)return;let i=gl.nextHighestPowerOfTwo(Math.ceil(e)),r=gl.nextHighestPowerOfTwo(Math.ceil(s));const n=Math.max(i,r);if(n>4096){const t=4096/n;e*=t,s*=t,i=Math.min(Math.ceil(i*t),4096),r=Math.min(Math.ceil(r*t),4096)}if(e<i&&s<r){const t=e/s;i/r>t?(e=r*t,s=r):(e=i,s=i/t)}if(this._manager.IsNpotSurfaceAllowed()&&(i=Math.ceil(e),r=Math.ceil(s)),i<=this._rasterSurfaceWidth&&r<=this._rasterSurfaceHeight&&!this._forceRaster)return;this._isRasterizing=!0,this._rasterSurfaceWidth=i,this._rasterSurfaceHeight=r;const a=await this._manager.RasterAtSize(this._dataSource,t,this._rasterSurfaceWidth,this._rasterSurfaceHeight,e,s);this._manager&&(this.ReleaseRasterizedResult(),this._rasterizedResult=a,this._rasterImageWidth=e,this._rasterImageHeight=s,this._isRasterizing=!1,this._forceRaster=!1,this._manager.Redraw())}WhenBaseSizeReady(){return this._getBaseSizePromise}GetBaseWidth(){return this._baseWidth}GetBaseHeight(){return this._baseHeight}GetRasterWidth(){return this._rasterImageWidth}GetRasterHeight(){return this._rasterImageHeight}HadError(){return this._hadError}}}{let ml=function(t){return Cl.get(t)};0;const Sl=self.C3;Sl.UTF8_BOM="\ufeff";const yl=new Set("0123456789");Sl.IsNumericChar=function(t){return yl.has(t)};const Gl=new Set(" \t\n\r\u2028\u2029");Sl.IsWhitespaceChar=function(t){return Gl.has(t)},Sl.FilterWhitespace=function(t){return[...t].filter(t=>!Sl.IsWhitespaceChar(t)).join("")},Sl.IsStringAllWhitespace=function(t){for(const e of t)if(!Sl.IsWhitespaceChar(e))return!1;return!0},Sl.IsCharArrayAllWhitespace=function(t){for(const e of t)if(!Sl.IsWhitespaceChar(e))return!1;return!0},Sl.IsUnprintableChar=function(t){return 1===t.length&&t.charCodeAt(0)<32},Sl.FilterUnprintableChars=function(t){return[...t].filter(t=>!Sl.IsUnprintableChar(t)).join("")};let Tl=null;try{Tl=new RegExp("\\p{P}(?<=[\\u3000-\\u303F\\uFF00-\\uFFEF])","u")}catch(t){console.warn("Unable to detect CJK punctuation: ",t)}Sl.IsCJKPunctuationChar=function(t){return!Sl.IsWhitespaceChar(t)&&Tl&&Tl.test(t)};const Il=new Set("0123456789.+-e");Sl.IsStringNumber=function(t){if(!(t=t.trim()).length)return!1;let e=t.charAt(0);if("-"!==e&&!yl.has(e))return!1;for(let e of t)if(!Il.has(e))return!1;return!0},Sl.RemoveTrailingDigits=function(t){let e=t.length;for(;e>0;){let s=t.charAt(e-1);if(!Sl.IsNumericChar(s))break;--e}return t.substr(0,e)},Sl.IncrementNumberAtEndOf=function(t){let e=Sl.RemoveTrailingDigits(t),s=t.substr(e.length);return s=s?(parseInt(s,10)+1).toString():"2",e+s};const Cl=new Map([["&","&amp;"],["<","&lt;"],[">","&gt;"],['"',"&quot;"],["'","&#39;"]]),bl=/[&<>"']/g;Sl.EscapeHTML=function(t){return t.replace(bl,ml)},Sl.EscapeJS=function(t){let e=Sl.ReplaceAll(t,"\\","\\\\");return e=Sl.ReplaceAll(e,'"','\\"'),e=Sl.ReplaceAll(e,"\t","\\t"),e=Sl.ReplaceAll(e,"\r",""),Sl.ReplaceAll(e,"\n","\\n")},Sl.EscapeXML=function(t){let e=Sl.ReplaceAll(t,"&","&amp;");return e=Sl.ReplaceAll(e,"<","&lt;"),e=Sl.ReplaceAll(e,">","&gt;"),Sl.ReplaceAll(e,'"',"&quot;")};const xl=/[-[\]{}()*+?.,\\^$|#\s]/g;Sl.EscapeRegex=function(t){return t.replace(xl,"\\$&")},Sl.CountCharsInString=function(t,e){let s=0;for(const i of t)i===e&&++s;return s},Sl.StringPosToLineNumber=function(t,e){let s=0,i=0;for(;s<e;){if(s=t.indexOf("\n",s),-1===s)return i;i++,s++}return i},Sl.FindAll=function(t,e,s=!1){if(!e)return[];s||(t=t.toLowerCase(),e=e.toLowerCase());const i=e.length;let r=0,n=0,a=[];for(;(n=t.indexOf(e,r))>-1;)a.push(n),r=n+i;return a},Sl.ReplaceAll=function(t,e,s){return t.replaceAll(e,()=>s)},Sl.ReplaceAllCaseInsensitive=function(t,e,s){return t.replace(new RegExp(Sl.EscapeRegex(e),"gi"),()=>s)},Sl.SetElementContent=function(t,e){"string"==typeof e?t.textContent=e:e.isPlainText()?t.textContent=e.toString():(t.innerHTML=e.toHTML(),e instanceof Sl.BBString&&e.attachLinkHandlers(t))},Sl.StringLikeEquals=function(t,e){return t instanceof Sl.HtmlString||t instanceof Sl.BBString?t.equals(e):e instanceof Sl.HtmlString||e instanceof Sl.BBString?e.equals(t):t===e},Sl.StringSubstitute=function(t,...e){let s=t;for(let i=0,r=e.length;i<r;++i){const r=`{${i}}`;if(!t.includes(r))throw new Error(`missing placeholder '${r}' in string substitution`);s=s.replace(r,e[i].toString())}return s},Sl.StringSubstituteAllowMissing=function(t,...e){let s=t,i=-1,r=-1;for(let n=0,a=e.length;n<a;++n){const a=`{${n}}`;t.includes(a)?(r=n,s=s.replace(a,e[n].toString())):-1===i&&(i=n)}if(i>=0&&r>=0&&i<r)throw new Error(`missing placeholder '${i}' in string substitution`);return s},Sl.StringSubstituteMap=function(t,e){let s=t;for(let[t,i]of Object.entries(e))s=s.replaceAll(t,i.toString());return s},Sl.SortAZ=function(t,e){return t>e?1:t<e?-1:0},Sl.SortAZCaseInsensitive=function(t,e){let s=t.toLowerCase(),i=e.toLowerCase();return s>i?1:s<i?-1:0};const wl=new self.Intl.Segmenter;Sl.SplitGraphemes=function(t){if(1===t.length)return[t];const e=[];for(const s of wl.segment(t))e.push(s.segment);return e},Sl.IterateGraphemes=function*(t){for(const e of wl.segment(t))yield e.segment},Sl.CountGraphemes=function(t){let e=0;for(const s of wl.segment(t))++e;return e};const Ml=1073741824,Pl=1099511627776;Sl.FormatDataSize=function(t,e){let s="common."+(e?"dataRates":"dataSizes")+".";const i=self.langSub;if(t<1024)return i(s+"bytes",t);if(t<1048576){let e=t/1024;return e=e<10?Math.round(10*e)/10:Math.round(e),i(s+"kilobytes",e)}if(t<Ml){let e=t/1048576;return e=e<10?Math.round(10*e)/10:Math.round(e),i(s+"megabytes",e)}if(t<Pl){let e=t/Ml;return e=e<10?Math.round(10*e)/10:Math.round(e),i(s+"gigabytes",e)}{let e=t/Pl;return e=e<10?Math.round(10*e)/10:Math.round(e),i(s+"terabytes",e)}};const vl={approximate:!1,days:!0,hours:!0,minutes:!0,seconds:!0};Sl.FormatTime=function(t,e){e=Object.assign({},vl,e),Sl.Lang.PushContext("common.time");const s=[],i=self.lang,r=self.langPluralSub;if(e.days){const e=Math.floor(t/86400);e>0&&(t-=24*e*3600,s.push(r(".days",null,e)))}if(e.hours){const e=Math.floor(t/3600);(e>0||s.length)&&(t-=3600*e,s.push(r(".hours",null,e)))}if(e.minutes){const i=Math.floor(t/60);(i>0||s.length||!e.seconds)&&(t-=60*i,s.push(r(".minutes",null,i)))}if(e.seconds){const e=Math.floor(t%60);s.push(r(".seconds",null,e))}const n=(e.approximate?i(".approx-prefix"):"")+s.join(i(".separator"));return Sl.Lang.PopContext(),n},Sl.ZeroPad=function(t,e){let s=t<0?"-":"",i=(t=Math.abs(t)).toString(),r=e-i.length;for(let t=0;t<r;++t)s+="0";return s+i},Sl.StringToTitleCase=function(t){return t.toLowerCase().replace(/\b\w/g,t=>t.toUpperCase())},Sl.CompareVersionStrings=function(t,e){let s=t.split(".").map(t=>t.trim()),i=e.split(".").map(t=>t.trim());Sl.resizeArray(s,4,"0"),Sl.resizeArray(i,4,"0"),s=s.map(t=>parseInt(t,10)),i=i.map(t=>parseInt(t,10));for(let t=0;t<4;++t){const e=s[t]-i[t];if(0!==e)return e<0?-1:1}return 0},Sl.CreateGUID=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,t=>{const e=Math.floor(16*Math.random());return("x"===t?e:3&e|8).toString(16)})},Sl.StringHammingDistance=function(t,e){if(t.length!==e.length)throw new Error("strings must be same length");let s=0;for(let i=0,r=t.length;i<r;++i)t.charAt(i)!==e.charAt(i)&&++s;return s},Sl.StringLevenshteinDistance=function(t,e){if(0===t.length)return e.length;if(0===e.length)return t.length;let s,i,r,n,a,o;for(t.length>e.length&&(s=t,t=e,e=s),o=Array(t.length+1),i=0;i<=t.length;i++)o[i]=i;for(i=1;i<=e.length;i++){for(n=i,r=1;r<=t.length;r++)a=e[i-1]===t[r-1]?o[r-1]:Math.min(o[r-1]+1,Math.min(n+1,o[r]+1)),o[r-1]=n,n=a;o[t.length]=n}return o[t.length]},Sl.StringByteLengthAsUTF8=function(t){return(new TextEncoder).encode(t).length}}{let Rl=function(t,e,s){const i=Dl.get(s);if(!i)return"class"===s?e?"</span>":`<span class="bbclass${kl++}">`:t;if("string"==typeof i){if("a"===i&&0===Bl.length||"abbr"===i&&0===Ll.length)return t;if("a"!==i||e){if("abbr"!==i||e)return"<"+e+i+">";{const t=parseInt(s.substring(3),10)-1;if(t<0||t>=Ll.length)throw new Error("invalid bbcode tip substitution");const e=Ll[t];let i="";if("string"==typeof e?i=e:"function"==typeof e&&(i=e()),"string"!=typeof i)throw new TypeError("invalid bbcode tip");return`<abbr title="${Al.ReplaceAll(i,'"',"&quot;")}">`}}{const t=parseInt(s.substring(1),10)-1;if(t<0||t>=Bl.length)throw new Error("invalid bbcode link substitution");const e=Bl[t];if("string"==typeof e)return`<a href="${Bl[t]}">`;if("function"==typeof e)return`<a class="bblink${t}">`;throw new TypeError("invalid bbcode link action")}}if(Array.isArray(i)){let t=i[0],s=i[1];return e?"</"+t+">":`<${t} class="${s}">`}};0;const Al=self.C3,Dl=(self.assert,new Map([["b","strong"],["i","em"],["s","s"],["u","u"],["sub","sub"],["sup","sup"],["small","small"],["mark","mark"],["code","code"],["a1","a"],["a2","a"],["a3","a"],["a4","a"],["a5","a"],["a6","a"],["a7","a"],["a8","a"],["a9","a"],["tip1","abbr"],["tip2","abbr"],["tip3","abbr"],["tip4","abbr"],["tip5","abbr"],["tip6","abbr"],["tip7","abbr"],["tip8","abbr"],["tip9","abbr"],["bad",["span","bbCodeBad"]],["good",["span","bbCodeGood"]],["info",["span","bbCodeInfo"]],["h1",["span","bbCodeH1"]],["h2",["span","bbCodeH2"]],["h3",["span","bbCodeH3"]],["h4",["span","bbCodeH4"]],["item",["span","bbCodeItem"]]])),El=new Set(["icon"]),Fl=/\[(\/?)([a-zA-Z0-9]+)\]/g,Ol=/\[(\/?)([^\[\n]*?)\]/g;let Bl=null,Ll=null,kl=0;const Nl=/\n/g;Al.BBString=class{constructor(t,e){if(this._bbstr=e&&e.noEscape?t:Al.EscapeHTML(t),this._htmlstr="",this._convertLineBreaks=!1,this._linkActions=[],this._tipList=[],e){if(this._convertLineBreaks=!!e.convertLineBreaks,e.links){if(e.links.length>9)throw new Error("too many links");this._linkActions=e.links}if(e.tips){if(e.tips.length>9)throw new Error("too many tips");this._tipList=e.tips}}this._hasAnyBBtags=this._bbstr.includes("["),this._needsLineBreakConversion=this._convertLineBreaks&&this._bbstr.includes("\n"),this._isPlain=!this._hasAnyBBtags&&!this._needsLineBreakConversion&&!this._bbstr.includes("&"),this._hasParsedFragments=!1,this._fragments=[]}toString(){return this._bbstr}valueOf(){return this._bbstr}isPlainText(){return this._isPlain}toPlainText(){return this._hasAnyBBtags?this._bbstr.replace(Fl,""):this._bbstr}toHTML(){if(this._isPlain)return this._bbstr;if(!this._htmlstr&&this._bbstr){let t=this._bbstr;this._hasAnyBBtags&&(kl=0,Bl=this._linkActions,Ll=this._tipList,t=t.replace(Fl,Rl),Bl=null,Ll=null),this._needsLineBreakConversion&&(t=t.replace(Nl,"<br>")),this._htmlstr=t}return this._htmlstr}attachLinkHandlers(t){if(this._linkActions.length)for(let e=0,s=this._linkActions.length;e<s;++e){const s=this._linkActions[e];if("function"!=typeof s)continue;const i=t.querySelector(".bblink"+e);if(!i)throw new Error("unable to attach BBString link handler");i.onclick=s}}equals(t){return t instanceof Al.HtmlString?this.toHTML()===t.toHTML():t instanceof Al.BBString?this._bbstr===t._bbstr:this._bbstr===t}toFragmentList(){if(this._hasParsedFragments)return this._fragments;const t=[],e=this._bbstr,s=[];Ol.lastIndex=0;let i=0,r=null;for(;null!==(r=Ol.exec(e));){const n=r.index;if(n>0&&"\\"===e.charAt(n-1))continue;const a=r[0],o=r[1],h=r[2],l=e.substring(i,n);if(i=n+a.length,l&&t.push({text:l,styles:s.slice(0)}),h)if(o){const t=h.toLowerCase();for(let e=s.length-1;e>=0;--e)if(s[e].tag===t){s.splice(e,1);break}}else{let e=h,i=null;const r=h.indexOf("=");if(-1!==r?(e=h.substring(0,r).toLowerCase(),i=h.substring(r+1)):e=e.toLowerCase(),El.has(e)){if("icon"!==e)throw new Error(`unknown self-closing tag ${e}`);t.push({icon:i,styles:s.slice(0)})}else s.push({tag:e,param:i})}}i<e.length&&t.push({text:e.substring(i),styles:s.slice(0)});for(const e of t)e.text&&(e.text=this._ProcessBBCodeEscapeSequences(e.text));return this._fragments=t.map(t=>t.icon?Al.New(Al.IconFragment,{icon:t.icon,styles:t.styles}):Al.New(Al.TextFragment,{chArr:Al.SplitGraphemes(t.text),styles:t.styles})),this._hasParsedFragments=!0,this._fragments}_ProcessBBCodeEscapeSequences(t){return t=Al.ReplaceAll(t,"\\[","["),Al.ReplaceAll(t,"\\\\","\\")}static StripTags(t){return Al.New(Al.BBString,t,{noEscape:!0}).toPlainText()}static StripAnyTags(t){return t.replace(Ol,"")}}}{let Ul=function(t){return""!==t&&""!==t&&Hl.IsWhitespaceChar(t)},Wl=function(t){return Yl.has(t)},jl=function(t){return Hl.IsCJKPunctuationChar(t)&&!Wl(t)},Vl=function(t){for(;t.length>0&&Ul(t.at(-1));)t.pop()},zl=function(t){return"\n"===t||"\r\n"===t};0;const Hl=self.C3,Yl=new Set("");class Xl{constructor(){this.fragments=[],this.width=0,this.height=0,this.fontBoundingBoxAscent=0,this.fontBoundingBoxDescent=0,this.topToAlphabeticDistance=0,this.isMeasured=!1}static FromSingleFragment(t,e,s,i,r,n){const a=new Xl;return a.fragments.push(t),a.width=e,a.height=s,a.fontBoundingBoxAscent=i,a.fontBoundingBoxDescent=r,a.topToAlphabeticDistance=n,a}Copy(t){this.fragments=t.fragments.map(t=>t._Clone()),this.width=t.width,this.height=t.height,this.fontBoundingBoxAscent=t.fontBoundingBoxAscent,this.fontBoundingBoxDescent=t.fontBoundingBoxDescent,this.topToAlphabeticDistance=t.topToAlphabeticDistance,this.isMeasured=t.isMeasured}Reset(){this.fragments=[],this.width=0,this.height=0,this.fontBoundingBoxAscent=0,this.fontBoundingBoxDescent=0,this.topToAlphabeticDistance=0,this.isMeasured=!1}SetMetrics(t,e){e||(this.width=t.width),this.height=t.height||0,this.fontBoundingBoxAscent=t.fontBoundingBoxAscent||0,this.fontBoundingBoxDescent=t.fontBoundingBoxDescent||0,this.topToAlphabeticDistance=t.topToAlphabeticDistance||0,this.isMeasured=!0}AddWord(t){const e=this.fragments.length?this.fragments.at(-1):null;let s=0;e&&e.IsText()&&t[0].IsText()&&t[0].GetStyles()===e.GetStyles()&&(e._Append(t[0].GetCharacterArray()),s=1);for(let e=t.length;s<e;++s){const e=t[s];this.fragments.push(e._Clone())}this.isMeasured=!1}}Hl.WordWrap=class{constructor(){this._lines=[],this._iconSet=null,this._lastFitLineState=new Xl,this._tryLineState=new Xl,this._hitNewline=!1}GetLines(){return this._lines}GetLineCount(){return this._lines.length}SetIconSet(t){this._iconSet=t}WordWrap(t,e,s,i,r){if("string"==typeof t&&(t=[Hl.New(Hl.TextFragment,{chArr:Hl.SplitGraphemes(t)})]),Hl.clearArray(this._lines),!t.length||1===t.length&&t[0].IsText()&&t[0].IsEmpty()||s<2)return;if(1===t.length){const i=t[0];if(i.IsText()&&i.GetLength()<=100&&!i.HasNewLine()){let{width:t,height:n,fontBoundingBoxAscent:a,fontBoundingBoxDescent:o,topToAlphabeticDistance:h}=e(i);if(t+=r,i.SetWidth(t),i.SetHeight(n),i.SetFontBoundingBoxAscent(a||0),i.SetFontBoundingBoxDescent(o||0),i.SetTopToAlphabeticDistance(h||0),t<=s)return void this._AddLine(Xl.FromSingleFragment(i,t,n,a,o,h))}}let n,a=4;"word"===i?n=this._TokeniseByWord(t):"cjk"===i?(n=this._TokeniseByCJK(t),a=8):(n=this._TokeniseByChar(t),a=8),this._WrapText(n,e,s,a,r)}_TokeniseByWord(t){const e=[];let s=[],i=!1;for(const r of t){const t=r.GetStyles();if(r.IsIcon())s.length>0&&e.push(s),e.push([r]),s=[];else for(const n of r.GetCharacterArray())if(zl(n))s.length>0&&e.push(s),e.push([Hl.New(Hl.TextFragment,{chArr:["\n"],styles:t})]),s=[];else if(0===s.length)s.push(Hl.New(Hl.TextFragment,{chArr:[n],styles:t})),i=Ul(n);else{const r=Ul(n);if(r===i){const e=s.at(-1);e.GetStyles()===t?e._AppendChar(n):s.push(Hl.New(Hl.TextFragment,{chArr:[n],styles:t}))}else e.push(s),s=[Hl.New(Hl.TextFragment,{chArr:[n],styles:t})],i=r}}return s.length>0&&e.push(s),e}_TokeniseByCJK(t){const e=[];let s=[],i=!1;for(const r of t){const t=r.GetStyles();if(r.IsIcon())s.length>0&&e.push(s),e.push([r]),s=[];else for(const n of r.GetCharacterArray())if(zl(n))s.length>0&&e.push(s),e.push([Hl.New(Hl.TextFragment,{chArr:["\n"],styles:t})]),s=[];else if(0===s.length)s.push(Hl.New(Hl.TextFragment,{chArr:[n],styles:t})),i=Wl(n);else if(i||jl(n)){const e=s.at(-1);e.GetStyles()===t?e._AppendChar(n):s.push(Hl.New(Hl.TextFragment,{chArr:[n],styles:t})),i=Wl(n)}else e.push(s),s=[Hl.New(Hl.TextFragment,{chArr:[n],styles:t})],i=Wl(n)}return s.length>0&&e.push(s),e}_TokeniseByChar(t){const e=[];for(const s of t)if(s.IsText()){const t=s.GetCharacterArray();Hl.appendArray(e,t.map(t=>[Hl.New(Hl.TextFragment,{chArr:[t],styles:s.GetStyles()})]))}else e.push([s]);return e}_MeasureLine(t,e){let s=0,i=0,r=0,n=0,a=0;for(const o of t){if(-1===o.GetWidth()){const t=e(o);o.SetHeight(t.height),o.SetFontBoundingBoxAscent(t.fontBoundingBoxAscent||0),o.SetFontBoundingBoxDescent(t.fontBoundingBoxDescent||0),o.SetTopToAlphabeticDistance(t.topToAlphabeticDistance||0),o.IsText()?o.SetWidth(t.width):o.IsIcon()&&o.CalculateWidthFromHeight(this._iconSet)}s+=o.GetWidth(),i=Math.max(i,o.GetHeight()),r=Math.max(r,o.GetFontBoundingBoxAscent()),n=Math.max(n,o.GetFontBoundingBoxDescent()),a=Math.max(a,o.GetTopToAlphabeticDistance())}return{width:s,height:i,fontBoundingBoxAscent:r,fontBoundingBoxDescent:n,topToAlphabeticDistance:a}}_ResetLineStates(){this._lastFitLineState.Reset(),this._tryLineState.Reset()}_AddLine(t){this._lines.push(new Hl.WordWrap.Line(t)),this._ResetLineStates()}_IsWordNewLine(t){return 1===t.length&&t[0].IsText()&&1===t[0].GetLength()&&zl(t[0].GetCharacterArray()[0])}_IsWordWhitespace(t){return t[0].IsText()&&Hl.IsCharArrayAllWhitespace(t[0].GetCharacterArray())}_WrapText(t,e,s,i,r){let n=0;for(;n<t.length;)n=this._WrapText_Chunk(t,n,e,s,i);if(this._tryLineState.fragments.length>0){if(!this._tryLineState.isMeasured){const t=this._MeasureLine(this._tryLineState.fragments,e);this._tryLineState.SetMetrics(t)}this._AddLine(this._tryLineState)}this._TrimLinesTrailingWhitespace(e,r),this._ResetLineStates(),this._hitNewline=!1}_WrapText_Chunk(t,e,s,i,r){const n=this._lastFitLineState,a=this._tryLineState,o=t[e];if(this._IsWordNewLine(o)){if(!a.isMeasured){const t=s(Hl.New(Hl.TextFragment,{chArr:[" "],styles:o[0].GetStyles()}));a.SetMetrics(t,!0)}return this._AddLine(a),e+1}const h=this._WrapText_CollectChunk(t,e,r),l=this._MeasureLine(a.fragments,s);return a.SetMetrics(l),l.width>=i?this._WrapText_RetryChunk(t,e,s,i):(n.Copy(a),this._hitNewline&&this._AddLine(n),h+1)}_WrapText_CollectChunk(t,e,s){const i=this._tryLineState;this._hitNewline=!1;let r=e,n=0;for(let e=t.length;r<e;++r){const e=t[r];if(this._IsWordNewLine(e)){this._hitNewline=!0;break}if(i.AddWord(e),!this._IsWordWhitespace(e)&&(++n,n===s))break}return r}_WrapText_RetryChunk(t,e,s,i){const r=this._lastFitLineState,n=this._tryLineState;n.Copy(r);let a=e;for(let e=t.length;a<e;++a){const o=t[a];if(this._IsWordNewLine(o))return this._AddLine(r),a+1;if(n.AddWord(o),!this._IsWordWhitespace(o)||0===r.fragments.length){const o=this._MeasureLine(n.fragments,s);if(n.SetMetrics(o),o.width>=i){let s;return r.fragments.length>0?s=r:(s=n,++a,a<e&&this._IsWordWhitespace(t[a])&&++a),this._AddLine(s),a}r.Copy(n)}}return a}_TrimLinesTrailingWhitespace(t,e){for(const s of this._lines){const i=s._GetFragmentsArray();if(!i.length)continue;let r=i.at(-1);if(r.IsText()){const n=r.GetCharacterArray(),a=n.slice(0);if(Vl(a),0===a.length)s.OffsetWidth(-r.GetWidth()),i.pop();else if(a.length<n.length){r.SetCharacterArray(a);const e=t(r).width,i=r.GetWidth()-e;r.SetWidth(e),s.OffsetWidth(-i)}0!==e&&i.length>0&&(r=i.at(-1),r.OffsetWidth(e),s.OffsetWidth(e))}}}Clear(){Hl.clearArray(this._lines)}GetMaxLineWidth(){return this._lines.reduce((t,e)=>Math.max(t,e.GetWidth()),0)}GetTotalLineHeight(){return this._lines.reduce((t,e)=>t+e.GetHeight(),0)}}}self.C3.WordWrap.Line=class{constructor(t){this._fragments=t.fragments,this._width=t.width,this._height=t.height,this._fontBoundingBoxAscent=t.fontBoundingBoxAscent,this._fontBoundingBoxDescent=t.fontBoundingBoxDescent,this._topToAlphabeticDistance=t.topToAlphabeticDistance,this._posX=0,this._posY=0}fragments(){return this._fragments.values()}*fragmentsReverse(){const t=this._fragments;for(let e=t.length-1;e>=0;--e)yield t[e]}_GetFragmentsArray(){return this._fragments}OffsetWidth(t){this._width+=t}GetWidth(){return this._width}GetHeight(){return this._height}GetFoundBoundingBoxAscent(){return this._fontBoundingBoxAscent}GetFontBoundingBoxDescent(){return this._fontBoundingBoxDescent}GetTopToAlphabeticDistance(){return this._topToAlphabeticDistance}SetPosX(t){this._posX=t}GetPosX(){return this._posX}SetPosY(t){this._posY=t}GetPosY(){return this._posY}};self.C3.FragmentBase=class{constructor(t){this._styles=t.styles||[],this._width=t.width||-1,this._height=t.height||-1,this._fontBoundingBoxAscent=t.fontBoundingBoxAscent||-1,this._fontBoundingBoxDescent=t.fontBoundingBoxDescent||-1,this._topToAlphabeticDistance=t.topToAlphabeticDistance||-1,this._posX=0,this._posY=0}IsText(){return!1}IsIcon(){return!1}GetStyles(){return this._styles}GetStyleTag(t){const e=this._styles;for(let s=e.length-1;s>=0;--s){const i=e[s];if(i.tag===t)return i}return null}HasStyleTag(t){return!!this.GetStyleTag(t)}GetStyleMap(){const t=new Map;for(const e of this._styles)t.set(e.tag,e.param);return t}OffsetWidth(t){this._width+=t}SetWidth(t){this._width=t}GetWidth(){return this._width}SetHeight(t){this._height=t}GetHeight(){return this._height}SetFontBoundingBoxAscent(t){this._fontBoundingBoxAscent=t}GetFontBoundingBoxAscent(){return this._fontBoundingBoxAscent}SetFontBoundingBoxDescent(t){this._fontBoundingBoxDescent=t}GetFontBoundingBoxDescent(){return this._fontBoundingBoxDescent}SetTopToAlphabeticDistance(t){this._topToAlphabeticDistance=t}GetTopToAlphabeticDistance(){return this._topToAlphabeticDistance}SetPosX(t){this._posX=t}GetPosX(){return this._posX}SetPosY(t){this._posY=t}GetPosY(){return this._posY}};{const ql=self.C3;ql.TextFragment=class extends ql.FragmentBase{constructor(t){super(t),this._chArr=t.chArr}IsText(){return!0}_Append(t){ql.appendArray(this._chArr,t),this._width=-1,this._height=-1,this._fontBoundingBoxAscent=-1,this._fontBoundingBoxDescent=-1,this._topToAlphabeticDistance=-1}_AppendChar(t){this._chArr.push(t)}_Clone(){return ql.New(ql.TextFragment,{chArr:this._chArr.slice(0),styles:this._styles,width:this._width,height:this._height,fontBoundingBoxAscent:this._fontBoundingBoxAscent,fontBoundingBoxDescent:this._fontBoundingBoxDescent,topToAlphabeticDistance:this._topToAlphabeticDistance})}GetCharacterArray(){return this._chArr}SetCharacterArray(t){this._chArr=t}GetLength(){return this._chArr.length}IsEmpty(){return 0===this._chArr.length}HasNewLine(){return this._chArr.includes("\n")}}}{const Jl=self.C3;Jl.IconFragment=class extends Jl.FragmentBase{constructor(t){super(t),this._icon=t.icon}IsIcon(){return!0}GetIconParameter(){return this._icon}_Clone(){return Jl.New(Jl.IconFragment,{icon:this._icon,styles:this._styles,width:this._width,height:this._height,fontBoundingBoxAscent:this._fontBoundingBoxAscent,fontBoundingBoxDescent:this._fontBoundingBoxDescent,topToAlphabeticDistance:this._topToAlphabeticDistance})}GetTextIcon(t){if(!t)return null;let e=Number(this._icon);return String(e)===this._icon?(e=Math.floor(e),t.GetTextIconByIndex(e)):t.GetTextIconByTag(this._icon)}CalculateWidthFromHeight(t){const e=this.GetTextIcon(t);this._width=e?this._height*e.GetWidth()/e.GetHeight():0}GetDrawable(t){const e=this.GetTextIcon(t);return e?e.GetDrawable():null}GetLength(){return 1}}}{const Ql=self.C3;Ql.TextIconManager=class{constructor(t){this._iconSets=new Map,this._getIconSetMetaCallback=t.getIconSetMeta,this._getIconSetContentCallback=t.getIconSetContent}Release(){for(const t of this._iconSets.values())t.Release();this._iconSets.clear()}GetIconSet(t){let e=this._iconSets.get(t);if(e)return e;const s=this._getIconSetMetaCallback(t);return e=Ql.New(Ql.TextIconSet,this,{source:t,iconMeta:s}),this._iconSets.set(t,e),e}HasIconSet(t){return this._iconSets.has(t)}DeleteIconSet(t){const e=this._iconSets.get(t);e&&e.Release(),this._iconSets.delete(t)}async _GetIconSetContent(t){return await this._getIconSetContentCallback(t)}}}{const Kl=self.C3;Kl.TextIconSet=class{constructor(t,e){this._textIconManager=t,this._source=e.source,this._iconsArray=[],this._iconsByTag=new Map,this._hasStartedLoad=!1,this._isLoading=!1,this._loadPromise=null;const s=e.iconMeta.icons;for(let t=0,e=s.length;t<e;++t){const e=s[t],i=Kl.New(Kl.TextIcon,this,{index:t,tag:e.tag,source:e.source,width:e.width,height:e.height});this._iconsArray.push(i),e.tag&&this._iconsByTag.set(e.tag.toLowerCase(),i)}}Release(){for(const t of this._iconsArray)t.Release();Kl.clearArray(this._iconsArray),this._iconsByTag.clear(),this._textIconManager=null,this._source=null}HasLoaded(){return this._hasStartedLoad}IsLoading(){return this._isLoading}LoadContent(){return this._loadPromise||(this._loadPromise=this._DoLoadContent()),this._loadPromise}async _DoLoadContent(){if(this._hasStartedLoad)return;this._hasStartedLoad=!0,this._isLoading=!0;const t=await this._textIconManager._GetIconSetContent(this._source);if(!this._textIconManager)return;const e=t.icons;for(let t=0,s=Math.min(e.length,this._iconsArray.length);t<s;++t){const s=e[t].drawable;this._iconsArray[t]._SetDrawable(s)}this._isLoading=!1}GetTextIconByIndex(t){return(t=Math.floor(t))<0||t>=this._iconsArray.length?null:this._iconsArray[t]}GetTextIconByTag(t){return this._iconsByTag.get(t.toLowerCase())||null}}}self.C3.TextIcon=class{constructor(t,e){this._textIconSet=t,this._source=e.source||null,this._index=e.index,this._tag=e.tag,this._width=e.width,this._height=e.height,this._drawable=null}Release(){this._width=0,this._height=0,this._textIconSet=null}GetSource(){return this._source}GetWidth(){return this._width}GetHeight(){return this._height}_SetDrawable(t){this._drawable=t}GetDrawable(){return this._drawable}};{let Zl=function(t,e,s,i){const r=hc;ic.subtract(ac,s,e),ic.subtract(oc,t,e),ic.cross(r,ac,oc),ic.normalize(r,r),i.set(r[0],r[1],r[2],ic.dot(t,r))},$l=function(t,e,s,i,r,n,a){const o=a.x,h=a.y,l=a.z,c=a.w,u=a.xF,_=a.yF,d=a.zF,p=1-u,f=1-_,g=1-d;return o*t*u+o*i*p+h*e*_+h*r*f+l*s*d+l*n*g>=c||o*i*u+o*t*p+h*r*_+h*e*f+l*n*d+l*s*g>c},tc=function(t,e,s,i){return i.x*t+i.y*e+i.z*s>=i.w};0;const ec=self.C3,sc=self.glMatrix,ic=sc.vec3,rc=sc.vec4,nc=sc.mat4,ac=ic.create(),oc=ic.create(),hc=ic.create(),lc=rc.create(),cc=nc.create(),uc=ic.create(),_c=ic.create(),dc=ic.create(),pc=ic.create(),fc=ic.create(),gc=ic.create(),mc=ic.create(),Sc=ic.create(),yc=rc.fromValues(0,0,1,1);ec.Gfx={Project(t,e,s,i,r,n,a){const o=i[0]*t+i[4]*e+i[8]*s+i[12],h=i[1]*t+i[5]*e+i[9]*s+i[13],l=i[2]*t+i[6]*e+i[10]*s+i[14],c=i[3]*t+i[7]*e+i[11]*s+i[15];let u=r[0]*o+r[4]*h+r[8]*l+r[12]*c,_=r[1]*o+r[5]*h+r[9]*l+r[13]*c,d=r[2]*o+r[6]*h+r[10]*l+r[14]*c,p=r[3]*o+r[7]*h+r[11]*l+r[15]*c;return 0!==p&&(p=1/p,u*=p,_*=p,d*=p,a[0]=(.5*u+.5)*n[2]+n[0],a[1]=(.5*_+.5)*n[3]+n[1],a[2]=.5*(1+d),!0)},Unproject(t,e,s,i,r,n,a){const o=cc,h=lc;return nc.multiply(o,r,i),null!==nc.invert(o,o)&&(h[0]=(t-n[0])/n[2]*2-1,h[1]=(e-n[1])/n[3]*2-1,h[2]=2*s-1,h[3]=1,rc.transformMat4(h,h,o),0!==h[3]&&(h[3]=1/h[3],a[0]=h[0]*h[3],a[1]=h[1]*h[3],a[2]=h[2]*h[3],!0))},UnprojectScreenToWorldZ(t,e,s,i,r,n,a){const o=ac,h=oc;if(!ec.Gfx.Unproject(t,e,0,i,r,n,o))return!1;if(!ec.Gfx.Unproject(t,e,1,i,r,n,h))return!1;const l=oc;ic.subtract(l,h,o);const c=hc;ic.set(c,0,0,1);const u=-s,_=ic.dot(c,l);let d=0;if(0===_){if(0!==ic.dot(c,o)+u)return!1}else if(d=-(ic.dot(o,c)+u)/_,d<0)return!1;return ic.scaleAndAdd(a,o,l,d),!0}};class Gc{constructor(){this.x=NaN,this.y=NaN,this.z=NaN,this.w=NaN,this.xF=NaN,this.yF=NaN,this.zF=NaN}set(t,e,s,i){this.x=t,this.y=e,this.z=s,this.w=i,this.xF=t>0?1:0,this.yF=e>0?1:0,this.zF=s>0?1:0}}ec.Gfx.ViewFrustum=class{constructor(){this._leftP=new Gc,this._topP=new Gc,this._rightP=new Gc,this._bottomP=new Gc,this._nearP=new Gc,this._farP=new Gc}CalculatePlanes(t,e){const s=yc;ec.Gfx.Unproject(0,1,0,t,e,s,uc),ec.Gfx.Unproject(1,1,0,t,e,s,_c),ec.Gfx.Unproject(0,0,0,t,e,s,dc),ec.Gfx.Unproject(1,0,0,t,e,s,pc),ec.Gfx.Unproject(0,1,1,t,e,s,fc),ec.Gfx.Unproject(1,1,1,t,e,s,gc),ec.Gfx.Unproject(0,0,1,t,e,s,mc),ec.Gfx.Unproject(1,0,1,t,e,s,Sc),Zl(dc,uc,fc,this._leftP),Zl(uc,_c,gc,this._topP),Zl(_c,pc,Sc,this._rightP),Zl(pc,dc,mc,this._bottomP),Zl(mc,fc,gc,this._farP),Zl(pc,_c,uc,this._nearP)}ContainsAABB(t,e,s,i,r,n){return $l(t,e,s,i,r,n,this._leftP)&&$l(t,e,s,i,r,n,this._topP)&&$l(t,e,s,i,r,n,this._rightP)&&$l(t,e,s,i,r,n,this._bottomP)&&$l(t,e,s,i,r,n,this._nearP)&&$l(t,e,s,i,r,n,this._farP)}IsBehindNearPlane(t,e,s){return!tc(t,e,s,this._nearP)}}}{const Tc=self.C3,Ic=self.glMatrix,Cc=Ic.vec3,bc=Ic.vec4,xc=Ic.mat4,wc=xc.create(),Mc=Cc.fromValues(0,0,0),Pc=Cc.fromValues(0,0,0),vc=Cc.fromValues(0,0,0),Rc=Cc.fromValues(0,1,0),Ac=(bc.fromValues(0,0,0,0),new Tc.Quad),Dc=new Tc.Rect,Ec=new Tc.Quad(0,0,1,0,1,1,0,1),Fc={nearZ:1,farZ:1e4},Oc=xc.fromValues(1,0,0,0,0,1,0,0,0,0,.5,0,0,0,.5,1);Tc.Gfx.RendererBase=class{constructor(t){t=Object.assign({},Fc,t),this._width=0,this._height=0,this._fovY=Tc.toRadians(45),this._tan_fovY_2=Math.tan(this._fovY/2),this._matP=xc.create(),this._matMV=xc.create(),this._zAxisScale=!1,this._nearZ=t.nearZ,this._farZ=t.farZ,this._allShaderPrograms=[],this._shaderProgramsByName=new Map,this._spTextureFill=null,this._spPoints=null,this._spTilemapFill=null,this._spTileRandomization=null,this._spColorFill=null,this._spLinearGradientFill=null,this._spPenumbraFill=null,this._spHardEllipseFill=null,this._spHardEllipseOutline=null,this._spSmoothEllipseFill=null,this._spSmoothEllipseOutline=null,this._spSmoothLineFill=null,this._stateGroups=new Map,this._currentStateGroup=null,this._blendModeTable=[],this._namedBlendModeMap=new Map,this._baseZ=0,this._currentZ=0,this._lineWidth=1,this._lineWidthStack=[this._lineWidth],this._lineCap=1,this._lineCapStack=[this._lineCap],this._lineOffset=.5,this._lineOffsetStack=[this._lineOffset],this._frameNumber=0,this._enableMipmaps=!0,this._hasMajorPerformanceCaveat=!1}_ClearState(){this._baseZ=0,this._currentZ=0,this._spTextureFill=null,this._spPoints=null,this._spTilemapFill=null,this._spTileRandomization=null,this._spColorFill=null,this._spLinearGradientFill=null,this._spPenumbraFill=null,this._spHardEllipseFill=null,this._spHardEllipseOutline=null,this._spSmoothEllipseFill=null,this._spSmoothEllipseOutline=null,this._spSmoothLineFill=null,this._ClearAllShaderPrograms()}InitState(){this._ClearState(),this._currentStateGroup=null}OnDeviceOrContextLost(){for(const t of this._allShaderPrograms)t.Release();this._ClearState()}GetWidth(){return this._width}GetHeight(){return this._height}GetDefaultCameraZ(t){return this.IsZAxisScaleNormalized()?100:t/(2*this._GetTanFovYDiv2())}GetZAxisScaleFactor(t){return this.IsZAxisScaleNormalized()?t/(2*this._GetTanFovYDiv2())/this.GetDefaultCameraZ(t):1}SetNearZ(t){this._nearZ=t}GetNearZ(){return this._nearZ}SetFarZ(t){this._farZ=t}GetFarZ(){return this._farZ}SetFovY(t){this._fovY=t,this._tan_fovY_2=Math.tan(this._fovY/2)}GetFovY(){return this._fovY}_GetTanFovYDiv2(){return this._tan_fovY_2}SetZAxisScaleNormalized(){this._zAxisScale=!1}SetZAxisScaleRegular(){this._zAxisScale=!0}IsZAxisScaleNormalized(){return!this._zAxisScale}IsZAxisScaleRegular(){return this._zAxisScale}CalculatePerspectiveMatrix(t,e,s=.5,i=.5){const r=this.GetNearZ(),n=this.GetFarZ(),a=this.GetFovY();if(.5===s&&.5===i)this.IsWebGPU()?xc.perspectiveZO(t,a,e,r,n):xc.perspective(t,a,e,r,n);else{const a=2*(s=1-s)-2,o=2*s,h=2*i-2,l=2*i,c=this._GetTanFovYDiv2()*r,u=c*e;xc.frustum(t,a*u,o*u,h*c,l*c,r,n),this.IsWebGPU()&&xc.mul(t,Oc,t)}}CalculateOrthographicMatrix(t,e,s,i=1){const r=self.devicePixelRatio,n=2*this.GetDefaultCameraZ(s)*r*this._GetTanFovYDiv2()/s,a=e*n/(2*r*i),o=s*n/(2*r*i),h=-a,l=a,c=-o,u=o;this.IsWebGPU()?xc.orthoZO(t,h,l,c,u,this.GetNearZ(),this.GetFarZ()):xc.ortho(t,h,l,c,u,this.GetNearZ(),this.GetFarZ())}CalculateLookAtModelView(t,e,s,i,r,n=1){let a=1;this.IsZAxisScaleNormalized()&&(a=200*this._GetTanFovYDiv2()/r);const o=vc;Cc.set(o,a,-a,1);const h=Mc,l=Pc;Cc.multiply(h,e,o),Cc.multiply(l,s,o),xc.lookAt(t,h,l,i||Rc),o[2]=n,xc.scale(t,t,o)}CalculateLookAtModelView2(t,e,s,i,r,n,a,o){return Cc.set(Mc,t,e,s),Cc.set(Pc,i,r,n),this.CalculateLookAtModelView(wc,Mc,Pc,Rc,a,o),wc}_AddShaderProgram(t){this._allShaderPrograms.push(t),this._shaderProgramsByName.set(t.GetName(),t)}_RemoveShaderProgram(t){const e=this._allShaderPrograms.indexOf(t);-1!==e&&this._allShaderPrograms.splice(e,1),this._shaderProgramsByName.delete(t.GetName())}_ClearAllShaderPrograms(){Tc.clearArray(this._allShaderPrograms),this._shaderProgramsByName.clear()}GetShaderProgramByName(t){return this._shaderProgramsByName.get(t)||null}GetTextureFillShaderProgram(){return this._spTextureFill}SetTextureFillMode(){this.SetProgram(this._spTextureFill)}GetPointsRenderingProgram(){return this._spPoints}SetPointsRenderingProgram(){this.SetProgram(this._spPoints)}SetTilemapFillMode(){this.SetProgram(this._spTilemapFill)}SetTileRandomizationMode(){this.SetProgram(this._spTileRandomization)}SetColorFillMode(){this.SetProgram(this._spColorFill)}SetLinearGradientFillMode(){this.SetProgram(this._spLinearGradientFill)}SetPenumbraFillMode(){this.SetProgram(this._spPenumbraFill)}SetHardEllipseFillMode(){this.SetProgram(this._spHardEllipseFill)}SetHardEllipseOutlineMode(){this.SetProgram(this._spHardEllipseOutline)}SetSmoothEllipseFillMode(){this.SetProgram(this._spSmoothEllipseFill)}SetSmoothEllipseOutlineMode(){this.SetProgram(this._spSmoothEllipseOutline)}SetSmoothLineFillMode(){this.SetProgram(this._spSmoothLineFill)}_SetCurrentStateGroup(t){this._currentStateGroup=t}GetCurrentStateGroup(){return this._currentStateGroup}AcquireStateGroup(t,e,s,i,r,n){const a=Tc.Gfx.StateGroup.MakeKey(t,e,s,i,r,n);let o=this._stateGroups.get(a);return o||(o=Tc.New(Tc.Gfx.StateGroup,this,t,e,s,i,r,n),this._stateGroups.set(a,o)),o.AddRef(),o}ReleaseStateGroup(t){t.DecRef(),0===t._GetRefCount()&&(this._currentStateGroup===t&&(this._currentStateGroup=null),this._stateGroups.delete(t.GetKey()),t.Release())}_InitBlendModeData(t){Tc.clearArray(this._blendModeTable),this._namedBlendModeMap.clear();let e=0;for(const s of t){const t=s[0],i=s[1];this._blendModeTable.push(i),this._namedBlendModeMap.set(t,e),e++}}_GetBlendParametersByIndex(t){return this._blendModeTable[t]}NamedBlendToNumber(t){const e=this._namedBlendModeMap.get(t);if(void 0===e)throw new Error("invalid blend name");return e}SetBaseZ(t){this._baseZ=t}GetBaseZ(){return this._baseZ}SetCurrentZ(t){this._currentZ=t,this._currentStateGroup=null}GetCurrentZ(){return this._currentZ}Line(t,e,s,i){const r=Tc.angleTo(t,e,s,i),n=Math.sin(r),a=Math.cos(r),o=.5*this._lineWidth,h=n*o,l=a*o,c=this._lineCap;2===c?this.LinePreCalc_LineCap2(t,e,0,s,i,0,h,l):1===c?this.LinePreCalc_LineCap1(t,e,0,s,i,0,h,l):this.LinePreCalc_LineCap0(t,e,0,s,i,0,h,l)}Line3D(t,e,s,i,r,n){const a=Tc.angleTo(t,e,i,r),o=Math.sin(a),h=Math.cos(a),l=.5*this._lineWidth,c=o*l,u=h*l,_=this._lineCap;2===_?this.LinePreCalc_LineCap2(t,e,s,i,r,n,c,u):1===_?this.LinePreCalc_LineCap1(t,e,s,i,r,n,c,u):this.LinePreCalc_LineCap0(t,e,s,i,r,n,c,u)}LinePreCalc_LineCap2(t,e,s,i,r,n,a,o){const h=this._lineOffset,l=t+h-o,c=e+h-a,u=i+h+o,_=r+h+a,d=2*o,p=2*a,f=l+a,g=c-o,m=l-a+d,S=c+o+p,y=u+a,G=_-o,T=u-a-d,I=_+o-p;this.Quad3D2(f,g,s,y,G,n,T,I,n,m,S,s,Ec)}LinePreCalc_LineCap1(t,e,s,i,r,n,a,o){const h=this._lineOffset,l=t+h-o,c=e+h-a,u=i+h+o,_=r+h+a,d=l+a,p=c-o,f=l-a,g=c+o,m=u+a,S=_-o,y=u-a,G=_+o;this.Quad3D2(d,p,s,m,S,n,y,G,n,f,g,s,Ec)}LinePreCalc_LineCap0(t,e,s,i,r,n,a,o){const h=this._lineOffset,l=t+h,c=e+h,u=i+h,_=r+h,d=l+a,p=c-o,f=l-a,g=c+o,m=u+a,S=_-o,y=u-a,G=_+o;this.Quad3D2(d,p,s,m,S,n,y,G,n,f,g,s,Ec)}TexturedLine(t,e,s,i,r,n){const a=Tc.angleTo(t,e,s,i),o=Math.sin(a),h=Math.cos(a),l=.5*this._lineWidth,c=o*l,u=h*l,_=this._lineCap;2===_?this.TexturedLinePreCalc_LineCap2(t,e,s,i,c,u,r,n):1===_?this.TexturedLinePreCalc_LineCap1(t,e,s,i,c,u,r,n):this.TexturedLinePreCalc_LineCap0(t,e,s,i,c,u,r,n)}TexturedLinePreCalc_LineCap2(t,e,s,i,r,n,a,o){const h=this._lineOffset,l=t+h-n,c=e+h-r,u=s+h+n,_=i+h+r,d=2*n,p=2*r,f=l+r,g=c-n,m=l-r+d,S=c+n+p,y=u+r,G=_-n,T=u-r-d,I=_+n-p;Ac.set(f,g,y,G,T,I,m,S),Dc.set(a,0,o,0),this.Quad3(Ac,Dc)}TexturedLinePreCalc_LineCap1(t,e,s,i,r,n,a,o){const h=this._lineOffset,l=t+h-n,c=e+h-r,u=s+h+n,_=i+h+r,d=l+r,p=c-n,f=l-r,g=c+n,m=u+r,S=_-n,y=u-r,G=_+n;Ac.set(d,p,m,S,y,G,f,g),Dc.set(a,0,o,0),this.Quad3(Ac,Dc)}TexturedLinePreCalc_LineCap0(t,e,s,i,r,n,a,o){const h=this._lineOffset,l=t+h,c=e+h,u=s+h,_=i+h,d=l+r,p=c-n,f=l-r,g=c+n,m=u+r,S=_-n,y=u-r,G=_+n;Ac.set(d,p,m,S,y,G,f,g),Dc.set(a,0,o,0),this.Quad3(Ac,Dc)}LineRect(t,e,s,i){const r=.5*this._lineWidth,n=this._lineCap;2===n?this._LineRectPreCalc_LineCap2(t,e,s,i,r):1===n?this._LineRectPreCalc_LineCap1(t,e,s,i,r):this._LineRectPreCalc_LineCap0(t,e,s,i,r)}_LineRectPreCalc_LineCap2(t,e,s,i,r){this.LinePreCalc_LineCap2(t,e,0,s,e,0,0,r),this.LinePreCalc_LineCap2(s,e,0,s,i,0,r,0),this.LinePreCalc_LineCap2(s,i,0,t,i,0,0,-r),this.LinePreCalc_LineCap2(t,i,0,t,e,0,-r,0)}_LineRectPreCalc_LineCap1(t,e,s,i,r){this.LinePreCalc_LineCap1(t,e,0,s,e,0,0,r),this.LinePreCalc_LineCap1(s,e,0,s,i,0,r,0),this.LinePreCalc_LineCap1(s,i,0,t,i,0,0,-r),this.LinePreCalc_LineCap1(t,i,0,t,e,0,-r,0)}_LineRectPreCalc_LineCap0(t,e,s,i,r){this.LinePreCalc_LineCap0(t,e,0,s,e,0,0,r),this.LinePreCalc_LineCap0(s,e,0,s,i,0,r,0),this.LinePreCalc_LineCap0(s,i,0,t,i,0,0,-r),this.LinePreCalc_LineCap0(t,i,0,t,e,0,-r,0)}LineRect2(t){this.LineRect(t.getLeft(),t.getTop(),t.getRight(),t.getBottom())}LineQuad(t){const e=Tc.angleTo(t.getTlx(),t.getTly(),t.getTrx(),t.getTry()),s=Math.sin(e),i=Math.cos(e),r=.5*this._lineWidth,n=s*r,a=i*r,o=this._lineCap;2===o?this._LineQuadPreCalc_LineCap2(t,n,a):1===o?this._LineQuadPreCalc_LineCap1(t,n,a):this._LineQuadPreCalc_LineCap0(t,n,a)}_LineQuadPreCalc_LineCap2(t,e,s){this.LinePreCalc_LineCap2(t.getTlx(),t.getTly(),0,t.getTrx(),t.getTry(),0,e,s),this.LinePreCalc_LineCap2(t.getTrx(),t.getTry(),0,t.getBrx(),t.getBry(),0,s,-e),this.LinePreCalc_LineCap2(t.getBrx(),t.getBry(),0,t.getBlx(),t.getBly(),0,-e,-s),this.LinePreCalc_LineCap2(t.getBlx(),t.getBly(),0,t.getTlx(),t.getTly(),0,-s,e)}_LineQuadPreCalc_LineCap1(t,e,s){this.LinePreCalc_LineCap1(t.getTlx(),t.getTly(),0,t.getTrx(),t.getTry(),0,e,s),this.LinePreCalc_LineCap1(t.getTrx(),t.getTry(),0,t.getBrx(),t.getBry(),0,s,-e),this.LinePreCalc_LineCap1(t.getBrx(),t.getBry(),0,t.getBlx(),t.getBly(),0,-e,-s),this.LinePreCalc_LineCap1(t.getBlx(),t.getBly(),0,t.getTlx(),t.getTly(),0,-s,e)}_LineQuadPreCalc_LineCap0(t,e,s){this.LinePreCalc_LineCap0(t.getTlx(),t.getTly(),0,t.getTrx(),t.getTry(),0,e,s),this.LinePreCalc_LineCap0(t.getTrx(),t.getTry(),0,t.getBrx(),t.getBry(),0,s,-e),this.LinePreCalc_LineCap0(t.getBrx(),t.getBry(),0,t.getBlx(),t.getBly(),0,-e,-s),this.LinePreCalc_LineCap0(t.getBlx(),t.getBly(),0,t.getTlx(),t.getTly(),0,-s,e)}SetLineWidth(t){this._lineWidth=t,this._lineWidthStack[this._lineWidthStack.length-1]=t}GetLineWidth(){return this._lineWidth}PushLineWidth(t){if(this._lineWidthStack.length>=100)throw new Error("pushed too many line widths - check push/pop pairs");this._lineWidthStack.push(t),this._lineWidth=t}PopLineWidth(){if(this._lineWidthStack.length<=1)throw new Error("cannot pop last line width - check push/pop pairs");this._lineWidthStack.pop(),this._lineWidth=this._lineWidthStack.at(-1)}SetLineCapButt(){this._lineCap=0,this._lineCapStack[this._lineCapStack.length-1]=0}SetLineCapSquare(){this._lineCap=1,this._lineCapStack[this._lineCapStack.length-1]=0}SetLineCapZag(){this._lineCap=2,this._lineCapStack[this._lineCapStack.length-1]=0}PushLineCap(t){if("butt"===t)this.PushLineCapButt();else if("square"===t)this.PushLineCapSquare();else{if("zag"!==t)throw new Error("invalid line cap");this.PushLineCapZag()}}PushLineCapButt(){if(this._lineCapStack.length>=100)throw new Error("pushed too many line caps - check push/pop pairs");this._lineCapStack.push(0),this._lineCap=0}PushLineCapSquare(){if(this._lineCapStack.length>=100)throw new Error("pushed too many line caps - check push/pop pairs");this._lineCapStack.push(1),this._lineCap=1}PushLineCapZag(){if(this._lineCapStack.length>=100)throw new Error("pushed too many line caps - check push/pop pairs");this._lineCapStack.push(2),this._lineCap=2}PopLineCap(){if(this._lineCapStack.length<=1)throw new Error("cannot pop last line cap - check push/pop pairs");this._lineCapStack.pop(),this._lineCap=this._lineCapStack.at(-1)}SetLineOffset(t){this._lineOffset=t,this._lineOffsetStack[this._lineOffsetStack.length-1]=t}GetLineOffset(){return this._lineOffset}PushLineOffset(t){if(this._lineOffsetStack.length>=100)throw new Error("pushed too many line offsets - check push/pop pairs");this._lineOffsetStack.push(t),this._lineOffset=t}PopLineOffset(){if(this._lineOffsetStack.length<=1)throw new Error("cannot pop last line offset - check push/pop pairs");this._lineOffsetStack.pop(),this._lineOffset=this._lineOffsetStack.at(-1)}ResetCullState(){this.SetCullFaceMode(0),this.SetFrontFaceWinding(0)}ConvexPoly(t){const e=t.length/2;if(e<3)throw new Error("need at least 3 points");const s=e-2,i=s-1,r=t[0],n=t[1];for(let e=0;e<s;e+=2){const s=2*e,a=t[s+2],o=t[s+3],h=t[s+4],l=t[s+5];if(e===i)this.Quad2(r,n,a,o,h,l,h,l);else{const e=t[s+6],i=t[s+7];this.Quad2(r,n,a,o,h,l,e,i)}}}Finish(){this.EndBatch(!0),this._frameNumber++}GetFrameNumber(){return this._frameNumber}IncrementFrameNumber(){this._frameNumber++}SetMipmapsEnabled(t){this._enableMipmaps=!!t}AreMipmapsEnabled(){return this._enableMipmaps}SetHasMajorPerformanceCaveat(t){this._hasMajorPerformanceCaveat=!!t}HasMajorPerformanceCaveat(){return this._hasMajorPerformanceCaveat}IsWebGL(){return!1}IsWebGPU(){return!1}GetEstimatedBackBufferMemoryUsage(){}GetEstimatedRenderBufferMemoryUsage(){}GetEstimatedTextureMemoryUsage(){}GetEstimatedTotalMemoryUsage(){return this.GetEstimatedBackBufferMemoryUsage()+this.GetEstimatedRenderBufferMemoryUsage()+this.GetEstimatedTextureMemoryUsage()}CreateRendererText(){return Tc.New(Tc.Gfx.RendererText,this)}}}self.C3.Gfx.ShaderProgramBase=class{constructor(t,e){this._name=e.name,this._renderer=t,this._extendBoxHorizontal=e.extendBoxHorizontal||0,this._extendBoxVertical=e.extendBoxVertical||0,this._crossSampling=!!e.crossSampling,this._mustPreDraw=!!e.mustPreDraw,this._preservesOpaqueness=!!e.preservesOpaqueness,this._supports3dDirectRendering=!!e.supports3dDirectRendering,this._animated=!!e.animated,this._blendsBackground=!!e.blendsBackground,this._usesDepth=!!e.usesDepth,this._usesAnySrcRectOrPixelSize=!1,this._needsPostDrawOrExtendBox=this._crossSampling||this._blendsBackground||0!==this._extendBoxHorizontal||0!==this._extendBoxVertical}Release(){this._renderer=null}GetRenderer(){return this._renderer}GetName(){return this._name}ExtendsBox(){return 0!==this._extendBoxHorizontal||0!==this._extendBoxVertical}GetBoxExtendHorizontal(){return this._extendBoxHorizontal}GetBoxExtendVertical(){return this._extendBoxVertical}UsesCrossSampling(){return this._crossSampling}MustPreDraw(){return this._mustPreDraw}PreservesOpaqueness(){return this._preservesOpaqueness}Supports3DDirectRendering(){return this._supports3dDirectRendering}IsAnimated(){return this._animated}BlendsBackground(){return this._blendsBackground}UsesDepth(){return this._usesDepth}UsesAnySrcRectOrPixelSize(){return this._usesAnySrcRectOrPixelSize}NeedsPostDrawOrExtendsBox(){return this._needsPostDrawOrExtendBox}UsesIsSrcTexRotated(){return!1}};{const Bc=self.C3;Bc.Gfx.StateGroup=class{constructor(t,e,s,i,r,n,a){this._renderer=t,this._refCount=0,this._shaderProgram=null,this._shaderProgramName="",this._blendMode=s,this._color=Bc.New(Bc.Color),this._color.set(i),this._zElevation=r,this._cullFaceMode=n,this._frontFaceWinding=a,"string"==typeof e?this._shaderProgramName=e:(this._shaderProgram=e,this._shaderProgramName=this._shaderProgram.GetName())}Release(){if(this._refCount>0)throw new Error("releasing state group still in use");this._renderer=null,this._shaderProgram=null,this._shaderProgramName=""}Apply(){const t=this._renderer;t.SetProgram(this._shaderProgram),t.SetBlendMode(this._blendMode),t.SetColor(this._color),t.SetCurrentZ(this._zElevation),t.SetCullFaceMode(this._cullFaceMode),t.SetFrontFaceWinding(this._frontFaceWinding),t._SetCurrentStateGroup(this)}GetKey(){return Bc.Gfx.StateGroup.MakeKey(this._shaderProgramName,this._blendMode,this._color,this._zElevation,this._cullFaceMode,this._frontFaceWinding)}AddRef(){++this._refCount}DecRef(){--this._refCount}_GetRefCount(){return this._refCount}OnContextLost(){this._shaderProgram=null}OnContextRestored(t){if(this._shaderProgram=t.GetShaderProgramByName(this._shaderProgramName),!this._shaderProgram)throw new Error("failed to restore shader program")}static MakeKey(t,e,s,i,r,n){return("string"==typeof t?t:t.GetName())+","+e+","+s.getR()+","+s.getG()+","+s.getB()+","+s.getA()+","+i+","+r+","+n}}}{let Lc=function(t,e,s){const i=s.getTlx(),r=s.getTly(),n=s.getTrx()-i,a=s.getTry()-r;return[i+n*t+(s.getBlx()-i)*e,r+a*t+(s.getBly()-r)*e]};0;const kc=globalThis.C3;globalThis.assert;kc.Gfx.MeshPoint=class{constructor(t,e,s){this._mesh=t,this._col=e,this._row=s,this._x=NaN,this._y=NaN,this._zElevation=NaN,this._u=NaN,this._v=NaN,this._x=0,this._y=0,this._zElevation=0,this._u=0,this._v=0}_Init(t,e,s,i){this._x=t,this._y=e,this._u=s,this._v=i}GetX(){return this._x}SetX(t){this._x!==t&&(this._x=t,this._mesh._SetPointsChanged())}GetY(){return this._y}SetY(t){this._y!==t&&(this._y=t,this._mesh._SetPointsChanged())}GetZElevation(){return this._zElevation}SetZElevation(t){this._zElevation!==t&&(this._zElevation=Math.max(t,0),this._mesh._SetPointsChanged())}GetU(){return this._u}SetU(t){this._u=t}GetV(){return this._v}SetV(t){this._v=t}_Interpolate_TexRect(t,e,s){[this._x,this._y]=Lc(t._x,t._y,e),this._zElevation=t._zElevation,this._u=kc.lerp(s.getLeft(),s.getRight(),t._u),this._v=kc.lerp(s.getTop(),s.getBottom(),t._v)}_Interpolate_TexQuad(t,e,s){[this._x,this._y]=Lc(t._x,t._y,e),this._zElevation=t._zElevation,[this._u,this._v]=Lc(t._u,t._v,s)}SaveToJson(){return{x:this.GetX(),y:this.GetY(),z:this.GetZElevation(),u:this.GetU(),v:this.GetV()}}LoadFromJson(t){this.SetX(t.x),this.SetY(t.y),t.hasOwnProperty("z")&&this.SetZElevation(t.z),this.SetU(t.u),this.SetV(t.v)}GetMesh(){return this._mesh}GetColumn(){return this._col}GetRow(){return this._row}},kc.Gfx.Mesh=class{constructor(t,e,s){if(t<2||e<2)throw new Error("invalid mesh size");this._hsize=t,this._vsize=e,this._owner=s||null,this._pts=[],this._minX=0,this._minY=0,this._maxX=1,this._maxY=1,this._maxZ=0,this._bboxChanged=!1,this._meshChunks=[],this._lastZOffset=0,this._dataArrsChanged=!0;const i=t-1,r=e-1;for(let s=0;s<e;++s){const e=[];for(let n=0;n<t;++n){const t=kc.New(kc.Gfx.MeshPoint,this,n,s),a=n/i,o=s/r;t._Init(a,o,a,o),e.push(t)}this._pts.push(e)}}Release(){kc.clearArray(this._pts),kc.clearArray(this._meshChunks)}GetHSize(){return this._hsize}GetVSize(){return this._vsize}GetOwner(){return this._owner}_GetPoints(){return this._pts}_SetPointsChanged(){this._bboxChanged=!0,this._dataArrsChanged=!0}_MaybeComputeBounds(){if(!this._bboxChanged)return;let t=1/0,e=1/0,s=-1/0,i=-1/0,r=0;for(const n of this._pts)for(const a of n){const n=a.GetX(),o=a.GetY();t=Math.min(t,n),e=Math.min(e,o),s=Math.max(s,n),i=Math.max(i,o),r=Math.max(r,a.GetZElevation())}this._minX=t,this._minY=e,this._maxX=s,this._maxY=i,this._maxZ=r,this._bboxChanged=!1}GetMinX(){return this._MaybeComputeBounds(),this._minX}GetMinY(){return this._MaybeComputeBounds(),this._minY}GetMaxX(){return this._MaybeComputeBounds(),this._maxX}GetMaxY(){return this._MaybeComputeBounds(),this._maxY}GetMaxZ(){return this._MaybeComputeBounds(),this._maxZ}HasAnyZElevation(){return this.GetMaxZ()>0}GetMeshPointAt(t,e){return t=Math.floor(t),e=Math.floor(e),t<0||t>=this._hsize||e<0||e>=this._vsize?null:this._pts[e][t]}CalculateTransformedMesh(t,e,s){const i=s instanceof kc.Rect;if(t.GetHSize()!==this.GetHSize()||t.GetVSize()!==this.GetVSize())throw new Error("source mesh wrong size");const r=t._pts,n=this._pts;for(let t=0,a=n.length;t<a;++t){const a=r[t],o=n[t];for(let t=0,r=o.length;t<r;++t){const r=a[t],n=o[t];i?n._Interpolate_TexRect(r,e,s):n._Interpolate_TexQuad(r,e,s)}}this._dataArrsChanged=!0}_MaybeUpdateDataArrays(t){if(!this._dataArrsChanged&&this._lastZOffset===t)return;const e=this._hsize,s=this._vsize,i=this._meshChunks,r=Math.floor(65535/e)-1;if(r<=0)throw new Error("mesh too large");const n=Math.ceil((s-1)/r);n<i.length&&(i.length=n);let a=0;for(let o=0;o<n;++o){const n=Math.min(r,s-a-1),h=(n+1)*e,l=3*h,c=2*h,u=(e-1)*n*6;if(o===i.length)i.push({posArr:new Float32Array(l),uvArr:new Float32Array(c),indexArr:new Uint16Array(u)});else{const t=i[o];t.posArr.length!==l&&(t.posArr=new Float32Array(l)),t.uvArr.length!==c&&(t.uvArr=new Float32Array(c)),t.indexArr.length!==u&&(t.indexArr=new Uint16Array(u))}const{posArr:_,uvArr:d,indexArr:p}=i[o];this._WriteChunkDataArrays(a,n,t,_,d,p),a+=r}this._lastZOffset=t,this._dataArrsChanged=!1}_WriteChunkDataArrays(t,e,s,i,r,n){const a=this._pts,o=this._hsize;let h=0,l=0,c=0;for(let u=t,_=t+e+1;u<_;++u){const e=a[u],d=u+1,p=u-t,f=p*o,g=(p+1)*o;for(let t=0,a=e.length;t<a;++t){const o=e[t],u=t+1;if(i[h++]=o.GetX(),i[h++]=o.GetY(),i[h++]=o.GetZElevation()+s,r[l++]=o.GetU(),r[l++]=o.GetV(),u<a&&d<_){const e=t+f,s=u+f,i=u+g,r=t+g;n[c++]=e,n[c++]=s,n[c++]=i,n[c++]=e,n[c++]=i,n[c++]=r}}}}Draw(t,e){this._MaybeUpdateDataArrays(e);for(const{posArr:e,uvArr:s,indexArr:i}of this._meshChunks)t.DrawMesh(e,s,i)}Outline(t,e){e||(e=(t,e,s)=>[t,e,s]);const s=this._pts;let i=s[0];for(let r=1,n=s.length;r<n;++r){const a=s[r];let o=i[0],h=a[0];for(let s=1,l=a.length;s<l;++s){const c=i[s],u=a[s],[_,d,p]=e(o.GetX(),o.GetY(),o.GetZElevation()),[f,g,m]=e(c.GetX(),c.GetY(),c.GetZElevation()),[S,y,G]=e(u.GetX(),u.GetY(),u.GetZElevation()),[T,I,C]=e(h.GetX(),h.GetY(),h.GetZElevation());t.Line3D(_,d,p,f,g,m),t.Line3D(_,d,p,S,y,G),t.Line3D(_,d,p,T,I,C),s===l-1&&t.Line3D(f,g,m,S,y,G),r===n-1&&t.Line3D(T,I,C,S,y,G),o=c,h=u}i=a}}InsertPolyMeshVertices(t){const e=.001,s=.99999999,i=t.pointsArr(),r=[],n=this.GetHSize()-1,a=this.GetVSize()-1,o=1/n,h=1/a,l=n-1,c=a-1;let u=i[0],_=i[1],d=kc.clamp(Math.floor(u*n),0,l),p=kc.clamp(Math.floor(_*a),0,c),f=!0,g=0,m=0,S=0,y=-1;const G=()=>{u=kc.clamp(kc.lerp(u,g,S),0,1),_=kc.clamp(kc.lerp(_,m,S),0,1),r.push(u,_)};for(let t=0,T=i.length;t<T;t+=2){u=i[t],_=i[t+1],r.push(u,_),d=kc.clamp(Math.floor(u*n),0,l),p=kc.clamp(Math.floor(_*a),0,c);const I=(t+2)%T;for(g=i[I],m=i[I+1],y=-1;;){if(r.length>1e6)throw new Error("Too many mesh poly points");const t=d*o,i=p*h,n=(d+1)*o,a=(p+1)*h;if(f=kc.isPointInTriangleInclusive(u,_,t,i,n,i,n,a),0!==y&&(S=kc.rayIntersectExtended(u,_,g,m,t,i,n,a,-.001),S>=0&&S<=s))G(),f=!f,y=0;else if(p>0&&2!==y&&(S=kc.rayIntersectExtended(u,_,g,m,t,i,n,i,e),S>=0&&S<=s))G(),p--,f=!1,y=4;else if(d<l&&3!==y&&(S=kc.rayIntersectExtended(u,_,g,m,n,i,n,a,e),S>=0&&S<=s))G(),d++,f=!1,y=1;else if(d>0&&1!==y&&(S=kc.rayIntersectExtended(u,_,g,m,t,i,t,a,e),S>=0&&S<=s))G(),d--,f=!0,y=3;else{if(!(p<c&&4!==y&&(S=kc.rayIntersectExtended(u,_,g,m,t,a,n,a,e),S>=0&&S<=s)))break;G(),p++,f=!0,y=2}}}return kc.New(kc.CollisionPoly,r)}TransformCollisionPoly(t,e){const s=this._TransformPolyPoints(t);this._SimplifyPoly(s),e.setPoints(s)}_TransformPolyPoints(t){const e=[],s=t.pointsArr();for(let t=0,i=s.length;t<i;t+=2){const i=s[t],r=s[t+1],[n,a]=this.TransformPoint(i,r);e.push(n,a)}return e}TransformPoint(t,e){const s=this.GetHSize()-1,i=this.GetVSize()-1,r=1/s,n=1/i,a=kc.clamp(Math.floor(t*s),0,s-1),o=kc.clamp(Math.floor(e*i),0,i-1),h=a*r,l=o*n,c=(a+1)*r,u=(o+1)*n,_=this.GetMeshPointAt(a,o),d=this.GetMeshPointAt(a+1,o+1),p=kc.isPointInTriangleInclusive(t,e,h,l,c,l,c,u),f=p?h+r:h,g=p?l:l+n,m=this.GetMeshPointAt(a+(p?1:0),o+(p?0:1)),[S,y,G]=kc.triangleCartesianToBarycentric(t,e,h,l,f,g,c,u);return kc.triangleBarycentricToCartesian3d(S,y,G,_.GetX(),_.GetY(),_.GetZElevation(),m.GetX(),m.GetY(),m.GetZElevation(),d.GetX(),d.GetY(),d.GetZElevation())}_SimplifyPoly(t){const e=[],s=1e-7;let i=t[0],r=t[1],n=i-t.at(-2),a=r-t.at(-1);for(let o=0,h=t.length;o<h;o+=2){const l=(o+2)%h,c=t[l],u=t[l+1],_=c-i,d=u-r,p=Math.abs(_)<s&&Math.abs(n)<s&&Math.sign(d)===Math.sign(a),f=Math.abs(d)<s&&Math.abs(a)<s&&Math.sign(_)===Math.sign(n);(!p&&!f&&Math.abs(_/n-d/a)>.001||0==_&&0===d)&&e.push(i,r),i=c,r=u,n=_,a=d}e.length>=6&&e.length<t.length&&kc.shallowAssignArray(t,e)}SaveToJson(){return{cols:this.GetHSize(),rows:this.GetVSize(),points:this._pts.map(t=>t.map(t=>t.SaveToJson()))}}LoadFromJson(t){const e=this.GetHSize(),s=this.GetVSize();if(t.cols!==e||t.rows!==s)throw new Error("mesh data wrong size");const i=t.points;for(let t=0;t<s;++t){const s=i[t];for(let i=0;i<e;++i)this.GetMeshPointAt(i,t).LoadFromJson(s[i])}}}}{let Nc=function(t,e){let s,i,r,n;switch(t){case"rgba8":s=e.RGBA8,i=e.RGBA,r=e.RGBA,n=e.UNSIGNED_BYTE;break;case"rgb8":s=e.RGB8,i=e.RGB,r=e.RGB,n=e.UNSIGNED_BYTE;break;case"rgba4":s=e.RGBA4,i=e.RGBA,r=e.RGBA,n=e.UNSIGNED_SHORT_4_4_4_4;break;case"rgb5_a1":s=e.RGB5_A1,i=e.RGBA,r=e.RGBA,n=e.UNSIGNED_SHORT_5_5_5_1;break;case"rgb565":s=e.RGB565,i=e.RGB,r=e.RGB,n=e.UNSIGNED_SHORT_5_6_5;break;default:throw new Error("invalid pixel format")}return{sizedinternalformat:s,internalformat:i,format:r,type:n}};0;const Uc=self.C3,Wc=new Set(["rgba8","rgb8","rgba4","rgb5_a1","rgb565"]),jc=new Set(["nearest","bilinear","trilinear"]),Vc=new Set(["default","low","high"]),zc=new Set(["clamp-to-edge","repeat","mirror-repeat"]),Hc={wrapX:"clamp-to-edge",wrapY:"clamp-to-edge",sampling:"trilinear",anisotropy:0,pixelFormat:"rgba8",mipMap:!0,mipMapQuality:"default",premultiplyAlpha:!0,isSvg:!1,width:-1,height:-1},Yc={premultiplyAlpha:!0,flipY:!1},Xc=new Set;Uc.Gfx.WebGLRendererTexture=class{constructor(t){this._renderer=t,this._texture=null,this._width=0,this._height=0,this._isStatic=!0,this._wrapX="clamp-to-edge",this._wrapY="clamp-to-edge",this._sampling="trilinear",this._anisotropy=0,this._pixelFormat="rgba8",this._isMipMapped=!1,this._mipMapQuality="default",this._refCount=0}_CreateStatic(t,e){if(!("undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap||"undefined"!=typeof OffscreenCanvas&&t instanceof OffscreenCanvas||t instanceof ImageData||t instanceof ArrayBuffer))throw new Error("invalid texture source");if(e=Object.assign({},Hc,e),this._texture)throw new Error("already created texture");if(this._wrapX=e.wrapX,this._wrapY=e.wrapY,this._sampling=e.sampling,this._anisotropy=e.anisotropy,this._pixelFormat=e.pixelFormat,this._isMipMapped=!!e.mipMap&&this._renderer.AreMipmapsEnabled(),this._mipMapQuality=e.mipMapQuality,!zc.has(this._wrapX)||!zc.has(this._wrapY))throw new Error("invalid wrap mode");if(!jc.has(this._sampling))throw new Error("invalid sampling");if(!Wc.has(this._pixelFormat))throw new Error("invalid pixel format");if(!Vc.has(this._mipMapQuality))throw new Error("invalid mipmap quality");if(this._isStatic=!0,t instanceof ArrayBuffer||null===t||e.isSvg){if(this._width=e.width,this._height=e.height,t instanceof ArrayBuffer&&t.byteLength!==this._width*this._height*4)throw new Error("ArrayBuffer wrong size")}else this._width=t.width,this._height=t.height;if(this._width<=0||this._height<=0)throw new Error("invalid texture data size");if(e.isSvg){const e=Uc.CreateCanvas(this._width,this._height);e.getContext("2d").drawImage(t,0,0,this._width,this._height),t=e}const s=Uc.isPOT(this._width)&&Uc.isPOT(this._height),i=this._renderer.GetMaxTextureSize();if(this._width>i||this._height>i)throw new Error("texture data exceeds maximum texture size");const r=this._renderer.GetContext(),n=this._renderer.GetWebGLVersionNumber();this._texture=r.createTexture(),r.bindTexture(r.TEXTURE_2D,this._texture),r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,e.premultiplyAlpha),r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,!1);const a=Nc(this._pixelFormat,r);if(this._renderer.SupportsNPOTTextures()||s||!this._IsTiled())if(n>=2){let e;e=this._isMipMapped?Math.floor(Math.log2(Math.max(this._width,this._height))+1):1,r.texStorage2D(r.TEXTURE_2D,e,a.sizedinternalformat,this._width,this._height),t instanceof ArrayBuffer?r.texSubImage2D(r.TEXTURE_2D,0,0,0,this._width,this._height,a.format,a.type,new Uint8Array(t)):null!==t&&r.texSubImage2D(r.TEXTURE_2D,0,0,0,a.format,a.type,t)}else t instanceof ArrayBuffer?r.texImage2D(r.TEXTURE_2D,0,a.internalformat,this._width,this._height,0,a.format,a.type,new Uint8Array(t)):null===t?r.texImage2D(r.TEXTURE_2D,0,a.internalformat,this._width,this._height,0,a.format,a.type,null):r.texImage2D(r.TEXTURE_2D,0,a.internalformat,a.format,a.type,t);else{if(null===t)throw new Error("cannot pass null data when creating a NPOT tiled texture without NPOT support");if(t instanceof ArrayBuffer&&(t=new ImageData(new Uint8ClampedArray(t),this._width,this._height)),t instanceof ImageData){const e=Uc.CreateCanvas(this._width,this._height);e.getContext("2d").putImageData(t,0,0),t=e}const e=Uc.CreateCanvas(Uc.nextHighestPowerOfTwo(this._width),Uc.nextHighestPowerOfTwo(this._height)),s=e.getContext("2d");s.imageSmoothingEnabled="nearest"!==this._sampling,s.drawImage(t,0,0,this._width,this._height,0,0,e.width,e.height),r.texImage2D(r.TEXTURE_2D,0,a.internalformat,a.format,a.type,e)}null!==t&&this._SetTextureParameters(r),r.bindTexture(r.TEXTURE_2D,null),this._renderer._ResetLastTexture(),this._refCount=1,Xc.add(this)}_CreateDynamic(t,e,s){if(s=Object.assign({},Hc,s),this._texture)throw new Error("already created texture");if(this._wrapX=s.wrapX,this._wrapY=s.wrapY,this._sampling=s.sampling,this._pixelFormat=s.pixelFormat,this._isMipMapped=!!s.mipMap&&this._renderer.AreMipmapsEnabled(),this._mipMapQuality=s.mipMapQuality,!zc.has(this._wrapX)||!zc.has(this._wrapY))throw new Error("invalid wrap mode");if(!jc.has(this._sampling))throw new Error("invalid sampling");if(!Wc.has(this._pixelFormat))throw new Error("invalid pixel format");if(!Vc.has(this._mipMapQuality))throw new Error("invalid mipmap quality");this._isStatic=!1,this._width=Math.floor(t),this._height=Math.floor(e);const i=Uc.isPOT(this._width)&&Uc.isPOT(this._height),r=this._renderer.GetMaxTextureSize();if(this._width<=0||this._height<=0)throw new Error("invalid texture size");if(this._width>r||this._height>r)throw new Error("texture exceeds maximum texture size");if(!this._renderer.SupportsNPOTTextures()&&this._IsTiled()&&!i)throw new Error("non-power-of-two tiled textures not supported");const n=this._renderer.GetContext(),a=this._renderer.GetWebGLVersionNumber();this._texture=n.createTexture(),n.bindTexture(n.TEXTURE_2D,this._texture),n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,s.premultiplyAlpha),n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,!1);const o=Nc(this._pixelFormat,n),h=a>=2?o.sizedinternalformat:o.internalformat;n.texImage2D(n.TEXTURE_2D,0,h,this._width,this._height,0,o.format,o.type,null),this._SetTextureParameters(n),n.bindTexture(n.TEXTURE_2D,null),this._renderer._ResetLastTexture(),this._refCount=1,Xc.add(this)}_GetMipMapHint(t){if("default"===this._mipMapQuality)return this._isStatic?t.NICEST:t.FASTEST;if("low"===this._mipMapQuality)return t.FASTEST;if("high"===this._mipMapQuality)return t.NICEST;throw new Error("invalid mipmap quality")}_IsTiled(){return"clamp-to-edge"!==this._wrapX||"clamp-to-edge"!==this._wrapY}_GetTextureWrapMode(t,e){if("clamp-to-edge"===e)return t.CLAMP_TO_EDGE;if("repeat"===e)return t.REPEAT;if("mirror-repeat"===e)return t.MIRRORED_REPEAT;throw new Error("invalid wrap mode")}_SetTextureParameters(t){const e=Uc.isPOT(this._width)&&Uc.isPOT(this._height);if(t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,this._GetTextureWrapMode(t,this._wrapX)),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,this._GetTextureWrapMode(t,this._wrapY)),"nearest"===this._sampling)t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),this._isMipMapped=!1;else if(t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),(e||this._renderer.SupportsNPOTTextures())&&this._isMipMapped){t.hint(t.GENERATE_MIPMAP_HINT,this._GetMipMapHint(t)),t.generateMipmap(t.TEXTURE_2D);const e="trilinear"===this._sampling&&!this._renderer.HasMajorPerformanceCaveat();t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,e?t.LINEAR_MIPMAP_LINEAR:t.LINEAR_MIPMAP_NEAREST)}else t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),this._isMipMapped=!1;const s=this._renderer._GetAnisotropicExtension();s&&this._anisotropy>0&&"nearest"!==this._sampling&&t.texParameterf(t.TEXTURE_2D,s.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(this._anisotropy,this._renderer._GetMaxAnisotropy()))}_Update(t,e){if(!("undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement||"undefined"!=typeof HTMLVideoElement&&t instanceof HTMLVideoElement||"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap||"undefined"!=typeof OffscreenCanvas&&t instanceof OffscreenCanvas||t instanceof ImageData))throw new Error("invalid texture source");if(!this._texture||this._refCount<=0)throw new Error("texture not created");if(this._isStatic)throw new Error("cannot update static texture");e=Object.assign({},Yc,e);const s=t.width||t.videoWidth,i=t.height||t.videoHeight,r=this._renderer.GetWebGLVersionNumber(),n=this._renderer.GetContext();n.bindTexture(n.TEXTURE_2D,this._texture),n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,e.premultiplyAlpha),n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,!!e.flipY);const a=Nc(this._pixelFormat,n),o=r>=2?a.sizedinternalformat:a.internalformat;try{if(this._width===s&&this._height===i){const e=Uc.isPOT(this._width)&&Uc.isPOT(this._height);n.texSubImage2D(n.TEXTURE_2D,0,0,0,a.format,a.type,t),(e||this._renderer.SupportsNPOTTextures())&&this._isMipMapped&&(n.hint(n.GENERATE_MIPMAP_HINT,this._GetMipMapHint(n)),n.generateMipmap(n.TEXTURE_2D))}else{this._width=s,this._height=i;const e=Uc.isPOT(this._width)&&Uc.isPOT(this._height);if(!this._renderer.SupportsNPOTTextures()&&this._IsTiled()&&!e)throw new Error("non-power-of-two tiled textures not supported");n.texImage2D(n.TEXTURE_2D,0,o,a.format,a.type,t),(e||this._renderer.SupportsNPOTTextures())&&this._isMipMapped&&(n.hint(n.GENERATE_MIPMAP_HINT,this._GetMipMapHint(n)),n.generateMipmap(n.TEXTURE_2D))}}catch(t){console.error("Error updating WebGL texture: ",t)}n.bindTexture(n.TEXTURE_2D,null),this._renderer._ResetLastTexture()}_Delete(){if(this._refCount>0)throw new Error("texture still has references");if(!this._texture)throw new Error("already deleted texture");Xc.delete(this),this._renderer.GetContext().deleteTexture(this._texture),this._texture=null}IsValid(){return!!this._texture}_GetTexture(){return this._texture}GetRenderer(){return this._renderer}AddReference(){this._refCount++}SubtractReference(){if(this._refCount<=0)throw new Error("no more references");this._refCount--}GetReferenceCount(){return this._refCount}GetWidth(){return this._width}GetHeight(){return this._height}IsStatic(){return this._isStatic}GetEstimatedMemoryUsage(){let t=this._width*this._height;switch(this._pixelFormat){case"rgba8":t*=4;break;case"rgb8":t*=3;break;case"rgba4":case"rgb5_a1":case"rgb565":t*=2}return this._isMipMapped&&(t+=Math.floor(t/3)),t}static OnContextLost(){Xc.clear()}static allTextures(){return Xc.values()}}}{const qc=self.C3,Jc=(self.assert,self.glMatrix),Qc=(Jc.vec3,Jc.mat4),Kc=new Set(["nearest","bilinear","trilinear"]),Zc={sampling:"trilinear",alpha:!0,depth:!1,isSampled:!0,isDefaultSize:!0,multisampling:0},$c=new Set;qc.Gfx.WebGLRenderTarget=class{constructor(t){this._renderer=t,this._frameBuffer=null,this._frameBufferNoDepth=null,this._texture=null,this._renderBuffer=null,this._width=0,this._height=0,this._isDefaultSize=!0,this._sampling="trilinear",this._alpha=!0,this._depth=!1,this._isSampled=!0,this._multisampling=0,this._projectionMatrix=Qc.create(),this._lastFov=0,this._lastNearZ=0,this._lastFarZ=0}_Create(t,e,s){s=Object.assign({},Zc,s);const i=this._renderer.GetWebGLVersionNumber();if(this._texture||this._renderBuffer)throw new Error("already created render target");if(this._sampling=s.sampling,this._alpha=!!s.alpha,this._depth=!!s.depth,this._isSampled=!!s.isSampled,this._isDefaultSize=!!s.isDefaultSize,this._multisampling=s.multisampling,!Kc.has(this._sampling))throw new Error("invalid sampling");if(this._multisampling>0&&(i<2||this._isSampled))throw new Error("invalid use of multisampling");if(i<2&&(this._isSampled=!0),this._width=t,this._height=e,this._width<=0||this._height<=0)throw new Error("invalid render target size");this._CalculateProjection();const r=this._renderer.GetContext();if(this._frameBuffer=r.createFramebuffer(),this._depth&&(this._frameBufferNoDepth=r.createFramebuffer()),this._isSampled){this._texture=this._renderer.CreateDynamicTexture(this._width,this._height,{sampling:this._sampling,pixelFormat:this._alpha?"rgba8":"rgb8",mipMap:!1});const t=this._texture._GetTexture();r.bindFramebuffer(r.FRAMEBUFFER,this._frameBuffer),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,t,0),this._depth&&(r.bindFramebuffer(r.FRAMEBUFFER,this._frameBufferNoDepth),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,t,0))}else{this._renderBuffer=r.createRenderbuffer(),r.bindRenderbuffer(r.RENDERBUFFER,this._renderBuffer);const t=this._alpha?r.RGBA8:r.RGB8;if(this._multisampling>0){const e=r.getInternalformatParameter(r.RENDERBUFFER,t,r.SAMPLES);if(e&&e[0]){const t=e[0];this._multisampling>t&&(this._multisampling=t)}else this._multisampling=0}0===this._multisampling?r.renderbufferStorage(r.RENDERBUFFER,t,this._width,this._height):r.renderbufferStorageMultisample(r.RENDERBUFFER,this._multisampling,t,this._width,this._height),r.bindFramebuffer(r.FRAMEBUFFER,this._frameBuffer),r.framebufferRenderbuffer(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.RENDERBUFFER,this._renderBuffer),this._depth&&(r.bindFramebuffer(r.FRAMEBUFFER,this._frameBufferNoDepth),r.framebufferRenderbuffer(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.RENDERBUFFER,this._renderBuffer)),r.bindRenderbuffer(r.RENDERBUFFER,null)}const n=this._renderer._GetDepthBuffer();this._depth&&n&&(r.bindFramebuffer(r.FRAMEBUFFER,this._frameBuffer),this._renderer._CanSampleDepth()?r.framebufferTexture2D(r.FRAMEBUFFER,r.DEPTH_STENCIL_ATTACHMENT,r.TEXTURE_2D,n,0):r.framebufferRenderbuffer(r.FRAMEBUFFER,r.DEPTH_STENCIL_ATTACHMENT,r.RENDERBUFFER,n)),r.bindFramebuffer(r.FRAMEBUFFER,null),$c.add(this)}_Resize(t,e){if(this._width===t&&this._height===e)return;this._width=t,this._height=e,this._CalculateProjection();const s=this._renderer.GetContext();s.bindFramebuffer(s.FRAMEBUFFER,this._frameBuffer),this._texture?this._texture._Update(new ImageData(this._width,this._height)):(s.bindRenderbuffer(s.RENDERBUFFER,this._renderBuffer),s.renderbufferStorage(s.RENDERBUFFER,this._alpha?s.RGBA8:s.RGB8,this._width,this._height),s.bindRenderbuffer(s.RENDERBUFFER,null));const i=this._renderer._GetDepthBuffer();this._depth&&i&&(this._renderer._CanSampleDepth()?s.framebufferTexture2D(s.FRAMEBUFFER,s.DEPTH_STENCIL_ATTACHMENT,s.TEXTURE_2D,i,0):s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_STENCIL_ATTACHMENT,s.RENDERBUFFER,i)),s.bindFramebuffer(s.FRAMEBUFFER,null)}_Delete(){if(!this._texture&&!this._renderBuffer)throw new Error("already deleted render target");$c.delete(this);const t=this._renderer.GetContext();this._texture?(t.bindFramebuffer(t.FRAMEBUFFER,this._frameBuffer),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,null,0),this._depth&&(t.bindFramebuffer(t.FRAMEBUFFER,this._frameBufferNoDepth),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,null,0)),this._renderer.DeleteTexture(this._texture),this._texture=null):this._renderBuffer&&(t.bindFramebuffer(t.FRAMEBUFFER,this._frameBuffer),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.RENDERBUFFER,null),this._depth&&(t.bindFramebuffer(t.FRAMEBUFFER,this._frameBufferNoDepth),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.RENDERBUFFER,null)),t.deleteRenderbuffer(this._renderBuffer),this._renderBuffer=null),t.bindFramebuffer(t.FRAMEBUFFER,null),this._renderer.GetWebGLVersionNumber()>=2&&(t.bindFramebuffer(t.READ_FRAMEBUFFER,null),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,null)),t.deleteFramebuffer(this._frameBuffer),this._depth&&t.deleteFramebuffer(this._frameBufferNoDepth);const e=this._renderer.GetBatchState();e.currentFramebuffer=null,e.currentFramebufferNoDepth=null,this._frameBuffer=null}_CalculateProjection(){this._renderer.CalculatePerspectiveMatrix(this._projectionMatrix,this._width/this._height),this._lastFov=this._renderer.GetFovY(),this._lastNearZ=this._renderer.GetNearZ(),this._lastFarZ=this._renderer.GetFarZ()}_GetFramebuffer(){return this._frameBuffer}_GetFramebufferNoDepth(){return this._frameBufferNoDepth}GetRenderer(){return this._renderer}GetTexture(){return this._texture}GetProjectionMatrix(){return this._renderer.GetFovY()===this._lastFov&&this._renderer.GetNearZ()===this._lastNearZ&&this._renderer.GetFarZ()===this._lastFarZ||this._CalculateProjection(),this._projectionMatrix}IsLinearSampling(){return"nearest"!==this._sampling}HasAlpha(){return this._alpha}IsSampled(){return this._isSampled}HasDepthBuffer(){return this._depth}GetWidth(){return this._width}GetHeight(){return this._height}IsDefaultSize(){return this._isDefaultSize}GetMultisampling(){return this._multisampling}GetOptions(){const t={sampling:this._sampling,alpha:this._alpha,isSampled:this._isSampled};return this._isDefaultSize||(t.width=this._width,t.height=this._height),t}IsCompatibleWithOptions(t){return"nearest"!==(t=Object.assign({},Zc,t)).sampling===this.IsLinearSampling()&&!!t.alpha===this.HasAlpha()&&!!t.depth===this.HasDepthBuffer()&&!(this._renderer.GetWebGLVersionNumber()>=2&&!!t.isSampled!==this.IsSampled())&&("number"==typeof t.width||"number"==typeof t.height?!this.IsDefaultSize()&&this.GetWidth()===Math.floor(t.width)&&this.GetHeight()===Math.floor(t.height):this.IsDefaultSize())}_GetWebGLTexture(){return this._texture?this._texture._GetTexture():null}GetEstimatedMemoryUsage(){return this._texture?this._texture.GetEstimatedMemoryUsage():this._width*this._height*(this._alpha?4:3)}static async DebugReadPixelsToBlob(t,e){const s=await t.ReadBackRenderTargetToImageData(e,!0);return await qc.ImageDataToBlob(s)}static OnContextLost(){$c.clear()}static allRenderTargets(){return $c.values()}static ResizeAll(t,e){for(const s of $c)s.IsDefaultSize()&&s._Resize(t,e)}}}{const tu=self.C3,eu=self.glMatrix,su=(eu.vec3,eu.mat4,new Set(["aPos","aTex","aColor","aPoints","matP","matMV","samplerFront","samplerBack","samplerDepth","destStart","destEnd","srcStart","srcEnd","srcOriginStart","srcOriginEnd","pixelSize","seconds","devicePixelRatio","layerScale","layerAngle","layoutStart","layoutEnd","color","color2_","pointTexStart","pointTexEnd","zElevation","tileSize","tileSpacing","outlineThickness","zNear","zFar"]));tu.Gfx.WebGLShaderProgram=class extends tu.Gfx.ShaderProgramBase{static async Compile(t,e){const s=t.GetContext(),i=e.src,r=e.vertexSrc,n=e.name,a=s.createShader(s.FRAGMENT_SHADER);s.shaderSource(a,i),s.compileShader(a);const o=s.createShader(s.VERTEX_SHADER);s.shaderSource(o,r),s.compileShader(o);const h=s.createProgram();s.attachShader(h,a),s.attachShader(h,o),s.bindAttribLocation(h,0,"aPos"),s.bindAttribLocation(h,1,"aTex"),s.bindAttribLocation(h,2,"aColor"),s.bindAttribLocation(h,3,"aPoints"),s.linkProgram(h);const l=t._GetParallelShaderCompileExtension();if(l?await t._WaitForObjectReady(()=>s.getProgramParameter(h,l.COMPLETION_STATUS_KHR)):await tu.Wait(5),!s.getShaderParameter(a,s.COMPILE_STATUS)){const t=s.getShaderInfoLog(a);throw s.deleteShader(a),s.deleteShader(o),s.deleteProgram(h),new Error("Error compiling fragment shader: "+t)}if(!s.getShaderParameter(o,s.COMPILE_STATUS)){const t=s.getShaderInfoLog(o);throw s.deleteShader(a),s.deleteShader(o),s.deleteProgram(h),new Error("Error compiling vertex shader: "+t)}if(!s.getProgramParameter(h,s.LINK_STATUS)){const t=s.getProgramInfoLog(h);throw s.deleteShader(a),s.deleteShader(o),s.deleteProgram(h),new Error("Error linking shader program: "+t)}const c=tu.FilterUnprintableChars(s.getProgramInfoLog(h)||"").trim();return c&&!tu.IsStringAllWhitespace(c)&&console.info(`[WebGL] Shader program '${n}' compilation log: `,c),s.deleteShader(a),s.deleteShader(o),h}static async Create(t,e){const s=await tu.Gfx.WebGLShaderProgram.Compile(t,e);return new tu.Gfx.WebGLShaderProgram(t,s,e)}constructor(t,e,s){super(t,s);const i=t.GetContext(),r=t.GetBatchState();t.EndBatch(),i.useProgram(e),this._gl=i,this._shaderProgram=e,this._isDeviceTransform="<default-device-transform>"===s.name;const n=i.getAttribLocation(e,"aPos"),a=i.getAttribLocation(e,"aTex"),o=i.getAttribLocation(e,"aColor");this._locAPoints=i.getAttribLocation(e,"aPoints"),-1!==n&&(i.bindBuffer(i.ARRAY_BUFFER,t._vertexBuffer),i.vertexAttribPointer(n,3,i.FLOAT,!1,0,0),i.enableVertexAttribArray(n)),-1!==a&&(i.bindBuffer(i.ARRAY_BUFFER,t._texcoordBuffer),i.vertexAttribPointer(a,2,i.FLOAT,!1,0,0),i.enableVertexAttribArray(a)),-1!==o&&(i.bindBuffer(i.ARRAY_BUFFER,t._colorBuffer),i.vertexAttribPointer(o,4,t.IsColorDataF16()?i.HALF_FLOAT:i.FLOAT,!1,0,0),i.enableVertexAttribArray(o)),-1!==this._locAPoints&&(i.bindBuffer(i.ARRAY_BUFFER,t._pointBuffer),i.vertexAttribPointer(this._locAPoints,4,i.FLOAT,!1,0,0),i.enableVertexAttribArray(this._locAPoints)),i.bindBuffer(i.ARRAY_BUFFER,null),this._uMatP=new tu.Gfx.WebGLShaderUniform(this,"matP","mat4"),this._uMatMV=new tu.Gfx.WebGLShaderUniform(this,"matMV","mat4"),this._uColor=new tu.Gfx.WebGLShaderUniform(this,"color","vec4"),this._uSamplerFront=new tu.Gfx.WebGLShaderUniform(this,"samplerFront","sampler"),this._uPointTexStart=new tu.Gfx.WebGLShaderUniform(this,"pointTexStart","vec2"),this._uPointTexEnd=new tu.Gfx.WebGLShaderUniform(this,"pointTexEnd","vec2"),this._uZElevation=new tu.Gfx.WebGLShaderUniform(this,"zElevation","float"),this._uTileSize=new tu.Gfx.WebGLShaderUniform(this,"tileSize","vec2"),this._uTileSpacing=new tu.Gfx.WebGLShaderUniform(this,"tileSpacing","vec2"),this._uColor2=new tu.Gfx.WebGLShaderUniform(this,"color2_","vec4"),this._uOutlineThickness=new tu.Gfx.WebGLShaderUniform(this,"outlineThickness","float"),this._uSamplerBack=new tu.Gfx.WebGLShaderUniform(this,"samplerBack","sampler"),this._uSamplerDepth=new tu.Gfx.WebGLShaderUniform(this,"samplerDepth","sampler"),this._uDestStart=new tu.Gfx.WebGLShaderUniform(this,"destStart","vec2"),this._uDestEnd=new tu.Gfx.WebGLShaderUniform(this,"destEnd","vec2"),this._uSrcStart=new tu.Gfx.WebGLShaderUniform(this,"srcStart","vec2"),this._uSrcEnd=new tu.Gfx.WebGLShaderUniform(this,"srcEnd","vec2"),this._uSrcOriginStart=new tu.Gfx.WebGLShaderUniform(this,"srcOriginStart","vec2"),this._uSrcOriginEnd=new tu.Gfx.WebGLShaderUniform(this,"srcOriginEnd","vec2"),this._uPixelSize=new tu.Gfx.WebGLShaderUniform(this,"pixelSize","vec2"),this._uSeconds=new tu.Gfx.WebGLShaderUniform(this,"seconds","float"),this._uDevicePixelRatio=new tu.Gfx.WebGLShaderUniform(this,"devicePixelRatio","float"),this._uLayerScale=new tu.Gfx.WebGLShaderUniform(this,"layerScale","float"),this._uLayerAngle=new tu.Gfx.WebGLShaderUniform(this,"layerAngle","float"),this._uLayoutStart=new tu.Gfx.WebGLShaderUniform(this,"layoutStart","vec2"),this._uLayoutEnd=new tu.Gfx.WebGLShaderUniform(this,"layoutEnd","vec2"),this._uZNear=new tu.Gfx.WebGLShaderUniform(this,"zNear","float"),this._uZFar=new tu.Gfx.WebGLShaderUniform(this,"zFar","float"),this._hasAnyOptionalUniforms=!!(this._uPixelSize.IsUsed()||this._uSeconds.IsUsed()||this._uSamplerBack.IsUsed()||this._uDestStart.IsUsed()||this._uDestEnd.IsUsed()||this._uSrcStart.IsUsed()||this._uSrcEnd.IsUsed()||this._uSrcOriginStart.IsUsed()||this._uSrcOriginEnd.IsUsed()||this._uDevicePixelRatio.IsUsed()||this._uLayerScale.IsUsed()||this._uLayerAngle.IsUsed()||this._uLayoutStart.IsUsed()||this._uLayoutEnd.IsUsed());const h=s.parameters||[];this._uCustomParameters=[],this._usesAnySrcRectOrPixelSize=this._uPixelSize.IsUsed()||this._uSrcStart.IsUsed()||this._uSrcEnd.IsUsed()||this._uSrcOriginStart.IsUsed()||this._uSrcOriginEnd.IsUsed(),this._hasCurrentMatP=!1,this._hasCurrentMatMV=!1,this._uColor.Init4f(1,1,1,1),this._uColor2.Init4f(1,1,1,1),this._uSamplerFront.Init1i(0),this._uSamplerBack.Init1i(1),this._uSamplerDepth.Init1i(2),this._uPointTexStart.Init2f(0,0),this._uPointTexEnd.Init2f(1,1),this._uZElevation.Init1f(0),this._uTileSize.Init2f(0,0),this._uTileSpacing.Init2f(0,0),this._uDestStart.Init2f(0,0),this._uDestEnd.Init2f(1,1),this._uSrcStart.Init2f(0,0),this._uSrcEnd.Init2f(0,0),this._uSrcOriginStart.Init2f(0,0),this._uSrcOriginEnd.Init2f(0,0),this._uPixelSize.Init2f(0,0),this._uDevicePixelRatio.Init1f(1),this._uZNear.Init1f(t.GetNearZ()),this._uZFar.Init1f(t.GetFarZ()),this._uLayerScale.Init1f(1),this._uLayerAngle.Init1f(0),this._uSeconds.Init1f(0),this._uLayoutStart.Init2f(0,0),this._uLayoutEnd.Init2f(0,0),this._uOutlineThickness.Init1f(1);for(const t of h){const e=t[0],s=t[2],i=new tu.Gfx.WebGLShaderUniform(this,e,s);"color"===s?i.Init3f(0,0,0):i.Init1f(0),this._uCustomParameters.push(i)}this._isDeviceTransform?this._UpdateDeviceTransformUniforms(r.currentMatP):(this.UpdateMatP(r.currentMatP,!0),this.UpdateMatMV(r.currentMV,!0));const l=r.currentShader;i.useProgram(l?l._shaderProgram:null)}Release(){this._gl.deleteProgram(this._shaderProgram),this._shaderProgram=null,this._renderer._RemoveShaderProgram(this),this._gl=null,super.Release()}GetWebGLContext(){return this._gl}GetShaderProgram(){return this._shaderProgram}GetParameterCount(){return this._uCustomParameters.length}GetParameterType(t){return t<0||t>=this._uCustomParameters.length?null:this._uCustomParameters[t].GetType()}AreCustomParametersAlreadySetInBatch(t){for(let e=0,s=t.length;e<s;++e)if(!this._uCustomParameters[e].IsSetToCustomInBatch(t[e]))return!1;return!0}SetCustomParametersInBatch(t){for(let e=0,s=t.length;e<s;++e)this._uCustomParameters[e].SetBatchValueCustom(t[e])}AreOptionalUniformsAlreadySetInBatch(t,e,s,i,r,n,a,o,h,l){return!(this._uSamplerBack.IsUsed()||this._uPixelSize.IsUsed()&&!this._uPixelSize.IsSetTo2InBatch(r,n)||this._uDestStart.IsUsed()&&!this._uDestStart.IsSetTo2InBatch(t.getLeft(),t.getTop())||this._uDestEnd.IsUsed()&&!this._uDestEnd.IsSetTo2InBatch(t.getRight(),t.getBottom())||this._uDevicePixelRatio.IsUsed()&&!this._uDevicePixelRatio.IsSetTo1InBatch(a)||this._uLayerScale.IsUsed()&&!this._uLayerScale.IsSetTo1InBatch(o)||this._uLayerAngle.IsUsed()&&!this._uLayerAngle.IsSetTo1InBatch(h)||this._uSrcStart.IsUsed()&&!this._uSrcStart.IsSetTo2InBatch(e.getLeft(),e.getTop())||this._uSrcEnd.IsUsed()&&!this._uSrcEnd.IsSetTo2InBatch(e.getRight(),e.getBottom())||this._uSrcOriginStart.IsUsed()&&!this._uSrcOriginStart.IsSetTo2InBatch(s.getLeft(),s.getTop())||this._uSrcOriginEnd.IsUsed()&&!this._uSrcOriginEnd.IsSetTo2InBatch(s.getRight(),s.getBottom())||this._uLayoutStart.IsUsed()&&!this._uLayoutStart.IsSetTo2InBatch(i.getLeft(),i.getTop())||this._uLayoutEnd.IsUsed()&&!this._uLayoutEnd.IsSetTo2InBatch(i.getTop(),i.getBottom())||this._uSeconds.IsUsed()&&!this._uSeconds.IsSetTo1InBatch(l))}SetOptionalUniformsInBatch(t,e,s,i,r,n,a,o,h,l){this._uSamplerBack.IsUsed()||(this._uPixelSize.IsUsed()&&this._uPixelSize.SetBatch2(r,n),this._uDestStart.IsUsed()&&this._uDestStart.SetBatch2(t.getLeft(),t.getTop()),this._uDestEnd.IsUsed()&&this._uDestEnd.SetBatch2(t.getRight(),t.getBottom()),this._uDevicePixelRatio.IsUsed()&&this._uDevicePixelRatio.SetBatch1(a),this._uLayerScale.IsUsed()&&this._uLayerScale.SetBatch1(o),this._uLayerAngle.IsUsed()&&this._uLayerAngle.SetBatch1(h),this._uSrcStart.IsUsed()&&this._uSrcStart.SetBatch2(e.getLeft(),e.getTop()),this._uSrcEnd.IsUsed()&&this._uSrcEnd.SetBatch2(e.getRight(),e.getBottom()),this._uSrcOriginStart.IsUsed()&&this._uSrcOriginStart.SetBatch2(s.getLeft(),s.getTop()),this._uSrcOriginEnd.IsUsed()&&this._uSrcOriginEnd.SetBatch2(s.getRight(),s.getBottom()),this._uLayoutStart.IsUsed()&&this._uLayoutStart.SetBatch2(i.getLeft(),i.getTop()),this._uLayoutEnd.IsUsed()&&this._uLayoutEnd.SetBatch2(i.getTop(),i.getBottom()),this._uSeconds.IsUsed()&&this._uSeconds.SetBatch1(l))}UpdateMatP(t,e){this._hasCurrentMatP&&!e||this._isDeviceTransform||(this._uMatP.IsUsed()&&this._uMatP.UpdateMatrix4fv(t),this._hasCurrentMatP=!0)}SetMatPStale(){this._hasCurrentMatP=!1}UpdateMatMV(t,e){this._hasCurrentMatMV&&!e||this._isDeviceTransform||(this._uMatMV.IsUsed()&&this._uMatMV.UpdateMatrix4fv(t),this._hasCurrentMatMV=!0)}SetMatMVStale(){this._hasCurrentMatMV=!1}_UpdateDeviceTransformUniforms(t){if(!this._isDeviceTransform)throw new Error("not device transform shader");this._uMatP.UpdateMatrix4fv(t);const e=this._renderer,s=e.GetWidth()/2,i=e.GetHeight()/2,r=e.CalculateLookAtModelView2(s,i,e.GetDefaultCameraZ(e.GetHeight()),s,i,0,e.GetHeight());this._uMatMV.UpdateMatrix4fv(r)}UpdateColor(t){this._uColor.IsUsed()&&this._uColor.Update4f(t[0],t[1],t[2],t[3])}static GetReservedUniformNames(){return su}static _GetConservativeDepthShaderPrefix(t){return t?"\n#extension GL_EXT_conservative_depth : enable\nlayout (depth_greater) out highp float gl_FragDepth;\n\t":""}static GetDefaultVertexShaderSource(t){const e=t?"highp":"mediump";return["attribute highp vec3 aPos;",`attribute ${e} vec2 aTex;`,`varying ${e} vec2 vTex;`,"attribute lowp vec4 aColor;","varying lowp vec4 vColor;","uniform highp mat4 matP;","uniform highp mat4 matMV;","void main(void) {","\tgl_Position = matP * matMV * vec4(aPos, 1.0);","\tvTex = aTex;","\tvColor = aColor;","}"].join("\n")}static GetDefaultVertexShaderSource_WebGL2(t){const e=t?"highp":"mediump";return["#version 300 es","in highp vec3 aPos;",`in ${e} vec2 aTex;`,`out ${e} vec2 vTex;`,"in lowp vec4 aColor;","out lowp vec4 vColor;","uniform highp mat4 matP;","uniform highp mat4 matMV;","void main(void) {","\tgl_Position = matP * matMV * vec4(aPos, 1.0);","\tvTex = aTex;","\tvColor = aColor;","}"].join("\n")}static GetTextureFillFragmentShaderSource_WebGL1_NoFragDepth(){return["varying mediump vec2 vTex;","varying lowp vec4 vColor;","uniform lowp sampler2D samplerFront;","void main(void) {","\tgl_FragColor = texture2D(samplerFront, vTex) * vColor;","}"].join("\n")}static GetTextureFillFragmentShaderSource_WebGL1_FragDepthEXT(){return["#extension GL_EXT_frag_depth : enable","varying mediump vec2 vTex;","varying lowp vec4 vColor;","uniform lowp sampler2D samplerFront;","void main(void) {","\tgl_FragColor = texture2D(samplerFront, vTex) * vColor;","\tgl_FragDepthEXT = (gl_FragColor.a == 0.0 ? 1.0 : gl_FragCoord.z);","}"].join("\n")}static GetTextureFillFragmentShaderSource_WebGL2(t){return["#version 300 es",tu.Gfx.WebGLShaderProgram._GetConservativeDepthShaderPrefix(t),"in mediump vec2 vTex;","out lowp vec4 outColor;","in lowp vec4 vColor;","uniform lowp sampler2D samplerFront;","void main(void) {","\toutColor = texture(samplerFront, vTex) * vColor;","\tgl_FragDepth = (outColor.a == 0.0 ? 1.0 : gl_FragCoord.z);","}"].join("\n")}static GetTilemapFragmentShaderSource_WebGL1_NoFragDepth(){return["varying highp vec2 vTex;","varying lowp vec4 vColor;","uniform lowp sampler2D samplerFront;","uniform highp vec2 srcStart;","uniform highp vec2 pixelSize;","uniform highp vec2 tileSize;","uniform highp vec2 tileSpacing;","void main(void) {","\thighp vec2 tile = floor(vTex);","\thighp vec2 tex = fract(vTex);","\thighp vec2 tileOrigin = srcStart + tile * (tileSize + tileSpacing);","\thighp vec2 lowerBound = tileOrigin + pixelSize / 2.0;","\thighp vec2 upperBound = tileOrigin + tileSize - pixelSize / 2.0;","\tgl_FragColor = texture2D(samplerFront, clamp(tex, lowerBound, upperBound), -16.0) * vColor;","}"].join("\n")}static GetTilemapFragmentShaderSource_WebGL1_FragDepthEXT(){return["#extension GL_EXT_frag_depth : enable","varying highp vec2 vTex;","varying lowp vec4 vColor;","uniform lowp sampler2D samplerFront;","uniform highp vec2 srcStart;","uniform highp vec2 pixelSize;","uniform highp vec2 tileSize;","uniform highp vec2 tileSpacing;","void main(void) {","\thighp vec2 tile = floor(vTex);","\thighp vec2 tex = fract(vTex);","\thighp vec2 tileOrigin = srcStart + tile * (tileSize + tileSpacing);","\thighp vec2 lowerBound = tileOrigin + pixelSize / 2.0;","\thighp vec2 upperBound = tileOrigin + tileSize - pixelSize / 2.0;","\tgl_FragColor = texture2D(samplerFront, clamp(tex, lowerBound, upperBound), -16.0) * vColor;","\tgl_FragDepthEXT = (gl_FragColor.a == 0.0 ? 1.0 : gl_FragCoord.z);","}"].join("\n")}static GetTilemapFragmentShaderSource_WebGL2(t){return["#version 300 es",tu.Gfx.WebGLShaderProgram._GetConservativeDepthShaderPrefix(t),"in highp vec2 vTex;","out lowp vec4 outColor;","in lowp vec4 vColor;","uniform lowp sampler2D samplerFront;","uniform highp vec2 srcStart;","uniform highp vec2 pixelSize;","uniform highp vec2 tileSize;","uniform highp vec2 tileSpacing;","void main(void) {","\thighp vec2 tile = floor(vTex);","\thighp vec2 tex = fract(vTex);","\thighp vec2 tileOrigin = srcStart + tile * (tileSize + tileSpacing);","\thighp vec2 lowerBound = tileOrigin + pixelSize / 2.0;","\thighp vec2 upperBound = tileOrigin + tileSize - pixelSize / 2.0;","\toutColor = texture(samplerFront, clamp(tex, lowerBound, upperBound), -16.0) * vColor;","\tgl_FragDepth = (outColor.a == 0.0 ? 1.0 : gl_FragCoord.z);","}"].join("\n")}static GetTileRandomizationFragmentShaderSource(t,e,s,i){let r="";return t>=2?r="#version 300 es\n"+tu.Gfx.WebGLShaderProgram._GetConservativeDepthShaderPrefix(i):(e&&(r="#extension GL_EXT_frag_depth : enable\n"),s&&(r+="#extension GL_EXT_shader_texture_lod : enable\n",r+="#extension GL_OES_standard_derivatives : enable\n")),r+`\nprecision highp float;\n${t>=2?"in":"varying"} vec2 vTex;\n${t>=2?"out lowp vec4 outColor;":""}\n${t>=2?"in":"varying"} lowp vec4 vColor;\nuniform lowp sampler2D samplerFront;\nuniform vec2 pixelSize;\n\nuniform vec2 tileSize;\nuniform vec2 tileSpacing;\nuniform float outlineThickness;\n\nconst float PI = 3.1415926;\n\nlowp vec4 cospVec4(lowp vec4 a, lowp vec4 b, float x)\n{\n\treturn (a + b + (a - b) * cos(x * PI)) / 2.0;\n}\n\nvec3 randVec3(vec2 seed)\n{\n\treturn vec3(fract(sin(dot(seed.xy + vec2(0.1, 0.1), vec2(12.9898,78.233))) * 43758.5453),\n\t\t\t\tfract(sin(dot(seed.yx + vec2(0.1, 0.1), vec2(12.9898,-78.233))) * 43758.5453),\n\t\t\t\tfract(sin(dot(seed.xy + vec2(0.1, 0.1), vec2(-12.9898,-78.233))) * 43758.5453));\n}\n\nlowp vec4 sampleTile(vec2 tile, vec2 uv, vec2 ddx, vec2 ddy)\n{\n\tvec2 posRandom = tileSize;\n\tfloat angleRandom = outlineThickness;\n\t\n\tvec3 rand = (randVec3(floor(tile + 0.5)) - 0.5) * 2.0;\n\t\n\tfloat angle = angleRandom * rand.z * PI;\n\tfloat sin_a = sin(angle);\n\tfloat cos_a = cos(angle);\n\tfloat aspect = pixelSize.x / pixelSize.y;\n\n\tvec2 mid = tile + vec2(0.5, 0.5);\n\tvec2 dp = uv - mid;\n\tdp.x /= aspect;\n\tvec2 r = vec2(dp.x * cos_a - dp.y * sin_a,\n\t\t\t\t  dp.y * cos_a + dp.x * sin_a);\n\tr.x *= aspect;\n\n\tvec2 p = mid + r + (posRandom * rand.xy / 2.0);\n\t\n\t${t>=2?"return textureGrad(samplerFront, p, ddx, ddy);":""}\n\t${t<2&&s?"return texture2DGradEXT(samplerFront, p, ddx, ddy);":""}\n\t${t<2&&!s?"return texture2D(samplerFront, p);":""}\n}\n\nvoid main(void) {\n\t\n\t${t<2?"lowp vec4 outColor;":""}\n\t\n\tfloat blendMarginX = tileSpacing.x;\n\tfloat blendMarginY = tileSpacing.y;\n\t\n\tvec2 tile = floor(vTex);\n\tvec2 tex = fract(vTex);\n\tvec2 ddx = ${t>=2||s?"dFdx(vTex)":"vec2(0.0, 0.0)"};\n\tvec2 ddy = ${t>=2||s?"dFdy(vTex)":"vec2(0.0, 0.0)"};\n\t\n\tvec4 curTile = sampleTile(tile, vTex, ddx, ddy);\n\t\n\tbool inLeftMargin = (tex.x < blendMarginX);\n\tbool inRightMargin = (tex.x > 1.0 - blendMarginX);\n\tbool inTopMargin = (tex.y < blendMarginY);\n\tbool inBottomMargin = (tex.y > 1.0 - blendMarginY);\n\t\n\tif (inLeftMargin)\n\t{\n\t\tlowp vec4 leftTile = sampleTile(tile + vec2(-1.0, 0.0), vTex, ddx, ddy);\n\t\tfloat leftMix = (tex.x / (blendMarginX * 2.0)) + 0.5;\n\t\tlowp vec4 leftMixedTile = cospVec4(leftTile, curTile, leftMix);\n\t\t\n\t\tif (inTopMargin)\n\t\t{\n\t\t\tlowp vec4 topTile =     sampleTile(tile + vec2(0.0,  -1.0), vTex, ddx, ddy);\n\t\t\tlowp vec4 topLeftTile = sampleTile(tile + vec2(-1.0, -1.0), vTex, ddx, ddy);\n\t\t\tlowp vec4 topLeftMixedTile = cospVec4(topLeftTile, topTile, leftMix);\n\t\t\t\n\t\t\toutColor = cospVec4(topLeftMixedTile, leftMixedTile, (tex.y / (blendMarginY * 2.0)) + 0.5);\n\t\t}\n\t\telse if (inBottomMargin)\n\t\t{\n\t\t\tlowp vec4 bottomTile =     sampleTile(tile + vec2(0.0,  1.0), vTex, ddx, ddy);\n\t\t\tlowp vec4 bottomLeftTile = sampleTile(tile + vec2(-1.0, 1.0), vTex, ddx, ddy);\n\t\t\tlowp vec4 bottomLeftMixedTile = cospVec4(bottomLeftTile, bottomTile, leftMix);\n\t\t\t\n\t\t\toutColor = cospVec4(leftMixedTile, bottomLeftMixedTile, (tex.y - (1.0 - blendMarginY)) / (blendMarginY * 2.0));\n\t\t}\n\t\telse\n\t\t{\n\t\t\toutColor = leftMixedTile;\n\t\t}\n\t}\n\telse if (inRightMargin)\n\t{\n\t\tlowp vec4 rightTile = sampleTile(tile + vec2(1.0, 0.0), vTex, ddx, ddy);\n\t\tfloat rightMix = (tex.x - (1.0 - blendMarginX)) / (blendMarginX * 2.0);\n\t\tlowp vec4 rightMixedTile = cospVec4(curTile, rightTile, rightMix);\n\t\t\n\t\tif (inTopMargin)\n\t\t{\n\t\t\tlowp vec4 topTile =      sampleTile(tile + vec2(0.0, -1.0), vTex, ddx, ddy);\n\t\t\tlowp vec4 topRightTile = sampleTile(tile + vec2(1.0, -1.0), vTex, ddx, ddy);\n\t\t\tlowp vec4 topRightMixedTile = cospVec4(topTile, topRightTile, rightMix);\n\t\t\t\n\t\t\toutColor = cospVec4(topRightMixedTile, rightMixedTile, (tex.y / (blendMarginY * 2.0)) + 0.5);\n\t\t}\n\t\telse if (inBottomMargin)\n\t\t{\n\t\t\tlowp vec4 bottomTile =      sampleTile(tile + vec2(0.0, 1.0), vTex, ddx, ddy);\n\t\t\tlowp vec4 bottomRightTile = sampleTile(tile + vec2(1.0, 1.0), vTex, ddx, ddy);\n\t\t\tlowp vec4 bottomRightMixedTile = cospVec4(bottomTile, bottomRightTile, rightMix);\n\t\t\t\n\t\t\toutColor = cospVec4(rightMixedTile, bottomRightMixedTile, (tex.y - (1.0 - blendMarginY)) / (blendMarginY * 2.0));\n\t\t}\n\t\telse\n\t\t{\n\t\t\toutColor = rightMixedTile;\n\t\t}\n\t}\n\telse if (inTopMargin)\n\t{\n\t\tlowp vec4 topTile = sampleTile(tile + vec2(0.0, -1.0), vTex, ddx, ddy);\n\t\toutColor = cospVec4(topTile, curTile, (tex.y / (blendMarginY * 2.0)) + 0.5);\n\t}\n\telse if (inBottomMargin)\n\t{\n\t\tlowp vec4 bottomTile = sampleTile(tile + vec2(0.0, 1.0), vTex, ddx, ddy);\n\t\toutColor = cospVec4(curTile, bottomTile, (tex.y - (1.0 - blendMarginY)) / (blendMarginY * 2.0));\n\t}\n\telse\n\t{\n\t\toutColor = curTile;\n\t}\n\t\n\toutColor *= vColor;\n\t${t<2?"gl_FragColor = outColor;":""}\n\t${t>=2?"gl_FragDepth = (outColor.a == 0.0 ? 1.0 : gl_FragCoord.z);":""}\n\t${t<2&&e?"gl_FragDepthEXT = (outColor.a == 0.0 ? 1.0 : gl_FragCoord.z);":""}\n}\n`}static GetPointVertexShaderSource_WebGL1(){return["attribute vec4 aPoints;","varying float pointOpacity;","uniform float zElevation;","uniform mat4 matP;","uniform mat4 matMV;","void main(void) {","\tgl_Position = matP * matMV * vec4(aPoints.xy, zElevation, 1.0);","\tgl_PointSize = aPoints.z;","\tpointOpacity = aPoints.w;","}"].join("\n")}static GetPointVertexShaderSource_WebGL2(){return["#version 300 es","in vec4 aPoints;","out float pointOpacity;","uniform float zElevation;","uniform mat4 matP;","uniform mat4 matMV;","void main(void) {","\tgl_Position = matP * matMV * vec4(aPoints.xy, zElevation, 1.0);","\tgl_PointSize = aPoints.z;","\tpointOpacity = aPoints.w;","}"].join("\n")}static GetPointFragmentShaderSource_WebGL1_NoFragDepth(){return["uniform lowp sampler2D samplerFront;","varying lowp float pointOpacity;","uniform mediump vec2 pointTexStart;","uniform mediump vec2 pointTexEnd;","uniform lowp vec4 color;","void main(void) {","\tmediump vec2 pointTexMin = min(pointTexStart, pointTexEnd);","\tmediump vec2 pointTexMax = max(pointTexStart, pointTexEnd);","\tmediump vec2 pointCoord = (pointTexEnd.x > pointTexStart.x ? gl_PointCoord : vec2(1.0 - gl_PointCoord.y, gl_PointCoord.x));","\tgl_FragColor = texture2D(samplerFront, mix(pointTexMin, pointTexMax, pointCoord)) * color * pointOpacity;","}"].join("\n")}static GetPointFragmentShaderSource_WebGL1_FragDepthEXT(){return["#extension GL_EXT_frag_depth : enable","uniform lowp sampler2D samplerFront;","varying lowp float pointOpacity;","uniform mediump vec2 pointTexStart;","uniform mediump vec2 pointTexEnd;","uniform lowp vec4 color;","void main(void) {","\tmediump vec2 pointTexMin = min(pointTexStart, pointTexEnd);","\tmediump vec2 pointTexMax = max(pointTexStart, pointTexEnd);","\tmediump vec2 pointCoord = (pointTexEnd.x > pointTexStart.x ? gl_PointCoord : vec2(1.0 - gl_PointCoord.y, gl_PointCoord.x));","\tgl_FragColor = texture2D(samplerFront, mix(pointTexMin, pointTexMax, pointCoord)) * color * pointOpacity;","\tgl_FragDepthEXT = (gl_FragColor.a == 0.0 ? 1.0 : gl_FragCoord.z);","}"].join("\n")}static GetPointFragmentShaderSource_WebGL2(t){return["#version 300 es",tu.Gfx.WebGLShaderProgram._GetConservativeDepthShaderPrefix(t),"uniform lowp sampler2D samplerFront;","in lowp float pointOpacity;","uniform mediump vec2 pointTexStart;","uniform mediump vec2 pointTexEnd;","uniform lowp vec4 color;","out lowp vec4 outColor;","void main(void) {","\tmediump vec2 pointTexMin = min(pointTexStart, pointTexEnd);","\tmediump vec2 pointTexMax = max(pointTexStart, pointTexEnd);","\tmediump vec2 pointCoord = (pointTexEnd.x > pointTexStart.x ? gl_PointCoord : vec2(1.0 - gl_PointCoord.y, gl_PointCoord.x));","\toutColor = texture(samplerFront, mix(pointTexMin, pointTexMax, pointCoord)) * color * pointOpacity;","\tgl_FragDepth = (outColor.a == 0.0 ? 1.0 : gl_FragCoord.z);","}"].join("\n")}static GetColorFillFragmentShaderSource(){return["varying lowp vec4 vColor;","void main(void) {","\tgl_FragColor = vColor;","}"].join("\n")}static GetLinearGradientFillFragmentShaderSource(){return["precision lowp float;","varying mediump vec2 vTex;","varying vec4 vColor;","uniform vec4 color2_;","vec3 fromLinear(vec3 linearRGB)","{","\tbvec3 cutoff = lessThan(linearRGB, vec3(0.0031308));","\tvec3 higher = vec3(1.055) * pow(abs(linearRGB), vec3(1.0/2.4)) - vec3(0.055);","\tvec3 lower = linearRGB * vec3(12.92);","\treturn mix(higher, lower, vec3(cutoff));","}","vec3 toLinear(vec3 sRGB)","{","\tbvec3 cutoff = lessThan(sRGB, vec3(0.04045));","\tvec3 higher = pow(abs((sRGB + vec3(0.055))/vec3(1.055)), vec3(2.4));","\tvec3 lower = sRGB/vec3(12.92);","\treturn mix(higher, lower, vec3(cutoff));","}","void main(void) {","\tvec3 linearGrad = mix(toLinear(vColor.rgb), toLinear(color2_.rgb), vTex.x);","\tfloat a = mix(vColor.a, color2_.a, vTex.x);","\tgl_FragColor = vec4(fromLinear(linearGrad) * a, a);","}"].join("\n")}static GetPenumbraFillFragmentShaderSource(){return["precision lowp float;","varying highp vec2 vTex;","varying vec4 vColor;","void main(void) {","\thighp float grad = vTex.x / (1.0 - vTex.y);","\tgl_FragColor = vColor * (1.0 - (cos(grad * 3.141592653589793) + 1.0) / 2.0);","}"].join("\n")}static GetSmoothLineFillFragmentShaderSource(){return["varying mediump vec2 vTex;","varying lowp vec4 vColor;","void main(void) {","\tlowp float f = 1.0 - abs(vTex.y - 0.5) * 2.0;","\tgl_FragColor = vColor * f;","}"].join("\n")}static GetHardEllipseFillFragmentShaderSource(){return["varying highp vec2 vTex;","varying lowp vec4 vColor;","void main(void) {","\thighp vec2 diff = vTex - vec2(0.5, 0.5);","\thighp vec2 diffSq = diff * diff;","\thighp float f = step(diffSq.x + diffSq.y, 0.25);","\tgl_FragColor = vColor * f;","}"].join("\n")}static GetHardEllipseOutlineFragmentShaderSource(){return["varying highp vec2 vTex;","varying lowp vec4 vColor;","uniform highp vec2 pixelSize;","uniform highp float outlineThickness;","void main(void) {","\thighp vec2 diff = vTex - vec2(0.5, 0.5);","\thighp vec2 diffSq = diff * diff;","\thighp float distSq = diffSq.x + diffSq.y;","\thighp vec2 norm = normalize(diff);","\thighp vec2 halfNorm = norm * 0.5;","\thighp float innerF = step(distSq, 0.25);","\thighp vec2 innerEdge = halfNorm - pixelSize * norm * outlineThickness;","\thighp vec2 innerEdgeSq = innerEdge * innerEdge;","\thighp float outerF = step(innerEdgeSq.x + innerEdgeSq.y, distSq);","\tgl_FragColor = vColor * innerF * outerF;","}"].join("\n")}static GetSmoothEllipseFillFragmentShaderSource(){return["varying highp vec2 vTex;","varying lowp vec4 vColor;","uniform highp vec2 pixelSize;","void main(void) {","\thighp vec2 diff = vTex - vec2(0.5, 0.5);","\thighp vec2 diffSq = diff * diff;","\thighp vec2 norm = normalize(diff);","\thighp vec2 halfNorm = norm * 0.5;","\thighp vec2 halfNormSq = halfNorm * halfNorm;","\thighp vec2 innerEdge = halfNorm - pixelSize * norm;","\thighp vec2 innerEdgeSq = innerEdge * innerEdge;","\thighp float f = smoothstep(halfNormSq.x + halfNormSq.y, innerEdgeSq.x + innerEdgeSq.y, diffSq.x + diffSq.y);","\tgl_FragColor = vColor * f;","}"].join("\n")}static GetSmoothEllipseOutlineFragmentShaderSource(){return["varying highp vec2 vTex;","varying lowp vec4 vColor;","uniform highp vec2 pixelSize;","uniform highp float outlineThickness;","void main(void) {","\thighp vec2 diff = vTex - vec2(0.5, 0.5);","\thighp vec2 diffSq = diff * diff;","\thighp float distSq = diffSq.x + diffSq.y;","\thighp vec2 norm = normalize(diff);","\thighp vec2 halfNorm = norm * 0.5;","\thighp vec2 halfNormSq = halfNorm * halfNorm;","\thighp vec2 pxNorm = pixelSize * norm;","\thighp vec2 innerEdge1 = halfNorm - pxNorm;","\thighp vec2 innerEdge1Sq = innerEdge1 * innerEdge1;","\thighp float innerF = smoothstep(halfNormSq.x + halfNormSq.y, innerEdge1Sq.x + innerEdge1Sq.y, distSq);","\thighp vec2 innerEdge2 = halfNorm - pxNorm * outlineThickness;","\thighp vec2 innerEdge2Sq = innerEdge2 * innerEdge2;","\thighp vec2 innerEdge3 = halfNorm - pxNorm * (outlineThickness + 1.0);","\thighp vec2 innerEdge3Sq = innerEdge3 * innerEdge3;","\thighp float outerF = smoothstep(innerEdge3Sq.x + innerEdge3Sq.y, innerEdge2Sq.x + innerEdge2Sq.y, distSq);","\tgl_FragColor = vColor * innerF * outerF;","}"].join("\n")}}}{const iu=self.C3,ru=self.glMatrix.mat4,nu=new Map([["float",1],["percent",1],["sampler",1],["vec2",2],["vec3",3],["color",3],["vec4",4],["mat4",16]]);iu.Gfx.WebGLShaderUniform=class{constructor(t,e,s){if(!nu.has(s))throw new Error("invalid uniform type");this._owner=t,this._gl=this._owner.GetWebGLContext(),this._name=e,this._type=s,this._isColorType="color"===this._type,this._location=this._gl.getUniformLocation(this._owner.GetShaderProgram(),e),this._isUsed=!!this._location;const i=nu.get(s);this._lastValue=new Float32Array(i),this._lastBatchValue=new Float32Array(i)}Release(){this._owner=null,this._gl=null,this._location=null}IsUsed(){return this._isUsed}GetType(){return this._type}IsColorType(){return this._isColorType}Init1f(t){this.IsUsed()&&(this._lastValue[0]=t,this._lastBatchValue.set(this._lastValue),this._gl.uniform1f(this._location,t))}Init1i(t){this.IsUsed()&&(this._lastValue[0]=t,this._lastBatchValue.set(this._lastValue),this._gl.uniform1i(this._location,t))}Init2f(t,e){this.IsUsed()&&(this._lastValue[0]=t,this._lastValue[1]=e,this._lastBatchValue.set(this._lastValue),this._gl.uniform2f(this._location,t,e))}Init3f(t,e,s){this.IsUsed()&&(this._lastValue[0]=t,this._lastValue[1]=e,this._lastValue[2]=s,this._lastBatchValue.set(this._lastValue),this._gl.uniform3f(this._location,t,e,s))}Init4f(t,e,s,i){this.IsUsed()&&(this._lastValue[0]=t,this._lastValue[1]=e,this._lastValue[2]=s,this._lastValue[3]=i,this._lastBatchValue.set(this._lastValue),this._gl.uniform4f(this._location,t,e,s,i))}Update1f(t){t=Math.fround(t);const e=this._lastValue;e[0]!==t&&(e[0]=t,this._gl.uniform1f(this._location,t))}Update1i(t){const e=this._lastValue;e[0]!==t&&(e[0]=t,this._gl.uniform1i(this._location,t))}Update2f(t,e){t=Math.fround(t),e=Math.fround(e);const s=this._lastValue;s[0]===t&&s[1]===e||(s[0]=t,s[1]=e,this._gl.uniform2f(this._location,t,e))}Update3f(t,e,s){t=Math.fround(t),e=Math.fround(e),s=Math.fround(s);const i=this._lastValue;i[0]===t&&i[1]===e&&i[2]===s||(i[0]=t,i[1]=e,i[2]=s,this._gl.uniform3f(this._location,t,e,s))}Update4f(t,e,s,i){t=Math.fround(t),e=Math.fround(e),s=Math.fround(s),i=Math.fround(i);const r=this._lastValue;r[0]===t&&r[1]===e&&r[2]===s&&r[3]===i||(r[0]=t,r[1]=e,r[2]=s,r[3]=i,this._gl.uniform4f(this._location,t,e,s,i))}UpdateMatrix4fv(t){const e=this._lastValue;ru.exactEquals(e,t)||(iu.typedArraySet16(e,t,0),this._gl.uniformMatrix4fv(this._location,!1,t))}IsSetToCustomInBatch(t){const e=this._lastBatchValue;return this.IsColorType()?e[0]===Math.fround(t.getR())&&e[1]===Math.fround(t.getG())&&e[2]===Math.fround(t.getB()):e[0]===Math.fround(t)}SetBatchValueCustom(t){const e=this._lastBatchValue;this.IsColorType()?(e[0]=t.getR(),e[1]=t.getG(),e[2]=t.getB()):e[0]=t}IsSetTo1InBatch(t){return this._lastBatchValue[0]===Math.fround(t)}IsSetTo2InBatch(t,e){const s=this._lastBatchValue;return s[0]===Math.fround(t)&&s[1]===Math.fround(e)}SetBatch1(t){this._lastBatchValue[0]=t}SetBatch2(t,e){const s=this._lastBatchValue;s[0]=t,s[1]=e}}}{const au=self.C3,ou=self.glMatrix,hu=(ou.vec4,ou.mat4);au.Gfx.BatchState=class{constructor(t){this.renderer=t,this.currentMV=hu.create(),this.currentMatP=hu.create(),this.currentFramebuffer=null,this.currentFramebufferNoDepth=null,this.isDepthSamplingEnabled=!1,this.currentShader=null,this.pointTexCoords=new au.Rect,this.clearColor=au.New(au.Color,0,0,0,0)}},au.Gfx.WebGLBatchJob=class{constructor(t){const e=new ArrayBuffer(96);this._type=0,this._batchState=t,this._gl=t.renderer.GetContext(),this._startIndex=0,this._indexCount=0,this._texParam=null,this._mat4param=new Float32Array(e,0,16),this._colorParam=new Float32Array(e,64,4),this._srcOriginRect=new Float32Array(e,80,4),this._shaderParams=[]}InitDraw(t,e){this._type=1,this._startIndex=t,this._indexCount=e}DoDraw(){const t=this._gl;t.drawElements(t.TRIANGLES,this._indexCount,t.UNSIGNED_SHORT,this._startIndex)}InitSetTexture(t){this._type=2,this._texParam=t}DoSetTexture(){const t=this._gl,e=this._texParam;t.bindTexture(t.TEXTURE_2D,e?e._GetTexture():null)}InitSetGradientColor(t){this._type=20,t.writeToTypedArray(this._colorParam,0)}DoSetGradientColor(){const t=this._colorParam,e=this._batchState.currentShader;e._uColor2.IsUsed()&&e._uColor2.Update4f(t[0],t[1],t[2],t[3])}InitSetBlend(t){this._type=3;const e=this._mat4param;e[0]=t.length;for(let s=0,i=t.length;s<i;++s)e[s+1]=t[s]}DoSetBlend(){const t=this._gl,e=this._mat4param,s=e[0],i=e[1],r=e[2];let n=i,a=r,o=t.FUNC_ADD,h=t.FUNC_ADD;s>=4&&(n=e[3],a=e[4]),6===s&&(o=e[5],h=e[6]),t.blendFuncSeparate(i,r,n,a),t.blendEquationSeparate(o,h)}InitSetViewport(t,e,s,i){this._type=4;const r=this._colorParam;r[0]=t,r[1]=e,r[2]=s,r[3]=i}DoSetViewport(){const t=this._colorParam;this._gl.viewport(t[0],t[1],t[2],t[3])}InitSetProjection(t){this._type=5,hu.copy(this._mat4param,t)}DoSetProjection(){const t=this._batchState,e=t.renderer._allShaderPrograms,s=t.currentShader,i=this._mat4param;for(let t=0,r=e.length;t<r;++t){const r=e[t];r===s?r.UpdateMatP(i,!0):r.SetMatPStale()}hu.copy(t.currentMatP,i)}InitSetModelView(t){this._type=6,hu.copy(this._mat4param,t)}DoSetModelView(){const t=this._batchState,e=t.renderer._allShaderPrograms,s=t.currentShader,i=this._mat4param;for(let t=0,r=e.length;t<r;++t){const r=e[t];r===s?r.UpdateMatMV(i,!0):r.SetMatMVStale()}hu.copy(t.currentMV,i)}InitSetRenderTarget(t){this._type=7,this._texParam=t}DoSetRenderTarget(){const t=this._gl,e=this._texParam,s=this._batchState;e?(s.currentFramebuffer=e._GetFramebuffer(),s.currentFramebufferNoDepth=e._GetFramebufferNoDepth(),s.isDepthSamplingEnabled&&s.currentFramebufferNoDepth?t.bindFramebuffer(t.FRAMEBUFFER,s.currentFramebufferNoDepth):t.bindFramebuffer(t.FRAMEBUFFER,s.currentFramebuffer)):(s.currentFramebuffer=null,s.currentFramebufferNoDepth=null,t.bindFramebuffer(t.FRAMEBUFFER,null))}InitClearSurface(t){this._type=8,t.writeToTypedArray(this._mat4param,0)}InitClearSurface2(t,e,s,i){this._type=8;const r=this._mat4param;r[0]=t,r[1]=e,r[2]=s,r[3]=i}DoClearSurface(){const t=this._gl,e=this._mat4param,s=this._batchState.clearColor,i=e[0],r=e[1],n=e[2],a=e[3];s.equalsRgba(i,r,n,a)||(t.clearColor(i,r,n,a),s.setRgba(i,r,n,a)),t.clear(t.COLOR_BUFFER_BIT)}InitSetPointTexCoords(t){this._type=14,t.writeToTypedArray(this._mat4param,0)}DoSetPointTextureCoords(){const t=this._mat4param;this._batchState.pointTexCoords.set(t[0],t[1],t[2],t[3])}InitPoints(t,e,s){this._type=9,this._startIndex=t,this._indexCount=1,this._mat4param[0]=e,s.writeToTypedArray(this._colorParam,0)}DoPoints(){const t=this._gl,e=this._batchState,s=e.renderer._spPoints;t.useProgram(s._shaderProgram),s.UpdateMatP(e.currentMatP,!1),s.UpdateMatMV(e.currentMV,!1);const i=e.pointTexCoords;s._uPointTexStart.IsUsed()&&s._uPointTexStart.Update2f(i.getLeft(),i.getTop()),s._uPointTexEnd.IsUsed()&&s._uPointTexEnd.Update2f(i.getRight(),i.getBottom());const r=this._mat4param[0];if(s._uZElevation.IsUsed()&&s._uZElevation.Update1f(r),s._uColor.IsUsed()){const t=this._colorParam;s._uColor.Update4f(t[0],t[1],t[2],t[3])}t.drawArrays(t.POINTS,this._startIndex/4,this._indexCount),t.useProgram(e.currentShader._shaderProgram)}InitSetProgram(t){this._type=10,this._texParam=t}DoSetProgram(){const t=this._gl,e=this._batchState,s=this._texParam;e.currentShader=s,t.useProgram(s._shaderProgram),s.UpdateMatP(e.currentMatP,!1),s.UpdateMatMV(e.currentMV,!1)}InitSetProgramParameters(){this._type=11}DoSetProgramParameters(){const t=this._batchState.currentShader,e=this._gl,s=this._mat4param,i=this._colorParam,r=this._srcOriginRect;if(t._uSamplerBack.IsUsed()){const t=this._batchState.renderer,s=this._texParam;t._lastTexture1!==s&&(e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,s?s._GetTexture():null),t._lastTexture1=s,e.activeTexture(e.TEXTURE0))}t._uPixelSize.IsUsed()&&t._uPixelSize.Update2f(s[0],s[1]),t._uDestStart.IsUsed()&&t._uDestStart.Update2f(s[2],s[3]),t._uDestEnd.IsUsed()&&t._uDestEnd.Update2f(s[4],s[5]),t._uDevicePixelRatio.IsUsed()&&t._uDevicePixelRatio.Update1f(this._indexCount),t._uLayerScale.IsUsed()&&t._uLayerScale.Update1f(s[6]),t._uLayerAngle.IsUsed()&&t._uLayerAngle.Update1f(s[7]),t._uSrcStart.IsUsed()&&t._uSrcStart.Update2f(s[12],s[13]),t._uSrcEnd.IsUsed()&&t._uSrcEnd.Update2f(s[14],s[15]),t._uSrcOriginStart.IsUsed()&&t._uSrcOriginStart.Update2f(r[0],r[1]),t._uSrcOriginEnd.IsUsed()&&t._uSrcOriginEnd.Update2f(r[2],r[3]),t._uLayoutStart.IsUsed()&&t._uLayoutStart.Update2f(i[0],i[1]),t._uLayoutEnd.IsUsed()&&t._uLayoutEnd.Update2f(i[2],i[3]),t._uSeconds.IsUsed()&&t._uSeconds.Update1f(this._startIndex)}InitSetProgramCustomParameters(){this._type=12}DoSetProgramCustomParameters(){const t=this._batchState.currentShader._uCustomParameters,e=this._shaderParams;for(let s=0,i=t.length;s<i;++s){const i=t[s],r=e[s];i.IsColorType()?i.Update3f(r.getR(),r.getG(),r.getB()):i.Update1f(r)}}InitInvalidateFramebuffer(t){this._type=13,this._texParam=t}DoInvalidateFramebuffer(){const t=this._gl,e=this._texParam,s=this._batchState.currentFramebuffer;e!==s&&t.bindFramebuffer(t.FRAMEBUFFER,e),t.invalidateFramebuffer(t.FRAMEBUFFER,[t.COLOR_ATTACHMENT0]),e!==s&&t.bindFramebuffer(t.FRAMEBUFFER,s)}InitBlitFramebuffer(t,e,s){this._type=16;const i=this._mat4param,r=this._batchState.renderer;i[0]=t.GetWidth(),i[1]=t.GetHeight(),i[2]=e?e.GetWidth():r.GetWidth(),i[3]=e?e.GetHeight():r.GetHeight(),i[4]=t.IsLinearSampling()?1:0,i[5]="stretch"===s;const n=this._shaderParams;au.clearArray(n),n.push(t._GetFramebuffer()),n.push(e?e._GetFramebuffer():null)}DoBlitFramebuffer(){const t=this._mat4param,e=this._shaderParams,s=this._gl,i=t[0],r=t[1],n=t[2],a=t[3],o=0!==t[4],h=0!==t[5],l=e[0],c=e[1];if(s.bindFramebuffer(s.READ_FRAMEBUFFER,l),s.bindFramebuffer(s.DRAW_FRAMEBUFFER,c),h)s.blitFramebuffer(0,0,i,r,0,0,n,a,s.COLOR_BUFFER_BIT,o?s.LINEAR:s.NEAREST);else{const t=Math.min(i,n),e=Math.min(r,a),o=Math.max(r-a,0),h=Math.max(a-r,0);s.blitFramebuffer(0,o,t,e+o,0,h,t,e+h,s.COLOR_BUFFER_BIT,s.NEAREST)}}InitStartQuery(t){this._type=17,this._texParam=t}DoStartQuery(){this._texParam.BeginTimeElapsed(),this._texParam=null}InitEndQuery(t){this._type=18,this._texParam=t}DoEndQuery(){this._texParam.EndTimeElapsed(),this._texParam=null}InitSetEllipseParams(t,e,s){this._type=19;const i=this._mat4param;i[0]=t,i[1]=e,i[2]=s}DoSetEllipseParams(){const t=this._batchState.currentShader,e=this._mat4param;t._uPixelSize.IsUsed()&&t._uPixelSize.Update2f(e[0],e[1]),t._uOutlineThickness.IsUsed()&&t._uOutlineThickness.Update1f(e[2])}InitSetTilemapInfo(t,e,s,i,r,n,a){this._type=15;const o=this._mat4param;t.writeToTypedArray(o,0),o[4]=1/e,o[5]=1/s,o[6]=i/e,o[7]=r/s,o[8]=n/e,o[9]=a/s}DoSetTilemapInfo(){const t=this._batchState.currentShader,e=this._mat4param;t._uSrcStart.IsUsed()&&t._uSrcStart.Update2f(e[0],e[1]),t._uPixelSize.IsUsed()&&t._uPixelSize.Update2f(e[4],e[5]),t._uTileSize.IsUsed()&&t._uTileSize.Update2f(e[6],e[7]),t._uTileSpacing.IsUsed()&&t._uTileSpacing.Update2f(e[8],e[9])}InitSetTileRandomizationInfo(t,e,s,i,r,n,a){this._type=28;const o=this._mat4param;o[0]=1/t,o[1]=1/e,o[2]=s,o[3]=i,o[4]=r,o[5]=n,o[6]=a}DoSetTileRandomizationInfo(){const t=this._batchState.currentShader,e=this._mat4param;t._uPixelSize.IsUsed()&&t._uPixelSize.Update2f(e[0],e[1]),t._uTileSize.IsUsed()&&t._uTileSize.Update2f(e[2],e[3]),t._uOutlineThickness.IsUsed()&&t._uOutlineThickness.Update1f(e[4]),t._uTileSpacing.IsUsed()&&t._uTileSpacing.Update2f(e[5],e[6])}InitClearDepth(t){this._type=21,this._startIndex=t?1:0}DoClearDepth(){const t=this._gl,e=0!==this._startIndex;e||t.depthMask(!0),t.clear(t.DEPTH_BUFFER_BIT),e||t.depthMask(!1)}InitSetDepthEnabled(t){this._type=22,this._startIndex=t?1:0}DoSetDepthEnabled(){const t=this._gl;0===this._startIndex?(t.disable(t.DEPTH_TEST),t.depthMask(!1)):(t.enable(t.DEPTH_TEST),t.depthMask(!0))}InitSetDepthSamplingEnabled(t){this._type=23,this._startIndex=t?1:0}DoSetDepthSamplingEnabled(){const t=this._gl,e=this._batchState,s=e.renderer,i=0!==this._startIndex;e.isDepthSamplingEnabled=i,t.activeTexture(t.TEXTURE2),i?(e.currentFramebufferNoDepth&&t.bindFramebuffer(t.FRAMEBUFFER,e.currentFramebufferNoDepth),t.bindTexture(t.TEXTURE_2D,s._GetDepthBuffer())):(t.bindTexture(t.TEXTURE_2D,null),e.currentFramebufferNoDepth&&t.bindFramebuffer(t.FRAMEBUFFER,e.currentFramebuffer)),t.activeTexture(t.TEXTURE0)}InitCoplanarStartStencilPass(){this._type=24}DoCoplanarStartStencilPass(){const t=this._gl;t.clear(t.STENCIL_BUFFER_BIT),t.enable(t.STENCIL_TEST),t.stencilFunc(t.ALWAYS,1,1),t.stencilOp(t.KEEP,t.KEEP,t.REPLACE),t.colorMask(!1,!1,!1,!1)}InitCoplanarStartColorPass(){this._type=25}DoCoplanarStartColorPass(){const t=this._gl;t.enable(t.STENCIL_TEST),t.colorMask(!0,!0,!0,!0),t.stencilFunc(t.EQUAL,1,1),t.stencilOp(t.KEEP,t.KEEP,t.KEEP)}InitCoplanarRestore(){this._type=26}DoCoplanarRestore(){const t=this._gl;t.disable(t.STENCIL_TEST)}InitSetScissor(t,e,s,i,r){this._type=27,this._startIndex=t?1:0;const n=this._mat4param;n[0]=e,n[1]=s,n[2]=i,n[3]=r}DoSetScissor(){const t=this._gl,e=this._mat4param;1===this._startIndex?(t.enable(t.SCISSOR_TEST),t.scissor(e[0],e[1],e[2],e[3])):t.disable(t.SCISSOR_TEST)}InitSetCullFaceMode(t){this._type=29,this._startIndex=t}DoSetCullFaceMode(){const t=this._gl,e=this._startIndex;0===e?t.disable(t.CULL_FACE):(t.enable(t.CULL_FACE),1===e?t.cullFace(t.BACK):t.cullFace(t.FRONT))}InitSetFrontFaceWinding(t){this._type=30,this._startIndex=t}DoSetFrontFaceWinding(){const t=this._gl;t.frontFace(0===this._startIndex?t.CW:t.CCW)}Run(){switch(this._type){case 1:return void this.DoDraw();case 2:return void this.DoSetTexture();case 3:return void this.DoSetBlend();case 4:return void this.DoSetViewport();case 5:return void this.DoSetProjection();case 6:return void this.DoSetModelView();case 7:return void this.DoSetRenderTarget();case 8:return void this.DoClearSurface();case 9:return void this.DoPoints();case 10:return void this.DoSetProgram();case 11:return void this.DoSetProgramParameters();case 12:return void this.DoSetProgramCustomParameters();case 13:return void this.DoInvalidateFramebuffer();case 14:return void this.DoSetPointTextureCoords();case 15:return void this.DoSetTilemapInfo();case 16:return void this.DoBlitFramebuffer();case 17:return void this.DoStartQuery();case 18:return void this.DoEndQuery();case 19:return void this.DoSetEllipseParams();case 20:return void this.DoSetGradientColor();case 21:return void this.DoClearDepth();case 22:return void this.DoSetDepthEnabled();case 23:return void this.DoSetDepthSamplingEnabled();case 24:return void this.DoCoplanarStartStencilPass();case 25:return void this.DoCoplanarStartColorPass();case 26:return void this.DoCoplanarRestore();case 27:return void this.DoSetScissor();case 28:return void this.DoSetTileRandomizationInfo();case 29:return void this.DoSetCullFaceMode();case 30:return void this.DoSetFrontFaceWinding()}}}}{let lu=function(t,e,s,i,r,n){e?t.strokeRect(s,i,r,n):t.fillRect(s,i,r,n)},cu=function(t){return t*(4/3)},uu=function(t,e){t=t.trim();const s=parseFloat(t);return isFinite(s)?t.endsWith("%")?e*s/100:s:0};0;const _u=self.C3,du=new Set(["serif","sans-serif","monospace","cursive","fantasy","system-ui","ui-serif","ui-sans-serif","ui-monospace","ui-rounded","math","emoji","fangsong"]),pu={timeout:60},fu=new _u.Color(0,0,0,1),gu=new Set(["left","center","right"]),mu=new Set(["top","center","bottom"]),Su=new Set(["word","cjk","character"]),yu=new Set(["ltr","rtl"]),Gu=new Set;_u.FontManager&&_u.FontManager.addEventListener("fontload",t=>{const e=t.font.GetName();for(const t of Gu)(t.IsBBCodeEnabled()||_u.equalsNoCase(t.GetFontName(),e))&&(t._SetWordWrapChanged(),t._ClearMeasurementCache())});let Tu=!1,Iu=!1;_u.Gfx.RendererText=class{constructor(t,e){e=Object.assign({},pu,e),this._renderer=t,this._fontName="Arial",this._fontSize=16,this._fontSizeScale=1,this._lineHeight=0,this._isBold=!1,this._isItalic=!1,this._colorStr="black",this._isBBcodeEnabled=!1,this._iconSet=null,this._iconSmoothing=!0,this.onloadfont=null,this._alreadyLoadedFonts=new Set,this._horizontalAlign="left",this._verticalAlign="top",this._text="",this._bbString=null,this._wrappedText=_u.New(_u.WordWrap),this._wrapMode="word",this._textDirection="ltr",this._wordWrapChanged=!1,this._textLayoutChanged=!1,this._drawChanged=!1,this._forceRecreateTexture=!1,this._drawMaxCharCount=-1,this._drawCharCount=0,this._cssWidth=0,this._cssHeight=0,this._width=0,this._height=0,this._zoom=1,this._textCanvas=null,this._textContext=null,this._measureContext=null,this._measureContextTop=null,this._lastCanvasWidth=-1,this._lastCanvasHeight=-1,this._lastTextCanvasFont="",this._lastMeasureCanvasFont="",this._lastTextCanvasFillStyle="",this._lastTextCanvasOpacity=1,this._lastTextCanvasLineWidth=1,this._measureTextCallback=t=>this._MeasureText(t),this._measurementCache=new Map,this._measurementCacheIdleTimeout=new _u.IdleTimeout(()=>this._ClearMeasurementCache(!0),2),this._texture=null,this._enableMipMap=!0,this._rcTex=new _u.Rect,this._scaleFactor=1,this._textureTimeout=new _u.IdleTimeout(()=>{this.ReleaseTexture(),this._SetTextCanvasSize(8,8),this._SetDrawChanged()},e.timeout),this.ontextureupdate=null,this._wasReleased=!1,Gu.add(this)}Release(){this.onloadfont=null,this._alreadyLoadedFonts.clear(),this._iconSet=null,this._bbString=null,this._textCanvas=null,this._textContext=null,this._measureContext=null,this._measureContextTop=null,this._measureTextCallback=null,this._ClearMeasurementCache(),this._measurementCacheIdleTimeout.Release(),this._textureTimeout.Release(),this.ontextureupdate=null,this.ReleaseTexture(),this._wrappedText.Clear(),this._wrappedText=null,this._renderer=null,this._wasReleased=!0,Gu.delete(this)}_SetDrawChanged(){this._drawChanged=!0}_SetTextLayoutChanged(){this._SetDrawChanged(),this._textLayoutChanged=!0}_SetWordWrapChanged(){this._SetTextLayoutChanged(),this._wordWrapChanged=!0}SetBBCodeEnabled(t){if(t=!!t,this._isBBcodeEnabled===t)return;this._isBBcodeEnabled=t;const e=this._isBBcodeEnabled?"alphabetic":"top";this._textContext&&(this._textContext.textBaseline=e),this._measureContext&&(this._measureContext.textBaseline=e),this._ClearMeasurementCache(),this._SetWordWrapChanged()}IsBBCodeEnabled(){return this._isBBcodeEnabled}SetIconSet(t){this._iconSet!==t&&(this._iconSet=t,this._wrappedText.SetIconSet(t),this._iconSet&&this._iconSet.IsLoading()&&this._iconSet.LoadContent().then(()=>this._SetDrawChanged()),this._SetWordWrapChanged())}SetIconSmoothing(t){t=!!t,this._iconSmoothing!==t&&(this._iconSmoothing=t,this._SetDrawChanged())}SetFontName(t){t||(t="serif"),this._fontName!==t&&(this._fontName=t,this._ClearMeasurementCache(),this._SetWordWrapChanged())}GetFontName(){return this._fontName}SetFontSize(t){t<.1&&(t=.1),this._fontSize!==t&&(this._fontSize=t,this._ClearMeasurementCache(),this._SetWordWrapChanged())}GetFontSize(){return this._fontSize}SetFontSizeScale(t){this._fontSizeScale!==t&&(this._fontSizeScale=t,this._ClearMeasurementCache(),this._SetWordWrapChanged())}SetLineHeight(t){this._lineHeight!==t&&(this._lineHeight=t,this._SetTextLayoutChanged())}GetLineHeight(){return this._lineHeight}SetBold(t){t=!!t,this._isBold!==t&&(this._isBold=t,this._ClearMeasurementCache(),this._SetWordWrapChanged())}IsBold(){return this._isBold}SetItalic(t){t=!!t,this._isItalic!==t&&(this._isItalic=t,this._ClearMeasurementCache(),this._SetWordWrapChanged())}IsItalic(){return this._isItalic}SetDrawMaxCharacterCount(t){t=Math.floor(t),this._drawMaxCharCount!==t&&(this._drawMaxCharCount=t,this._SetDrawChanged())}GetDrawMaxCharacterCount(){return this._drawMaxCharCount}_GetFontString(t,e){let s=[];(this._isBold||e.HasStyleTag("b"))&&s.push("bold"),(this._isItalic||e.HasStyleTag("i"))&&s.push("italic");const i=e.GetStyleTag("size"),r=(i?parseFloat(i.param):this._fontSize)*this._fontSizeScale;t?s.push(r+"pt"):s.push(r*this.GetDrawScale()+"pt");let n=this._fontName;const a=e.GetStyleTag("font");return a&&a.param&&(n=a.param,this.onloadfont&&!this._alreadyLoadedFonts.has(n)&&(this.onloadfont(n),this._alreadyLoadedFonts.add(n))),n&&(du.has(n)?s.push(n):s.push('"'+n+'"')),s.join(" ")}SetColor(t){t instanceof _u.Color&&(t=t.getCssRgb()),this._colorStr!==t&&(this._colorStr=t,this._SetDrawChanged())}SetColorRgb(t,e,s){fu.setRgb(t,e,s),this.SetColor(fu)}SetHorizontalAlignment(t){if(!gu.has(t))throw new Error("invalid horizontal alignment");this._horizontalAlign!==t&&(this._horizontalAlign=t,this._SetTextLayoutChanged())}GetHorizontalAlignment(){return this._horizontalAlign}SetVerticalAlignment(t){if(!mu.has(t))throw new Error("invalid vertical alignment");this._verticalAlign!==t&&(this._verticalAlign=t,this._SetTextLayoutChanged())}GetVerticalAlignment(){return this._verticalAlign}SetWordWrapMode(t){if(!Su.has(t))throw new Error("invalid word wrap mode");this._wrapMode!==t&&(this._wrapMode=t,this._ClearMeasurementCache(),this._SetWordWrapChanged())}GetWordWrapMode(){return this._wrapMode}SetTextDirection(t){if(!yu.has(t))throw new Error("invalid text direction");this._textDirection!==t&&(this._textDirection=t,this._textContext&&(this._textContext.direction=this._textDirection),this._measureContext&&(this._measureContext.direction=this._textDirection),this._ClearMeasurementCache(),this._SetWordWrapChanged())}GetTextDirection(){return this._textDirection}SetText(t){this._text!==t&&(this._text=t,this._ClearMeasurementCache(),this._SetWordWrapChanged())}GetText(){return this._text}GetDrawScale(){return this._scaleFactor*this._zoom*self.devicePixelRatio}SetMipMapEnabled(t){t=!!t,this._enableMipMap!==t&&(this._enableMipMap=t,this._forceRecreateTexture=!0)}IsMipMapEnabled(){return this._enableMipMap}SetSize(t,e,s){if(void 0===s&&(s=1),t<=0||t<=0)return;if(this._cssWidth===t&&this._cssHeight===e&&this._zoom===s)return;const i=this._cssWidth;this._cssWidth=t,this._cssHeight=e,this._zoom=s;const r=self.devicePixelRatio;this._width=this._cssWidth*this._zoom*r,this._height=this._cssHeight*this._zoom*r;const n=Math.max(this._width,this._height),a=Math.min(this._renderer.GetMaxTextureSize(),4096);let o=1;n>a&&(o=a/n,this._width=Math.min(this._width*o,a),this._height=Math.min(this._height*o,a)),this._scaleFactor=o,this._cssWidth!==i?this._SetWordWrapChanged():this._SetTextLayoutChanged()}GetWidth(){return this._width}GetHeight(){return this._height}GetZoom(){return this._zoom}GetTextWidth(){return this._UpdateTextMeasurements(),this._wrappedText.GetMaxLineWidth()}GetTextHeight(){return this._UpdateTextMeasurements(),this._wrappedText.GetTotalLineHeight()+this._wrappedText.GetLineCount()*(this._lineHeight+4)-this._lineHeight}GetLengthInGraphemes(){this._UpdateTextMeasurements();let t=0;for(const e of this._wrappedText.GetLines())for(const s of e.fragments())t+=s.GetLength();return t}GetTexture(){return this._textureTimeout.Reset(),this._MaybeUpdate(),this._texture}HitTestFragment(t,e){this._UpdateTextMeasurements();const s=this.GetDrawScale(),i=this._wrappedText.GetLines();for(const r of i){const i=r.GetFontBoundingBoxDescent()*s;if(e>=r.GetPosY()-r.GetHeight()*s+i&&e<r.GetPosY()+i)for(const e of r.fragments())if(t>=e.GetPosX()&&t<e.GetPosX()+e.GetWidth()*s)return e}return null}*fragmentsWithTag(t){this._UpdateTextMeasurements();const e=this._wrappedText.GetLines();for(const s of e)for(const e of s.fragments()){const s=e.GetStyleTag("tag");s&&_u.equalsNoCase(s.param,t)&&(yield e)}}FindFragmentWithTag(t,e){for(const s of this.fragmentsWithTag(t)){if(0===e)return s;--e}return null}CountFragmentsWithTag(t){let e=0;for(const s of this.fragmentsWithTag(t))++e;return e}_MaybeUpdate(){(!this._texture||this._drawChanged||this._textLayoutChanged||this._wordWrapChanged||this._forceRecreateTexture)&&(this._wasReleased||this._width<=0||this._height<=0||this._DoUpdate())}_DoUpdate(){this._wasReleased||(this._UpdateTextMeasurements(),this._DrawTextToCanvas(),this._UpdateTexture(),this._textureTimeout.Reset())}_SetTextCanvasSize(t,e){this._textCanvas||(this._textCanvas=_u.CreateCanvas(16,16));let s=!1;this._lastCanvasWidth===t&&this._lastCanvasHeight===e||(this._lastCanvasWidth=t,this._lastCanvasHeight=e,this._textCanvas.width=t,this._textCanvas.height=e,s=!0),this._textContext||(this._textContext=this._textCanvas.getContext("2d"),s=!0),s?(this._textContext.textBaseline=this._isBBcodeEnabled?"alphabetic":"top",this._textContext.direction=this._textDirection,this._textContext.font=this._lastTextCanvasFont,this._textContext.fillStyle=this._lastTextCanvasFillStyle,this._textContext.strokeStyle=this._lastTextCanvasFillStyle,this._textContext.globalAlpha=this._lastTextCanvasOpacity,this._textContext.lineWidth=this._lastTextCanvasLineWidth):this._textContext.clearRect(0,0,t,e)}_MaybeCreateMeasureContext(){this._measureContext||(this._measureContext=_u.CreateCanvas(16,16).getContext("2d"),this._measureContextTop=_u.CreateCanvas(16,16).getContext("2d"),this._measureContext.textBaseline=this._isBBcodeEnabled?"alphabetic":"top",this._measureContextTop.textBaseline="top",this._measureContext.direction=this._textDirection,this._measureContextTop.direction=this._textDirection)}_SetMeasureFontString(t){this._lastMeasureCanvasFont!==t&&(this._lastMeasureCanvasFont=t,this._measureContext.font=t,this._measureContextTop.font=t)}_SupportsFontBoundingBoxMeasurements(){if(!Tu){Tu=!0,this._MaybeCreateMeasureContext();const t=this._measureContext.measureText("test");Iu="number"==typeof t.fontBoundingBoxAscent&&"number"==typeof t.fontBoundingBoxDescent}return Iu}_UpdateTextMeasurements(){this._UpdateWordWrap(),this._UpdateTextLayout()}_UpdateWordWrap(){this._wordWrapChanged&&(this._MaybeCreateMeasureContext(),!this._isBBcodeEnabled||this._bbString&&this._bbString.toString()===this._text||(this._bbString=new _u.BBString(this._text,{noEscape:!0})),this._measurementCacheIdleTimeout.Reset(),this._wrappedText.WordWrap(this._isBBcodeEnabled?this._bbString.toFragmentList():this._text,this._measureTextCallback,this._cssWidth,this._wrapMode,0),this._wordWrapChanged=!1)}_UpdateTextLayout(){this._textLayoutChanged&&(this._LayoutText(),this._textLayoutChanged=!1)}_ClearMeasurementCache(t){this._measurementCache.clear(),t||this._measurementCacheIdleTimeout.Cancel()}_AddToMeasurementCache(t,e){const s=this._measurementCache;if(s.set(t,e),s.size>1e3){let t=0;for(const e of s.keys())if(s.delete(e),t++,t>=10)break}}_MeasureText(t){const e=t.IsText()?t.GetCharacterArray().join(""):" ",s=this._GetFontString(!0,t),i=s+"|"+e,r=this._measurementCache;let n=r.get(i);if(n)return r.delete(i),r.set(i,n),n;this._SetMeasureFontString(s);const a=this._measureContext.measureText(e);let o=0;if(this._isBBcodeEnabled&&this._SupportsFontBoundingBoxMeasurements()){const t=this._measureContextTop.measureText(e);o=a.fontBoundingBoxAscent-t.fontBoundingBoxAscent}const h=t.GetStyleTag("size"),l=(h?parseFloat(h.param):this._fontSize)*this._fontSizeScale;return n={width:a.width,height:cu(l),fontBoundingBoxAscent:a.fontBoundingBoxAscent||0,fontBoundingBoxDescent:a.fontBoundingBoxDescent||0,topToAlphabeticDistance:o},this._AddToMeasurementCache(i,n),n}_SetDrawFontString(t){this._lastTextCanvasFont!==t&&(this._lastTextCanvasFont=t,this._textContext.font=t)}_SetDrawCanvasColor(t){this._lastTextCanvasFillStyle!==t&&(this._lastTextCanvasFillStyle=t,this._textContext.fillStyle=t,this._textContext.strokeStyle=t)}_SetDrawCanvasOpacity(t){this._lastTextCanvasOpacity!==t&&(this._lastTextCanvasOpacity=t,this._textContext.globalAlpha=t)}_SetDrawCanvasLineWith(t){this._lastTextCanvasLineWidth!==t&&(this._lastTextCanvasLineWidth=t,this._textContext.lineWidth=t)}_LayoutText(){const t=this.GetDrawScale(),e=(4+this._lineHeight)*t;let s=0;const i=this._wrappedText.GetLines();if(0===i.length)return;for(const t of i){t.SetPosX(NaN),t.SetPosY(NaN);for(const e of t.fragments())e.SetPosX(NaN),e.SetPosY(NaN)}const r=this._isBBcodeEnabled&&this._SupportsFontBoundingBoxMeasurements();let n=i[0].GetHeight()*t;if("center"===this._verticalAlign){const a=i.reduce((s,i)=>s+i.GetHeight()*t+e,0)-e;s=Math.max(this._height/2-a/2,0),r&&(n=i[0].GetTopToAlphabeticDistance()*t)}else if("bottom"===this._verticalAlign){const n=i.reduce((s,i)=>s+i.GetHeight()*t+e,0)-this._lineHeight*t,a=r?i.at(-1).GetFontBoundingBoxDescent()*t:0;s=this._height-n-a-2}for(let r=0,a=i.length;r<a;++r){const a=i[r],o=a.GetHeight()*t,h=s;if(this._isBBcodeEnabled){if(s+=0===r?n:o,r>0&&s>this._height-4*t)break}else if(r>0&&s>=this._height-o)break;h>=0&&this._LayoutTextLine(a,s,t),this._isBBcodeEnabled||(s+=o),s+=e}}_LayoutTextLine(t,e,s){let i=0;"center"===this._horizontalAlign?i=Math.floor((this._width-t.GetWidth()*s)/2):"right"===this._horizontalAlign&&(i=this._width-t.GetWidth()*s),t.SetPosX(i),t.SetPosY(e);for(const r of"ltr"===this._textDirection?t.fragments():t.fragmentsReverse())this._LayoutFragment(r,i,e,s),i+=r.GetWidth()*s}_LayoutFragment(t,e,s,i){const r=t.GetStyleTag("offsetx");e+=r?uu(r.param,t.GetHeight())*i:0;const n=t.GetStyleTag("offsety");if(s+=n?uu(n.param,t.GetHeight())*i:0,t.IsIcon()){const e=t.GetStyleTag("iconoffsety");s+=e?uu(e.param,t.GetHeight())*i:.2*t.GetHeight()*i}t.SetPosX(e),t.SetPosY(s)}_DrawTextToCanvas(){if(!this._drawChanged)return;this._SetTextCanvasSize(Math.max(_u.nextHighestPowerOfTwo(Math.ceil(this._width)),128),Math.max(_u.nextHighestPowerOfTwo(Math.ceil(this._height)),64)),this._textContext.imageSmoothingEnabled=this._iconSmoothing,this._textContext.imageSmoothingQuality="high",this._drawCharCount=0;const t=this.GetDrawScale(),e=this._wrappedText.GetLines();for(const s of e)this._DrawTextLine(s,t);this._drawChanged=!1}_DrawTextLine(t,e){const s=t.GetPosX(),i=t.GetPosY();if(Number.isFinite(s)&&Number.isFinite(i))for(const s of"ltr"===this._textDirection?t.fragments():t.fragmentsReverse())this._DrawFragment(s,e,t.GetHeight())}_DrawFragment(t,e,s){const i=this._textContext,r=t.GetPosX(),n=t.GetPosY();if(!Number.isFinite(r)||!Number.isFinite(n))return;const a=s/16;let o=t.GetWidth()*e;const h=t.GetHeight()*e,l=t.GetHeight()/16,c=(4+this._lineHeight)*e;let u=t.IsText()?t.GetCharacterArray():null;if(-1!==this._drawMaxCharCount){if(this._drawCharCount>=this._drawMaxCharCount)return;t.IsText()&&this._drawCharCount+u.length>this._drawMaxCharCount&&(u=u.slice(0,this._drawMaxCharCount-this._drawCharCount),o=this._MeasureText(t).width*e),this._drawCharCount+=t.GetLength()}const _=t.GetStyleTag("background"),d=t.HasStyleTag("u"),p=t.HasStyleTag("s");if(t.IsText()&&_u.IsCharArrayAllWhitespace(u)&&!_&&!d&&!p||t.HasStyleTag("hide"))return;const f=t.GetStyleTag("color"),g=t.GetStyleTag("opacity");this._SetDrawCanvasOpacity(g?parseFloat(g.param)/100:1),_&&(this._SetDrawCanvasColor(_.param),i.fillRect(r,n-h,o,h+c));const m=t.GetStyleTag("linethickness"),S=m?parseFloat(m.param):1,y=t.HasStyleTag("stroke");if(y&&this._SetDrawCanvasLineWith(.5*l*S*this.GetDrawScale()),t.IsText()){const e=u.join("");if(this._SetDrawFontString(this._GetFontString(!1,t)),!y){this._SetDrawCanvasLineWith(.5*l*S*this.GetDrawScale());const s=t.GetStyleTag("outlineback");s&&(this._SetDrawCanvasColor(s.param),this._FillOrStrokeText(!0,e,r,n,o))}if(this._SetDrawCanvasColor(f?f.param:this._colorStr),this._FillOrStrokeText(y,e,r,n,o),!y){this._SetDrawCanvasLineWith(.5*l*S*this.GetDrawScale());const s=t.GetStyleTag("outline");s&&(this._SetDrawCanvasColor(s.param),this._FillOrStrokeText(!0,e,r,n,o))}}else if(t.IsIcon()&&t.GetWidth()>0){const e=t.GetDrawable(this._iconSet);e&&i.drawImage(e,r,n-h,o,h)}if(this._SetDrawCanvasColor(f?f.param:this._colorStr),d&&lu(i,y,r,n+e*a,o,e*a*S),p){const t=e*l,s=n-h/4+t/2;i.fillRect(r,s-t*S/2,o,t*S)}}_FillOrStrokeText(t,e,s,i,r){"rtl"===this._textDirection&&(s+=r),t?"Gecko"===_u.Platform.BrowserEngine?this._textContext.strokeText(e,s,i,r):this._textContext.strokeText(e,s,i):"Gecko"===_u.Platform.BrowserEngine?this._textContext.fillText(e,s,i,r):this._textContext.fillText(e,s,i)}_UpdateTexture(){this._renderer.IsContextLost()||(this._texture&&!this._forceRecreateTexture||(this.ReleaseTexture(),this._texture=this._renderer.CreateDynamicTexture(this._textCanvas.width,this._textCanvas.height,{mipMap:this._enableMipMap,mipMapQuality:"high"}),this._forceRecreateTexture=!1),this._renderer.UpdateTexture(this._textCanvas,this._texture),this._rcTex.set(0,0,this._width/this._texture.GetWidth(),this._height/this._texture.GetHeight()),this.ontextureupdate&&this.ontextureupdate())}GetTexRect(){return this._rcTex}ReleaseTexture(){this._texture&&(this._renderer.IsContextLost()||this._renderer.DeleteTexture(this._texture),this._texture=null)}static OnContextLost(){for(const t of Gu)t.ReleaseTexture()}static GetAll(){return Gu.values()}}}{const Cu=self.C3;class bu{constructor(t){this._gl=t.GetContext(),this._version=t.GetWebGLVersionNumber(),this._timerExt=t._GetDisjointTimerQueryExtension(),this._query=null,this._isActive=!1,this._hasResult=!1,this._result=0,1===this._version?this._query=this._timerExt.createQueryEXT():this._query=this._gl.createQuery()}Release(){this._DeleteQueryObject(),this._gl=null,this._timerExt=null,this._hasResult=!1}_DeleteQueryObject(){this._query&&(1===this._version?this._timerExt.deleteQueryEXT(this._query):this._gl.deleteQuery(this._query),this._query=null)}BeginTimeElapsed(){if(this._isActive)throw new Error("query already active");1===this._version?this._timerExt.beginQueryEXT(this._timerExt.TIME_ELAPSED_EXT,this._query):this._gl.beginQuery(this._timerExt.TIME_ELAPSED_EXT,this._query),this._isActive=!0}EndTimeElapsed(){if(!this._isActive)throw new Error("query not active");1===this._version?this._timerExt.endQueryEXT(this._timerExt.TIME_ELAPSED_EXT):this._gl.endQuery(this._timerExt.TIME_ELAPSED_EXT),this._isActive=!1}CheckForResult(){if(!this._query||this._hasResult||this._isActive)return;let t=!1;t=1===this._version?this._timerExt.getQueryObjectEXT(this._query,this._timerExt.QUERY_RESULT_AVAILABLE_EXT):this._gl.getQueryParameter(this._query,this._gl.QUERY_RESULT_AVAILABLE);const e=this._gl.getParameter(this._timerExt.GPU_DISJOINT_EXT);t&&!e&&(1===this._version?this._result=this._timerExt.getQueryObjectEXT(this._query,this._timerExt.QUERY_RESULT_EXT):this._result=this._gl.getQueryParameter(this._query,this._gl.QUERY_RESULT),this._result/=1e9,this._hasResult=!0),(t||e)&&this._DeleteQueryObject()}HasResult(){return this._hasResult}GetResult(){if(!this._hasResult)throw new Error("no result available");return this._result}}Cu.Gfx.WebGLTimeElapsedQuery=class{constructor(t){this._renderer=t,this._frameNumber=t.GetFrameNumber(),this._isActive=!1,this._parentQuery=null,this._isNested=!1,this._realQuery=null,this._queries=[]}Release(){for(const t of this._queries)t instanceof bu&&t.Release();Cu.clearArray(this._queries),this._parentQuery=null,this._realQuery=null,this._renderer=null}BeginTimeElapsed(){if(this._isActive)throw new Error("query already active");const t=this._renderer._GetTimeQueryStack();t.length>0?(this._isNested=!0,this._parentQuery=t.at(-1),this._parentQuery._EndReal(),this._parentQuery._queries.push(this)):(this._isNested=!1,this._parentQuery=null),this._isActive=!0,t.push(this),this._StartReal()}EndTimeElapsed(){if(!this._isActive)throw new Error("query not active");if(this._renderer._GetTimeQueryStack().pop()!==this)throw new Error("can only end most nested query");this._isActive=!1,this._EndReal(),this._parentQuery&&(this._parentQuery._StartReal(),this._parentQuery=null)}_StartReal(){this._realQuery=Cu.New(bu,this._renderer),this._queries.push(this._realQuery),this._realQuery.BeginTimeElapsed()}_EndReal(){this._realQuery.EndTimeElapsed(),this._realQuery=null}CheckForResult(){for(const t of this._queries)t.CheckForResult()}IsNested(){return this._isNested}HasResult(){return this._queries.every(t=>t.HasResult())}GetResult(){return this._queries.reduce((t,e)=>t+e.GetResult(),0)}GetFrameNumber(){return this._frameNumber}}}{const xu=self.C3;xu.Gfx.WebGLQueryResultBuffer=class{constructor(t,e=1e3){this._renderer=t,this._maxQueries=e,this._buffer=[],this._renderer._AddQueryResultBuffer(this)}Release(){this.Clear(),this._renderer._RemoveQueryResultBuffer(this),this._renderer=null}Clear(){for(const t of this._buffer)t.Release();xu.clearArray(this._buffer)}AddTimeElapsedQuery(){const t=new xu.Gfx.WebGLTimeElapsedQuery(this._renderer);return this._buffer.push(t),this._buffer.length>this._maxQueries&&this._buffer.shift().Release(),t}CheckForResults(t){for(const e of this._buffer){if(e.GetFrameNumber()>=t)return;if(e.IsNested())return;e.CheckForResult()}}GetFrameRangeResultSum(t,e){if(e<=t)return NaN;let s=0;for(const i of this._buffer){if(i.GetFrameNumber()>=e)break;if(!(i.GetFrameNumber()<t)){if(!i.HasResult())return NaN;s+=i.GetResult()}}return s}DeleteAllBeforeFrameNumber(t){for(let e=0,s=this._buffer.length;e<s;++e){const s=this._buffer[e];if(!(s.GetFrameNumber()<t))return void(e>0&&this._buffer.splice(0,e));s.Release()}}}}{let wu=function(){Uu=-1;for(const t of Nu)t.checkFunc()&&(t.resolve(),Nu.delete(t));Nu.size>0&&(Uu=self.requestAnimationFrame(wu))};0;const Mu=self.C3,Pu=(self.assert,self.glMatrix),vu=(Pu.vec3,Pu.vec4),Ru=Pu.mat4,Au={powerPreference:"default",enableGpuProfiling:!0,alpha:!1,depth:!1,canSampleDepth:!1,maxWebGLVersion:2,failIfMajorPerformanceCaveat:!1},Du=new Set(["default","low-power","high-performance"]),Eu=new Mu.Quad(0,0,1,0,1,1,0,1),Fu=Ru.create(),Ou=Ru.create(),Bu=new Mu.Quad,Lu=new Mu.Rect;let ku=null;Mu.isDebug&&(self.debug_lose_webgl_context=function(){ku?ku.loseContext():console.warn("WEBGL_lose_context not supported")},self.debug_restore_webgl_context=function(){ku?ku.restoreContext():console.warn("WEBGL_lose_context not supported")});const Nu=new Set;let Uu=-1;Mu.Gfx.WebGLRenderer=class extends Mu.Gfx.RendererBase{constructor(t,e){if(super(e),e=Object.assign({},Au,e),!Du.has(e.powerPreference))throw new Error("invalid power preference");const s={alpha:!!e.alpha,depth:!1,antialias:!1,powerPreference:e.powerPreference,failIfMajorPerformanceCaveat:!!e.failIfMajorPerformanceCaveat};let i=null,r=0;if(e.maxWebGLVersion>=2&&(i=t.getContext("webgl2",s),r=2),i||(i=t.getContext("webgl",s),r=1),!i)throw new Error("renderer-unavailable (could not get WebGL context)");this._gl=i,this._attribs=i.getContextAttributes(),this._versionString=i.getParameter(i.VERSION),this._version=r,this._viewport=vu.create(),this._didChangeTransform=!1,this._bbProjectionMatrix=Ru.create(),this._usesDepthBuffer=!!e.depth,this._canSampleDepth=!(!e.depth||!e.canSampleDepth),this._isDepthEnabled=this._usesDepthBuffer,this._isDepthSamplingEnabled=!1,this._depthBuffer=null,this._isAutoSizeDepthBuffer=!0,this._depthBufferWidth=0,this._depthBufferHeight=0,this._vertexBuffer=null,this._texcoordBuffer=null,this._colorBuffer=null,this._indexBuffer=null,this._pointBuffer=null,this._isColorDataF16=this._version>=2&&void 0!==globalThis.Float16Array,this._vertexData=new Float32Array(196605),this._indexData=new Uint16Array(393210),this._texcoordData=new Float32Array(131070),this._colorData=this._isColorDataF16?new globalThis.Float16Array(262140):new Float32Array(262140),this._pointData=new Float32Array(32e3),this._vertexPtr=0,this._indexPtr=0,this._pointPtr=0,this._lastProgram=null,this._spDeviceTransformTextureFill=null,this._batch=[],this._batchPtr=0,this._topOfBatch=0,this._currentRenderTarget=null,this._lastPointZ=0,this._batchState=Mu.New(Mu.Gfx.BatchState,this),this._lastColor=Mu.New(Mu.Color,1,1,1,1),this._lastTexture0=null,this._lastTexture1=null,this._lastBlendMode=0,this._lastPointTexCoords=new Mu.Rect,this._lastScissorRect=Mu.New(Mu.Rect,0,0,-1,-1),this._coplanarMode=0,this._lastCullFace=0,this._lastFrontFaceWinding=0,this._maxTextureSize=-1,this._minPointSize=0,this._maxPointSize=0,this._unmaskedVendor="(unavailable)",this._unmaskedRenderer="(unavailable)",this._extensions=[],this._isInitialisingAfterContextRestored=!1,this._parallelShaderCompileExt=null,this._anisotropicExt=null,this._conservativeDepthExt=null,this._depthTextureExt=null,this._fragDepthExt=null,this._stdDerivativesExt=null,this._textureLodExt=null,this._blendMinMaxExt=null,this._maxAnisotropy=0,this._isGpuProfilingEnabled=!!e.enableGpuProfiling,this._timerExt=null,this._allQueryResultBuffers=new Set,this._timeQueryStack=[]}IsWebGL(){return!0}async InitState(){super.InitState();const t=this._gl;this._lastColor.setRgba(1,1,1,1),this._lastTexture0=null,this._lastTexture1=null,this._vertexPtr=0,this._indexPtr=0,this._pointPtr=0,Mu.clearArray(this._batch),this._batchPtr=0,this._topOfBatch=0,this._lastProgram=null,this._currentRenderTarget=null,this._lastPointTexCoords.set(0,0,1,1),this._lastPointZ=0;const e=this._batchState;e.currentShader=null,e.currentFramebuffer=null,e.currentFramebufferNoDepth=null,e.clearColor.setRgba(0,0,0,0),e.pointTexCoords.set(0,0,1,1),t.clearColor(0,0,0,0),t.clear(t.COLOR_BUFFER_BIT),t.enable(t.BLEND),t.blendFunc(t.ONE,t.ONE_MINUS_SRC_ALPHA),t.blendEquationSeparate(t.FUNC_ADD,t.FUNC_ADD),this._lastBlendMode=0,1===this._version?this._blendMinMaxExt=t.getExtension("EXT_blend_minmax"):this._blendMinMaxExt=null,this._InitBlendModes(t),t.cullFace(t.BACK),t.disable(t.CULL_FACE),this._lastCullFace=0,t.frontFace(t.CW),this._lastFrontFaceWinding=0,t.disable(t.STENCIL_TEST),t.disable(t.DITHER),this._usesDepthBuffer?(t.enable(t.DEPTH_TEST),t.depthMask(!0),t.depthFunc(t.LEQUAL)):(t.disable(t.DEPTH_TEST),t.depthMask(!1)),this._isDepthEnabled=this._usesDepthBuffer,this._isDepthSamplingEnabled=!1,this._pointBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this._pointBuffer),t.bufferData(t.ARRAY_BUFFER,this._pointData.byteLength,t.DYNAMIC_DRAW),this._vertexBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this._vertexBuffer),t.bufferData(t.ARRAY_BUFFER,this._vertexData.byteLength,t.DYNAMIC_DRAW),this._texcoordBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this._texcoordBuffer),t.bufferData(t.ARRAY_BUFFER,this._texcoordData.byteLength,t.DYNAMIC_DRAW),this._colorBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this._colorBuffer),t.bufferData(t.ARRAY_BUFFER,this._colorData.byteLength,t.DYNAMIC_DRAW),this._indexBuffer=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this._indexBuffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,this._indexData.byteLength,t.DYNAMIC_DRAW),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,null),this._maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE);const s=t.getParameter(t.ALIASED_POINT_SIZE_RANGE);this._minPointSize=s[0],this._maxPointSize=s[1],this._maxPointSize>2048&&(this._maxPointSize=2048),this._extensions=t.getSupportedExtensions();const i=t.getExtension("WEBGL_debug_renderer_info");if(i&&(this._unmaskedVendor=t.getParameter(i.UNMASKED_VENDOR_WEBGL),this._unmaskedRenderer=t.getParameter(i.UNMASKED_RENDERER_WEBGL)),this._parallelShaderCompileExt=t.getExtension("KHR_parallel_shader_compile"),this._version>=2&&("Chromium"!==Mu.Platform.BrowserEngine||Mu.Platform.BrowserVersionNumber>=135)&&(this._conservativeDepthExt=t.getExtension("EXT_conservative_depth")),Mu.isDebug&&(ku=t.getExtension("WEBGL_lose_context")),this._isGpuProfilingEnabled&&(1===this.GetWebGLVersionNumber()?this._timerExt=t.getExtension("EXT_disjoint_timer_query"):this._timerExt=t.getExtension("EXT_disjoint_timer_query_webgl2")||t.getExtension("EXT_disjoint_timer_query")),this._anisotropicExt=t.getExtension("EXT_texture_filter_anisotropic"),this._anisotropicExt?this._maxAnisotropy=t.getParameter(this._anisotropicExt.MAX_TEXTURE_MAX_ANISOTROPY_EXT):this._maxAnisotropy=0,this.GetWebGLVersionNumber()<2&&this._usesDepthBuffer&&this._canSampleDepth&&(this._depthTextureExt=t.getExtension("WEBGL_depth_texture"),!this._depthTextureExt))throw new Error("no depth texture support");this.GetWebGLVersionNumber()<2&&(this._fragDepthExt=t.getExtension("EXT_frag_depth"),this._stdDerivativesExt=t.getExtension("OES_standard_derivatives"),this._textureLodExt=t.getExtension("EXT_shader_texture_lod"));const r=Mu.Gfx.WebGLShaderProgram,n=r.GetDefaultVertexShaderSource(!1);let a=r.GetTextureFillFragmentShaderSource_WebGL1_NoFragDepth(),o=n,h=r.GetPointFragmentShaderSource_WebGL1_NoFragDepth(),l=r.GetPointVertexShaderSource_WebGL1(),c=r.GetTilemapFragmentShaderSource_WebGL1_NoFragDepth(),u=r.GetDefaultVertexShaderSource(!0),_=!1;this._usesDepthBuffer&&(this.GetWebGLVersionNumber()<2?this._fragDepthExt&&(a=r.GetTextureFillFragmentShaderSource_WebGL1_FragDepthEXT(),h=r.GetPointFragmentShaderSource_WebGL1_FragDepthEXT(),c=r.GetTilemapFragmentShaderSource_WebGL1_FragDepthEXT(),_=!0):(o=r.GetDefaultVertexShaderSource_WebGL2(),a=r.GetTextureFillFragmentShaderSource_WebGL2(this._SupportsConservativeDepth()),h=r.GetPointFragmentShaderSource_WebGL2(this._SupportsConservativeDepth()),l=r.GetPointVertexShaderSource_WebGL2(),c=r.GetTilemapFragmentShaderSource_WebGL2(this._SupportsConservativeDepth()),u=r.GetDefaultVertexShaderSource_WebGL2(!0)));const d=r.GetTileRandomizationFragmentShaderSource(this.GetWebGLVersionNumber(),_,this._stdDerivativesExt&&this._textureLodExt,this._SupportsConservativeDepth()),p=this.GetWebGLVersionNumber()>=2?r.GetDefaultVertexShaderSource_WebGL2():n,f=[[a,o,"<default>"],[a,o,"<default-device-transform>"],[h,l,"<point>"],[r.GetColorFillFragmentShaderSource(),n,"<fill>"],[r.GetLinearGradientFillFragmentShaderSource(),n,"<lineargradient>"],[r.GetPenumbraFillFragmentShaderSource(),n,"<penumbra>"],[r.GetHardEllipseFillFragmentShaderSource(),n,"<hardellipse>"],[r.GetHardEllipseOutlineFragmentShaderSource(),n,"<hardellipseoutline>"],[r.GetSmoothEllipseFillFragmentShaderSource(),n,"<smoothellipse>"],[r.GetSmoothEllipseOutlineFragmentShaderSource(),n,"<smoothellipseoutline>"],[r.GetSmoothLineFillFragmentShaderSource(),n,"<smoothline>"],[c,u,"<tilemap>"],[d,p,"<tilerandomization>"]],g=await Promise.all(f.map(t=>this.CreateShaderProgram({src:t[0],vertexSrc:t[1],name:t[2]})));this._spTextureFill=g[0],this._spDeviceTransformTextureFill=g[1],this._spPoints=g[2],this._spColorFill=g[3],this._spLinearGradientFill=g[4],this._spPenumbraFill=g[5],this._spHardEllipseFill=g[6],this._spHardEllipseOutline=g[7],this._spSmoothEllipseFill=g[8],this._spSmoothEllipseOutline=g[9],this._spSmoothLineFill=g[10],this._spTilemapFill=g[11],this._spTileRandomization=g[12],this.SetTextureFillMode()}async CreateShaderProgram(t){const e=await Mu.Gfx.WebGLShaderProgram.Create(this,t);return this._AddShaderProgram(e),e}ResetLastProgram(){this._lastProgram=null}SetSize(t,e,s){if(this._width===t&&this._height===e&&!s)return;this.EndBatch();const i=this._gl,r=this._batchState;this._width=t,this._height=e,this._SetViewport(0,0,t,e),this.CalculatePerspectiveMatrix(this._bbProjectionMatrix,t/e),this.SetProjectionMatrix(this._bbProjectionMatrix),this._spDeviceTransformTextureFill&&(i.useProgram(this._spDeviceTransformTextureFill.GetShaderProgram()),this._spDeviceTransformTextureFill._UpdateDeviceTransformUniforms(this._matP),this._lastProgram=this._spDeviceTransformTextureFill,this._batchState.currentShader=this._spDeviceTransformTextureFill),i.bindTexture(i.TEXTURE_2D,null),i.activeTexture(i.TEXTURE1),i.bindTexture(i.TEXTURE_2D,null),i.activeTexture(i.TEXTURE0),this._lastTexture0=null,this._lastTexture1=null,this._usesDepthBuffer&&this._isAutoSizeDepthBuffer&&this._SetDepthBufferSize(this._width,this._height),this._currentRenderTarget&&this._currentRenderTarget._Resize(this._width,this._height),i.bindFramebuffer(i.FRAMEBUFFER,null),this._currentRenderTarget=null,r.currentFramebuffer=null,r.currentFramebufferNoDepth=null}_SetDepthBufferSize(t,e){const s=this._gl;this._depthBuffer&&this._depthBufferWidth===t&&this._depthBufferHeight===e||(this._canSampleDepth?(this._depthBuffer&&s.deleteTexture(this._depthBuffer),this._depthBuffer=s.createTexture(),s.bindTexture(s.TEXTURE_2D,this._depthBuffer),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),this.GetWebGLVersionNumber()>=2?s.texImage2D(s.TEXTURE_2D,0,s.DEPTH24_STENCIL8,t,e,0,s.DEPTH_STENCIL,s.UNSIGNED_INT_24_8,null):this._depthTextureExt&&s.texImage2D(s.TEXTURE_2D,0,s.DEPTH_STENCIL,t,e,0,s.DEPTH_STENCIL,this._depthTextureExt.UNSIGNED_INT_24_8_WEBGL,null),s.bindTexture(s.TEXTURE_2D,null)):(this._depthBuffer&&s.deleteRenderbuffer(this._depthBuffer),this._depthBuffer=s.createRenderbuffer(),s.bindRenderbuffer(s.RENDERBUFFER,this._depthBuffer),s.renderbufferStorage(s.RENDERBUFFER,this._version>=2?s.DEPTH24_STENCIL8:s.DEPTH_STENCIL,t,e),s.bindRenderbuffer(s.RENDERBUFFER,null)),this._depthBufferWidth=t,this._depthBufferHeight=e)}SetFixedSizeDepthBuffer(t,e){this._usesDepthBuffer&&(this._isAutoSizeDepthBuffer=!1,this._SetDepthBufferSize(t,e))}SetAutoSizeDepthBuffer(){this._usesDepthBuffer&&(this._isAutoSizeDepthBuffer=!0,this._SetDepthBufferSize(this._width,this._height))}_SetViewport(t,e,s,i){const r=this._viewport;r[0]===t&&r[1]===e&&r[2]===s&&r[3]===i||(this.PushBatch().InitSetViewport(t,e,s,i),vu.set(r,t,e,s,i),this._topOfBatch=0)}SetFovY(t){super.SetFovY(t),this.CalculatePerspectiveMatrix(this._bbProjectionMatrix,this._width/this._height)}SetNearZ(t){super.SetNearZ(t),this.CalculatePerspectiveMatrix(this._bbProjectionMatrix,this._width/this._height)}SetFarZ(t){super.SetFarZ(t),this.CalculatePerspectiveMatrix(this._bbProjectionMatrix,this._width/this._height)}SetProjectionMatrix(t){Ru.exactEquals(this._matP,t)||(this.PushBatch().InitSetProjection(t),Ru.copy(this._matP,t),this._topOfBatch=0,this._didChangeTransform=!0)}SetDefaultRenderTargetProjectionState(){let t,e,s;const i=this._currentRenderTarget;null===i?(t=this._bbProjectionMatrix,e=this.GetWidth(),s=this.GetHeight()):(t=i.GetProjectionMatrix(),e=i.GetWidth(),s=i.GetHeight()),this.SetProjectionMatrix(t),this._SetViewport(0,0,e,s)}SetModelViewMatrix(t){Ru.exactEquals(this._matMV,t)||(this.PushBatch().InitSetModelView(t),Ru.copy(this._matMV,t),this._topOfBatch=0,this._didChangeTransform=!0)}ResetDidChangeTransformFlag(){this._didChangeTransform=!1}DidChangeTransform(){return this._didChangeTransform}GetBatchState(){return this._batchState}PushBatch(){const t=this._batch;return this._batchPtr===t.length&&t.push(new Mu.Gfx.WebGLBatchJob(this._batchState)),t[this._batchPtr++]}EndBatch(){0!==this._batchPtr&&(this.IsContextLost()||(this._WriteBuffers(),this._ExecuteBatch(),this._batchPtr=0,this._vertexPtr=0,this._indexPtr=0,this._pointPtr=0,this._topOfBatch=0))}_WriteBuffers(){const t=this._gl;this._vertexPtr>0&&(t.bindBuffer(t.ARRAY_BUFFER,this._vertexBuffer),t.bufferSubData(t.ARRAY_BUFFER,0,this._vertexData.subarray(0,3*this._vertexPtr)),t.bindBuffer(t.ARRAY_BUFFER,this._texcoordBuffer),t.bufferSubData(t.ARRAY_BUFFER,0,this._texcoordData.subarray(0,2*this._vertexPtr)),t.bindBuffer(t.ARRAY_BUFFER,this._colorBuffer),t.bufferSubData(t.ARRAY_BUFFER,0,this._colorData.subarray(0,4*this._vertexPtr))),this._indexPtr>0&&(t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this._indexBuffer),t.bufferSubData(t.ELEMENT_ARRAY_BUFFER,0,this._indexData.subarray(0,this._indexPtr))),this._pointPtr>0&&(t.bindBuffer(t.ARRAY_BUFFER,this._pointBuffer),t.bufferSubData(t.ARRAY_BUFFER,0,this._pointData.subarray(0,this._pointPtr)))}_ExecuteBatch(){const t=this._batch;for(let e=0,s=this._batchPtr;e<s;++e)t[e].Run()}GetOpacity(){return this._lastColor.getA()}SetColorRgba(t,e,s,i){const r=this._lastColor;r.equalsRgba(t,e,s,i)||(r.setRgba(t,e,s,i),this._currentStateGroup=null,2===this._topOfBatch&&(this._topOfBatch=0))}SetOpacity(t){const e=this._lastColor;e.getA()!==t&&(e.setA(t),this._currentStateGroup=null,2===this._topOfBatch&&(this._topOfBatch=0))}SetColor(t){const e=this._lastColor;e.equals(t)||(e.set(t),this._currentStateGroup=null,2===this._topOfBatch&&(this._topOfBatch=0))}ResetColor(){this.SetColorRgba(1,1,1,1)}GetColor(){return this._lastColor}SetTexture(t){t!==this._lastTexture0&&(this.PushBatch().InitSetTexture(t),this._lastTexture0=t,this._topOfBatch=0)}_ResetLastTexture(){this._lastTexture0=null}SetBlendMode(t){this._lastBlendMode!==t&&(this._lastBlendMode=t,this._SetBlend(this._GetBlendParametersByIndex(t)))}SetNamedBlendMode(t){this.SetBlendMode(this.NamedBlendToNumber(t))}_SetBlend(t){this.PushBatch().InitSetBlend(t),this._topOfBatch=0,this._currentStateGroup=null}IsPremultipliedAlphaBlend(){return 0===this._lastBlendMode}SetAlphaBlend(){this.SetBlendMode(0)}SetCullFaceMode(t){this._lastCullFace!==t&&(this.PushBatch().InitSetCullFaceMode(t),this._lastCullFace=t,this._topOfBatch=0,this._currentStateGroup=null)}GetCullFaceMode(){return this._lastCullFace}SetFrontFaceWinding(t){this._lastFrontFaceWinding!==t&&(this.PushBatch().InitSetFrontFaceWinding(t),this._lastFrontFaceWinding=t,this._topOfBatch=0,this._currentStateGroup=null)}GetFrontFaceWinding(){return this._lastFrontFaceWinding}SetCopyBlend(){this.SetBlendMode(3)}Rect(t){this.Rect2(t.getLeft(),t.getTop(),t.getRight(),t.getBottom())}Rect2(t,e,s,i){this.Quad2(t,e,s,e,s,i,t,i)}_AddToDrawBatch(t,e){(this._vertexPtr+t>65535||this._indexPtr+e>393210)&&this.EndBatch(),1===this._topOfBatch?this._batch[this._batchPtr-1]._indexCount+=e:(this.PushBatch().InitDraw(2*this._indexPtr,e),this._topOfBatch=1)}_AddIndicesForQuad(){const t=this._vertexPtr;let e=this._indexPtr;this._indexPtr+=6;const s=this._indexData;s[e++]=t,s[e++]=t+1,s[e++]=t+2,s[e++]=t,s[e++]=t+2,s[e]=t+3}Quad(t){this.Quad4(t,Eu)}Quad2(t,e,s,i,r,n,a,o){this._AddToDrawBatch(4,6),this._AddIndicesForQuad();const h=this._vertexData,l=this._vertexPtr;this._vertexPtr+=4;let c=3*l;const u=this._baseZ+this._currentZ;h[c++]=t,h[c++]=e,h[c++]=u,h[c++]=s,h[c++]=i,h[c++]=u,h[c++]=r,h[c++]=n,h[c++]=u,h[c++]=a,h[c++]=o,h[c]=u,Eu.writeToTypedArray(this._texcoordData,2*l),this._lastColor.writeToTypedArrayx4(this._colorData,4*l)}Quad3(t,e){this._AddToDrawBatch(4,6),this._AddIndicesForQuad();const s=this._vertexPtr;this._vertexPtr+=4,t.writeToTypedArray3D(this._vertexData,3*s,this._baseZ+this._currentZ),e.writeAsQuadToTypedArray(this._texcoordData,2*s),this._lastColor.writeToTypedArrayx4(this._colorData,4*s)}Quad4(t,e){this._AddToDrawBatch(4,6),this._AddIndicesForQuad();const s=this._vertexPtr;this._vertexPtr+=4,t.writeToTypedArray3D(this._vertexData,3*s,this._baseZ+this._currentZ),e.writeToTypedArray(this._texcoordData,2*s),this._lastColor.writeToTypedArrayx4(this._colorData,4*s)}Quad5(t,e,s){this._AddToDrawBatch(4,6),this._AddIndicesForQuad();const i=this._vertexPtr;this._vertexPtr+=4,t.writeToTypedArray3D(this._vertexData,3*i,this._baseZ+this._currentZ),e.writeToTypedArray(this._texcoordData,2*i),this._colorData.set(s,4*i)}Quad3D(t,e,s,i,r,n,a,o,h,l,c,u,_){this._AddToDrawBatch(4,6),this._AddIndicesForQuad();const d=this._vertexData,p=this._vertexPtr;this._vertexPtr+=4;let f=3*p;const g=this._baseZ+this._currentZ;d[f++]=t,d[f++]=e,d[f++]=g+s,d[f++]=i,d[f++]=r,d[f++]=g+n,d[f++]=a,d[f++]=o,d[f++]=g+h,d[f++]=l,d[f++]=c,d[f]=g+u,_.writeAsQuadToTypedArray(this._texcoordData,2*p),this._lastColor.writeToTypedArrayx4(this._colorData,4*p)}Quad3D2(t,e,s,i,r,n,a,o,h,l,c,u,_){this._AddToDrawBatch(4,6),this._AddIndicesForQuad();const d=this._vertexData,p=this._vertexPtr;this._vertexPtr+=4;let f=3*p;const g=this._baseZ+this._currentZ;d[f++]=t,d[f++]=e,d[f++]=g+s,d[f++]=i,d[f++]=r,d[f++]=g+n,d[f++]=a,d[f++]=o,d[f++]=g+h,d[f++]=l,d[f++]=c,d[f]=g+u,_.writeToTypedArray(this._texcoordData,2*p),this._lastColor.writeToTypedArrayx4(this._colorData,4*p)}Quad3D3(t,e,s,i,r,n,a,o,h,l,c,u,_,d){this._AddToDrawBatch(4,6),this._AddIndicesForQuad();const p=this._vertexData,f=this._vertexPtr;this._vertexPtr+=4;let g=3*f;const m=this._baseZ+this._currentZ;p[g++]=t,p[g++]=e,p[g++]=m+s,p[g++]=i,p[g++]=r,p[g++]=m+n,p[g++]=a,p[g++]=o,p[g++]=m+h,p[g++]=l,p[g++]=c,p[g]=m+u,_.writeToTypedArray(this._texcoordData,2*f),this._colorData.set(d,4*f)}DrawMesh(t,e,s,i){if(t.length%3!=0)throw new Error("vertex buffer length not multiple of 3");if(t.length>196605)throw new Error(`too many vertices (${t.length/3}, limit 65535)`);if(s.length%3!=0)throw new Error("index buffer length not multiple of 3");if(s.length>393210)throw new Error(`too many indices (${s.length}, limit 393210)`);this._AddToDrawBatch(t.length,s.length);const r=this._vertexPtr;this._vertexData.set(t,3*r),this._texcoordData.set(e,2*r);const n=this._indexData;if(0===r)n.set(s,this._indexPtr);else{let t=this._indexPtr;for(let e=0,i=s.length;e<i;++e)n[t++]=s[e]+r}const a=this._colorData;if(null!=i)a.set(i,4*r);else{const e=this._lastColor,s=e.getR(),i=e.getG(),n=e.getB(),o=e.getA();let h=4*r;for(let e=0,r=t.length;e<r;++e)a[h++]=s,a[h++]=i,a[h++]=n,a[h++]=o}this._vertexPtr+=t.length/3,this._indexPtr+=s.length}FullscreenQuad(t,e){this.SetCurrentZ(0),Ru.copy(Fu,this._matP),Ru.copy(Ou,this._matMV),this.SetDefaultRenderTargetProjectionState();const[s,i]=this.GetRenderTargetSize(this._currentRenderTarget),r=this.CalculateLookAtModelView2(0,0,this.GetDefaultCameraZ(i),0,0,0,i);if(this.SetModelViewMatrix(r),"crop"===t&&this._currentRenderTarget&&e){const t=this._width/2,s=this._height/2,i=e.GetWidth(),r=e.GetHeight(),n=this._currentRenderTarget.GetWidth(),a=this._currentRenderTarget.GetHeight(),o=Math.min(n,i),h=Math.min(a,r),l=Math.max(r-a,0),c=Math.max(a-r,0);Lu.set(-t,s-c,-t+o,s-h-c),Bu.setFromRect(Lu),Lu.set(0,l,o,h+l),Lu.divide(i,r),this.Quad3(Bu,Lu)}else{const t=s/2,e=i/2;this.Rect2(-t,e,t,-e)}this.SetProjectionMatrix(Fu),this.SetModelViewMatrix(Ou)}StartRenderingPoints(t){this._lastPointTexCoords.equals(t)||(this._lastPointTexCoords.copy(t),this.PushBatch().InitSetPointTexCoords(t),this._topOfBatch=0)}FinishRenderingPoints(){}Point(t,e,s,i){this._pointPtr>=7996&&this.EndBatch();let r=this._pointPtr;const n=this._baseZ+this._currentZ;2===this._topOfBatch&&this._lastPointZ===n?this._batch[this._batchPtr-1]._indexCount++:(this.PushBatch().InitPoints(r,n,this._lastColor),this._topOfBatch=2,this._lastPointZ=n);const a=this._pointData;a[r++]=t,a[r++]=e,a[r++]=s,a[r++]=i,this._pointPtr=r}SetProgram(t){this._lastProgram!==t&&(this.PushBatch().InitSetProgram(t),this._lastProgram=t,this._topOfBatch=0,this._currentStateGroup=null)}GetProgram(){return this._lastProgram}SetDeviceTransformTextureFillMode(){this.SetProgram(this._spDeviceTransformTextureFill)}SetGradientColor(t){this.PushBatch().InitSetGradientColor(t),this._topOfBatch=0}SetEllipseParams(t,e,s=1){this.PushBatch().InitSetEllipseParams(t,e,s),this._topOfBatch=0}SetTilemapInfo(t,e,s,i,r,n,a){if(this._lastProgram!==this._spTilemapFill)throw new Error("must set tilemap fill mode first");this.PushBatch().InitSetTilemapInfo(t,e,s,i,r,n,a),this._topOfBatch=0}SetTileRandomizationInfo(t,e,s,i,r,n,a){if(this._lastProgram!==this._spTileRandomization)throw new Error("must set tile randomization mode first");this.PushBatch().InitSetTileRandomizationInfo(t,e,s,i,r,n,a),this._topOfBatch=0}SetProgramParameters(t,e,s,i,r,n,a,o,h,l,c){const u=this._lastProgram;if(c%=10800,!u._hasAnyOptionalUniforms||u.AreOptionalUniformsAlreadySetInBatch(e,s,i,r,n,a,o,h,l,c))return;const _=this.PushBatch();_.InitSetProgramParameters(),u.SetOptionalUniformsInBatch(e,s,i,r,n,a,o,h,l,c);const d=_._mat4param;d[0]=n,d[1]=a,e.writeToTypedArray(d,2),d[6]=h,d[7]=l,s.writeToTypedArray(d,12);const p=_._colorParam;r.writeToTypedArray(p,0);const f=p[1];p[1]=p[3],p[3]=f,i.writeToTypedArray(_._srcOriginRect,0),_._startIndex=c,_._indexCount=o,u._uSamplerBack.IsUsed()?_._texParam=t?t.GetTexture():null:_._texParam=null,this._topOfBatch=0}SetProgramCustomParameters(t){const e=this._lastProgram;if(0===t.length||e.AreCustomParametersAlreadySetInBatch(t))return;const s=this.PushBatch();s.InitSetProgramCustomParameters(),e.SetCustomParametersInBatch(t),Mu.shallowAssignArray(s._shaderParams,t),this._topOfBatch=0}ClearRgba(t,e,s,i){this.PushBatch().InitClearSurface2(t,e,s,i),this._topOfBatch=0}Clear(t){this.PushBatch().InitClearSurface(t),this._topOfBatch=0}Start(){}Finish(){super.Finish(),this._gl.flush()}ClearDepth(){this._usesDepthBuffer&&this._currentRenderTarget&&this._currentRenderTarget.HasDepthBuffer()&&(this.PushBatch().InitClearDepth(this._isDepthEnabled),this._topOfBatch=0)}SetDepthEnabled(t){t=!!t,this._isDepthEnabled!==t&&this._usesDepthBuffer&&(this._isDepthEnabled=t,this.PushBatch().InitSetDepthEnabled(t),this._topOfBatch=0)}IsDepthEnabled(){return this._isDepthEnabled}_GetDepthBuffer(){return this._depthBuffer}_CanSampleDepth(){return this._canSampleDepth}SetDepthSamplingEnabled(t){if(t=!!t,this._canSampleDepth&&this._isDepthSamplingEnabled!==t){if(t&&this.IsDepthEnabled())throw new Error("depth still enabled");this._isDepthSamplingEnabled=t,this.PushBatch().InitSetDepthSamplingEnabled(t),this._topOfBatch=0}}SetScissorRect(t,e,s,i,r=0){t=Math.floor(t),e=Math.floor(e),s=Math.floor(s),i=Math.floor(i),this._lastScissorRect.equalsWH(t,e,s,i)||(this._lastScissorRect.setWH(t,e,s,i),e=(r||this.GetRenderTargetSize(this.GetRenderTarget())[1])-e-i,this.PushBatch().InitSetScissor(!0,t,e,s,i),this._topOfBatch=0)}RemoveScissorRect(){-1!==this._lastScissorRect.getRight()&&(this._lastScissorRect.set(0,0,-1,-1),this.PushBatch().InitSetScissor(!1,0,0,0,0),this._topOfBatch=0)}CheckForQueryResults(){for(const t of this._allQueryResultBuffers)t.CheckForResults(this._frameNumber)}IsContextLost(){return!this._gl||this._gl.isContextLost()||this._isInitialisingAfterContextRestored}OnContextLost(){super.OnDeviceOrContextLost(),Mu.Gfx.WebGLRendererTexture.OnContextLost(),Mu.Gfx.WebGLRenderTarget.OnContextLost(),Mu.Gfx.RendererText.OnContextLost();for(const t of this._allQueryResultBuffers)t.Clear();this._extensions=[],this._timerExt=null,this._parallelShaderCompileExt=null,this._conservativeDepthExt=null,this._anisotropicExt=null,this._depthTextureExt=null,this._fragDepthExt=null,this._stdDerivativesExt=null,this._textureLodExt=null,this._maxAnisotropy=0,this._unmaskedVendor="(unavailable)",this._unmaskedRenderer="(unavailable)",this._lastProgram=null,this._spDeviceTransformTextureFill=null,this._depthBuffer=null;for(const t of this._stateGroups.values())t.OnContextLost()}async OnContextRestored(){this._isInitialisingAfterContextRestored=!0,await this.InitState(),this._isInitialisingAfterContextRestored=!1;for(const t of this._stateGroups.values())t.OnContextRestored(this);this.SetSize(this._width,this._height,!0)}CreateStaticTexture(t,e){if(this.IsContextLost())throw new Error("context lost");this.EndBatch();const s=Mu.New(Mu.Gfx.WebGLRendererTexture,this);return s._CreateStatic(t,e),s}async CreateStaticTextureAsync(t,e){if(this.IsContextLost())throw new Error("context lost");if(e=Object.assign({},e),Mu.Supports.ImageBitmapOptions){let s=await createImageBitmap(t,{premultiplyAlpha:"premultiply"});const i=e.wrapX&&"clamp-to-edge"!==e.wrapX||e.wrapY&&"clamp-to-edge"!==e.wrapY,r=Mu.isPOT(s.width)&&Mu.isPOT(s.height);return this.SupportsNPOTTextures()||r||!i?e.premultiplyAlpha=!1:Mu.Supports.ImageBitmapOptionsResize?(s=await createImageBitmap(t,{premultiplyAlpha:"premultiply",resizeWidth:Mu.nextHighestPowerOfTwo(s.width),resizeHeight:Mu.nextHighestPowerOfTwo(s.height)}),e.premultiplyAlpha=!1):s=await createImageBitmap(t,{premultiplyAlpha:"none"}),await Mu.Asyncify(()=>this.CreateStaticTexture(s,e))}if(t instanceof Blob){if("undefined"==typeof Image)throw new Error("texture upload variant not supported in worker");const e=await Mu.BlobToImage(t);t=e}return await Mu.Asyncify(()=>this.CreateStaticTexture(t,e))}CreateDynamicTexture(t,e,s){this.EndBatch();const i=Mu.New(Mu.Gfx.WebGLRendererTexture,this);return i._CreateDynamic(t,e,s),i}UpdateTexture(t,e,s){this.EndBatch(),e._Update(t,s)}DeleteTexture(t){t&&(t.SubtractReference(),t.GetReferenceCount()>0||(this.EndBatch(),t===this._lastTexture0&&(this._gl.bindTexture(this._gl.TEXTURE_2D,null),this._lastTexture0=null),t===this._lastTexture1&&(this._gl.activeTexture(this._gl.TEXTURE1),this._gl.bindTexture(this._gl.TEXTURE_2D,null),this._gl.activeTexture(this._gl.TEXTURE0),this._lastTexture1=null),t._Delete()))}CreateRenderTarget(t){let e=this._width,s=this._height,i=!0;if(t&&("number"==typeof t.width&&(e=Math.floor(t.width),i=!1),"number"==typeof t.height&&(s=Math.floor(t.height),i=!1)),e<=0||s<=0)throw new Error("invalid size");this.EndBatch();const r=Mu.New(Mu.Gfx.WebGLRenderTarget,this);return r._Create(e,s,Object.assign({isDefaultSize:i},t)),this._currentRenderTarget=null,this._batchState.currentFramebuffer=null,this._batchState.currentFramebufferNoDepth=null,r}SetRenderTarget(t,e=!0){t!==this._currentRenderTarget&&(t&&t.IsDefaultSize()&&t._Resize(this._width,this._height),this.PushBatch().InitSetRenderTarget(t),this._currentRenderTarget=t,this._topOfBatch=0,e&&this.SetDefaultRenderTargetProjectionState())}GetRenderTarget(){return this._currentRenderTarget}GetRenderTargetSize(t){return t?[t.GetWidth(),t.GetHeight()]:[this._width,this._height]}CopyRenderTarget(t,e="stretch"){this._version<2||this._currentRenderTarget&&this._currentRenderTarget.GetMultisampling()>0?(this.SetCopyBlend(),this.ResetColor(),this.DrawRenderTarget(t,e)):(this.PushBatch().InitBlitFramebuffer(t,this._currentRenderTarget,e),this._topOfBatch=0)}DrawRenderTarget(t,e="stretch"){const s=t.GetTexture();if(!s)throw new Error("not a texture-backed render target");this.SetTexture(s),this.FullscreenQuad(e,s)}InvalidateRenderTarget(t){this._version<2||(this.PushBatch().InitInvalidateFramebuffer(t._GetFramebuffer()),this._topOfBatch=0)}DeleteRenderTarget(t){this.SetRenderTarget(null),this.EndBatch();const e=t.GetTexture();e===this._lastTexture0&&(this._gl.bindTexture(this._gl.TEXTURE_2D,null),this._lastTexture0=null),e===this._lastTexture1&&(this._gl.activeTexture(this._gl.TEXTURE1),this._gl.bindTexture(this._gl.TEXTURE_2D,null),this._gl.activeTexture(this._gl.TEXTURE0),this._lastTexture1=null),t._Delete()}async ReadBackRenderTargetToImageData(t,e,s){this.EndBatch();const i=this._currentRenderTarget;let r,n,a;t?(r=t.GetWidth(),n=t.GetHeight(),a=t._GetFramebuffer()):(r=this.GetWidth(),n=this.GetHeight(),a=null);let o=0,h=0,l=r,c=n;if(s){o=Mu.clamp(Math.floor(s.getLeft()),0,r-1),h=Mu.clamp(Math.floor(s.getTop()),0,n-1);let t=s.width();t=0===t?r-o:Mu.clamp(Math.floor(t),0,r-o);let e=s.height();e=0===e?n-h:Mu.clamp(Math.floor(e),0,n-h),l=t,c=e,h=n-(h+c)}const u=this._gl;u.bindFramebuffer(u.FRAMEBUFFER,a);const _=()=>{u.bindFramebuffer(u.FRAMEBUFFER,null),this._currentRenderTarget=null,this._batchState.currentFramebuffer=null,this._batchState.currentFramebufferNoDepth=null,this.SetRenderTarget(i)};let d;if(!e&&this.GetWebGLVersionNumber()>=2){u.bindFramebuffer(u.READ_FRAMEBUFFER,a);const t=u.createBuffer(),e=l*c*4,s=u.PIXEL_PACK_BUFFER;u.bindBuffer(s,t),u.bufferData(s,e,u.STREAM_READ),u.readPixels(o,h,l,c,u.RGBA,u.UNSIGNED_BYTE,0),u.bindFramebuffer(u.READ_FRAMEBUFFER,null),u.bindBuffer(s,null),_();const i=u.fenceSync(u.SYNC_GPU_COMMANDS_COMPLETE,0);await this._WaitForObjectReady(()=>u.getSyncParameter(i,u.SYNC_STATUS)===u.SIGNALED),u.deleteSync(i),d=new ImageData(l,c),u.bindBuffer(s,t),u.getBufferSubData(s,0,new Uint8Array(d.data.buffer),0,e),u.bindBuffer(s,null),u.deleteBuffer(t)}else d=new ImageData(l,c),u.readPixels(o,h,l,c,u.RGBA,u.UNSIGNED_BYTE,new Uint8Array(d.data.buffer)),_();return d}CoplanarStartStencilPass(){this.SetDepthEnabled(!0),this.PushBatch().InitCoplanarStartStencilPass(),this._topOfBatch=0,this._coplanarMode=1}CoplanarStartColorPass(t=!1){this.SetDepthEnabled(t),this.PushBatch().InitCoplanarStartColorPass(),this._topOfBatch=0,this._coplanarMode=2}IsCoplanarColorPass(){return 2===this._coplanarMode}CoplanarRestoreStandardRendering(t=!0){this.SetDepthEnabled(t),this.PushBatch().InitCoplanarRestore(),this._topOfBatch=0,this._coplanarMode=0}StartQuery(t){this.SupportsGPUProfiling()&&(this.PushBatch().InitStartQuery(t),this._topOfBatch=0)}EndQuery(t){this.SupportsGPUProfiling()&&(this.PushBatch().InitEndQuery(t),this._topOfBatch=0)}_WaitForObjectReady(t){const e=new Promise(e=>Nu.add({resolve:e,checkFunc:t}));return-1===Uu&&(Uu=self.requestAnimationFrame(wu)),e}GetEstimatedBackBufferMemoryUsage(){return this._width*this._height*(this._attribs.alpha?4:3)}GetEstimatedRenderBufferMemoryUsage(){let t=0;for(const e of Mu.Gfx.WebGLRenderTarget.allRenderTargets())e.GetTexture()||(t+=e.GetEstimatedMemoryUsage());return t}GetEstimatedTextureMemoryUsage(){let t=0;for(const e of Mu.Gfx.WebGLRendererTexture.allTextures())t+=e.GetEstimatedMemoryUsage();return t}GetWebGLVersionString(){return this._versionString}GetWebGLVersionNumber(){return this._version}IsColorDataF16(){return this._isColorDataF16}GetDisplayName(){return"webgl"+this.GetWebGLVersionNumber()}SupportsNPOTTextures(){return this.GetWebGLVersionNumber()>=2}GetMaxTextureSize(){return this._maxTextureSize}GetMinPointSize(){return this._minPointSize}GetMaxPointSize(){return this._maxPointSize}GetUnmaskedVendor(){return this._unmaskedVendor}GetUnmaskedRenderer(){return this._unmaskedRenderer}GetWebGLExtensionsAnalyticsString(){if(this.GetWebGLVersionNumber()>=2)return"webgl2";{const t=[];return this._fragDepthExt&&t.push("EXT_frag_depth"),this._stdDerivativesExt&&t.push("OES_standard_derivatives"),this._textureLodExt&&t.push("EXT_shader_texture_lod"),t.length>0?"webgl1:"+t.join(","):"webgl1:none"}}GetExtensions(){return this._extensions}SupportsGPUProfiling(){return!!this._timerExt}_GetDisjointTimerQueryExtension(){return this._timerExt}_GetParallelShaderCompileExtension(){return this._parallelShaderCompileExt}_SupportsConservativeDepth(){return!!this._conservativeDepthExt}_GetAnisotropicExtension(){return this._anisotropicExt}_GetMaxAnisotropy(){return this._maxAnisotropy}_AddQueryResultBuffer(t){this._allQueryResultBuffers.add(t)}_RemoveQueryResultBuffer(t){this._allQueryResultBuffers.delete(t)}_GetTimeQueryStack(){return this._timeQueryStack}GetContext(){return this._gl}_InitBlendModes(t){let e=t.FUNC_ADD,s=t.FUNC_ADD;this._version>=2?(e=t.MAX,s=t.MIN):this._blendMinMaxExt&&(e=this._blendMinMaxExt.MAX_EXT,s=this._blendMinMaxExt.MIN_EXT),this._InitBlendModeData([["normal",[t.ONE,t.ONE_MINUS_SRC_ALPHA]],["additive",[t.ONE,t.ONE]],["xor",[t.ONE,t.ONE_MINUS_SRC_ALPHA]],["copy",[t.ONE,t.ZERO]],["destination-over",[t.ONE_MINUS_DST_ALPHA,t.ONE]],["source-in",[t.DST_ALPHA,t.ZERO]],["destination-in",[t.ZERO,t.SRC_ALPHA]],["source-out",[t.ONE_MINUS_DST_ALPHA,t.ZERO]],["destination-out",[t.ZERO,t.ONE_MINUS_SRC_ALPHA]],["source-atop",[t.DST_ALPHA,t.ONE_MINUS_SRC_ALPHA]],["destination-atop",[t.ONE_MINUS_DST_ALPHA,t.SRC_ALPHA]],["lighten",[t.ONE,t.ONE,t.ONE,t.ONE,e,e]],["darken",[t.ONE,t.ONE,t.ONE,t.ONE,s,s]],["multiply",[t.DST_COLOR,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA]],["screen",[t.ONE,t.ONE_MINUS_SRC_COLOR,t.ONE,t.ONE_MINUS_SRC_ALPHA]]])}CreateWebGLText(){return this.CreateRendererText()}}}{const Wu=self.C3,ju=self.glMatrix,Vu=(ju.vec3,ju.mat4),zu=(self.assert,self.GPUBufferUsage),Hu=self.GPUShaderStage,Yu=(self.GPUMapMode,self.GPUTextureUsage),Xu={powerPreference:"default",depth:!1,failIfMajorPerformanceCaveat:!1,canSampleBackbuffer:!1,backTextureSampling:"bilinear",usesBackgroundBlending:!1,canSampleDepth:!1,isMultiTexturingAllowed:!0},qu=Math.floor(65535/4),Ju=4*qu-16,Qu=new Wu.Quad(0,0,1,0,1,1,0,1),Ku=Wu.New(Wu.Vector2),Zu=Wu.New(Wu.Rect),$u=(Wu.New(Wu.Rect),Wu.New(Wu.Quad));Wu.Gfx.WebGPURenderer=class extends Wu.Gfx.RendererBase{constructor(t){super(t),this._adapterOpts=null,this._adapter=null,this._adapterInfo=null,this._device=null,this._canvas=null,this._presentCtx=null,this._swapChainFormat="",this._swapChainTexture=null,this._swapChainTexView=null,this._viewportWidth=0,this._viewportHeight=0,this._matTransform=Vu.create(),this._depthBuffer=null,this._nullDepthBuffer=null,this._depthBufferView=null,this._nullDepthBufferView=null,this._depthBufferBindGroup=null,this._nullDepthBufferBindGroup=null,this._depthBufferWidth=0,this._depthBufferHeight=0,this._vertexUniformBuffer=null,this._fragmentUniformBuffer=null,this._fragmentC3ParamsBuffer=null,this._fragmentDefaultCustomParamsBuffer=null,this._vertexBuffer=null,this._texcoordBuffer=null,this._texIndexBuffer=null,this._colorBuffer=null,this._indexBuffer=null,this._pointsIndexBuffer=null,this._pointBuffer=null,this._vertexUniformBufferLayout=Wu.Gfx.WebGPUShaderProgram.GetVertexUniformBufferLayout(),this._vertexUniformBufferSize=Wu.Gfx.WebGPUShaderProgram.GetVertexUniformBufferSize(),this._vertexUniformArrayBuffer=null,this._vertexUniformf32=null,this._fragUniformBufferLayout=Wu.Gfx.WebGPUShaderProgram.GetFragmentUniformBufferLayout(),this._fragUniformBufferSize=Wu.Gfx.WebGPUShaderProgram.GetFragmentUniformBufferSize(),this._fragUniformArrayBuffer=null,this._fragUniformf32=null,this._fragC3ParamsLayout=Wu.Gfx.WebGPUShaderProgram.GetFragmentC3ParamsBufferLayout(),this._fragC3ParamsSize=Wu.Gfx.WebGPUShaderProgram.GetFragmentC3ParamsBufferSize(),this._fragC3ParamsArrayBuffer=null,this._fragC3Paramsf32=null,this._fragC3Paramsu32=null,this._vertexData=new Float32Array(196605),this._texcoordData=new Float32Array(131070),this._texIndexData=new Uint32Array(65535),this._colorData=null,this._indexData=new Uint16Array(393210),this._pointData=new Float32Array(4*qu),this._vertexPtr=0,this._indexPtr=0,this._currentMultiTextureIndex=0,this._currentColor=Wu.New(Wu.Color,1,1,1,1),this._pointPtr=0,this._bufferManager=Wu.New(Wu.Gfx.WebGPUBufferManager,this),this._flags=32768,this._flags2=0,this._drawFirstIndex=0,this._drawIndexCount=0,this._vertexUniformUpdateStart=0,this._vertexUniformUpdateEnd=0,this._fragUniformUpdateStart=0,this._fragUniformUpdateEnd=0,this._fragC3ParamsUpdateStart=0,this._fragC3ParamsUpdateEnd=0,this._scissorRect=Wu.New(Wu.Rect,0,0,0,0),this._currentColor2=Wu.New(Wu.Color,1,1,1,1),this._currentPointColor=Wu.New(Wu.Color,1,1,1,1),this._currentPointTexCoords=Wu.New(Wu.Rect,0,0,0,0),this._currentVertexZElevation=0,this._textureFormat="",this._bufferBindGroupLayout=null,this._defaultBufferBindGroup=null,this._textureBindGroupLayout=null,this._backTextureBindGroupLayout=null,this._depthTextureBindGroupLayout=null,this._nullTexture=null,this._currentTexture=null,this._currentTextureBindGroup=null,this._currentBackTexture=null,this._currentBackTextureBindGroup=null,this._currentDepthTextureBindGroup=null,this._currentBufferBindGroup=null,this._mipmapGeneratorPipeline=null,this._availableMultiTextures=new Set,this._nonFullMultiTexGroups=new Set,this._maxTextureSize=8192,this._pipelineLayout=null,this._defaultVertexModule=null,this._normVertexModule=null,this._currentProgram=null,this._currentBlendMode=0,this._currentMultisampleCount=0,this._currentCullFace=0,this._currentFrontFaceWinding=0,this._mipmapGeneratorProgram=null,this._spSingleTextureFill=null,this._samplerMap=new Map,this._commandEncoder=null,this._currentRenderPass=null,this._commandBuffers=[],this._backbufferRenderTarget=null,this._currentRenderTarget=null,this._canSampleBackbuffer=!1,this._backTextureSampling="bilinear",this._usesBackgroundBlending=!1,this._canSampleDepth=!1,this._frameTimeQuerySet=null,this._timestampIsMeasuring=!1,this._timestampStartIndex=-1,this._timestampEndIndex=-1,this._timestampStartedIndices=new Set,this.ondevicelost=null,this.ondevicerestored=null,this._InitBlendModes()}IsWebGPU(){return!0}_SetFlag(t,e){e?this._flags|=t:this._flags&=~t}_IsFlagSet(t){return 0!==(this._flags&t)}_SetFlag2(t,e){e?this._flags2|=t:this._flags2&=~t}_IsFlagSet2(t){return 0!==(this._flags2&t)}async Create(t,e){if(e=Object.assign({},Xu,e),!navigator.gpu)throw new Error("renderer-unavailable (WebGPU not supported)");if("Safari"===Wu.Platform.Browser||"iOS"===Wu.Platform.OS)throw new Error("WebGPU is currently disabled in Safari - see https://bugs.webkit.org/show_bug.cgi?id=301627");e.depth&&(this._flags|=524288),e.isMultiTexturingAllowed&&(this._flags|=65536),this._canSampleBackbuffer=!!e.canSampleBackbuffer,this._backTextureSampling=e.backTextureSampling,this._usesBackgroundBlending=!!e.usesBackgroundBlending,this._adapterOpts={},this._canSampleDepth=!(!e.depth||!e.canSampleDepth),"default"!==e.powerPreference&&(this._adapterOpts.powerPreference=e.powerPreference),this._canvas=t,await this._InitDevice(e.failIfMajorPerformanceCaveat)}async _InitDevice(t){for(this._device=null,await this._TryGetDeviceOnCurrentAdapter(t);!this._device;)this._adapter=null,await this._TryGetDeviceOnCurrentAdapter(t);await this.InitState()}async _TryGetDeviceOnCurrentAdapter(t){if(!this._adapter){if(this._adapter=await navigator.gpu.requestAdapter(this._adapterOpts),!this._adapter)throw new Error("renderer-unavailable (no WebGPU adapter available)");const e=this._adapter.info;if(t&&e.isFallbackAdapter)throw new Error("renderer-unavailable (WebGPU provided fallback adapter)");if("adreno-7xx"===e.architecture)throw new Error("WebGPU disabled on adreno-7xx devices - see https://issues.chromium.org/issues/329702056");if("intel"===e.vendor&&("gen-7"===e.architecture||"gen7"===e.architecture))throw new Error("WebGPU disabled on Intel Gen7 GPUs - see https://issues.chromium.org/issues/462468373")}const e=[];if(this._adapter.features.has("timestamp-query")&&e.push("timestamp-query"),this._adapter.features.has("shader-f16")&&e.push("shader-f16"),this._device=await this._adapter.requestDevice({requiredFeatures:e,requiredLimits:{maxTextureDimension2D:this._adapter.limits.maxTextureDimension2D}}),!this._device)return null;this._maxTextureSize=this._device.limits.maxTextureDimension2D,this._SetFlag(134217728,this._device.features.has("timestamp-query")),this._SetFlag(268435456,this._device.features.has("shader-f16")),this._SetFlag(536870912,this._IsFlagSet(268435456)&&void 0!==globalThis.Float16Array),this._device.lost.then(t=>this._OnDeviceLost(t)),this._SetFlag(32768,!1)}async _OnDeviceLost(t){console.log("[WebGPU] Device lost: ",t),super.OnDeviceOrContextLost(),this._bufferManager.OnContextLost(),Wu.Gfx.WebGPURendererTexture.OnContextLost(),Wu.Gfx.WebGPURenderTarget.OnContextLost(),Wu.Gfx.RendererText.OnContextLost(),this._swapChainFormat="",this._swapChainTexture=null,this._swapChainTexView=null,this._depthBuffer=null,this._depthBufferView=null,this._nullDepthBuffer=null,this._nullDepthBufferView=null,this._depthBufferBindGroup=null,this._nullDepthBufferBindGroup=null,this._vertexBuffer=null,this._texcoordBuffer=null,this._texIndexBuffer=null,this._colorBuffer=null,this._indexBuffer=null,this._pointsIndexBuffer=null,this._pointBuffer=null,this._vertexUniformBuffer=null,this._fragmentUniformBuffer=null,this._fragmentC3ParamsBuffer=null,this._fragmentDefaultCustomParamsBuffer=null,this._defaultBufferBindGroup=null,this._bufferBindGroupLayout=null,this._currentBufferBindGroup=null,this._textureBindGroupLayout=null,this._backTextureBindGroupLayout=null,this._depthTextureBindGroupLayout=null,this._pipelineLayout=null,this._currentProgram=null,this._nullTexture=null,this._currentTexture=null,this._currentTextureBindGroup=null,this._currentBackTexture=null,this._currentBackTextureBindGroup=null,this._currentDepthTextureBindGroup=null,this._defaultVertexModule=null,this._normVertexModule=null,this._backbufferRenderTarget=null,this._currentRenderTarget=null,this._mipmapGeneratorPipeline=null,this._frameTimeQuerySet=null,this._mipmapGeneratorProgram=null,this._spSingleTextureFill=null,this._availableMultiTextures.clear(),this._nonFullMultiTexGroups.clear(),this._samplerMap.clear();for(const t of this._stateGroups.values())t.OnContextLost();this._device=null,this._adapter=null,this._adapterInfo=null,this._flags|=32768,this.ondevicelost&&this.ondevicelost(),await this._InitDevice();for(const t of this._stateGroups.values())t.OnContextRestored(this);this.SetSize(this._width,this._height,!0),this.ondevicerestored&&this.ondevicerestored()}async InitState(){super.InitState();const t=this._device;this._swapChainFormat=navigator.gpu.getPreferredCanvasFormat(),this._swapChainTexture=null,this._swapChainTexView=null;let e=Yu.RENDER_ATTACHMENT;this._canSampleBackbuffer&&(e|=Yu.TEXTURE_BINDING),this._usesBackgroundBlending&&(e|=Yu.COPY_SRC),this._swapChainFormat.startsWith("rgba8")||this._swapChainFormat.startsWith("bgra8")?this._textureFormat=this._swapChainFormat:this._textureFormat="rgba8unorm",this._flags&=940113920,this._flags|=7680,this._flags2=0,this._IsFlagSet(524288)&&(this._flags|=70254592),this._vertexPtr=0,this._indexPtr=0,this._currentBlendMode=0,this._currentCullFace=0,this._currentFrontFaceWinding=0,this._currentMultisampleCount=0,this._currentColor.setRgba(1,1,1,1),this._currentColor2.setRgba(1,1,1,1),this._currentPointColor.setRgba(1,1,1,1),this._colorData=this.IsColorDataF16()?new globalThis.Float16Array(262140):new Float32Array(262140),this._vertexUniformArrayBuffer=new ArrayBuffer(this._vertexUniformBufferSize),this._vertexUniformf32=new Float32Array(this._vertexUniformArrayBuffer),this._fragUniformArrayBuffer=new ArrayBuffer(this._fragUniformBufferSize),this._fragUniformf32=new Float32Array(this._fragUniformArrayBuffer),this._fragC3ParamsArrayBuffer=new ArrayBuffer(this._fragC3ParamsSize),this._fragC3Paramsf32=new Float32Array(this._fragC3ParamsArrayBuffer),this._fragC3Paramsu32=new Uint32Array(this._fragC3ParamsArrayBuffer),this._vertexBuffer=t.createBuffer({label:"vertexbuffer",size:this._vertexData.byteLength,usage:zu.VERTEX|zu.COPY_DST}),this._texcoordBuffer=t.createBuffer({label:"texcoordbuffer",size:this._texcoordData.byteLength,usage:zu.VERTEX|zu.COPY_DST}),this._texIndexBuffer=t.createBuffer({label:"texindexbuffer",size:this._texIndexData.byteLength,usage:zu.VERTEX|zu.COPY_DST}),this._colorBuffer=t.createBuffer({label:"colorbuffer",size:this._colorData.byteLength,usage:zu.VERTEX|zu.COPY_DST}),this._indexBuffer=t.createBuffer({label:"indexbuffer",size:this._indexData.byteLength,usage:zu.INDEX|zu.COPY_DST}),this._pointsIndexBuffer=t.createBuffer({label:"pointsindexbuffer",size:6*qu*2,usage:zu.INDEX,mappedAtCreation:!0});const s=this._pointsIndexBuffer.getMappedRange();this._FillPointsIndexBuffer(s),this._pointsIndexBuffer.unmap(),this._pointBuffer=t.createBuffer({label:"pointbuffer",size:this._pointData.byteLength,usage:zu.VERTEX|zu.STORAGE|zu.COPY_DST}),this._bufferBindGroupLayout=t.createBindGroupLayout({label:"bufferbindgrouplayout",entries:[{binding:0,visibility:Hu.VERTEX,buffer:{type:"uniform",minBindingSize:this._vertexUniformBufferSize}},{binding:1,visibility:Hu.FRAGMENT,buffer:{type:"uniform",minBindingSize:this._fragUniformBufferSize}},{binding:3,visibility:Hu.VERTEX,buffer:{type:"read-only-storage",minBindingSize:this._pointData.byteLength}},{binding:4,visibility:Hu.FRAGMENT,buffer:{type:"uniform",minBindingSize:this._fragC3ParamsSize}},{binding:5,visibility:Hu.FRAGMENT,buffer:{type:"uniform"}}]});const i=[],r=Wu.Gfx.WebGPUMultiTextureGroup.GetMultiTextureLimit();for(let t=0;t<r;++t)i.push({binding:2*t,visibility:Hu.FRAGMENT,sampler:{type:"filtering"}},{binding:2*t+1,visibility:Hu.FRAGMENT,texture:{sampleType:"float",viewDimension:"2d"}});this._textureBindGroupLayout=t.createBindGroupLayout({label:"texturebindgrouplayout",entries:i}),this._backTextureBindGroupLayout=t.createBindGroupLayout({label:"backtexturebindgrouplayout",entries:[{binding:0,visibility:Hu.FRAGMENT,sampler:{type:"nearest"===this._backTextureSampling?"non-filtering":"filtering"}},{binding:1,visibility:Hu.FRAGMENT,texture:{sampleType:"float",viewDimension:"2d"}}]}),this._depthTextureBindGroupLayout=t.createBindGroupLayout({label:"depthtexturebindgrouplayout",entries:[{binding:0,visibility:Hu.FRAGMENT,sampler:{type:"non-filtering"}},{binding:1,visibility:Hu.FRAGMENT,texture:{sampleType:"depth",viewDimension:"2d"}}]}),this._pipelineLayout=t.createPipelineLayout({bindGroupLayouts:[this._bufferBindGroupLayout,this._textureBindGroupLayout,this._backTextureBindGroupLayout,this._depthTextureBindGroupLayout]});const n=Wu.Gfx.WebGPUShaderProgram,a=this.SupportsF16(),o=this.IsColorDataF16();this._defaultVertexModule=t.createShaderModule({label:"<default vertex module>",code:n._PreprocessVertexShaderCode(n.GetDefaultVertexShaderSource(o),a)}),this._defaultVertexModule.getCompilationInfo().then(t=>n.ReportShaderCompilationInfo("<default>","vertex",t)),this._normVertexModule=t.createShaderModule({label:"<normalized vertex module>",code:n._PreprocessVertexShaderCode(n.GetNormalizedVertexShaderSource(o),a)}),this._normVertexModule.getCompilationInfo().then(t=>n.ReportShaderCompilationInfo("<normalized>","vertex",t));const h=await Promise.all([n.Create(this,{name:"<default>",src:n.GetMultiTextureFillFragmentShaderSource(!1,o),srcFragDepth:n.GetMultiTextureFillFragmentShaderSource(!0,o),vertexSrc:n.GetTextureFillVertexShaderSource(o),normVertexSrc:n.GetNormalizedTextureFillVertexShaderSource(o)}),n.Create(this,{name:"<single-texture-fill>",src:n.GetSingleTextureFillFragmentShaderSource(!1,o),srcFragDepth:n.GetSingleTextureFillFragmentShaderSource(!0,o),vertexSrc:n.GetTextureFillVertexShaderSource(o),normVertexSrc:n.GetNormalizedTextureFillVertexShaderSource(o)}),n.Create(this,{name:"<generate-mipmap>",src:n._GetMipmapGeneratorFragmentSource(),vertexSrc:n._GetMipmapGeneratorVertexSource()}),n.Create(this,{name:"<point>",src:n._GetPointFragmentSource(!1),srcFragDepth:n._GetPointFragmentSource(!0),vertexSrc:n._GetPointVertexSource()}),n.Create(this,{name:"<tilemap>",src:n._GetTilemapFragmentShaderSource(!1),srcFragDepth:n._GetTilemapFragmentShaderSource(!0)}),n.Create(this,{name:"<fill>",src:n._GetColorFillFragmentShaderSource()}),n.Create(this,{name:"<lineargradient>",src:n._GetLinearGradientFillFragmentShaderSource()}),n.Create(this,{name:"<penumbra>",src:n._GetPenumbraFillFragmentShaderSource()}),n.Create(this,{name:"<hardellipse>",src:n._GetHardEllipseFillFragmentShaderSource()}),n.Create(this,{name:"<hardellipseoutline>",src:n._GetHardEllipseOutlineFragmentShaderSource()}),n.Create(this,{name:"<smoothellipse>",src:n._GetSmoothEllipseFillFragmentShaderSource()}),n.Create(this,{name:"<smoothellipseoutline>",src:n._GetSmoothEllipseOutlineFragmentShaderSource()}),n.Create(this,{name:"<tilerandomization>",src:n.GetTileRandomizationFragmentShaderSource(!1),srcFragDepth:n.GetTileRandomizationFragmentShaderSource(!0)}),n.Create(this,{name:"<smoothline>",src:n._GetSmoothLineFillFragmentShaderSource()})]);this._spTextureFill=h[0],this._spSingleTextureFill=h[1],this._mipmapGeneratorProgram=h[2],this._spPoints=h[3],this._spTilemapFill=h[4],this._spColorFill=h[5],this._spLinearGradientFill=h[6],this._spPenumbraFill=h[7],this._spHardEllipseFill=h[8],this._spHardEllipseOutline=h[9],this._spSmoothEllipseFill=h[10],this._spSmoothEllipseOutline=h[11],this._spTileRandomization=h[12],this._spSmoothLineFill=h[13];for(const t of h)this._AddShaderProgram(t);65536&this._flags?(this._flags|=393216,this._currentProgram=this._spTextureFill):this._currentProgram=this._spSingleTextureFill,this._mipmapGeneratorPipeline=this._mipmapGeneratorProgram._GetMipmapGeneratorPipeline(),this._vertexUniformBuffer=t.createBuffer({label:"vertexuniformbuffer",size:this._vertexUniformBufferSize,usage:zu.UNIFORM|zu.COPY_DST}),this._fragmentUniformBuffer=t.createBuffer({label:"fragmentuniformbuffer",size:this._fragUniformBufferSize,usage:zu.UNIFORM|zu.COPY_DST}),this._fragmentC3ParamsBuffer=t.createBuffer({label:"fragmentc3paramsuniformbuffer",size:this._fragC3ParamsSize,usage:zu.UNIFORM|zu.COPY_DST}),this._fragmentDefaultCustomParamsBuffer=t.createBuffer({label:"fragmentdefaultcustomparamsbuffer",size:16,usage:zu.UNIFORM|zu.COPY_DST}),this._vertexUniformUpdateStart=0,this._vertexUniformUpdateEnd=this._vertexUniformBufferSize,this._UpdateTransformUniform(),this._UpdatePointTexCoordsUniform(),this._UpdateZElevationUniform(),this._fragUniformUpdateStart=0,this._fragUniformUpdateEnd=this._fragUniformBufferSize,this._UpdateColor2Uniform(),this._UpdatePointColorUniform(),this._defaultBufferBindGroup=this._CreateBufferBindGroup(this._fragmentDefaultCustomParamsBuffer),this._currentBufferBindGroup=this._defaultBufferBindGroup;const l=Wu.CreateCanvas(32,32);l.getContext("2d"),this._nullTexture=await this.CreateStaticTextureAsync(l),this._currentTexture=null,this._currentTextureBindGroup=this._nullTexture._GetOwnTextureBindGroup(),this._currentMultiTextureIndex=0,this._currentBackTexture=null,this._currentBackTextureBindGroup=this._nullTexture._GetBackTextureBindGroup(),this._nullTexture._DisableMultiTexture(),this._nullDepthBuffer=this._device.createTexture({label:"nulldepthbuffer",size:[8,8,1],format:this._GetDepthBufferFormat(),usage:Yu.TEXTURE_BINDING}),this._nullDepthBufferView=this._nullDepthBuffer.createView({label:"nulldepthbufferview",aspect:"depth-only"}),this._nullDepthBufferBindGroup=this._device.createBindGroup({label:"nulldepthbufferbindgroup",layout:this._depthTextureBindGroupLayout,entries:[{binding:0,resource:this._GetSampler({sampling:"nearest"})},{binding:1,resource:this._nullDepthBufferView}]}),this._currentDepthTextureBindGroup=this._nullDepthBufferBindGroup,this._backbufferRenderTarget=Wu.New(Wu.Gfx.WebGPURenderTarget,this,!0),this._backbufferRenderTarget.GetTexture()._BackbufferTextureSetProperties(e,this._swapChainFormat),this._currentRenderTarget=this._backbufferRenderTarget,this._CreateCommandEncoder(),this._adapterInfo=this._adapter.info,this._presentCtx||(this._presentCtx=this._canvas.getContext("webgpu")),this._presentCtx.configure({device:t,format:this._swapChainFormat,usage:e,alphaMode:"premultiplied"})}_CreateBufferBindGroup(t){return this._device.createBindGroup({layout:this._bufferBindGroupLayout,entries:[{binding:0,resource:{buffer:this._vertexUniformBuffer}},{binding:1,resource:{buffer:this._fragmentUniformBuffer}},{binding:3,resource:{buffer:this._pointBuffer}},{binding:4,resource:{buffer:this._fragmentC3ParamsBuffer}},{binding:5,resource:{buffer:t}}]})}_FillPointsIndexBuffer(t){const e=new Uint16Array(t);let s=0,i=e.length,r=0;for(;s<i;)e[s++]=r,e[s++]=r+1,e[s++]=r+2,e[s++]=r,e[s++]=r+2,e[s++]=r+3,r+=4}_GetDevice(){return this._device}_GetDefaultVertexModule(){return this._defaultVertexModule}_GetNormalizedVertexModule(){return this._normVertexModule}async CreateShaderProgram(t){const e=await Wu.Gfx.WebGPUShaderProgram.Create(this,t);return this._AddShaderProgram(e),e}GetDisplayName(){return"webgpu"}GetSwapChainFormat(){return this._swapChainFormat}_GetDepthBufferFormat(){return"depth24plus-stencil8"}_GetSwapChainTexture(){return this._swapChainTexture}_GetSwapChainTexView(){return this._swapChainTexView}_CanSampleBackbuffer(){return this._canSampleBackbuffer}UsesBackgroundBlending(){return this._usesBackgroundBlending}_GetPipelineLayout(){return this._pipelineLayout}_GetTextureBindGroupLayout(){return this._textureBindGroupLayout}_GetBackTextureBindGroupLayout(){return this._backTextureBindGroupLayout}_GetBackTextureSampling(){return this._backTextureSampling}GetTextureFormat(){return this._textureFormat}GetMaxTextureSize(){return this._maxTextureSize}IsContextLost(){return this._IsFlagSet(32768)}SupportsGPUProfiling(){return this._IsFlagSet(134217728)}SupportsF16(){return this._IsFlagSet(268435456)}IsColorDataF16(){return this._IsFlagSet(536870912)}GetEstimatedBackBufferMemoryUsage(){const t=this.GetWidth()*this.GetHeight();let e=t*Wu.Gfx.WebGPURendererTexture.GetFormatByteSize(this._swapChainFormat);return this.UsesDepthBuffer()&&(e+=t*Wu.Gfx.WebGPURendererTexture.GetFormatByteSize(this._GetDepthBufferFormat())),e}GetEstimatedRenderBufferMemoryUsage(){let t=0;for(const e of Wu.Gfx.WebGPURenderTarget.allRenderTargets())e.IsBackBuffer()||(t+=e.GetTexture().GetEstimatedMemoryUsage());return t}GetEstimatedTextureMemoryUsage(){let t=0;for(const e of Wu.Gfx.WebGPURendererTexture.allTextures())e.IsRenderTarget()||(t+=e.GetEstimatedMemoryUsage());return t}SupportsNPOTTextures(){return!0}GetBufferManager(){return this._bufferManager}SetSize(t,e,s){(this._width!==t||this._height!==e||s)&&(this.EndBatch(),this._width=t,this._height=e,this._viewportWidth=t,this._viewportHeight=e,this._backbufferRenderTarget._CalculateProjection(),this.SetProjectionMatrix(this._backbufferRenderTarget.GetProjectionMatrix()),this._currentRenderTarget&&this._currentRenderTarget._Resize(this._width,this._height),this._IsFlagSet(524288)&&this._IsFlagSet(67108864)&&this._SetDepthBufferSize(t,e))}_SetDepthBufferSize(t,e){if(this._depthBuffer){if(this._depthBufferWidth===t&&this._depthBufferHeight===e)return;this._depthBuffer.destroy()}let s=Yu.RENDER_ATTACHMENT;this._canSampleDepth&&(s|=Yu.TEXTURE_BINDING),this._depthBuffer=this._device.createTexture({label:"depthbuffer",size:[t,e,1],format:this._GetDepthBufferFormat(),usage:s}),this._depthBufferView=this._depthBuffer.createView({label:"depthbufferview"}),this._canSampleDepth&&(this._depthBufferBindGroup=this._device.createBindGroup({label:"depthbufferbindgroup",layout:this._depthTextureBindGroupLayout,entries:[{binding:0,resource:this._GetSampler({sampling:"nearest"})},{binding:1,resource:this._depthBuffer.createView({label:"depthbufferview",aspect:"depth-only"})}]})),this._depthBufferWidth=t,this._depthBufferHeight=e}SetFixedSizeDepthBuffer(t,e){this.UsesDepthBuffer()&&(this._SetFlag(67108864,!1),this._SetDepthBufferSize(t,e))}SetAutoSizeDepthBuffer(){this.UsesDepthBuffer()&&(this._SetFlag(67108864,!0),this._SetDepthBufferSize(this._width,this._height))}SetProjectionMatrix(t){Vu.exactEquals(this._matP,t)||(Vu.copy(this._matP,t),this._UpdateTransformUniform())}SetDefaultRenderTargetProjectionState(){this.SetProjectionMatrix(this._currentRenderTarget.GetProjectionMatrix())}SetModelViewMatrix(t){Vu.exactEquals(this._matMV,t)||(Vu.copy(this._matMV,t),this._UpdateTransformUniform())}ResetDidChangeTransformFlag(){this._SetFlag2(1,!1)}DidChangeTransform(){return this._IsFlagSet2(1)}CreateStaticTexture(t,e){if(t&&!Wu.Gfx.WebGPURendererTexture.IsGPUImageCopyExternalImageSource(t)){const e=t.width||t.videoWidth,s=t.height||t.videoHeight,i=Wu.CreateCanvas(e,s);i.getContext("2d").drawImage(t,0,0,e,s),t=i}this.EndBatch();const s=Wu.New(Wu.Gfx.WebGPURendererTexture,this);return s._Create(t,e),s}async CreateStaticTextureAsync(t,e){if(Wu.Gfx.WebGPURendererTexture.IsGPUImageCopyExternalImageSource(t))return this.CreateStaticTexture(t,e);{if(!Wu.Supports.ImageBitmapOptions)throw new Error("no support for ImageBitmapOptions");const s=await createImageBitmap(t,{premultiplyAlpha:"premultiply"});return this.CreateStaticTexture(s,e)}}_GetSampler(t){const e=t.wrapX||"clamp-to-edge",s=t.wrapY||"clamp-to-edge",i=t.sampling;let r=t.anisotropy||0;"trilinear"!==i&&(r=0);const n=`${e},${s},${i},${r}`;let a=this._samplerMap.get(n);if(a)return a;const o={addressModeU:e,addressModeV:s,magFilter:"nearest",minFilter:"nearest",mipmapFilter:"nearest"};return"bilinear"!==i&&"trilinear"!==i||(o.magFilter="linear",o.minFilter="linear"),"trilinear"===i&&(o.mipmapFilter="linear",r>1&&(o.maxAnisotropy=r)),a=this._device.createSampler(o),this._samplerMap.set(n,a),a}_GetMipmapGeneratorPipeline(){return this._mipmapGeneratorPipeline}CreateDynamicTexture(t,e,s){this.EndBatch();const i=Wu.New(Wu.Gfx.WebGPURendererTexture,this);return i._CreateDynamic(t,e,s),i}UpdateTexture(t,e,s){return e._Update(t,s)}DeleteTexture(t){t&&(t.SubtractReference(),t.GetReferenceCount()>0||(this.IsContextLost()||(this.EndBatch(),this._currentTexture===t&&this.SetTexture(null),this._currentBackTexture===t&&this.SetBackTexture(null)),t._Delete()))}_SetMultiTextureAvailable(t,e){this.IsContextLost()||(e?this._availableMultiTextures.add(t):this._availableMultiTextures.delete(t))}_SetMultiTextureGroupNonFull(t,e){e?this._nonFullMultiTexGroups.add(t):this._nonFullMultiTexGroups.delete(t)}_TryCreateMultiTextureGroup(t){const e=[t],s=Wu.Gfx.WebGPUMultiTextureGroup.GetMultiTextureLimit();for(const t of this._nonFullMultiTexGroups)t.Release();for(const i of this._availableMultiTextures){if(e.length>=s)break;i!==t&&e.push(i)}e.length<2||Wu.New(Wu.Gfx.WebGPUMultiTextureGroup,this,e)}Start(){this._UpdateSwapChainTexture()}Restart(){this._UpdateSwapChainTexture()}_UpdateSwapChainTexture(){this._swapChainTexture=this._presentCtx.getCurrentTexture(),this._swapChainTexView=this._swapChainTexture.createView({label:"swapchaintextureview"}),this._backbufferRenderTarget.GetTexture()._BackbufferTextureStartFrame()}Finish(){null===this._currentRenderPass&&this._backbufferRenderTarget._IsAwaitingClear()&&this._BeginRenderPass(),super.Finish(),this._bufferManager.MaybeCollectUnusedBuffers(this._frameNumber),this._backbufferRenderTarget.GetTexture()._BackbufferTextureEndFrame(),this._swapChainTexture=null,this._swapChainTexView=null}_CreateCommandEncoder(){this._commandEncoder=this._device.createCommandEncoder(),this._flags&=-16385}StartFrameTiming(t){if(!this.SupportsGPUProfiling())throw new Error("GPU profiling not supported");if(this._frameTimeQuerySet)throw new Error("already started frame timing");return this._timestampIsMeasuring=!1,this._timestampStartedIndices.clear(),this._frameTimeQuerySet=Wu.New(Wu.Gfx.WebGPUTimeQuerySet,this,t),this._frameTimeQuerySet}StartMeasuringRenderPassTime(t,e){if(this.SupportsGPUProfiling()){if(!this._frameTimeQuerySet)throw new Error("not started frame timing");if(t<0||e<0||t===e)throw new Error("invalid timestamp index");this._MaybeEndRenderPass(),this._timestampIsMeasuring=!0,this._timestampStartIndex=t,this._timestampEndIndex=e}}StopMeasuringRenderPassTime(){this._timestampIsMeasuring&&(this._MaybeEndRenderPass(),this._timestampIsMeasuring=!1)}_AddToDrawBatch(t,e){if(this._vertexPtr+t>65535||this._indexPtr+e>393210)this.EndBatch();else if(1&this._flags)return void(this._drawIndexCount+=e);null===this._currentRenderPass&&this._BeginRenderPass(),this._flags|=1,this._drawFirstIndex=this._indexPtr,this._drawIndexCount=e}_AddIndicesForQuad(){const t=this._vertexPtr;let e=this._indexPtr;this._indexPtr+=6;const s=this._indexData;s[e++]=t,s[e++]=t+1,s[e++]=t+2,s[e++]=t,s[e++]=t+2,s[e]=t+3}_MaybeEndDrawBatch(){const t=this._flags;if(!(1&t))return;const e=this._currentRenderPass;if(16&t){const s=this._currentRenderTarget;e.setViewport(0,0,s.GetWidth(),s.GetHeight(),0,1),2&t?e.setIndexBuffer(this._pointsIndexBuffer,"uint16"):e.setIndexBuffer(this._indexBuffer,"uint16"),e.setVertexBuffer(0,this._vertexBuffer),e.setVertexBuffer(1,this._texcoordBuffer),e.setVertexBuffer(2,this._colorBuffer),e.setVertexBuffer(3,this._texIndexBuffer),25165824&t&&e.setStencilReference(1),4&t&&this._DoSetRenderPassScissorRect(e,this._scissorRect,s)}if(32&t){let s=0;1073741824&t?s=4:8388608&t?s=2:16777216&t?s=3:3145728&~t||(s=1),e.setPipeline(this._currentProgram.GetRenderPipelineForState(this._currentBlendMode,s,this._currentCullFace,this._currentFrontFaceWinding,this._currentMultisampleCount))}if(8192&t&&e.setBindGroup(0,this._currentBufferBindGroup),64&t&&e.setBindGroup(1,this._currentTextureBindGroup),128&t&&e.setBindGroup(2,this._currentBackTextureBindGroup),256&t&&e.setBindGroup(3,this._currentDepthTextureBindGroup),8&t){const s=this._currentRenderTarget;4&t?this._DoSetRenderPassScissorRect(e,this._scissorRect,s):e.setScissorRect(0,0,s.GetWidth(),s.GetHeight())}e.drawIndexed(this._drawIndexCount,1,this._drawFirstIndex,0,0),this._flags&=-8698}_DoSetRenderPassScissorRect(t,e,s){const i=s.GetWidth(),r=s.GetHeight();let n=Wu.clamp(e.getLeft(),0,i),a=Wu.clamp(e.getTop(),0,r),o=Wu.clamp(e.getRight(),n,i),h=Wu.clamp(e.getBottom(),a,r);Number.isNaN(n)&&(n=0),Number.isNaN(a)&&(a=0),Number.isNaN(o)&&(o=i),Number.isNaN(h)&&(h=r),t.setScissorRect(n,a,o-n,h-a)}_BeginRenderPass(){const t=this._flags;7680&t&&this._WriteUniformBuffers();let e=null;e=8388608&t?this._GetCoplanarStencilRenderPassOpts():16777216&t?this._GetCoplanarColorRenderPassOpts():this._GetStandardRenderPassOpts(),this._currentRenderPass=this._commandEncoder.beginRenderPass(e),this._flags|=25072}_GetStandardRenderPassOpts(){const t=this._flags,e=this._currentRenderTarget,s={colorAttachments:[{view:e._GetTextureView(),loadOp:e._IsAwaitingClear()?"clear":"load",clearValue:e._GetClearColor().toJSON(),storeOp:"store"}]};return this._MaybeSetTimestampRenderPassOption(s),e._SetIsAwaitingClear(!1),3145728&~t||(s.depthStencilAttachment={view:this._depthBufferView,depthLoadOp:4194304&t?"clear":"load",depthClearValue:1,depthStoreOp:"store",stencilLoadOp:"clear",stencilClearValue:0,stencilStoreOp:"discard"},this._flags&=-4194305),s}_GetCoplanarStencilRenderPassOpts(){const t=this._flags,e={colorAttachments:[],depthStencilAttachment:{view:this._depthBufferView,depthLoadOp:4194304&t?"clear":"load",depthClearValue:1,depthStoreOp:"store",stencilLoadOp:33554432&t?"clear":"load",stencilClearValue:0,stencilStoreOp:"store"}};return this._MaybeSetTimestampRenderPassOption(e),this._flags&=-37748737,e}_GetCoplanarColorRenderPassOpts(){const t=this._currentRenderTarget,e={colorAttachments:[{view:t._GetTextureView(),loadOp:t._IsAwaitingClear()?"clear":"load",clearValue:t._GetClearColor().toJSON(),storeOp:"store"}],depthStencilAttachment:{view:this._depthBufferView,depthReadOnly:!0,stencilReadOnly:!0}};return this._MaybeSetTimestampRenderPassOption(e),t._SetIsAwaitingClear(!1),e}_MaybeSetTimestampRenderPassOption(t){if(!this._timestampIsMeasuring)return;const e={querySet:this._frameTimeQuerySet._GetQuerySet(),endOfPassWriteIndex:this._timestampEndIndex};this._timestampStartedIndices.has(this._timestampStartIndex)||(e.beginningOfPassWriteIndex=this._timestampStartIndex,this._timestampStartedIndices.add(this._timestampStartIndex)),t.timestampWrites=e}_MaybeDoPendingClearRenderPass(t){t._IsAwaitingClear()&&(this._MaybeEndRenderPass(),this._commandEncoder.beginRenderPass({colorAttachments:[{view:t._GetTextureView(),loadOp:"clear",clearValue:t._GetClearColor().toJSON(),storeOp:"store"}]}).end(),this._flags|=16384,t._SetIsAwaitingClear(!1))}_MaybeEndRenderPass(){null!==this._currentRenderPass&&(this._MaybeEndDrawBatch(),this._currentRenderPass.end(),this._currentRenderPass=null)}EndBatch(t=!1){this._MaybeEndRenderPass(),this._frameTimeQuerySet&&t&&(this._frameTimeQuerySet.Resolve(this._commandEncoder),this._flags|=16384),16384&this._flags&&(this._commandBuffers.push(this._commandEncoder.finish()),this._CreateCommandEncoder()),0!==this._commandBuffers.length&&(this._WriteBuffers(),this._device.queue.submit(this._commandBuffers),Wu.clearArray(this._commandBuffers),this._bufferManager.AfterSubmit(),this._frameTimeQuerySet&&t&&(this._frameTimeQuerySet.ReadResult(),this._frameTimeQuerySet=null))}_WriteBuffers(){const t=this._device.queue;if(this._vertexPtr>0){const e=this._vertexPtr;t.writeBuffer(this._vertexBuffer,0,this._vertexData.buffer,0,3*e*4),t.writeBuffer(this._texcoordBuffer,0,this._texcoordData.buffer,0,2*e*4),65536&this._flags&&t.writeBuffer(this._texIndexBuffer,0,this._texIndexData.buffer,0,4*e);const s=this.IsColorDataF16()?2:4;t.writeBuffer(this._colorBuffer,0,this._colorData.buffer,0,4*e*s),this._vertexPtr=0}this._indexPtr>0&&(this._indexPtr%2!=0&&(this._indexData[this._indexPtr++]=0),t.writeBuffer(this._indexBuffer,0,this._indexData.buffer,0,2*this._indexPtr),this._indexPtr=0),this._pointPtr>0&&(t.writeBuffer(this._pointBuffer,0,this._pointData.buffer,0,4*this._pointPtr),this._pointPtr=0)}_UpdateTransformUniform(){this._flags|=512,this._flags2|=1,this._MarkVertexUniformBufferRangeChanged(this._vertexUniformBufferLayout.transform)}_UpdatePointTexCoordsUniform(){const t=this._vertexUniformBufferLayout.pointTex;this._currentPointTexCoords.writeToTypedArray(this._vertexUniformf32,t.offset/4),this._MarkVertexUniformBufferRangeChanged(t)}_UpdateZElevationUniform(){const t=this._vertexUniformBufferLayout.zElevation;this._vertexUniformf32[t.offset/4]=this._currentVertexZElevation,this._MarkVertexUniformBufferRangeChanged(t)}_MarkVertexUniformBufferRangeChanged(t){const e=t.offset,s=t.end;1024&this._flags?(this._vertexUniformUpdateStart=Math.min(this._vertexUniformUpdateStart,e),this._vertexUniformUpdateEnd=Math.max(this._vertexUniformUpdateEnd,s)):(this._flags|=1024,this._vertexUniformUpdateStart=e,this._vertexUniformUpdateEnd=s,this._MaybeEndRenderPass())}_UpdateColor2Uniform(){this._UpdateFragmentUniformColor(this._currentColor2,this._fragUniformBufferLayout.color2)}_UpdatePointColorUniform(){this._UpdateFragmentUniformColor(this._currentPointColor,this._fragUniformBufferLayout.pointColor)}_UpdateFragmentUniformColor(t,e){t.writeToTypedArray(this._fragUniformf32,e.offset/4),this._MarkFragUniformBufferRangeChanged(e)}_UpdateFragmentUniformVec2(t,e){t.writeToTypedArray(this._fragUniformf32,e.offset/4),this._MarkFragUniformBufferRangeChanged(e)}_MarkFragUniformBufferRangeChanged(t){const e=t.offset,s=t.end;2048&this._flags?(this._fragUniformUpdateStart=Math.min(this._fragUniformUpdateStart,e),this._fragUniformUpdateEnd=Math.max(this._fragUniformUpdateEnd,s)):(this._flags|=2048,this._fragUniformUpdateStart=e,this._fragUniformUpdateEnd=s,this._MaybeEndRenderPass())}_MaybeUpdateFragmentC3ParamsFloat(t,e){this._fragC3Paramsf32[e.offset/4]!==Math.fround(t)&&(this._fragC3Paramsf32[e.offset/4]=t,this._MarkFragC3ParamsRangeChanged(e))}_MaybeUpdateFragmentC3ParamsUint(t,e){this._fragC3Paramsu32[e.offset/4]!==t&&(this._fragC3Paramsu32[e.offset/4]=t,this._MarkFragC3ParamsRangeChanged(e))}_MaybeUpdateFragmentC3ParamsRect(t,e){t.equalsF32Array(this._fragC3Paramsf32,e.offset/4)||(t.writeToTypedArray(this._fragC3Paramsf32,e.offset/4),this._MarkFragC3ParamsRangeChanged(e))}_MarkFragC3ParamsRangeChanged(t){const e=t.offset,s=t.end;4096&this._flags?(this._fragC3ParamsUpdateStart=Math.min(this._fragC3ParamsUpdateStart,e),this._fragC3ParamsUpdateEnd=Math.max(this._fragC3ParamsUpdateEnd,s)):(this._flags|=4096,this._fragC3ParamsUpdateStart=e,this._fragC3ParamsUpdateEnd=s,this._MaybeEndRenderPass())}_WriteUniformBuffers(){const t=this._flags;512&t&&(Vu.multiply(this._matTransform,this._matP,this._matMV),this._vertexUniformf32.set(this._matTransform,this._vertexUniformBufferLayout.transform.offset/4)),1024&t&&this._bufferManager.UpdateBufferSubData(this._commandEncoder,this._vertexUniformBuffer,this._vertexUniformArrayBuffer,this._vertexUniformUpdateStart,this._vertexUniformUpdateEnd-this._vertexUniformUpdateStart),2048&t&&this._bufferManager.UpdateBufferSubData(this._commandEncoder,this._fragmentUniformBuffer,this._fragUniformArrayBuffer,this._fragUniformUpdateStart,this._fragUniformUpdateEnd-this._fragUniformUpdateStart),4096&t&&this._bufferManager.UpdateBufferSubData(this._commandEncoder,this._fragmentC3ParamsBuffer,this._fragC3ParamsArrayBuffer,this._fragC3ParamsUpdateStart,this._fragC3ParamsUpdateEnd-this._fragC3ParamsUpdateStart),this._flags=-7681&t|16384}CreateRenderTarget(t){let e=this._width,s=this._height,i=!0;if(t&&("number"==typeof t.width&&(e=Math.floor(t.width),i=!1),"number"==typeof t.height&&(s=Math.floor(t.height),i=!1)),e<=0||s<=0)throw new Error("invalid size");this.EndBatch();const r=Wu.New(Wu.Gfx.WebGPURenderTarget,this);return r._Create(e,s,Object.assign({isDefaultSize:i},t)),r}SetRenderTarget(t,e=!0){null===t&&(t=this._backbufferRenderTarget),this._currentRenderTarget!==t&&(this._MaybeEndRenderPass(),this._currentRenderTarget=t,this._SetFlag(2097152,t.HasDepthBuffer()),t.IsDefaultSize()&&!t.IsBackBuffer()&&t._Resize(this._width,this._height),e&&this.SetDefaultRenderTargetProjectionState())}InvalidateRenderTarget(t){}GetRenderTarget(){return this._currentRenderTarget===this._backbufferRenderTarget?null:this._currentRenderTarget}GetRenderTargetSize(t){return null===t?[this._width,this._height]:[t.GetWidth(),t.GetHeight()]}GetBackbufferRenderTarget(){return this._backbufferRenderTarget}DeleteRenderTarget(t){this.EndBatch(),this._currentRenderTarget===t&&this.SetRenderTarget(null);const e=t.GetTexture();this._currentTexture===e&&this.SetTexture(null),this._currentBackTexture===e&&this.SetBackTexture(null),t._Delete()}async ReadBackRenderTargetToImageData(t,e,s){this._MaybeDoPendingClearRenderPass(t),this.EndBatch(),null===t&&(t=this._backbufferRenderTarget);const i=this._device,r=t.GetWidth(),n=t.GetHeight();let a=0,o=0,h=r,l=n;if(s){a=Wu.clamp(Math.floor(s.getLeft()),0,r-1),o=Wu.clamp(Math.floor(s.getTop()),0,n-1);let t=s.width();t=0===t?r-a:Wu.clamp(Math.floor(t),0,r-a);let e=s.height();e=0===e?n-o:Wu.clamp(Math.floor(e),0,n-o),h=t,l=e}const c=i.createCommandEncoder(),u=t.GetTexture();let _=u._GetTexture(),d=null;"rgba8unorm"===u._GetFormat()?u.CanReadPixels()||Wu.NotYetImplemented():(d=this._ConvertTextureFormat(u,"rgba8unorm",c),_=d);const p=4*h,f=256*Math.ceil(p/256),g=i.createBuffer({size:f*l,usage:zu.MAP_READ|zu.COPY_DST});c.copyTextureToBuffer({texture:_,origin:[a,o,0]},{buffer:g,bytesPerRow:f},[h,l,1]);const m=c.finish();i.queue.submit([m]),d&&d.destroy(),await g.mapAsync(self.GPUMapMode.READ);const S=g.getMappedRange().slice(0);let y;if(f===p)y=new ImageData(new Uint8ClampedArray(S),h,l);else{const t=new ArrayBuffer(p*l),e=new Uint8Array(t);for(let t=0;t<l;++t){const s=t*f,i=t*p;e.set(new Uint8Array(S,s,p),i)}y=new ImageData(new Uint8ClampedArray(t),h,l)}return g.destroy(),y}_ConvertTextureFormat(t,e,s){const i=this._device,r=t.GetWidth(),n=t.GetHeight();if(t._GetFormat()===e)throw new Error("no conversion necessary");t.IsSampled()||Wu.NotYetImplemented();const a=i.createTexture({size:[r,n,1],format:e,usage:Yu.COPY_SRC|Yu.RENDER_ATTACHMENT}),o=this._mipmapGeneratorProgram._GetMipmapGeneratorPipeline(e),h=o.getBindGroupLayout(0),l=this._GetSampler({sampling:"nearest"}),c=t._GetTexture().createView({baseMipLevel:0,mipLevelCount:1}),u=a.createView({baseMipLevel:0,mipLevelCount:1}),_=s.beginRenderPass({colorAttachments:[{view:u,loadOp:"clear",clearValue:[0,0,0,0],storeOp:"store"}]}),d=i.createBindGroup({layout:h,entries:[{binding:0,resource:l},{binding:1,resource:c}]});return _.setPipeline(o),_.setBindGroup(0,d),_.draw(4),_.end(),a}SetDepthEnabled(t){524288&this._flags&&(t=!!t,!!(1048576&this._flags)!==t&&(2097152&this._flags&&this._MaybeEndRenderPass(),this._SetFlag(1048576,t)))}IsDepthEnabled(){return this._IsFlagSet(1048576)}UsesDepthBuffer(){return this._IsFlagSet(524288)}SetDepthSamplingEnabled(t){if(!this._canSampleDepth)return;if(t&&this.IsDepthEnabled())throw new Error("depth still enabled");const e=t?this._depthBufferBindGroup:this._nullDepthBufferBindGroup;this._currentDepthTextureBindGroup!==e&&(this._MaybeEndDrawBatch(),this._currentDepthTextureBindGroup=e,this._flags|=256)}Clear(t){this._MaybeEndRenderPass(),this._currentRenderTarget._SetIsAwaitingClear(!0),this._currentRenderTarget._GetClearColor().set(t)}ClearRgba(t,e,s,i){this._MaybeEndRenderPass(),this._currentRenderTarget._SetIsAwaitingClear(!0),this._currentRenderTarget._GetClearColor().setRgba(t,e,s,i)}ClearDepth(){2621440&~this._flags||(this._MaybeEndRenderPass(),this._flags|=4194304)}SetScissorRect(t,e,s,i){t=Math.floor(t),e=Math.floor(e),s=Math.floor(s),i=Math.floor(i),4&this._flags&&this._scissorRect.equalsWH(t,e,s,i)||(this._MaybeEndDrawBatch(),this._flags|=12,this._scissorRect.setWH(t,e,s,i))}RemoveScissorRect(){4&this._flags&&(this._MaybeEndDrawBatch(),this._flags&=-5,this._flags|=8)}GetTextureFillShaderProgram(){return 65536&this._flags?this._spTextureFill:this._spSingleTextureFill}SetTextureFillMode(){this.SetProgram(this.GetTextureFillShaderProgram())}SetProgram(t){if(this._currentProgram!==t){if(t===this._spTextureFill&&!(65536&this._flags))throw new Error("cannot set multitexture fill program when multitexturing not allowed");this._MaybeEndDrawBatch(),this._currentProgram=t,this._currentStateGroup=null,this._flags|=32,this._SetMultiTexturingEnabled(t===this._spTextureFill)}}GetProgram(){return this._currentProgram}_SetMultiTexturingEnabled(t){if(t=!!t,!!(131072&this._flags)===t)return;this._SetFlag(131072,t);const e=null===this._currentTexture?this._nullTexture:this._currentTexture;this._ApplyTextureBindGroup(e)}_SetMultiTexturingActive(t){t=!!t,!!(262144&this._flags)!==t&&(this._MaybeEndDrawBatch(),this._SetFlag(262144,t),this._SetFlag(32,!0))}SetNormalizedCoordsProgramVariant(t){t=!!t,!!(1073741824&this._flags)!==t&&(this._MaybeEndDrawBatch(),this._SetFlag(1073741824,t),this._flags|=32)}IsNormalizedCoordsProgramVariant(){return this._IsFlagSet(1073741824)}SetTexture(t){t!==this._currentTexture&&(this._currentTexture=t,null===t&&(t=this._nullTexture),this._ApplyTextureBindGroup(t))}_ApplyTextureBindGroup(t){if(131072&this._flags){const e=t._GetMultiTextureBindGroup();if(null!==e)return this._SetTextureBindGroup(e),this._currentMultiTextureIndex=t._GetMultiTextureIndex(),void this._SetMultiTexturingActive(!0)}this._SetTextureBindGroup(t._GetOwnTextureBindGroup()),this._currentMultiTextureIndex=0,this._SetMultiTexturingActive(!1)}_SetTextureBindGroup(t){t!==this._currentTextureBindGroup&&(this._MaybeEndDrawBatch(),this._currentTextureBindGroup=t,this._flags|=64)}_OnTextureBindGroupChanged(t){this._currentTexture===t&&(this._MaybeEndDrawBatch(),this._currentTextureBindGroup=t._GetOwnTextureBindGroup(),this._flags|=64)}_OnMultiTextureBindGroupReleased(t){if(this._currentTextureBindGroup!==t)return;this._MaybeEndDrawBatch();const e=null===this._currentTexture?this._nullTexture:this._currentTexture;this._currentTextureBindGroup=e._GetOwnTextureBindGroup(),this._currentMultiTextureIndex=0,this._flags|=64}SetBackTexture(t){t!==this._currentBackTexture&&(this._currentBackTexture=t,null===t&&(t=this._nullTexture),this._MaybeEndDrawBatch(),this._currentBackTextureBindGroup=t._GetBackTextureBindGroup(),this._flags|=128)}CopyTextureToTexture(t,e,s,i,r,n){const a=t._GetUsage(),o=e._GetUsage();if(0===(a&Yu.COPY_SRC))throw new Error("source texture missing COPY_SRC usage");if(0===(o&Yu.COPY_DST))throw new Error("destination texture missing COPY_DST usage");if(t===e)throw new Error("invalid destination");const h=Math.min(t.GetWidth(),e.GetWidth()),l=Math.min(t.GetHeight(),e.GetHeight());r=Math.min(r,h-s),n=Math.min(n,l-i),r<=0||n<=0||(this._MaybeEndRenderPass(),this._commandEncoder.copyTextureToTexture({texture:t._GetTexture(),origin:[s,i]},{texture:e._GetTexture(),origin:[s,i]},[r,n]),this._flags|=16384)}_ClampToSupportedMultisampleValues(t){return t>=2?4:1}SetRenderingToMultisampleCount(t){t=this._ClampToSupportedMultisampleValues(t),this._currentMultisampleCount!==t&&(this._MaybeEndDrawBatch(),this._currentMultisampleCount=t,this._flags|=32)}SetBlendMode(t){t!==this._currentBlendMode&&(this._MaybeEndDrawBatch(),this._currentBlendMode=t,this._currentStateGroup=null,this._flags|=32)}SetNamedBlendMode(t){this.SetBlendMode(this.NamedBlendToNumber(t))}SetAlphaBlend(){this.SetBlendMode(0)}SetCopyBlend(){this.SetBlendMode(3)}SetColorRgba(t,e,s,i){const r=this._currentColor;r.equalsRgba(t,e,s,i)||(r.setRgba(t,e,s,i),this._currentStateGroup=null)}SetOpacity(t){const e=this._currentColor;e.getA()!==t&&(e.setA(t),this._currentStateGroup=null)}GetOpacity(){return this._currentColor.getA()}SetColor(t){const e=this._currentColor;e.equals(t)||(e.set(t),this._currentStateGroup=null)}ResetColor(){this.SetColorRgba(1,1,1,1)}GetColor(){return this._currentColor}SetCullFaceMode(t){t!==this._currentCullFace&&(this._MaybeEndDrawBatch(),this._currentCullFace=t,this._currentStateGroup=null,this._flags|=32)}GetCullFaceMode(){return this._currentCullFace}SetFrontFaceWinding(t){t!==this._currentFrontFaceWinding&&(this._MaybeEndDrawBatch(),this._currentFrontFaceWinding=t,this._currentStateGroup=null,this._flags|=32)}GetFrontFaceWinding(){return this._currentFrontFaceWinding}Rect(t){this.Rect2(t.getLeft(),t.getTop(),t.getRight(),t.getBottom())}Rect2(t,e,s,i){this.Quad2(t,e,s,e,s,i,t,i)}_WriteQuadTexIndices(t){const e=this._texIndexData,s=this._currentMultiTextureIndex;e[t++]=s,e[t++]=s,e[t++]=s,e[t]=s}Quad(t){this.Quad4(t,Qu)}Quad2(t,e,s,i,r,n,a,o){this._AddToDrawBatch(4,6),this._AddIndicesForQuad();const h=this._vertexData,l=this._vertexPtr;this._vertexPtr+=4;let c=3*l;const u=this._baseZ+this._currentZ;h[c++]=t,h[c++]=e,h[c++]=u,h[c++]=s,h[c++]=i,h[c++]=u,h[c++]=r,h[c++]=n,h[c++]=u,h[c++]=a,h[c++]=o,h[c]=u,Qu.writeToTypedArray(this._texcoordData,2*l),262144&this._flags&&this._WriteQuadTexIndices(l),this._currentColor.writeToTypedArrayx4(this._colorData,4*l)}Quad3(t,e){this._AddToDrawBatch(4,6),this._AddIndicesForQuad();const s=this._vertexPtr;this._vertexPtr+=4,t.writeToTypedArray3D(this._vertexData,3*s,this._baseZ+this._currentZ),e.writeAsQuadToTypedArray(this._texcoordData,2*s),262144&this._flags&&this._WriteQuadTexIndices(s),this._currentColor.writeToTypedArrayx4(this._colorData,4*s)}Quad4(t,e){this._AddToDrawBatch(4,6),this._AddIndicesForQuad();const s=this._vertexPtr;this._vertexPtr+=4,t.writeToTypedArray3D(this._vertexData,3*s,this._baseZ+this._currentZ),e.writeToTypedArray(this._texcoordData,2*s),262144&this._flags&&this._WriteQuadTexIndices(s),this._currentColor.writeToTypedArrayx4(this._colorData,4*s)}Quad5(t,e,s){this._AddToDrawBatch(4,6),this._AddIndicesForQuad();const i=this._vertexPtr;this._vertexPtr+=4,t.writeToTypedArray3D(this._vertexData,3*i,this._baseZ+this._currentZ),e.writeToTypedArray(this._texcoordData,2*i),262144&this._flags&&this._WriteQuadTexIndices(i),this._colorData.set(s,4*i)}Quad3D(t,e,s,i,r,n,a,o,h,l,c,u,_){this._AddToDrawBatch(4,6),this._AddIndicesForQuad();const d=this._vertexData,p=this._vertexPtr;this._vertexPtr+=4;let f=3*p;const g=this._baseZ+this._currentZ;d[f++]=t,d[f++]=e,d[f++]=g+s,d[f++]=i,d[f++]=r,d[f++]=g+n,d[f++]=a,d[f++]=o,d[f++]=g+h,d[f++]=l,d[f++]=c,d[f]=g+u,_.writeAsQuadToTypedArray(this._texcoordData,2*p),262144&this._flags&&this._WriteQuadTexIndices(p),this._currentColor.writeToTypedArrayx4(this._colorData,4*p)}Quad3D2(t,e,s,i,r,n,a,o,h,l,c,u,_){this._AddToDrawBatch(4,6),this._AddIndicesForQuad();const d=this._vertexData,p=this._vertexPtr;this._vertexPtr+=4;let f=3*p;const g=this._baseZ+this._currentZ;d[f++]=t,d[f++]=e,d[f++]=g+s,d[f++]=i,d[f++]=r,d[f++]=g+n,d[f++]=a,d[f++]=o,d[f++]=g+h,d[f++]=l,d[f++]=c,d[f]=g+u,_.writeToTypedArray(this._texcoordData,2*p),262144&this._flags&&this._WriteQuadTexIndices(p),this._currentColor.writeToTypedArrayx4(this._colorData,4*p)}Quad3D3(t,e,s,i,r,n,a,o,h,l,c,u,_,d){this._AddToDrawBatch(4,6),this._AddIndicesForQuad();const p=this._vertexData,f=this._vertexPtr;this._vertexPtr+=4;let g=3*f;const m=this._baseZ+this._currentZ;p[g++]=t,p[g++]=e,p[g++]=m+s,p[g++]=i,p[g++]=r,p[g++]=m+n,p[g++]=a,p[g++]=o,p[g++]=m+h,p[g++]=l,p[g++]=c,p[g]=m+u,_.writeToTypedArray(this._texcoordData,2*f),262144&this._flags&&this._WriteQuadTexIndices(f),this._colorData.set(d,4*f)}DrawMesh(t,e,s,i){if(t.length%3!=0)throw new Error("vertex buffer length not multiple of 3");if(t.length>196605)throw new Error(`too many vertices (${t.length/3}, limit 65535)`);if(s.length%3!=0)throw new Error("index buffer length not multiple of 3");if(s.length>393210)throw new Error(`too many indices (${s.length}, limit 393210)`);this._AddToDrawBatch(t.length,s.length);const r=this._vertexPtr;this._vertexData.set(t,3*r),this._texcoordData.set(e,2*r),262144&this._flags&&this._texIndexData.fill(this._currentMultiTextureIndex,r,r+t.length);const n=this._indexData;if(0===r)n.set(s,this._indexPtr);else{let t=this._indexPtr;for(let e=0,i=s.length;e<i;++e)n[t++]=s[e]+r}const a=this._colorData;if(null!=i)a.set(i,4*r);else{const e=this._currentColor,s=e.getR(),i=e.getG(),n=e.getB(),o=e.getA();let h=4*r;for(let e=0,r=t.length;e<r;++e)a[h++]=s,a[h++]=i,a[h++]=n,a[h++]=o}this._vertexPtr+=t.length/3,this._indexPtr+=s.length}StartRenderingPoints(t){this._currentPointTexCoords.equals(t)||(this._currentPointTexCoords.copy(t),this._UpdatePointTexCoordsUniform());const e=this._baseZ+this._currentZ;this._currentVertexZElevation!==e&&(this._currentVertexZElevation=e,this._UpdateZElevationUniform()),this._currentPointColor.equals(this._currentColor)||(this._currentPointColor.copy(this._currentColor),this._UpdatePointColorUniform()),this.SetProgram(this.GetPointsRenderingProgram()),this._drawIndexCount=0,this._flags|=18}FinishRenderingPoints(){this._drawIndexCount>0&&this._MaybeEndDrawBatch(),this._flags&=-3,this._flags|=16}Point(t,e,s,i){let r=this._pointPtr;r>Ju&&(this.EndBatch(),r=0),1&this._flags?this._drawIndexCount+=6:(null===this._currentRenderPass&&this._BeginRenderPass(),this._flags|=1,this._drawFirstIndex=r/4*6,this._drawIndexCount=6);const n=this._pointData;n[r++]=t,n[r++]=e,n[r++]=s,n[r++]=i,this._pointPtr=r}SetGradientColor(t){this._currentColor2.equals(t)||(this._currentColor2.copy(t),this._UpdateColor2Uniform())}SetEllipseParams(t,e,s=1){const i=this._fragUniformBufferLayout,r=this._fragUniformf32;Ku.set(t,e),Ku.equalsF32Array(r,i.pixelSize.offset/4)||this._UpdateFragmentUniformVec2(Ku,i.pixelSize),r[i.outlineThickness.offset/4]!==Math.fround(s)&&(r[i.outlineThickness.offset/4]=s,this._MarkFragUniformBufferRangeChanged(i.outlineThickness))}SetTilemapInfo(t,e,s,i,r,n,a){const o=this._fragUniformBufferLayout,h=this._fragUniformf32;t.equalsF32Array(h,o.srcRect.offset/4)||(t.writeToTypedArray(h,o.srcRect.offset/4),this._MarkFragUniformBufferRangeChanged(o.srcRect)),Ku.set(i/e,r/s),Ku.equalsF32Array(h,o.tileSize.offset/4)||this._UpdateFragmentUniformVec2(Ku,o.tileSize),Ku.set(n/e,a/s),Ku.equalsF32Array(h,o.tileSpacing.offset/4)||this._UpdateFragmentUniformVec2(Ku,o.tileSpacing)}SetTileRandomizationInfo(t,e,s,i,r,n,a){const o=this._fragUniformBufferLayout,h=this._fragUniformf32;Ku.set(s,i),Ku.equalsF32Array(h,o.tileSize.offset/4)||this._UpdateFragmentUniformVec2(Ku,o.tileSize),h[o.outlineThickness.offset/4]!==Math.fround(r)&&(h[o.outlineThickness.offset/4]=r,this._MarkFragUniformBufferRangeChanged(o.outlineThickness)),Ku.set(n,a),Ku.equalsF32Array(h,o.tileSpacing.offset/4)||this._UpdateFragmentUniformVec2(Ku,o.tileSpacing)}SetProgramParameters(t,e,s,i,r,n,a,o,h,l,c){const u=this._fragC3ParamsLayout,_=this._currentProgram;c%=10800,_.BlendsBackground()&&this.SetBackTexture(t),_.UsesAnyC3ParamRect()&&(this._MaybeUpdateFragmentC3ParamsRect(e,u.destRect),this._MaybeUpdateFragmentC3ParamsRect(s,u.srcRect),this._MaybeUpdateFragmentC3ParamsRect(i,u.srcOriginRect),this._MaybeUpdateFragmentC3ParamsRect(r,u.layoutRect)),this._MaybeUpdateFragmentC3ParamsFloat(o,u.devicePixelRatio),this._MaybeUpdateFragmentC3ParamsFloat(h,u.layerScale),this._MaybeUpdateFragmentC3ParamsFloat(l,u.layerAngle),this._MaybeUpdateFragmentC3ParamsFloat(c,u.seconds),this._MaybeUpdateFragmentC3ParamsFloat(this.GetNearZ(),u.zNear),this._MaybeUpdateFragmentC3ParamsFloat(this.GetFarZ(),u.zFar)}SetProgramCustomParameters(t){t&&(t.IsChanged()&&(this._MaybeEndRenderPass(),t.UpdateBuffer(this._commandEncoder)),this._SetBufferBindGroup(t.GetBufferBindGroup()))}SetProgramParameter_IsSrcTexRotated(t){this._MaybeUpdateFragmentC3ParamsUint(t?1:0,this._fragC3ParamsLayout.isSrcTexRotated)}_SetBufferBindGroup(t){t!==this._currentBufferBindGroup&&(this._MaybeEndDrawBatch(),this._currentBufferBindGroup=t,this._flags|=8192)}_OnBufferBindGroupDestroyed(t){this._currentBufferBindGroup===t&&this._SetBufferBindGroup(this._defaultBufferBindGroup)}CopyRenderTarget(t){if(t._IsAwaitingClear())return this._currentRenderTarget._SetIsAwaitingClear(!0),void this._currentRenderTarget._GetClearColor().set(t._GetClearColor());t.GetMultisampling()>=2&&this._currentRenderTarget.GetMultisampling()<2?this._ResolveMultisampledRenderTarget(t):(this.ClearRgba(0,0,0,0),this.SetCopyBlend(),this.ResetColor(),this.DrawRenderTarget(t))}DrawRenderTarget(t){this._MaybeDoPendingClearRenderPass(t);const e=t.GetTexture();this.SetTexture(e),this.FullscreenQuad()}FullscreenQuad(){const t=this.IsNormalizedCoordsProgramVariant();t||this.SetNormalizedCoordsProgramVariant(!0),this.SetCurrentZ(0);const e=$u,s=Zu;e.set(0,-1,0,-1,2,1,0,1),s.set(0,-1,2,1),this.Quad3(e,s),t||this.SetNormalizedCoordsProgramVariant(!1)}_ResolveMultisampledRenderTarget(t){this._MaybeDoPendingClearRenderPass(t),this._MaybeEndRenderPass(),this._commandEncoder.beginRenderPass({colorAttachments:[{view:t.GetTexture()._GetTextureView(),resolveTarget:this._currentRenderTarget.GetTexture()._GetTextureView(),loadOp:"load",storeOp:"store"}]}).end(),this._flags|=16384}CoplanarStartStencilPass(){this._MaybeEndRenderPass(),this.SetDepthEnabled(!0),this._flags|=41943040}CoplanarStartColorPass(t=!1){this._MaybeEndRenderPass(),this.SetDepthEnabled(t),this._flags&=-8388609,this._flags|=16777216}IsCoplanarColorPass(){return this._IsFlagSet(16777216)}CoplanarRestoreStandardRendering(t=!0){this._MaybeEndRenderPass(),this.SetDepthEnabled(t),this._flags&=-16777217}_InitBlendModes(){this._InitBlendModeData([["normal",["one","one-minus-src-alpha"]],["additive",["one","one"]],["xor",["one","one-minus-src-alpha"]],["copy",["one","zero"]],["destination-over",["one-minus-dst-alpha","one"]],["source-in",["dst-alpha","zero"]],["destination-in",["zero","src-alpha"]],["source-out",["one-minus-dst-alpha","zero"]],["destination-out",["zero","one-minus-src-alpha"]],["source-atop",["dst-alpha","one-minus-src-alpha"]],["destination-atop",["one-minus-dst-alpha","src-alpha"]],["lighten",["one","one","one","one","max","max"]],["darken",["one","one","one","one","min","min"]],["multiply",["dst","one-minus-src-alpha","one","one-minus-src-alpha"]],["screen",["one","one-minus-src","one","one-minus-src-alpha"]]])}GetAvailableAdapterFeatures(){return this._adapter?[...this._adapter.features]:[]}GetAdapterInfo(){return this._adapterInfo}GetAdapterInfoString(){const t=this._adapterInfo;if(!t)return"unknown/unknown";const e=t.vendor||"unknown",s=t.architecture||"unknown",i=[];return t.device&&i.push(t.device),t.description&&i.push(t.description),t.type&&i.push(t.type),t.backend&&i.push(t.backend),e+"/"+s+(i.length>0?` (${i.join(", ")})`:"")}}}{const t_=self.C3;t_.Gfx.WebGPUBufferManager=class{constructor(t){this._renderer=t,this._buffers=new Map,this._recycleAfterSubmit=[],this._releaseAfterSubmit=[],this._destroyAfterSubmit=[],this._totalBufferCount=0,this._totalBufferSize=0,this._totalCreated=0,this._totalReleased=0,this._totalReturned=0,this._totalRecycled=0}GetRenderer(){return this._renderer}OnContextLost(){this._buffers.clear(),t_.clearArray(this._recycleAfterSubmit),t_.clearArray(this._releaseAfterSubmit),t_.clearArray(this._destroyAfterSubmit)}_RoundBufferSizeClass(t){return Math.max(t_.nextHighestPowerOfTwo(t),16)}GetRecyclableBuffer(t){this._totalReturned++;const e=this._RoundBufferSizeClass(t);{const t=this._buffers.get(e);if(void 0!==t&&t.length>0){const s=t.pop();return s.MarkInUse(),0===t.length&&this._buffers.delete(e),s}}return this._totalBufferCount++,this._totalBufferSize+=e,this._totalCreated++,t_.New(t_.Gfx.WebGPURecyclableBuffer,this,e)}_AddRecycledBuffer(t){this._totalRecycled++;const e=t.GetSize(),s=this._buffers.get(e);void 0===s?this._buffers.set(e,[t]):s.push(t)}_DestroyAfterSubmit(t){this._destroyAfterSubmit.push(t)}AfterSubmit(){for(const t of this._recycleAfterSubmit)t.Recycle();t_.clearArray(this._recycleAfterSubmit);for(const t of this._releaseAfterSubmit)this._totalBufferCount--,this._totalBufferSize-=t.GetSize(),t.Release();t_.clearArray(this._releaseAfterSubmit);for(const t of this._destroyAfterSubmit)t.destroy();t_.clearArray(this._destroyAfterSubmit)}MaybeCollectUnusedBuffers(t){t%30==0&&this._CollectUnusedBuffers(t)}_CollectUnusedBuffers(t){for(const[e,s]of this._buffers.entries()){let i=0;for(let e=0,r=s.length;e<r;++e){const r=s[e];r._ShouldCollect(t)?(this._totalBufferCount--,this._totalBufferSize-=r.GetSize(),r.Release(),this._totalReleased++):(s[i]=r,++i)}0===i?this._buffers.delete(e):t_.truncateArray(s,i)}this._DebugLogBufferMap()}UpdateBufferSubData(t,e,s,i,r){const n=this.GetRecyclableBuffer(r),a=n.GetBuffer(),o=a.getMappedRange(0,r);new Uint8Array(o).set(new Uint8Array(s,i,r)),a.unmap(),t.copyBufferToBuffer(a,0,e,i,r),this._recycleAfterSubmit.push(n)}_DebugLogBufferMap(){this._totalCreated=0,this._totalReleased=0,this._totalReturned=0,this._totalRecycled=0}}}{const e_=self.C3,s_=self.GPUBufferUsage,i_=self.GPUMapMode;self.assert;e_.Gfx.WebGPURecyclableBuffer=class{constructor(t,e){this._bufferManager=t,this._state=1,this._size=e,this._buffer=this.GetRenderer()._GetDevice().createBuffer({mappedAtCreation:!0,size:e,usage:s_.COPY_SRC|s_.MAP_WRITE}),this._recycledFrameNumber=0}GetRenderer(){return this._bufferManager.GetRenderer()}GetState(){return this._state}GetSize(){return this._size}GetBuffer(){return this._buffer}MarkInUse(){this._state=1}async Recycle(){this._state=2;try{await this._buffer.mapAsync(i_.WRITE)}catch(t){return void console.warn("[WebGPU] Error recycling buffer, assuming device was lost: ",t)}this.GetRenderer().IsContextLost()||(this._state=0,this._recycledFrameNumber=this.GetRenderer().GetFrameNumber(),this._bufferManager._AddRecycledBuffer(this))}Discard(){this._state=0}_ShouldCollect(t){return this._recycledFrameNumber<=t-25}Release(){this._buffer.destroy(),this._buffer=null,this._bufferManager=null}}}{const r_=self.C3,n_=(self.assert,self.GPUBufferUsage);r_.Gfx.WebGPUEffectCustomParamsBuffer=class{constructor(t){const e=t.GetRenderer();this._shaderProgram=t,this._byteSize=t.GetCustomParametersByteSize(),this._arrayBuffer=new ArrayBuffer(this._byteSize),this._f32arr=new Float32Array(this._arrayBuffer),this._isChanged=!1,this._buffer=e._GetDevice().createBuffer({size:this._byteSize,usage:n_.UNIFORM|n_.COPY_DST}),this._bufferBindGroup=e._CreateBufferBindGroup(this._buffer)}Release(){this.GetRenderer()._OnBufferBindGroupDestroyed(this._bufferBindGroup),this.GetRenderer().GetBufferManager()._DestroyAfterSubmit(this._buffer),this._buffer=null,this._shaderProgram=null,this._arrayBuffer=null,this._f32arr=null,this._bufferBindGroup=null}GetRenderer(){return this._shaderProgram.GetRenderer()}GetShaderProgram(){return this._shaderProgram}GetBufferBindGroup(){return this._bufferBindGroup}SetParameterValue(t,e){const s=this._shaderProgram._GetCustomParameterInfo(t),i=s.type,r=s.offset/4,n=this._f32arr;if("color"===i){if(e.equalsRGBF32Array(n,r))return;e.writeRGBToTypedArray(n,r),this._isChanged=!0}else{if("float"!==i&&"percent"!==i)throw new Error(`unexpected shader param type '${i}'`);if(n[r]===Math.fround(e))return;n[r]=e,this._isChanged=!0}}IsChanged(){return this._isChanged}UpdateBuffer(t){this.GetRenderer().GetBufferManager().UpdateBufferSubData(t,this._buffer,this._arrayBuffer,0,this._byteSize),this._isChanged=!1}}}{let a_=function(t){for(const e of Object.values(t))e.end=e.offset+e.size},o_=function(t){const e=[];for(let s=0;s<t;++s)e.push(null);return e},h_=function(t){return`\nstruct FragmentInput {\n\t@location(1) fragUV : vec2<f32>,\n\t@location(2) fragColor : vec4<${t?"f16":"f32"}>,\n\t@builtin(position) fragPos : vec4<f32>\n};\n\nfn c3_getBackUV(fragPos : vec2<f32>, texBack : texture_2d<f32>) -> vec2<f32>\n{\n\treturn fragPos / vec2<f32>(textureDimensions(texBack));\n}\n\nfn c3_getDepthUV(fragPos : vec2<f32>, texDepth : texture_depth_2d) -> vec2<f32>\n{\n\treturn fragPos / vec2<f32>(textureDimensions(texDepth));\n}\n`},l_=function(t,e,s,i,r){return t<<10|e<<7|s<<5|i<<4|r};0;const c_=self.C3,u_="\nstruct Uniforms {\n\ttransform\t\t: mat4x4<f32>,\n\tpointTexStart\t: vec2<f32>,\n\tpointTexEnd\t\t: vec2<f32>,\n\tzElevation\t\t: f32\n};\n@binding(0) @group(0) var<uniform> uniforms : Uniforms;\n",__={transform:{offset:0,size:64,end:0},pointTex:{offset:64,size:16,end:0},pointTexStart:{offset:64,size:8,end:0},pointTexEnd:{offset:72,size:8,end:0},zElevation:{offset:80,size:4,end:0}};a_(__);const d_=__.zElevation.end,p_="\nstruct Uniforms {\n\tcolor2\t\t\t\t: vec4<f32>,\n\tpointColor \t\t\t: vec4<f32>,\n\ttileSize\t\t\t: vec2<f32>,\n\ttileSpacing\t\t\t: vec2<f32>,\n\tsrcRectStart\t\t: vec2<f32>,\n\tsrcRectEnd\t\t\t: vec2<f32>,\n\tpixelSize\t\t\t: vec2<f32>,\n\toutlineThickness\t: f32\n};\n@binding(1) @group(0) var<uniform> uniforms : Uniforms;\n",f_={color2:{offset:0,size:16,end:0},pointColor:{offset:16,size:16,end:0},tileSize:{offset:32,size:8,end:0},tileSpacing:{offset:40,size:8,end:0},srcRect:{offset:48,size:16,end:0},srcRectStart:{offset:48,size:8,end:0},srcRectEnd:{offset:56,size:8,end:0},pixelSize:{offset:64,size:8,end:0},outlineThickness:{offset:72,size:4,end:0}};a_(f_);const g_=f_.outlineThickness.end,m_="\nstruct C3Params {\n\tsrcStart\t\t\t: vec2<f32>,\n\tsrcEnd\t\t\t\t: vec2<f32>,\n\tsrcOriginStart\t\t: vec2<f32>,\n\tsrcOriginEnd\t\t: vec2<f32>,\n\tlayoutStart\t\t\t: vec2<f32>,\n\tlayoutEnd\t\t\t: vec2<f32>,\n\tdestStart\t\t\t: vec2<f32>,\n\tdestEnd\t\t\t\t: vec2<f32>,\n\tdevicePixelRatio\t: f32,\n\tlayerScale\t\t\t: f32,\n\tlayerAngle\t\t\t: f32,\n\tseconds\t\t\t\t: f32,\n\tzNear\t\t\t\t: f32,\n\tzFar\t\t\t\t: f32,\n\tisSrcTexRotated\t\t: u32\n};\n@binding(4) @group(0) var<uniform> c3Params : C3Params;\n\nfn c3_srcToNorm(p : vec2<f32>) -> vec2<f32>\n{\n\treturn (p - c3Params.srcStart) / (c3Params.srcEnd - c3Params.srcStart);\n}\n\nfn c3_normToSrc(p : vec2<f32>) -> vec2<f32>\n{\n\treturn fma(p, c3Params.srcEnd - c3Params.srcStart, c3Params.srcStart);\n}\n\nfn c3_clampToSrc(p : vec2<f32>) -> vec2<f32>\n{\n\treturn clamp(p, min(c3Params.srcStart, c3Params.srcEnd), max(c3Params.srcStart, c3Params.srcEnd));\n}\n\nfn c3_srcOriginToNorm(p : vec2<f32>) -> vec2<f32>\n{\n\treturn (p - c3Params.srcOriginStart) / (c3Params.srcOriginEnd - c3Params.srcOriginStart);\n}\n\nfn c3_normToSrcOrigin(p : vec2<f32>) -> vec2<f32>\n{\n\treturn fma(p, c3Params.srcOriginEnd - c3Params.srcOriginStart, c3Params.srcOriginStart);\n}\n\nfn c3_clampToSrcOrigin(p : vec2<f32>) -> vec2<f32>\n{\n\treturn clamp(p, min(c3Params.srcOriginStart, c3Params.srcOriginEnd), max(c3Params.srcOriginStart, c3Params.srcOriginEnd));\n}\n\nfn c3_getLayoutPos(p : vec2<f32>) -> vec2<f32>\n{\n\treturn fma(p - c3Params.srcOriginStart, (c3Params.layoutEnd - c3Params.layoutStart) / (c3Params.srcOriginEnd - c3Params.srcOriginStart), c3Params.layoutStart);\n}\n\nfn c3_srcToDest(p : vec2<f32>) -> vec2<f32>\n{\n\treturn fma(p - c3Params.srcStart, (c3Params.destEnd - c3Params.destStart) / (c3Params.srcEnd - c3Params.srcStart), c3Params.destStart);\n}\n\nfn c3_clampToDest(p : vec2<f32>) -> vec2<f32>\n{\n\treturn clamp(p, min(c3Params.destStart, c3Params.destEnd), max(c3Params.destStart, c3Params.destEnd));\n}\n\nfn c3_linearizeDepth(depthSample : f32) -> f32\n{\n\treturn c3Params.zNear * c3Params.zFar / (c3Params.zFar + depthSample * (c3Params.zNear - c3Params.zFar));\n}\n",S_=["srcStart","srcEnd","srcOriginStart","srcOriginEnd","c3_srcToNorm","c3_normToSrc","c3_clampToSrc","c3_srcOriginToNorm","c3_normToSrcOrigin","c3_clampToSrcOrigin","c3_getLayoutPos","c3_srcToDest"],y_=["layoutStart","layoutEnd","destStart","destEnd","c3_clampToDest"],G_={srcRect:{offset:0,size:16,end:0},srcStart:{offset:0,size:8,end:0},srcEnd:{offset:8,size:8,end:0},srcOriginRect:{offset:16,size:16,end:0},srcOriginStart:{offset:16,size:8,end:0},srcOriginEnd:{offset:24,size:8,end:0},layoutRect:{offset:32,size:16,end:0},layoutStart:{offset:32,size:8,end:0},layoutEnd:{offset:40,size:8,end:0},destRect:{offset:48,size:16,end:0},destStart:{offset:48,size:8,end:0},destEnd:{offset:56,size:8,end:0},devicePixelRatio:{offset:64,size:4,end:0},layerScale:{offset:68,size:4,end:0},layerAngle:{offset:72,size:4,end:0},seconds:{offset:76,size:4,end:0},zNear:{offset:80,size:4,end:0},zFar:{offset:84,size:4,end:0},isSrcTexRotated:{offset:88,size:4,end:0}};a_(G_);const T_=G_.isSrcTexRotated.end,I_="\nstruct FragmentOutput {\n\t@location(0) color : vec4<f32>\n};\n",C_=new Map([["float",4],["percent",4],["color",12]]),b_=new Map([["float",4],["percent",4],["color",16]]),x_="\nfn c3_premultiply(c : vec4<f32>) -> vec4<f32>\n{\n\treturn vec4<f32>(c.rgb * c.a, c.a);\n}\n\nfn c3_unpremultiply(c : vec4<f32>) -> vec4<f32>\n{\n\tif (c.a == 0.0)\n\t{\n\t\treturn vec4<f32>(0.0);\n\t}\n\t\n\treturn vec4<f32>(c.rgb / c.a, c.a);\n}\n\nfn c3_grayscale(rgb : vec3<f32>) -> f32\n{\n\treturn dot(rgb, vec3<f32>(0.299, 0.587, 0.114));\n}\n\nfn c3_getPixelSize(t : texture_2d<f32>) -> vec2<f32>\n{\n\treturn vec2<f32>(1.0) / vec2<f32>(textureDimensions(t));\n}\n\nfn c3_clamp2(v : vec2<f32>, l : f32, u : f32) -> vec2<f32>\n{\n\treturn clamp(v, vec2<f32>(l), vec2<f32>(u));\n}\n\nfn c3_mod(x : f32, y : f32) -> f32\n{\n\treturn x - y * floor(x / y);\n}\n\nfn c3_mod2(x : vec2<f32>, y : vec2<f32>) -> vec2<f32>\n{\n\treturn x - y * floor(x / y);\n}\n\nfn c3_RGBtoHSL(color : vec3<f32>) -> vec3<f32>\n{\n\tvar hsl : vec3<f32> = vec3<f32>(0.0);\n\t\n\tvar fmin : f32 = min(min(color.r, color.g), color.b);\n\tvar fmax : f32 = max(max(color.r, color.g), color.b);\n\tvar delta : f32 = fmax - fmin;\n\n\thsl.z = (fmax + fmin) / 2.0;\n\n\tif (delta == 0.0)\n\t{\n\t\thsl.x = 0.0;\n\t\thsl.y = 0.0;\n\t}\n\telse \n\t{\n\t\tif (hsl.z < 0.5)\n\t\t{\n\t\t\thsl.y = delta / (fmax + fmin);\n\t\t}\n\t\telse\n\t\t{\n\t\t\thsl.y = delta / (2.0 - fmax - fmin);\n\t\t}\n\t\t\n\t\tvar dR : f32 = (((fmax - color.r) / 6.0) + (delta / 2.0)) / delta;\n\t\tvar dG : f32 = (((fmax - color.g) / 6.0) + (delta / 2.0)) / delta;\n\t\tvar dB : f32 = (((fmax - color.b) / 6.0) + (delta / 2.0)) / delta;\n\n\t\tif (color.r == fmax)\n\t\t{\n\t\t\thsl.x = dB - dG;\n\t\t}\n\t\telse if (color.g == fmax)\n\t\t{\n\t\t\thsl.x = (1.0 / 3.0) + dR - dB;\n\t\t}\n\t\telse if (color.b == fmax)\n\t\t{\n\t\t\thsl.x = (2.0 / 3.0) + dG - dR;\n\t\t}\n\n\t\tif (hsl.x < 0.0)\n\t\t{\n\t\t\thsl.x = hsl.x + 1.0;\n\t\t}\n\t\telse if (hsl.x > 1.0)\n\t\t{\n\t\t\thsl.x = hsl.x - 1.0;\n\t\t}\n\t}\n\n\treturn hsl;\n}\n\nfn c3_hueToRGB(f1 : f32, f2 : f32, hue_ : f32) -> f32\n{\n\tvar hue : f32 = hue_;\n\tif (hue < 0.0)\n\t{\n\t\thue = hue + 1.0;\n\t}\n\telse if (hue > 1.0)\n\t{\n\t\thue = hue - 1.0;\n\t}\n\t\t\n\tvar ret : f32;\n\t\n\tif ((6.0 * hue) < 1.0)\n\t{\n\t\tret = f1 + (f2 - f1) * 6.0 * hue;\n\t}\n\telse if ((2.0 * hue) < 1.0)\n\t{\n\t\tret = f2;\n\t}\n\telse if ((3.0 * hue) < 2.0)\n\t{\n\t\tret = f1 + (f2 - f1) * ((2.0 / 3.0) - hue) * 6.0;\n\t}\n\telse\n\t{\n\t\tret = f1;\n\t}\n\t\n\treturn ret;\n}\n\nfn c3_HSLtoRGB(hsl : vec3<f32>) -> vec3<f32>\n{\n\tvar rgb : vec3<f32> = vec3<f32>(hsl.z);\n\t\n\tif (hsl.y != 0.0)\n\t{\n\t\tvar f2 : f32;\n\t\t\n\t\tif (hsl.z < 0.5)\n\t\t{\n\t\t\tf2 = hsl.z * (1.0 + hsl.y);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tf2 = (hsl.z + hsl.y) - (hsl.y * hsl.z);\n\t\t}\n\t\t\t\n\t\tvar f1 : f32 = 2.0 * hsl.z - f2;\n\t\t\n\t\trgb.r = c3_hueToRGB(f1, f2, hsl.x + (1.0 / 3.0));\n\t\trgb.g = c3_hueToRGB(f1, f2, hsl.x);\n\t\trgb.b = c3_hueToRGB(f1, f2, hsl.x - (1.0 / 3.0));\n\t}\n\t\n\treturn rgb;\n}\n";c_.Gfx.WebGPUShaderProgram=class extends c_.Gfx.ShaderProgramBase{constructor(t,e){if(super(t,e),this._fragmentModule=e.fragmentModule,this._fragmentModuleFragDepth=e.fragmentModuleFragDepth,this._vertexModule=e.vertexModule,this._normVertexModule=e.normVertexModule,this._renderPipelineMap=new Map,this._mipmapPipelineMap=new Map,this._usesAnyC3ParamRect=!1,this._usesIsSrcTexRotated=!1,this._parameters=[],this._customParamsByteSize=0,e.parameters){let t=0;for(const s of e.parameters){const e=s[2];if(!C_.has(e))throw new Error(`unrecognized effect param type '${e}'`);const i=C_.get(e),r=b_.get(e),n=t%r;0!==n&&(t+=r-n),this._parameters.push({type:e,offset:t,size:i,end:t+i}),t+=i}this._customParamsByteSize=16*Math.ceil(t/16)}}static async Create(t,e){const s=t._GetDevice(),i=e.name,r=t.SupportsF16(),n=t.IsColorDataF16(),a=e.src,o=c_.Gfx.WebGPUShaderProgram._PreprocessFragmentShaderCode(a,r,n),h=s.createShaderModule({label:i,code:o});let l,c=null;if(e.srcFragDepth){const t=c_.Gfx.WebGPUShaderProgram._PreprocessFragmentShaderCode(e.srcFragDepth,r,n);c=s.createShaderModule({label:i,code:t})}h.getCompilationInfo().then(t=>c_.Gfx.WebGPUShaderProgram.ReportShaderCompilationInfo(i,"fragment",t));const u=c_.Gfx.WebGPUShaderProgram._PreprocessVertexShaderCode(e.vertexSrc,r);let _;u?(l=s.createShaderModule({label:i,code:u}),l.getCompilationInfo().then(t=>c_.Gfx.WebGPUShaderProgram.ReportShaderCompilationInfo(i,"vertex",t))):l=t._GetDefaultVertexModule();const d=c_.Gfx.WebGPUShaderProgram._PreprocessVertexShaderCode(e.normVertexSrc,r);d?(_=s.createShaderModule({label:i,code:d}),_.getCompilationInfo().then(t=>c_.Gfx.WebGPUShaderProgram.ReportShaderCompilationInfo(i,"vertex (norm)",t))):_=t._GetNormalizedVertexModule();const p=c_.New(c_.Gfx.WebGPUShaderProgram,t,Object.assign({fragmentModule:h,fragmentModuleFragDepth:c,vertexModule:l,normVertexModule:_},e));if(p._usesAnySrcRectOrPixelSize=a.includes("%%C3PARAMS_STRUCT%%")&&S_.some(t=>a.includes(t)),p._usesAnyC3ParamRect=p._usesAnySrcRectOrPixelSize||a.includes("%%C3PARAMS_STRUCT%%")&&y_.some(t=>a.includes(t)),p._usesIsSrcTexRotated=a.includes("%%C3PARAMS_STRUCT%%")&&a.includes("isSrcTexRotated"),"<generate-mipmap>"!==i){const e=p._CreateRenderPipelineAsync(0,0,0,0,0);let s=null;t.UsesDepthBuffer()&&(s=p._CreateRenderPipelineAsync(0,1,0,0,0));const[i,r]=await Promise.all([e,s]);p._renderPipelineMap.set(l_(0,0,0,0,0),i),r&&p._renderPipelineMap.set(l_(0,1,0,0,0),r)}return p}static _PreprocessShaderCode(t,e){if(!t)return t;let s="";return s=e?"enable f16;\nalias f16or32 = f16;\n":"alias f16or32 = f32;\n",s+t}static _PreprocessFragmentShaderCode(t,e,s){return t=c_.Gfx.WebGPUShaderProgram._PreprocessShaderCode(t,e),c_.StringSubstituteMap(t,{"%%SAMPLERFRONT_BINDING%%":"@binding(0) @group(1)","%%TEXTUREFRONT_BINDING%%":"@binding(1) @group(1)","%%SAMPLERBACK_BINDING%%":"@binding(0) @group(2)","%%TEXTUREBACK_BINDING%%":"@binding(1) @group(2)","%%SAMPLERDEPTH_BINDING%%":"@binding(0) @group(3)","%%TEXTUREDEPTH_BINDING%%":"@binding(1) @group(3)","%%SHADERPARAMS_BINDING%%":"@binding(5) @group(0)","%%FRAGMENTINPUT_STRUCT%%":h_(s),"%%FRAGMENTOUTPUT_STRUCT%%":I_,"%%C3PARAMS_STRUCT%%":m_,"%%C3_UTILITY_FUNCTIONS%%":x_})}static _PreprocessVertexShaderCode(t,e){return c_.Gfx.WebGPUShaderProgram._PreprocessShaderCode(t,e)}static ReportShaderCompilationInfo(t,e,s){for(const i of s.messages){const s=`[WebGPU] Message (${i.type}) compiling ${e} shader '${t}': ${i.message} (line ${i.lineNum}, pos ${i.linePos})`;"error"===i.type?console.error(s):"warning"===i.type?console.warn(s):console.log(s)}}Release(){this._fragmentModule=null,this._fragmentModuleFragDepth=null,this._vertexModule=null,this._normVertexModule=null,this._renderPipelineMap.clear(),this._mipmapPipelineMap.clear(),super.Release()}_GetDevice(){return this._renderer._GetDevice()}_GetPipelineLayout(){return this._renderer._GetPipelineLayout()}GetRenderer(){return this._renderer}UsesAnyC3ParamRect(){return this._usesAnyC3ParamRect}UsesIsSrcTexRotated(){return this._usesIsSrcTexRotated}GetParameterCount(){return this._parameters.length}GetParameterType(t){return t<0||t>=this._parameters.length?null:this._parameters[t].type}GetCustomParametersByteSize(){return this._customParamsByteSize}_GetCustomParameterInfo(t){return this._parameters[t]}_GetRenderPipelineDescriptor(t,e,s,i,r){const n=this._renderer,a=n.IsColorDataF16(),o=n._GetBlendParametersByIndex(t);let h=o[0],l=o[1],c=h,u=l,_="add",d="add";o.length>=4&&(c=o[2],u=o[3]),6===o.length&&(_=o[4],d=o[5]);let p="none";switch(s){case 1:p="back";break;case 2:p="front"}const f={label:`${this.GetName()} blendMode ${t} variant ${e} multisampleCount ${r}`,layout:this._GetPipelineLayout(),primitive:{cullMode:p,frontFace:0===i?"cw":"ccw"},vertex:{module:4===e?this._normVertexModule:this._vertexModule,entryPoint:"main",buffers:[{arrayStride:12,attributes:[{shaderLocation:0,offset:0,format:"float32x3"}]},{arrayStride:8,attributes:[{shaderLocation:1,offset:0,format:"float32x2"}]},{arrayStride:4*(a?2:4),attributes:[{shaderLocation:2,offset:0,format:a?"float16x4":"float32x4"}]},{arrayStride:4,attributes:[{shaderLocation:3,offset:0,format:"uint32"}]}]},fragment:{module:this._fragmentModule,entryPoint:"main",targets:[{format:n.GetSwapChainFormat(),blend:{color:{srcFactor:h,dstFactor:l,operation:_},alpha:{srcFactor:c,dstFactor:u,operation:d}}}]}};if(r>=2&&(f.multisample={count:r}),1===e)f.fragment.module=this._fragmentModuleFragDepth||this._fragmentModule,f.depthStencil={format:n._GetDepthBufferFormat(),depthWriteEnabled:!0,depthCompare:"less-equal"};else if(2===e){f.fragment.module=this._fragmentModuleFragDepth||this._fragmentModule,f.fragment.targets=[];const t={compare:"always",failOp:"keep",depthFailOp:"keep",passOp:"replace"};f.depthStencil={format:n._GetDepthBufferFormat(),depthWriteEnabled:!0,depthCompare:"less-equal",stencilFront:t,stencilBack:t,stencilReadMask:1,stencilWriteMask:1}}else if(3===e){f.fragment.module=this._fragmentModuleFragDepth||this._fragmentModule;const t={compare:"equal",failOp:"keep",depthFailOp:"keep",passOp:"keep"};f.depthStencil={format:n._GetDepthBufferFormat(),depthWriteEnabled:!1,depthCompare:"always",stencilFront:t,stencilBack:t,stencilReadMask:1,stencilWriteMask:0}}return f}_CreateRenderPipeline(t,e,s,i,r){return this._GetDevice().createRenderPipeline(this._GetRenderPipelineDescriptor(t,e,s,i,r))}_CreateRenderPipelineAsync(t,e,s,i,r){return this._GetDevice().createRenderPipelineAsync(this._GetRenderPipelineDescriptor(t,e,s,i,r))}GetRenderPipelineForState(t,e,s,i,r){const n=l_(t,e,s,i,r);let a=this._renderPipelineMap.get(n);return a||(a=this._CreateRenderPipeline(t,e,s,i,r),this._renderPipelineMap.set(n,a),a)}static GetVertexUniformBufferLayout(){return __}static GetVertexUniformBufferSize(){return 16*Math.ceil(d_/16)}static GetFragmentUniformBufferLayout(){return f_}static GetFragmentUniformBufferSize(){return 16*Math.ceil(g_/16)}static GetFragmentC3ParamsBufferLayout(){return G_}static GetFragmentC3ParamsBufferSize(){return 16*Math.ceil(T_/16)}static GetDefaultVertexShaderSource(t){const e=t?"f16":"f32";return`\n\t\t${u_}\n\n\t\tstruct VertexInput {\n\t\t\t@location(0) position : vec3<f32>,\n\t\t\t@location(1) uv : vec2<f32>,\n\t\t\t@location(2) color : vec4<${e}>,\n\t\t\t@location(3) texIndex : u32\n\t\t};\n\n\t\tstruct VertexOutput {\n\t\t\t@builtin(position) Position : vec4<f32>,\n\t\t\t@location(1) fragUV : vec2<f32>,\n\t\t\t@location(2) fragColor : vec4<${e}>,\n\t\t\t@location(3) @interpolate(flat, either) texIndex : u32\n\t\t};\n\n\t\t@vertex\n\t\tfn main(input : VertexInput) -> VertexOutput {\n\t\t\tvar output : VertexOutput;\n\t\t\toutput.Position = uniforms.transform * vec4<f32>(input.position, 1.0);\n\t\t\toutput.fragUV = input.uv;\n\t\t\toutput.fragColor = input.color;\n\t\t\toutput.texIndex = input.texIndex;\n\t\t\treturn output;\n\t\t}`}static GetNormalizedVertexShaderSource(t){const e=t?"f16":"f32";return`\n\t\tstruct VertexInput {\n\t\t\t@location(0) position : vec3<f32>,\n\t\t\t@location(1) uv : vec2<f32>,\n\t\t\t@location(2) color : vec4<${e}>,\n\t\t\t@location(3) texIndex : u32\n\t\t};\n\n\t\tstruct VertexOutput {\n\t\t\t@builtin(position) Position : vec4<f32>,\n\t\t\t@location(1) fragUV : vec2<f32>,\n\t\t\t@location(2) fragColor : vec4<${e}>,\n\t\t\t@location(3) @interpolate(flat, either) texIndex : u32\n\t\t};\n\n\t\t@vertex\n\t\tfn main(input : VertexInput) -> VertexOutput {\n\t\t\tvar output : VertexOutput;\n\t\t\tvar p = input.position;\n\t\t\tp.y = 1.0 - p.y;\n\t\t\toutput.Position = vec4<f32>(p.xy * 2.0 - 1.0, p.z, 1.0);\n\t\t\toutput.fragUV = input.uv;\n\t\t\toutput.texIndex = input.texIndex;\n\t\t\toutput.fragColor = input.color;\n\t\t\treturn output;\n\t\t}`}static GetTextureFillVertexShaderSource(t){const e=t?"f16":"f32";return`\n\t\t${u_}\n\n\t\tstruct VertexInput {\n\t\t\t@location(0) position : vec3<f32>,\n\t\t\t@location(1) uv : vec2<f32>,\n\t\t\t@location(2) color : vec4<${e}>,\n\t\t\t@location(3) texIndex : u32\n\t\t};\n\n\t\tstruct VertexOutput {\n\t\t\t@builtin(position) Position : vec4<f32>,\n\t\t\t@location(1) fragUV : vec2<f32>,\n\t\t\t@location(2) fragColor : vec4<${e}>,\n\t\t\t@location(3) @interpolate(flat, either) texIndex : u32\n\t\t};\n\n\t\t@vertex\n\t\tfn main(input : VertexInput) -> VertexOutput {\n\t\t\tvar output : VertexOutput;\n\t\t\toutput.Position = uniforms.transform * vec4<f32>(input.position, 1.0);\n\t\t\toutput.fragUV = input.uv;\n\t\t\toutput.fragColor = input.color;\n\t\t\toutput.texIndex = input.texIndex;\n\t\t\treturn output;\n\t\t}`}static GetNormalizedTextureFillVertexShaderSource(t){const e=t?"f16":"f32";return`\n\t\tstruct VertexInput {\n\t\t\t@location(0) position : vec3<f32>,\n\t\t\t@location(1) uv : vec2<f32>,\n\t\t\t@location(2) color : vec4<${e}>,\n\t\t\t@location(3) texIndex : u32\n\t\t};\n\n\t\tstruct VertexOutput {\n\t\t\t@builtin(position) Position : vec4<f32>,\n\t\t\t@location(1) fragUV : vec2<f32>,\n\t\t\t@location(2) fragColor : vec4<${e}>,\n\t\t\t@location(3) @interpolate(flat, either) texIndex : u32\n\t\t};\n\n\t\t@vertex\n\t\tfn main(input : VertexInput) -> VertexOutput {\n\t\t\tvar output : VertexOutput;\n\t\t\tvar p = input.position;\n\t\t\tp.y = 1.0 - p.y;\n\t\t\toutput.Position = vec4<f32>(p.xy * 2.0 - 1.0, p.z, 1.0);\n\t\t\toutput.fragUV = input.uv;\n\t\t\toutput.fragColor = input.color;\n\t\t\toutput.texIndex = input.texIndex;\n\t\t\treturn output;\n\t\t}`}static GetMultiTextureFillFragmentShaderSource(t,e){return`\n\t\t@binding(0) @group(1) var sampler0 : sampler;\n\t\t@binding(1) @group(1) var texture0 : texture_2d<f32>;\n\t\t@binding(2) @group(1) var sampler1 : sampler;\n\t\t@binding(3) @group(1) var texture1 : texture_2d<f32>;\n\t\t@binding(4) @group(1) var sampler2 : sampler;\n\t\t@binding(5) @group(1) var texture2 : texture_2d<f32>;\n\t\t@binding(6) @group(1) var sampler3 : sampler;\n\t\t@binding(7) @group(1) var texture3 : texture_2d<f32>;\n\t\t@binding(8) @group(1) var sampler4 : sampler;\n\t\t@binding(9) @group(1) var texture4 : texture_2d<f32>;\n\t\t@binding(10) @group(1) var sampler5 : sampler;\n\t\t@binding(11) @group(1) var texture5 : texture_2d<f32>;\n\t\t@binding(12) @group(1) var sampler6 : sampler;\n\t\t@binding(13) @group(1) var texture6 : texture_2d<f32>;\n\t\t@binding(14) @group(1) var sampler7 : sampler;\n\t\t@binding(15) @group(1) var texture7 : texture_2d<f32>;\n\t\t@binding(16) @group(1) var sampler8 : sampler;\n\t\t@binding(17) @group(1) var texture8 : texture_2d<f32>;\n\t\t@binding(18) @group(1) var sampler9 : sampler;\n\t\t@binding(19) @group(1) var texture9 : texture_2d<f32>;\n\t\t@binding(20) @group(1) var sampler10 : sampler;\n\t\t@binding(21) @group(1) var texture10 : texture_2d<f32>;\n\t\t@binding(22) @group(1) var sampler11 : sampler;\n\t\t@binding(23) @group(1) var texture11 : texture_2d<f32>;\n\t\t@binding(24) @group(1) var sampler12 : sampler;\n\t\t@binding(25) @group(1) var texture12 : texture_2d<f32>;\n\t\t@binding(26) @group(1) var sampler13 : sampler;\n\t\t@binding(27) @group(1) var texture13 : texture_2d<f32>;\n\n\t\tstruct FragmentInput {\n\t\t\t@location(1) fragUV : vec2<f32>,\n\t\t\t@location(2) fragColor : vec4<${e?"f16":"f32"}>,\n\t\t\t@location(3) @interpolate(flat, either) texIndex : u32,\n\t\t\t${t?"@builtin(position) fragPos: vec4<f32>":""}\n\t\t};\n\n\t\tstruct FragmentOutput {\n\t\t\t@location(0) color : vec4<f32>,\n\t\t\t${t?"@builtin(frag_depth) fragDepth: f32":""} \n\t\t};\n\n\t\t@fragment\n\t\tfn main(input : FragmentInput) -> FragmentOutput {\n\t\t\tvar output : FragmentOutput;\n\t\t\tvar texXy : vec2<f32> = input.fragUV.xy;\n\t\t\tvar texIndex : u32 = input.texIndex;\n\t\t\tvar c : vec4<f32>;\n\n\t\t\tlet dx = dpdx(texXy);\n\t\t\tlet dy = dpdy(texXy);\n\t\t\t\n\t\t\tif (texIndex <= 6)\n\t\t\t{\n\t\t\t\tif (texIndex <= 2)\n\t\t\t\t{\n\t\t\t\t\tif (texIndex == 0)\t\t\t{\tc = textureSampleGrad(texture0, sampler0, texXy, dx, dy);\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tif (texIndex == 1)\t\t{\tc = textureSampleGrad(texture1, sampler1, texXy, dx, dy);\t}\n\t\t\t\t\t\telse\t\t\t\t\t{\tc = textureSampleGrad(texture2, sampler2, texXy, dx, dy);\t}\n\t\t\t\t\t}\t\t\t\t\t\t\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tif (texIndex <= 4)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (texIndex == 3)\t\t{\tc = textureSampleGrad(texture3, sampler3, texXy, dx, dy);\t}\n\t\t\t\t\t\telse\t\t\t\t\t{\tc = textureSampleGrad(texture4, sampler4, texXy, dx, dy);\t}\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tif (texIndex <= 5)\t\t{\tc = textureSampleGrad(texture5, sampler5, texXy, dx, dy);\t}\n\t\t\t\t\t\telse\t\t\t\t\t{\tc = textureSampleGrad(texture6, sampler6, texXy, dx, dy);\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tif (texIndex <= 9)\n\t\t\t\t{\n\t\t\t\t\tif (texIndex == 7)\t\t\t{\tc = textureSampleGrad(texture7, sampler7, texXy, dx, dy);\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tif (texIndex == 8)\t\t{\tc = textureSampleGrad(texture8, sampler8, texXy, dx, dy);\t}\n\t\t\t\t\t\telse\t\t\t\t\t{\tc = textureSampleGrad(texture9, sampler9, texXy, dx, dy);\t}\n\t\t\t\t\t}\t\t\t\t\t\t\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tif (texIndex <= 11)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (texIndex == 10)\t\t{\tc = textureSampleGrad(texture10, sampler10, texXy, dx, dy);\t}\n\t\t\t\t\t\telse\t\t\t\t\t{\tc = textureSampleGrad(texture11, sampler11, texXy, dx, dy);\t}\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tif (texIndex == 12)\t\t{\tc = textureSampleGrad(texture12, sampler12, texXy, dx, dy);\t}\n\t\t\t\t\t\telse\t\t\t\t\t{\tc = textureSampleGrad(texture13, sampler13, texXy, dx, dy);\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\toutput.color = c * vec4<f32>(input.fragColor);\n\t\t\t${t?"output.fragDepth = select(input.fragPos.z, 1.0, output.color.a == 0.0);":""}\n\t\t\treturn output;\n\t\t}`}static GetSingleTextureFillFragmentShaderSource(t,e){return`\n\t\t@binding(0) @group(1) var sampler0 : sampler;\n\t\t@binding(1) @group(1) var texture0 : texture_2d<f32>;\n\n\t\tstruct FragmentInput {\n\t\t\t@location(1) fragUV : vec2<f32>,\n\t\t\t@location(2) fragColor : vec4<${e?"f16":"f32"}>,\n\t\t\t${t?"@builtin(position) fragPos: vec4<f32>":""}\n\t\t};\n\n\t\tstruct FragmentOutput {\n\t\t\t@location(0) color : vec4<f32>,\n\t\t\t${t?"@builtin(frag_depth) fragDepth: f32":""} \n\t\t};\n\n\t\t@fragment\n\t\tfn main(input : FragmentInput) -> FragmentOutput {\n\t\t\tvar output : FragmentOutput;\n\t\t\toutput.color = textureSample(texture0, sampler0, input.fragUV) * vec4<f32>(input.fragColor);\n\t\t\t${t?"output.fragDepth = select(input.fragPos.z, 1.0, output.color.a == 0.0);":""}\n\t\t\treturn output;\n\t\t}`}static _GetMipmapGeneratorVertexSource(){return"\n\t\tstruct VertexInput {\n\t\t\t@builtin(vertex_index) VertexIndex : u32\n\t\t};\n\t\t\n\t\tstruct VertexOutput {\n\t\t\t@builtin(position) Position : vec4<f32>,\n\t\t\t@location(0) fragUV : vec2<f32>\n\t\t};\n\n\t\t@vertex\n\t\tfn main(input : VertexInput) -> VertexOutput {\n\n\t\t\tvar pos : array<vec2<f32>, 4> = array<vec2<f32>, 4>(\n\t\t\t\tvec2<f32>(-1.0, 1.0),\n\t\t\t\tvec2<f32>(1.0, 1.0),\n\t\t\t\tvec2<f32>(-1.0, -1.0),\n\t\t\t\tvec2<f32>(1.0, -1.0));\n\t\t\t\n\t\t\tvar output : VertexOutput;\n\t\t\tvar p : vec2<f32> = pos[input.VertexIndex];\n\t\t\toutput.Position = vec4<f32>(p, 0.0, 1.0);\n\t\t\toutput.fragUV = p / 2.0 + 0.5;\n\t\t\treturn output;\n\t\t}"}static _GetMipmapGeneratorFragmentSource(){return"\n\t\t@binding(0) @group(0) var sampler0 : sampler;\n\t\t@binding(1) @group(0) var texture0 : texture_2d<f32>;\n\n\t\tstruct FragmentInput {\n\t\t\t@location(0) fragUV : vec2<f32>\n\t\t};\n\n\t\tstruct FragmentOutput {\n\t\t\t@location(0) color : vec4<f32>\n\t\t};\n\n\t\t@fragment\n\t\tfn main(input : FragmentInput) -> FragmentOutput {\n\t\t\tvar output : FragmentOutput;\n\t\t\toutput.color = textureSample(texture0, sampler0, vec2<f32>(input.fragUV.x, 1.0 - input.fragUV.y));\n\t\t\treturn output;\n\t\t}"}_GetMipmapGeneratorPipeline(t){t||(t=this._renderer.GetTextureFormat());let e=this._mipmapPipelineMap.get(t);return e||(e=this._GetDevice().createRenderPipeline({label:"<mipmap generator>",layout:"auto",vertex:{module:this._vertexModule,entryPoint:"main"},primitive:{topology:"triangle-strip",stripIndexFormat:"uint16"},fragment:{module:this._fragmentModule,entryPoint:"main",targets:[{format:t,blend:{color:{srcFactor:"one",dstFactor:"zero"},alpha:{srcFactor:"one",dstFactor:"zero"}}}]}}),this._mipmapPipelineMap.set(t,e)),e}static _GetPointVertexSource(){return`\n\t\t${u_}\n\n\t\tstruct PointData {\n\t\t\tdata : array<vec4<f32>>\n\t\t};\n\t\t@binding(3) @group(0) var<storage> pointBuffer : PointData;\n\n\t\tstruct VertexInput {\n\t\t\t@builtin(vertex_index) VertexIndex : u32\n\t\t};\n\n\t\tstruct VertexOutput {\n\t\t\t@builtin(position) Position : vec4<f32>,\n\t\t\t@location(0) fragUV : vec2<f32>,\n\t\t\t@location(1) pointOpacity : f32\n\t\t};\n\n\t\t@vertex\n\t\tfn main(input : VertexInput) -> VertexOutput {\n\n\t\t\tvar normPos : array<vec2<f32>, 4> = array<vec2<f32>, 4>(\n\t\t\t\tvec2<f32>(-0.5, -0.5),\n\t\t\t\tvec2<f32>(0.5, -0.5),\n\t\t\t\tvec2<f32>(0.5, 0.5),\n\t\t\t\tvec2<f32>(-0.5, 0.5));\n\t\t\t\n\t\t\tvar output : VertexOutput;\n\t\t\tvar p : vec2<f32> = normPos[input.VertexIndex % u32(4)];\n\t\t\tvar pointData : vec4<f32> = pointBuffer.data[input.VertexIndex / u32(4)];\n\n\t\t\tvar size : f32 = pointData.z;\n\t\t\toutput.Position = uniforms.transform * vec4<f32>(p * size + pointData.xy, uniforms.zElevation, 1.0);\n\t\t\toutput.pointOpacity = pointData.w;\n\n\t\t\tvar pointTexMin : vec2<f32> = min(uniforms.pointTexStart, uniforms.pointTexEnd);\n\t\t\tvar pointTexMax : vec2<f32> = max(uniforms.pointTexStart, uniforms.pointTexEnd);\n\t\t\tvar pn : vec2<f32> = p + vec2<f32>(0.5, 0.5);\n\t\t\tvar pointCoord : vec2<f32> = select(vec2<f32>(1.0 - pn.y, pn.x), pn, uniforms.pointTexEnd.x > uniforms.pointTexStart.x);\n\n\t\t\toutput.fragUV = mix(pointTexMin, pointTexMax, pointCoord);\n\t\t\treturn output;\n\t\t}`}static _GetPointFragmentSource(t){return`\n\t\t${p_}\n\n\t\t%%SAMPLERFRONT_BINDING%% var sampler0 : sampler;\n\t\t%%TEXTUREFRONT_BINDING%% var texture0 : texture_2d<f32>;\n\n\t\tstruct FragmentInput {\n\t\t\t@location(0) fragUV : vec2<f32>,\n\t\t\t@location(1) pointOpacity : f32,\n\t\t\t@builtin(position) fragPos : vec4<f32>\n\t\t};\n\t\t\n\t\tstruct FragmentOutput {\n\t\t\t@location(0) color : vec4<f32>,\n\t\t\t${t?"@builtin(frag_depth) fragDepth: f32":""} \n\t\t};\n\n\t\t@fragment\n\t\tfn main(input : FragmentInput) -> FragmentOutput {\n\t\t\tvar output : FragmentOutput;\n\t\t\toutput.color = textureSample(texture0, sampler0, input.fragUV) * uniforms.pointColor * input.pointOpacity;\n\t\t\t${t?"output.fragDepth = select(input.fragPos.z, 1.0, output.color.a == 0.0);":""}\n\t\t\treturn output;\n\t\t}`}static _GetTilemapFragmentShaderSource(t){return`\n\t\t${p_}\n\n\t\t%%SAMPLERFRONT_BINDING%% var sampler0 : sampler;\n\t\t%%TEXTUREFRONT_BINDING%% var texture0 : texture_2d<f32>;\n\n\t\t%%FRAGMENTINPUT_STRUCT%%\n\t\t\n\t\tstruct FragmentOutput {\n\t\t\t@location(0) color : vec4<f32>,\n\t\t\t${t?"@builtin(frag_depth) fragDepth: f32":""} \n\t\t};\n\n\t\t@fragment\n\t\tfn main(input : FragmentInput) -> FragmentOutput {\n\t\t\tvar output : FragmentOutput;\n\t\t\tvar halfPixelSize : vec2<f32> = vec2<f32>(0.5, 0.5) / vec2<f32>(textureDimensions(texture0));\n\n\t\t\tvar tile : vec2<f32> = floor(input.fragUV);\n\t\t\tvar tex : vec2<f32> = fract(input.fragUV);\n\t\t\tvar tileOrigin : vec2<f32> = uniforms.srcRectStart + tile * (uniforms.tileSize + uniforms.tileSpacing);\n\t\t\tvar lowerBound : vec2<f32> = tileOrigin + halfPixelSize;\n\t\t\tvar upperBound : vec2<f32> = tileOrigin + uniforms.tileSize - halfPixelSize;\n\n\t\t\toutput.color = textureSampleLevel(texture0, sampler0, clamp(tex, lowerBound, upperBound), 0.0) * vec4<f32>(input.fragColor);\n\t\t\t${t?"output.fragDepth = select(input.fragPos.z, 1.0, output.color.a == 0.0);":""}\n\t\t\treturn output;\n\t\t}`}static GetTileRandomizationFragmentShaderSource(t){return`\n${p_}\n\n%%SAMPLERFRONT_BINDING%% var sampler0 : sampler;\n%%TEXTUREFRONT_BINDING%% var texture0 : texture_2d<f32>;\n\n%%FRAGMENTINPUT_STRUCT%%\n\nstruct FragmentOutput {\n\t@location(0) color : vec4<f32>,\n\t${t?"@builtin(frag_depth) fragDepth: f32":""} \n};\n\n%%C3_UTILITY_FUNCTIONS%%\n\nconst PI : f32 = 3.1415926;\n\nfn cospVec4(a : vec4<f32>, b : vec4<f32>, x : f32) -> vec4<f32>\n{\n\treturn (a + b + (a - b) * cos(x * PI)) / 2.0;\n}\n\nfn randVec3(seed : vec2<f32>) -> vec3<f32>\n{\n\treturn vec3<f32>(\n\t\tfract(sin(dot(seed.xy, vec2<f32>(12.9898,78.233))) * 43758.5453),\n\t\tfract(sin(dot(seed.yx, vec2<f32>(12.9898,-78.233))) * 43758.5453),\n\t\tfract(sin(dot(seed.xy, vec2<f32>(-12.9898,-78.233))) * 43758.5453));\n}\n\nfn sampleTile(tile : vec2<f32>, uv : vec2<f32>, ddx : vec2<f32>, ddy : vec2<f32>) -> vec4<f32>\n{\n\tvar posRandom = uniforms.tileSize;\n\tvar angleRandom = uniforms.outlineThickness;\n\tvar pixelSize = c3_getPixelSize(texture0);\n\t\n\tvar rand = (randVec3(round(tile)) - 0.5) * 2.0;\n\t\n\tvar angle = angleRandom * rand.z * PI;\n\tvar sin_a = sin(angle);\n\tvar cos_a = cos(angle);\n\tvar aspect = pixelSize.x / pixelSize.y;\n\n\tvar mid = tile + vec2<f32>(0.5, 0.5);\n\tvar dp = uv - mid;\n\tdp.x /= aspect;\n\tvar r = vec2<f32>(dp.x * cos_a - dp.y * sin_a,\n\t\t\t\t\t  dp.y * cos_a + dp.x * sin_a);\n\tr.x *= aspect;\n\n\tvar p = mid + r + (posRandom * rand.xy / 2.0);\n\t\n\treturn textureSampleGrad(texture0, sampler0, p, ddx, ddy);\n}\n\n@fragment\nfn main(input : FragmentInput) -> FragmentOutput\n{\n\tvar output : FragmentOutput;\n\t\n\tvar blendMarginX = uniforms.tileSpacing.x;\n\tvar blendMarginY = uniforms.tileSpacing.y;\n\t\n\tvar tile = floor(input.fragUV);\n\tvar tex = fract(input.fragUV);\n\tvar ddx = dpdx(input.fragUV);\n\tvar ddy = dpdy(input.fragUV);\n\t\n\tvar curTile = sampleTile(tile, input.fragUV, ddx, ddy);\n\t\n\tvar inLeftMargin = (tex.x < blendMarginX);\n\tvar inRightMargin = (tex.x > 1.0 - blendMarginX);\n\tvar inTopMargin = (tex.y < blendMarginY);\n\tvar inBottomMargin = (tex.y > 1.0 - blendMarginY);\n\t\n\tif (inLeftMargin)\n\t{\n\t\tvar leftTile = sampleTile(tile + vec2<f32>(-1.0, 0.0), input.fragUV, ddx, ddy);\n\t\tvar leftMix = (tex.x / (blendMarginX * 2.0)) + 0.5;\n\t\tvar leftMixedTile = cospVec4(leftTile, curTile, leftMix);\n\t\t\n\t\tif (inTopMargin)\n\t\t{\n\t\t\tvar topTile =     sampleTile(tile + vec2<f32>(0.0,  -1.0), input.fragUV, ddx, ddy);\n\t\t\tvar topLeftTile = sampleTile(tile + vec2<f32>(-1.0, -1.0), input.fragUV, ddx, ddy);\n\t\t\tvar topLeftMixedTile = cospVec4(topLeftTile, topTile, leftMix);\n\t\t\t\n\t\t\toutput.color = cospVec4(topLeftMixedTile, leftMixedTile, (tex.y / (blendMarginY * 2.0)) + 0.5);\n\t\t}\n\t\telse if (inBottomMargin)\n\t\t{\n\t\t\tvar bottomTile =     sampleTile(tile + vec2<f32>(0.0,  1.0), input.fragUV, ddx, ddy);\n\t\t\tvar bottomLeftTile = sampleTile(tile + vec2<f32>(-1.0, 1.0), input.fragUV, ddx, ddy);\n\t\t\tvar bottomLeftMixedTile = cospVec4(bottomLeftTile, bottomTile, leftMix);\n\t\t\t\n\t\t\toutput.color = cospVec4(leftMixedTile, bottomLeftMixedTile, (tex.y - (1.0 - blendMarginY)) / (blendMarginY * 2.0));\n\t\t}\n\t\telse\n\t\t{\n\t\t\toutput.color = leftMixedTile;\n\t\t}\n\t}\n\telse if (inRightMargin)\n\t{\n\t\tvar rightTile = sampleTile(tile + vec2(1.0, 0.0), input.fragUV, ddx, ddy);\n\t\tvar rightMix = (tex.x - (1.0 - blendMarginX)) / (blendMarginX * 2.0);\n\t\tvar rightMixedTile = cospVec4(curTile, rightTile, rightMix);\n\t\t\n\t\tif (inTopMargin)\n\t\t{\n\t\t\tvar topTile =      sampleTile(tile + vec2<f32>(0.0, -1.0), input.fragUV, ddx, ddy);\n\t\t\tvar topRightTile = sampleTile(tile + vec2<f32>(1.0, -1.0), input.fragUV, ddx, ddy);\n\t\t\tvar topRightMixedTile = cospVec4(topTile, topRightTile, rightMix);\n\t\t\t\n\t\t\toutput.color = cospVec4(topRightMixedTile, rightMixedTile, (tex.y / (blendMarginY * 2.0)) + 0.5);\n\t\t}\n\t\telse if (inBottomMargin)\n\t\t{\n\t\t\tvar bottomTile =      sampleTile(tile + vec2<f32>(0.0, 1.0), input.fragUV, ddx, ddy);\n\t\t\tvar bottomRightTile = sampleTile(tile + vec2<f32>(1.0, 1.0), input.fragUV, ddx, ddy);\n\t\t\tvar bottomRightMixedTile = cospVec4(bottomTile, bottomRightTile, rightMix);\n\t\t\t\n\t\t\toutput.color = cospVec4(rightMixedTile, bottomRightMixedTile, (tex.y - (1.0 - blendMarginY)) / (blendMarginY * 2.0));\n\t\t}\n\t\telse\n\t\t{\n\t\t\toutput.color = rightMixedTile;\n\t\t}\n\t}\n\telse if (inTopMargin)\n\t{\n\t\tvar topTile = sampleTile(tile + vec2<f32>(0.0, -1.0), input.fragUV, ddx, ddy);\n\t\toutput.color = cospVec4(topTile, curTile, (tex.y / (blendMarginY * 2.0)) + 0.5);\n\t}\n\telse if (inBottomMargin)\n\t{\n\t\tvar bottomTile = sampleTile(tile + vec2<f32>(0.0, 1.0), input.fragUV, ddx, ddy);\n\t\toutput.color = cospVec4(curTile, bottomTile, (tex.y - (1.0 - blendMarginY)) / (blendMarginY * 2.0));\n\t}\n\telse\n\t{\n\t\toutput.color = curTile;\n\t}\n\t\n\toutput.color *= vec4<f32>(input.fragColor);\n\t${t?"output.fragDepth = select(input.fragPos.z, 1.0, output.color.a == 0.0);":""}\n\treturn output;\n}\n`}static _GetColorFillFragmentShaderSource(){return"\n\t\t%%FRAGMENTINPUT_STRUCT%%\n\t\t%%FRAGMENTOUTPUT_STRUCT%%\n\n\t\t@fragment\n\t\tfn main(input : FragmentInput) -> FragmentOutput {\n\t\t\tvar output : FragmentOutput;\n\t\t\toutput.color = vec4<f32>(input.fragColor);\n\t\t\treturn output;\n\t\t}"}static _GetLinearGradientFillFragmentShaderSource(){return`\n\t\t${p_}\n\n\t\t%%FRAGMENTINPUT_STRUCT%%\n\t\t%%FRAGMENTOUTPUT_STRUCT%%\n\n\t\tfn fromLinear(linearRGB : vec3<f32>) -> vec3<f32>\n\t\t{\n\t\t\tvar cutoff : vec3<bool> = (linearRGB < vec3<f32>(0.0031308));\n\t\t\tvar higher : vec3<f32> = vec3<f32>(1.055) * pow(abs(linearRGB), vec3<f32>(1.0/2.4)) - 0.055;\n\t\t\tvar lower : vec3<f32> = linearRGB * 12.92;\n\t\t\treturn select(higher, lower, cutoff);\n\t\t}\n\n\t\tfn toLinear(sRGB : vec3<f32>) -> vec3<f32>\n\t\t{\n\t\t\tvar cutoff : vec3<bool> = (sRGB < vec3<f32>(0.04045));\n\t\t\tvar higher : vec3<f32> = pow(abs((sRGB + 0.055) / 1.055), vec3<f32>(2.4));\n\t\t\tvar lower : vec3<f32> = sRGB / 12.92;\n\t\t\treturn select(higher, lower, cutoff);\n\t\t}\n\n\t\t@fragment\n\t\tfn main(input : FragmentInput) -> FragmentOutput {\n\t\t\tvar output : FragmentOutput;\n\t\t\tvar linearGrad : vec3<f32> = mix(toLinear(vec3<f32>(input.fragColor.rgb)), toLinear(uniforms.color2.rgb), vec3<f32>(input.fragUV.x));\n\n\t\t\tvar a : f32 = mix(f32(input.fragColor.a), uniforms.color2.a, input.fragUV.x);\n\t\t\toutput.color = vec4<f32>(fromLinear(linearGrad) * a, a);\n\t\t\treturn output;\n\t\t}\n\t\t`}static _GetPenumbraFillFragmentShaderSource(){return`\n\t\t${p_}\n\n\t\t%%FRAGMENTINPUT_STRUCT%%\n\t\t%%FRAGMENTOUTPUT_STRUCT%%\n\n\t\t@fragment\n\t\tfn main(input : FragmentInput) -> FragmentOutput {\n\t\t\tvar output : FragmentOutput;\n\t\t\tvar grad : f32 = input.fragUV.x / (1.0 - input.fragUV.y);\n\t\t\toutput.color = vec4<f32>(input.fragColor) * (1.0 - (cos(grad * 3.141592653589793) + 1.0) / 2.0);\n\t\t\treturn output;\n\t\t}\n\t\t`}static _GetHardEllipseFillFragmentShaderSource(){return"\n\t\t%%FRAGMENTINPUT_STRUCT%%\n\t\t%%FRAGMENTOUTPUT_STRUCT%%\n\n\t\t@fragment\n\t\tfn main(input : FragmentInput) -> FragmentOutput {\n\t\t\tvar output : FragmentOutput;\n\t\t\tvar diff : vec2<f32> = input.fragUV - 0.5;\n\t\t\tvar diffSq : vec2<f32> = diff * diff;\n\n\t\t\tvar f : f32 = step(diffSq.x + diffSq.y, 0.25);\n\n\t\t\toutput.color = vec4<f32>(input.fragColor) * f;\n\t\t\treturn output;\n\t\t}"}static _GetHardEllipseOutlineFragmentShaderSource(){return`\n\t\t${p_}\n\n\t\t%%FRAGMENTINPUT_STRUCT%%\n\t\t%%FRAGMENTOUTPUT_STRUCT%%\n\n\t\t@fragment\n\t\tfn main(input : FragmentInput) -> FragmentOutput {\n\t\t\tvar output : FragmentOutput;\n\t\t\tvar diff : vec2<f32> = input.fragUV - 0.5;\n\t\t\tvar diffSq : vec2<f32> = diff * diff;\n\t\t\tvar distSq : f32 = diffSq.x + diffSq.y;\n\t\t\tvar norm : vec2<f32> = normalize(diff);\n\t\t\tvar halfNorm : vec2<f32> = norm * 0.5;\n\n\t\t\tvar innerF : f32 = step(distSq, 0.25);\n\n\t\t\tvar innerEdge : vec2<f32> = halfNorm - uniforms.pixelSize * norm * uniforms.outlineThickness;\n\t\t\tvar innerEdgeSq : vec2<f32> = innerEdge * innerEdge;\n\t\t\tvar outerF : f32 = step(innerEdgeSq.x + innerEdgeSq.y, distSq);\n\t\t\t\n\t\t\toutput.color = vec4<f32>(input.fragColor) * innerF * outerF;\n\t\t\treturn output;\n\t\t}`}static _GetSmoothEllipseFillFragmentShaderSource(){return`\n\t\t${p_}\n\n\t\t%%FRAGMENTINPUT_STRUCT%%\n\t\t%%FRAGMENTOUTPUT_STRUCT%%\n\n\t\t@fragment\n\t\tfn main(input : FragmentInput) -> FragmentOutput {\n\t\t\tvar output : FragmentOutput;\n\t\t\tvar diff : vec2<f32> = input.fragUV - 0.5;\n\t\t\tvar diffSq : vec2<f32> = diff * diff;\n\t\t\tvar norm : vec2<f32> = normalize(diff);\n\t\t\tvar halfNorm : vec2<f32> = norm * 0.5;\n\t\t\tvar halfNormSq : vec2<f32> = halfNorm * halfNorm;\n\n\t\t\tvar innerEdge : vec2<f32> = halfNorm - uniforms.pixelSize * norm;\n\t\t\tvar innerEdgeSq : vec2<f32> = innerEdge * innerEdge;\n\n\t\t\tvar f : f32 = smoothstep(halfNormSq.x + halfNormSq.y, innerEdgeSq.x + innerEdgeSq.y, diffSq.x + diffSq.y);\n\n\t\t\toutput.color = vec4<f32>(input.fragColor) * f;\n\t\t\treturn output;\n\t\t}`}static _GetSmoothEllipseOutlineFragmentShaderSource(){return`\n\t\t${p_}\n\n\t\t%%FRAGMENTINPUT_STRUCT%%\n\t\t%%FRAGMENTOUTPUT_STRUCT%%\n\n\t\t@fragment\n\t\tfn main(input : FragmentInput) -> FragmentOutput {\n\t\t\tvar output : FragmentOutput;\n\t\t\tvar diff : vec2<f32> = input.fragUV - 0.5;\n\t\t\tvar diffSq : vec2<f32> = diff * diff;\n\t\t\tvar distSq : f32 = diffSq.x + diffSq.y;\n\t\t\tvar norm : vec2<f32> = normalize(diff);\n\t\t\tvar halfNorm : vec2<f32> = norm * 0.5;\n\t\t\tvar halfNormSq : vec2<f32> = halfNorm * halfNorm;\n\n\t\t\tvar pxNorm : vec2<f32> = uniforms.pixelSize * norm;\n\t\t\tvar innerEdge1 : vec2<f32> = halfNorm - pxNorm;\n\t\t\tvar innerEdge1Sq : vec2<f32> = innerEdge1 * innerEdge1;\n\n\t\t\tvar innerF : f32 = smoothstep(halfNormSq.x + halfNormSq.y, innerEdge1Sq.x + innerEdge1Sq.y, distSq);\n\n\t\t\tvar innerEdge2 : vec2<f32> = halfNorm - pxNorm * uniforms.outlineThickness;\n\t\t\tvar innerEdge2Sq : vec2<f32> = innerEdge2 * innerEdge2;\n\t\t\tvar innerEdge3 : vec2<f32> = halfNorm - pxNorm * (uniforms.outlineThickness + 1.0);\n\t\t\tvar innerEdge3Sq : vec2<f32> = innerEdge3 * innerEdge3;\n\n\t\t\tvar outerF : f32 = smoothstep(innerEdge3Sq.x + innerEdge3Sq.y, innerEdge2Sq.x + innerEdge2Sq.y, distSq);\n\t\t\t\n\t\t\toutput.color = vec4<f32>(input.fragColor) * innerF * outerF;\n\t\t\treturn output;\n\t\t}`}static _GetSmoothLineFillFragmentShaderSource(){return"\n\t\t%%FRAGMENTINPUT_STRUCT%%\n\t\t%%FRAGMENTOUTPUT_STRUCT%%\n\n\t\t@fragment\n\t\tfn main(input : FragmentInput) -> FragmentOutput {\n\t\t\tvar output : FragmentOutput;\n\t\t\tvar f : f32 = 1.0 - abs(input.fragUV.y - 0.5) * 2.0;\n\t\t\toutput.color = vec4<f32>(input.fragColor) * f;\n\t\t\treturn output;\n\t\t}"}}}{const w_=self.C3,M_=new Set(["nearest","bilinear","trilinear"]),P_=new Set(["clamp-to-edge","repeat","mirror-repeat"]),v_=self.GPUTextureUsage,R_={wrapX:"clamp-to-edge",wrapY:"clamp-to-edge",sampling:"trilinear",anisotropy:0,mipMap:!0,isRenderTarget:!1,isSampled:!1,canReadPixels:!1,canUpdate:!1,multisampling:0,width:-1,height:-1},A_=[[1,["r8unorm","r8snorm","r8uint","r8sint","stencil8"]],[2,["r16uint","r16sint","r16float","rg8unorm","rg8snorm","rg8uint","rg8sint","depth16unorm"]],[3,["depth24plus"]],[4,["r32uint","r32sint","r32float","rg16uint","rg16sint","rg16float","rgba8unorm","rgba8unorm-srgb","rgba8snorm","rgba8uint","rgba8sint","bgra8unorm","bgra8unorm-srgb","rgb9e5ufloat","rgb10a2uint","rgb10a2unorm","rg11b10ufloat","depth24plus-stencil8","depth32float"]],[8,["rg32uint","rg32sint","rg32float","rgba16uint","rgba16sint","rgba16float"]],[16,["rgba32uint","rgba32sint","rgba32float"]],[5,["depth32float-stencil8"]]],D_=new Map;for(const[O_,B_]of A_)for(const L_ of B_)D_.set(L_,O_);const E_=new Set,F_={premultiplyAlpha:!0,flipY:!1};w_.Gfx.WebGPURendererTexture=class{constructor(t,e){this._renderer=t,this._texture=null,this._format="",this._textureView=null,this._sampler=null,this._ownTextureBindGroup=null,this._backTextureBindGroup=null,this._width=0,this._height=0,this._isStatic=!0,this._wrapX="clamp-to-edge",this._wrapY="clamp-to-edge",this._sampling="trilinear",this._anisotropy=0,this._isMipMapped=!1,this._refCount=0,this._isRenderTarget=!1,this._isSampled=!1,this._canReadPixels=!1,this._canUpdate=!1,this._multisampling=0,this._usage=0,this._multiTextureEnabled=!0,this._multiTextureGroup=null,this._multiTextureIndex=0,this._isForBackbuffer=!!e,this._isForBackbuffer&&(this._format=this._renderer.GetSwapChainFormat(),this._isRenderTarget=!0,this._isSampled=this._renderer._CanSampleBackbuffer(),this._sampling=this._renderer._GetBackTextureSampling(),this._sampler=this._renderer._GetSampler({sampling:this._sampling}))}_InitFromOpts(t){if(this._wrapX=t.wrapX,this._wrapY=t.wrapY,this._sampling=t.sampling,this._anisotropy=t.anisotropy,this._isMipMapped=!!t.mipMap&&this._renderer.AreMipmapsEnabled()&&"nearest"!==t.sampling,this._isRenderTarget=!!t.isRenderTarget,this._isSampled=!!t.isSampled,this._canReadPixels=!!t.canReadPixels,this._canUpdate=!!t.canUpdate,this._multisampling=this._renderer._ClampToSupportedMultisampleValues(t.multisampling),!M_.has(this._sampling))throw new Error("invalid sampling");if(!P_.has(this._wrapX)||!P_.has(this._wrapY))throw new Error("invalid wrap mode");if(this._multisampling>=2&&this._isSampled)throw new Error("invalid use of multisampling");"nearest"===this._sampling&&(this._anisotropy=0),this._sampler=this._renderer._GetSampler({wrapX:this._wrapX,wrapY:this._wrapY,sampling:this._sampling,anisotropy:this._anisotropy}),this._CreateGPUResources(),this._refCount=1}_CreateGPUResources(){const t=this._renderer,e=t._GetDevice();this._usage=0,this._isRenderTarget?(this._usage=v_.RENDER_ATTACHMENT,this._isSampled&&(this._usage|=v_.TEXTURE_BINDING),this._canUpdate&&(this._usage|=v_.COPY_DST),this._format=this._renderer.GetSwapChainFormat()):(this._usage=v_.COPY_DST|v_.TEXTURE_BINDING,this._format=this._renderer.GetTextureFormat()),this._canReadPixels&&(this._usage|=v_.COPY_SRC),this._texture=e.createTexture({size:[this._width,this._height,1],mipLevelCount:this._GetMipLevelCount(),format:this._format,usage:this._usage,sampleCount:this._multisampling>=2?this._multisampling:1}),this._textureView=this._texture.createView();const s=[],i=w_.Gfx.WebGPUMultiTextureGroup.GetMultiTextureLimit();for(let t=0;t<i;++t)s.push({binding:2*t,resource:this._sampler},{binding:2*t+1,resource:this._textureView});this._isRenderTarget&&!this._isSampled||(this._ownTextureBindGroup=e.createBindGroup({layout:t._GetTextureBindGroupLayout(),entries:s}),this._backTextureBindGroup=e.createBindGroup({layout:t._GetBackTextureBindGroupLayout(),entries:[{binding:0,resource:this._renderer._GetSampler({sampling:this._renderer._GetBackTextureSampling()})},{binding:1,resource:this._textureView}]})),this._CanMultiTexture()&&this._SetMultiTextureAvailable(!0),E_.add(this)}_DeleteGPUResources(){E_.delete(this),this._multiTextureGroup&&this._multiTextureGroup.Release(),this._SetMultiTextureAvailable(!1),this._texture.destroy(),this._texture=null,this._textureView=null,this._ownTextureBindGroup=null,this._backTextureBindGroup=null}static IsGPUImageCopyExternalImageSource(t){return t instanceof ImageBitmap||"undefined"!=typeof HTMLVideoElement&&t instanceof HTMLVideoElement||"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement||"undefined"!=typeof OffscreenCanvas&&t instanceof OffscreenCanvas}static IsCreateImageBitmapDataSource(t){return"undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement||t instanceof ImageData}_GetDataSize(t){return[t.width||t.videoWidth,t.height||t.videoHeight]}_Create(t,e){if(t&&!w_.Gfx.WebGPURendererTexture.IsGPUImageCopyExternalImageSource(t))throw new TypeError("invalid texture source");if(e=Object.assign({},R_,e),this._texture)throw new Error("already created texture");if(this._isStatic=!0,t){const[e,s]=this._GetDataSize(t);this._width=e,this._height=s}else if(this._width=e.width,this._height=e.height,this._width<=0||this._height<=0)throw new Error("invalid texture size");if(this._InitFromOpts(e),this._isRenderTarget||this._isSampled)throw new Error("static texture cannot be render target");t&&this._UploadImage(t)}_UploadImage(t,e=!0){if(this._isMipMapped)this._GenerateMipmaps(t,this._GetMipLevelCount(),e);else{const s=this._renderer._GetDevice(),i=s.createCommandEncoder(),r=s.createTexture({size:[this._width,this._height,1],mipLevelCount:1,format:this._format,usage:v_.COPY_SRC|v_.COPY_DST|v_.RENDER_ATTACHMENT});this._CopyImageToMipLevel(r,t,0,e),i.copyTextureToTexture({texture:r,mipLevel:0},{texture:this._texture,mipLevel:0},[this._width,this._height,1]),s.queue.submit([i.finish()]),r.destroy()}}_CopyImageToMipLevel(t,e,s,i=!0){const[r,n]=this._GetDataSize(e);this._renderer._GetDevice().queue.copyExternalImageToTexture({source:e},{texture:t,mipLevel:s,premultipliedAlpha:!!i},[r,n,1])}_GetMipLevelCount(){return this._isMipMapped?Math.floor(Math.log2(Math.max(this._width,this._height))+1):1}_GenerateMipmaps(t,e,s=!0){const i=this._renderer._GetDevice(),r=i.createTexture({size:[this._width,this._height,1],mipLevelCount:this._GetMipLevelCount(),format:this._format,usage:v_.COPY_DST|v_.COPY_SRC|v_.TEXTURE_BINDING|v_.RENDER_ATTACHMENT}),n=this._renderer._GetMipmapGeneratorPipeline(),a=n.getBindGroupLayout(0),o=this._renderer._GetSampler({sampling:"bilinear"}),h=i.createCommandEncoder();this._CopyImageToMipLevel(r,t,0,s),h.copyTextureToTexture({texture:r,mipLevel:0},{texture:this._texture,mipLevel:0},[this._width,this._height,1]);const l=[];for(let t=0;t<e;++t)l.push(r.createView({baseMipLevel:t,mipLevelCount:1}));let c=this._width,u=this._height;for(let t=1;t<e;++t){c/=2,u/=2;const e=Math.max(Math.floor(c),1),s=Math.max(Math.floor(u),1),_=h.beginRenderPass({colorAttachments:[{view:l[t],loadOp:"clear",clearValue:[0,0,0,0],storeOp:"store"}]}),d=i.createBindGroup({layout:a,entries:[{binding:0,resource:o},{binding:1,resource:l[t-1]}]});_.setPipeline(n),_.setBindGroup(0,d),_.draw(4),_.end(),h.copyTextureToTexture({texture:r,mipLevel:t},{texture:this._texture,mipLevel:t},[e,s,1])}i.queue.submit([h.finish()]),r.destroy()}_CreateDynamic(t,e,s){if(s=Object.assign({},R_,s),this._texture)throw new Error("already created texture");this._isStatic=!1,this._width=t,this._height=e,this._InitFromOpts(s)}async _Update(t,e){if(!w_.Gfx.WebGPURendererTexture.IsGPUImageCopyExternalImageSource(t)&&!w_.Gfx.WebGPURendererTexture.IsCreateImageBitmapDataSource(t))throw new Error("invalid texture source");if(!this._texture||this._refCount<=0)throw new Error("texture not created");if(this._isStatic)throw new Error("cannot update static texture");if(e=Object.assign({},F_,e),(w_.Gfx.WebGPURendererTexture.IsCreateImageBitmapDataSource(t)||e.flipY||!e.premultiplyAlpha)&&(t=await createImageBitmap(t,{premultiplyAlpha:e.premultiplyAlpha?"premultiply":"none",imageOrientation:e.flipY?"flipY":"none"}),!this._texture))return;this._renderer.EndBatch();const[s,i]=this._GetDataSize(t);this._width===s&&this._height===i||(this._DeleteGPUResources(),this._width=s,this._height=i,this._CreateGPUResources(),this._renderer._OnTextureBindGroupChanged(this)),this._UploadImage(t,e.premultiplyAlpha)}_Delete(){if(this._refCount>0)throw new Error("texture still has references");if(!this._texture)throw new Error("already deleted texture");this._DeleteGPUResources()}_DisableMultiTexture(){this._multiTextureEnabled=!1,this._SetMultiTextureAvailable(!1)}_CanMultiTexture(){return this._isStatic&&this._multiTextureEnabled&&!this._isRenderTarget}_SetMultiTextureAvailable(t){this._renderer._SetMultiTextureAvailable(this,t)}_SetMultiTextureGroup(t,e){if(this._multiTextureGroup)throw new Error("already in a group");this._multiTextureGroup=t,this._multiTextureIndex=e,this._SetMultiTextureAvailable(!1)}_ClearMultiTextureGroup(){this._multiTextureGroup=null,this._multiTextureIndex=0,this._CanMultiTexture()&&this._SetMultiTextureAvailable(!0)}_GetOwnTextureBindGroup(){return this._ownTextureBindGroup}_GetBackTextureBindGroup(){return this._backTextureBindGroup}_GetMultiTextureBindGroup(){return null!==this._multiTextureGroup?this._multiTextureGroup._GetBindGroup():this._CanMultiTexture()?(this._renderer._TryCreateMultiTextureGroup(this),null!==this._multiTextureGroup?this._multiTextureGroup._GetBindGroup():null):null}_GetMultiTextureIndex(){return this._multiTextureIndex}GetWidth(){return this._isForBackbuffer?this._renderer.GetWidth():this._width}GetHeight(){return this._isForBackbuffer?this._renderer.GetHeight():this._height}GetRenderer(){return this._renderer}_GetTexture(){return this._texture}_GetTextureView(){return this._textureView}_GetFormat(){return this._format}_GetSampler(){return this._sampler}GetSampling(){return this._sampling}IsLinearSampling(){return"nearest"!==this._sampling}IsRenderTarget(){return this._isRenderTarget}IsSampled(){return this._isSampled}CanReadPixels(){return this._canReadPixels}AddReference(){this._refCount++}SubtractReference(){if(this._refCount<=0)throw new Error("no more references");this._refCount--}GetReferenceCount(){return this._refCount}_GetUsage(){return this._usage}_BackbufferTextureSetProperties(t,e){this._usage=t,this._format=e}_BackbufferTextureStartFrame(){const t=this._renderer,e=t._GetDevice();this._texture=t._GetSwapChainTexture(),this._textureView=t._GetSwapChainTexView(),t._CanSampleBackbuffer()&&(this._backTextureBindGroup=e.createBindGroup({layout:t._GetBackTextureBindGroupLayout(),entries:[{binding:0,resource:this._sampler},{binding:1,resource:this._textureView}]}))}_BackbufferTextureEndFrame(){this._texture=null,this._textureView=null,this._backTextureBindGroup=null}GetEstimatedMemoryUsage(){let t=this.GetWidth()*this.GetHeight()*w_.Gfx.WebGPURendererTexture.GetFormatByteSize(this._GetFormat());return this._isMipMapped&&(t+=Math.floor(t/3)),t}static OnContextLost(){}static allTextures(){return E_.values()}static GetFormatByteSize(t){const e=D_.get(t);return"number"==typeof e?e:NaN}}}{const k_=self.C3;k_.Gfx.WebGPUMultiTextureGroup=class{constructor(t,e){if(e.length<2)throw new Error("invalid multi-texture group");this._renderer=t,this._textures=e,this._multiTextureBindGroup=null;for(let t=0,s=e.length;t<s;++t)e[t]._SetMultiTextureGroup(this,t);e.length<k_.Gfx.WebGPUMultiTextureGroup.GetMultiTextureLimit()&&this._renderer._SetMultiTextureGroupNonFull(this,!0),this._CreateBindGroup()}Release(){this._renderer._SetMultiTextureGroupNonFull(this,!1);for(const t of this._textures)t._ClearMultiTextureGroup();this._DeleteBindGroup(),k_.clearArray(this._textures),this._renderer=null}_CreateBindGroup(){this._DeleteBindGroup();const t=this._renderer._GetDevice(),e=[],s=k_.Gfx.WebGPUMultiTextureGroup.GetMultiTextureLimit();for(let t=0;t<s;++t){const s=this._textures[Math.min(t,this._textures.length-1)];e.push({binding:2*t,resource:s._GetSampler()},{binding:2*t+1,resource:s._GetTextureView()})}this._multiTextureBindGroup=t.createBindGroup({layout:this._renderer._GetTextureBindGroupLayout(),entries:e})}_DeleteBindGroup(){null!==this._multiTextureBindGroup&&this._renderer._OnMultiTextureBindGroupReleased(this._multiTextureBindGroup),this._multiTextureBindGroup=null}_GetBindGroup(){return this._multiTextureBindGroup}static GetMultiTextureLimit(){return 14}}}{const N_=self.C3,U_=self.glMatrix,W_=(U_.vec3,U_.mat4),j_={sampling:"trilinear",alpha:!0,depth:!1,isSampled:!0,canReadPixels:!1,canUpdate:!1,isDefaultSize:!0,multisampling:0},V_=new Set;N_.Gfx.WebGPURenderTarget=class{constructor(t,e){this._renderer=t,this._isBackBuffer=!!e,this._depth=!!e&&t.UsesDepthBuffer(),this._rendererTexture=null,this._isDefaultSize=!0,this._multisampling=0,this._isAwaitingClear=!1,this._clearColor=N_.New(N_.Color),this._projectionMatrix=W_.create(),this._lastFov=0,this._lastNearZ=0,this._lastFarZ=0,this._isBackBuffer&&(this._rendererTexture=N_.New(N_.Gfx.WebGPURendererTexture,t,!0))}_Create(t,e,s){if(s=Object.assign({},j_,s),this._rendererTexture)throw new Error("already created render target");if(this._depth=!!s.depth,this._isDefaultSize=!!s.isDefaultSize,this._multisampling=this._renderer._ClampToSupportedMultisampleValues(s.multisampling),this._multisampling>=2&&s.isSampled)throw new Error("invalid use of multisampling");this._rendererTexture=this._renderer.CreateDynamicTexture(t,e,{sampling:s.sampling,mipMap:!1,isRenderTarget:!0,isSampled:s.isSampled,canReadPixels:s.canReadPixels,canUpdate:s.canUpdate,multisampling:this._multisampling}),this._CalculateProjection(),V_.add(this)}_Delete(){V_.delete(this),this._rendererTexture._DeleteGPUResources(),this._rendererTexture=null,this._renderer=null}_Resize(t,e){if(t===this.GetWidth()&&e===this.GetHeight())return;const s=this._rendererTexture.GetSampling(),i=this._rendererTexture.IsSampled(),r=this._rendererTexture.CanReadPixels();this._rendererTexture._DeleteGPUResources(),this._rendererTexture=null,this._rendererTexture=this._renderer.CreateDynamicTexture(t,e,{sampling:s,mipMap:!1,isRenderTarget:!0,isSampled:i,canReadPixels:r}),this._CalculateProjection()}_GetTextureView(){return this._isBackBuffer?this._renderer._GetSwapChainTexView():this._rendererTexture._GetTextureView()}_CalculateProjection(){this._renderer.CalculatePerspectiveMatrix(this._projectionMatrix,this.GetWidth()/this.GetHeight()),this._lastFov=this._renderer.GetFovY(),this._lastNearZ=this._renderer.GetNearZ(),this._lastFarZ=this._renderer.GetFarZ()}IsDefaultSize(){return this._isDefaultSize}IsBackBuffer(){return this._isBackBuffer}HasDepthBuffer(){return this._depth}GetWidth(){return this._isBackBuffer?this._renderer.GetWidth():this._rendererTexture.GetWidth()}GetHeight(){return this._isBackBuffer?this._renderer.GetHeight():this._rendererTexture.GetHeight()}GetTexture(){if(this._rendererTexture)return this._rendererTexture;throw new Error("no texture")}GetRenderer(){return this._renderer}GetMultisampling(){return this._multisampling}GetProjectionMatrix(){return this._renderer.GetFovY()===this._lastFov&&this._renderer.GetNearZ()===this._lastNearZ&&this._renderer.GetFarZ()===this._lastFarZ||this._CalculateProjection(),this._projectionMatrix}IsLinearSampling(){return this._rendererTexture.IsLinearSampling()}IsSampled(){return this._rendererTexture.IsSampled()}CanReadPixels(){return this._rendererTexture.CanReadPixels()}IsCompatibleWithOptions(t){return"nearest"!==(t=Object.assign({},j_,t)).sampling===this.IsLinearSampling()&&!!t.isSampled===this.IsSampled()&&!!t.canReadPixels===this.CanReadPixels()&&!!t.depth===this.HasDepthBuffer()&&("number"==typeof t.width||"number"==typeof t.height?!this.IsDefaultSize()&&this.GetWidth()===Math.floor(t.width)&&this.GetHeight()===Math.floor(t.height):this.IsDefaultSize())}_SetIsAwaitingClear(t){this._isAwaitingClear=!!t}_IsAwaitingClear(){return this._isAwaitingClear}_GetClearColor(){return this._clearColor}static OnContextLost(){}static allRenderTargets(){return V_.values()}}}self.C3.Gfx.WebGPUTimeQuerySet=class{constructor(t,e){this._renderer=t,this._frameNumber=this._renderer.GetFrameNumber(),this._queryCount=e;const s=this._renderer._GetDevice();this._querySet=s.createQuerySet({count:this._queryCount,type:"timestamp"});const i=self.GPUBufferUsage;this._resolveBuffer=s.createBuffer({size:this._GetBufferSize(),usage:i.QUERY_RESOLVE|i.COPY_SRC}),this._readbackBuffer=s.createBuffer({size:this._GetBufferSize(),usage:i.COPY_DST|i.MAP_READ}),this._result=null}_GetBufferSize(){return 8*this._queryCount}_GetQuerySet(){return this._querySet}Resolve(t){t.resolveQuerySet(this._querySet,0,this._queryCount,this._resolveBuffer,0),t.copyBufferToBuffer(this._resolveBuffer,0,this._readbackBuffer,0,this._GetBufferSize())}async ReadResult(){const t=this._GetBufferSize();await this._readbackBuffer.mapAsync(self.GPUMapMode.READ,0,t);const e=this._readbackBuffer.getMappedRange(0,t);this._result=new BigUint64Array(e.slice(0)),this._readbackBuffer.destroy(),this._readbackBuffer=null,this._resolveBuffer.destroy(),this._resolveBuffer=null,this._querySet.destroy(),this._querySet=null}HasResult(){return null!==this._result}GetResult(){if(!this._result)throw new Error("not yet got result");return this._result}GetFrameNumber(){return this._frameNumber}};{const z_=self.C3,H_={getDrawSize:null,getRenderTarget:null,releaseRenderTarget:null,getTime:null,redraw:null};z_.Gfx.EffectChainManager=class{constructor(t){t=Object.assign({},H_,t),this._cbGetDrawSize=t.getDrawSize,this._cbGetRenderTarget=t.getRenderTarget,this._cbReleaseRenderTarget=t.releaseRenderTarget,this._cbGetTime=t.getTime,this._cbRedraw=t.redraw,this._webgpuBackTexture=null,this._allEffectChains=new Set}_AddEffectChain(t){this._allEffectChains.add(t)}_RemoveEffectChain(t){this._allEffectChains.delete(t)}OnContextLost(){this._webgpuBackTexture=null;for(const t of this._allEffectChains)t.OnContextLost()}GetDrawSize(t){return this._cbGetDrawSize?this._cbGetDrawSize(t):[t.GetWidth(),t.GetHeight()]}GetRenderTarget(t){return this._cbGetRenderTarget(t)}ReleaseRenderTarget(t,e){this._cbReleaseRenderTarget(t,e)}GetTime(){return this._cbGetTime()}Redraw(t){this._cbRedraw(t)}_GetWebGPUBackTexture(t,e,s){return e=Math.floor(e),s=Math.floor(s),!this._webgpuBackTexture||this._webgpuBackTexture.GetWidth()===e&&this._webgpuBackTexture.GetHeight()===s||(t.DeleteTexture(this._webgpuBackTexture),this._webgpuBackTexture=null),null===this._webgpuBackTexture&&(this._webgpuBackTexture=t.CreateStaticTexture(null,{width:e,height:s,sampling:"nearest",mipMap:!1})),this._webgpuBackTexture}}}{const Y_=self.C3,X_=(self.assert,self.glMatrix.mat4),q_=Y_.New(Y_.Rect),J_=Y_.New(Y_.Rect),Q_=Y_.New(Y_.Rect),K_=Y_.New(Y_.Rect),Z_=X_.create(),$_=X_.create(),td={drawContent:null,getSourceTextureInfo:null,getShaderParameters:null,invalidateRenderTargets:!1},ed={indexMap:null,forcePreDraw:!1,forcePostDraw:!1,is3D:!1,isSourceTextureRotated:!1,isRotatedOrNegativeSizeInstance:!1,useFullSurface:!1};Y_.Gfx.EffectChain=class{constructor(t,e){e=Object.assign({},td,e),this._manager=t,this._cbDrawContent=e.drawContent,this._cbGetSourceTextureInfo=e.getSourceTextureInfo,this._cbGetShaderParameters=e.getShaderParameters,this._cbDrawContentHook=null,this._shaderProgramList=[],this._shaderProgramIndices=[],this._steps=[],this._needsRebuild=!1,this._blendMode=0,this._isAnyShaderAnimated=!1,this._isAnyShaderDepthSampling=!1,this._isAnyShaderBackgroundBlending=!1,this._isAnyShaderCrossSampling=!1,this._isAnyIsSrcTexRotated=!1,this._useCopyTextureBackgroundSampling=!1,this._didChangeTransform=!1,this._depthEnabledAtStart=!1,this._coplanarColorPassAtStart=!1,this._canUseFastPath=!1,this._useFullSurface=!1,this._isSourceTextureRotated=!1,this._numTempSurfacesRequired=0,this._renderTargets=[null,null,null],this._invalidateRenderTargets=!!e.invalidateRenderTargets,this._boxExtendHorizontal=0,this._boxExtendVertical=0,this._drawWidth=0,this._drawHeight=0,this._contentObject=null,this._contextObject=null,this._layoutRect=Y_.New(Y_.Rect),this._drawSurfaceRect=Y_.New(Y_.Rect),this._rcTexOriginal=Y_.New(Y_.Rect),this._rcTexBounce=Y_.New(Y_.Rect),this._rcTexDest=Y_.New(Y_.Rect),this._devicePixelRatio=1,this._layerScale=1,this._layerAngle=0,this._time=0,this._destRenderTarget=null,this._backTex=null,this._compositOffX=0,this._compositOffY=0,this._compositRtWidth=0,this._compositRtHeight=0,this._updateOwnProjection=!1,this._projectionMatrix=X_.create(),this._modelViewMatrix=X_.create(),this._manager._AddEffectChain(this)}Release(){this._manager._RemoveEffectChain(this),Y_.clearArray(this._steps),Y_.clearArray(this._shaderProgramList),Y_.clearArray(this._shaderProgramIndices),this._contentObject=null,this._contextObject=null,this._cbDrawContent=null,this._cbGetSourceTextureInfo=null,this._cbGetShaderParameters=null}OnContextLost(){this._needsRebuild=!0,Y_.clearArray(this._steps),Y_.clearArray(this._shaderProgramList),Y_.clearArray(this._shaderProgramIndices)}NeedsRebuild(){return this._needsRebuild}BuildSteps(t,e){if(e=Object.assign({},ed,e),Y_.clearArray(this._steps),this._boxExtendHorizontal=0,this._boxExtendVertical=0,this._isAnyShaderAnimated=!1,this._isAnyShaderDepthSampling=!1,this._isAnyShaderBackgroundBlending=!1,this._isAnyShaderCrossSampling=!1,this._isAnyIsSrcTexRotated=!1,this._useCopyTextureBackgroundSampling=!1,this._numTempSurfacesRequired=0,this._isSourceTextureRotated=!!e.isSourceTextureRotated,this._useFullSurface=!!e.useFullSurface,this._needsRebuild=!1,Y_.shallowAssignArray(this._shaderProgramList,t),0===t.length)return;if(e.indexMap){if(e.indexMap.length!==t.length)throw new Error("incorrect indexMap length");Y_.shallowAssignArray(this._shaderProgramIndices,e.indexMap)}else{Y_.clearArray(this._shaderProgramIndices);for(let e=0,s=t.length;e<s;++e)this._shaderProgramIndices.push(e)}for(const e of t)this._boxExtendHorizontal+=e.GetBoxExtendHorizontal(),this._boxExtendVertical+=e.GetBoxExtendVertical(),e.IsAnimated()&&(this._isAnyShaderAnimated=!0),e.UsesDepth()&&(this._isAnyShaderDepthSampling=!0),e.BlendsBackground()&&(this._isAnyShaderBackgroundBlending=!0),e.UsesCrossSampling()&&(this._isAnyShaderCrossSampling=!0),e.UsesIsSrcTexRotated()&&(this._isAnyIsSrcTexRotated=!0);this._useCopyTextureBackgroundSampling=this._ShouldUseCopyTextureBackgroundSampling(t[0].GetRenderer());const s=this._ShouldPreDraw(t[0],e),i=this._ShouldPostDraw(t.at(-1),e);if(1===t.length&&!s&&!i)return void(this._canUseFastPath=!0);this._canUseFastPath=!1;let r=0;s&&(this._numTempSurfacesRequired=1,this._steps.push(Y_.New(Y_.Gfx.EffectChain.Step.PreDraw,this,-1,1)),r=1);for(let e=0,n=t.length;e<n;++e)if(0!==e||s){let t=1===r?2:1;e!==n-1||i||(t=0),this._numTempSurfacesRequired=Math.max(this._numTempSurfacesRequired,t),this._steps.push(Y_.New(Y_.Gfx.EffectChain.Step.Bounce,this,r,t,e)),r=t}else this._numTempSurfacesRequired=1,this._steps.push(Y_.New(Y_.Gfx.EffectChain.Step.FirstBounce,this,-1,1,e)),r=1;i&&this._steps.push(Y_.New(Y_.Gfx.EffectChain.Step.PostDraw,this,r,0))}_ShouldPreDraw(t,e){return!!(e.forcePreDraw||t.MustPreDraw()||e.is3D&&!t.Supports3DDirectRendering()||t.UsesDepth()&&!this._useFullSurface||0!==this._boxExtendHorizontal||0!==this._boxExtendVertical)||(t.GetRenderer().IsWebGL()?t.BlendsBackground()&&(e.isRotatedOrNegativeSizeInstance||e.isSourceTextureRotated)||t.UsesAnySrcRectOrPixelSize()&&e.isSourceTextureRotated:t.BlendsBackground()&&!this._useCopyTextureBackgroundSampling&&e.isRotatedOrNegativeSizeInstance)}_ShouldPostDraw(t,e){return!!e.forcePostDraw||(t.GetRenderer().IsWebGL()?t.BlendsBackground()||t.UsesCrossSampling():(t.BlendsBackground()||t.UsesCrossSampling())&&this._UseRenderTargetBackgroundSampling())}_ShouldUseCopyTextureBackgroundSampling(t){return t.IsWebGPU()&&this._isAnyShaderBackgroundBlending&&!this._isAnyShaderCrossSampling}Render(t,e,s){t.IsWebGPU()&&null===e&&(e=t.GetBackbufferRenderTarget()),this._destRenderTarget=e,this._contentObject=s.contentObject||null,this._contextObject=s.contextObject||null,this._blendMode=s.blendMode||0,this._devicePixelRatio=s.devicePixelRatio||1,this._layerScale=s.layerScale||1,this._layerAngle=s.layerAngle||0,this._time="number"==typeof s.time?s.time:this._manager.GetTime(),this._didChangeTransform=!1,t.ResetDidChangeTransformFlag(),this._isAnyShaderAnimated&&this._Redraw();let i=!1;if(this._UseCopyTextureBackgroundSampling()&&(this._CalculateDrawSizeAndRectangles(t,s),i=!0,this._backTex=this._manager._GetWebGPUBackTexture(t,this._drawWidth,this._drawHeight),q_.copy(this._drawSurfaceRect),q_.roundOuter(),t.IsWebGPU()&&t._MaybeDoPendingClearRenderPass(this._destRenderTarget),t.CopyTextureToTexture(this._destRenderTarget.GetTexture(),this._backTex,q_.getLeft(),q_.getTop(),q_.width(),q_.height())),this._canUseFastPath)this._Render_FastPath(t,s);else if(i||this._CalculateDrawSizeAndRectangles(t,s),0!==this._rcTexOriginal.width()||0!==this._rcTexOriginal.height()){t.SetAlphaBlend(),t.ResetCullState(),t.ResetColor(),t.SetBaseZ(0),t.SetCurrentZ(0),this._cbDrawContentHook=s.drawContentHook||null,this._compositOffX=s.compositOffX||0,this._compositOffY=s.compositOffY||0,this._compositRtWidth=s.compositRtWidth||0,this._compositRtHeight=s.compositRtHeight||0,this._updateOwnProjection=!!s.updateOwnProjection,this._OnBeforeStartEffectChain(t),this._renderTargets[0]=e,this._renderTargets[1]=this._numTempSurfacesRequired>=1?this._GetRenderTarget():null,this._renderTargets[2]=2===this._numTempSurfacesRequired?this._GetRenderTarget():null;for(const e of this._steps){const s=this._GetRenderTargetForId(e.GetSrcTargetId()),i=this._GetRenderTargetForId(e.GetDestTargetId());t.IsWebGPU()?e.Run_WebGPU(t,s,i):e.Run_WebGL(t,s,i)}t.SetTexture(null),this._renderTargets[1]&&this._ReleaseRenderTarget(this._renderTargets[1]),this._renderTargets[2]&&this._ReleaseRenderTarget(this._renderTargets[2]),this._renderTargets.fill(null),this._OnAfterEndEffectChain(t),this._destRenderTarget=null,this._backTex=null,this._contentObject=null,this._contextObject=null,this._cbDrawContentHook=null}}_CalculateDrawSizeAndRectangles(t,e){const[s,i]=this._manager.GetDrawSize(t);this._SetDrawSize(t,s,i),this._CalculateRectangles(e)}_SetDrawSize(t,e,s){if(e<=0||s<=0)throw new Error("invalid draw size");this._drawWidth===e&&this._drawHeight===s||this._CalculateDeviceTransformMatrices(t,e,s,0,0,this._projectionMatrix,this._modelViewMatrix),this._drawWidth=e,this._drawHeight=s}_CalculateDeviceTransformMatrices(t,e,s,i,r,n,a){const o=e/2+i,h=s/2+r;t.CalculatePerspectiveMatrix(n,e/s);const l=t.CalculateLookAtModelView2(o,h,t.GetDefaultCameraZ(s),o,h,0,s);X_.copy(a,l)}_CalculateRectangles(t){if(this._layoutRect.copy(t.layoutRect),t.drawSurfaceRect?this._drawSurfaceRect.copy(t.drawSurfaceRect):this._drawSurfaceRect.set(0,0,this._drawWidth,this._drawHeight),this._canUseFastPath){const e=t.compositOffX??0,s=t.compositOffY??0;this._drawSurfaceRect.offset(-e,-s)}this._rcTexOriginal.copy(this._drawSurfaceRect),this._rcTexOriginal.divide(this._drawWidth,this._drawHeight);const e=this._layerScale*this._devicePixelRatio;this._drawSurfaceRect.inflate(this._boxExtendHorizontal*e,this._boxExtendVertical*e),this._rcTexDest.copy(this._drawSurfaceRect),this._rcTexDest.divide(this._drawWidth,this._drawHeight),this._drawSurfaceRect.clampBoth(0,0,this._drawWidth,this._drawHeight),this._rcTexBounce.copy(this._drawSurfaceRect),this._rcTexBounce.divide(this._drawWidth,this._drawHeight)}_OnBeforeStartEffectChain(t){if(this._depthEnabledAtStart=t.IsDepthEnabled(),this._coplanarColorPassAtStart=t.IsCoplanarColorPass(),this._useFullSurface)t.SetDepthEnabled(!1),this._isAnyShaderDepthSampling&&t.SetDepthSamplingEnabled(!0);else{if(q_.copy(this._drawSurfaceRect),t.IsWebGL()){const t=this._layerScale*this._devicePixelRatio;q_.inflate(Math.max(this._boxExtendHorizontal,1)*t,Math.max(this._boxExtendVertical,1)*t),q_.roundOuter(),q_.clamp(0,0,this._drawWidth,this._drawHeight)}else q_.roundOuter();t.SetScissorRect(q_.getLeft(),q_.getTop(),q_.width(),q_.height(),this._drawHeight)}}_OnAfterEffectChainDrawContent(t){t.ResetColor(),this._useFullSurface||(this._coplanarColorPassAtStart?t.CoplanarRestoreStandardRendering(!1):t.SetDepthEnabled(!1),this._isAnyShaderDepthSampling&&t.SetDepthSamplingEnabled(!0)),t.IsWebGPU()&&t.SetNormalizedCoordsProgramVariant(!0)}_OnAfterEndEffectChain(t){t.SetDepthSamplingEnabled(!1),this._coplanarColorPassAtStart?t.CoplanarStartColorPass(this._depthEnabledAtStart):t.SetDepthEnabled(this._depthEnabledAtStart),this._useFullSurface||t.RemoveScissorRect(),t.IsWebGPU()&&t.SetNormalizedCoordsProgramVariant(!1),this._didChangeTransform=t.DidChangeTransform()}_ClampRcTexDest(){this._rcTexDest.clamp(0,0,1,1)}_GetRenderTargetForId(t){return t<0?null:this._renderTargets[t]}_GetRenderTarget(){return this._manager.GetRenderTarget(this)}_GetDestRenderTarget(){return this._destRenderTarget}_ReleaseRenderTarget(t){this._manager.ReleaseRenderTarget(t,this)}_GetShaderProgramAt(t){return this._shaderProgramList[t]}_DrawContent(t){this._cbDrawContentHook?this._cbDrawContentHook(this,t,()=>this._cbDrawContent(t,this)):this._cbDrawContent(t,this),this._canUseFastPath||this._OnAfterEffectChainDrawContent(t)}_IsRenderTargetSameSizeAndOffset(t){if(this._useFullSurface)return!0;if(0!==this._compositOffX||0!==this._compositOffY||0!==this._compositRtWidth||0!==this._compositRtHeight)return!1;const[e,s]=t.GetRenderTargetSize(t.GetRenderTarget());return e===this._drawWidth&&s===this._drawHeight}_SetDeviceTransform(t,e){let s=this._projectionMatrix,i=this._modelViewMatrix;if(e&&!this._IsRenderTargetSameSizeAndOffset(t)){let e,r;s=Z_,i=$_,0!==this._compositRtWidth&&0!==this._compositRtHeight?[e,r]=[this._compositRtWidth,this._compositRtHeight]:[e,r]=t.GetRenderTargetSize(t.GetRenderTarget()),this._CalculateDeviceTransformMatrices(t,e,r,this._compositOffX,this._compositOffY,s,i),this._useFullSurface||t.RemoveScissorRect()}t.SetProjectionMatrix(s),t.SetModelViewMatrix(i)}_Redraw(){this._manager.Redraw(this)}_GetShaderParameters(t,e){return this._cbGetShaderParameters(this._shaderProgramIndices[t],e)}_SetProgramParameters(t,e){let s=this._rcTexDest,i=this._rcTexBounce,r=this._rcTexOriginal;t.IsWebGL()&&(J_.copy(s),J_.flipAround(1),s=J_,Q_.copy(i),Q_.flipAround(1),i=Q_,K_.copy(r),K_.flipAround(1),r=K_),this._DoSetProgramParameters(t,e,i,r,s,1/this._drawWidth,1/this._drawHeight)}_SetFirstBounceProgramParameters(t,e){let s=this._rcTexBounce,i=this._rcTexOriginal,r=1/this._drawWidth,n=1/this._drawHeight;if(this._cbGetSourceTextureInfo){let{srcTexRect:t,srcWidth:e,srcHeight:a}=this._cbGetSourceTextureInfo(this._contentObject);t||(q_.set(0,0,0,0),t=q_),e||(e=this._drawWidth),a||(a=this._drawHeight),s=t,i=t,r=1/e,n=1/a}else t.IsWebGL()&&(Q_.copy(s),Q_.flipAround(1),s=Q_,K_.copy(i),K_.flipAround(1),i=K_);let a=this._rcTexDest;t.IsWebGL()&&(a=J_,a.copy(this._rcTexDest),a.flipAround(1)),this._DoSetProgramParameters(t,e,s,i,a,r,n),t.IsWebGPU()&&this._isAnyIsSrcTexRotated&&t.SetProgramParameter_IsSrcTexRotated(this._isSourceTextureRotated)}_GetBackTex(t){return this._isAnyShaderBackgroundBlending?t.IsWebGPU()?this._UseCopyTextureBackgroundSampling()?this._backTex:this._destRenderTarget.GetTexture():this._destRenderTarget:null}_DoSetProgramParameters(t,e,s,i,r,n,a){t.SetProgramParameters(this._GetBackTex(t),r,s,i,this._layoutRect,n,a,this._devicePixelRatio,this._layerScale,this._layerAngle,this._time),t.SetProgramCustomParameters(this._GetShaderParameters(e,t))}_Render_FastPath(t,e){const s=this._shaderProgramList[0],i=t.IsDepthEnabled(),r=s.UsesDepth();r&&(t.SetDepthEnabled(!1),t.SetDepthSamplingEnabled(!0),this._rcTexDest.set(0,0,1,1),this._rcTexOriginal.set(0,0,1,1)),t.SetProgram(s),t.SetBlendMode(this._blendMode),t.SetRenderTarget(this._destRenderTarget),t.ResetCullState();let n=0,a=1;if(this._rcTexOriginal.set(0,0,1,1),s.UsesAnySrcRectOrPixelSize()&&this._cbGetSourceTextureInfo){const{srcTexRect:t,srcWidth:e,srcHeight:s}=this._cbGetSourceTextureInfo(this._contentObject);t&&this._rcTexOriginal.copy(t),n=Number.isFinite(e)?1/e:0,a=Number.isFinite(s)?1/s:0}else{const[e,s]=this._manager.GetDrawSize(t);n=1/e,a=1/s}e.layoutRect?this._layoutRect.copy(e.layoutRect):this._layoutRect.set(0,0,0,0),t.SetProgramParameters(this._GetBackTex(t),this._rcTexDest,this._rcTexOriginal,this._rcTexOriginal,this._layoutRect,n,a,this._devicePixelRatio,this._layerScale,this._layerAngle,this._time),t.SetProgramCustomParameters(this._GetShaderParameters(0,t)),t.IsWebGPU()&&this._isAnyIsSrcTexRotated&&t.SetProgramParameter_IsSrcTexRotated(this._isSourceTextureRotated),t.SetBaseZ(0),this._DrawContent(t),r&&(t.SetDepthSamplingEnabled(!1),t.SetDepthEnabled(i))}_UseCopyTextureBackgroundSampling(){return this._useCopyTextureBackgroundSampling}_UseRenderTargetBackgroundSampling(){return!this._useCopyTextureBackgroundSampling}IsAnyShaderBackgroundBlending(){return this._isAnyShaderBackgroundBlending}CanSkipCalculatingDrawSurfaceRect(){return!!this._canUseFastPath&&!this._UseCopyTextureBackgroundSampling()}UseFullSurface(){return this._useFullSurface}GetContentObject(){return this._contentObject}GetContextObject(){return this._contextObject}_GetBlendMode(){return this._blendMode}_UpdateOwnProjection(){return this._updateOwnProjection}DidChangeTransform(){return this._didChangeTransform}_GetDrawSurfaceRect(){return this._drawSurfaceRect}_GetRcTexBounce(){return this._rcTexBounce}_ShouldInvalidateRenderTargets(){return this._invalidateRenderTargets}async DebugLogRenderTargetContents(t,e,s){}}}self.C3.Gfx.EffectChain.Step=class{constructor(t,e,s,i=-1){this._effectChain=t,this._srcTargetId=e,this._destTargetId=s,this._index=i}GetEffectChain(){return this._effectChain}GetSrcTargetId(){return this._srcTargetId}GetDestTargetId(){return this._destTargetId}GetIndex(){return this._index}GetShaderProgram(){return this.GetEffectChain()._GetShaderProgramAt(this.GetIndex())}Run_WebGL(t,e,s){}Run_WebGPU(t,e,s){}};{const sd=self.C3;sd.Gfx.EffectChain.Step.PreDraw=class extends sd.Gfx.EffectChain.Step{constructor(t,e,s,i){super(t,e,s,i)}Run_WebGL(t,e,s){const i=this.GetEffectChain();t.SetAlphaBlend(),t.ResetCullState(),t.SetTextureFillMode(),t.SetRenderTarget(s,i._UpdateOwnProjection()),t.ClearRgba(0,0,0,0),i._DrawContent(t),i._ClampRcTexDest()}Run_WebGPU(t,e,s){const i=this.GetEffectChain();t.SetAlphaBlend(),t.ResetCullState(),t.SetTextureFillMode(),t.SetRenderTarget(s,!1),t.ClearRgba(0,0,0,0),i._DrawContent(t),i._ClampRcTexDest()}}}{const id=self.C3,rd=id.New(id.Rect),nd=id.New(id.Quad);id.Gfx.EffectChain.Step.PostDraw=class extends id.Gfx.EffectChain.Step{constructor(t,e,s,i){super(t,e,s,i)}Run_WebGL(t,e,s){const i=this.GetEffectChain();t.SetTextureFillMode(),t.SetRenderTarget(s),i._SetDeviceTransform(t,!0),t.SetBlendMode(i._GetBlendMode()),t.SetTexture(e.GetTexture()),nd.setFromRect(i._GetDrawSurfaceRect()),rd.copy(i._GetRcTexBounce()),rd.flipAround(1),t.Quad3(nd,rd),i._ShouldInvalidateRenderTargets()&&t.InvalidateRenderTarget(e)}Run_WebGPU(t,e,s){const i=this.GetEffectChain();t.SetTextureFillMode(),t.SetRenderTarget(s,!1),i._IsRenderTargetSameSizeAndOffset(t)?nd.setFromRect(i._GetRcTexBounce()):(t.SetNormalizedCoordsProgramVariant(!1),i._SetDeviceTransform(t,!0),nd.setFromRect(i._GetDrawSurfaceRect())),t.SetBackTexture(null),t.SetBlendMode(i._GetBlendMode()),t.SetTexture(e.GetTexture()),i.UseFullSurface()?t.FullscreenQuad():t.Quad3(nd,i._GetRcTexBounce())}}}{const ad=self.C3;ad.Gfx.EffectChain.Step.FirstBounce=class extends ad.Gfx.EffectChain.Step{constructor(t,e,s,i){super(t,e,s,i)}Run_WebGL(t,e,s){const i=this.GetEffectChain();t.SetRenderTarget(s,i._UpdateOwnProjection()),t.ClearRgba(0,0,0,0),t.SetCopyBlend(),t.SetProgram(this.GetShaderProgram()),i._SetFirstBounceProgramParameters(t,this.GetIndex()),i._DrawContent(t),i._ClampRcTexDest()}Run_WebGPU(t,e,s){const i=this.GetEffectChain();t.SetRenderTarget(s,!1),t.ClearRgba(0,0,0,0),t.SetCopyBlend(),t.SetProgram(this.GetShaderProgram()),i._SetFirstBounceProgramParameters(t,this.GetIndex()),i._DrawContent(t),i._ClampRcTexDest()}}}{const od=self.C3,hd=od.New(od.Rect),ld=od.New(od.Quad);od.Gfx.EffectChain.Step.Bounce=class extends od.Gfx.EffectChain.Step{constructor(t,e,s,i){super(t,e,s,i)}Run_WebGL(t,e,s){const i=this.GetEffectChain();t.SetRenderTarget(s);const r=0===this.GetDestTargetId();r?t.SetBlendMode(i._GetBlendMode()):(t.ClearRgba(0,0,0,0),t.SetCopyBlend()),t.SetProgram(this.GetShaderProgram()),i._SetProgramParameters(t,this.GetIndex()),t.SetTexture(e.GetTexture()),i._SetDeviceTransform(t,r),ld.setFromRect(i._GetDrawSurfaceRect()),hd.copy(i._GetRcTexBounce()),hd.flipAround(1),t.Quad3(ld,hd),i._ShouldInvalidateRenderTargets()&&t.InvalidateRenderTarget(e)}Run_WebGPU(t,e,s){const i=this.GetEffectChain();t.SetRenderTarget(s,!1),0===this.GetDestTargetId()?(t.SetBlendMode(i._GetBlendMode()),t.SetBackTexture(null),i._IsRenderTargetSameSizeAndOffset(t)?ld.setFromRect(i._GetRcTexBounce()):(t.SetNormalizedCoordsProgramVariant(!1),i._SetDeviceTransform(t,!0),ld.setFromRect(i._GetDrawSurfaceRect()))):(t.ClearRgba(0,0,0,0),t.SetCopyBlend(),ld.setFromRect(i._GetRcTexBounce())),t.SetProgram(this.GetShaderProgram()),i._SetProgramParameters(t,this.GetIndex()),t.SetTexture(e.GetTexture()),i.UseFullSurface()?t.FullscreenQuad():t.Quad3(ld,i._GetRcTexBounce())}}}{let cd=function(t,e){const s=t[0]-e[0];return 0!==s?s:t[1]-e[1]};0;const ud=self.C3,_d=self.C3X;let dd=null;const pd=new Set,fd=[],gd=[];let md=!1,Sd=!1,yd=!1;const Gd=new Set(["vsync","unlimited-tick","unlimited-frame"]);self.IRuntime=class{constructor(t){dd=t,Object.defineProperties(this,{assets:{value:dd.GetAssetManager().GetIAssetManager(),writable:!1},collisions:{value:dd.GetCollisionEngine().GetICollisionEngine(),writable:!1},objects:{value:{},writable:!1},globalVars:{value:{},writable:!1},projectName:{value:dd.GetProjectName(),writable:!1},projectVersion:{value:dd.GetProjectVersion(),writable:!1},projectId:{value:dd.GetAppId(),writable:!1},projectUniqueId:{value:dd.GetProjectUniqueId(),writable:!1},exportDate:{value:new Date(dd.GetExportTimestamp()),writable:!1},storage:{value:new self.IStorage(dd),writable:!1},isInWorker:{value:dd.IsInWorker(),writable:!1},viewportWidth:{value:dd.GetOriginalViewportWidth(),writable:!1},viewportHeight:{value:dd.GetOriginalViewportHeight(),writable:!1},sampling:{value:dd.GetSampling(),writable:!1},platformInfo:{value:new self.IPlatformInfo(t),writable:!1},sdk:{value:new self.ISDKUtils(t),writable:!1}}),dd.UserScriptDispatcher().addEventListener("keydown",t=>{pd.has(t.key)?t.stopPropagation():pd.add(t.key)}),dd.UserScriptDispatcher().addEventListener("keyup",t=>pd.delete(t.key)),dd.Dispatcher().addEventListener("window-blur",()=>pd.clear()),dd.IsInWorker()&&(self.alert=t=>(md||(md=!0,console.warn("[Construct] alert() was called from a Web Worker, because the project 'Use worker' setting is enabled. This method is not normally available in a Web Worker. Construct has implemented the alert for you, but note that other features may be missing in worker mode. You may wish to disable 'Use worker', or use a more convenient function like console.log(). For more information please refer to the scripting section of the manual.")),this.alert(t)))}_InitObjects(t){Object.defineProperties(this.objects,t)}_InitGlobalVars(t){Object.defineProperties(this.globalVars,t)}addEventListener(t,e){dd.UserScriptDispatcher().addEventListener(t,e)}removeEventListener(t,e){dd.UserScriptDispatcher().removeEventListener(t,e)}callFunction(t,...e){_d.RequireString(t);const s=dd.GetEventSheetManager(),i=s.GetFunctionBlockByName(t);if(!i)throw new Error(`cannot find function name '${t}'`);if(!i.IsEnabled())return i.GetDefaultReturnValue();if(e.length<i.GetFunctionParameterCount())throw new Error(`not enough function parameters passed for '${t}' (${e.length} passed, ${i.GetFunctionParameterCount()} expected)`);const r=i.GetEventBlock();let n=r.GetSolModifiersIncludingParents();const a=s.GetCurrentEvent();if(a){n=n.slice(0);const t=new Set(n);for(const e of a.GetSolModifiersIncludingParents())t.has(e)||(n.push(e),t.add(e));for(const e of s.GetDynamicSolModifiersSet())t.has(e)||(n.push(e),t.add(e))}return r.RunAsExpressionOrJSFunctionCall(n,i.IsCopyPicked(),i.GetReturnType(),i.GetDefaultReturnValue(),null,...e)}setReturnValue(t){const e=dd.GetEventStack().GetCurrentExpFuncStackFrame();if(!e)throw new Error("not in a function which returns a value");switch(e.GetFunctionReturnType()){case 1:"number"==typeof t&&e.SetFunctionReturnValue(t);break;case 2:"string"==typeof t&&e.SetFunctionReturnValue(t);break;case 3:"number"!=typeof t&&"string"!=typeof t||e.SetFunctionReturnValue(t)}}signal(t){_d.RequireString(t),dd.GetEventSheetManager().Signal(t)}waitForSignal(t){return _d.RequireString(t),dd.GetEventSheetManager().WaitForSignal(t)}getViewportSize(){return[dd.GetOriginalViewportWidth(),dd.GetOriginalViewportHeight()]}get isSuspended(){return dd.IsSuspended()}get dt(){return dd.GetDt()}get dtRaw(){return dd.GetDtRaw()}get gameTime(){return dd.GetGameTime()}get tickCount(){return dd.GetTickCount()}get wallTime(){return dd.GetWallTime()}get timeScale(){return dd.GetTimeScale()}set timeScale(t){_d.RequireFiniteNumber(t),dd.SetTimeScale(t)}get fps(){return Sd||(console.warn("IRuntime.fps is deprecated. Use IRuntime.framesPerSecond instead."),Sd=!0),dd.GetFramesPerSecond()}get framesPerSecond(){return dd.GetFramesPerSecond()}get ticksPerSecond(){return dd.GetTicksPerSecond()}get cpuUtilisation(){return dd.GetMainThreadTime()}get gpuUtilisation(){return dd.GetGPUUtilisation()}get framerateMode(){return dd.GetFramerateMode()}set framerateMode(t){if(!Gd.has(t))throw new Error("invalid framerate mode");dd._SetFramerateMode(t)}get minDt(){return dd.GetMinDt()}set minDt(t){_d.RequireFiniteNumber(t),dd.SetMinDt(t)}get maxDt(){return dd.GetMaxDt()}set maxDt(t){dd.SetMaxDt(t)}set isPixelRoundingEnabled(t){dd.SetPixelRoundingEnabled(!!t)}get isPixelRoundingEnabled(){return dd.IsPixelRoundingEnabled()}get loadingProgress(){return dd.GetAssetManager().GetLoadProgress()}get imageLoadingProgress(){return dd.GetAssetManager().GetImageLoadProgress()}random(){return dd.Random()}get layout(){const t=dd.GetMainRunningLayout();if(!t)throw new Error("no layout is running - make sure a layout is loaded before accessing");return t.GetILayout()}getLayout(t){const e=dd.GetLayoutManager();let s=null;if("number"!=typeof t&&"string"!=typeof t)throw new TypeError("expected string or number");if(s=e.GetLayout(t),!s)throw new Error("invalid layout");return s.GetILayout()}getAllLayouts(){return dd.GetLayoutManager().GetAllLayouts().map(t=>t.GetILayout())}goToLayout(t){const e=dd.GetLayoutManager();let s=null;if("number"!=typeof t&&"string"!=typeof t)throw new TypeError("expected string or number");if(s=e.GetLayout(t),!s)throw new Error("invalid layout");e.IsPendingChangeMainLayout()||e.ChangeMainLayout(s)}get keyboard(){const t=dd._GetCommonScriptInterfaces().keyboard;if(!t)throw new Error("runtime.keyboard used but Keyboard object missing - add it to your project first");return t}get mouse(){const t=dd._GetCommonScriptInterfaces().mouse;if(!t)throw new Error("runtime.mouse used but Mouse object missing - add it to your project first");return t}get touch(){const t=dd._GetCommonScriptInterfaces().touch;if(!t)throw new Error("runtime.touch used but Touch object missing - add it to your project first");return t}get timelineController(){const t=dd._GetCommonScriptInterfaces().timelineController;if(!t)throw new Error("runtime.timelineController used but Timeline Controller object missing - add it to your project first");return t}get renderer(){return dd.GetCanvasManager().GetIRenderer()}invokeDownload(t,e){_d.RequireString(t),_d.RequireString(e),dd.InvokeDownload(t,e)}getInstanceByUid(t){_d.RequireFiniteNumber(t);const e=dd.GetInstanceByUID(t);return e?e.GetInterfaceClass():null}sortZOrder(t,e){_d.RequireFunction(e);const s=dd.GetCurrentLayout();for(const e of t){const t=dd._UnwrapIWorldInstance(e),s=t.GetWorldInfo();s.IsDestroyed()||(fd.push([s.GetLayer().GetIndex(),s.GetZIndex()]),gd.push(t))}if(0===fd.length)return;fd.sort(cd),gd.sort((t,s)=>e(t.GetInterfaceClass(),s.GetInterfaceClass()));let i=!1;for(let t=0,e=fd.length;t<e;++t){const e=gd[t],r=s.GetLayerByIndex(fd[t][0]),n=fd[t][1],a=r._GetInstances();a[n]!==e&&(a[n]=e,e.GetWorldInfo()._SetLayer(r,!0),r.SetZIndicesChanged(e),i=!0)}i&&dd.UpdateRender(),ud.clearArray(fd),ud.clearArray(gd)}destroyMultiple(t){for(const e of t){const t=dd._UnwrapIWorldInstance(e);dd.DestroyInstance(t)}dd.GetEventSheetManager().IsInEventEngine()||dd.GetLayoutManager().IsEndingLayout()||dd.GetEventSheetManager().IsFlushingBlocked()||dd.FlushPendingInstances()}async createWorker(t,e){yd||(console.warn("IRuntime.createWorker() is deprecated. All modern browsers now support nested workers so this method is no longer needed."),yd=!0);const s=new MessageChannel,i=s.port1,r=s.port2;return await dd.PostComponentMessageToDOMAsync("runtime","script-create-worker",{url:t,opts:e,port2:r},[r]),i}alert(t){return dd.PostComponentMessageToDOMAsync("runtime","alert",{message:t+(dd.IsInWorker()?" [via Web Worker]":"")})}getHTMLLayer(t){return _d.RequireFiniteNumber(t),dd._GetHTMLLayerWrapElement(t)}addLoadPromise(t){dd.AddLoadPromise(t)}async saveCanvasImage(t,e,s){_d.RequireOptionalString(t),_d.RequireOptionalNumber(e),_d.RequireOptionalInstanceOf(s,DOMRect),s||(s=new DOMRect(0,0,0,0));const i=dd.GetCanvasManager();if(!i)return;dd.UpdateRender();const r=await i.SnapshotCanvas(t||"image/png",e,s.x,s.y,s.width,s.height);return await dd.TriggerAsync(ud.Plugins.System.Cnds.OnCanvasSnapshot,null),r}}}{self.C3,self.C3X;let Td=null;self.IAssetManager=class{constructor(t){Td=t,Object.defineProperties(this,{isWebMOpusSupported:{value:!0,writable:!1}})}loadImageAsset(t){const e=self.IImageInfo._Unwrap(t);if(!e)throw new Error("invalid IImageInfo");e.LoadAsset(Td.GetRuntime())}fetchText(t){return Td.FetchText(t)}fetchJson(t){return Td.FetchJson(t)}fetchBlob(t){return Td.FetchBlob(t)}fetchArrayBuffer(t){return Td.FetchArrayBuffer(t)}getProjectFileUrl(t){return Promise.resolve(Td.GetProjectFileUrl(t))}getMediaFileUrl(t){return Td.GetMediaFileUrl(t)}get mediaFolder(){return Td.GetMediaSubfolder()}async decodeWebMOpus(t,e){throw new Error("decodeWebMOpus() is no longer supported - use Web Audio's decodeAudioData() directly as all supported platforms now support WebM Opus")}loadScripts(...t){return Td.LoadScripts(...t)}compileWebAssembly(t){return Td.CompileWebAssembly(t)}loadStyleSheet(t){return Td.LoadStyleSheet(t)}get projectFileList(){return Td.GetExportedFileList()}}}{const Id=self.C3,Cd=self.C3X;let bd=null;self.ICollisionEngine=class{constructor(t){bd=t,Object.defineProperties(this,{runtime:{value:bd.GetRuntime(),writable:!1}})}testOverlap(t,e){const s=bd.GetRuntime(),i=s._UnwrapIWorldInstance(t),r=s._UnwrapIWorldInstance(e);return bd.TestOverlap(i,r)}testOverlapAny(t,e){const s=bd.GetRuntime(),i=s._UnwrapIWorldInstance(t);for(const t of e){const e=s._UnwrapIWorldInstance(t);if(bd.TestOverlap(i,e))return t}return null}testOverlapSolid(t){const e=bd.GetRuntime()._UnwrapIWorldInstance(t),s=bd.TestOverlapSolid(e);return s?s.GetInterfaceClass():null}setCollisionCellSize(t,e){if(Cd.RequireFiniteNumber(t),Cd.RequireFiniteNumber(e),t=Math.floor(t),e=Math.floor(e),t<=0||e<=0)throw new Error("invalid cell size");bd.SetCollisionCellSize(t,e)}getCollisionCellSize(){return bd.GetCollisionCellSize()}getCollisionCandidates(t,e){const s=bd.GetRuntime();let i;i=Array.isArray(t)?t.map(t=>s._UnwrapIObjectClass(t)):[s._UnwrapIObjectClass(t)];const r=Id.Rect.FromObject(e),n=[];return bd.GetObjectClassesCollisionCandidates(null,i,r,n),n.map(t=>t.GetInterfaceClass())}}}{const xd=self.C3;self.C3X;let wd=null;const Md=new Map([["Windows","windows"],["macOS","macos"],["Linux","linux"],["Chrome OS","chrome-os"],["Android","android"],["iOS","ios"]]),Pd=new Map([["Chrome","chrome"],["Chromium","chromium"],["Edge","edge"],["Opera","opera"],["Firefox","firefox"],["Safari","safari"]]),vd=new Map([["Chromium","chromium"],["Gecko","gecko"],["WebKit","webkit"]]);self.IPlatformInfo=class{constructor(t){wd=t,Object.defineProperties(this,{isMobile:{value:xd.Platform.IsMobile,writable:!1},os:{value:Md.get(xd.Platform.OS)||"unknown",writable:!1},osVersion:{value:xd.Platform.OSVersion,writable:!1},browser:{value:Pd.get(xd.Platform.Browser)||"unknown",writable:!1},browserVersion:{value:xd.Platform.BrowserVersion,writable:!1},browserEngine:{value:vd.get(xd.Platform.BrowserEngine)||"unknown",writable:!1}})}get exportType(){let t=wd.GetExportType();return wd.IsWindowsWebView2()?t="windows-webview2":"cordova"===t?t="Android"===xd.Platform.OS?"cordova-android":"cordova-ios":"playable-ad-single-file"!==t&&"playable-ad-zip"!==t||(t="playable-ad"),t}get renderer(){return wd.GetCanvasManager().GetRendererString()}get rendererDetail(){return wd.GetCanvasManager().GetRendererDetailString()}get canvasClientX(){return wd.GetCanvasManager().GetCanvasClientX()}get canvasClientY(){return wd.GetCanvasManager().GetCanvasClientY()}get canvasCssWidth(){return wd.GetCanvasManager().GetCssWidth()}get canvasCssHeight(){return wd.GetCanvasManager().GetCssHeight()}get canvasDeviceWidth(){return wd.GetCanvasManager().GetDeviceWidth()}get canvasDeviceHeight(){return wd.GetCanvasManager().GetDeviceHeight()}get devicePixelRatio(){return wd.GetDevicePixelRatio()}}}{self.C3;const Rd=self.C3X;self.IStorage=class{constructor(t){this._storage=t._GetProjectStorage()}getItem(t){return Rd.RequireString(t),this._storage.getItem(t)}setItem(t,e){return Rd.RequireString(t),this._storage.setItem(t,e)}removeItem(t){return Rd.RequireString(t),this._storage.removeItem(t)}clear(){return this._storage.clear()}keys(){return this._storage.keys()}}}{const Ad=self.C3,Dd=(self.C3X,Ad._GetInternalAPIToken());self.IPlugin=class{#t;constructor(){const t=Ad.AddonManager._GetInitObject2(Dd);this.#t=t,Object.defineProperties(this,{runtime:{value:t.GetRuntime().GetIRuntime(),writable:!1},id:{value:t.GetID(),writable:!1},isSingleGlobal:{value:t.IsSingleGlobal(),writable:!1},isWorldType:{value:t.IsWorldType(),writable:!1},isHTMLElementType:{value:t.IsHTMLElementType(),writable:!1},isRotatable:{value:t.IsRotatable(),writable:!1},hasEffects:{value:t.HasEffects(),writable:!1},is3d:{value:t.Is3D(),writable:!1},supportsHierarchies:{value:t.SupportsSceneGraph(),writable:!1},supportsMesh:{value:t.SupportsMesh(),writable:!1}}),t.GetRuntime()._MapScriptInterface(this,t)}static getByConstructor(t){if(!t)return null;const e=Ad.AddonManager.GetPluginByConstructorFunction(t);return e?e.GetIPlugin():null}getSingleGlobalObjectType(){return this.#t.GetSingleGlobalObjectClass().GetIObjectClass()}getSingleGlobalInstance(){return this.#t.GetSingleGlobalInstance().GetInterfaceClass()}}}{const Ed=globalThis.C3,Fd=globalThis.C3X,Od=Ed._GetInternalAPIToken();globalThis.IObjectClass=class{#t;constructor(){const t=Ed.AddonManager._GetInitObject2(Od);this.#t=t,Object.defineProperties(this,{name:{value:t.GetName(),writable:!1},runtime:{value:t.GetRuntime().GetIRuntime(),writable:!1},plugin:{value:t.GetPlugin().GetIPlugin(),writable:!1}}),t.GetRuntime()._MapScriptInterface(this,t)}addEventListener(t,e){Fd.RequireString(t),Fd.RequireFunction(e),this.#t.UserScriptDispatcher().addEventListener(t,e)}removeEventListener(t,e){Fd.RequireString(t),Fd.RequireFunction(e),this.#t.UserScriptDispatcher().removeEventListener(t,e)}getAllInstances(){return[...this.instances()]}getFirstInstance(){return Ed.first(this.instances())}getPickedInstances(){return[...this.pickedInstances()]}getFirstPickedInstance(){return Ed.first(this.pickedInstances())}getPairedInstance(t){const e=this.#t,s=e.GetRuntime()._UnwrapIInstance(t),i=e.GetPairedInstance(s);return i?i.GetInterfaceClass():null}*instances(){for(const t of this.#t.instancesIncludingPendingCreate())yield t.GetInterfaceClass()}*pickedInstances(){for(const t of this.#t.GetCurrentSol().GetInstances())yield t.GetInterfaceClass()}callCustomAction(t,e,...s){Fd.RequireString(t);const i=this.#t,r=i.GetRuntime(),n=r.GetEventSheetManager(),a=n.GetCustomActionBlockByName(i,t);if(!a)throw new Error(`cannot find '${this.name}' custom action '${t}'`);if(!a.IsEnabled())return null;if(s.length<a.GetFunctionParameterCount())throw new Error(`not enough function parameters passed for '${this.name}' custom action '${t}' (${s.length} passed, ${a.GetFunctionParameterCount()} expected)`);const o=a.GetEventBlock();let h=o.GetSolModifiersIncludingParents();const l=n.GetCurrentEvent();if(l){h=h.slice(0);const t=new Set(h);for(const e of l.GetSolModifiersIncludingParents())t.has(e)||(h.push(e),t.add(e));for(const e of n.GetDynamicSolModifiersSet())t.has(e)||(h.push(e),t.add(e))}if(i.IsFamily()&&a.HasCustomACEOverrides()){const n=new Map,l=[];for(const s of e){const e=r._UnwrapIInstance(s),i=e.GetObjectClass();if(i.HasOwnCustomActionByName(t)){const t=n.get(i);Array.isArray(t)?t.push(e):n.set(i,[e])}else l.push(e)}const c=[];if(l.length>0){const t={pickObjectClass:i,pickInstances:l},e=o.RunAsExpressionOrJSFunctionCall(h,a.IsCopyPicked(),0,null,t,...s);c.push(e)}if(n.size>0)for(const[e,i]of n){const r=e.GetOwnCustomActionByName(t).GetEventBlock(),n=[...new Set([...h,...r.GetSolModifiers()])],o={pickObjectClass:e,pickInstances:i},l=r.RunAsExpressionOrJSFunctionCall(n,a.IsCopyPicked(),0,null,o,...s);c.push(l)}return Promise.all(c)}{const t={pickObjectClass:a.GetObjectClass(),pickInstances:(Array.isArray(e)?e:[...e]).map(t=>r._UnwrapIInstance(t))},i=o.RunAsExpressionOrJSFunctionCall(h,a.IsCopyPicked(),0,null,t,...s);return i instanceof Promise?i:Promise.resolve()}}}}{const Bd=globalThis.C3,Ld=globalThis.C3X,kd=Bd._GetInternalAPIToken();globalThis.IObjectType=class extends globalThis.IObjectClass{#t;constructor(){super();const t=Bd.AddonManager._GetInitObject2(kd);this.#t=t}setInstanceClass(t){Ld.RequireFunction(t);const e=this.#t;if(e.GetInstanceCount()>0)throw new Error("setInstanceClass() called too late, because instances have already been created - call in runOnStartup");e._SetUserScriptInstanceClass(t)}createInstance(t,e,s,i,r){if(Ld.RequireNumber(e),Ld.RequireNumber(s),"number"!=typeof t&&"string"!=typeof t)throw new TypeError("invalid layer parameter");const n=this.#t,a=n.GetRuntime(),o=a.GetMainRunningLayout().GetLayer(t);if(!o)throw new Error("invalid layer");const h=a.CreateInstance(n,o,e,s,i,r);i&&o.SortAndAddInstancesByZIndex(h);const l=a.GetEventSheetManager();return l.BlockFlushingInstances(!0),h._TriggerOnCreatedOnSelfAndRelated(),l.BlockFlushingInstances(!1),l.IsInEventEngine()||a.GetLayoutManager().IsEndingLayout()||a.FlushPendingInstances(),h.GetInterfaceClass()}getAllFamilies(){return this.#t.GetFamilies().map(t=>t.GetIObjectClass())}*families(){for(const t of this.#t.GetFamilies())yield t.GetIObjectClass()}isInFamily(t){return Ld.RequireInstanceOf(t,globalThis.IFamily),t.hasObjectType(this)}}}{const Nd=globalThis.C3,Ud=globalThis.C3X,Wd=globalThis.IObjectType,jd=Nd._GetInternalAPIToken();globalThis.IFamily=class extends globalThis.IObjectClass{#t;constructor(){super();const t=Nd.AddonManager._GetInitObject2(jd);this.#t=t}getAllObjectTypes(){return this.#t.GetFamilyMembers().map(t=>t.GetIObjectClass())}*objectTypes(){for(const t of this.#t.GetFamilyMembers())yield t.GetIObjectClass()}hasObjectType(t){Ud.RequireInstanceOf(t,Wd);const e=this.#t,s=e.GetRuntime()._UnwrapIObjectClass(t);return e.FamilyHasMember(s)}}}{self.C3;const Vd=self.C3X,zd=["above","below","top-sublayer","bottom-sublayer"];self.ILayout=class{#t;constructor(t){this.#t=t;const e=[],s=t.GetEffectList(),i=s.GetAllEffectTypes().length;for(let t=0;t<i;++t)e.push(new self.IEffectInstance(s,t));Object.defineProperties(this,{runtime:{value:t.GetRuntime().GetIRuntime(),writable:!1},name:{value:t.GetName(),writable:!1},index:{value:t.GetIndex(),writable:!1},effects:{value:e,writable:!1}})}addEventListener(t,e){Vd.RequireString(t),Vd.RequireFunction(e),this.#t.UserScriptDispatcher().addEventListener(t,e)}removeEventListener(t,e){Vd.RequireString(t),Vd.RequireFunction(e),this.#t.UserScriptDispatcher().removeEventListener(t,e)}get width(){return this.#t.GetWidth()}set width(t){Vd.RequireFiniteNumber(t),this.#t.SetWidth(t)}get height(){return this.#t.GetHeight()}set height(t){Vd.RequireFiniteNumber(t),this.#t.SetHeight(t)}setSize(t,e){Vd.RequireFiniteNumber(t),Vd.RequireFiniteNumber(e);const s=this.#t;s.SetWidth(t),s.SetHeight(e)}getSize(){const t=this.#t;return[t.GetWidth(),t.GetHeight()]}set scale(t){Vd.RequireFiniteNumber(t),this.#t.SetScale(t)}get scale(){return this.#t.GetScale()}set angle(t){Vd.RequireFiniteNumber(t),this.#t.SetAngle(t)}get angle(){return this.#t.GetAngle()}set scrollX(t){Vd.RequireNumber(t),this.#t.SetScrollX(t)}get scrollX(){return this.#t.GetScrollX()}set scrollY(t){Vd.RequireNumber(t),this.#t.SetScrollY(t)}get scrollY(){return this.#t.GetScrollY()}scrollTo(t,e){Vd.RequireNumber(t),Vd.RequireNumber(e);const s=this.#t;s.SetScrollX(t),s.SetScrollY(e)}getScrollPosition(){const t=this.#t;return[t.GetScrollX(),t.GetScrollY()]}get isUnboundedScrolling(){return this.#t.IsUnboundedScrolling()}getLayer(t){const e=this.#t;let s=null;if("number"!=typeof t&&"string"!=typeof t)throw new TypeError("expected string or number");return s=e.GetLayer(t),s?s.GetILayer():null}getAllLayers(){return this.#t.GetLayers().map(t=>t.GetILayer())}*allLayers(){for(const t of this.#t.allLayers())yield t.GetILayer()}addLayer(t,e,s){const i=this.#t,r=self.ILayer;Vd.RequireString(t),Vd.RequireOptionalInstanceOf(e,r);const n=e?i.GetRuntime()._UnwrapScriptInterface(e):null,a=zd.indexOf(s);if(a<0)throw new Error("invalid location");i.AddLayer(t,n,a)}moveLayer(t,e,s){const i=this.#t,r=i.GetRuntime(),n=self.ILayer;Vd.RequireInstanceOf(t,n);const a=r._UnwrapScriptInterface(t);if(!a)throw new Error("invalid layer");Vd.RequireOptionalInstanceOf(e,n);const o=e?r._UnwrapScriptInterface(e):null,h=zd.indexOf(s);if(h<0)throw new Error("invalid location");i.MoveLayer(a,o,h)}removeLayer(t){const e=this.#t,s=self.ILayer;Vd.RequireInstanceOf(t,s);const i=e.GetRuntime()._UnwrapScriptInterface(t);if(!i)throw new Error("invalid layer");const r=i.GetRuntime();e.RemoveLayer(i),r.GetEventSheetManager().IsInEventEngine()||r.FlushPendingInstances()}removeAllDynamicLayers(){const t=this.#t,e=t.GetRuntime();t.RemoveAllDynamicLayers(),e.GetEventSheetManager().IsInEventEngine()||e.FlushPendingInstances()}setVanishingPoint(t,e){Vd.RequireFiniteNumber(t),Vd.RequireFiniteNumber(e),this.#t.SetVanishingPointXY(t,e)}getVanishingPoint(){return this.#t.GetVanishingPoint()}set projection(t){Vd.RequireString(t);const e=this.#t;if("perspective"===t)e.SetPerspectiveProjection();else{if("orthographic"!==t)throw new Error("invalid projection");e.SetOrthographicProjection()}}get projection(){return this.#t.IsOrthographicProjection()?"orthographic":"perspective"}}}{const Hd=self.C3,Yd=self.C3X,Xd=new Map([["normal",0],["additive",1],["copy",3],["destination-over",4],["source-in",5],["destination-in",6],["source-out",7],["destination-out",8],["source-atop",9],["destination-atop",10],["lighten",11],["darken",12],["multiply",13],["screen",14]]),qd=new Map([...Xd.entries()].map(t=>[t[1],t[0]])),Jd=new Set(["2d","3d"]),Qd=Hd.New(Hd.Color);self.ILayer=class{#t;constructor(t){this.#t=t;const e=[],s=t.GetEffectList(),i=s.GetAllEffectTypes().length;for(let t=0;t<i;++t)e.push(new self.IEffectInstance(s,t));Object.defineProperties(this,{runtime:{value:t.GetRuntime().GetIRuntime(),writable:!1},name:{value:t.GetName(),writable:!1},layout:{value:t.GetLayout().GetILayout(),writable:!1},effects:{value:e,writable:!1}}),t.GetRuntime()._MapScriptInterface(this,t)}addEventListener(t,e){this.#t.UserScriptDispatcher().addEventListener(t,e)}removeEventListener(t,e){this.#t.UserScriptDispatcher().removeEventListener(t,e)}get parentLayer(){const t=this.#t.GetParentLayer();return t?t.GetILayer():null}*parentLayers(){for(const t of this.#t.parentLayers())yield t.GetILayer()}*subLayers(){for(const t of this.#t.GetSubLayers())yield t.GetILayer()}*allSubLayers(){for(const t of this.#t.GetSubLayers())for(const e of t.selfAndAllSubLayers())yield e.GetILayer()}get index(){return this.#t.GetIndex()}get isVisible(){return this.#t._IsVisibleFlagSet()}set isVisible(t){this.#t.SetVisible(t)}get isSelfAndParentsVisible(){return this.#t.IsVisible()}get isInteractive(){return this.#t.IsInteractive()}set isInteractive(t){this.#t.SetInteractive(t)}get isHTMLElementsLayer(){return this.#t.IsHTMLElementsLayer()}set isHTMLElementsLayer(t){this.#t.SetIsHTMLElementsLayer(!!t)}get isSelfAndParentsInteractive(){return this.#t.IsSelfAndParentsInteractive()}get opacity(){return this.#t.GetOpacity()}set opacity(t){t=Hd.clamp(+t,0,1),isNaN(t)||this.#t.SetOpacity(t)}set scale(t){Yd.RequireFiniteNumber(t),this.#t.SetOwnScale(t)}get scale(){return this.#t.GetOwnScale()}set scaleRate(t){Yd.RequireFiniteNumber(t),this.#t.SetScaleRate(t)}get scaleRate(){return this.#t.GetScaleRate()}set angle(t){Yd.RequireFiniteNumber(t),this.#t.SetAngle(t)}get angle(){return this.#t.GetOwnAngle()}set parallaxX(t){Yd.RequireFiniteNumber(t),this.#t.SetParallaxX(t)}get parallaxX(){return this.#t.GetParallaxX()}set parallaxY(t){Yd.RequireFiniteNumber(t),this.#t.SetParallaxY(t)}get parallaxY(){return this.#t.GetParallaxY()}set zElevation(t){Yd.RequireFiniteNumber(t),this.#t.SetZElevation(t)}get zElevation(){return this.#t.GetZElevation()}set renderingMode(t){if(!Jd.has(t))throw TypeError("invalid rendering mode");this.#t.SetRenderAs3D("3d"===t)}get renderingMode(){return this.#t.IsRenderAs3D()?"3d":"2d"}set isTransparent(t){this.#t.SetTransparent(t)}get isTransparent(){return this.#t.IsTransparent()}set isForceOwnTexture(t){this.#t.SetForceOwnTexture(t)}get isForceOwnTexture(){return this.#t.IsForceOwnTexture()}set blendMode(t){Yd.RequireString(t);const e=Xd.get(t);if("number"!=typeof e)throw new Error("invalid blend mode");this.#t.SetBlendMode(e)}get blendMode(){return qd.get(this.#t.GetBlendMode())}set backgroundColor(t){if(Yd.RequireArray(t),t.length<3)throw new Error("expected 3 elements");Qd.setRgb(t[0],t[1],t[2]);const e=this.#t,s=e.GetBackgroundColor();s.equalsIgnoringAlpha(Qd)||(s.copyRgb(Qd),e.GetRuntime().UpdateRender())}get backgroundColor(){const t=this.#t.GetBackgroundColor();return[t.getR(),t.getG(),t.getB()]}set scrollX(t){Yd.RequireNumber(t);const e=this.#t;e.SetOwnScrollPositionEnabled(!0),e.SetScrollX(t)}get scrollX(){return this.#t.GetScrollX()}set scrollY(t){Yd.RequireNumber(t);const e=this.#t;e.SetOwnScrollPositionEnabled(!0),e.SetScrollY(t)}get scrollY(){return this.#t.GetScrollY()}scrollTo(t,e){Yd.RequireNumber(t),Yd.RequireNumber(e);const s=this.#t;s.SetOwnScrollPositionEnabled(!0),s.SetScrollX(t),s.SetScrollY(e)}getScrollPosition(){const t=this.#t;return[t.GetScrollX(),t.GetScrollY()]}restoreScrollPosition(){this.#t.SetOwnScrollPositionEnabled(!1)}getViewport(){return this.#t.GetViewport().toDOMRect()}cssPxToLayer(t,e,s=0){Yd.RequireNumber(t),Yd.RequireNumber(e),Yd.RequireNumber(s);const i=this.#t,r=i.GetRuntime();return i.CanvasCssToLayer(t-r.GetCanvasClientX(),e-r.GetCanvasClientY(),s)}layerToCssPx(t,e,s=0){Yd.RequireNumber(t),Yd.RequireNumber(e),Yd.RequireNumber(s);const i=this.#t,r=i.GetRuntime(),[n,a]=i.LayerToCanvasCss(t,e,s);return[n+r.GetCanvasClientX(),a+r.GetCanvasClientY()]}drawSurfaceToLayer(t,e,s=0){return Yd.RequireNumber(t),Yd.RequireNumber(e),Yd.RequireNumber(s),this.#t.DrawSurfaceToLayer(t,e,s)}layerToDrawSurface(t,e,s=0){return Yd.RequireNumber(t),Yd.RequireNumber(e),Yd.RequireNumber(s),this.#t.LayerToDrawSurface(t,e,s)}get renderScale(){return this.#t.GetRenderScale()}}}{let Kd=function(t){let e=tp.get(t);return e||(e=Zd.New(Zd.Event.Dispatcher),tp.set(t,e),e)};0;const Zd=self.C3,$d=self.C3X,tp=new WeakMap,ep=Zd._GetInternalAPIToken();self.IInstance=class{#t;constructor(){const t=Zd.AddonManager._GetInitObject2(ep);this.#t=t;const e={runtime:{value:t.GetRuntime().GetIRuntime(),writable:!1},objectType:{value:t.GetObjectClass().GetIObjectClass(),writable:!1},plugin:{value:t.GetPlugin().GetIPlugin(),writable:!1}};t._GetInstVarsScriptDescriptor(e),t._GetBehaviorsScriptDescriptor(e),Object.defineProperties(this,e),t.GetRuntime()._MapScriptInterface(this,t)}static _GetInitInst(){return Zd.AddonManager._GetInitObject()}_release(){const t=tp.get(this);t&&(t.Release(),tp.delete(this))}addEventListener(t,e,s){$d.RequireString(t),$d.RequireFunction(e),Kd(this).addEventListener(t,e,s)}removeEventListener(t,e,s){$d.RequireString(t),$d.RequireFunction(e),Kd(this).removeEventListener(t,e,s)}dispatchEvent(t){Kd(this).dispatchEvent(t)}destroy(){const t=this.#t,e=t.GetRuntime();e.DestroyInstance(t),e.GetEventSheetManager().IsInEventEngine()||e.GetLayoutManager().IsEndingLayout()||e.GetEventSheetManager().IsFlushingBlocked()||e.FlushPendingInstances()}getOtherContainerInstances(){const t=this.#t.GetSiblings();return t?t.map(t=>t.GetInterfaceClass()):[]}*otherContainerInstances(){const t=this.#t;if(t.IsInContainer())for(const e of t.siblings())yield e.GetInterfaceClass()}get uid(){return this.#t.GetUID()}get iid(){return this.#t.GetIID()}get templateName(){return this.#t.GetTemplateName()}set timeScale(t){$d.RequireFiniteNumber(t),this.#t.SetTimeScale(t)}get timeScale(){return this.#t.GetActiveTimeScale()}restoreTimeScale(){this.#t.RestoreTimeScale()}get dt(){const t=this.#t;return t.GetRuntime().GetDt(t)}hasTag(t){return $d.RequireString(t),this.#t.HasTag(t)}hasTags(...t){$d.RequireArray(t);const e=new Set(t.map(t=>t.toLowerCase())),s=this.#t.GetLowercaseTagsSet();return e.isSubsetOf(s)}setAllTags(t){t instanceof Set||(t=new Set(t)),this.#t.SetTagsSet(t)}getAllTags(){return new Set(this.#t.GetTagsSet())}signal(t){$d.RequireString(t);const e=this.#t;e.GetRuntime().GetEventSheetManager().InstanceSignal(e,t)}waitForSignal(t){$d.RequireString(t);const e=this.#t;return e.GetRuntime().GetEventSheetManager().WaitForInstanceSignal(e,t)}callCustomAction(t,...e){return this.objectType.callCustomAction(t,[this],...e)}}}{const sp=self.C3,ip=self.C3X,rp=sp._GetInternalAPIToken();self.ISDKInstanceBase=class extends self.IInstance{#t;#e=!1;#s=null;#i=!1;#r=null;#n;#a;constructor(t){super(),this.#t=sp.AddonManager._GetInitObject2(rp),this.#e=!1,this.#s=null,this.#i=!1,this.#r=null,this.#n=t?.domComponentId,this.#a=t?.wrapperComponentId}_release(){this._setTicking(!1),this._setTicking2(!1),super._release()}_getInitProperties(){return sp.AddonManager._GetInitProperties()}_trigger(t){const e=this.#t;e.GetRuntime().Trigger(t,e)}_triggerAsync(t){const e=this.#t;return e.GetRuntime().TriggerAsync(t,e)}_addDOMMessageHandler(t,e){if(ip.RequireString(t),ip.RequireFunction(e),!this.#n)throw new Error("no DOM component id set");this.#t.GetRuntime().AddDOMComponentMessageHandler(this.#n,t,e)}_addDOMMessageHandlers(t){ip.RequireArray(t);for(const[e,s]of t)this._addDOMMessageHandler(e,s)}_postToDOM(t,e){if(ip.RequireString(t),!this.#n)throw new Error("no DOM component id set");this.#t.GetRuntime().PostComponentMessageToDOM(this.#n,t,e)}_postToDOMAsync(t,e){if(ip.RequireString(t),!this.#n)throw new Error("no DOM component id set");return this.#t.GetRuntime().PostComponentMessageToDOMAsync(this.#n,t,e)}_postToDOMMaybeSync(t,e){if(!this.#t.GetRuntime().IsInWorker())return window.c3_runtimeInterface._OnMessageFromRuntime({type:"event",component:this.#n,handler:t,data:e,responseId:null});this._postToDOM(t,e)}_setTicking(t){if(t=!!t,this.#e===t)return;this.#e=t;const e=this.#t.GetRuntime();if(t){if(!this.#s)if(this.#t.GetRuntime().IsDebug()){const t=globalThis.C3Debugger,e=this.plugin;this.#s=()=>{const s=performance.now();this._tick(),t.AddIndividualPluginTickTime(e,performance.now()-s)}}else this.#s=()=>this._tick();e.Dispatcher().addEventListener("tick",this.#s)}else e.Dispatcher().removeEventListener("tick",this.#s)}_isTicking(){return this.#e}_tick(){}_setTicking2(t){if(t=!!t,this.#i===t)return;this.#i=t;const e=this.#t.GetRuntime();if(t){if(!this.#r)if(this.#t.GetRuntime().IsDebug()){const t=globalThis.C3Debugger,e=this.plugin;this.#r=()=>{const s=performance.now();this._tick2(),t.AddIndividualPluginTickTime(e,performance.now()-s)}}else this.#r=()=>this._tick2();e.Dispatcher().addEventListener("tick2",this.#r)}else e.Dispatcher().removeEventListener("tick2",this.#r)}_isTicking2(){return this.#i}_tick2(){}_getDebuggerProperties(){return[]}_saveToJson(){return null}_loadFromJson(t){}_isWrapperExtensionAvailable(){if(!this.#a)throw new Error("no wrapper component id set");return this.#t.GetRuntime().HasWrapperComponentId(this.#a)}_addWrapperExtensionMessageHandler(t,e){if(ip.RequireString(t),ip.RequireFunction(e),!this.#a)throw new Error("no wrapper component id set");this.#t.GetRuntime().AddWrapperExtensionMessageHandler(this.#a,t,e)}_addWrapperMessageHandlers(t){ip.RequireArray(t);for(const[e,s]of t)this._addWrapperExtensionMessageHandler(e,s)}_sendWrapperExtensionMessage(t,e){if(!this.#a)throw new Error("no wrapper component id set");this.runtime.sdk.sendWrapperExtensionMessage(this.#a,t,e)}_sendWrapperExtensionMessageAsync(t,e){if(!this.#a)throw new Error("no wrapper component id set");return this.runtime.sdk.sendWrapperExtensionMessageAsync(this.#a,t,e)}}}{let np=function(t){return class e extends t{#t;#e;constructor(t){super(t);const e=ap.AddonManager._GetInitObject2(_p),s=e.GetWorldInfo();this.#t=e,this.#e=s,up.set(this,e);const i=[],r=s.GetInstanceEffectList();if(r){const t=s.GetObjectClass().GetEffectList().GetAllEffectTypes().length;for(let e=0;e<t;++e)i.push(new self.IEffectInstance(r,e))}const n={effects:{value:i,writable:!1}};Object.defineProperties(this,n)}get layout(){return this.#e.GetLayout().GetILayout()}get layer(){return this.#e.GetLayer().GetILayer()}get x(){return this.#e.GetX()}set x(t){t=+t;const e=this.#e;isNaN(t)||e.GetX()===t||(e.SetX(t),e.SetBboxChanged())}get y(){return this.#e.GetY()}set y(t){t=+t;const e=this.#e;isNaN(t)||e.GetY()===t||(e.SetY(t),e.SetBboxChanged())}setPosition(t,e){t=+t,e=+e;const s=this.#e;isNaN(t)||isNaN(e)||s.GetX()===t&&s.GetY()===e||(s.SetXY(t,e),s.SetBboxChanged())}getPosition(){const t=this.#e;return[t.GetX(),t.GetY()]}offsetPosition(t,e){if(t=+t,e=+e,isNaN(t)||isNaN(e)||0===t&&0===e)return;const s=this.#e;s.OffsetXY(t,e),s.SetBboxChanged()}set originX(t){t=+t;const e=this.#e;isNaN(t)||e.GetOriginX()===t||(e.SetOriginX(t),e.SetBboxChanged())}get originX(){return this.#e.GetOriginX()}set originY(t){t=+t;const e=this.#e;isNaN(t)||e.GetOriginY()===t||(e.SetOriginY(t),e.SetBboxChanged())}get originY(){return this.#e.GetOriginY()}setOrigin(t,e){t=+t,e=+e;const s=this.#e;isNaN(t)||isNaN(e)||s.GetOriginX()===t&&s.GetOriginY()===e||(s.SetOriginX(t),s.SetOriginY(e),s.SetBboxChanged())}getOrigin(){const t=this.#e;return[t.GetOriginX(),t.GetOriginY()]}get zElevation(){return this.#e.GetZElevation()}set zElevation(t){t=+t;const e=this.#t,s=this.#e;isNaN(t)||s.GetZElevation()===t||(s.SetZElevation(t),e.GetRuntime().UpdateRender())}get totalZElevation(){return this.#e.GetTotalZElevation()}get width(){return this.#e.GetWidth()}set width(t){t=+t;const e=this.#e;isNaN(t)||e.GetWidth()===t||(e.SetWidth(t),e.SetBboxChanged())}get height(){return this.#e.GetHeight()}set height(t){t=+t;const e=this.#e;isNaN(t)||e.GetHeight()===t||(e.SetHeight(t),e.SetBboxChanged())}setSize(t,e){t=+t,e=+e;const s=this.#e;isNaN(t)||isNaN(e)||s.GetWidth()===t&&s.GetHeight()===e||(s.SetSize(t,e),s.SetBboxChanged())}getSize(){const t=this.#e;return[t.GetWidth(),t.GetHeight()]}get angle(){return this.#e.GetAngle()}set angle(t){t=ap.clampAngle(+t);const e=this.#e;isNaN(t)||e.GetAngle()===t||(e.SetAngle(t),e.SetBboxChanged())}get angleDegrees(){return ap.toDegrees(this.angle)}set angleDegrees(t){this.angle=ap.toRadians(t)}getBoundingBox(t){return t?(this.#e.CalculateBbox(lp,cp,!1),lp.toDOMRect()):this.#e.GetBoundingBox().toDOMRect()}getBoundingQuad(t){return t?(this.#e.CalculateBbox(lp,cp,!1),cp.toDOMQuad()):this.#e.GetBoundingQuad().toDOMQuad()}isOnScreen(){return this.#e.IsInViewport2()}get isVisible(){return this.#e.IsVisible()}set isVisible(t){t=!!t;const e=this.#t,s=this.#e;s.IsVisible()!==t&&(s.SetVisible(t),e.GetRuntime().UpdateRender())}get opacity(){return this.#e.GetOpacity()}set opacity(t){t=ap.clamp(+t,0,1);const e=this.#t,s=this.#e;isNaN(t)||s.GetOpacity()===t||(s.SetOpacity(t),e.GetRuntime().UpdateRender())}set colorRgb(t){if(op.RequireArray(t),t.length<3)throw new Error("expected 3 elements");fp.setRgb(t[0],t[1],t[2]);const e=this.#t,s=this.#e;s.GetUnpremultipliedColor().equalsIgnoringAlpha(fp)||(s.SetUnpremultipliedColor(fp),e.GetRuntime().UpdateRender())}get colorRgb(){const t=this.#e.GetUnpremultipliedColor();return[t.getR(),t.getG(),t.getB()]}set blendMode(t){op.RequireString(t);const e=dp.get(t);if("number"!=typeof e)throw new Error("invalid blend mode");const s=this.#t;this.#e.SetBlendMode(e),s.GetRuntime().UpdateRender()}get blendMode(){return pp.get(this.#e.GetBlendMode())}moveToTop(){this.#e.ZOrderMoveToTop()}moveToBottom(){this.#e.ZOrderMoveToBottom()}moveToLayer(t){op.RequireInstanceOf(t,hp);const e=this.#t,s=e.GetRuntime()._UnwrapScriptInterface(t);if(!s)throw new Error("invalid layer");e.GetWorldInfo().ZOrderMoveToLayer(s)}moveAdjacentToInstance(t,s){op.RequireInstanceOf(t,e),this.#e.ZOrderMoveAdjacentToInstance(up.get(t),s)}get zIndex(){return this.#e.GetZIndex()}get isCollisionEnabled(){return this.#e.IsCollisionEnabled()}set isCollisionEnabled(t){this.#e.SetCollisionEnabled(!!t)}containsPoint(t,e){return op.RequireNumber(t),op.RequireNumber(e),this.#e.ContainsPoint(+t,+e)}testOverlap(t){op.RequireInstanceOf(t,e);const s=this.#t,i=up.get(t);return s.GetRuntime().GetCollisionEngine().TestOverlap(s,i)}testOverlapSolid(){const t=this.#t,e=t.GetRuntime().GetCollisionEngine().TestOverlapSolid(t);return e?e.GetInterfaceClass():null}getParent(){const t=this.#t.GetParent();return t?t.GetInterfaceClass():null}getTopParent(){const t=this.#t.GetTopParent();return t?t.GetInterfaceClass():null}*parents(){for(const t of this.#t.parents())yield t.GetInterfaceClass()}getChildCount(){return this.#t.GetChildCount()}getChildAt(t){const e=this.#t.GetChildAt(t);return e?e.GetInterfaceClass():null}*children(){for(const t of this.#t.children())yield t.GetInterfaceClass()}*allChildren(){for(const t of this.#t.allChildren())yield t.GetInterfaceClass()}addChild(t,s){op.RequireInstanceOf(t,e),op.RequireOptionalObject(s),s||(s={});const i=this.#t,r=up.get(t);i.AddChild(r,s)}removeChild(t){op.RequireInstanceOf(t,e);const s=this.#t,i=up.get(t);s.RemoveChild(i)}removeFromParent(){const t=this.#t;t.HasParent()&&t.GetParent().RemoveChild(t)}getHierarchyOpts(){const t=this.#e;return{transformX:t.GetTransformWithParentX(),transformY:t.GetTransformWithParentY(),transformWidth:t.GetTransformWithParentWidth(),transformHeight:t.GetTransformWithParentHeight(),transformAngle:t.GetTransformWithParentAngle(),transformZElevation:t.GetTransformWithParentZElevation(),transformOpacity:t.GetTransformWithParentOpacity(),transformVisibility:t.GetTransformWithParentVisibility(),destroyWithParent:t.GetDestroyWithParent()}}createMesh(t,e){op.RequireFiniteNumber(t),op.RequireFiniteNumber(e),this.#e.CreateMesh(t,e)}releaseMesh(){const t=this.#e;t.ReleaseMesh(),t.SetBboxChanged()}setMeshPoint(t,e,s){op.RequireFiniteNumber(t),op.RequireFiniteNumber(e),op.RequireObject(s);const i=this.#e;i.SetMeshPoint(t,e,s)&&i.SetBboxChanged()}getMeshPoint(t,e){let s=NaN,i=NaN,r=NaN,n=NaN,a=NaN;const o=this.#e;if(o.HasMesh()){const h=o.GetSourceMesh().GetMeshPointAt(t,e);null!==h&&(s=h.GetX(),i=h.GetY(),r=h.GetZElevation(),n=h.GetU(),a=h.GetV())}return{x:s,y:i,zElevation:r,u:n,v:a}}getMeshSize(){const t=this.#e;if(!t.HasMesh())return[0,0];const e=t.GetSourceMesh();return[e.GetHSize(),e.GetVSize()]}}};0;const ap=self.C3,op=self.C3X,hp=(self.IInstance,self.ILayer),lp=ap.New(ap.Rect),cp=ap.New(ap.Quad),up=new WeakMap,_p=ap._GetInternalAPIToken(),dp=new Map([["normal",0],["additive",1],["copy",3],["destination-over",4],["source-in",5],["destination-in",6],["source-out",7],["destination-out",8],["source-atop",9],["destination-atop",10],["lighten",11],["darken",12],["multiply",13],["screen",14]]),pp=new Map([...dp.entries()].map(t=>[t[1],t[0]])),fp=ap.New(ap.Color);self.IWorldInstance=np(self.IInstance),self.IWorldInstanceSDKBase=np(self.ISDKInstanceBase)}{self.C3;const gp=self.C3X;self.IDOMInstance=class extends self.IWorldInstance{#t;constructor(){super(),this.#t=self.IInstance._GetInitInst()}getElement(){return this.#t.GetSdkInstance()._GetElementInDOMMode()}focus(){this.#t.GetSdkInstance().FocusElement()}blur(){this.#t.GetSdkInstance().BlurElement()}setCssStyle(t,e){gp.RequireString(t),this.#t.GetSdkInstance().SetElementCSSStyle(t,e)}}}{let mp=function(t){let e=Gp.get(t);return e||(e=Sp.New(Sp.Event.Dispatcher),Gp.set(t,e),e)};0;const Sp=self.C3,yp=self.C3X,Gp=new WeakMap,Tp=Sp._GetInternalAPIToken();self.IBehaviorInstance=class{#t;constructor(){const t=Sp.AddonManager._GetInitObject2(Tp);this.#t=t;const e={runtime:{value:t.GetRuntime().GetIRuntime(),writable:!1},behavior:{value:t.GetBehavior().GetIBehavior(),writable:!1},behaviorType:{value:t.GetBehaviorType().GetIBehaviorType(),writable:!1}};Object.defineProperties(this,e),t.GetRuntime()._MapScriptInterface(this,t)}static _GetInitInst(){return Sp.AddonManager._GetInitObject()}get instance(){return this.#t.GetObjectInstance().GetInterfaceClass()}_release(){const t=Gp.get(this);t&&(t.Release(),Gp.delete(this))}addEventListener(t,e,s){yp.RequireString(t),yp.RequireFunction(e),mp(this).addEventListener(t,e,s)}removeEventListener(t,e,s){yp.RequireString(t),yp.RequireFunction(e),mp(this).removeEventListener(t,e,s)}dispatchEvent(t){mp(this).dispatchEvent(t)}}}{const Ip=self.C3,Cp=(self.C3X,Ip._GetInternalAPIToken());self.IBehaviorType=class{constructor(){const t=Ip.AddonManager._GetInitObject2(Cp),e={runtime:{value:t.GetRuntime().GetIRuntime(),writable:!1},behavior:{value:t.GetBehavior().GetIBehavior(),writable:!1},name:{value:t.GetName(),writable:!1}};Object.defineProperties(this,e)}}}{const bp=self.C3,xp=(self.C3X,bp._GetInternalAPIToken());self.IBehavior=class{#e;constructor(){const t=bp.AddonManager._GetInitObject2(xp);this.#e=t;const e={runtime:{value:t.GetRuntime().GetIRuntime(),writable:!1},id:{value:t.GetID(),writable:!1}};Object.defineProperties(this,e),t.GetRuntime()._MapScriptInterface(this,t)}getAllInstances(){return this.#e.GetInstances().map(t=>t.GetInterfaceClass())}static getByConstructor(t){if(!t)return null;const e=bp.AddonManager.GetBehaviorByConstructorFunction(t);return e?e.GetIBehavior():null}}}{const wp=self.C3,Mp=self.C3X,Pp=wp.New(wp.Color);self.IEffectInstance=class{#t;constructor(t,e){this.#t=t;const s={index:{value:e,writable:!1}};Object.defineProperties(this,s)}get name(){return this.#t.GetAllEffectTypes()[this.index].GetName()}get isActive(){return this.#t.IsEffectIndexActive(this.index)}set isActive(t){t=!!t;const e=this.#t;e.IsEffectIndexActive(this.index)!==t&&(e.SetEffectIndexActive(this.index,t),e.UpdateActiveEffects(),e.GetRuntime().UpdateRender())}setParameter(t,e){Mp.RequireFiniteNumber(t),t=Math.floor(+t);const s=this.#t,i=s.GetEffectParameter(this.index,t);if(null===i)throw new RangeError("invalid index");if(i instanceof wp.Color){if(!Array.isArray(e)||e.length<3)throw new TypeError("expected array with 3 elements");Pp.setRgb(e[0],e[1],e[2]),e=Pp}else if("number"!=typeof e)throw new TypeError("expected number");s.SetEffectParameter(this.index,t,e)&&s.IsEffectIndexActive(this.index)&&s.GetRuntime().UpdateRender()}getParameter(t){Mp.RequireFiniteNumber(t),t=Math.floor(+t);const e=this.#t.GetEffectParameter(this.index,t);if(null===e)throw new RangeError("invalid index");return e instanceof wp.Color?[e.getR(),e.getG(),e.getB()]:e}}}self.C3,self.C3X;self.IAnimation=class{#t;constructor(t){this.#t=t,Object.defineProperties(this,{name:{value:t.GetName(),writable:!1}})}get speed(){return this.#t.GetSpeed()}get isLooping(){return this.#t.IsLooping()}get repeatCount(){return this.#t.GetRepeatCount()}get repeatTo(){return this.#t.GetRepeatTo()}get isPingPong(){return this.#t.IsPingPong()}get frameCount(){return this.#t.GetFrameCount()}getFrames(){return this.#t.GetFrames().map(t=>t.GetIAnimationFrame())}*frames(){for(const t of this.#t.GetFrames())yield t.GetIAnimationFrame()}};self.C3,self.C3X;self.IImageInfo=class{#e;constructor(t){this.#e=t}static _Unwrap(t){return t.#e}get width(){return this.#e.GetWidth()}get height(){return this.#e.GetHeight()}getSize(){const t=this.#e;return[t.GetWidth(),t.GetHeight()]}getTexture(t){return t.getTextureForImageInfo(this)}getTexRect(){return this.#e.GetTexRect().toDOMRect()}};{self.C3;const vp=self.C3X;self.IAnimationFrame=class extends self.IImageInfo{#e;constructor(t){super(t.GetImageInfo()),this.#e=t,Object.defineProperties(this,{duration:{value:t.GetDuration(),writable:!1},originX:{value:t.GetOriginX(),writable:!1},originY:{value:t.GetOriginY(),writable:!1}})}getOrigin(){const t=this.#e;return[t.GetOriginX(),t.GetOriginY()]}getImagePointCount(){return this.#e.GetImagePointCount()}getImagePointX(t){return this.getImagePoint(t)[0]}getImagePointY(t){return this.getImagePoint(t)[1]}getImagePoint(t){const e=this.#e;let s=null;if("number"==typeof t)s=e.GetImagePointByIndex(Math.floor(t));else{if("string"!=typeof t)throw new TypeError("expected string or number");s=e.GetImagePointByName(t)}return s?[s.GetX(),s.GetY()]:this.getOrigin()}getPolyPointCount(){const t=this.#e.GetCollisionPoly();return t?t.pointCount():0}getPolyPointX(t){return this.getPolyPoint(t)[0]}getPolyPointY(t){return this.getPolyPoint(t)[1]}getPolyPoint(t){vp.RequireFiniteNumber(t),t=Math.floor(t);const e=this.#e.GetCollisionPoly();if(!e||t<0||t>=e.pointCount())return[0,0];const s=e.pointsArr();return[s[2*t],s[2*t+1]]}get tag(){return this.#e.GetTag()}}}{let Rp=function(t){const e=Dp.get(t);if(e.IsReleased())throw new Error("timeline/tween was released and is no longer valid");return e};0;self.C3;const Ap=self.C3X,Dp=new WeakMap;self.ITimelineStateBase=class{constructor(t){Dp.set(this,t),t.GetRuntime()._MapScriptInterface(this,t)}pause(){Rp(this).Stop()}resume(){Rp(this).Resume()}stop(){Rp(this).Reset()}hasTags(t){return Rp(this).HasTags(t)}set time(t){Ap.RequireFiniteNumber(t),Rp(this).SetTime(t)}get time(){return Rp(this).GetTime()}set totalTime(t){Ap.RequireFiniteNumber(t),Rp(this).SetTotalTime(t)}get totalTime(){return Rp(this).GetTotalTime()}set isLooping(t){Rp(this).SetLoop(!!t)}get isLooping(){return Rp(this).GetLoop()}set isPingPong(t){Rp(this).SetPingPong(!!t)}get isPingPong(){return Rp(this).GetPingPong()}set playbackRate(t){Ap.RequireFiniteNumber(t),Rp(this).SetPlaybackRate(t)}get playbackRate(){return Rp(this).GetPlaybackRate()}get progress(){const t=Rp(this);return t.GetTime()/t.GetTotalTime()}get tags(){return Rp(this).GetTags()}get finished(){return Rp(this).GetPlayPromise()}get isPlaying(){return Rp(this).IsPlaying()}get isPaused(){return Rp(this).IsPaused()}get isReleased(){return Dp.get(this).IsReleased()}}}{let Ep=function(t){const e=Fp.get(t);if(e.IsReleased())throw new Error("timeline was released and is no longer valid");return e};0;self.C3,self.C3X;const Fp=new WeakMap;self.ITimelineState=class extends self.ITimelineStateBase{constructor(t){super(t),Fp.set(this,t);const e={name:{value:t.GetName(),writable:!1}};Object.defineProperties(this,e)}}}{let Op=function(t){const e=Lp.get(t);if(e.IsReleased())throw new Error("tween was released and is no longer valid");return e};0;self.C3;const Bp=self.C3X,Lp=new WeakMap,kp=new WeakMap;let Np=null;self.ITweenState=class extends self.ITimelineStateBase{constructor(t,e,s){super(t),Np||(Np=s.easeToIndexFunc),Lp.set(this,t),e&&kp.set(this,e)}stop(){const t=Op(this);kp.get(this).ReleaseTween(t)}setEase(t){Bp.RequireString(t);const e=self.Ease.GetEaseFromIndex(Np(t));Op(this).SetEase(e)}get instance(){const t=Op(this).GetInstance();return t?t.GetInterfaceClass():null}get isDestroyOnComplete(){return Op(this).GetDestroyInstanceOnComplete()}set isDestroyOnComplete(t){Op(this).SetDestroyInstanceOnComplete(!!t)}get finished(){const t=Op(this);return t.GetPlayPromise().then(()=>new Promise(e=>{t.IsComplete()&&e()}))}get released(){return Op(this).GetReleasePromise()}get value(){const t=Op(this);if("value"!==t.GetId())throw new Error("not a value tween");return t.GetPropertyTrack("value").GetSourceAdapterValue()}}}self.C3,self.C3X;self.ISDKPluginBase=class extends self.IPlugin{constructor(){super()}};{const Up=self.C3,Wp=self.C3X,jp=Up._GetInternalAPIToken();self.ISDKDOMPluginBase=class extends self.ISDKPluginBase{#t;#s;#e=0;#n=new Map;constructor(t){if(super(),this.#t=Up.AddonManager._GetInitObject2(jp),!t?.domComponentId)throw new Error("no DOM component ID specified");this.#s=t.domComponentId,this._addElementMessageHandler("elem-focused",t=>t._onElemFocused()),this._addElementMessageHandler("elem-blurred",t=>{t&&t._onElemBlurred()})}_addElement(t){const e=this.#e++;return this.#n.set(e,t),e}_removeElement(t){this.#n.delete(t)}_addElementMessageHandler(t,e){this.#t.GetRuntime().AddDOMComponentMessageHandler(this.#s,t,t=>{const s=this.#n.get(t.elementId);e(s,t)})}_addElementMessageHandlers(t){Wp.RequireArray(t);for(const[e,s]of t)this._addElementMessageHandlers(e,s)}}}{const Vp=self.C3,zp=(self.C3X,Vp._GetInternalAPIToken());self.ISDKObjectTypeBase=class extends self.IObjectType{#t;constructor(){super(),this.#t=Vp.AddonManager._GetInitObject2(zp)}_onCreate(){}getImageInfo(){return this.#t.GetImageInfo().GetIImageInfo()}_loadTextures(t){}_releaseTextures(t){}_onDynamicTextureLoadComplete(){}_preloadTexturesWithInstances(t){}}}{const Hp=self.C3,Yp=(self.C3X,Hp._GetInternalAPIToken());self.ISDKWorldInstanceBase=class extends self.IWorldInstanceSDKBase{#t;#r=null;#e=null;constructor(t){super(t),this.#t=Hp.AddonManager._GetInitObject2(Yp)}_release(){if(super._release(),this.#r){const t=this.#t.GetRuntime().Dispatcher();t.removeEventListener("renderercontextlost",this.#r),t.removeEventListener("renderercontextrestored",this.#e),this.#r=null,this.#e=null}}_handleRendererContextLoss(){if(this.#r)return;this.#r=()=>this._onRendererContextLost(),this.#e=()=>this._onRendererContextRestored();const t=this.#t.GetRuntime().Dispatcher();t.addEventListener("renderercontextlost",this.#r),t.addEventListener("renderercontextrestored",this.#e)}_onRendererContextLost(){}_onRendererContextRestored(){}_draw(t){}_rendersToOwnZPlane(){return!0}_mustPreDraw(){return!1}}}{const Xp=self.C3,qp=(self.C3X,Xp.New(Xp.Rect)),Jp=new WeakMap,Qp=Xp._GetInternalAPIToken();self.ISDKDOMInstanceBase=class extends self.ISDKWorldInstanceBase{#t=-1;#e=!0;#n=!1;#i=!1;#s=-.2;#a=Xp.New(Xp.Rect,0,0,-1,-1);#o=0;#h=0;#l=-1;#c=-1;#u=!1;constructor(t){if(!t?.domComponentId)throw new Error("no DOM component ID specified");super(t);const e=Xp.AddonManager._GetInitObject2(Qp);Jp.set(this,e),this.#t=this.plugin._addElement(this);const s=e.GetRuntime().GetCanvasManager();this.#o=s.GetLastWidth(),this.#h=s.GetLastHeight(),this._setTicking(!0)}_release(){super._release(),this.plugin._removeElement(this.#t),this._postToDOMElement("destroy"),this.#t=-1,Jp.delete(this)}_getElementInDOMMode(){if(Jp.get(this).GetRuntime().IsInWorker())throw new Error("not valid in worker mode");return this._postToDOMElementMaybeSync("get-element")}_postToDOMElement(t,e){e||(e={}),e.elementId=this.#t,this._postToDOM(t,e)}_postToDOMElementMaybeSync(t,e){return e||(e={}),e.elementId=this.#t,this._postToDOMMaybeSync(t,e)}_postToDOMElementAsync(t,e){return e||(e={}),e.elementId=this.#t,this._postToDOMAsync(t,e)}_createElement(t){t||(t={});const e=Jp.get(this).GetWorldInfo();t.elementId=this.#t,t.isVisible=e.IsVisible(),t.htmlIndex=e.GetLayer().GetHTMLIndex(),t.htmlZIndex=e.GetHTMLZIndex(),Object.assign(t,this._getElementState()),this.#e=!!t.isVisible,this._postToDOMMaybeSync("create",t),this._updatePosition(!0)}setElementVisible(t){t=!!t,this.#e!==t&&(this.#e=t,this._postToDOMElement("set-visible",{isVisible:t}))}_tick(){this._updatePosition(!1)}_shouldPreserveElement(){const t=Jp.get(this).GetRuntime().GetCanvasManager().GetFullscreenMode();return"Android"===Xp.Platform.OS&&("scale-inner"===t||"scale-outer"===t||"crop"===t)}_updatePosition(t){const e=Jp.get(this);if(e.IsDestroyed())return;const s=e.GetWorldInfo(),i=s.GetLayer(),r=s.GetBoundingBox();let[n,a]=i.LayerToCanvasCss(r.getLeft(),r.getTop()),[o,h]=i.LayerToCanvasCss(r.getRight(),r.getBottom());const l=e.GetRuntime().GetCanvasManager(),c=l.GetCssWidth(),u=l.GetCssHeight();if(!s.IsVisible()||!i.IsVisible())return void this.setElementVisible(!1);if(!this._shouldPreserveElement()&&(o<=0||h<=0||n>=c||a>=u))return void this.setElementVisible(!1);qp.set(n,a,o,h);const _=l.GetLastWidth(),d=l.GetLastHeight(),p=i.GetHTMLIndex(),f=s.GetHTMLZIndex();if(!t&&qp.equals(this.#a)&&this.#o===_&&this.#h===d&&this.#l===p&&this.#c===f)return void this.setElementVisible(!0);this.#a.copy(qp),this.#o=_,this.#h=d,this.#l=p,this.#c=f,this.setElementVisible(!0);let g=null;this.#i&&(g=i.GetDisplayScale()+this.#s),this._postToDOMElement("update-position",{left:Math.round(this.#a.getLeft()),top:Math.round(this.#a.getTop()),width:Math.round(this.#a.width()),height:Math.round(this.#a.height()),htmlIndex:p,htmlZIndex:f,fontSize:g})}focusElement(){this._postToDOMElementMaybeSync("focus",{focus:!0})}blurElement(){this._postToDOMElementMaybeSync("focus",{focus:!1})}_onElemFocused(){this.#n=!0}_onElemBlurred(){this.#n=!1}isElementFocused(){return this.#n}setElementCSSStyle(t,e){this.postToDOMElement("set-css-style",{prop:Xp.CSSToCamelCase(t),val:e})}setElementAttribute(t,e){this.postToDOMElement("set-attribute",{name:t,val:e})}removeElementAttribute(t){this.postToDOMElement("remove-attribute",{name:t})}_updateElementState(){this.#u||(this.#u=!0,Promise.resolve().then(()=>{this.#u=!1,this._postToDOMElement("update-state",this._getElementState())}))}_getElementState(){}_getElementId(){return this.#t}}}self.C3,self.C3X;self.ISDKBehaviorBase=class extends self.IBehavior{constructor(){super()}};self.C3,self.C3X;self.ISDKBehaviorTypeBase=class extends globalThis.IBehaviorType{constructor(){super()}_onCreate(){}};{const Kp=self.C3,Zp=(self.C3X,new WeakMap),$p=Kp._GetInternalAPIToken();self.ISDKBehaviorInstanceBase=class extends self.IBehaviorInstance{#i=!1;#e=!1;#t=!1;constructor(){super(),Zp.set(this,Kp.AddonManager._GetInitObject2($p))}_release(){super._release(),this._setTicking(!1),this._setTicking2(!1),this._setPostTicking(!1),Zp.delete(this)}_getInitProperties(){return Kp.AddonManager._GetInitProperties()}_postCreate(){}_trigger(t){const e=Zp.get(this);e.GetRuntime().Trigger(t,e.GetObjectInstance(),e.GetBehaviorType())}_triggerAsync(t){const e=Zp.get(this);return e.GetRuntime().TriggerAsync(t,e.GetObjectInstance(),e.GetBehaviorType())}_setTicking(t){if(t=!!t,this.#i===t)return;this.#i=t;const e=Zp.get(this).GetRuntime();t?e._AddBehInstToTick(this):e._RemoveBehInstToTick(this)}_isTicking(){return this.#i}_tick(){}_setTicking2(t){if(t=!!t,this.#e===t)return;this.#e=t;const e=Zp.get(this).GetRuntime();t?e._AddBehInstToTick2(this):e._RemoveBehInstToTick2(this)}_isTicking2(){return this.#e}_tick2(){}_setPostTicking(t){if(t=!!t,this.#t===t)return;this.#t=t;const e=Zp.get(this).GetRuntime();t?e._AddBehInstToPostTick(this):e._RemoveBehInstToPostTick(this)}_isPostTicking(){return this.#t}_postTick(){}_getDebuggerProperties(){return[]}_saveToJson(){return null}_loadFromJson(t){}}}{self.C3;const tf=self.C3X;let ef=null;self.ISDKUtils=class{constructor(t){ef=t,Object.defineProperties(this,{constructVersionCode:{value:ef.GetConstructVersionCode(),writable:!1}})}updateRender(){ef.UpdateRender()}addLoadPromise(t){ef.AddLoadPromise(t)}isWrapperExtensionAvailable(t){return tf.RequireString(t),ef.HasWrapperComponentId(t)}sendWrapperExtensionMessage(t,e,s){tf.RequireString(t),tf.RequireString(e),tf.RequireOptionalArray(s),ef.SendWrapperExtensionMessage(t,e,s)}sendWrapperExtensionMessageAsync(t,e,s){return tf.RequireString(t),tf.RequireString(e),tf.RequireOptionalArray(s),ef.SendWrapperExtensionMessageAsync(t,e,s)}createLoopingConditionContext(t){return tf.RequireOptionalString(t),new self.ILoopingConditionContext(ef,t)}set isAutoSuspendEnabled(t){ef._SetAutoSuspendEnabled(!!t)}get isAutoSuspendEnabled(){return ef._IsAutoSuspendEnabled()}setSuspended(t){ef.SetSuspended(!!t)}getObjectClassBySid(t){tf.RequireNumber(t);const e=ef.GetObjectClassBySID(t);return e?e.GetIObjectClass():null}}}self.C3,self.C3X;self.ILoopingConditionContext=class{#t;#e;#a;#s;#n;#r;constructor(t,e){this.#t=t;const s=t.GetEventSheetManager(),i=t.GetCurrentEvent();this.#e=i,this.#a=i.GetSolModifiers();const r=t.GetEventStack();this.#s=r.GetCurrentStackFrame(),this.#n=r.Push(i);const n=s.GetLoopStack().Push();this.#r=n,e&&n.SetName(e),t.SetDebuggingEnabled(!1)}retrigger(){const t=this.#t.GetEventSheetManager(),e=this.#a,s=this.#r;t.PushCopySol(e),this.#e.Retrigger(this.#s,this.#n),t.PopSol(e),s.SetIndex(s.GetIndex()+1)}get isStopped(){return this.#r.IsStopped()}release(){const t=this.#t,e=t.GetEventStack(),s=t.GetEventSheetManager().GetLoopStack();t.SetDebuggingEnabled(!0),s.Pop(),e.Pop()}};{let sf=function(t){return t instanceof ImageBitmap||"undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement||"undefined"!=typeof OffscreenCanvas&&t instanceof OffscreenCanvas};0;const rf=self.C3,nf=self.C3X;let af=null,of=null;const hf=["none","back","front"],lf=["cw","ccw"];self.IRenderer=class{constructor(t,e){of=t,af=e}setAlphaBlendMode(){af.SetAlphaBlend()}setBlendMode(t){af.SetNamedBlendMode(t)}setColorFillMode(){af.SetColorFillMode()}setTextureFillMode(){af.SetTextureFillMode()}setSmoothLineFillMode(){af.SetSmoothLineFillMode()}setColor(t){af.SetColorRgba(t[0],t[1],t[2],t[3])}setColorRgba(t,e,s,i){af.SetColorRgba(t,e,s,i)}resetColor(){af.ResetColor()}setOpacity(t){af.SetOpacity(t)}setCurrentZ(t){af.SetCurrentZ(t)}getCurrentZ(){return af.GetCurrentZ()}setCullFaceMode(t){const e=hf.indexOf(t);if(-1===e)throw new Error("invalid cull mode");af.SetCullFaceMode(e)}getCullFaceMode(){return hf[af.GetCullFaceMode()]}setFrontFaceWinding(t){const e=lf.indexOf(t);if(-1===e)throw new Error("invalid front face winding");af.SetFrontFaceWinding(e)}getFrontFaceWinding(){return af.GetFrontFaceWinding()}rect(t){af.Rect2(t.left,t.top,t.right,t.bottom)}rect2(t,e,s,i){af.Rect2(t,e,s,i)}quad(t){af.Quad(rf.Quad.fromDOMQuad(t))}quad2(t,e,s,i,r,n,a,o){af.Quad2(t,e,s,i,r,n,a,o)}quad3(t,e){af.Quad3(rf.Quad.fromDOMQuad(t),rf.Rect.fromDOMRect(e))}quad4(t,e){af.Quad4(rf.Quad.fromDOMQuad(t),rf.Quad.fromDOMQuad(e))}quad5(t,e,s){af.Quad5(rf.Quad.fromDOMQuad(t),rf.Quad.fromDOMQuad(e),s)}quad3D(t,e,s,i,r,n,a,o,h,l,c,u,_){af.Quad3D(t,e,s,i,r,n,a,o,h,l,c,u,rf.Rect.fromDOMRect(_))}quad3D2(t,e,s,i,r,n,a,o,h,l,c,u,_){af.Quad3D2(t,e,s,i,r,n,a,o,h,l,c,u,rf.Quad.fromDOMQuad(_))}quad3D3(t,e,s,i,r,n,a,o,h,l,c,u,_,d){af.Quad3D3(t,e,s,i,r,n,a,o,h,l,c,u,rf.Quad.fromDOMQuad(_),d)}drawMesh(t,e,s,i){af.DrawMesh(t,e,s,i)}convexPoly(t){af.ConvexPoly(t)}line(t,e,s,i){af.Line(t,e,s,i)}texturedLine(t,e,s,i,r,n){af.TexturedLine(t,e,s,i,r,n)}lineRect(t,e,s,i){af.LineRect(t,e,s,i)}lineRect2(t){af.LineRect2(rf.Rect.fromDOMRect(t))}lineQuad(t){af.LineQuad(rf.Quad.fromDOMQuad(t))}pushLineWidth(t){af.PushLineWidth(t)}popLineWidth(){af.PopLineWidth()}pushLineCap(t){af.PushLineCap(t)}popLineCap(){af.PopLineCap()}setTexture(t){nf.RequireOptionalInstanceOf(t,self.ITexture);const e=t?of._UnwrapScriptInterface(t):null;af.SetTexture(e)}loadTextureForImageInfo(t,e){const s=self.IImageInfo._Unwrap(t);if(!s)throw new Error("invalid IImageInfo");return s.LoadStaticTexture(af,{wrapX:e?.wrapX??"clamp-to-edge",wrapY:e?.wrapY??"clamp-to-edge",sampling:e?.sampling??"trilinear",mipMap:e?.mipMap??!0})}releaseTextureForImageInfo(t){const e=self.IImageInfo._Unwrap(t);if(!e)throw new Error("invalid IImageInfo");e.ReleaseTexture()}getTextureForImageInfo(t){const e=self.IImageInfo._Unwrap(t);if(!e)throw new Error("invalid IImageInfo");const s=e.GetTexture();return self.ITexture.GetInterface(of,s)}createStaticTexture(t,e){if(!sf(t))throw new TypeError("invalid texture data");const s=af.CreateStaticTexture(t,{wrapX:e?.wrapX??"clamp-to-edge",wrapY:e?.wrapY??"clamp-to-edge",sampling:e?.sampling??"trilinear",mipMap:e?.mipMap??!0});return self.ITexture.GetInterface(of,s)}createDynamicTexture(t,e,s){nf.RequireFiniteNumber(t),nf.RequireFiniteNumber(e);const i=af.CreateDynamicTexture(t,e,{wrapX:s?.wrapX??"clamp-to-edge",wrapY:s?.wrapY??"clamp-to-edge",sampling:s?.sampling??"trilinear",mipMap:s?.mipMap??!0});return self.ITexture.GetInterface(of,i)}updateTexture(t,e,s){nf.RequireInstanceOf(e,self.ITexture);const i=of._UnwrapScriptInterface(e);af.UpdateTexture(t,i,{premultiplyAlpha:s?.premultiplyAlpha??!0})}deleteTexture(t){nf.RequireInstanceOf(t,self.ITexture);const e=of._UnwrapScriptInterface(t);af.DeleteTexture(e)}createRendererText(){const t=af.CreateRendererText();return new self.IRendererText(of,t)}setDeviceTransform(){of.GetCanvasManager().SetDeviceTransform(af)}setLayerTransform(t){nf.RequireInstanceOf(t,globalThis.ILayer),of._UnwrapScriptInterface(t)._SetTransform(af)}}}{self.C3,self.C3X;const cf=new WeakMap,uf=new WeakMap;self.ITexture=class{constructor(t,e){cf.set(this,{runtime:t,texture:e}),uf.set(e,this),t._MapScriptInterface(this,e),Object.defineProperties(this,{width:{value:e.GetWidth(),writable:!1},height:{value:e.GetHeight(),writable:!1}})}static GetInterface(t,e){if(!e)return null;return uf.get(e)||new self.ITexture(t,e)}}}{let _f=function(t){return pf.get(t).rendererText};0;self.C3;const df=self.C3X,pf=new WeakMap;self.IRendererText=class{constructor(t,e){pf.set(this,{runtime:t,rendererText:e}),t._MapScriptInterface(this,e)}release(){_f(this).Release()}set fontFace(t){df.RequireString(t),_f(this).SetFontName(t)}get fontFace(){return _f(this).GetFontName()}set sizePt(t){df.RequireFiniteNumber(t),_f(this).SetFontSize(t)}get sizePt(){return _f(this).GetFontSize()}set lineHeight(t){df.RequireFiniteNumber(t),_f(this).SetLineHeight(t)}get lineHeight(){return _f(this).GetLineHeight()}set isBold(t){_f(this).SetBold(t)}get isBold(){return _f(this).IsBold()}set isItalic(t){_f(this).SetItalic(t)}get isItalic(){return _f(this).IsItalic()}setColor(t){df.RequireArray(t),this.setColorRgb(t[0],t[1],t[2])}setColorRgb(t,e,s){_f(this).SetColorRgb(t,e,s)}setCssColor(t){df.RequireString(t),_f(this).SetColor(t)}set horizontalAlign(t){_f(this).SetHorizontalAlignment(t)}get horizontalAlign(){return _f(this).GetHorizontalAlignment()}set verticalAlign(t){_f(this).SetVerticalAlignment(t)}get verticalAlign(){return _f(this).GetVerticalAlignment()}set wordWrapMode(t){_f(this).SetWordWrapMode(t)}get wordWrapMode(){return _f(this).GetWordWrapMode()}set textDirection(t){_f(this).SetTextDirection(t)}get textDirection(){return _f(this).GetTextDirection()}set text(t){df.RequireString(t),_f(this).SetText(t)}get text(){return _f(this).GetText()}setSize(t,e,s){df.RequireFiniteNumber(t),df.RequireFiniteNumber(e),df.RequireFiniteNumber(s),_f(this).SetSize(t,e,s)}getTexture(){const{runtime:t,rendererText:e}=pf.get(this),s=e.GetTexture();return self.ITexture.GetInterface(t,s)}getTexRect(){return _f(this).GetTexRect().toDOMRect()}setTextureUpdateCallback(t){df.RequireFunction(t),_f(this).ontextureupdate=t}releaseTexture(){_f(this).ReleaseTexture()}get textWidth(){return _f(this).GetTextWidth()}get textHeight(){return _f(this).GetTextHeight()}}}{let ff=function(t){if(!t)return"";const e=t.split(".");if(e.length<2)return"";const s=e.at(-1).toLowerCase();return yf.get(s)||""},gf=function(t){return new Promise((e,s)=>{const i=document.createElement("script");i.onload=e,i.onerror=s,i.async=!1,i.type="module",i.src=t,document.head.appendChild(i)})};0;const mf=self.C3,Sf=new Set(["local","remote"]),yf=new Map([["mp4","video/mp4"],["webm","video/webm"],["m4a","audio/mp4"],["mp3","audio/mpeg"],["js","application/javascript"],["wasm","application/wasm"],["svg","image/svg+xml"],["html","text/html"]]);mf.AssetManager=class extends mf.DefendedBase{constructor(t,e){super();const s=e.exportType;this._runtime=t,this._cordovaBlobUrlCache=new Map,this._isCordova="cordova"===s,this._isiOSCordova=!!e.isiOSCordova,this._swClientId=e.swClientId,this._supportedAudioFormats=e.supportedAudioFormats||{},this._audioFiles=new Map,this._preloadSounds=!1,this._scriptSubfolder=e.scriptFolder,this._mediaSubfolder="",this._fontsSubfolder="",this._iconsSubfolder="",this._fileMap=e.fileMap||new Map,this._fileMapBlobUrls=new Map,this._exportedFileList=[];const i="html5"===s||"scirra-arcade"===s||"instant-games"===s;this._defaultLoadPolicy=i?"remote":"local",this._imageAssetsMap=new Map,this._webFonts=[],this._loadPromises=[],this._hasFinishedInitialLoad=!1,this._totalAssetSizeToLoad=0,this._assetSizeLoaded=0,this._lastLoadProgress=0,this._hasHadErrorLoading=!1,this._loadingRateLimiter=mf.New(mf.RateLimiter,()=>this._FireLoadingProgressEvent(),50),this._localPromiseThrottle=mf.New(mf.PromiseThrottle,Math.max(mf.hardwareConcurrency,8)),this._remotePromiseThrottle=mf.New(mf.PromiseThrottle,20),this._iAssetManager=new self.IAssetManager(this)}Release(){for(const t of this._imageAssetsMap.values())t.Release();this._imageAssetsMap.clear(),mf.clearArray(this._loadPromises),this._runtime=null}GetRuntime(){return this._runtime}GetScriptSubfolder(){return this._scriptSubfolder}_SetMediaSubfolder(t){this._mediaSubfolder=t}GetMediaSubfolder(){return this._mediaSubfolder}_SetFontsSubfolder(t){this._fontsSubfolder=t}GetFontsSubfolder(){return this._fontsSubfolder}_SetIconsSubfolder(t){this._iconsSubfolder=t}GetIconsSubfolder(){return this._iconsSubfolder}_SetExportedFileList(t){this._exportedFileList=t}GetExportedFileList(){return this._exportedFileList}FetchBlob(t,e){return e=e||this._defaultLoadPolicy,mf.IsRelativeURL(t)?"playable-ad-single-file"===this._runtime.GetExportType()?self.c3_runtimeInterface._PlayableAdFetchBlob(t):"local"===e?this._localPromiseThrottle.Add(()=>mf.FetchBlob(t)):this._remotePromiseThrottle.Add(()=>mf.FetchBlob(t)):mf.FetchBlob(t)}FetchArrayBuffer(t){return mf.IsRelativeURL(t)?"playable-ad-single-file"===this._runtime.GetExportType()?mf.BlobToArrayBuffer(self.c3_runtimeInterface._PlayableAdFetchBlob(t)):"local"===this._defaultLoadPolicy?this._localPromiseThrottle.Add(()=>mf.FetchArrayBuffer(t)):this._remotePromiseThrottle.Add(()=>mf.FetchArrayBuffer(t)):mf.FetchArrayBuffer(t)}FetchText(t){return mf.IsRelativeURL(t)?"playable-ad-single-file"===this._runtime.GetExportType()?mf.BlobToString(self.c3_runtimeInterface._PlayableAdFetchBlob(t)):"local"===this._defaultLoadPolicy?this._localPromiseThrottle.Add(()=>mf.FetchText(t)):this._remotePromiseThrottle.Add(()=>mf.FetchText(t)):mf.FetchText(t)}async FetchJson(t){const e=await this.FetchText(t);return JSON.parse(e)}GetMediaFileUrl(t){let e=this._mediaSubfolder+t;return"Gecko"===mf.Platform.BrowserEngine&&"preview"===this._runtime.GetExportType()&&(e=this._GetLocalBlobURLFromFileMap(e)),e}GetProjectFileUrl(t){return"playable-ad-single-file"===this._runtime.GetExportType()&&mf.IsRelativeURL(t)?URL.createObjectURL(self.c3_runtimeInterface._PlayableAdFetchBlob(t)):t}GetProjectFileIframeUrl(t){if(mf.IsAbsoluteURL(t)||"preview"!==this._runtime.GetExportType()||!this._swClientId||!t)return t;try{const e=new URL(t,location.href);return e.searchParams.set("__c3_client_id",this._swClientId),e.toString()}catch(e){return console.warn("Invalid iframe URL: "+t),t}}_GetImageAssetKey(t,e){return(e?"true":"false")+"|"+t}LoadImage(t){const e=!!t.isTiled;if(t.loadPolicy&&!Sf.has(t.loadPolicy))throw new Error("invalid load policy");const s=this._GetImageAssetKey(t.url,e);let i=this._imageAssetsMap.get(s);return i||(i=mf.New(mf.ImageAsset,this,{url:t.url,size:t.size||0,loadPolicy:t.loadPolicy||this._defaultLoadPolicy,isTiled:e}),this._imageAssetsMap.set(s,i),this._hasFinishedInitialLoad||(this._totalAssetSizeToLoad+=i.GetSize(),this._loadPromises.push(i.Load().then(()=>this._AddLoadedSize(i.GetSize())))),i)}_ReleaseImageAsset(t){const e=this._GetImageAssetKey(t.GetURL(),t.IsTiled());this._imageAssetsMap.delete(e)}async WaitForAllToLoad(t){try{await Promise.all(this._loadPromises),this._lastLoadProgress=1,t&&0===this._totalAssetSizeToLoad&&this._FireLoadingProgressEvent()}catch(t){console.error("Error loading: ",t),this._hasHadErrorLoading=!0,this._FireLoadingProgressEvent()}}SetInitialLoadFinished(){this._hasFinishedInitialLoad=!0}HasHadErrorLoading(){return this._hasHadErrorLoading}_AddLoadedSize(t){this._assetSizeLoaded+=t,this._loadingRateLimiter.Call()}_FireLoadingProgressEvent(){const t=mf.New(mf.Event,"loadingprogress");0===this._totalAssetSizeToLoad?this._lastLoadProgress=1:this._lastLoadProgress=mf.clamp(this._assetSizeLoaded/this._totalAssetSizeToLoad,0,1),t.progress=this._lastLoadProgress,this._runtime.Dispatcher().dispatchEvent(t),this._runtime.DispatchUserScriptEvent(mf.New(mf.Event,"loadingprogress"))}GetLoadProgress(){return this._lastLoadProgress}GetImageLoadProgress(){return this._runtime.GetSystemPlugin().GetImageLoadingProgress()}_SetWebFonts(t){mf.shallowAssignArray(this._webFonts,t),this._webFonts.length&&this._loadPromises.push(this._LoadWebFonts())}async _LoadWebFonts(){const t=[],e=[];for(const[s,i,r]of this._webFonts)this._totalAssetSizeToLoad+=r,t.push(this._LoadWebFont(s,i,e).then(()=>this._AddLoadedSize(r)));await Promise.all(t),this._runtime.IsInWorker()&&e.length>0&&await this._runtime.PostComponentMessageToDOMAsync("runtime","load-webfonts",{webfonts:e})}async _LoadWebFont(t,e,s){try{let i=this.GetProjectFileUrl(e);"Gecko"===mf.Platform.BrowserEngine&&(t=`'${t}'`),("Gecko"===mf.Platform.BrowserEngine&&"preview"===this._runtime.GetExportType()||"playable-ad-single-file"===this._runtime.GetExportType())&&(i=this._GetLocalBlobURLFromFileMap(i));const r=new FontFace(t,`url('${i}')`);this._runtime.IsInWorker()?self.fonts.add(r):document.fonts.add(r),await r.load(),this._runtime.IsInWorker()&&s.push({name:t,url:i})}catch(e){console.warn(`[C3 runtime] Failed to load web font '${t}': `,e)}}IsAudioFormatSupported(t){return!!this._supportedAudioFormats[t]}_SetAudioFiles(t,e){this._preloadSounds=!!e;for(const[e,s,i]of t)this._audioFiles.set(e,{fileName:e,formats:s.map(t=>({type:t[0],fileExtension:t[1],fullName:e+t[1],fileSize:t[2]})),isMusic:i})}GetPreferredAudioFile(t){const e=this._audioFiles.get(t);if(!e)return null;let s=null;for(const t of e.formats)if(s||"audio/webm; codecs=opus"!==t.type||(s=t),this.IsAudioFormatSupported(t.type))return t;return s}GetProjectAudioFileUrl(t){const e=this.GetPreferredAudioFile(t);return e?{url:this.GetMediaFileUrl(e.fullName),type:e.type}:null}GetAudioToPreload(){if(this._preloadSounds){const t=[];for(const e of this._audioFiles.values()){if(e.isMusic)continue;const s=this.GetPreferredAudioFile(e.fileName);s&&t.push({originalUrl:e.fileName,url:this.GetMediaFileUrl(s.fullName),type:s.type,fileSize:s.fileSize})}return t}return[]}_GetLocalBlobFromFileMap(t){return"preview"===this._runtime.GetExportType()&&(t=new URL(t,location.href).toString()),this._fileMap.get(t)||null}_GetLocalBlobURLFromFileMap(t){let e=this._fileMapBlobUrls.get(t);if(e)return e;const s=this._GetLocalBlobFromFileMap(t);return s?(e=URL.createObjectURL(s),this._fileMapBlobUrls.set(t,e),e):t}GetIAssetManager(){return this._iAssetManager}async LoadScripts(...t){const e=t.map(t=>this.GetProjectFileUrl(t));if(this._runtime.IsInWorker())if(1===t.length){const e=t[0];await import(new URL(e,location.href).toString())}else{const e=t.map(t=>`import "${new URL(t,location.href).toString()}";`).join("\n"),s=URL.createObjectURL(new Blob([e],{type:"application/javascript"}));await import(s)}else await Promise.all(e.map(t=>gf(t)))}async CompileWebAssembly(t){if(WebAssembly.compileStreaming){const e=this.GetProjectFileUrl(t);return await WebAssembly.compileStreaming(fetch(e))}{const e=await mf.FetchArrayBuffer(t);return await WebAssembly.compile(e)}}async LoadStyleSheet(t){const e=this.GetProjectFileUrl(t);return await this._runtime.PostComponentMessageToDOMAsync("runtime","add-stylesheet",{url:e})}}}{const Gf=self.C3;Gf.Asset=class extends Gf.DefendedBase{constructor(t,e){super(),this._assetManager=t,this._runtime=t.GetRuntime(),this._url=e.url||"",this._size=e.size,this._loadPolicy=e.loadPolicy,this._blob=e.blob||null,this._isLoaded=!!this._blob,this._loadPromise=null}Release(){this._loadPromise=null,this._assetManager=null,this._runtime=null,this._blob=null}GetURL(){return this._url}GetSize(){return this._size}Load(){return"local"===this._loadPolicy||this._blob?(this._isLoaded=!0,Promise.resolve()):(this._loadPromise||(this._loadPromise=this._assetManager.FetchBlob(this._url,this._loadPolicy).then(t=>(this._isLoaded=!0,this._loadPromise=null,this._blob=t,t)).catch(t=>{console.error("Error loading resource: ",t),this._loadPromise=null})),this._loadPromise)}IsLoaded(){return this._isLoaded}GetBlob(){return this._blob?Promise.resolve(this._blob):this._loadPromise?this._loadPromise:this._assetManager.FetchBlob(this._url,this._loadPolicy)}}}{const Tf=self.C3,If=new Tf.PromiseThrottle,Cf=new Set;Tf.ImageAsset=class extends Tf.Asset{constructor(t,e){super(t,e),this._texturePromise=null,this._webglTexture=null,this._refCount=0,this._imageWidth=-1,this._imageHeight=-1,this._isTiled=!!e.isTiled,Cf.add(this)}Release(){if(0!==this._refCount)throw new Error("released image asset which still has references");this._assetManager._ReleaseImageAsset(this),this._texturePromise=null,Cf.delete(this),super.Release()}static OnRendererContextLost(){for(const t of Cf)t._texturePromise=null,t._webglTexture=null,t._refCount=0}LoadStaticTexture(t,e){return e=e||{},this._refCount++,this._webglTexture?Promise.resolve(this._webglTexture):(this._texturePromise||(e.anisotropy=this._runtime.GetCanvasManager().GetTextureAnisotropy(),this._texturePromise=this._DoLoadStaticTexture(t,e)),this._texturePromise)}async _DoLoadStaticTexture(t,e){try{const s=await this.GetBlob();return 0===this._refCount?(this._texturePromise=null,null):await If.Add(async()=>{const i=await t.CreateStaticTextureAsync(s,e);return this._texturePromise=null,0===this._refCount?(t.DeleteTexture(i),null):(this._webglTexture=i,this._imageWidth=i.GetWidth(),this._imageHeight=i.GetHeight(),this._webglTexture)})}catch(t){throw console.error("Failed to load texture: ",t),t}}ReleaseTexture(){if(this._refCount<=0)throw new Error("texture released too many times");this._refCount--,0===this._refCount&&this._webglTexture&&(this._webglTexture.GetRenderer().DeleteTexture(this._webglTexture),this._webglTexture=null)}IncRefCount(){this._refCount++}GetRefCount(){return this._refCount}DecRefCount(){this._refCount--}GetTexture(){return this._webglTexture}GetWidth(){return this._imageWidth}GetHeight(){return this._imageHeight}IsTiled(){return this._isTiled}async LoadToDrawable(){const t=await this.GetBlob();return Tf.Supports.ImageBitmap?await createImageBitmap(t):await Tf.BlobToImage(t)}}}{let bf=function(t,e){return t.GetWorldInfo()._GetLastCachedZIndex()-e.GetWorldInfo()._GetLastCachedZIndex()};0;const xf=self.C3;self.assert;xf.RenderCell=class extends xf.DefendedBase{constructor(t,e,s){super(),this._grid=t,this._x=e,this._y=s,this._instances=[],this._isSorted=!0,this._pendingRemoval=new Set,this._isAnyPendingRemoval=!1}Release(){xf.clearArray(this._instances),this._pendingRemoval.clear(),this._grid=null}Reset(){xf.clearArray(this._instances),this._isSorted=!0,this._pendingRemoval.clear(),this._isAnyPendingRemoval=!1}SetChanged(){this._isSorted=!1}IsEmpty(){return!this._instances.length||!(this._instances.length>this._pendingRemoval.size)&&(this._FlushPending(),!0)}Insert(t){if(this._pendingRemoval.has(t))return this._pendingRemoval.delete(t),void(0===this._pendingRemoval.size&&(this._isAnyPendingRemoval=!1));this._instances.push(t),this._isSorted=1===this._instances.length}Remove(t){this._pendingRemoval.add(t),this._isAnyPendingRemoval=!0,this._pendingRemoval.size>=50&&this._FlushPending()}_FlushPending(){this._isAnyPendingRemoval&&(this._instances.length!==this._pendingRemoval.size?(xf.arrayRemoveAllInSet(this._instances,this._pendingRemoval),this._pendingRemoval.clear(),this._isAnyPendingRemoval=!1):this.Reset())}_EnsureSorted(){this._isSorted||(this._instances.sort(bf),this._isSorted=!0)}Dump(t){this._FlushPending(),this._EnsureSorted(),this._instances.length&&t.push(this._instances)}}}{const wf=self.C3;wf.RenderGrid=class extends wf.DefendedBase{constructor(t,e){super(),this._cellWidth=t,this._cellHeight=e,this._cells=wf.New(wf.PairMap)}Release(){this._cells.Release(),this._cells=null}GetCell(t,e,s){let i=this._cells.Get(t,e);return i||(s?(i=wf.New(wf.RenderCell,this,t,e),this._cells.Set(t,e,i),i):null)}XToCell(t){return Math.floor(t/this._cellWidth)}YToCell(t){return Math.floor(t/this._cellHeight)}Update(t,e,s){if(e)for(let i=e.getLeft(),r=e.getRight();i<=r;++i)for(let r=e.getTop(),n=e.getBottom();r<=n;++r){if(s&&s.containsPoint(i,r))continue;const e=this.GetCell(i,r,!1);e&&(e.Remove(t),e.IsEmpty()&&this._cells.Delete(i,r))}if(s)for(let i=s.getLeft(),r=s.getRight();i<=r;++i)for(let r=s.getTop(),n=s.getBottom();r<=n;++r)e&&e.containsPoint(i,r)||this.GetCell(i,r,!0).Insert(t)}QueryRange(t,e){let s=this.XToCell(t.getLeft());const i=this.YToCell(t.getTop()),r=this.XToCell(t.getRight()),n=this.YToCell(t.getBottom());for(;s<=r;++s)for(let t=i;t<=n;++t){const i=this.GetCell(s,t,!1);i&&i.Dump(e)}}MarkRangeChanged(t){let e=t.getLeft();const s=t.getTop(),i=t.getRight(),r=t.getBottom();for(;e<=i;++e)for(let t=s;t<=r;++t){const s=this.GetCell(e,t,!1);s&&s.SetChanged()}}}}{let Mf=function(t,e){return t.GetWorldInfo()._GetLastCachedZIndex()-e.GetWorldInfo()._GetLastCachedZIndex()},Pf=function(t,e){return t.GetWorldInfo().GetZElevation()-e.GetWorldInfo().GetZElevation()};0;const vf=self.C3,Rf=(self.assert,new vf.Rect),Af=new vf.Quad,Df=[],Ef=(new vf.Rect,new vf.Rect,self.glMatrix),Ff=Ef.vec3,Of=Ef.vec4,Bf=Ef.mat4,Lf=Bf.create(),kf=Ff.create(),Nf=Of.create(),Uf=Ff.create(),Wf=Ff.create(),jf=Ff.create(),Vf=vf.New(vf.Vector2),zf=(vf.New(vf.Rect),[]),Hf=[],Yf=[],Xf={name:"",sid:-1,isDynamic:!1,isVisible:!0,isInteractive:!0,isHTMLElementsLayer:!1,backgroundColor:[1,1,1,1],isTransparent:!0,parallax:[1,1],opacity:1,isForceOwnTexture:!1,renderAs3d:!1,useCameraDistanceDrawOrder:!1,useRenderCells:!1,scaleRate:1,blendMode:0,zElevation:0,initialInstancesData:[],effectListData:[],subLayersData:[]},qf=new Map,Jf=t=>{if(!t.instance.GetObjectClass().IsGlobal())return;const e=t.instance.GetUID();qf.has(e)&&(qf.delete(e),qf.size||t.instance.GetRuntime().Dispatcher().removeEventListener("instancedestroy",Jf))};vf.Layer=class extends vf.DefendedBase{constructor(t,e,s){super(),s=Object.assign({},Xf,s),this._layout=t,this._runtime=t.GetRuntime(),this._parentLayer=e,this._name=s.name,this._index=-1,this._isHTMLElementsLayer=!!s.isHTMLElementsLayer,this._htmlIndex=-1,this._sid=s.sid,this._isDynamic=!!s.isDynamic,this._isVisible=!!s.isVisible,this._isInteractive=!!s.isInteractive,this._backgroundColor=vf.New(vf.Color),this._backgroundColor.setFromJSON(s.backgroundColor),this._isTransparent=!!s.isTransparent,this._parallaxX=s.parallax[0],this._parallaxY=s.parallax[1],this._color=vf.New(vf.Color,1,1,1,s.opacity),this._premultipliedColor=vf.New(vf.Color),this._isForceOwnTexture=!!s.isForceOwnTexture,this._renderAs3d=!!s.renderAs3d,this._useCameraDistanceDrawOrder=!!s.useCameraDistanceDrawOrder,this._useRenderCells=!!s.useRenderCells,this._scaleRate=s.scaleRate,this._blendMode=s.blendMode,this._curRenderTarget=null,this._scale=1,this._zElevation=s.zElevation,this._angle=0,this._scrollX=0,this._scrollY=0,this._hasOwnScrollPosition=!1,this._viewport=vf.New(vf.Rect),this._viewportZ0=vf.New(vf.Rect),this._viewport3D=vf.New(vf.Rect),this._isViewportChanged=!0,this._projectionMatrix=Bf.create(),this._isProjectionMatrixChanged=!0,this._modelViewMatrix=Bf.create(),this._isMVMatrixChanged=!0,this._viewFrustum=vf.New(vf.Gfx.ViewFrustum),this._isViewFrustumChanged=!0,this._startupInitialInstances=[],this._initialInstancesData=s.initialInstancesData,this._initialInstances=[],this._createdGlobalUids=[],this._initialUIDsToInstanceData=new Map,this._instances=[],this._zIndicesUpToDate=!1,this._htmlZIndicesUpToDate=!1,this._anyInstanceZElevated=!1;const i=this._runtime.GetCanvasManager();this._effectList=vf.New(vf.EffectList,this,s.effectListData),this._effectChain=vf.New(vf.Gfx.EffectChain,i.GetEffectChainManager(),{drawContent:(t,e)=>{const s=e.GetContentObject(),r=s.GetRenderTarget();t.SetColor(s.GetPremultipliedColor()),t.DrawRenderTarget(r),t.InvalidateRenderTarget(r),i.ReleaseAdditionalRenderTarget(r)},getShaderParameters:t=>this.GetEffectList()._GetEffectChainShaderParametersForIndex(t)}),this._needsRebuildEffectChainSteps=!0,this._wasDefaultColor=!0,this._renderGrid=null,this._lastRenderList=[],this._isRenderListUpToDate=!1,this._lastRenderCells=vf.New(vf.Rect,0,0,-1,-1),this._curRenderCells=vf.New(vf.Rect,0,0,-1,-1),this._iLayer=new self.ILayer(this),this._userScriptDispatcher=vf.New(vf.Event.Dispatcher),this._UpdatePremultipliedColor(),this.UsesRenderCells()&&(this._renderGrid=vf.New(vf.RenderGrid,this._runtime.GetOriginalViewportWidth(),this._runtime.GetOriginalViewportHeight())),this._subLayers=s.subLayersData.map(t=>vf.Layer.CreateFromExportData(this._layout,this,t))}_InitInitialInstances(){for(const t of this._initialInstancesData){const e=this._runtime.GetObjectClassByIndex(t[1]);this._layout._AddInitialObjectClass(e),e.GetDefaultInstanceData()||(e.SetDefaultInstanceData(t),e._SetDefaultLayerIndex(this._index)),this._initialInstances.push(t),this._initialUIDsToInstanceData.set(t[2],t)}vf.shallowAssignArray(this._startupInitialInstances,this._initialInstances),this._initialInstancesData=null}static CreateFromExportData(t,e,s){return vf.New(vf.Layer,t,e,{name:s[0],sid:s[2],isVisible:s[3],isInteractive:s[13],isHTMLElementsLayer:s[19],backgroundColor:s[4].map(t=>t/255),isTransparent:s[5],parallax:[s[6],s[7]],opacity:s[8],isForceOwnTexture:s[9],renderAs3d:s[17],useCameraDistanceDrawOrder:s[18],useRenderCells:s[10],scaleRate:s[11],blendMode:s[12],zElevation:s[16],initialInstancesData:s[14],effectListData:s[15],subLayersData:s[20]})}Release(){for(const t of this._subLayers)t.Release();vf.clearArray(this._subLayers);for(const t of this._instances)this._runtime.DestroyInstance(t);vf.clearArray(this._instances),this._effectList.Release(),this._effectList=null,this._effectChain.Release(),this._effectChain=null,this._iLayer=null,this._parentLayer=null,this._layout=null,this._runtime=null}WasReleased(){return!this._layout}GetInitialInstanceData(t){return this._initialUIDsToInstanceData.get(t)}CreateInitialInstances(t){const e=this._layout.IsFirstVisit(),s=this._initialInstances;let i=0;for(let r=0,n=s.length;r<n;++r){const n=s[r],a=this._runtime.GetObjectClassByIndex(n[1]);let o=!0;if(!a.HasPersistBehavior()||e)if(a.IsGlobal()&&qf.has(n[2]))o=!1;else{const e=this._runtime.CreateInstanceFromData(n,this,!0);t.push(e),a.IsGlobal()&&(qf.size||this._runtime.Dispatcher().addEventListener("instancedestroy",Jf),qf.set(e.GetUID(),e),o=!1,this._createdGlobalUids.push(e.GetUID()))}o&&(s[i]=s[r],++i)}vf.truncateArray(s,i),this._runtime.FlushPendingInstances(),this.SetZIndicesChanged()}_AddInstance(t,e){if(!t.GetPlugin().IsWorldType())throw new Error("instance is not of world type");const s=t.GetWorldInfo();if(s.GetLayer()!==this)throw new Error("instance added to wrong layer");this._instances.push(t),0!==s.GetZElevation()&&(this._anyInstanceZElevated=!0),e&&this.UsesRenderCells()&&t.GetWorldInfo().SetBboxChanged(),this.SetZIndicesChanged(t)}_MaybeAddInstance(t){this._instances.includes(t)||(this._instances.push(t),0!==t.GetWorldInfo().GetZElevation()&&(this._anyInstanceZElevated=!0),this.SetZIndicesChanged(t))}_PrependInstance(t,e){const s=t.GetWorldInfo();if(s.GetLayer()!==this)throw new Error("instance added to wrong layer");this._instances.unshift(t),0!==s.GetZElevation()&&(this._anyInstanceZElevated=!0),this.SetZIndicesChanged(t),e&&this.UsesRenderCells()&&t.GetWorldInfo().SetBboxChanged()}_RemoveInstance(t,e){const s=this._instances.indexOf(t);s<0||(e&&this.UsesRenderCells()&&t.GetWorldInfo()._RemoveFromRenderCells(),this._instances.splice(s,1),this.SetZIndicesChanged(t),this._MaybeResetAnyInstanceZElevatedFlag())}_SetAnyInstanceZElevated(){this._anyInstanceZElevated=!0}_MaybeResetAnyInstanceZElevatedFlag(){0===this._instances.length&&(this._anyInstanceZElevated=!1)}_SortInstancesByLastCachedZIndex(t){if(t){const t=new Set;for(const e of this._instances){const s=e.GetWorldInfo()._GetLastCachedZIndex();s>=0&&t.add(s)}let e=-1;for(const s of this._instances){const i=s.GetWorldInfo();if(!(i._GetLastCachedZIndex()>=0)){for(++e;t.has(e);)++e;i._SetZIndex(e)}}}this._instances.sort(Mf)}_Start(){}_End(){for(const t of this._instances)t.GetObjectClass().IsGlobal()||this._runtime.DestroyInstance(t);this._runtime.FlushPendingInstances(),vf.clearArray(this._instances),this._anyInstanceZElevated=!1,this.SetZIndicesChanged()}RecreateInitialObjects(t,e,s,i,r,n){const a=this._runtime.GetEventSheetManager(),o=this._runtime.GetAllObjectClasses(),h=t.IsFamily(),l=[];for(const c of this._initialInstances){const u=c[0],_=u[0],d=u[1];if(!e.containsPoint(_,d))continue;const p=o[c[1]];if(p!==t){if(!h)continue;if(!t.FamilyHasMember(p))continue}let f=r;if(!f){const t=this._runtime.GetCurrentLayout();this.GetLayout()===t?f=this:(f=t.GetLayerByName(this.GetName()),f||(f=t.GetLayerByIndex(this.GetIndex())))}const g=this._runtime.CreateInstanceFromData(c,f,!1,void 0,void 0,!1,n,void 0,n);n&&f.SortAndAddInstancesByZIndex(g);const m=g.GetWorldInfo();m.OffsetXY(s,i),m.SetBboxChanged(),a.BlockFlushingInstances(!0),g._TriggerOnCreatedOnSelfAndRelated(),a.BlockFlushingInstances(!1),l.push(g)}return l}GetInstanceCount(){return this._instances.length}GetLayout(){return this._layout}GetName(){return this._name}_SetIndex(t){this._index=t}GetIndex(){return this._index}_SetHTMLIndex(t){this._htmlIndex=t}GetHTMLIndex(){return this._htmlIndex}IsHTMLElementsLayer(){return this._isHTMLElementsLayer}SetIsHTMLElementsLayer(t){t=!!t,this._isHTMLElementsLayer!==t&&(this._isHTMLElementsLayer=t,this._layout._ReindexAndUpdateAllLayers(),this._runtime.UpdateRender())}_GetSiblingIndex(){let t=-1;const e=this.GetParentLayer();return t=e?e.GetSubLayers().indexOf(this):this.GetLayout()._GetRootLayers().indexOf(this),t}GetSID(){return this._sid}GetRuntime(){return this._runtime}IsDynamic(){return this._isDynamic}HasAnyDynamicParentLayer(){for(const t of this.parentLayers())if(t.IsDynamic())return!0;return!1}GetDevicePixelRatio(){return this._runtime.GetDevicePixelRatio()}GetEffectList(){return this._effectList}GetEffectChain(){return this._MaybeRebuildEffectChainSteps(),this._effectChain}_MaybeRebuildEffectChainSteps(){const t=this.HasDefaultColor();if(!this._needsRebuildEffectChainSteps&&t===this._wasDefaultColor&&!this._effectChain.NeedsRebuild())return;const e=this.GetEffectList().GetActiveEffectTypes();this._effectChain.BuildSteps(e.map(t=>t.GetShaderProgram()),{indexMap:e.map(t=>t.GetIndex()),forcePreDraw:!t,useFullSurface:!0}),this._needsRebuildEffectChainSteps=!1,this._wasDefaultColor=t}UpdateActiveEffects(){this.GetEffectList().UpdateActiveEffects(),this._needsRebuildEffectChainSteps=!0}UsesRenderCells(){return this._useRenderCells&&!this._useCameraDistanceDrawOrder}GetRenderGrid(){return this._renderGrid}SetRenderListStale(){this._isRenderListUpToDate=!1}IsVisible(){for(const t of this.selfAndParentLayers())if(!t._IsVisibleFlagSet())return!1;return!0}_IsVisibleFlagSet(){return this._isVisible}SetVisible(t){t=!!t,this._isVisible!==t&&(this._isVisible=t,this._runtime.UpdateRender())}SetInteractive(t){this._isInteractive=!!t}IsInteractive(){return this._isInteractive}IsSelfAndParentsInteractive(){for(const t of this.selfAndParentLayers())if(!t.IsInteractive())return!1;return!0}SetOwnScrollPositionEnabled(t){if(t=!!t,this._hasOwnScrollPosition!==t){if(this._hasOwnScrollPosition=t,t){const t=this.GetLayout();this._scrollX=t.GetScrollX(),this._scrollY=t.GetScrollY()}this._SetMVMatrixChanged(),this._runtime.UpdateRender()}}IsOwnScrollPositionEnabled(){return this._hasOwnScrollPosition}SetScrollX(t){const e=this.GetLayout(),s=e.GetScrollLeftBound(),i=e.GetScrollRightBound();t>i&&(t=i),t<s&&(t=s),this._scrollX!==t&&(this._scrollX=t,this.IsOwnScrollPositionEnabled()&&(this._SetMVMatrixChanged(),this._runtime.UpdateRender()))}SetScrollY(t){const e=this.GetLayout(),s=e.GetScrollTopBound(),i=e.GetScrollBottomBound();t>i&&(t=i),t<s&&(t=s),this._scrollY!==t&&(this._scrollY=t,this.IsOwnScrollPositionEnabled()&&(this._SetMVMatrixChanged(),this._runtime.UpdateRender()))}GetScrollX(){return this.IsOwnScrollPositionEnabled()?this._scrollX:this.GetLayout().GetScrollX()}GetScrollY(){return this.IsOwnScrollPositionEnabled()?this._scrollY:this.GetLayout().GetScrollY()}GetViewport(){return this._MaybeUpdateViewport(),this._viewport}_GetViewportZ0(){return this._MaybeUpdateViewport(),this._viewportZ0}GetViewport3D(){return this._MaybeUpdateViewport(),this._viewport3D}_GetVanishingPoint(){return this.GetLayout().GetVanishingPoint()}GetDefaultCameraZ(t){return this._runtime.GetDefaultCameraZ(t)}GetViewportForZ(t,e){const s=this._GetViewportZ0();if(0===t)e.copy(s);else{let i=s.midX(),r=s.midY();const n=this.Get2DScaleFactorToZ(t),a=s.width()/n,o=s.height()/n,[h,l]=this._GetVanishingPoint();if(.5!==h||.5!==l){const e=this.Get2DCameraZ(),s=this._runtime,n=this.GetDefaultCameraZ()/e;let a=(h-.5)*s.GetViewportWidth()/n,o=(l-.5)*s.GetViewportHeight()/n;const c=this.GetAngle();0!==c&&(Vf.set(a,o),Vf.rotate(c),a=Vf.getX(),o=Vf.getY());const u=vf.unlerp(e,0,t);i+=vf.lerp(a,0,u),r+=vf.lerp(o,0,u)}e.set(i-a/2,r-o/2,i+a/2,r+o/2)}}GetOpacity(){return this._color.getA()}SetOpacity(t){t=vf.clamp(t,0,1),this._color.getA()!==t&&(this._color.setA(t),this._UpdatePremultipliedColor(),this._runtime.UpdateRender())}_UpdatePremultipliedColor(){this._premultipliedColor.copy(this._color),this._premultipliedColor.premultiply()}GetPremultipliedColor(){return this._premultipliedColor}HasDefaultColor(){return this._color.equalsRgba(1,1,1,1)}GetScaleRate(){return this._scaleRate}SetScaleRate(t){this._scaleRate!==t&&(this._scaleRate=t,this._SetMVMatrixChanged(),this._runtime.UpdateRender())}GetParallaxX(){return this._parallaxX}GetParallaxY(){return this._parallaxY}SetParallax(t,e){this._parallaxX===t&&this._parallaxY===e||(this._parallaxX=t,this._parallaxY=e,this._SetMVMatrixChanged(),this._runtime.UpdateRender())}SetParallaxX(t){this.SetParallax(t,this.GetParallaxY())}SetParallaxY(t){this.SetParallax(this.GetParallaxX(),t)}SetZElevation(t){this._zElevation!==t&&(this._zElevation=t,this._runtime.UpdateRender())}GetZElevation(){return this._zElevation}SetAngle(t){t=vf.clampAngle(t),this._angle!==t&&(this._angle=t,this._SetMVMatrixChanged(),this._runtime.UpdateRender())}GetAngle(){return vf.clampAngle(this._layout.GetAngle()+this._angle)}GetOwnAngle(){return this._angle}HasInstances(){return this._instances.length>0}_GetInstances(){return this._instances}_GetInstancesInDrawOrder(){return this.RendersIn3DMode()&&this._useCameraDistanceDrawOrder?(vf.shallowAssignArray(Yf,this._GetInstances()),Yf.sort((t,e)=>this._SortInstancesByCameraDistance(t,e)),Yf):this._GetInstances()}_AppendAllInstancesIncludingSubLayersInDrawOrder(t){vf.appendArray(t,this._GetInstancesInDrawOrder());for(const e of this._subLayers)e.IsVisible()&&e.GetOpacity()>0&&e._AppendAllInstancesIncludingSubLayersInDrawOrder(t)}_SortInstancesByCameraDistance(t,e){const s=this.GetLayout().Get3DCameraPosition(),i=s[0],r=s[1],n=s[2],a=t.GetWorldInfo(),o=e.GetWorldInfo(),h=a.GetX()-i,l=a.GetY()-r,c=a.GetZElevation()-n,u=o.GetX()-i,_=o.GetY()-r,d=o.GetZElevation()-n;return u*u+_*_+d*d-(h*h+l*l+c*c)}GetBackgroundColor(){return this._backgroundColor}IsTransparent(){return this._isTransparent}SetTransparent(t){t=!!t,this._isTransparent!==t&&(this._isTransparent=t,this._runtime.UpdateRender())}IsForceOwnTexture(){return this._isForceOwnTexture}SetForceOwnTexture(t){t=!!t,this._isForceOwnTexture!==t&&(this._isForceOwnTexture=t,this._runtime.UpdateRender())}SetRenderAs3D(t){t=!!t,this._renderAs3d!==t&&(this._renderAs3d=t,this._SetMVMatrixChanged(),this._runtime.UpdateRender())}IsRenderAs3D(){return this._renderAs3d}RendersIn2DMode(){return!this.GetRuntime().Uses3DFeatures()||!this._renderAs3d}RendersIn3DMode(){return!this.RendersIn2DMode()}Has3DCamera(){return this.RendersIn3DMode()&&this.GetLayout().Is3DCameraEnabled()}SelfAndAllSubLayersHave3DCamera(){if(!this.Has3DCamera())return!1;for(const t of this._subLayers)if(!t.SelfAndAllSubLayersHave3DCamera())return!1;return!0}SetBlendMode(t){this._blendMode!==t&&(this._blendMode=t,this._runtime.UpdateRender())}GetBlendMode(){return this._blendMode}IsRootLayer(){return!this._parentLayer}GetParentLayer(){return this._parentLayer}_SetParentLayer(t){this._parentLayer=t}GetSubLayers(){return this._subLayers}HasAnySubLayers(){return this._subLayers.length>0}_AddSubLayer(t,e=!0){e?this._subLayers.push(t):this._subLayers.unshift(t)}_InsertSubLayer(t,e,s){let i=this._subLayers.indexOf(e);if(-1===i)throw new Error("cannot find layer to insert by");s&&++i,this._subLayers.splice(i,0,t)}_RemoveSubLayer(t){const e=this._subLayers.indexOf(t);if(-1===e)throw new Error("cannot find layer to remove");this._subLayers.splice(e,1)}HasAnyVisibleSubLayer(){for(const t of this._subLayers)if(t.ShouldDraw())return!0;return!1}*selfAndAllSubLayers(){for(const t of this._subLayers)yield*t.selfAndAllSubLayers();yield this}*parentLayers(){let t=this.GetParentLayer();for(;t;)yield t,t=t.GetParentLayer()}*selfAndParentLayers(){yield this,yield*this.parentLayers()}HasParentLayer(t){for(const e of this.parentLayers())if(e===t)return!0;return!1}IsTransformCompatibleWith(t){return this===t||this._parallaxX===t._parallaxX&&this._parallaxY===t._parallaxY&&this._scale===t._scale&&this._scaleRate===t._scaleRate&&this._angle===t._angle&&this.GetScrollX()===t.GetScrollX()&&this.GetScrollY()===t.GetScrollY()}SaveTransform(){return{parallaxX:this.GetParallaxX(),parallaxY:this.GetParallaxY(),scale:this.GetOwnScale(),scaleRate:this.GetScaleRate(),angle:this.GetOwnAngle(),hasOwnScroll:this.IsOwnScrollPositionEnabled(),scrollX:this.GetScrollX(),scrollY:this.GetScrollY()}}RestoreTransform(t){this.SetParallax(t.parallaxX,t.parallaxY),this.SetOwnScale(t.scale),this.SetScaleRate(t.scaleRate),this.SetAngle(t.angle),this.SetOwnScrollPositionEnabled(t.hasOwnScroll),this.SetScrollX(t.scrollX),this.SetScrollY(t.scrollY),this._MaybeUpdateViewport()}_RemoveAllInstancesInSet(t){0!==t.size&&vf.arrayRemoveAllInSet(this._instances,t)>0&&(this._MaybeResetAnyInstanceZElevatedFlag(),this.SetZIndicesChanged())}SetZIndicesChanged(t){this._zIndicesUpToDate=!1,this._isRenderListUpToDate=!1,t&&!t.GetObjectClass().GetPlugin().IsHTMLElementType()||(this._htmlZIndicesUpToDate=!1)}_UpdateZIndices(){if(!this._zIndicesUpToDate){if(this._instances.sort(Pf),this.UsesRenderCells())for(let t=0,e=this._instances.length;t<e;++t){const e=this._instances[t].GetWorldInfo();e._SetZIndex(t),this._renderGrid.MarkRangeChanged(e.GetRenderCellRange())}else for(let t=0,e=this._instances.length;t<e;++t)this._instances[t].GetWorldInfo()._SetZIndex(t);this._zIndicesUpToDate=!0}}_UpdateHTMLZIndices(){if(this._htmlZIndicesUpToDate)return;const t=this._layout.GetRootLayersForHTMLLayer(this.GetHTMLIndex()).map(t=>[...t.selfAndAllSubLayers()]).flat();let e=0;for(const s of t){for(const t of s._GetInstances())t.GetObjectClass().GetPlugin().IsHTMLElementType()&&t.GetWorldInfo()._SetHTMLZIndex(e++);s._SetHTMLZIndicesUpToDate()}}_SetHTMLZIndicesUpToDate(){this._htmlZIndicesUpToDate=!0}_GetHTMLLayerDOMState(){return{isVisible:this.IsVisible(),opacity:this.GetOpacity(),isInteractive:this.IsInteractive()}}MoveInstanceAdjacent(t,e,s){const i=t.GetWorldInfo(),r=e.GetWorldInfo();if(i.GetLayer()!==this||r.GetLayer()!==this)throw new Error("can't arrange Z order unless both objects on this layer");const n=i.GetZIndex();let a=r.GetZIndex();return n!==a+(s?1:-1)&&(vf.arrayRemove(this._instances,n),n<a&&a--,s&&a++,a===this._instances.length?this._instances.push(t):this._instances.splice(a,0,t),this.SetZIndicesChanged(t),!0)}_MergeSortedZArrays(t,e){const s=[];let i=0,r=0,n=t.length,a=e.length;for(;i<n&&r<a;){const n=t[i],a=e[r];n.GetWorldInfo()._GetLastCachedZIndex()<a.GetWorldInfo()._GetLastCachedZIndex()?(s.push(n),++i):(s.push(a),++r)}for(;i<n;++i)s.push(t[i]);for(;r<a;++r)s.push(e[r]);return s}_MergeAllSortedZArrays_pass(t){const e=[],s=t.length;for(let i=0;i<s-1;i+=2){const s=t[i],r=t[i+1];e.push(this._MergeSortedZArrays(s,r))}return s%2==1&&e.push(t[s-1]),e}_MergeAllSortedZArrays(t){for(;t.length>1;)t=this._MergeAllSortedZArrays_pass(t);return t[0]}_GetRenderCellInstancesToDraw(){return this._UpdateZIndices(),vf.clearArray(Df),this._renderGrid.QueryRange(this.GetViewport(),Df),Df.length?1===Df.length?Df[0]:this._MergeAllSortedZArrays(Df):[]}ShouldDraw(){return this.IsVisible()&&this.GetOpacity()>0&&this._DrawsAnyContentInSelfOrSubLayers()}_DrawsAnyContentInSelfOrSubLayers(){if(this.HasInstances()||!this.IsTransparent()||this._userScriptDispatcher.HasAnyHandlerFor("beforedraw")||this._userScriptDispatcher.HasAnyHandlerFor("afterdraw"))return!0;for(const t of this._subLayers)if(t._DrawsAnyContentInSelfOrSubLayers())return!0;return!1}UsesOwnTexture(){return this.IsForceOwnTexture()||!this.HasDefaultColor()||0!==this.GetBlendMode()||this._effectList.HasAnyActiveEffect()}SelfOrAnySubLayerUsesOwnTexture(){if(this.UsesOwnTexture())return!0;for(const t of this._subLayers)if(t.SelfOrAnySubLayerUsesOwnTexture())return!0;return!1}GetRenderTarget(){return this._curRenderTarget}Get2DScaleFactorToZ(t){if(this._layout.IsOrthographicProjection())return 1;{const e=this.Get3DCameraZ();return e/(e-t)}}GetResolutionScaleFactorToZ(t){const e=this._runtime.GetRenderScale();if(this._layout.IsOrthographicProjection())return e;{const s=this.Get3DCameraZ();return this.GetDefaultCameraZ()/Math.abs(s-t)*e}}_SetMVMatrixChanged(){this._isMVMatrixChanged=!0,this._isViewFrustumChanged=!0,this._isViewportChanged=!0}_GetModelViewMatrix(t){return this._isMVMatrixChanged&&(this._CalculateModelViewMatrix(t,this._modelViewMatrix,0,0,null),this._isMVMatrixChanged=!1),this._modelViewMatrix}Get2DCameraZ(t){return this.GetDefaultCameraZ(t)/this.GetNormalScale()}Get3DCameraZ(){return this.Has3DCamera()?this.GetLayout().Get3DCameraPosition()[2]:this.Get2DCameraZ()}GetCameraPosition(){if(this.Has3DCamera()){const t=this.GetLayout().Get3DCameraPosition();return[t[0],t[1],t[2]]}return this._Get2DCameraPosition()}_Get2DCameraPosition(t=0,e=0,s=0){const i=this._runtime,r=this.GetLayout(),n=i.GetParallaxXOrigin(),a=i.GetParallaxYOrigin();let o=(this.GetScrollX()-n)*this._parallaxX+n,h=(this.GetScrollY()-a)*this._parallaxY+a;i.IsPixelRoundingEnabled()&&(o=Math.round(o),h=Math.round(h));let l=o+t,c=h+e;const u=r.IsOrthographicProjection()?this.GetDefaultCameraZ(s):this.Get2DCameraZ(s),[_,d]=this._GetVanishingPoint();if(.5!==_||.5!==d){const t=this.GetDefaultCameraZ(s)/u;let e=(_-.5)*i.GetViewportWidth()/t,r=(d-.5)*i.GetViewportHeight()/t;const n=this.GetAngle();0!==n&&(Vf.set(e,r),Vf.rotate(n),e=Vf.getX(),r=Vf.getY()),l+=e,c+=r}return[l,c,u]}_CalculateModelViewMatrix(t,e,s,i,r){const n=this._runtime,a=this.GetLayout();if(this.Has3DCamera()){Ff.copy(Uf,a.Get3DCameraPosition()),Ff.copy(Wf,a.Get3DCameraLookAt()),Ff.copy(jf,a.Get3DCameraUpVector());const t=n.GetParallaxXOrigin(),e=n.GetParallaxYOrigin(),s=Wf[0]-Uf[0],i=Wf[1]-Uf[1],r=Wf[2]-Uf[2];Uf[0]=(Uf[0]-t)*this._parallaxX+t,Uf[1]=(Uf[1]-e)*this._parallaxY+e,Uf[2]*=Math.max(this._parallaxX,this._parallaxY),Wf[0]=Uf[0]+s,Wf[1]=Uf[1]+i,Wf[2]=Uf[2]+r}else{const[t,e,n]=this._Get2DCameraPosition(s,i,r);Ff.set(Uf,t,e,n),Ff.set(Wf,t,e,n-100);const a=this.GetAngle();0===a?Ff.set(jf,0,1,0):Ff.set(jf,Math.sin(a),Math.cos(a),0)}t.CalculateLookAtModelView(e,Uf,Wf,jf,r||n.GetViewportHeight())}_SetProjectionMatrixChanged(){this._isProjectionMatrixChanged=!0,this._isViewFrustumChanged=!0,this._isViewportChanged=!0}_GetProjectionMatrix(t){return this._isProjectionMatrixChanged&&(this._CalculateProjectionMatrix(t),this._isProjectionMatrixChanged=!1),this._projectionMatrix}_CalculateProjectionMatrix(t){const e=this._runtime.GetCanvasManager(),[s,i]=this._GetVanishingPoint();if(this._layout.IsOrthographicProjection())t.CalculateOrthographicMatrix(this._projectionMatrix,e.GetDrawWidth(),e.GetDrawHeight());else if(.5===s&&.5===i)Bf.copy(this._projectionMatrix,e.GetDefaultProjectionMatrix());else{const r=e.GetDrawWidth(),n=e.GetDrawHeight();t.CalculatePerspectiveMatrix(this._projectionMatrix,r/n,s,i)}}_SetTransform(t,e=!0,s=0,i=0,r=0){e&&t.SetProjectionMatrix(this._GetProjectionMatrix(t));let n=null;0===s&&0===i&&0===r?n=this._GetModelViewMatrix(t):(this._CalculateModelViewMatrix(t,Lf,s,i,r),n=Lf),t.SetModelViewMatrix(n)}PrepareForDraw(t){this._SetTransform(t),t.SetBaseZ(this.GetZElevation())}_MaybeStartWebGLProfiling(t){let e=null;if(t.IsWebGL()&&this._runtime.IsGPUProfiling()){const s=this._runtime.GetCanvasManager().GetLayerTimingsBuffer(this);s&&(e=s.AddTimeElapsedQuery(),t.StartQuery(e))}return e}_MaybeStartWebGPUProfiling(t){if(t.IsWebGPU()&&this._runtime.IsGPUProfiling()){const e=2*(this.GetIndex()+1);t.StartMeasuringRenderPassTime(e,e+1)}}_FireDrawEvent(t,e){if(this._userScriptDispatcher.HasAnyHandlerFor(e)){t.SetTextureFillMode(),t.SetTexture(null),t.SetAlphaBlend(),t.ResetCullState(),t.SetColorRgba(1,1,1,1),t.SetBaseZ(this.GetZElevation()),t.SetCurrentZ(0);const s=new vf.Event(e);s.renderer=this._runtime.GetCanvasManager().GetIRenderer(),this.DispatchUserScriptEvent(s)}}Draw(t,e,s){const i=this._runtime.GetCanvasManager(),r=this.UsesOwnTexture();let n=null;const a=this._MaybeStartWebGLProfiling(t);if(this._MaybeStartWebGPUProfiling(t),r){const e={sampling:this._runtime.GetSampling(),isSampled:!0,canReadPixels:!!t.IsWebGPU()&&this._runtime.UsesAnyBackgroundBlending()};"low"===i.GetCurrentFullscreenScalingQuality()&&(e.width=i.GetDrawWidth(),e.height=i.GetDrawHeight()),n=this._runtime.GetAdditionalRenderTarget(e),this._curRenderTarget=n,t.SetRenderTarget(n),this.IsTransparent()&&t.ClearRgba(0,0,0,0)}else this._curRenderTarget=e,t.SetRenderTarget(e);if(this.IsTransparent()||t.Clear(this._backgroundColor),this._layout._DrawLayerList(t,this._curRenderTarget,this._subLayers,r&&this.IsTransparent()),this._MaybeStartWebGPUProfiling(t),this._SetTransform(t),t.SetBaseZ(this.GetZElevation()),t.SetDepthEnabled(this.RendersIn3DMode()),this._FireDrawEvent(t,"beforedraw"),this.GetNormalScale()>Number.EPSILON){this._UpdateZIndices();const e=this.UsesRenderCells()&&0===this.GetZElevation()&&!this._anyInstanceZElevated;this.Has3DCamera()?this._DrawInstances_3DCamera(t):e?this._DrawInstances_RenderCells(t):this._DrawInstances(t,this._GetInstancesInDrawOrder())}this._FireDrawEvent(t,"afterdraw"),t.SetBaseZ(0),t.SetCurrentZ(0),r&&(t.SetDepthEnabled(!1),this._DrawLayerOwnTextureToRenderTarget(t,n,e,s)),a&&t.EndQuery(a),this._curRenderTarget=null}_DrawInstances(t,e){const s=this.GetViewport(),i=this._curRenderTarget,r=this.GetLayout().IsOrthographicProjection(),n=this.GetLayout().HasVanishingPointOutsideViewport();let a=null;for(let o=0,h=e.length;o<h;++o){const h=e[o];if(h===a)continue;a=h;const l=h.GetWorldInfo();l.IsVisible()&&l.IsInViewport(s,n,r)&&this._DrawInstanceMaybeWithEffects(h,l,t,i)}}_DrawInstances_3DCamera(t){const e=this._curRenderTarget,s=this._GetViewFrustum(),i=zf,r=Hf,n=this._GetInstancesInDrawOrder();for(let a=0,o=n.length;a<o;){const h=n[a],l=h.GetWorldInfo();if(!l.IsVisible()||!l.IsInViewport3D(s)){++a;continue}(!h.RendersToOwnZPlane()||l.GetDepth()>0)&&r.push(h);const c=h.GetWorldInfo().GetTotalZElevation();i.push(h);let u=a+1;for(;u<o;++u){const t=n[u],e=t.GetWorldInfo();if(e.IsVisible()&&e.IsInViewport3D(s)){if(e.GetTotalZElevation()!==c)break;t.RendersToOwnZPlane()?(e.GetDepth()>0&&r.push(t),i.push(t)):r.push(t)}}if(1!==i.length||i[0].MustMitigateZFighting()){this._DrawCoplanarInstances_3DCamera(t,i);for(let s=0,i=r.length;s<i;++s){const i=r[s],n=i.GetWorldInfo();n._SetDrawNonBackFacesOnly(!0),this._DrawInstanceMaybeWithEffects(i,n,t,e),n._SetDrawNonBackFacesOnly(!1)}}else{this._DrawInstanceMaybeWithEffects(h,l,t,e);for(let s=0,i=r.length;s<i;++s){const i=r[s];if(i===h)continue;const n=i.GetWorldInfo();n.GetLayer()._DrawInstanceMaybeWithEffects(i,n,t,e)}}a=u,vf.clearArray(i),vf.clearArray(r)}}_DrawCoplanarInstances_3DCamera(t,e){const s=this._curRenderTarget;t.CoplanarStartStencilPass();for(let s=0,i=e.length;s<i;++s){const i=e[s],r=i.GetWorldInfo();r._SetDrawBackFaceOnly(!0),this._DrawInstance(i,r,t)}t.CoplanarStartColorPass();for(let i=0,r=e.length;i<r;++i){const r=e[i],n=r.GetWorldInfo();this._DrawInstanceMaybeWithEffects(r,n,t,s),n._SetDrawBackFaceOnly(!1)}t.CoplanarRestoreStandardRendering()}_DrawInstances_RenderCells(t){const e=this._renderGrid,s=this._curRenderCells,i=this._lastRenderCells,r=this.GetViewport();let n;s.set(e.XToCell(r.getLeft()),e.YToCell(r.getTop()),e.XToCell(r.getRight()),e.YToCell(r.getBottom())),this._isRenderListUpToDate&&s.equals(i)?n=this._lastRenderList:(n=this._GetRenderCellInstancesToDraw(),this._isRenderListUpToDate=!0,i.copy(s)),this._DrawInstances(t,n),n!==this._lastRenderList&&vf.shallowAssignArray(this._lastRenderList,n)}_DrawInstanceMaybeWithEffects(t,e,s,i){e.HasAnyActiveEffect()?this._DrawInstanceWithEffectsAndRestore(t,e,s,i):this._DrawInstance(t,e,s)}_DrawInstance(t,e,s){const i=e.GetRendererStateGroup();s.GetCurrentStateGroup()!==i&&i.Apply(),t.Draw(s)}_DrawInstanceWithEffectsAndRestore(t,e,s,i){this._DrawInstanceWithEffects(t,e,s,i,null)&&this._SetTransform(s)}_DrawInstanceWithEffects(t,e,s,i,r){const n=e.GetInstanceEffectList().GetEffectChain();return n.Render(s,i,{contentObject:t,blendMode:e.GetBlendMode(),devicePixelRatio:this._runtime.GetEffectDevicePixelRatioParam(),time:t.GetInstanceGameTime(),layerScale:this._runtime.GetEffectLayerScaleParam()*this.GetNormalScale(),layerAngle:this.GetAngle(),layoutRect:e.GetBoundingBox(),drawSurfaceRect:n.CanSkipCalculatingDrawSurfaceRect()?null:this._InstanceBoxToDrawSurface(e),drawContentHook:r&&r.drawContentHook,compositOffX:r&&r.compositOffX,compositOffY:r&&r.compositOffY,compositRtWidth:r&&r.compositRtWidth,compositRtHeight:r&&r.compositRtHeight,updateOwnProjection:r&&r.updateOwnProjection}),s.SetBaseZ(this.GetZElevation()),n.DidChangeTransform()}_DrawLayerOwnTextureToRenderTarget(t,e,s,i){const r=this._effectList.GetActiveEffectTypes(),n=this._runtime;0===r.length?(t.SetRenderTarget(s),t.SetTextureFillMode(),i&&0===this._blendMode&&this.HasDefaultColor()?t.CopyRenderTarget(e):(t.SetBlendMode(this._blendMode),t.SetColor(this._premultipliedColor),t.DrawRenderTarget(e)),t.InvalidateRenderTarget(e),n.ReleaseAdditionalRenderTarget(e)):this.GetEffectChain().Render(t,s,{contentObject:this,blendMode:this.GetBlendMode(),devicePixelRatio:n.GetEffectDevicePixelRatioParam(),layerScale:n.GetEffectLayerScaleParam()*this.GetNormalScale(),layerAngle:this.GetAngle(),layoutRect:this.GetViewport(),drawSurfaceRect:null,invalidateRenderTargets:!0})}GetOwnScale(){return this._scale}SetOwnScale(t){this._scale!==t&&(this._scale=t,this._layout.BoundScrolling(),this._SetMVMatrixChanged(),this._runtime.UpdateRender())}GetRenderScale(){return this.GetNormalScale()*this._runtime.GetRenderScale()}GetDisplayScale(){return this.GetNormalScale()*this._runtime.GetDisplayScale()}GetNormalScale(){return(this._scale*this._layout.GetScale()-1)*this._scaleRate+1}_MaybeUpdateViewport(){if(!this._isViewportChanged)return;this._isViewportChanged=!1;const t=this._runtime.GetParallaxXOrigin(),e=this._runtime.GetParallaxYOrigin(),s=(this.GetScrollX()-t)*this._parallaxX+t,i=(this.GetScrollY()-e)*this._parallaxY+e,r=this.GetNormalScale(),n=this._runtime.GetViewportWidth()/r,a=this._runtime.GetViewportHeight()/r;let o=s-n/2,h=i-a/2;this._runtime.IsPixelRoundingEnabled()&&(o=Math.round(o),h=Math.round(h));const l=this._viewportZ0;l.set(o,h,o+n,h+a);const c=this.GetAngle();0!==c&&(Rf.copy(l),Rf.offset(-l.midX(),-l.midY()),Af.setFromRotatedRect(Rf,c),Af.getBoundingBox(Rf),Rf.offset(l.midX(),l.midY()),l.copy(Rf));const u=this._zElevation;this.GetViewportForZ(u,this._viewport),this.Has3DCamera()?this.CalculateViewport3D(u,this._viewport3D):this._viewport3D.copy(this._viewport)}CalculateViewport3D(t,e){const s=this._runtime.GetCanvasManager(),i=s.GetCssWidth(),r=s.GetCssHeight(),[n,a]=this.CanvasCssToLayer(0,0,t),[o,h]=this.CanvasCssToLayer(i,0,t),[l,c]=this.CanvasCssToLayer(i,r,t),[u,_]=this.CanvasCssToLayer(0,r,t);let d=Math.min(n,o,l,u),p=Math.min(a,h,c,_),f=Math.max(n,o,l,u),g=Math.max(a,h,c,_);isFinite(d)||(d=-1/0),isFinite(p)||(p=-1/0),isFinite(f)||(f=1/0),isFinite(g)||(g=1/0),e.set(d,p,f,g)}CanvasCssToLayer(t,e,s=0){return this._CanvasToLayer(t,e,s,this.GetDisplayScale())}DrawSurfaceToLayer(t,e,s=0){return this._CanvasToLayer(t,e,s,this.GetRenderScale()*this.GetDevicePixelRatio())}_CanvasToLayer(t,e,s,i){const r=this._runtime,n=r.GetRenderer(),a=this.GetNormalScale(),o=r.GetViewportWidth()/a,h=r.GetViewportHeight()/a,l=Nf;Of.set(l,0,0,o,h),t/=i,e=l[3]-e/i;const c=this._GetProjectionMatrix(n),u=this._GetModelViewMatrix(n),_=kf;return vf.Gfx.UnprojectScreenToWorldZ(t,e,s,u,c,l,_)?[_[0],_[1]]:[NaN,NaN]}CanvasCssToLayer_DefaultTransform(t,e){const s=this._scale,i=this._scaleRate,r=this._parallaxX,n=this._parallaxY,a=this._angle,o=this.Has3DCamera();o&&this.GetLayout().Set3DCameraEnabled(!1),this._scale=1,this._scaleRate=1,this._parallaxX=1,this._parallaxY=1,this._angle=0,this._SetMVMatrixChanged();const h=this.CanvasCssToLayer(t,e);return this._scale=s,this._scaleRate=i,this._parallaxX=r,this._parallaxY=n,this._angle=a,this._SetMVMatrixChanged(),o&&this.GetLayout().Set3DCameraEnabled(!0),h}LayerToCanvasCss(t,e,s=0){return this._LayerToCanvas(t,e,s,this.GetDisplayScale())}LayerToDrawSurface(t,e,s=0){return this._LayerToCanvas(t,e,s,this.GetRenderScale()*this.GetDevicePixelRatio())}_LayerToCanvas(t,e,s,i){const r=this._runtime,n=r.GetRenderer(),a=this.GetNormalScale(),o=r.GetViewportWidth()/a,h=r.GetViewportHeight()/a,l=Nf;Of.set(l,0,0,o,h);const c=this._GetProjectionMatrix(n),u=this._GetModelViewMatrix(n),_=kf;return vf.Gfx.Project(t,e,s,u,c,l,_)?[_[0]*i,(l[3]-_[1])*i]:[NaN,NaN]}_GetLayerToDrawSurfaceScale(t,e){return t*=this.GetRenderScale()*this.GetDevicePixelRatio(),0!==e&&(t*=this.Get2DScaleFactorToZ(e)),t}_InstanceBoxToDrawSurface(t){const e=t.GetBoundingBox(),s=t.GetTotalZElevation(),i=t.GetDepth(),r=s+i,n=e.getLeft(),a=e.getTop(),o=e.getRight(),h=e.getBottom();if(this.Has3DCamera()){if(this._IsPointBehindNearPlane(n,a,s)||this._IsPointBehindNearPlane(o,a,s)||this._IsPointBehindNearPlane(o,h,s)||this._IsPointBehindNearPlane(n,h,s))return null;if(i>0&&(this._IsPointBehindNearPlane(n,a,r)||this._IsPointBehindNearPlane(o,a,r)||this._IsPointBehindNearPlane(o,h,r)||this._IsPointBehindNearPlane(n,h,r)))return null}else if(r>=this.Get2DCameraZ())return null;let[l,c]=this.LayerToDrawSurface(n,a,s),[u,_]=this.LayerToDrawSurface(o,h,s);if(0!==this.GetAngle()||i>0||this.Has3DCamera()){const[t,e]=this.LayerToDrawSurface(o,a,s),[d,p]=this.LayerToDrawSurface(n,h,s);if(i>0){const[s,i]=this.LayerToDrawSurface(n,a,r),[f,g]=this.LayerToDrawSurface(o,a,r),[m,S]=this.LayerToDrawSurface(o,h,r),[y,G]=this.LayerToDrawSurface(n,h,r);let T=Math.min(l,u,t,d,s,f,m,y);u=Math.max(l,u,t,d,s,f,m,y),l=T,T=Math.min(c,_,e,p,i,g,S,G),_=Math.max(c,_,e,p,i,g,S,G),c=T}else{let s=Math.min(l,u,t,d);u=Math.max(l,u,t,d),l=s,s=Math.min(c,_,e,p),_=Math.max(c,_,e,p),c=s}}return Rf.set(l,c,u,_),Rf}_GetViewFrustum(){return this._isViewFrustumChanged&&(this._UpdateViewFrustum(),this._isViewFrustumChanged=!1),this._viewFrustum}_UpdateViewFrustum(){const t=this._runtime.GetRenderer(),e=this._GetProjectionMatrix(t),s=this._GetModelViewMatrix(t);this._viewFrustum.CalculatePlanes(s,e)}_IsPointBehindNearPlane(t,e,s){return this._GetViewFrustum().IsBehindNearPlane(t,e,s)}_SaveToJson(){return{d:this.IsDynamic(),s:this.GetOwnScale(),a:this.GetOwnAngle(),v:this._IsVisibleFlagSet(),i:this.IsInteractive(),html:this.IsHTMLElementsLayer(),bc:this._backgroundColor.toJSON(),t:this.IsTransparent(),sx:this._scrollX,sy:this._scrollY,hosp:this._hasOwnScrollPosition,px:this.GetParallaxX(),py:this.GetParallaxY(),c:this._color.toJSON(),sr:this.GetScaleRate(),fx:this._effectList.SaveToJson(),cg:this._createdGlobalUids}}_LoadFromJson(t){this._isDynamic=!!t.d,this._scale=t.s,this._angle=t.a,this._isVisible=!!t.v,this._isInteractive=!t.hasOwnProperty("i")||t.i,this._isHTMLElementsLayer=!!t.html,this._backgroundColor.setFromJSON(t.bc),this._isTransparent=!!t.t,t.hasOwnProperty("sx")&&(this._scrollX=t.sx),t.hasOwnProperty("sy")&&(this._scrollY=t.sy),t.hasOwnProperty("hosp")&&(this._hasOwnScrollPosition=!!t.hosp),this._parallaxX=t.px,this._parallaxY=t.py,this._color.setFromJSON(t.c),this._UpdatePremultipliedColor(),this._scaleRate=t.sr,vf.shallowAssignArray(this._createdGlobalUids,t.cg),vf.shallowAssignArray(this._initialInstances,this._startupInitialInstances);const e=new Set(this._createdGlobalUids);let s=0;for(let t=0,i=this._initialInstances.length;t<i;++t)e.has(this._initialInstances[t][2])||(this._initialInstances[s]=this._initialInstances[t],++s);vf.truncateArray(this._initialInstances,s),this._effectList.LoadFromJson(t.fx),this._needsRebuildEffectChainSteps=!0}_LoadFromJsonAfterInstances(){this._SortInstancesByLastCachedZIndex(!1),this.SetZIndicesChanged(),this._SetMVMatrixChanged(),this._SetProjectionMatrixChanged()}GetILayer(){return this._iLayer}UserScriptDispatcher(){return this._userScriptDispatcher}DispatchUserScriptEvent(t){t.layer=this.GetILayer(),this._userScriptDispatcher.dispatchEvent(t)}SortAndAddInstancesByZIndex(t,e=!1,s=!1){if(this._instances.includes(t))return e&&this._instances.sort((t,e)=>(t.GetWorldInfo().GetSceneGraphZIndex()??0)-(e.GetWorldInfo().GetSceneGraphZIndex()??0)),void(s&&this._instances.forEach((t,e)=>t.GetWorldInfo()._SetZIndex(e)));if(t.HasChildren()){const e=[...t.allChildren()];e.push(t),e.sort((t,e)=>(t.GetWorldInfo().GetSceneGraphZIndex()??0)-(e.GetWorldInfo().GetSceneGraphZIndex()??0));for(const t of e)if(t.IsInContainer())for(const s of t.siblings()){if(e.includes(s))continue;const t=[...s.allChildren()];t.push(s),t.sort((t,e)=>(t.GetWorldInfo().GetSceneGraphZIndex()??0)-(e.GetWorldInfo().GetSceneGraphZIndex()??0)),t&&t.length&&e.splice(e.length,0,...t)}for(const t of e)t.GetPlugin().IsWorldType()&&this._AddInstance(t,!0);s&&this._instances.forEach((t,e)=>t.GetWorldInfo()._SetZIndex(e))}else{if(t.GetPlugin().IsWorldType()&&this._AddInstance(t,!0),!t.IsInContainer())return void(s&&this._instances.forEach((t,e)=>t.GetWorldInfo()._SetZIndex(e)));for(const e of t.siblings()){const t=[...e.allChildren()];if(t.push(e),t.sort((t,e)=>(t.GetWorldInfo().GetSceneGraphZIndex()??0)-(e.GetWorldInfo().GetSceneGraphZIndex()??0)),t&&t.length)for(const e of t)e.GetPlugin().IsWorldType()&&this._AddInstance(e,!0)}s&&this._instances.forEach((t,e)=>t.GetWorldInfo()._SetZIndex(e))}}}}{let Qf=function(t,e,s,i){return t[0]===Math.fround(e)&&t[1]===Math.fround(s)&&t[2]===Math.fround(i)},Kf=function(t,e){og!==t&&(t.PrepareForDraw(e),og=t)};0;const Zf=self.C3,$f=self.C3Debugger,tg=(self.assert,Zf.New(Zf.Rect),Zf.New(Zf.Rect),Zf.New(Zf.Rect)),eg=Zf.New(Zf.Color),sg=self.glMatrix.vec3,ig=[],rg=[],ng=[],ag=[];let og=null;Zf.Layout=class extends Zf.DefendedBase{constructor(t,e,s){super(),this._layoutManager=t,this._runtime=t.GetRuntime(),this._name=s[0],this._originalWidth=s[1],this._originalHeight=s[2],this._width=s[1],this._height=s[2],this._isUnboundedScrolling=!!s[3],this._isOrthographicProjection=!!s[4],this._vanishingPointX=s[5],this._vanishingPointY=s[6],this._eventSheetName=s[7],this._eventSheet=null,this._sid=s[8],this._index=e,this._scrollX=0,this._scrollY=0,this._scale=1,this._angle=0,this._initialObjectClasses=new Set,this._textureLoadedTypes=new Set,this._textureLoadPendingPromises=new Set,this._createdInstances=[],this._createdPersistedInstances=[],this._createdPersistedInstancesToDataMap=new Map,this._createdPersistedIndexToInstanceMap=new Map,this._initialNonWorld=[],this._is3dCameraEnabled=!1,this._cam3dposition=sg.create(),this._cam3dlook=sg.create(),this._cam3dup=sg.create(),this._rootLayers=[],this._allLayersFlat=[],this._layersByName=new Map,this._layersBySid=new Map,this._pendingSetHTMLLayerCount=-1;const i=this._runtime.GetCanvasManager();this._effectList=Zf.New(Zf.EffectList,this,s[11]),this._effectChain=Zf.New(Zf.Gfx.EffectChain,i.GetEffectChainManager(),{drawContent:(t,e)=>{const s=e.GetContentObject().GetRenderTarget();t.ResetColor(),t.DrawRenderTarget(s),t.InvalidateRenderTarget(s),i.ReleaseAdditionalRenderTarget(s)},getShaderParameters:t=>this.GetEffectList()._GetEffectChainShaderParametersForIndex(t)}),this._needsRebuildEffectChainSteps=!0,this._wasFullScreenQualityLow=!1,this._curRenderTarget=null,this._persistData={},this._persistedIntances=new Map,this._isFirstVisit=!0,this._iLayout=new self.ILayout(this),this._userScriptDispatcher=Zf.New(Zf.Event.Dispatcher);for(const t of s[9])this._rootLayers.push(Zf.Layer.CreateFromExportData(this,null,t));this._ReindexLayers();for(const t of this.allLayers())t._InitInitialInstances();for(const t of s[10]){const e=this._runtime.GetObjectClassByIndex(t[1]);if(!e)throw new Error("missing nonworld object class");e.GetDefaultInstanceData()||e.SetDefaultInstanceData(t),this._initialNonWorld.push(t),this._AddInitialObjectClass(e)}}Release(){for(const t of this._allLayersFlat)t.Release();Zf.clearArray(this._allLayersFlat),this._textureLoadPendingPromises.clear(),this._eventSheet=null,this._layoutManager=null,this._runtime=null}GetRuntime(){return this._runtime}GetName(){return this._name}GetSID(){return this._sid}GetIndex(){return this._index}GetEffectList(){return this._effectList}GetEffectChain(){return this._MaybeRebuildEffectChainSteps(),this._effectChain}_MaybeRebuildEffectChainSteps(){const t="low"===this._runtime.GetCanvasManager().GetCurrentFullscreenScalingQuality();if(!this._needsRebuildEffectChainSteps&&this._wasFullScreenQualityLow===t&&!this._effectChain.NeedsRebuild())return;const e=this.GetEffectList().GetActiveEffectTypes();this._effectChain.BuildSteps(e.map(t=>t.GetShaderProgram()),{indexMap:e.map(t=>t.GetIndex()),forcePostDraw:t,useFullSurface:!0}),this._needsRebuildEffectChainSteps=!1,this._wasFullScreenQualityLow=t}UpdateActiveEffects(){this.GetEffectList().UpdateActiveEffects(),this._needsRebuildEffectChainSteps=!0}GetMinLayerScale(){let t=this._allLayersFlat[0].GetNormalScale();for(let e=1,s=this._allLayersFlat.length;e<s;++e){const s=this._allLayersFlat[e];0===s.GetParallaxX()&&0===s.GetParallaxY()||(t=Math.min(t,s.GetNormalScale()))}return t}_GetScrollBoundMarginHorizontal(){return.5*this._runtime.GetViewportWidth()/this.GetMinLayerScale()}_GetScrollBoundMarginVertical(){return.5*this._runtime.GetViewportHeight()/this.GetMinLayerScale()}GetScrollLeftBound(){return this.IsUnboundedScrolling()?-1/0:this._GetScrollBoundMarginHorizontal()}GetScrollRightBound(){return this.IsUnboundedScrolling()?1/0:this.GetWidth()-this._GetScrollBoundMarginHorizontal()}GetScrollTopBound(){return this.IsUnboundedScrolling()?-1/0:this._GetScrollBoundMarginVertical()}GetScrollBottomBound(){return this.IsUnboundedScrolling()?1/0:this.GetHeight()-this._GetScrollBoundMarginVertical()}SetScrollX(t){const e=this.GetScrollLeftBound(),s=this.GetScrollRightBound();t>s&&(t=s),t<e&&(t=e),this._scrollX!==t&&(this._scrollX=t,this._SetAllLayersMVChanged(),this._runtime.UpdateRender())}GetScrollX(){return this._scrollX}SetScrollY(t){const e=this.GetScrollTopBound(),s=this.GetScrollBottomBound();t>s&&(t=s),t<e&&(t=e),this._scrollY!==t&&(this._scrollY=t,this._SetAllLayersMVChanged(),this._runtime.UpdateRender())}GetScrollY(){return this._scrollY}IsUnboundedScrolling(){return this._isUnboundedScrolling}BoundScrolling(){this.SetScrollX(this.GetScrollX()),this.SetScrollY(this.GetScrollY());for(const t of this._allLayersFlat)t.IsOwnScrollPositionEnabled()&&(t.SetScrollX(t.GetScrollX()),t.SetScrollY(t.GetScrollY()))}SetVanishingPointXY(t,e){this._vanishingPointX===t&&this._vanishingPointY===e||(this._vanishingPointX=t,this._vanishingPointY=e,this.IsPerspectiveProjection()&&(this._SetAllLayersProjectionChanged(),this._SetAllLayersMVChanged(),this._runtime.UpdateRender()))}GetVanishingPointX(){return this.IsOrthographicProjection()?.5:this._vanishingPointX}GetVanishingPointY(){return this.IsOrthographicProjection()?.5:this._vanishingPointY}GetVanishingPoint(){return[this.GetVanishingPointX(),this.GetVanishingPointY()]}HasVanishingPointOutsideViewport(){const t=this.GetVanishingPointX(),e=this.GetVanishingPointY();return t<0||t>1||e<0||e>1}SetPerspectiveProjection(){this._isOrthographicProjection&&(this._isOrthographicProjection=!1,this._SetAllLayersProjectionChanged(),this._SetAllLayersMVChanged(),this._runtime.UpdateRender())}SetOrthographicProjection(){this._isOrthographicProjection||(this._isOrthographicProjection=!0,this._SetAllLayersProjectionChanged(),this._SetAllLayersMVChanged(),this._runtime.UpdateRender())}IsOrthographicProjection(){return this._isOrthographicProjection}IsPerspectiveProjection(){return!this.IsOrthographicProjection()}Set3DCameraEnabled(t){t=!!t,this._is3dCameraEnabled!==t&&(this._is3dCameraEnabled=t,this._SetAllLayersMVChanged(),this._runtime.UpdateRender())}Is3DCameraEnabled(){return this._is3dCameraEnabled}Set3DCameraOrientation(t,e,s,i,r,n,a,o,h){Qf(this._cam3dposition,t,e,s)&&Qf(this._cam3dlook,i,r,n)&&Qf(this._cam3dup,a,o,h)||(sg.set(this._cam3dposition,t,e,s),sg.set(this._cam3dlook,i,r,n),sg.set(this._cam3dup,a,o,h),this.Set3DCameraChanged())}Set3DCameraChanged(){this._SetAllLayersMVChanged(),this._runtime.UpdateRender()}Get3DCameraPosition(){return this._cam3dposition}Get3DCameraLookAt(){return this._cam3dlook}Get3DCameraUpVector(){return this._cam3dup}GetScale(){return this._scale}SetScale(t){this._scale!==t&&(this._scale=t,this._SetAllLayersMVChanged(),this.BoundScrolling(),this._runtime.UpdateRender())}SetAngle(t){t=Zf.clampAngle(t),this._angle!==t&&(this._angle=t,this._SetAllLayersMVChanged(),this._runtime.UpdateRender())}GetAngle(){return this._angle}GetWidth(){return this._width}SetWidth(t){!isFinite(t)||t<1||(this._width=t)}GetHeight(){return this._height}SetHeight(t){!isFinite(t)||t<1||(this._height=t)}GetEventSheet(){return this._eventSheet}_GetRootLayers(){return this._rootLayers}*allLayers(){for(const t of this._rootLayers)yield*t.selfAndAllSubLayers()}GetLayers(){return this._allLayersFlat}GetLayerCount(){return this._allLayersFlat.length}GetLayer(t){return"number"==typeof t?this.GetLayerByIndex(t):this.GetLayerByName(t.toString())}GetLayerByIndex(t){return t=Zf.clamp(Math.floor(t),0,this._allLayersFlat.length-1),this._allLayersFlat[t]}GetLayerByName(t){return this._layersByName.get(t.toLowerCase())||null}HasLayerByName(t){return!!this.GetLayerByName(t)}GetLayerBySID(t){return this._layersBySid.get(t)||null}_SetAllLayersProjectionChanged(){for(const t of this._allLayersFlat)t._SetProjectionMatrixChanged()}_SetAllLayersMVChanged(){for(const t of this._allLayersFlat)t._SetMVMatrixChanged()}AddLayer(t,e,s){if(this.HasLayerByName(t))throw new Error(`layer name '${t}' already in use`);if(!e&&s<2)throw new Error("invalid insert position");const i=s>=2?e:e.GetParentLayer(),r=Zf.New(Zf.Layer,this,i,{name:t,sid:Math.floor(1e15*Math.random()),isDynamic:!0});this._InsertLayer(r,e,s),this.GetRuntime().UpdateRender(),this._ReindexAndUpdateAllLayers()}MoveLayer(t,e,s){if(!e&&s<2)throw new Error("invalid insert position");t===e&&s<2||(this._RemoveLayer(t),this._InsertLayer(t,e,s),this.GetRuntime().UpdateRender(),this._ReindexAndUpdateAllLayers())}RemoveLayer(t){if(this._RemoveLayer(t)){const e=this._runtime.GetEventSheetManager();e.BlockFlushingInstances(!0),t.Release(),e.BlockFlushingInstances(!1),this.GetRuntime().UpdateRender(),this._ReindexAndUpdateAllLayers()}}RemoveAllDynamicLayers(){const t=new Set;for(const e of this.allLayers())e.IsDynamic()&&!e.HasAnyDynamicParentLayer()&&t.add(e);if(0===t.size)return;const e=this._runtime.GetEventSheetManager();e.BlockFlushingInstances(!0);for(const e of t)this._RemoveLayer(e),e.Release();e.BlockFlushingInstances(!1),this.GetRuntime().UpdateRender(),this._ReindexAndUpdateAllLayers()}_InsertLayer(t,e,s){if(s>=2)if(e){if(e===t||e.HasParentLayer(t))throw new Error(`cannot move layer '${t.GetName()}' to sub-layer of itself`);e._AddSubLayer(t,2===s),t._SetParentLayer(e)}else 2===s?this._rootLayers.push(t):this._rootLayers.unshift(t),t._SetParentLayer(null);else{const i=e.GetParentLayer();if(i){if(e.HasParentLayer(t))throw new Error(`cannot move layer '${t.GetName()}' to sub-layer of itself`);i._InsertSubLayer(t,e,0===s),t._SetParentLayer(i)}else{let i=this._rootLayers.indexOf(e);if(-1===i)throw new Error("cannot find layer to insert by");0===s&&++i,this._rootLayers.splice(i,0,t),t._SetParentLayer(null)}}}_RemoveLayer(t){const e=t.GetParentLayer();if(e)return e._RemoveSubLayer(t),!0;if(this._rootLayers.length>1){const e=this._rootLayers.indexOf(t);if(-1===e)throw new Error("cannot find layer to remove");return this._rootLayers.splice(e,1),!0}return!1}_ReindexLayers(){this._allLayersFlat=[...this.allLayers()],this._layersByName.clear(),this._layersBySid.clear();for(let t=0,e=this._allLayersFlat.length;t<e;++t){const e=this._allLayersFlat[t];e._SetIndex(t),this._layersByName.set(e.GetName().toLowerCase(),e),this._layersBySid.set(e.GetSID(),e)}}_ReindexHTMLLayers(){let t=0;for(const e of this._rootLayers){for(const s of e.selfAndAllSubLayers())s._SetHTMLIndex(t);e.IsHTMLElementsLayer()&&t++}}GetHTMLLayerCount(){return this._rootLayers.at(-1).GetHTMLIndex()+1}async _ReindexAndUpdateAllLayers(){this._ReindexLayers(),this._ReindexHTMLLayers(),this._pendingSetHTMLLayerCount=this.GetHTMLLayerCount()}_GetPendingSetHTMLLayerCount(){return this._pendingSetHTMLLayerCount}_ResetPendingHTMLLayerCount(){this._pendingSetHTMLLayerCount=-1}GetRootLayersForHTMLLayer(t){const e=[];for(const s of this._rootLayers){const i=s.GetHTMLIndex();if(i===t)e.push(s);else if(i>t)break}return e}SaveTransform(){return{scrollX:this.GetScrollX(),scrollY:this.GetScrollY(),scale:this.GetScale(),angle:this.GetAngle(),vpX:this.GetVanishingPointX(),vpY:this.GetVanishingPointY()}}RestoreTransform(t){this.SetScrollX(t.scrollX),this.SetScrollY(t.scrollY),this.SetScale(t.scale),this.SetAngle(t.angle),this.SetVanishingPointXY(t.vpX,t.vpY)}GetLayoutBackgroundColor(){let t=this._rootLayers.filter(t=>t.ShouldDraw())[0];for(;t;){if(!t.IsTransparent())return eg.copyRgb(t.GetBackgroundColor()),eg.setA(1),eg;if(t.UsesOwnTexture())return eg.setRgba(0,0,0,0),eg;t=t.GetSubLayers().filter(t=>t.ShouldDraw())[0]}return eg.setRgba(0,0,0,0),eg}IsFirstVisit(){return this._isFirstVisit}_GetInitialObjectClasses(){return[...this._initialObjectClasses]}_AddInitialObjectClass(t){if(t.IsInContainer())for(const e of t.GetContainer().GetObjectTypes())this._initialObjectClasses.add(e);else this._initialObjectClasses.add(t)}_GetTextureLoadedObjectTypes(){return[...this._textureLoadedTypes]}_Load(t,e){if(t===this||!e)return Promise.resolve();t&&(Zf.CopySet(this._textureLoadedTypes,t._textureLoadedTypes),t._textureLoadedTypes.clear());const s=[];for(const t of this._initialObjectClasses)this._textureLoadedTypes.has(t)||(s.push(t.LoadTextures(e)),this._textureLoadedTypes.add(t));return Promise.all(s)}async MaybeLoadTexturesFor(t){if(t.IsFamily())throw new Error("cannot load textures for family");const e=this._runtime.GetRenderer();if(!e||e.IsContextLost()||this._textureLoadedTypes.has(t))return;this._textureLoadedTypes.add(t);const s=t.LoadTextures(e);this._AddPendingTextureLoadPromise(s),await s,t.OnDynamicTextureLoadComplete(),this._runtime.UpdateRender()}_AddPendingTextureLoadPromise(t){this._textureLoadPendingPromises.add(t),t.then(()=>this._textureLoadPendingPromises.delete(t)).catch(()=>this._textureLoadPendingPromises.delete(t))}WaitForPendingTextureLoadsToComplete(){return Promise.all([...this._textureLoadPendingPromises])}MaybeUnloadTexturesFor(t){if(t.IsFamily()||t.GetInstanceCount()>0)throw new Error("cannot unload textures");const e=this._runtime.GetRenderer();e&&this._textureLoadedTypes.has(t)&&(this._textureLoadedTypes.delete(t),t.ReleaseTextures(e))}_Unload(t,e){if(t!==this&&e)for(const e of this._textureLoadedTypes)e.IsGlobal()||t._initialObjectClasses.has(e)||(e.ReleaseTextures(),this._textureLoadedTypes.delete(e))}_OnRendererContextLost(){this._textureLoadedTypes.clear()}async _StartRunning(t){const e=this._runtime,s=this._layoutManager,i=e.GetEventSheetManager();this._eventSheetName&&(this._eventSheet=i.GetEventSheetByName(this._eventSheetName),this._eventSheet._UpdateDeepIncludes()),s._SetMainRunningLayout(this),this._width=this._originalWidth,this._height=this._originalHeight,this._scrollX=e.GetOriginalViewportWidth()/2,this._scrollY=e.GetOriginalViewportHeight()/2,this.BoundScrolling(),this._SetAllLayersProjectionChanged(),this._SetAllLayersMVChanged(),this._ReindexHTMLLayers(),await this._runtime.GetCanvasManager().SetHTMLLayerCount(this.GetHTMLLayerCount(),!0),this._MoveGlobalObjectsToThisLayout(t),this._runtime.SetUsingCreatePromises(!0),this._CreateInitialInstances(),this._isFirstVisit||this._CreatePersistedInstances(),this._CreateAndLinkContainerInstances(this._createdInstances),this._CreateAndLinkContainerInstances(this._createdPersistedInstances),this._CreateInitialNonWorldInstances(),s.ClearPendingChangeLayout(),e.FlushPendingInstances(),this._runtime.SetUsingCreatePromises(!1);const r=this._runtime.GetCreatePromises();if(await Promise.all(r),Zf.clearArray(r),!e.IsLoadingState()){for(const t of this._createdInstances)t.SetupInitialSceneGraphConnections();for(const t of this._createdPersistedInstances)t.SetupPersistedSceneGraphConnections(this._createdPersistedInstancesToDataMap,this._createdPersistedIndexToInstanceMap);for(const[t,e]of Object.entries(this._persistData)){const s=this._runtime.GetObjectClassBySID(parseInt(t,10));s&&!s.IsFamily()&&s.HasPersistBehavior()&&Zf.clearArray(e)}for(const t of this._createdInstances)t._TriggerOnCreated();for(const t of this._createdPersistedInstances)t._TriggerOnCreated();for(const t of this._createdInstances)t.HasParent()||t._OnHierarchyReady();for(const t of this._createdPersistedInstances)t.HasParent()||t._OnHierarchyReady()}Zf.clearArray(this._createdInstances),Zf.clearArray(this._createdPersistedInstances),this._createdPersistedInstancesToDataMap.clear(),this._createdPersistedIndexToInstanceMap.clear(),await Promise.all([...this._initialObjectClasses].map(t=>t.PreloadTexturesWithInstances(this._runtime.GetRenderer()))),t&&(e.Dispatcher().dispatchEvent(new Zf.Event("beforefirstlayoutstart")),await e.DispatchUserScriptEventAsyncWait(new Zf.Event("beforeprojectstart"))),await this.DispatchRuntimeUserScriptEventAsyncWait(new Zf.Event("beforeanylayoutstart")),e.Dispatcher().dispatchEvent(new Zf.Event("beforelayoutstart")),await this.DispatchUserScriptEventAsyncWait(new Zf.Event("beforelayoutstart")),e.IsLoadingState()||await e.TriggerAsync(Zf.Plugins.System.Cnds.OnLayoutStart,null,null),e.Dispatcher().dispatchEvent(new Zf.Event("afterlayoutstart")),await this.DispatchUserScriptEventAsyncWait(new Zf.Event("afterlayoutstart")),await this.DispatchRuntimeUserScriptEventAsyncWait(new Zf.Event("afteranylayoutstart")),t&&(e.Dispatcher().dispatchEvent(new Zf.Event("afterfirstlayoutstart")),await e.DispatchUserScriptEventAsyncWait(new Zf.Event("afterprojectstart"))),i._RunQueuedTriggers(s),await this.WaitForPendingTextureLoadsToComplete(),this._isFirstVisit=!1}_MoveGlobalObjectsToThisLayout(t){for(const t of this._runtime.GetAllObjectClasses())if(!t.IsFamily()&&t.IsWorldType())for(const e of t.GetInstances()){const t=e.GetWorldInfo(),s=t.GetLayer(),i=s.GetName(),r=this.GetLayerByName(i);if(r)t._SetLayer(r,!0),r._MaybeAddInstance(e);else{const i=Zf.clamp(s.GetIndex(),0,this._allLayersFlat.length-1),r=this._allLayersFlat[i];t._SetLayer(r,!0),r._MaybeAddInstance(e)}}if(!t)for(const t of this._allLayersFlat)t._SortInstancesByLastCachedZIndex(!1)}_CreateInitialInstances(){for(const t of this._allLayersFlat)t.CreateInitialInstances(this._createdInstances),t._Start()}_CreatePersistedInstances(){let t=!1;for(const[e,s]of Object.entries(this._persistData)){const i=this._runtime.GetObjectClassBySID(parseInt(e,10));if(i&&!i.IsFamily()&&i.HasPersistBehavior())for(const e of s){let s=null;if(i.IsWorldType()&&(s=e.hasOwnProperty("instJson")?this.GetLayerBySID(e.instJson.w.l):this.GetLayerBySID(e.w.l),!s))continue;const r=this._runtime.CreateInstanceFromData(i,s,!1,0,0,!0);e.hasOwnProperty("instJson")?r.LoadFromJson(e.instJson):r.LoadFromJson(e),t=!0,this._createdPersistedInstances.push(r),e.hasOwnProperty("instJson")&&(this._createdPersistedInstancesToDataMap.set(r,e),this._createdPersistedIndexToInstanceMap.set(e.index,r))}}for(const t of this._allLayersFlat)t._SortInstancesByLastCachedZIndex(!0),t.SetZIndicesChanged();t&&(this._runtime.FlushPendingInstances(),this._runtime._RefreshUidMap())}_CreateAndLinkContainerInstances(t){for(const e of t){if(!e.IsInContainer())continue;const s=e.GetWorldInfo(),i=e.GetIID();for(const r of e.GetObjectClass().GetContainer().objectTypes()){if(r===e.GetObjectClass())continue;const n=r.GetInstances();if(n.length>i)e._AddSibling(n[i]);else{let i;i=s?this._runtime.CreateInstanceFromData(r,s.GetLayer(),!0,s.GetX(),s.GetY(),!0):this._runtime.CreateInstanceFromData(r,null,!0,0,0,!0),this._runtime.FlushPendingInstances(),r._UpdateIIDs(),e._AddSibling(i),t.push(i)}}}}_CreateInitialNonWorldInstances(){for(const t of this._initialNonWorld)this._runtime.GetObjectClassByIndex(t[1]).IsInContainer()||this._runtime.CreateInstanceFromData(t,null,!0)}_CreateGlobalNonWorlds(){const t=[],e=this._initialNonWorld;let s=0;for(let i=0,r=e.length;i<r;++i){const r=e[i],n=this._runtime.GetObjectClassByIndex(r[1]);n.IsGlobal()?n.IsInContainer()&&n.GetContainer().HasAnyWorldType()||t.push(this._runtime.CreateInstanceFromData(r,null,!0)):(e[s]=r,++s)}Zf.truncateArray(e,s),this._runtime.FlushPendingInstances(),this._CreateAndLinkContainerInstances(t)}RecreateInitialObjects(t,e,s,i,r,n,a){if(s)return s.RecreateInitialObjects(t,e,r,n,i,a);{const s=[];for(const o of this._allLayersFlat)s.push(o.RecreateInitialObjects(t,e,r,n,i,a));return s.flat()}}async _StopRunning(){const t=this._layoutManager;this._runtime.IsLoadingState()||(await this.DispatchRuntimeUserScriptEventAsyncWait(new Zf.Event("beforeanylayoutend")),await this.DispatchUserScriptEventAsyncWait(new Zf.Event("beforelayoutend")),await this._runtime.TriggerAsync(Zf.Plugins.System.Cnds.OnLayoutEnd,null,null),await this.DispatchUserScriptEventAsyncWait(new Zf.Event("afterlayoutend")),await this.DispatchRuntimeUserScriptEventAsyncWait(new Zf.Event("afteranylayoutend"))),t.SetIsEndingLayout(!0),this._runtime.GetEventSheetManager().ClearAllScheduledWaits(),this._isFirstVisit||this._SavePersistData();for(const t of this._allLayersFlat)t._End();for(const t of this._runtime.GetAllObjectClasses())if(!(t.IsGlobal()||t.IsWorldType()||t.GetPlugin().IsSingleGlobal()||t.IsFamily())){for(const e of t.GetInstances())this._runtime.DestroyInstance(e);this._runtime.FlushPendingInstances()}t.SetIsEndingLayout(!1),t.GetMainRunningLayout()===this&&t._SetMainRunningLayout(null)}_SaveInstanceToPersist(t,e){const s=t.GetObjectClass().GetSID().toString();this._persistData.hasOwnProperty(s)||(this._persistData[s]=[]);const i=this._persistData[s],r={index:e,instJson:t.SaveToJson(),sceneGraphJson:{children:[]}};i.push(r),this._persistedIntances.set(t,r)}_SaveSceneGraphInfoToPersist(t){const e=this._persistedIntances.get(t);for(const s of t.GetChildren()){const t=this._persistedIntances.get(s);t&&e.sceneGraphJson.children.push({index:t.index,flags:Zf.SceneGraphInfo._GetFlagsNumber(s.GetWorldInfo())})}}_SavePersistData(){this._persistedIntances.clear();let t=0;for(const e of this._allLayersFlat){e._UpdateZIndices();for(const s of e._GetInstances()){const e=s.GetObjectClass();!e.IsGlobal()&&e.HasPersistBehavior()&&(this._SaveInstanceToPersist(s,t),t++)}}for(const t of this._allLayersFlat)for(const e of t._GetInstances()){const t=e.GetObjectClass();!t.IsGlobal()&&t.HasPersistBehavior()&&this._SaveSceneGraphInfoToPersist(e)}this._persistedIntances.clear()}ResetPersistData(){this._persistData={},this._isFirstVisit=!0}GetRenderTarget(){return this._curRenderTarget}UsesOwnTexture(){const t=this._runtime,e=t.GetRenderer().IsWebGL();return"low"===t.GetCanvasManager().GetCurrentFullscreenScalingQuality()||e&&t.UsesAnyBackgroundBlending()||this._effectList.HasAnyActiveEffect()||e&&t.Uses3DFeatures()}_MaybeStartDrawToOwnTexture(t){const e=this._runtime.GetCanvasManager();if(this.UsesOwnTexture()){t.SetRenderTarget(null),t.ClearRgba(0,0,0,0);const s={sampling:this._runtime.GetSampling(),isSampled:t.IsWebGPU()||this._runtime.UsesAnyBackgroundBlending()||this._effectList.HasAnyActiveEffect(),canReadPixels:!!t.IsWebGPU()&&this._runtime.UsesAnyBackgroundBlending()};"low"===e.GetCurrentFullscreenScalingQuality()&&(s.width=e.GetDrawWidth(),s.height=e.GetDrawHeight()),this._curRenderTarget=this._runtime.GetAdditionalRenderTarget(s)}else this._curRenderTarget=null}_MaybeCopyOwnTextureToBackbuffer(t){this._runtime._NeedsHTMLLayerCompositing(t)&&(t.SetDepthEnabled(!1),t.SetRenderTarget(null),t.SetTextureFillMode(),t.CopyRenderTarget(this._curRenderTarget))}_MaybeEndDrawToOwnTexture(t){this.UsesOwnTexture()&&(t.SetDepthEnabled(!1),this._DrawLayoutOwnTextureToRenderTarget(t,this._curRenderTarget))}DrawMain(t){t.SetRenderTarget(this._curRenderTarget),t.Clear(this.GetLayoutBackgroundColor()),this._runtime.Uses3DFeatures()&&t.ClearDepth();const e=this.GetRootLayersForHTMLLayer(0);this._DrawLayerList(t,this._curRenderTarget,e,!0),t.IsWebGPU()&&t.StartMeasuringRenderPassTime(0,1),this._MaybeEndDrawToOwnTexture(t),this._curRenderTarget=null}DrawForHTMLLayerIndex(t,e){let s=null;this._runtime._NeedsHTMLLayerCompositing(t)&&(s=this._curRenderTarget),t.SetRenderTarget(s),t.ClearRgba(0,0,0,0),this._runtime.Uses3DFeatures()&&t.ClearDepth();const i=this.GetRootLayersForHTMLLayer(e);this._DrawLayerList(t,s,i,!0),this._MaybeCopyOwnTextureToBackbuffer(t),t.EndBatch(),this._runtime.GetCanvasManager().BlitMainCanvasToHTMLLayerCanvas(e)}_DrawLayerList(t,e,s,i){const r=s.filter(t=>t.ShouldDraw());for(let s=0,n=r.length;s<n;){const a=r[s];if(a.SelfAndAllSubLayersHave3DCamera()&&!a.SelfOrAnySubLayerUsesOwnTexture()){ig.push(a);for(let t=s+1;t<n;++t){const e=r[t];if(!e.SelfAndAllSubLayersHave3DCamera()||e.SelfOrAnySubLayerUsesOwnTexture())break;ig.push(r[t])}if(ig.length>=2||1===ig.length&&ig[0].HasAnyVisibleSubLayer()){this._Draw3DLayers(t,e,ig),s+=ig.length,Zf.clearArray(ig);continue}Zf.clearArray(ig)}a.Draw(t,e,i&&0===s),++s}}_DrawLayoutOwnTextureToRenderTarget(t,e){const s=this._effectList.GetActiveEffectTypes(),i=this._runtime;0===s.length?(t.SetRenderTarget(null),t.SetTextureFillMode(),t.CopyRenderTarget(e),t.InvalidateRenderTarget(e),i.ReleaseAdditionalRenderTarget(e)):(tg.set(0,0,i.GetViewportWidth(),i.GetViewportHeight()),this.GetEffectChain().Render(t,null,{contentObject:this,blendMode:3,devicePixelRatio:this._runtime.GetEffectDevicePixelRatioParam(),layerScale:this._runtime.GetEffectLayerScaleParam()*this.GetScale(),layerAngle:this.GetAngle(),layoutRect:tg,drawSurfaceRect:null,invalidateRenderTargets:!0}))}_Draw3DLayers(t,e,s){const i=s[0],r=i._MaybeStartWebGLProfiling(t);i._MaybeStartWebGPUProfiling(t),s[0].IsTransparent()||(eg.copyRgb(s[0].GetBackgroundColor()),eg.setA(1),t.Clear(eg)),t.SetDepthEnabled(!0);const n=rg,a=ng,o=ag;for(const e of s)e._UpdateZIndices(),e._AppendAllInstancesIncludingSubLayersInDrawOrder(n),e._FireDrawEvent(t,"beforedraw");for(let s=0,i=n.length;s<i;){const r=n[s],h=r.GetWorldInfo(),l=h.GetLayer();if(!h.IsVisible()||!h.IsInViewport3D(l._GetViewFrustum())){++s;continue}(!r.RendersToOwnZPlane()||h.GetDepth()>0)&&o.push(r);const c=r.GetWorldInfo().GetTotalZElevation();a.push(r);let u=s+1;for(;u<i;++u){const t=n[u],e=t.GetWorldInfo();if(e.IsVisible()&&e.IsInViewport3D(e.GetLayer()._GetViewFrustum())){if(e.GetTotalZElevation()!==c)break;t.RendersToOwnZPlane()?(e.GetDepth()>0&&o.push(t),a.push(t)):o.push(t)}}if(1!==a.length||a[0].MustMitigateZFighting()){this._Draw3DLayersCoplanarInstances(t,e,a);for(let s=0,i=o.length;s<i;++s){const i=o[s],r=i.GetWorldInfo(),n=r.GetLayer();r._SetDrawNonBackFacesOnly(!0),Kf(n,t),n._DrawInstanceMaybeWithEffects(i,r,t,e),r._SetDrawNonBackFacesOnly(!1)}}else{Kf(l,t),l._DrawInstanceMaybeWithEffects(r,h,t,e);for(let s=0,i=o.length;s<i;++s){const i=o[s];if(i===r)continue;const n=i.GetWorldInfo(),a=n.GetLayer();Kf(a,t),a._DrawInstanceMaybeWithEffects(i,n,t,e)}}s=u,Zf.clearArray(a),Zf.clearArray(o)}for(const e of s)e._FireDrawEvent(t,"afterdraw");r&&t.EndQuery(r),Zf.clearArray(n),og=null}_Draw3DLayersCoplanarInstances(t,e,s){t.CoplanarStartStencilPass();for(let e=0,i=s.length;e<i;++e){const i=s[e],r=i.GetWorldInfo(),n=r.GetLayer();r._SetDrawBackFaceOnly(!0),Kf(n,t),n._DrawInstance(i,r,t)}t.CoplanarStartColorPass();for(let i=0,r=s.length;i<r;++i){const r=s[i],n=r.GetWorldInfo(),a=n.GetLayer();Kf(a,t),a._DrawInstanceMaybeWithEffects(r,n,t,e),n._SetDrawBackFaceOnly(!1)}t.CoplanarRestoreStandardRendering()}_SaveToJson(){const t={sx:this.GetScrollX(),sy:this.GetScrollY(),s:this.GetScale(),a:this.GetAngle(),w:this.GetWidth(),h:this.GetHeight(),ortho:this.IsOrthographicProjection(),vpX:this.GetVanishingPointX(),vpY:this.GetVanishingPointY(),fv:this._isFirstVisit,persist:this._persistData,fx:this._effectList.SaveToJson(),layers:{},dynamicLayers:[]};for(const e of this._allLayersFlat)if(e.IsDynamic()){const s=e.GetParentLayer();t.dynamicLayers.push({sid:e.GetSID(),name:e.GetName(),parentSid:s?s.GetSID():null,siblingIndex:e._GetSiblingIndex(),data:e._SaveToJson()})}else t.layers[e.GetSID().toString()]=e._SaveToJson();return t}_LoadFromJson(t){this._scrollX=t.sx,this._scrollY=t.sy,this._scale=t.s,this._angle=t.a,this._width=t.w,this._height=t.h,this._isOrthographicProjection=!!t.ortho,t.hasOwnProperty("vpX")&&(this._vanishingPointX=t.vpX),t.hasOwnProperty("vpY")&&(this._vanishingPointY=t.vpY),this._isFirstVisit=!!t.fv,this._persistData=t.persist,this._effectList.LoadFromJson(t.fx),this._needsRebuildEffectChainSteps=!0;for(const[e,s]of Object.entries(t.layers)){const t=parseInt(e,10),i=this.GetLayerBySID(t);i&&i._LoadFromJson(s)}if(t.hasOwnProperty("dynamicLayers")){this.RemoveAllDynamicLayers(),this._runtime.FlushPendingInstances();const e=new Map,s=t.dynamicLayers;for(let t=s.length-1;t>=0;--t){const i=s[t],r=i.sid,n=i.name,a=i.parentSid,o=i.siblingIndex,h=i.data;if(this._ReindexLayers(),this.HasLayerByName(n)||this.GetLayerBySID(r))continue;let l,c;if(null===a)l=null,c=this._rootLayers;else{if(l=this.GetLayerBySID(a),!l)continue;c=l.GetSubLayers()}const u=Zf.New(Zf.Layer,this,l,{name:n,sid:r,isDynamic:!0});c.push(u);let _=e.get(c);_||(_=[],e.set(c,_)),_.push({layer:u,siblingIndex:o}),u._LoadFromJson(h)}for(const[t,s]of e){s.sort((t,e)=>t.siblingIndex-e.siblingIndex);for(const e of s){const s=e.layer,i=e.siblingIndex;let r=t.indexOf(s);t.splice(r,1),t.splice(i,0,s)}}}this._ReindexAndUpdateAllLayers(),this._SetAllLayersProjectionChanged(),this._SetAllLayersMVChanged()}GetILayout(){return this._iLayout}UserScriptDispatcher(){return this._userScriptDispatcher}DispatchUserScriptEvent(t){t.layout=this.GetILayout();const e=this._runtime,s=e.IsDebug()&&!e.GetEventSheetManager().IsInEventEngine();s&&$f.StartMeasuringScriptTime(),this._userScriptDispatcher.dispatchEvent(t),s&&$f.AddScriptTime()}DispatchUserScriptEventAsyncWait(t){return t.layout=this.GetILayout(),this._userScriptDispatcher.dispatchEventAndWaitAsync(t)}DispatchRuntimeUserScriptEventAsyncWait(t){return t.layout=this.GetILayout(),this._runtime.DispatchUserScriptEventAsyncWait(t)}_LogLayerTree(){this._LogLayerList(this._rootLayers)}_LogLayerList(t,e=0){const s=t.slice(0);s.reverse();for(const t of s)console.log(`${"\t".repeat(e)}- ${t.GetName()}`),this._LogLayerList(t.GetSubLayers(),e+1)}}}{const hg=self.C3;hg.LayoutManager=class extends hg.DefendedBase{#e;#s=[];#_=new Map;#h=new Map;#i=null;#t=[];#n=null;#a=0;#d=null;constructor(t){super(),this.#e=t}Release(){this.#e=null,this.#i=null,this.#n=null,this.#d=null,hg.clearArray(this.#s),this.#_.clear(),this.#h.clear(),hg.clearArray(this.#t)}Create(t){const e=hg.New(hg.Layout,this,this.#s.length,t);this.#s.push(e),this.#_.set(e.GetName().toLowerCase(),e),this.#h.set(e.GetSID(),e)}GetRuntime(){return this.#e}SetFirstLayout(t){this.#n=t}GetFirstLayout(){if(this.#n)return this.#n;if(this.#s.length)return this.#s[0];throw new Error("no first layout")}GetLayoutByName(t){return this.#_.get(t.toLowerCase())||null}GetLayoutBySID(t){return this.#h.get(t)||null}GetLayoutByIndex(t){return t=hg.clamp(Math.floor(t),0,this.#s.length-1),this.#s[t]}GetLayout(t){return"number"==typeof t?this.GetLayoutByIndex(t):this.GetLayoutByName(t.toString())}GetAllLayouts(){return this.#s}_SetMainRunningLayout(t){this.#i=t}GetMainRunningLayout(){return this.#i}_AddRunningSubLayout(t){if(this.#t.includes(t))throw new Error("layout already running");this.#t.push(t)}_RemoveRunningSubLayout(t){const e=this.#t.indexOf(t);if(-1===e)throw new Error("layout not running");this.#t.splice(e,1)}*runningLayouts(){this.#i&&(yield this.#i),this.#t.length&&(yield*this.#t)}IsLayoutRunning(t){return this.#i===t||this.#t.includes(t)}SetIsEndingLayout(t){if(t)this.#a++;else{if(this.#a<=0)throw new Error("already unset");this.#a--}}IsEndingLayout(){return this.#a>0}ChangeMainLayout(t){this.#d=t}ClearPendingChangeLayout(){this.#d=null}IsPendingChangeMainLayout(){return!!this.#d}GetPendingChangeMainLayout(){return this.#d}SetAllLayerProjectionChanged(){const t=this.GetMainRunningLayout();t&&t._SetAllLayersProjectionChanged()}SetAllLayerMVChanged(){const t=this.GetMainRunningLayout();t&&t._SetAllLayersMVChanged()}}}{const lg=self.C3,cg=new RegExp("<(.+?)>","g");lg.TimelineManager=class extends lg.DefendedBase{constructor(t){super(),this._runtime=t,this._timelineDataManager=lg.New(lg.TimelineDataManager),this._pluginInstance=null,this._timelines=[],this._timelinesByName=new Map,this._objectClassToTimelineMap=new Map,this._timelinesCreatedByTemplate=new Map,this._scheduledTimelines=[],this._playingTimelines=[],this._markedForRemovalTimelines=[],this._hasRuntimeListeners=!1,this._changingLayout=!1,this._isTickingTimelines=!1,this._tickFunc=()=>this._OnTick(),this._tick2Func=()=>this._OnTick2(),this._beforeLayoutChange=()=>this._OnBeforeChangeLayout(),this._layoutChange=()=>this._OnAfterChangeLayout(),this._instanceDestroy=t=>this._OnInstanceDestroy(t.instance),this._beforeLoad=t=>this._OnBeforeLoad(),this._afterLoad=t=>this._OnAfterLoad(),this._afterLayoutStart=t=>this._OnAfterLayoutStart(),this._destroyedWhileLoadingState=[],this._renderChange=0}Release(){this.RemoveRuntimeListeners(),this._tickFunc=null,this._tick2Func=null,this._beforeLayoutChange=null,this._layoutChange=null,this._instanceDestroy=null,this._afterLoad=null;for(const t of this._timelines)t.Stop(),t.Release();lg.clearArray(this._timelines),this._timelines=null,this._timelineDataManager.Release(),this._timelineDataManager=null,lg.clearArray(this._scheduledTimelines),this._scheduledTimelines=null,lg.clearArray(this._playingTimelines),this._playingTimelines=null,lg.clearArray(this._markedForRemovalTimelines),this._markedForRemovalTimelines=null,this._timelinesByName.clear(),this._timelinesByName=null,this._objectClassToTimelineMap.clear(),this._objectClassToTimelineMap=null,this._timelinesCreatedByTemplate.clear(),this._timelinesCreatedByTemplate=null,lg.clearArray(this._destroyedWhileLoadingState),this._destroyedWhileLoadingState=null,this._runtime=null}AddRuntimeListeners(){const t=this._runtime.Dispatcher();t.addEventListener("pretick",this._tickFunc),t.addEventListener("tick2",this._tick2Func),t.addEventListener("beforelayoutchange",this._beforeLayoutChange),t.addEventListener("layoutchange",this._layoutChange),t.addEventListener("instancedestroy",this._instanceDestroy),t.addEventListener("beforeload",this._beforeLoad),t.addEventListener("afterload",this._afterLoad),t.addEventListener("afterlayoutstart",this._afterLayoutStart)}RemoveRuntimeListeners(){const t=this._runtime.Dispatcher();t.removeEventListener("pretick",this._tickFunc),t.removeEventListener("tick2",this._tick2Func),t.removeEventListener("beforelayoutchange",this._beforeLayoutChange),t.removeEventListener("layoutchange",this._layoutChange),t.removeEventListener("instancedestroy",this._instanceDestroy),t.removeEventListener("beforeload",this._beforeLoad),t.removeEventListener("afterload",this._afterLoad),t.removeEventListener("afterlayoutstart",this._afterLayoutStart)}Create(t){this._timelineDataManager.Add(t);const e=lg.TimelineState.CreateInitial(t,this);this.Add(e),this.SetTimelineObjectClassesToMap(e),this._timelinesCreatedByTemplate.set(e.GetName(),0)}CreateFromTemplate(t){const e=this.GetTimelineDataManager(),s=t.GetTemplateName(),i=e.Get(s),r=lg.TimelineState.CreateFromTemplate(`${s}:${this._timelinesCreatedByTemplate.get(s)}`,i,this);return this._IncreaseTemplateTimelinesCount(s),this.Add(r),this._runtime.IsDebug()&&globalThis.C3Debugger.TimelineCreated(r),r}GetCreatedTemplateTimelinesCount(t){return this._timelinesCreatedByTemplate.get(t)}_IncreaseTemplateTimelinesCount(t){this._timelinesCreatedByTemplate.set(t,this._timelinesCreatedByTemplate.get(t)+1)}_SetCreatedTemplateTimelinesCount(){for(const t of this._timelines){if(t.IsTemplate())continue;const e=t.GetTemplateName();this._IncreaseTemplateTimelinesCount(e)}}_ClearCreatedTemplateTimelinesCount(){for(const t of this._timelinesCreatedByTemplate.keys())this._timelinesCreatedByTemplate.set(t,0)}Add(t){this._timelines.push(t),this._timelinesByName.set(t.GetName().toLowerCase(),t)}Remove(t){t.Removed(),t.IsTemplate()||(lg.arrayFindRemove(this._timelines,t),lg.arrayFindRemove(this._scheduledTimelines,t),lg.arrayFindRemove(this._playingTimelines,t),lg.arrayFindRemove(this._markedForRemovalTimelines,t),this._timelinesByName.delete(t.GetName().toLowerCase()),this.RemoveTimelineFromObjectClassMap(t),this._runtime.IsDebug()&&globalThis.C3Debugger.TimelineDestroyed(t),t.IsReleased()||t.Release())}Trigger(t){this._runtime.Trigger(t,this._pluginInstance,null)}GetRuntime(){return this._runtime}GetTimelineDataManager(){return this._timelineDataManager}SetPluginInstance(t){this._pluginInstance=t}GetPluginInstance(){return this._pluginInstance}*GetTimelines(){for(const t of this._timelines)yield t}*GetPlayingTimelines(){for(const t of this._playingTimelines)yield t}SetTimelineObjectClassToMap(t,e){this._objectClassToTimelineMap.has(t)||this._objectClassToTimelineMap.set(t,new Set),this._objectClassToTimelineMap.get(t).add(e)}SetTimelineObjectClassesToMap(t){for(const e of t.GetObjectClasses())this.SetTimelineObjectClassToMap(e,t)}RemoveTimelineFromObjectClassMap(t){for(const[e,s]of this._objectClassToTimelineMap.entries())s.has(t)&&(s.delete(t),0===s.size&&this._objectClassToTimelineMap.delete(e))}GetTimelinesForObjectClass(t){if(this._objectClassToTimelineMap.has(t))return this._objectClassToTimelineMap.get(t)}GetTimelineOfTemplateForInstances(t,e){if(e)for(const s of this._timelines)if(e.every(t=>s.HasTrackInstance(t.instance,t.trackId))&&s.GetName().includes(t.GetName()))return s}GetTimelineByName(t){return this._timelinesByName.get(t.toLowerCase())||null}GetScheduledOrPlayingTimelineByName(t){for(const e of this._scheduledTimelines)if(e.GetName()===t)return e;for(const e of this._playingTimelines)if(e.GetName()===t)return e;return null}*GetTimelinesByName(t){if(cg.test(t)){let e;cg.lastIndex=0;const s=new Set;do{if(e=cg.exec(t),e){const t=e[1].split(",");for(const e of t)s.add(e)}}while(e);for(const t of s.values()){const e=this.GetTimelineByName(t);e&&(yield e)}s.clear()}else{const e=this.GetTimelineByName(t);e&&(yield e)}}*GetTimelinesByTags(t){for(const e of this._timelines)e.HasTags(t)&&(yield e)}AddScheduledTimeline(t){this._scheduledTimelines.includes(t)||this._scheduledTimelines.push(t),this._MaybeEnableRuntimeListeners()}RemovePlayingTimeline(t){lg.arrayFindRemove(this._playingTimelines,t),this._MaybeDisableRuntimeListeners()}ScheduleTimeline(t){this._playingTimelines.includes(t)?(t.SetPlaying(!0),t.SetScheduled(!1),t.SetMarkedForRemoval(!1)):(t.SetPlaying(!1),t.SetScheduled(!0),t.SetMarkedForRemoval(!1),this._scheduledTimelines.includes(t)||this._scheduledTimelines.push(t)),this._MaybeEnableRuntimeListeners()}DeScheduleTimeline(t){t.SetPlaying(!1),t.SetScheduled(!1),t.ResolvePlayPromise(),lg.arrayFindRemove(this._scheduledTimelines,t),this._MaybeDisableRuntimeListeners()}CompleteTimeline(t){t.SetPlaying(!1),t.SetScheduled(!1),this._playingTimelines.includes(t)&&(t.SetMarkedForRemoval(!0),this._markedForRemovalTimelines.push(t),lg.arrayFindRemove(this._playingTimelines,t)),this._scheduledTimelines.includes(t)&&t.SetMarkedForRemoval(!0)}CompleteTimelineBeforeChangeOfLayout(t){t.SetPlaying(!1),t.SetScheduled(!1),t.SetMarkedForRemoval(!1),t.SetPlaybackRate(1),lg.arrayFindRemove(this._playingTimelines,t)}CompleteTimelineAndResolve(t){this.CompleteTimeline(t),t.ResolvePlayPromise()}_OnTick(){const t=this.GetRuntime();if(t.IsLoadingState())return;if(!this._hasRuntimeListeners)return;if(this._changingLayout)return;let e=0;for(t.IsDebug()&&(e=performance.now()),this._isTickingTimelines=!0;this._scheduledTimelines.length;){const t=this._scheduledTimelines.pop();t.IsMarkedForRemoval()?(t.SetInitialStateForce(),this._markedForRemovalTimelines.push(t)):(t.SetInitialState(),this._playingTimelines.push(t)),0!==t.GetRenderChange()&&(this._renderChange=1)}const s=this._runtime._GetDtFast(),i=this._runtime.GetDt1(),r=this._runtime.GetTimeScale();for(let t=this._playingTimelines.length-1;t>=0;t--){const e=this._playingTimelines[t];e&&e.Tick(s,r,i)}this._isTickingTimelines=!1,t.IsDebug()&&globalThis.C3Debugger.AddTweensAndTimelinesTime(performance.now()-e),0!==this._renderChange&&t.UpdateRender()}_OnTick2(){const t=this.GetRuntime();if(t.IsLoadingState())return;if(!this._hasRuntimeListeners)return;if(this._changingLayout)return;let e,s=0;t.IsDebug()&&(s=performance.now());for(let t=0,s=this._markedForRemovalTimelines.length;t<s;t++){const s=this._markedForRemovalTimelines[t];e||(e=new Set),s.Removed(),this._MaybeExecuteTimelineFinishTriggers(s),e.add(s)}if(e){lg.arrayRemoveAllInSet(this._markedForRemovalTimelines,e),this._renderChange=0;for(let t=0,e=this._playingTimelines.length;t<e;t++)if(0!==this._playingTimelines[t].GetRenderChange()){this._renderChange=1;break}}this._MaybeDisableRuntimeListeners(),t.IsDebug()&&globalThis.C3Debugger.AddTweensAndTimelinesTime(performance.now()-s)}_MaybeExecuteTimelineFinishTriggers(t){t.IsReleased()||t.HasValidTracks()&&t.IsComplete()&&t.InitialStateSet()&&t.FinishTriggers()}_MaybeEnableRuntimeListeners(){this._hasRuntimeListeners||(this._hasRuntimeListeners=!0)}_MaybeDisableRuntimeListeners(){this._markedForRemovalTimelines.length||this._playingTimelines.length||this._scheduledTimelines.length||this._isTickingTimelines||(this._hasRuntimeListeners=!1)}_OnBeforeChangeLayout(){for(this._changingLayout=!0;this._scheduledTimelines.length;)this.DeScheduleTimeline(this._scheduledTimelines.pop());const t=new Set;for(const e of this._playingTimelines)e._OnBeforeChangeLayout()&&(e.Removed(),t.add(e));lg.arrayRemoveAllInSet(this._playingTimelines,t),t.clear();for(const e of this._markedForRemovalTimelines)e._OnBeforeChangeLayout()&&(e.Removed(),t.add(e));lg.arrayRemoveAllInSet(this._markedForRemovalTimelines,t),this._MaybeDisableRuntimeListeners();for(const t of this._timelines)t.CleanCaches()}_OnAfterChangeLayout(){this._changingLayout=!1}_OnInstanceDestroy(t){const e=t.GetObjectClass(),s=this.GetTimelinesForObjectClass(e);if(s)if(this._runtime.IsLoadingState())this._destroyedWhileLoadingState.push(t);else for(const t of s)t.IsTemplate()||(t.IsReleased()?this.Remove(t):t.HasValidTracks()||(this._MaybeExecuteTimelineFinishTriggers(t),this.Remove(t)))}_OnBeforeLoad(){for(const t of this._scheduledTimelines.map(t=>t))this._MaybeExecuteTimelineFinishTriggers(t),this.Remove(t);for(const t of this._playingTimelines.map(t=>t))this._MaybeExecuteTimelineFinishTriggers(t),this.Remove(t)}_OnAfterLoad(){for(const t of this._destroyedWhileLoadingState)this._OnInstanceDestroy(t);lg.clearArray(this._destroyedWhileLoadingState);for(const t of this._timelines)t._OnAfterLoad()}_OnAfterLayoutStart(){const t=this._runtime.GetLayoutManager().GetMainRunningLayout();if(t)for(const e of this._timelines){const s=e.GetStartOnLayout();s&&t.GetName()===s&&this.ScheduleTimeline(e)}}_SaveToJson(){return{timelinesJson:this._SaveTimelinesToJson(),scheduledTimelinesJson:this._SaveScheduledTimelinesToJson(),playingTimelinesJson:this._SavePlayingTimelinesToJson(),markedForRemovalTimelinesJson:this._SaveMarkedForRemovalTimelinesToJson(),hasRuntimeListeners:this._hasRuntimeListeners,changingLayout:this._changingLayout,isTickingTimelines:this._isTickingTimelines}}_LoadFromJson(t){t&&(this._ClearCreatedTemplateTimelinesCount(),this._LoadTimelinesFromJson(t.timelinesJson),this._LoadScheduledTimelinesFromJson(t.scheduledTimelinesJson),this._LoadPlayingTimelinesFromJson(t.playingTimelinesJson),this._LoadMarkedForRemovalTimelinesFromJson(t.markedForRemovalTimelinesJson),this._hasRuntimeListeners=!t.hasRuntimeListeners,this._changingLayout=!!t.changingLayout,this._isTickingTimelines=!!t.isTickingTimelines,this._SetCreatedTemplateTimelinesCount(),this._MaybeEnableRuntimeListeners(),this._MaybeDisableRuntimeListeners())}_SaveTimelinesToJson(){return this._timelines.map(t=>t._SaveToJson())}_LoadTimelinesFromJson(t){for(const e of t){let t=this.GetTimelineByName(e.name);if(t)t._LoadFromJson(e);else{const s=this._GetTemplateNameFromJson(e);if(!s)continue;const i=this.GetTimelineByName(s);t=this.CreateFromTemplate(i),t._LoadFromJson(e)}t.HasTracks()||this.Remove(t)}}_GetTemplateNameFromJson(t){const e=t.name.split(":");return e&&2===e.length?e[0]:null}_SaveScheduledTimelinesToJson(){return this._SaveTimelines(this._scheduledTimelines)}_LoadScheduledTimelinesFromJson(t){this._LoadTimelines(t,this._scheduledTimelines)}_SavePlayingTimelinesToJson(){return this._SaveTimelines(this._playingTimelines)}_LoadPlayingTimelinesFromJson(t){this._LoadTimelines(t,this._playingTimelines)}_SaveMarkedForRemovalTimelinesToJson(){return this._SaveTimelines(this._markedForRemovalTimelines)}_LoadMarkedForRemovalTimelinesFromJson(t){this._LoadTimelines(t,this._markedForRemovalTimelines)}_IsTimelineInJson(t,e){if(!e)return!1;for(const s of e)if(s===t.GetName())return!0;return!1}_SaveTimelines(t){return t.map(t=>t.GetName())}_LoadTimelines(t,e){const s=new Set;for(const i of e)this._IsTimelineInJson(i,t)||s.add(i);if(lg.arrayRemoveAllInSet(e,s),t){const s=t=>e=>e.GetName()===t;for(const i of t){const t=this.GetTimelineByName(i);t&&(e.find(s(i))||e.push(t))}}}}}{const ug=self.C3,_g=[0,0],dg=[0,0],pg=[0,0],fg=[0,0,0,0,0],gg=new Array(4),mg=[{x:0,y:0,t:0,distance:0},{x:0,y:0,t:0,distance:0},{x:0,y:0,t:0,distance:0}],Sg={x:0,y:0,t:0,distance:0};ug.TimelineInfo=class{constructor(t,e){this._initialized=!1,this._timeline=t,this._segments=[];let s=null;if(s=e?this._timeline.GetTrackById(e):ug.first(this._timeline.GetTracks()),!s)return;const i=s.GetPropertyTrack("offsetX"),r=s.GetPropertyTrack("offsetY");if(!i||!r)return;this._xTrack=i,this._yTrack=r;const n=i.GetPropertyKeyframeDataItemArrayIncludingDisabled(),a=r.GetPropertyKeyframeDataItemArrayIncludingDisabled();for(let t=1,e=Math.min(n.length,a.length);t<e;++t){const e=n[t],s=(e.GetNext(),e.GetPrevious()),i=a[t],r=(i.GetNext(),i.GetPrevious());s&&"cubic-bezier"===s.GetPathMode()&&r&&"cubic-bezier"===r.GetPathMode()?this._segments.push(ug.New(ug.TimelineCubicBezierSegmentInfo,s,r,e,i,this._segments.length)):(s&&"line"===s.GetPathMode()&&r&&r.GetPathMode(),this._segments.push(ug.New(ug.TimelineLineSegmentInfo,e,i,this._segments.length)))}this._initialized=!0}Release(){for(const t of this._segments)t.Release();ug.clearArray(this._segments),this._segments=null,this._timeline=null,this._xTrack=null,this._yTrack=null}WasInitialized(){return this._initialized}segments(){return this._segments}SetOrigin(t){const e="relative"===this._xTrack.GetResultMode()?t.GetX():0,s="relative"===this._yTrack.GetResultMode()?t.GetY():0;for(const t of this._segments)t.SetOrigin(e,s)}Project(t,e,s){let i=NaN,r=this._segments.length;for(let s=0;s<r;s++){const r=this._segments[s];if("cubic-bezier"===r.GetType()){const s=r.Project(t,e);(isNaN(i)||s[3]<i)&&(i=s[3],pg[0]=s[2],pg[1]=r.GetIndex())}}return pg}ProjectWithOptions(t,e,s){const i=s.tRange;ug.IsFiniteNumber(i[0])||(i[0]=0),ug.IsFiniteNumber(i[1])||(i[1]=1);let r=NaN,n=this._segments.length;for(let s=0;s<n;s++){const n=this._segments[s];if("cubic-bezier"===n.GetType()){const s=n.ProjectWithRange(t,e,i);(isNaN(r)||s[3]<r)&&(r=s[3],pg[0]=s[2],pg[1]=n.GetIndex())}}return pg}Tangent(t,e){return this._segments[e].Tangent(t)}TangentAngle(t,e){return this._segments[e].TangentAngle(t)}},ug.TimelineCubicBezierSegmentInfo=class{constructor(t,e,s,i,r){this._index=r;const n=t.GetAddOn("cubic-bezier"),a=s.GetAddOn("cubic-bezier"),o=e.GetAddOn("cubic-bezier"),h=i.GetAddOn("cubic-bezier");this._aX=t.GetValueWithResultMode(),this._aY=e.GetValueWithResultMode(),this._bX=t.GetValueWithResultMode()+n.GetStartAnchor(),this._bY=e.GetValueWithResultMode()+o.GetStartAnchor(),this._cX=s.GetValueWithResultMode()+a.GetEndAnchor(),this._cY=i.GetValueWithResultMode()+h.GetEndAnchor(),this._dX=s.GetValueWithResultMode(),this._dY=i.GetValueWithResultMode(),this._aXO=0,this._aYO=0,this._bXO=0,this._bYO=0,this._cXO=0,this._cYO=0,this._dXO=0,this._dYO=0,this._d0x=0,this._d0y=0,this._d1x=0,this._d1y=0,this._d2x=0,this._d2y=0,this._x1Factor=0,this._x2Factor=0,this._x3Factor=0,this._y1Factor=0,this._y2Factor=0,this._y3Factor=0,this._lutIndex=NaN,this._initialized=!1,this._len=100,this._arcLengths=new Array(this._len+1),this._arcLengths[0]=0,this._length=0,this._lut=[],this._lutObjects=[];for(let t=0;t<100;t++)this._lutObjects.push({x:0,y:0,t:0,distance:0});this._CalculateLength()}Release(){ug.clearArray(this._arcLengths),this._arcLengths=null,ug.clearArray(this._lut),this._lut=null,ug.clearArray(this._lutObjects),this._lutObjects=null}GetType(){return"cubic-bezier"}GetIndex(){return this._index}GetStepCount(){return Math.floor(this._length/25)}GetStepIncrement(){return 1/this.GetStepCount()}SetOrigin(t,e){this._originX=t,this._originY=e,this._arcLengths=new Array(this._len+1),this._arcLengths[0]=0,this._CalculateLength(),this._aXO=this._aX+this._originX,this._aYO=this._aY+this._originY,this._bXO=this._bX+this._originX,this._bYO=this._bY+this._originY,this._cXO=this._cX+this._originX,this._cYO=this._cY+this._originY,this._dXO=this._dX+this._originX,this._dYO=this._dY+this._originY,this._d0x=3*(this._bXO-this._aXO),this._d0y=3*(this._bYO-this._aYO),this._d1x=3*(this._cXO-this._bXO),this._d1y=3*(this._cYO-this._bYO),this._d2x=3*(this._dXO-this._cXO),this._d2y=3*(this._dYO-this._cYO),this._x1Factor=3*(this._bXO-this._aXO),this._x2Factor=3*(this._aXO+this._cXO-2*this._bXO),this._x3Factor=this._dXO-this._aXO+3*(this._bXO-this._cXO),this._y1Factor=3*(this._bYO-this._aYO),this._y2Factor=3*(this._aYO+this._cYO-2*this._bYO),this._y3Factor=this._dYO-this._aYO+3*(this._bYO-this._cYO)}Map(t){if(!this._initialized)return NaN;const e=this._Map(t);return dg[0]=this._X(e),dg[1]=this._Y(e),dg}Project(t,e){const s=this._GenerateLUT(100),i=this._FindClosestFromLUT(t,e,s),r=this._RefineProjection(t,e,s,i);return fg[0]=r.x,fg[1]=r.y,fg[2]=r.t,fg[3]=r.distance,fg}ProjectWithRange(t,e,s){const i=this._GenerateLUT(100),r=this._FindClosestFromLUTWithRange(t,e,i,s),n=this._RefineProjection(t,e,i,r);return fg[0]=n.x,fg[1]=n.y,fg[2]=n.t,fg[3]=n.distance,fg}Tangent(t){const e=1-t,s=e*e,i=2*e*t,r=t*t,n=s*this._d0x+i*this._d1x+r*this._d2x,a=s*this._d0y+i*this._d1y+r*this._d2y,o=ug.hypot2DFast(n,a);return _g[0]=n/o,_g[1]=a/o,_g}TangentAngle(t){const e=1-t,s=e*e,i=2*e*t,r=t*t,n=s*this._d0x+i*this._d1x+r*this._d2x,a=s*this._d0y+i*this._d1y+r*this._d2y;return Math.atan2(a,n)}_Map(t){if(!this._initialized)return;let e=t*this._arcLengths[this._len],s=0,i=this._len,r=0;for(;s<i;)r=s+((i-s)/2|0),this._arcLengths[r]<e?s=r+1:i=r;this._arcLengths[r]>e&&r--;const n=this._arcLengths[r];return n===e?r/this._len:(r+(e-n)/(this._arcLengths[r+1]-n))/this._len}_X(t){return this._initialized?self.Ease.GetRuntimeEase("cubicbezier")(t,this._aX+this._originX,this._bX+this._originX,this._cX+this._originX,this._dX+this._originX):NaN}_Y(t){return this._initialized?self.Ease.GetRuntimeEase("cubicbezier")(t,this._aY+this._originY,this._bY+this._originY,this._cY+this._originY,this._dY+this._originY):NaN}_GenerateLUT(t){if(t=t||100,this._lut.length>=t)return this._lut;this._lut=new Array(t),t++;for(let e=0;e<t-1;e++){const s=e/(t-1),i=s**2,r=s**3,n=this._x1Factor*s,a=this._x2Factor*i,o=this._x3Factor*r,h=this._y1Factor*s,l=this._y2Factor*i,c=this._y3Factor*r,u=this._aXO+n+a+o,_=this._aYO+h+l+c;this._lutObjects[e].x=u,this._lutObjects[e].y=_,this._lutObjects[e].t=s,this._lutObjects[e].distance=0,this._lut[e]=this._lutObjects[e]}return this._lut}_FindClosestFromLUT(t,e,s,i=null,r=Number.MAX_SAFE_INTEGER){let n=0;if(isNaN(this._lutIndex))for(let i=0;i<100;i++){const a=s[i],o=a.x-t,h=a.y-e;a.distance=o*o+h*h,a.distance<r&&(r=a.distance,n=i)}else{for(let i=this._lutIndex;i<this._lutIndex+5&&!(i>=s.length);i++){const a=s[i],o=a.x-t,h=a.y-e;a.distance=o*o+h*h,a.distance<r&&(r=a.distance,n=i)}for(let i=this._lutIndex;i>this._lutIndex-5&&!(i<0);i--){const a=s[i],o=a.x-t,h=a.y-e;a.distance=o*o+h*h,a.distance<r&&(r=a.distance,n=i)}}return this._lutIndex=n,n}_FindClosestFromLUTWithRange(t,e,s,i,r=Number.MAX_SAFE_INTEGER){let n=0;if(isNaN(this._lutIndex))for(let a=0;a<100;a++){const o=s[a],h=o.x-t,l=o.y-e;o.distance=h*h+l*l,o.t>=i[0]&&o.t<=i[1]&&o.distance<r&&(r=o.distance,n=a)}else{for(let a=this._lutIndex;a<this._lutIndex+5&&!(a>=s.length);a++){const o=s[a],h=o.x-t,l=o.y-e;o.distance=h*h+l*l,o.t>=i[0]&&o.t<=i[1]&&o.distance<r&&(r=o.distance,n=a)}for(let a=this._lutIndex;a>this._lutIndex-5&&!(a<0);a--){const o=s[a],h=o.x-t,l=o.y-e;o.distance=h*h+l*l,o.t>=i[0]&&o.t<=i[1]&&o.distance<r&&(r=o.distance,n=a)}}return this._lutIndex=n,n}_RefineProjection(t,e,s,i){let r=s[i],n=1,a=Number.MAX_SAFE_INTEGER;t:do{const n=s.length;let o=0===i?0:i-1,h=i===n-1?n-1:i+1,l=s[o].t,c=(s[h].t-l)/4;if(c<.001)break;gg[0]=s[o];for(let s=1;s<=2;s++){const n=l+s*c,o=n**2,h=n**3,u=this._x1Factor*n,_=this._x2Factor*o,d=this._x3Factor*h,p=this._y1Factor*n,f=this._y2Factor*o,g=this._y3Factor*h,m=this._aXO+u+_+d,S=this._aYO+p+f+g,y=m-t,G=S-e,T=y*y+G*G;if(T<a){a=T,i=s,Sg.x=m,Sg.y=S,Sg.t=n,Sg.distance=T,r=Sg;break t}const I=mg[s-1];I.x=m,I.y=S,I.t=n,I.distance=T,gg[s]=I}gg[3]=s[h],s=gg}while(n++<20);return r}_CalculateLength(){this._initialized=!0;let t=this._X(0),e=this._Y(0),s=0;for(let i=1;i<=this._len;i++){const r=this._X(.01*i),n=this._Y(.01*i),a=t-r,o=e-n;s+=ug.hypot2DFast(a,o),this._arcLengths[i]=s,t=r,e=n}this._length=s}},ug.TimelineLineSegmentInfo=class{constructor(t,e,s){this._index=s,this._targetX=t.GetValueWithResultMode(),this._targetY=e.GetValueWithResultMode(),this._originX=0,this._originY=0}Release(){}GetType(){return"line"}GetIndex(){return this._index}SetOrigin(t,e){this._originX=t,this._originY=e}GetX(){return this._targetX+this._originX}GetY(){return this._targetY+this._originY}}}{const yg=self.C3;yg.TimelineState=class extends yg.DefendedBase{constructor(t,e,s){super(),this._runtime=s.GetRuntime(),this._timelineManager=s,this._timelineDataItem=e,this._name=t,this._tracks=[],this._tracksLength=0,this._beforeAndAfterTracks=null,this._beforeAndAfterTracksLength=0,this.CreateTrackStates(),this._playPromise=null,this._playResolve=null,this._playheadTime=0,this._overshoot=0,this._playbackRate=1,this._pingPongState=0,this._resumePingPongState=-1,this._currentRepeatCount=1,this._isPlaying=!1,this._isScheduled=!1,this._initialStateSet=!1,this._complete=!0,this._released=!1,this._markedForRemoval=!1,this._completedTick=-1,this._implicitPause=!1,this._isTemplate=!1,this._finishedTriggers=!1,this._firstTick=!1,this._lastDelta=NaN,this._tags=[""],this._stringTags="",this._tagsChanged=!1,this._renderChange=0,this._hasNestedContent=0,this._stoppedKeyframeDataItem=null,this._iTimelineState=null}static CreateInitial(t,e){const s=e.GetTimelineDataManager(),i=s.GetNameId(),r=s.Get(t[i]),n=yg.New(yg.TimelineState,t[i],r,e);return n.SetIsTemplate(!0),n}static CreateFromTemplate(t,e,s){return yg.New(yg.TimelineState,t,e,s)}Release(){if(this.IsReleased())return;const t=this._runtime.Dispatcher();this._timelineManager.DeScheduleTimeline(this),this._timelineManager.CompleteTimelineAndResolve(this);for(const t of this._tracks)t.Release();yg.clearArray(this._tracks),this._tracks=null,this._runtime=null,this._timelineManager=null,this._timelineDataItem=null,this._released=!0,this._playPromise=null,this._playResolve=null,this.FireReleaseEvent(t)}FireReleaseEvent(t){const e=yg.New(yg.Event,"timelinestatereleased");e.timelineState=this,t.dispatchEvent(e)}GetType(){return 0}CreateTrackStates(){for(const t of this._timelineDataItem.GetTrackData().trackDataItems())this._tracksLength=this._tracks.push(yg.TrackState.Create(this,t))}GetTimelineManager(){return this._timelineManager}GetRuntime(){return this._runtime}GetTracks(){return this._tracks}GetSimilarPropertyTracks(t,e,s,i){if(!this._hasNestedContent)return;let r;for(let n=0;n<this._tracks.length;n++){let a=this._tracks[n];if(t!==a.GetInstance())continue;const o=a.GetPropertyTrack(s);o&&e.constructor===o.GetSourceAdapter().constructor&&o.GetResultMode()===i.GetResultMode()&&(r||(r=[]),r.push(o))}return r}HasTracks(){return!!this._tracks.length}GetTrackById(t){for(const e of this._tracks)if(yg.equalsNoCase(e.GetId(),t))return e;return null}GetTrackByName(t){for(const e of this._tracks)if(!e.IsInstanceTrack()&&yg.equalsNoCase(e.GetName(),t))return e;return null}SetName(t){this._name=t}GetName(){return this._name}GetTimelineDataItem(){return this._timelineDataItem}GetTemplateName(){return this._timelineDataItem.GetName()}GetTotalTime(){return this._timelineDataItem.GetTotalTime()}SetTotalTime(t){this._timelineDataItem.SetTotalTime(t)}GetStep(){return this._timelineDataItem.GetStep()}SetStep(t){this._timelineDataItem.SetStep(t)}GetInterpolationMode(){return this._timelineDataItem.GetInterpolationMode()}SetInterpolationMode(t){this._timelineDataItem.SetInterpolationMode(t)}GetResultMode(){return this._timelineDataItem.GetResultMode()}SetResultMode(t){this._timelineDataItem.GetResultMode(t)}SetEase(t){for(const e of this.GetTracks())e.SetEase(t)}GetLoop(){return this._timelineDataItem.GetLoop()}SetLoop(t){return this._timelineDataItem.SetLoop(t)}GetPingPong(){return this._timelineDataItem.GetPingPong()}SetPingPong(t){return this._timelineDataItem.SetPingPong(t)}GetRepeatCount(){return this._timelineDataItem.GetRepeatCount()}GetCurrentRepeatCount(){return this._currentRepeatCount}SetRepeatCount(t){return this._timelineDataItem.SetRepeatCount(t)}SetPlaybackRate(t){if(t=Number(t),yg.IsFiniteNumber(t))return this._playbackRate=t}GetPlaybackRate(){return this._playbackRate}GetStartOnLayout(){return this._timelineDataItem.GetStartOnLayout()}GetTransformWithSceneGraph(){return this._timelineDataItem.GetTransformWithSceneGraph()}GetUseSystemTimescale(){return this._timelineDataItem.GetUseSystemTimescale()}GetPingPongState(){return this._pingPongState}IsForwardPlayBack(){return!this.IsPlaying()||this._playbackRate>0}GetStatus(){return this.IsPlaying()?"playing":this.IsPaused()?"paused":this.IsComplete()?"complete":"other"}GetPlayPromise(){return this._playPromise||(this._playPromise=new Promise(t=>{this._playResolve=t})),this._playPromise}ResolvePlayPromise(){this._playPromise&&(this._playResolve(),this._playPromise=null,this._playResolve=null)}SetTags(t){this._tags=yg.TimelineState._GetTagArray(t),this._tagsChanged=!0}GetTags(){return this._tags}GetStringTags(){return this._tagsChanged&&(this._stringTags=this._tags.join(" ")),this._tagsChanged=!1,this._stringTags}HasTags(t){if(!this._tags)return!1;if(!this._tags.length)return!1;const e=yg.TimelineState._GetTagArray(t);return!!e&&!!e.length&&e.every(yg.TimelineState._HasTag,this)}OnStarted(){yg.Plugins.Timeline&&this.constructor===yg.TimelineState&&(yg.Plugins.Timeline.Cnds.PushTriggerTimeline(this),this._timelineManager.Trigger(yg.Plugins.Timeline.Cnds.OnTimelineStarted),this._timelineManager.Trigger(yg.Plugins.Timeline.Cnds.OnTimelineStartedByName),this._timelineManager.Trigger(yg.Plugins.Timeline.Cnds.OnTimelineStartedByTags),this._timelineManager.Trigger(yg.Plugins.Timeline.Cnds.OnAnyTimelineStarted),yg.Plugins.Timeline.Cnds.PopTriggerTimeline())}OnCompleted(){this._completedTick=this._runtime.GetTickCount()}FinishTriggers(){this._finishedTriggers||(this._finishedTriggers=!0,yg.Plugins.Timeline&&this.constructor===yg.TimelineState&&(yg.Plugins.Timeline.Cnds.PushTriggerTimeline(this),this._timelineManager.Trigger(yg.Plugins.Timeline.Cnds.OnTimelineFinished),this._timelineManager.Trigger(yg.Plugins.Timeline.Cnds.OnTimelineFinishedByName),this._timelineManager.Trigger(yg.Plugins.Timeline.Cnds.OnTimelineFinishedByTags),this._timelineManager.Trigger(yg.Plugins.Timeline.Cnds.OnAnyTimelineFinished),yg.Plugins.Timeline.Cnds.PopTriggerTimeline()))}SetPlaying(t){this._isPlaying=t}IsCompletedTick(){return this._completedTick===this._runtime.GetTickCount()}IsPlaying(t=!1){return!!this.IsCompletedTick()||!(!this.IsScheduled()||t)||this._isPlaying}_IsPlaying(){return this.IsPlaying(!0)}IsPaused(){return this._IsPaused()}_IsPaused(){return!(this.IsReleased()||this.IsScheduled()||this._IsPlaying()||this.IsComplete())}SetScheduled(t){this._isScheduled=t}IsScheduled(){return this._isScheduled}SetComplete(t){this._complete=t;const e=this.GetLoop(),s=this.GetPingPong();if(e||s){if(e&&!s);else if(!e&&s){const t=this.GetTime();1===this._pingPongState&&(t<=0||t>=this.GetTotalTime())&&(this._complete=!0)}}else{const t=this.GetTime();(t<=0||t>=this.GetTotalTime())&&(this._complete=!0)}}IsComplete(){return this._complete}IsReleased(){return this._released}SetMarkedForRemoval(t){this._markedForRemoval=t}IsMarkedForRemoval(){return this._markedForRemoval}SetImplicitPause(t){this._implicitPause=t}IsImplicitPause(){return this._implicitPause}SetIsTemplate(t){this._isTemplate=!!t}IsTemplate(){return this._isTemplate}InitialStateSet(){return this._initialStateSet}GetTime(){return this._playheadTime}SetTime(t){if(t=Number(t),!yg.IsFiniteNumber(t))return;const e=this.GetTime();this._SetTime(t),this.SetComplete(!1),this.IsComplete()||this.SetImplicitPause(!0),(this._IsPlaying()||this.IsScheduled()||!this._initialStateSet)&&(this._IsPlaying()||this.IsScheduled()||this._initialStateSet?this._IsPlaying()?this.Stop():this.IsScheduled()&&(this._timelineManager.DeScheduleTimeline(this),this.SetInitialStateFromSetTime()):this.SetInitialStateFromSetTime()),this._SetUpdateStateBefore(),this._Interpolate(this.GetTime(),!1,!0,!0,e),this._SetUpdateStateAfter(),this._renderChange&&this.GetRuntime().UpdateRender(),this._OnSetTime()}_SetTime(t){yg.IsFiniteNumber(t)||(t=this.GetTotalTime()),t<0?this._playheadTime=0:t>=this.GetTotalTime()?this._playheadTime=this.GetTotalTime():this._playheadTime=t}_SetTimeAndReset(t){yg.IsFiniteNumber(t)||(t=this.GetTotalTime()),t<0?this._playheadTime=0:t>=this.GetTotalTime()?this._playheadTime=this.GetTotalTime():this._playheadTime=t;for(const t of this._tracks)t.SetResetState()}_OnSetTime(){yg.Plugins.Timeline&&this.constructor===yg.TimelineState&&(yg.Plugins.Timeline.Cnds.PushTriggerTimeline(this),this._timelineManager.Trigger(yg.Plugins.Timeline.Cnds.OnTimeSet),this._timelineManager.Trigger(yg.Plugins.Timeline.Cnds.OnTimeSetByName),this._timelineManager.Trigger(yg.Plugins.Timeline.Cnds.OnTimeSetByTags),yg.Plugins.Timeline.Cnds.PopTriggerTimeline())}_CanResume(){if(this.GetLoop())return!0;if(this.GetPingPong()&&1===this._pingPongState){if(this.IsForwardPlayBack()){if(this.GetTime()>=this.GetTotalTime())return!1}else if(this.GetTime()<=0)return!1}else if(!this.GetLoop()&&!this.GetPingPong())if(this.IsForwardPlayBack()){if(this.GetTime()>=this.GetTotalTime())return!1}else if(this.GetTime()<=0)return!1;return!0}Resume(){this.IsReleased()||this._CanResume()&&this.Play(!0)}Play(t=!1){return!this.IsReleased()&&!this.IsScheduled()&&(this._IsPlaying()&&this.IsCompletedTick()?this._SchedulePlayingTimeline():!this._IsPlaying()&&!!(this.IsComplete()||t||this.IsImplicitPause())&&this._ScheduleStoppedTimeline())}_SchedulePlayingTimeline(){return this.SetImplicitPause(!1),this._timelineManager.RemovePlayingTimeline(this),this._timelineManager.ScheduleTimeline(this),this.GetPlayPromise(),!0}_ScheduleStoppedTimeline(){return this.SetImplicitPause(!1),this._timelineManager.ScheduleTimeline(this),this.GetPlayPromise(),!0}Stop(t=!1){this.IsReleased()||(this.SetComplete(t),this._timelineManager.CompleteTimeline(this),this.IsComplete()&&this.ResolvePlayPromise())}Reset(t=!0,e=!1){if(this.IsReleased())return;if(!this._IsPlaying()&&this.IsScheduled())return this._timelineManager.DeScheduleTimeline(this);if(this.IsComplete())return;this.Stop(!0),this.IsForwardPlayBack()?this._SetTime(0):this._SetTime(this.GetTotalTime());const s=this.GetTime();this._SetUpdateStateBefore(),e?this._InterpolateBeforeChangeLayout(s):this._Interpolate(s,!1,!1,!0),t&&this._OnSetTime(),this._SetUpdateStateAfter(),this._renderChange&&t&&this.GetRuntime().UpdateRender()}ResetBeforeChangeLayout(){this.Reset(!1,!0)}_InterpolateBeforeChangeLayout(t){this._Interpolate(t,!1,!1,!0,NaN,!1,!0)}_OnBeforeChangeLayout(){return!!this.IsReleased()||!(!this.GetRuntime().IsLoadingState()&&this.HasValidGlobalTracks())&&(this._timelineManager.CompleteTimelineBeforeChangeOfLayout(this),this.GetRuntime().IsLoadingState()||this.ResetBeforeChangeLayout(),!0)}SetInitialStateFromSetTime(){this.SetInitialState(!0)}SetInitialStateForce(){this.SetInitialState(!1,!0),this.SetPlaying(!1),this.SetScheduled(!1)}SetInitialState(t=!1,e=!1){if(!this.IsMarkedForRemoval()||e)if(t){this._finishedTriggers=!1,this._initialStateSet=!0,this._firstTick=!0,this._SetUpdateStateBefore();for(const t of this._tracks)t.SetInitialState();this._SetUpdateStateAfter()}else if(this.SetPlaying(!0),this.SetScheduled(!1),this.OnStarted(),this.IsComplete()){this._completedTick=-1,0!==this._pingPongState&&(this._playbackRate=Math.abs(this._playbackRate)),this._pingPongState=0,this._resumePingPongState=-1,this._currentRepeatCount=1,this._complete=!1,this._finishedTriggers=!1,this._initialStateSet=!0,this._firstTick=!0,this.IsForwardPlayBack()?this._SetTime(0):this._SetTime(this.GetTotalTime()),this._SetUpdateStateBefore();for(const t of this._tracks)t.SetInitialState();this._SetUpdateStateAfter()}else{-1!==this._resumePingPongState&&(this._pingPongState=this._resumePingPongState),this._firstTick=!0,this._finishedTriggers=!1,this._SetUpdateStateBefore();for(const t of this._tracks)t.SetResumeState();this._SetUpdateStateAfter()}}GetRenderChange(){return this._renderChange}_SetUpdateStateBefore(){this._hasNestedContent=0;for(const t of this._tracks)t.IsNested()&&(this._hasNestedContent=1)}_SetUpdateStateAfter(){this._renderChange=0;for(const t of this._tracks)t._SetUpdateState(),0===this._renderChange&&1===t.GetRenderChange()&&(this._renderChange=1),this._beforeAndAfterTracks||1!==t.GetNeedsBeforeAndAfter()||(this._beforeAndAfterTracks||(this._beforeAndAfterTracks=[]),this._beforeAndAfterTracksLength=this._beforeAndAfterTracks.push(t))}Tick(t,e,s){if(this.GetUseSystemTimescale()){if(0===t&&0===this._lastDelta)return;this._lastDelta=t,t=s}else{if(0===s&&0===this._lastDelta)return;this._lastDelta=s,t=s,e=1}const i=this._playheadTime+this._overshoot,r=i+t*e*this._playbackRate,n=this._timelineDataItem._totalTime;r<0?(this._playheadTime=0,this._overshoot=-r):r>=n?(this._playheadTime=n,this._overshoot=this._playheadTime-r):(this._playheadTime=r,this._overshoot=0);let a=!1,o=!1;const h=this.GetLoop(),l=this.GetPingPong();let c;h||l?h&&!l?this._playbackRate>0?this._playheadTime>=n&&(this._SetTimeAndReset(0),o=!0):this._playheadTime<=0&&(this._SetTimeAndReset(n),o=!0):!h&&l?this._playbackRate>0?this._playheadTime>=n&&(this._SetTime(n),this.SetPlaybackRate(-1*this.GetPlaybackRate()),o=!0,1===this._pingPongState?this._currentRepeatCount<this.GetRepeatCount()?(this._currentRepeatCount++,this._pingPongState=0):a=!0:0===this._pingPongState&&(this._pingPongState=1)):this._playheadTime<=0&&(this._SetTime(0),this.SetPlaybackRate(-1*this.GetPlaybackRate()),o=!0,1===this._pingPongState?this._currentRepeatCount<this.GetRepeatCount()?(this._currentRepeatCount++,this._pingPongState=0):a=!0:0===this._pingPongState&&(this._pingPongState=1)):h&&l&&(this._playbackRate>0?this._playheadTime>=n&&(this._SetTime(n),this.SetPlaybackRate(-1*this.GetPlaybackRate()),o=!0,this._pingPongState++,yg.wrap(this._pingPongState,0,2)):this._playheadTime<=0&&(this._SetTime(0),this.SetPlaybackRate(-1*this.GetPlaybackRate()),o=!0,this._pingPongState++,yg.wrap(this._pingPongState,0,2))):this._playbackRate>0?this._playheadTime>=n&&(this._currentRepeatCount<this.GetRepeatCount()?(this._currentRepeatCount++,this._SetTimeAndReset(0),o=!0):(this._SetTime(n),a=!0)):this._playheadTime<=0&&(this._currentRepeatCount<this.GetRepeatCount()?(this._currentRepeatCount++,this._SetTimeAndReset(n),o=!0):(this._SetTime(0),a=!0));const u=this._tracksLength;if(a){for(c=0;c<u;c++)this._tracks[c].SetEndState();return this.Stop(!0),void this.OnCompleted()}const _=this._beforeAndAfterTracksLength;for(c=0;c<_;c++){const t=this._beforeAndAfterTracks[c],e=t.GetStartOffset();this._playheadTime-e<0&&i-e>0?t.BeforeInterpolate(e):t.BeforeInterpolate(this._playheadTime)}if(1===this._hasNestedContent)for(c=0;c<u;c++){const t=this._tracks[c],e=t.GetStartOffset();this._playheadTime-e<0&&i-e>0?t.Interpolate(e,!0,!1,o,this._firstTick,!1):t.Interpolate(this._playheadTime,!0,!1,o,this._firstTick,!1)}else for(c=0;c<u;c++)this._tracks[c].Interpolate(this._playheadTime,!0,!1,o,this._firstTick,!1);if(!this.IsPlaying()&&this._stoppedKeyframeDataItem){const t=this._stoppedKeyframeDataItem.GetTime()+this._stoppedKeyframeDataItem.GetKeyframeData().GetTrackDataItem().GetStartOffset(),e=this._playheadTime-t;this._playheadTime-=e,0!==this._overshoot&&(this._overshoot-=e),this._stoppedKeyframeDataItem=null}for(c=0;c<_;c++){const t=this._beforeAndAfterTracks[c],e=t.GetStartOffset();this._playheadTime-e<0&&i-e>0?t.AfterInterpolate(e):t.AfterInterpolate(this._playheadTime)}this._firstTick&&(this._firstTick=!1)}SetStoppedOnKeyframe(t){this._stoppedKeyframeDataItem=t}GetStoppedOnKeyframe(){return this._stoppedKeyframeDataItem}_GetTrackStartTime(t,e,s,i=!1){let r=t;if("number"==typeof e&&!isNaN(e)){const t=this.GetTime()-s.GetStartOffset(),n=e-s.GetStartOffset();t<0&&n>0&&(r=s.GetStartOffset(),i&&this._SetTime(r))}return r}_Interpolate(t,e=!1,s=!1,i=!1,r=NaN,n=!1,a=!1){for(const e of this._tracks){const i=this._GetTrackStartTime(t,r,e);e.BeforeInterpolate(i,s)}for(const n of this._tracks){const o=this._GetTrackStartTime(t,r,n,!0);n.Interpolate(o,e,s,i,this._firstTick,a)}for(const e of this._tracks){const i=this._GetTrackStartTime(t,r,e);e.AfterInterpolate(i,s)}this._firstTick&&n&&(this._firstTick=!1)}AddTrack(){const t=this._timelineDataItem.GetTrackData().AddEmptyTrackDataItem(),e=yg.TrackState.Create(this,t);return this._tracksLength=this._tracks.push(e),e}Removed(){if(!this.IsReleased())for(const t of this._tracks)t.TimelineRemoved()}CleanCaches(){for(const t of this._tracks)t.CleanCaches()}*GetInstances(){for(const t of this._tracks)t.GetInstance()&&(yield t.GetInstance())}ClearTrackInstances(){for(const t of this._tracks)t.ClearInstance()}SetTrackInstance(t,e,s){if(e){if("number"==typeof s&&s>=0){const t=this._tracks[s];if(!t)return;return t.SetInstance(e),void this._timelineManager.SetTimelineObjectClassToMap(e.GetObjectClass(),this)}for(const s of this._tracks)if(s.IsInstanceTrack()){if(t){if(s.GetId()!==t)continue;s.SetInstance(e),this._timelineManager.SetTimelineObjectClassToMap(e.GetObjectClass(),this);break}if(!s.HasInstance()){s.SetInstance(e),this._timelineManager.SetTimelineObjectClassToMap(e.GetObjectClass(),this);break}}}}HasTrackInstance(t,e){for(const s of this._tracks)if(s.IsInstanceTrack())if(e){if(e===s.GetId()&&t===s.GetInstance())return!0}else if(t===s.GetInstance())return!0;return!1}HasValidTracks(){return this._tracks.some(t=>!t.IsInstanceTrack()||t.CanInstanceBeValid())}HasValidGlobalTracks(){return this._tracks.some(t=>{if(t.IsInstanceTrack()){if(!t.CanInstanceBeValid())return!1;const e=t.GetObjectClass();return!!e&&e.IsGlobal()}return!1})}GetPropertyTrack(t){for(const e of this.GetTracks())for(const s of e.GetPropertyTracks())if(s.GetPropertyName()===t)return s}GetTrackFromInstance(t){for(const e of this._tracks)if(t===e.GetInstance())return e;return null}GetKeyframeWithTags(t){let e=t?t.split(" "):[];const s=new Set(e.map(t=>t.toLowerCase().trim()));e=[...s.values()];for(const t of this.GetTracks())for(const s of t.GetKeyframeDataItems())if(e.every(t=>s.HasTag(t)))return s}GetObjectClasses(){const t=[];for(const e of this.GetTracks())t.push(e.GetObjectClass());return t.filter(t=>t)}_OnAfterLoad(){for(const t of this.GetTracks())t._OnAfterLoad()}_SaveToJson(){return{tracksJson:this._SaveTracksToJson(),name:this._name,playheadTime:this.GetTime(),playbackRate:this._playbackRate,pingPongState:this._pingPongState,resumePingPongState:this._resumePingPongState,currentRepeatCount:this._currentRepeatCount,isPlaying:this._isPlaying,isScheduled:this._isScheduled,initialStateSet:this._initialStateSet,finishedTriggers:this._finishedTriggers,complete:this._complete,released:this._released,markedForRemoval:this._markedForRemoval,completedTick:this._completedTick,implicitPause:this._implicitPause,isTemplate:this._isTemplate,tags:this._tags.join(" "),stringTags:this._stringTags,tagsChanged:this._tagsChanged,firstTick:this._firstTick}}_LoadFromJson(t){t&&(this._LoadTracksFromJson(t.tracksJson),this._name=t.name,this._playheadTime=t.playheadTime,this._playbackRate=t.playbackRate,this._pingPongState=t.pingPongState,this._resumePingPongState=t.hasOwnProperty("resumePingPongState")?t.resumePingPongState:-1,this._currentRepeatCount=t.currentRepeatCount,this._isPlaying=!!t.isPlaying,this._isScheduled=!!t.isScheduled,this._initialStateSet=!!t.initialStateSet,this._finishedTriggers=!!t.hasOwnProperty("finishedTriggers")&&!!t.finishedTriggers,this._complete=!!t.complete,this._released=!!t.released,this._markedForRemoval=!!t.markedForRemoval,this._completedTick=t.completedTick,this._implicitPause=!!t.implicitPause,this._isTemplate=!!t.isTemplate,this._tags=t.tags.split(" "),this._stringTags=t.stringTags,this._tagsChanged=!!t.tagsChanged,this._firstTick=!!t.firstTick)}_SaveTracksToJson(){return this._tracks.map(t=>t._SaveToJson())}_LoadTracksFromJson(t){this.ClearTrackInstances(),t.forEach((t,e)=>{this._tracks[e]._LoadFromJson(t)}),this._tracks.filter(t=>t.CanInstanceBeValid())}static _HasTag(t){const e=this.GetTags();return""===t?1===e.length&&""===e[0]:e.map(t=>t.toLowerCase()).includes(t.toLowerCase())}static _GetTagArray(t){if(yg.IsArray(t))return t.slice(0);if(yg.IsString(t))return t.split(" ");throw new Error("invalid tags")}GetITimelineState(){return this._iTimelineState||(this._iTimelineState=yg.New(self.ITimelineState,this)),this._iTimelineState}}}{const Gg=self.C3;Gg.TrackState=class extends Gg.DefendedBase{constructor(t,e){super(),this._timeline=t,this._trackDataItem=e,this._trackData=e.GetTrackData(),this._instanceUid=NaN,this._objectClassIndex=NaN,this._instance=null,this._worldInfo=null,this._cleared=!1,this._isNested=e.GetStartOffset()>0,this._initialStateOfNestedSet=!1,this._endStateOfNestedSet=!1,this._instanceUidToLoad=NaN,this._lastKeyframeDataItem=null,this._keyframeDataItems=this._trackDataItem.GetKeyframeData().GetKeyframeDataItemArray(),this._propertyTracks=[],this.CreatePropertyTrackStates(),this._worldInfoChange=0,this._renderChange=0,this._needsBeforeAndAfter=0,this._keyframeReachedOnCurrentTick=null}static Create(t,e){return Gg.New(Gg.TrackState,t,e)}Release(){this._keyframeDataItems=null;for(const t of this._propertyTracks)t.Release();Gg.clearArray(this._propertyTracks),this._propertyTracks=null,this._timeline=null,this._instance=null,this._worldInfo=null,this._trackDataItem=null,this._lastKeyframeDataItem=null}CreatePropertyTrackStates(){for(const t of this._trackDataItem.GetPropertyTrackData().propertyTrackDataItems())this._propertyTracks.push(Gg.PropertyTrackState.Create(this,t))}TimelineRemoved(){for(const t of this._propertyTracks)t.TimelineRemoved()}CleanCaches(){for(const t of this._propertyTracks)t.CleanCaches();this._instance=null,this._worldInfo=null}GetTimeline(){return this._timeline}GetRuntime(){return this._timeline.GetRuntime()}GetKeyframeDataItems(){return this._keyframeDataItems||(this._keyframeDataItems=this._trackDataItem.GetKeyframeData().GetKeyframeDataItemArray()),this._keyframeDataItems}GetPropertyTracks(){return this._propertyTracks}GetPropertyTrack(t){for(let e=0;e<this._propertyTracks.length;e++){const s=this._propertyTracks[e];if(s.GetPropertyName()===t)return s}}MaybeGetInstance(){this._instance||this.GetInstance()}IsInstanceValid(){return!!this._instance&&!this._instance.IsDestroyed()}CanInstanceBeValid(){if(!this.IsInstanceTrack())return!1;if(this._cleared)return!1;const t=this.GetInstanceUID(),e=this.GetRuntime().GetInstanceByUID(t);return!!e&&!e.IsDestroyed()}GetObjectClass(){if(!this.IsInstanceTrack())return;const t=this.GetObjectClassIndex();return-1!==t?this.GetRuntime().GetObjectClassByIndex(t):void 0}GetTrackIndexInTimeline(){return this._timeline.GetTracks().indexOf(this)}ClearInstance(){this._instance=null,this._instanceUid=NaN,this._worldInfo=null,this._objectClassIndex=NaN,this._cleared=!0}HasInstance(){return!!this._instance}GetInstance(){if(this._cleared)return;if(this._instance&&this.IsInstanceValid())return this._instance;const t=this.GetInstanceUID();return this._instance=this.GetRuntime().GetInstanceByUID(t),this._instance}SetInstance(t){if(this._cleared=!1,this._instance!==t){this.CleanCaches(),this._instance=t,this._objectClassIndex=t.GetObjectClass().GetIndex(),this._instanceUid=t.GetUID(),this._worldInfo=t.GetWorldInfo();for(const e of this.propertyTrackItems()){const s=e.propertyTrack,i=e.sourceAdapter;switch(s.GetSourceAdapterId()){case"instance-variable":{i.GetEditorIndex();const s=t.GetObjectClass(),r=s.GetInstanceVariableIndexByName(e.name),n=s.GetInstanceVariableName(r),a=s.GetInstanceVariableType(r);n===e.name&&a===e.type&&i.UpdateInstanceVariableIndex(r);break}case"behavior":{const s=e.behaviorType,r=this.GetObjectClass(),n=t.GetObjectClass(),a=i.GetBehaviorType(n);if(s&&a){const t=s.GetName();r.GetBehaviorIndexByName(t),n.GetBehaviorIndexByName(t),i.GetEditorIndex(),i.UpdateBehaviorTypeSid(a.GetSID())}break}}}}}*propertyTrackItems(){for(const t of this._propertyTracks){const e=t.GetSourceAdapter(),s=this.GetObjectClass(),i={propertyTrack:t,sourceAdapter:e};switch(t.GetSourceAdapterId()){case"world-instance":i.property=t.GetPropertyName();break;case"instance-variable":{const t=e.GetEditorIndex();i.name=s.GetInstanceVariableName(t),i.type=s.GetInstanceVariableType(t);break}case"effect":{const t=s.GetEffectList(),r=e.GetEffectType(t);i.effectType=r;break}case"behavior":{const t=e.GetBehaviorType(s);i.behaviorType=t;break}case"plugin":i.plugin=s.GetPlugin()}yield i}}GetWorldInfo(){if(this._worldInfo&&this.IsInstanceValid())return this._worldInfo;const t=this.GetInstance();return t&&(this._worldInfo=t.GetWorldInfo()),this._worldInfo}GetTrackDataItem(){return this._trackDataItem}GetInstanceUID(){return isNaN(this._instanceUid)?this._trackDataItem.GetInstanceUID():this._instanceUid}SetInstanceUID(t){this._trackDataItem.SetInstanceUID(t)}GetInterpolationMode(){return this._trackDataItem.GetInterpolationMode()}SetInterpolationMode(t){this._trackDataItem.SetInterpolationMode(t)}GetResultMode(){return this._trackDataItem.GetResultMode()}GetId(){return this._trackDataItem.GetId()}GetStartOffset(){return this._trackDataItem.GetStartOffset()}GetLocalTotalTime(){return this._trackDataItem.GetLocalTotalTime()}SetLocalTotalTime(t){this._trackDataItem.SetLocalTotalTime(t)}SetResultMode(t){this._trackDataItem.SetResultMode(t)}SetEase(t){for(const e of this.GetKeyframeDataItems())e.SetEase(t);for(const e of this.GetPropertyTracks())e.SetEase(t)}GetEnable(){return this._trackDataItem.GetEnable()}SetEnable(t){this._trackDataItem.SetEnable(t)}GetObjectClassIndex(){return isNaN(this._objectClassIndex)?this._trackDataItem.GetObjectClassIndex():this._objectClassIndex}SetObjectClassIndex(t){this._trackDataItem.SetObjectClassIndex(t)}SetOriginalWidth(t){this._trackDataItem.SetOriginalWidth(t)}GetOriginalWidth(){const t=this.GetInstance();return t&&t.GetSdkInstance().IsOriginalSizeKnown()?t.GetSdkInstance().GetOriginalWidth():this._trackDataItem.GetOriginalWidth()}SetOriginalHeight(t){this._trackDataItem.SetOriginalHeight(t)}GetOriginalHeight(){const t=this.GetInstance();return t&&t.GetSdkInstance().IsOriginalSizeKnown()?t.GetSdkInstance().GetOriginalHeight():this._trackDataItem.GetOriginalHeight()}GetType(){return this._trackDataItem.GetType()}GetName(){return this._trackDataItem.GetName()}IsInstanceTrack(){return 0===this.GetType()}IsValueTrack(){return 1===this.GetType()}IsAudioTrack(){return 2===this.GetType()}GetWorldInfoChange(){return this._worldInfoChange}GetRenderChange(){return this._renderChange}GetNeedsBeforeAndAfter(){return this._needsBeforeAndAfter}IsNested(){return this._isNested}SetResetState(){for(const t of this._propertyTracks)t.SetResetState();const t=this.GetTimeline(),e=t.GetTime();t.IsForwardPlayBack()?this._lastKeyframeDataItem=this._GetLastKeyFrameBeforeTime(e):this._lastKeyframeDataItem=this._GetFirstKeyFrameAfterTime(e)}SetInitialState(){if(this.MaybeGetInstance(),!this.IsInstanceValid()&&this.IsInstanceTrack())return;const t=this.GetTimeline().IsForwardPlayBack(),e=t?0:this.GetLocalTotalTime();for(const t of this._propertyTracks)t.SetInitialState(e),0===this._worldInfoChange&&1===t.GetWorldInfoChange()&&(this._worldInfoChange=1),0===this._renderChange&&1===t.GetRenderChange()&&(this._renderChange=1);this._needsBeforeAndAfter=0,this._propertyTracks.some(t=>t.GetNeedsBeforeAndAfter())&&(this._needsBeforeAndAfter=1),this._lastKeyframeDataItem=t?this._GetLastKeyFrameBeforeTime(e):this._GetFirstKeyFrameAfterTime(e),this._initialStateOfNestedSet=!1,this._endStateOfNestedSet=!1,this.Interpolate(e),this.OnInitialKeyframeReached(this._lastKeyframeDataItem)}GetCurrentKeyframeInterval(){const t=this.GetLastKeyframe(),e=this.GetNextKeyframe();let s,i;return this._timeline.IsForwardPlayBack()?(s={GetTime:()=>t.GetTime()+this.GetStartOffset(),GetTags:()=>t.GetTagsString()||"<no tags>"},i={GetTime:()=>e?e.GetTime()+this.GetStartOffset():this.GetLocalTotalTime(),GetTags:()=>e?.GetTagsString()||"<no tags>"}):(s={GetTime:()=>e?e.GetTime()+this.GetStartOffset():this.GetLocalTotalTime(),GetTags:()=>e?.GetTagsString()||"<no tags>"},i={GetTime:()=>t.GetTime()+this.GetStartOffset(),GetTags:()=>t.GetTagsString()||"<no tags>"}),[s,i]}GetLastKeyframe(){const t=this._timeline.GetTime()-this.GetStartOffset();return this._timeline.IsForwardPlayBack()?this._GetLastKeyFrameBeforeTime(t):this._GetFirstKeyFrameAfterTime(t)}GetNextKeyframe(){return this._timeline.IsForwardPlayBack()?this.GetLastKeyframe().GetNext():this.GetLastKeyframe().GetLast()}SetResumeState(){if(this.MaybeGetInstance(),!this.IsInstanceValid()&&this.IsInstanceTrack())return;const t=this._timeline.IsForwardPlayBack(),e=this._timeline.GetTime()-this.GetStartOffset();this._lastKeyframeDataItem=t?this._GetLastKeyFrameBeforeTime(e):this._GetFirstKeyFrameAfterTime(e);for(const t of this._propertyTracks)t.SetResumeState(e)}SetEndState(){if(!this.GetTimeline().IsComplete()&&(this.MaybeGetInstance(),(this.IsInstanceValid()||!this.IsInstanceTrack())&&!this._isNested)){const t=this._timeline.GetTime();t>=this.GetStartOffset()+this.GetLocalTotalTime()?this.Interpolate(this.GetLocalTotalTime(),!0,!1,!0,!1,!1,!0):t<=0&&this.Interpolate(0,!0,!1,!0,!1,!1,!0)}}_SetUpdateState(){for(let t=0,e=this._propertyTracks.length;t<e;t++){const e=this._propertyTracks[t];e._SetUpdateState(),0===this._worldInfoChange&&1===e.GetWorldInfoChange()&&(this._worldInfoChange=1),0===this._renderChange&&1===e.GetRenderChange()&&(this._renderChange=1)}}BeforeInterpolate(t,e=!1){const s=this._propertyTracks.length;for(let i=0;i<s;i++)this._propertyTracks[i].BeforeInterpolate(t,e)}Interpolate(t,e=!1,s=!1,i=!1,r=!1,n=!1,a=!1){this._instance||this.GetInstance();const o=this._instance&&!this._instance.IsDestroyed(),h=0===this._trackDataItem._type;if((o||!h)&&!(n&&h&&this.GetObjectClass().IsGlobal()||(t-=this.GetStartOffset())<0)){this.MaybeSetInitialStateOfNestedTrack(t,e),this.MaybeTriggerKeyframeReachedConditions(t,e,r),!this.GetTimeline().IsPlaying()&&this.GetTimeline().GetStoppedOnKeyframe()&&(t=this.GetTimeline().GetStoppedOnKeyframe().GetTime());for(let e=0,r=this._propertyTracks.length;e<r;e++)this._propertyTracks[e].Interpolate(t,s,i,a);this.MaybeSetEndStateOfNestedTrack(t,e),0!==this._worldInfoChange&&(this._worldInfo||(this._worldInfo=this._instance.GetWorldInfo()),this._worldInfo&&this._worldInfo.SetBboxChanged())}}AfterInterpolate(t,e=!1){const s=this._propertyTracks.length;for(let i=0;i<s;i++)this._propertyTracks[i].AfterInterpolate(t,e)}MaybeSetInitialStateOfNestedTrack(t,e){if(e&&this._isNested&&!this._initialStateOfNestedSet){if(this.GetTimeline().IsForwardPlayBack()){if(t<0)return}else if(t>this.GetLocalTotalTime())return;for(const t of this._propertyTracks)t.SetInitialState();this._initialStateOfNestedSet=!0}}MaybeSetEndStateOfNestedTrack(t,e){if(e&&this._isNested&&!this._endStateOfNestedSet)if(this.GetTimeline().IsForwardPlayBack()){if(t>=this.GetLocalTotalTime()){for(const t of this._propertyTracks)t.Interpolate(this.GetLocalTotalTime(),!1,!0);this._endStateOfNestedSet=!0}}else if(t<=0){for(const t of this._propertyTracks)t.Interpolate(0,!1,!0);this._endStateOfNestedSet=!0}}MaybeTriggerKeyframeReachedConditions(t,e,s){if(this._keyframeReachedOnCurrentTick=null,s)return;if(!e)return;if(!Gg.Plugins.Timeline)return;const i=this.GetTimeline();if(i.IsForwardPlayBack()){const e=this._lastKeyframeDataItem.GetNext(),s=this._lastKeyframeDataItem.GetTime(),r=e?e.GetTime():i.GetTotalTime();(t<=s||t>=r)&&(this._lastKeyframeDataItem=this._trackData.GetFirstKeyFrameDataItemLowerOrEqualThan(t,this._trackDataItem),e&&this.OnKeyframeReached(this._lastKeyframeDataItem))}else{if(!this._trackData.GetFirstKeyFrameDataItemHigherOrEqualThan(t,this._trackDataItem))return;this._lastKeyframeDataItem||(this._lastKeyframeDataItem=this._trackData.GetFirstKeyFrameDataItemHigherOrEqualThan(t,this._trackDataItem));const e=this._lastKeyframeDataItem.GetLast(),s=this._lastKeyframeDataItem.GetTime(),i=e?e.GetTime():0;(t>=s||t<=i)&&(this._lastKeyframeDataItem=this._trackData.GetFirstKeyFrameDataItemHigherOrEqualThan(t,this._trackDataItem),this._lastKeyframeDataItem&&this.OnKeyframeReached(this._lastKeyframeDataItem))}}_GetLastKeyFrameBeforeTime(t){return this._trackData.GetKeyFrameDataItemAtTime(t,this._trackDataItem)||this._trackData.GetFirstKeyFrameDataItemLowerOrEqualThan(t,this._trackDataItem)}_GetFirstKeyFrameAfterTime(t){return this._trackData.GetKeyFrameDataItemAtTime(t,this._trackDataItem)||this._trackData.GetFirstKeyFrameDataItemHigherOrEqualThan(t,this._trackDataItem)}OnKeyframeReached(t,e=!1){if(!Gg.Plugins.Timeline)return;const s=this.GetTimeline(),i=s.GetTimelineManager();Gg.Plugins.Timeline.Cnds.PushTriggerTimeline(s),Gg.Plugins.Timeline.Cnds.PushTriggerKeyframe(t),i.Trigger(Gg.Plugins.Timeline.Cnds.OnAnyKeyframeReached),i.Trigger(Gg.Plugins.Timeline.Cnds.OnKeyframeReached),s.IsPlaying()||e||s.SetStoppedOnKeyframe(t),Gg.Plugins.Timeline.Cnds.PopTriggerTimeline(s),Gg.Plugins.Timeline.Cnds.PopTriggerKeyframe(t),this._keyframeReachedOnCurrentTick=t}WasKeyframeReachedOnCurrentTick(){return this._keyframeReachedOnCurrentTick}OnInitialKeyframeReached(t){this.OnKeyframeReached(t,!0)}AddKeyframe(){return this._trackDataItem.GetKeyframeData().AddEmptyKeyframeDataItem()}AddPropertyTrack(){const t=this._trackDataItem.GetPropertyTrackData().AddEmptyPropertyTrackDataItem(),e=Gg.PropertyTrackState.Create(this,t);return this._propertyTracks.push(e),e}DeleteKeyframes(t){this._trackDataItem.GetKeyframeData().DeleteKeyframeDataItems(t)}DeletePropertyKeyframes(t){for(const e of this._propertyTracks)e.DeletePropertyKeyframes(t)}SaveState(){for(const t of this._propertyTracks)t.SaveState()}CompareInitialStateWithCurrent(){if(this.MaybeGetInstance(),this.IsInstanceValid()||!this.IsInstanceTrack())for(const t of this._propertyTracks)t.CompareInitialStateWithCurrent()}CompareSaveStateWithCurrent(){if(this.MaybeGetInstance(),!this.IsInstanceValid()&&this.IsInstanceTrack())return;let t=!1;for(const e of this._propertyTracks){const s=e.CompareSaveStateWithCurrent();!t&&s&&(t=!0)}if(t){const t=this.AddKeyframe();t.SetTime(this.GetTimeline().GetTime()),t.SetEase("noease"),t.SetEnable(!0),t.SetTags("")}}_OnAfterLoad(){isNaN(this._instanceUidToLoad)||this._LoadInstanceFromJson(this._instanceUidToLoad),this._instanceUidToLoad=NaN}_SaveToJson(){const t=this.GetInstance(),e=t?t.GetUID():this.GetInstanceUID();return{propertyTracksJson:this._SavePropertyTracksToJson(),lastKeyframeDataItemJson:this._SaveLastKeyframeDataItemToJson(),initialStateOfNestedSet:this._initialStateOfNestedSet,endStateOfNestedSet:this._endStateOfNestedSet,instanceUid:e,cleared:this._cleared}}_LoadFromJson(t){if(t){this._LoadPropertyTracksFromJson(t.propertyTracksJson),this._LoadLastKeyframeDataItemFromJson(t.lastKeyframeDataItemJson),this._instanceUidToLoad=t.instanceUid,this._initialStateOfNestedSet=!1,t.hasOwnProperty.initialStateOfNestedSet&&(this._initialStateOfNestedSet=t.initialStateOfNestedSet),this._endStateOfNestedSet=!1,t.hasOwnProperty.endStateOfNestedSet&&(this._endStateOfNestedSet=t.endStateOfNestedSet),this._cleared=!!t.hasOwnProperty("cleared")&&t.cleared;for(const t of this._propertyTracks)0===this._worldInfoChange&&1===t.GetWorldInfoChange()&&(this._worldInfoChange=1),0===this._renderChange&&1===t.GetRenderChange()&&(this._renderChange=1);this._needsBeforeAndAfter=0,this._propertyTracks.some(t=>t.GetNeedsBeforeAndAfter())&&(this._needsBeforeAndAfter=1)}}_SaveLastKeyframeDataItemToJson(){return this._trackDataItem.GetKeyframeData().GetKeyframeDataItemIndex(this._lastKeyframeDataItem)}_SavePropertyTracksToJson(){return this._propertyTracks.map(t=>t._SaveToJson())}_LoadPropertyTracksFromJson(t){t.forEach((t,e)=>{this._propertyTracks[e]._LoadFromJson(t)})}_LoadInstanceFromJson(t){if(!Gg.IsFiniteNumber(t))return;const e=this.GetRuntime().GetInstanceByUID(t);e&&this.GetTimeline().SetTrackInstance(this._trackDataItem.GetId(),e,this.GetTrackIndexInTimeline())}_LoadLastKeyframeDataItemFromJson(t){const e=this._trackDataItem.GetKeyframeData();this._lastKeyframeDataItem=e.GetKeyframeDataItemFromIndex(t)}}}{const Tg=self.C3;Tg.PropertyTrackState=class extends Tg.DefendedBase{constructor(t,e){super(),this._track=t,this._propertyTrackDataItem=e,this._propertyTrackData=e.GetPropertyTrackData(),this._worldInfoChange=0,this._renderChange=0,this._needsBeforeAndAfter=0,this._sourceAdapter=this.GetSourceAdapter(),this._propertyKeyframeDataItems=this._propertyTrackDataItem.GetPropertyKeyframeData().GetPropertyKeyframeDataItemArray(),this._lastPropertyKeyframeDataItem=null,this._absoluteValueObject=null}static Create(t,e){return Tg.New(Tg.PropertyTrackState,t,e)}Release(){this._track=null,this._sourceAdapter&&(this._sourceAdapter.Release(),this._sourceAdapter=null),this._propertyKeyframeDataItems=null,this._propertyTrackDataItem=null,this._propertyTrackData=null}GetWorldInfoChange(){return this._worldInfoChange}GetRenderChange(){return this._renderChange}GetNeedsBeforeAndAfter(){return this._needsBeforeAndAfter}HasAbsoluteValueObject(){return!!this._absoluteValueObject}SetAbsoluteValueObject(t){this._absoluteValueObject=t}GetAbsoluteValueObject(){return this._absoluteValueObject}GetTrack(){return this._track}GetPropertyTrackDataItem(){return this._propertyTrackDataItem}GetPropertyTrackData(){return this._propertyTrackData}GetTimeline(){return this._track.GetTimeline()}GetRuntime(){return this._track.GetRuntime()}GetInstance(){return this._track.GetInstance()}GetSourceAdapter(){if(this._sourceAdapter)return this._sourceAdapter;let t;switch(this._propertyTrackDataItem.GetSourceAdapterId()){case"behavior":t=new Tg.PropertyTrackState.BehaviorSourceAdapter(this);break;case"effect":t=new Tg.PropertyTrackState.EffectSourceAdapter(this),this._renderChange=1;break;case"instance-variable":t=new Tg.PropertyTrackState.InstanceVariableSourceAdapter(this);break;case"plugin":t=new Tg.PropertyTrackState.PluginSourceAdapter(this),this._renderChange=1;break;case"world-instance":t=new Tg.PropertyTrackState.PropertySourceAdapter(this),this._renderChange=1,this._worldInfoChange=1;break;case"value":t=new Tg.PropertyTrackState.ValueSourceAdapter(this);break;case"audio":t=new Tg.PropertyTrackState.AudioSourceAdapter(this)}return this._sourceAdapter=t,this._sourceAdapter}GetSourceAdapterId(){return this._propertyTrackDataItem.GetSourceAdapterId()}SetSourceAdapterId(t){this._propertyTrackDataItem.SetSourceAdapterId(t)}GetSourceAdapterArgs(){return this._propertyTrackDataItem.GetSourceAdapterArguments()}SetSourceAdapterArgs(t){this._propertyTrackDataItem.SetSourceAdapterArguments(t)}GetSourceAdapterValue(){return this.GetSourceAdapter().GetValue()}GetPropertyName(){return this._propertyTrackDataItem.GetProperty()}SetPropertyName(t){this._propertyTrackDataItem.SetProperty(t)}GetPropertyType(){return this._propertyTrackDataItem.GetType()}SetPropertyType(t){this._propertyTrackDataItem.SetType(t)}GetPropertyKeyframeType(){return this.GetPropertyTrackData().GetFirstPropertyKeyframeDataItem(this._propertyTrackDataItem).GetType()}GetMin(){return this._propertyTrackDataItem.GetMin()}SetMin(t){this._propertyTrackDataItem.SetMin(t)}GetMax(){return this._propertyTrackDataItem.GetMax()}SetMax(t){this._propertyTrackDataItem.SetMax(t)}GetEnable(){return this._propertyTrackDataItem.GetEnable()}SetEnable(t){this._propertyTrackDataItem.SetEnable(t)}GetInterpolationMode(){return this._propertyTrackDataItem.GetInterpolationMode()}SetInterpolationMode(t){this._propertyTrackDataItem.SetInterpolationMode(t)}GetResultMode(){return this._propertyTrackDataItem.GetResultMode()}SetResultMode(t){this._propertyTrackDataItem.SetResultMode(t)}SetEase(t){for(const e of this.GetPropertyKeyframeDataItems())e.SetEase(t)}CanHavePropertyKeyframes(){return this._propertyTrackDataItem.CanHavePropertyKeyframes()}GetPropertyKeyframeDataItems(){return this._propertyKeyframeDataItems||(this._propertyKeyframeDataItems=this._propertyTrackDataItem.GetPropertyKeyframeData().GetPropertyKeyframeDataItemArray()),this._propertyKeyframeDataItems}GetPropertyKeyframeDataItemArrayIncludingDisabled(){return this._propertyTrackDataItem.GetPropertyKeyframeData().GetPropertyKeyframeDataItemArrayIncludingDisabled()}GetPropertyKeyFrameDataItemAtTime(t){return this._propertyTrackData.GetPropertyKeyFrameDataItemAtTime(t,this._propertyTrackDataItem)}GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(t){return this._propertyTrackData.GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(t,this._propertyTrackDataItem)}GetPropertyKeyframeDataItemPairForTime(t){let e,s=this._propertyTrackData.GetPropertyKeyFrameDataItemAtTime(t,this._propertyTrackDataItem);return s?e=this._propertyTrackData.GetFirstPropertyKeyFrameDataItemHigherThan(t,this._propertyTrackDataItem):(s=this._propertyTrackData.GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(t,this._propertyTrackDataItem),e=this._propertyTrackData.GetFirstPropertyKeyFrameDataItemHigherOrEqualThan(t,this._propertyTrackDataItem)),{start:s,end:e}}*GetPropertyKeyframeValues(){for(const t of this.GetPropertyKeyframeDataItems())yield t.GetValueWithResultMode()}*GetPropertyKeyframeTimes(){for(const t of this.GetPropertyKeyframeDataItems())yield t.GetTime()}TimelineRemoved(){this.GetSourceAdapter().TimelineRemoved()}CleanCaches(){this.GetSourceAdapter().CleanCaches()}GetCurrentState(){return this.GetSourceAdapter().GetCurrentState()}SetResetState(){this.GetSourceAdapter().SetResetState()}SetInitialState(t){this.GetSourceAdapter().SetInitialState(),this._lastPropertyKeyframeDataItem=this._GetLastPropertyKeyFrameBeforeTime(t),this._SetUpdateState()}SetResumeState(t){this.GetSourceAdapter().SetResumeState(),this._lastPropertyKeyframeDataItem=this._GetLastPropertyKeyFrameBeforeTime(t)}_SetUpdateState(){const t=this.GetTrack();if(this._needsBeforeAndAfter=0,t.IsInstanceTrack()){const e=this.GetTimeline(),s=t.GetInstance(),i=this.GetSourceAdapter(),r=this.GetPropertyName();if(i.MayNeedBeforeAndAfterInterpolate()){const t=e.GetSimilarPropertyTracks(s,i,r,this);t&&t.length&&(this._needsBeforeAndAfter=1)}else this._needsBeforeAndAfter=0}}_GetLastPropertyKeyFrameBeforeTime(t){const e=this.GetTimeline();return this._propertyTrackData.GetPropertyKeyFrameDataItemAtTime(t,this._propertyTrackDataItem)||(e.IsForwardPlayBack()?this._propertyTrackData.GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(t,this._propertyTrackDataItem):this._propertyTrackData.GetFirstPropertyKeyFrameDataItemHigherOrEqualThan(t,this._propertyTrackDataItem))}BeforeInterpolate(t,e){let s,i;if(e)s=this._propertyTrackData.GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(t,this._propertyTrackDataItem);else{if(this._lastPropertyKeyframeDataItem){const e=this.GetTimeline(),s=this._lastPropertyKeyframeDataItem.GetNext(),i=this._lastPropertyKeyframeDataItem.GetTime(),r=s?s.GetTime():e.GetTotalTime();(t<=i||t>=r)&&(this._lastPropertyKeyframeDataItem=this._propertyTrackData.GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(t,this._propertyTrackDataItem))}else this._lastPropertyKeyframeDataItem=this._propertyTrackData.GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(t,this._propertyTrackDataItem);s=this._lastPropertyKeyframeDataItem}s&&(i=s.GetNext()),this._sourceAdapter.BeforeInterpolate(s,i)}Interpolate(t,e=!1,s=!1,i=!1){let r,n,a=!1;if(e)r=this._propertyTrackData.GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(t,this._propertyTrackDataItem);else{if(this._lastPropertyKeyframeDataItem){const e=this.GetTimeline(),s=this._lastPropertyKeyframeDataItem.GetNext(),i=this._lastPropertyKeyframeDataItem.GetTime(),r=s?s.GetTime():e.GetTotalTime();(t<=i||t>=r)&&(this._lastPropertyKeyframeDataItem=this._propertyTrackData.GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(t,this._propertyTrackDataItem),a=!0)}else this._lastPropertyKeyframeDataItem=this._propertyTrackData.GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(t,this._propertyTrackDataItem),a=!0;r=this._lastPropertyKeyframeDataItem}r&&(n=r.GetNext()),this._sourceAdapter.Interpolate(t,r,n,e,s,i,a)}GetInterpolatedValue(t){if(this._lastPropertyKeyframeDataItem){const e=this.GetTimeline(),s=this._lastPropertyKeyframeDataItem.GetNext(),i=this._lastPropertyKeyframeDataItem.GetTime(),r=s?s.GetTime():e.GetTotalTime();(t<=i||t>=r)&&(this._lastPropertyKeyframeDataItem=this._propertyTrackData.GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(t,this._propertyTrackDataItem))}else this._lastPropertyKeyframeDataItem=this._propertyTrackData.GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(t,this._propertyTrackDataItem);const e=this._lastPropertyKeyframeDataItem,s=e.GetNext();return this._sourceAdapter.GetInterpolatedValue(t,e,s)}GetInterpolatedValueFast(t,e,s){return this._sourceAdapter.GetInterpolatedValue(t,e,s)}AfterInterpolate(t,e){let s,i;if(e)s=this._propertyTrackData.GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(t,this._propertyTrackDataItem);else{if(this._lastPropertyKeyframeDataItem){const e=this.GetTimeline(),s=this._lastPropertyKeyframeDataItem.GetNext(),i=this._lastPropertyKeyframeDataItem.GetTime(),r=s?s.GetTime():e.GetTotalTime();(t<=i||t>=r)&&(this._lastPropertyKeyframeDataItem=this._propertyTrackData.GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(t,this._propertyTrackDataItem))}else this._lastPropertyKeyframeDataItem=this._propertyTrackData.GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(t,this._propertyTrackDataItem);s=this._lastPropertyKeyframeDataItem}s&&(i=s.GetNext()),this._sourceAdapter.AfterInterpolate(s,i)}static GetStartPropertyKeyframeForTime(t,e){const s=e.GetPropertyTrackDataItem();return e._propertyTrackData.GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(t,s)}static GetEndPropertyKeyframeForTime(t,e){const s=e.GetPropertyTrackDataItem();return e._propertyTrackData.GetFirstPropertyKeyFrameDataItemHigherOrEqualThan(t,s)}static GetPropertyKeyframeValueWithPlaybackDirection(t,e,s){return e?s.GetTimeline().IsForwardPlayBack()?t.GetValueWithResultMode():e.GetValueWithResultMode():t.GetValueWithResultMode()}AddPropertyKeyframe(){const t=this._propertyTrackDataItem.GetPropertyKeyframeData().AddEmptyPropertyKeyframeDataItem();return this._lastPropertyKeyframeDataItem=null,t}DeletePropertyKeyframes(t){this._lastPropertyKeyframeDataItem=null,this._propertyTrackDataItem.GetPropertyKeyframeData().DeletePropertyKeyframeDataItems(t)}SaveState(){this.GetSourceAdapter().SaveState()}CompareInitialStateWithCurrent(){if(this.GetSourceAdapter().CompareInitialStateWithCurrent()){const t=this._propertyTrackData.GetFirstPropertyKeyframeDataItem(this._propertyTrackDataItem),e=this.GetSourceAdapter().GetCurrentState();t.SetAbsoluteValue(e)}}CompareSaveStateWithCurrent(){const t=this.GetSourceAdapter().CompareSaveStateWithCurrent();return t&&this.AddPropertyKeyframeAtCurrentTime(),this.GetSourceAdapter().ClearSaveState(),t}AddPropertyKeyframeAtCurrentTime(){const t=this.GetTimeline().GetTime(),e=this.GetSourceAdapter(),s=Tg.PropertyTrackState.GetStartPropertyKeyframeForTime(t,this),i=this.AddPropertyKeyframe();i.SetType(s.GetType()),i.SetTime(t),i.SetEase(s.GetEase()),i.SetEnable(!0),i.SetValue(e.GetValueAtTime()),i.SetAbsoluteValue(e.GetCurrentState())}_SaveToJson(){return{sourceAdapterJson:this.GetSourceAdapter()._SaveToJson()}}_LoadFromJson(t){t&&this.GetSourceAdapter()._LoadFromJson(t.sourceAdapterJson)}}}{const Ig=self.C3.PropertyTrackState;Ig.PropertySourceAdapter=class{constructor(t){this._propertyTrack=t,this._propertyAdapter=null,this.GetPropertyAdapter()}Release(){this._propertyAdapter&&(this._propertyAdapter.Release(),this._propertyAdapter=null),this._propertyTrack=null}MayNeedBeforeAndAfterInterpolate(){return this._propertyAdapter.MayNeedBeforeAndAfterInterpolate()}GetPropertyTrack(){return this._propertyTrack}TimelineRemoved(){this._propertyAdapter&&this._propertyAdapter.TimelineRemoved()}CleanCaches(){this._propertyAdapter&&this._propertyAdapter.CleanCaches()}GetPropertyAdapter(){return this._propertyAdapter||(this._propertyAdapter=this._CreatePropertyAdapter()),this._propertyAdapter}GetEditorIndex(){}GetIndex(){return this.GetEditorIndex()}GetTarget(){}SetResetState(){this.GetPropertyAdapter().SetResetState()}SetInitialState(){this.GetPropertyAdapter().SetInitialState()}SetResumeState(){this.GetPropertyAdapter().SetResumeState()}BeforeInterpolate(t,e){this._propertyAdapter.BeforeChangeProperty(t,e)}Interpolate(t,e,s,i,r,n,a){let o;switch(this._propertyTrack.GetPropertyKeyframeType()){case"numeric":o=Ig.NumericTypeAdapter.Interpolate(t,e,s,this._propertyTrack);break;case"angle":o=Ig.AngleTypeAdapter.Interpolate(t,e,s,this._propertyTrack);break;case"boolean":o=Ig.BooleanTypeAdapter.Interpolate(t,e,s,this._propertyTrack);break;case"color":o=Ig.ColorTypeAdapter.Interpolate(t,e,s,this._propertyTrack);break;case"text":o=Ig.TextTypeAdapter.Interpolate(t,e,s,this._propertyTrack)}this._propertyAdapter.ChangeProperty(t,o,e,s,i,r,n,a)}GetInterpolatedValue(t,e,s){switch(this._propertyTrack.GetPropertyKeyframeType()){case"numeric":return Ig.NumericTypeAdapter.Interpolate(t,e,s,this._propertyTrack);case"angle":return Ig.AngleTypeAdapter.Interpolate(t,e,s,this._propertyTrack);case"boolean":return Ig.BooleanTypeAdapter.Interpolate(t,e,s,this._propertyTrack);case"color":return Ig.ColorTypeAdapter.Interpolate(t,e,s,this._propertyTrack);case"text":return Ig.TextTypeAdapter.Interpolate(t,e,s,this._propertyTrack)}}AfterInterpolate(t,e){this._propertyAdapter.AfterChangeProperty(t,e)}SaveState(){this.GetPropertyAdapter().SetSaveState()}ClearSaveState(){this.GetPropertyAdapter().ClearSaveState()}GetCurrentState(){return this.GetPropertyAdapter().GetCurrentState()}CompareInitialStateWithCurrent(){return this.GetPropertyAdapter().CompareInitialStateWithCurrent()}CompareSaveStateWithCurrent(){return this.GetPropertyAdapter().CompareSaveStateWithCurrent()}GetValueAtTime(){const t=this._propertyTrack,e=t.GetTrack().GetTimeline().GetTime(),s=Ig.GetStartPropertyKeyframeForTime(e,t),i=s.GetNext();switch(t.GetPropertyKeyframeType()){case"numeric":return Ig.NumericTypeAdapter.Interpolate(e,s,i,t);case"angle":return Ig.AngleTypeAdapter.Interpolate(e,s,i,t);case"boolean":return Ig.BooleanTypeAdapter.Interpolate(e,s,i,t);case"color":return Ig.ColorTypeAdapter.Interpolate(e,s,i,t);case"text":return Ig.TextTypeAdapter.Interpolate(e,s,i,t)}}_CreatePropertyAdapter(){const t=this._propertyTrack;switch(t.CanHavePropertyKeyframes()?t.GetPropertyKeyframeType():""){case"combo":case"boolean":case"text":case"string":return new Ig.PropertyInterpolationAdapter.NoInterpolationAdapter(this);case"numeric":case"number":case"angle":return"combo"===this._propertyTrack.GetPropertyType()?new Ig.PropertyInterpolationAdapter.NoInterpolationAdapter(this):new Ig.PropertyInterpolationAdapter.NumericInterpolationAdapter(this);case"color":case"offsetColor":return new Ig.PropertyInterpolationAdapter.ColorInterpolationAdapter(this);default:return new Ig.PropertyInterpolationAdapter.NumericInterpolationAdapter(this)}}_SaveToJson(){return{propertyAdapterJson:this.GetPropertyAdapter()._SaveToJson()}}_LoadFromJson(t){t&&this.GetPropertyAdapter()._LoadFromJson(t.propertyAdapterJson)}}}{const Cg=self.C3;class bg extends Cg.PropertyTrackState.PropertySourceAdapter{constructor(t){super(t),this._updatedIndex=NaN}GetEditorIndex(){return this._propertyTrack.GetPropertyTrackDataItem().GetSourceAdapterArguments()[0]}GetIndex(){return this._updatedIndex?this._updatedIndex:super.GetIndex()}GetTarget(){return this._propertyTrack.GetTrack().GetInstance()}UpdateInstanceVariableIndex(t){this._propertyTrack.GetPropertyTrackDataItem().GetSourceAdapterArguments()[0]!==t&&(this._updatedIndex=t)}Interpolate(t,e,s,i,r,n,a){this.GetPropertyAdapter().CanChange(e.GetValue())&&super.Interpolate(t,e,s,i,r,n,a)}GetInterpolatedValue(t,e,s){if(this.GetPropertyAdapter().CanChange(e.GetValue()))return super.GetInterpolatedValue(t,e,s)}_SaveToJson(){return Object.assign(super._SaveToJson(),{index:this._updatedIndex})}_LoadFromJson(t){t&&(super._LoadFromJson(t),this._updatedIndex=t.index)}}Cg.PropertyTrackState.InstanceVariableSourceAdapter=bg}{const xg=self.C3;class wg extends xg.PropertyTrackState.PropertySourceAdapter{constructor(t){super(t),this._sid=NaN}GetEditorIndex(){return this._propertyTrack.GetPropertyTrackDataItem().GetSourceAdapterArguments()[1]}GetTarget(){const t=this._propertyTrack.GetPropertyTrackDataItem(),e=this._propertyTrack.GetTrack(),s=this._sid?this._sid:t.GetSourceAdapterArguments()[0],i=e.GetInstance(),r=i.GetBehaviorIndexBySID(s);return i.GetBehaviorInstances()[r].GetSdkInstance()}GetBehaviorType(t){const e=this._propertyTrack.GetPropertyTrackDataItem().GetSourceAdapterArguments()[2];return t.GetBehaviorTypeByName(e)}UpdateBehaviorTypeSid(t){this._propertyTrack.GetPropertyTrackDataItem().GetSourceAdapterArguments()[0]!==t&&(this._sid=t)}Interpolate(t,e,s,i,r,n,a){const o=this._propertyTrack.GetTrack().GetInstance();this.GetBehaviorType(o.GetObjectClass())&&super.Interpolate(t,e,s,i,r,n,a)}GetInterpolatedValue(t,e,s){const i=this._propertyTrack.GetTrack().GetInstance();if(this.GetBehaviorType(i.GetObjectClass()))return super.GetInterpolatedValue(t,e,s)}_SaveToJson(){return Object.assign(super._SaveToJson(),{sid:this._sid})}_LoadFromJson(t){t&&(super._LoadFromJson(t),this._sid=t.sid)}}xg.PropertyTrackState.BehaviorSourceAdapter=wg}{const Mg=self.C3;class Pg extends Mg.PropertyTrackState.PropertySourceAdapter{constructor(t){super(t)}GetEditorIndex(){return this._propertyTrack.GetPropertyTrackDataItem().GetSourceAdapterArguments()[1]}GetTarget(){const t=this._propertyTrack.GetTrack().GetWorldInfo().GetInstanceEffectList(),e=t.GetEffectList(),s=this.GetEffectType(e).GetIndex();return t.IsEffectIndexActive(s)?t.GetEffectParametersForIndex(s):null}GetEffectType(t){const e=this._propertyTrack.GetPropertyTrackDataItem().GetSourceAdapterArguments()[0];return t.GetEffectTypeByName(e)}Interpolate(t,e,s,i,r,n,a){this._IsEffectActive()&&super.Interpolate(t,e,s,i,r,n,a)}GetInterpolatedValue(t,e,s){if(this._IsEffectActive())return super.GetInterpolatedValue(t,e,s)}_IsEffectActive(){const t=this._propertyTrack.GetTrack().GetWorldInfo().GetInstanceEffectList(),e=t.GetEffectList(),s=this.GetEffectType(e);if(!s)return;const i=s.GetIndex();return t.IsEffectIndexActive(i)}}Mg.PropertyTrackState.EffectSourceAdapter=Pg}{const vg=self.C3;class Rg extends vg.PropertyTrackState.PropertySourceAdapter{constructor(t){super(t),this._optionalCallbacksRelative=null,this._optionalCallbacksAbsolute=null,this._forceNextChange=!1}GetEditorIndex(){return this._propertyTrack.GetPropertyTrackDataItem().GetSourceAdapterArguments()[0]}GetTarget(){return this._propertyTrack.GetTrack().GetInstance().GetSdkInstance()}Interpolate(t,e,s,i,r,n,a){const o=this._propertyTrack.GetTrack();o.GetObjectClass().GetPlugin()===o.GetInstance().GetObjectClass().GetPlugin()&&super.Interpolate(t,e,s,i,r,n,a)}GetInterpolatedValue(t,e,s){const i=this._propertyTrack.GetTrack();if(i.GetObjectClass().GetPlugin()===i.GetInstance().GetObjectClass().GetPlugin())return super.GetInterpolatedValue(t,e,s)}_IsTimelineChunkDiscreteLike(t,e){if(!e)return!0;if(t?.GetValueWithResultMode()===e?.GetValueWithResultMode())return!0;const s=this._propertyTrack?.GetInterpolationMode();return"discrete"===s}_WasKeyframeReached(t,e,s){const i=t.WasKeyframeReachedOnCurrentTick();return!!i&&(this._propertyTrack.GetTimeline().IsForwardPlayBack()?i.GetTime()===e.GetTime():i.GetTime()===s.GetTime())}SetResetState(){this.GetPropertyAdapter().SetResetState();const t=this._propertyTrack.GetTrack().GetObjectClass().GetPlugin();this._forceNextChange=!1,vg.Plugins.Sprite&&t instanceof vg.Plugins.Sprite&&"initial-animation"===this._propertyTrack.GetPropertyName()&&(this._forceNextChange=!0)}ForceChanges(){const t=this._forceNextChange;return this._forceNextChange=!1,t}GetOptionalCallbacks(t,e){const s=this._propertyTrack.GetTrack(),i=s.GetObjectClass().GetPlugin();if(vg.Plugins.Sprite&&i instanceof vg.Plugins.Sprite&&("initial-frame"===this._propertyTrack.GetPropertyName()||"initial-animation"===this._propertyTrack.GetPropertyName()))switch(this._propertyTrack.GetResultMode()){case"relative":return this._optionalCallbacksRelative?(this._optionalCallbacksRelative.startFrom=t.GetAddOn("initial-animation")?.GetStartFrom()??0,this._optionalCallbacksRelative.keyframeReached=this._WasKeyframeReached(s,t,e),this._optionalCallbacksRelative.isChunkDiscreteLike=this._IsTimelineChunkDiscreteLike(t,e),this._optionalCallbacksRelative):(this._optionalCallbacksRelative={onFrameChange:(t,e,i,r,n)=>{if(e!==r){const i=r/e,n=s.GetPropertyTrack("offsetWidth"),a=s.GetPropertyTrack("offsetScaleX");if(n||a){const o=n?.GetSourceAdapter()?.GetPropertyAdapter(),h=a?.GetSourceAdapter()?.GetPropertyAdapter();if(t.HasParent()&&t.GetTransformWithParentWidth())h&&h.SetOriginalSizeProperty(r),t.SetWidth(this.GetNewWidth(r,e,t,s,o,h));else{const e=r*((t._GetSceneGraphInfo()?._GetStartWidth()??this.GetInstanceOriginalWidth(t,s))/this.GetInstanceOriginalWidth(t,s));h&&h.SetOriginalSizeProperty(r);const n=o?.GetChangeAccumulatorProperty()??0,a=h?.GetChangeAccumulatorProperty()??0;t.SetWidth(e+(n+a*i))}}else t.SetWidth(t.GetWidth()*i)}if(i!==n){const e=n/i,r=s.GetPropertyTrack("offsetHeight"),a=s.GetPropertyTrack("offsetScaleY");if(r||a){const o=r?.GetSourceAdapter()?.GetPropertyAdapter(),h=a?.GetSourceAdapter()?.GetPropertyAdapter();if(t.HasParent()&&t.GetTransformWithParentHeight())h&&h.SetOriginalSizeProperty(n),t.SetHeight(this.GetNewHeight(n,i,t,s,o,h));else{const i=n*((t._GetSceneGraphInfo()?._GetStartHeight()??this.GetInstanceOriginalHeight(t,s))/this.GetInstanceOriginalHeight(t,s));h&&h.SetOriginalSizeProperty(n);const r=o?.GetChangeAccumulatorProperty()??0,a=h?.GetChangeAccumulatorProperty()??0;t.SetHeight(i+(r+a*e))}}else t.SetHeight(t.GetHeight()*e)}},startFrom:t.GetAddOn("initial-animation")?.GetStartFrom()??0,keyframeReached:this._WasKeyframeReached(s,t,e),isChunkDiscreteLike:this._IsTimelineChunkDiscreteLike(t,e)},this._optionalCallbacksRelative);case"absolute":return this._optionalCallbacksAbsolute?(this._optionalCallbacksAbsolute.startFrom=t.GetAddOn("initial-animation")?.GetStartFrom()??0,this._optionalCallbacksAbsolute.keyframeReached=this._WasKeyframeReached(s,t,e),this._optionalCallbacksAbsolute.isChunkDiscreteLike=this._IsTimelineChunkDiscreteLike(t,e),this._optionalCallbacksAbsolute):(this._optionalCallbacksAbsolute={startFrom:t.GetAddOn("initial-animation")?.GetStartFrom()??0,keyframeReached:this._WasKeyframeReached(s,t,e),isChunkDiscreteLike:this._IsTimelineChunkDiscreteLike(t,e)},this._optionalCallbacksAbsolute)}}GetLastPropertyKeyframeValue(t,e,s,i=0){const r=e.GetTimeline().GetTrackFromInstance(t.GetInstance());if(!r)return i;const n=r.GetPropertyTrack(s);if(!n)return i;const a=n.GetPropertyTrackDataItem().GetPropertyKeyframeData();if(!a)return i;const o=a.GetLastPropertyKeyframeDataItem();return o?o.GetValue():i}GetInstanceOriginalWidth(t,e){const s=e.GetTimeline().GetTrackFromInstance(t.GetInstance());if(s)return s.GetOriginalWidth();const i=t.GetInstance().GetSdkInstance();return i.IsOriginalSizeKnown()?i.GetOriginalWidth():t._GetSceneGraphInfo()._GetStartWidth()}GetInstanceOriginalHeight(t,e){const s=e.GetTimeline().GetTrackFromInstance(t.GetInstance());if(s)return s.GetOriginalHeight();const i=t.GetInstance().GetSdkInstance();return i.IsOriginalSizeKnown()?i.GetOriginalHeight():t._GetSceneGraphInfo()._GetStartHeight()}GetNewWidth(t,e,s,i,r,n){const a=s._GetSceneGraphInfo()._GetStartWidth(),o=a/s.GetParent()._GetSceneGraphInfo()._GetStartWidth();let h=1;const l=n?.GetAbsoluteScaleXOffsetProperty()??0;if(0!==l){const t=a/this.GetInstanceOriginalWidth(s,i);h=(t+l)/(0===t?Number.EPSILON:t)}const c=a*(t/e);let u=r?.GetAbsoluteWidthOffsetProperty()??0;u+=c-a;const _=(a+u)/(0===a?Number.EPSILON:a);return s.GetParent().GetWidth()*o*h*_}GetNewHeight(t,e,s,i,r,n){const a=s._GetSceneGraphInfo()._GetStartHeight(),o=a/s.GetParent()._GetSceneGraphInfo()._GetStartHeight();let h=1;const l=n?.GetAbsoluteScaleYOffsetProperty()??0;if(0!==l){const t=a/this.GetInstanceOriginalHeight(s,i);h=(t+l)/(0===t?Number.EPSILON:t)}const c=a*(t/e);let u=r?.GetAbsoluteHeightOffsetProperty()??0;u+=c-a;const _=(a+u)/(0===a?Number.EPSILON:a);return s.GetParent().GetHeight()*o*h*_}}vg.PropertyTrackState.PluginSourceAdapter=Rg}{const Ag=self.C3;class Dg extends Ag.PropertyTrackState.PropertySourceAdapter{constructor(t){super(t),this._value=0,this._init=!1}MayNeedBeforeAndAfterInterpolate(){return!1}SetInitialState(){const t=this._propertyTrack.GetPropertyTrackData();let e=this._propertyTrack.GetPropertyTrackDataItem();e=t.GetFirstPropertyKeyframeDataItem(e),this._value=e.GetValueWithResultMode()}SetResumeState(){}GetValue(){return this._init||this._propertyTrack.Interpolate(0),this._value}Interpolate(t,e,s,i,r,n,a){this._value=Ag.PropertyTrackState.NumericTypeAdapter.Interpolate(t,e,s,this._propertyTrack),this._init=!0}SaveState(){}ClearSaveState(){}GetCurrentState(){return this._value}CompareInitialStateWithCurrent(){return!1}CompareSaveStateWithCurrent(){return!1}_SaveToJson(){return{value:this._value,init:this._init}}_LoadFromJson(t){t&&(this._value=t.value,this._init=!t.hasOwnProperty("init")||t.init)}}Ag.PropertyTrackState.ValueSourceAdapter=Dg}{const Eg=self.C3;class Fg extends Eg.PropertyTrackState.PropertySourceAdapter{constructor(t){super(t),this._audioPlaybackStarted=!1,this._sdkInstance=null,this._actions=null,this._expressions=null,this._timeline=this._propertyTrack.GetTimeline(),this._track=this._propertyTrack.GetTrack(),this._sourceAdapterArgs=this._propertyTrack.GetSourceAdapterArgs(),this._fileArgs=this._sourceAdapterArgs[0],this._startOffsetTime=this._sourceAdapterArgs[1],this._sourceAdapterArgs[3]?this._audioTag=this._sourceAdapterArgs[3]:this._audioTag=Math.random().toString(36).slice(2),this._pauseTime=NaN,this._pauseVolume=NaN,this._volume=NaN,this._audioSource=null,this._Initialize()}Release(){super.Release(),this._sdkInstance=null,this._actions=null,this._expressions=null,this._timeline=null,this._track=null,this._sourceAdapterArgs=null,this._fileArgs=null,this._audioSource=null}_Initialize(){if(!self.C3.Plugins.Audio)return;const t=this._propertyTrack.GetRuntime().GetSingleGlobalObjectClassByCtor(self.C3.Plugins.Audio);t&&(this._sdkInstance=t.GetSingleGlobalInstance().GetSdkInstance()),this._actions=self.C3.Plugins.Audio.Acts,this._expressions=self.C3.Plugins.Audio.Exps}_MaybeSetAudioSource(){if(this._audioSource)return;const t=this._propertyTrack.GetTrack().GetPropertyTrack("audioSource");t&&(this._audioSource=t.GetSourceAdapter())}_GetPauseVolume(){const t=this._propertyTrack.GetTrack().GetPropertyTrack("volume");return t?t.GetSourceAdapter()._pauseVolume:this._pauseVolume}TimelineRemoved(){super.TimelineRemoved(),this._audioPlaybackStarted=!1,this._sdkInstance&&(this._expressions&&(this._pauseTime=this._expressions.PlaybackTime.call(this._sdkInstance,this._audioTag),this._pauseVolume=this._expressions.Volume.call(this._sdkInstance,this._audioTag)),this._actions&&this._actions.Stop.call(this._sdkInstance,this._audioTag))}GetAudioTag(){return this._audioTag}GetVolume(){return this._volume}SetVolume(t){this._volume=t}SetInitialState(){super.SetInitialState(),this._pauseTime=NaN,this._audioPlaybackStarted=!1}SetResumeState(){super.SetResumeState();const t=this._propertyTrack.GetTimeline().GetTime();switch(this._pauseTime=t-this._startOffsetTime,this._propertyTrack.GetPropertyName()){case"audioSource":break;case"volume":this._pauseVolume=this._propertyTrack.GetInterpolatedValue(t)}this._audioPlaybackStarted=!1}Interpolate(t,e,s,i,r,n,a){if(this._sdkInstance)switch(this._propertyTrack.GetPropertyName()){case"audioSource":{if(!this._timeline.IsForwardPlayBack())return;if(i)return void(this._actions&&this._actions.Stop.call(this._sdkInstance,this._audioTag));if(t<this._startOffsetTime)return void(this._audioPlaybackStarted=!1);const e=this._expressions.PlaybackRate.call(this._sdkInstance,this._audioTag),s=this._timeline.GetPlaybackRate();if(s!==e&&this._actions.SetPlaybackRate.call(this._sdkInstance,this._audioTag,s),this._audioPlaybackStarted)return;if(!this._propertyTrack.GetTimeline().IsPlaying())return;if(this._audioPlaybackStarted=!0,isNaN(this._pauseTime)){const e=self.performance.now(),s=t-this._startOffsetTime;if("suspended"===this._sdkInstance.GetAudioContextState())return void(this._audioPlaybackStarted=!1);const i=s+(self.performance.now()-e)/1e3;if(this._actions){let t=this.GetVolume();isNaN(t)?(this.SetVolume(0),t=0):this.SetVolume(t),this._actions.PlayFromTimeline.call(this._sdkInstance,this._fileArgs,t,this._audioTag,i)}}else{const t=this._pauseTime;this._pauseTime=NaN;const e=this._GetPauseVolume();if(this._pauseVolume=NaN,"suspended"===this._sdkInstance.GetAudioContextState())return void(this._audioPlaybackStarted=!1);this._actions&&(this.SetVolume(e),this._actions.PlayFromTimeline.call(this._sdkInstance,this._fileArgs,e,this._audioTag,t))}break}case"volume":this._MaybeSetAudioSource(),super.Interpolate(t,e,s,i,r,n,a)}}GetInterpolatedValue(t,e,s){if(this._sdkInstance)switch(this._propertyTrack.GetPropertyName()){case"audioSource":return;case"volume":return this._MaybeSetAudioSource(),super.GetInterpolatedValue(t,e,s)}}Getter(t,e){return this._audioSource?this._audioSource.GetVolume():0}Setter(t,e,s,i){this._audioSource&&this._audioSource.SetVolume(this.Getter()+e),this._actions&&this._audioSource&&this._actions.SetVolume.call(this._sdkInstance,this._audioSource.GetAudioTag(),this._audioSource.GetVolume())}AbsoluteSetter(t,e,s){this._audioSource&&this._audioSource.SetVolume(e),this._actions&&this._audioSource&&this._actions.SetVolume.call(this._sdkInstance,this._audioSource.GetAudioTag(),this._audioSource.GetVolume())}DoesRounding(){return!0}_SaveToJson(){return{audioPlaybackStarted:this._audioPlaybackStarted,audioTag:this._audioTag,pauseTime:this._pauseTime,pauseVolume:this._pauseVolume,volume:this._volume}}_LoadFromJson(t){t&&(this._audioPlaybackStarted=t.audioPlaybackStarted,this._audioTag=t.audioTag,this._pauseTime=t.pauseTime,this._pauseVolume=t.pauseVolume,this._volume=t.volume,this._Initialize())}}Eg.PropertyTrackState.AudioSourceAdapter=Fg}self.C3.PropertyTrackState.PropertyInterpolationAdapter=class{constructor(t){this._sourceAdapter=t,this._propertyTrack=t.GetPropertyTrack(),this._worldInfo=this._propertyTrack.GetTrack().GetWorldInfo(),this._property=this._propertyTrack.GetPropertyName(),this._firstAbsoluteUpdate=!1,this._saveState=null,this._target=null}Release(){this._sourceAdapter=null,this._propertyTrack=null,this._worldInfo=null,this._saveState=null,this._target=null}MayNeedBeforeAndAfterInterpolate(){return!1}TimelineRemoved(){}CleanCaches(){this._worldInfo=null,this._saveState=null,this._target=null}GetSourceAdapter(){return this._sourceAdapter}GetPropertyTrack(){return this._propertyTrack}GetWorldInfo(){return this._worldInfo||(this._worldInfo=this._propertyTrack.GetTrack().GetWorldInfo()),this._worldInfo}SetFirstAbsoluteUpdate(t){this._firstAbsoluteUpdate=!!t}GetFirstAbsoluteUpdate(){return this._firstAbsoluteUpdate}SetResetState(){}SetInitialState(){}SetResumeState(){}SetSaveState(){this._saveState=this.GetCurrentState()}ClearSaveState(){this._saveState=null}GetCurrentState(){}CompareInitialStateWithCurrent(){}CompareSaveStateWithCurrent(){}CanChange(t){return typeof this._Getter()==typeof t}BeforeChangeProperty(t,e){}ChangeProperty(t,e,s,i,r,n,a,o){}AfterChangeProperty(t,e){}_FirstKeyframeGetter(){return this._PickTimelinePlaybackMode(()=>{const t=this._propertyTrack.GetPropertyTrackDataItem();return this._propertyTrack.GetPropertyTrackData().GetFirstPropertyKeyframeDataItem(t)},()=>{const t=this._propertyTrack.GetPropertyTrackDataItem();return this._propertyTrack.GetPropertyTrackData().GetLastPropertyKeyframeDataItem(t)}).GetAbsoluteValue()}_CurrentKeyframeGetter(){const t=this._propertyTrack.GetTimeline().GetTime()-this._propertyTrack.GetTrack().GetStartOffset();return this._PickTimelinePlaybackMode(()=>{const e=this._propertyTrack.GetPropertyTrackDataItem();return this._propertyTrack.GetPropertyTrackData().GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(t,e)},()=>{const e=this._propertyTrack.GetPropertyTrackDataItem(),s=this._propertyTrack.GetPropertyTrackData();return s.GetFirstPropertyKeyFrameDataItemHigherOrEqualThan(t,e)||s.GetLastPropertyKeyframeDataItem(e)}).GetAbsoluteValue()}_PickTimelinePlaybackMode(t,e){return this._propertyTrack.GetTimeline().IsForwardPlayBack()?t():e()}_PickResultMode(t,e){return"relative"===this._propertyTrack.GetResultMode()?t():e()}_PickFirstAbsoluteUpdate(t,e){return this.GetFirstAbsoluteUpdate()?(this.SetFirstAbsoluteUpdate(!1),t()):e()}_GetAbsoluteInitialValue(t){}_GetIndex(){return this._sourceAdapter.GetIndex()}_GetTarget(){return this._target||(this._target=this._sourceAdapter.GetTarget()),this._target}_PickSource(t,e,s,i,r,n){switch(this._propertyTrack.GetSourceAdapterId()){case"behavior":return t();case"effect":return e();case"instance-variable":return s();case"plugin":return i();case"world-instance":return r();case"audio":return n()}}_SaveToJson(){return{firstAbsoluteUpdate:this._firstAbsoluteUpdate,saveState:this._saveState}}_LoadFromJson(t){t&&(this._firstAbsoluteUpdate=t.firstAbsoluteUpdate,this._saveState=t.saveState)}_GetPropertyKeyframeStubs(t,e=!1){const s=[];for(const i of t){const t=i.GetTrack().GetStartOffset();for(const r of i.GetPropertyKeyframeDataItems())e&&0===r.GetTime()?s.push({time:t+r.GetTime(),value:r.GetAbsoluteValue()}):e||s.push({time:t+r.GetTime(),value:r.GetAbsoluteValue()})}return s.sort((t,e)=>t.time-e.time)}_GetLastPropertyKeyframeStub(t,e,s){return this._GetPropertyKeyframeStubLowerThanPlayhead(e,s)}_GetPropertyKeyframeStubLowerThanPlayhead(t,e){for(let s=e.length-1;s>=0;s--)if(e[s].time<=t)return e[s];return null}};{const Og=self.C3,Bg=new Map,Lg=[0,0,0];class kg extends Og.PropertyTrackState.PropertyInterpolationAdapter{constructor(t){super(t)}SetResetState(){}SetInitialState(){}SetResumeState(){}GetCurrentState(){const t=this._propertyTrack.GetSourceAdapterId(),e=this._GetTarget(),s=this._GetIndex();switch(t){case"behavior":case"plugin":return this._ToColorArray(e.GetPropertyValueByIndex(s));case"effect":return this._ToColorArray(e[s]);case"world-instance":return this._ToColorArray(this._Getter())}}CompareInitialStateWithCurrent(){const t=this._FirstKeyframeGetter();return!this._CompareColors(t,this._Getter())}CompareSaveStateWithCurrent(){return!Og.IsNullOrUndefined(this._saveState)&&!this._CompareColors(this._saveState,this._Getter())}_CompareColors(t,e){return t=this._GetColorFromArray(t),e=this._GetColorFromArray(e),t.equalsIgnoringAlpha(e)}_FirstKeyframeGetter(){const t=super._FirstKeyframeGetter();return this._GetColorFromArray(t)}_CurrentKeyframeGetter(){const t=super._CurrentKeyframeGetter();return this._GetColorFromArray(t)}_GetAbsoluteInitialValue(t){}_ToColorArray(t){return Og.IsInstanceOf(t,Og.Color)?t.toArray().slice(0,3):t.slice(0,3)}_GetColorFromArray(t){return Og.IsInstanceOf(t,Og.Color)?t:new Og.Color(t[0],t[1],t[2],1)}CanChange(t){return!0}MayNeedBeforeAndAfterInterpolate(){return!0}BeforeChangeProperty(){const t=this._propertyTrack.GetTimeline(),e=this._propertyTrack.GetInstance(),s=this._propertyTrack.GetSourceAdapter(),i=t.GetSimilarPropertyTracks(e,s,this._property,this._propertyTrack);if(i&&i.length>1){Bg.has(e)||Bg.set(e,new Map);const t=Bg.get(e),s=this._propertyTrack.GetSourceAdapterId();t.has(s)||t.set(s,new Map);const i=t.get(s);i.has(this._property)||i.set(this._property,{used:!1,color:new Og.Color(0,0,0,1)})}}_GetTmpColor(t,e,s){const i=Bg.get(t).get(e).get(s);return i.used=!0,i.color}ChangeProperty(t,e,s,i,r,n,a,o){const h=this._propertyTrack.GetTimeline(),l=this._propertyTrack.GetTrack(),c=this._propertyTrack.GetInstance(),u=this._propertyTrack.GetSourceAdapter(),_=this._propertyTrack.GetSourceAdapterId(),d=this._property,p=h.GetSimilarPropertyTracks(c,u,d,this._propertyTrack);if(p&&p.length>1){const t=this._GetPropertyKeyframeStubs(p,!0),s=this._GetLastPropertyKeyframeStub(h,h.GetTime(),t);if(s){const t=l.GetStartOffset(),i=s.time-t;if(0===i)this._GetTmpColor(c,_,this._property).addRgb(e[0],e[1],e[2]);else{if(i<0)return;const t=e[0],s=e[1],r=e[2],n=this._propertyTrack.Interpolate(i,!1,!0),a=Og.Color.DiffChannel(t,n[0]),o=Og.Color.DiffChannel(s,n[1]),h=Og.Color.DiffChannel(r,n[2]);this._GetTmpColor(c,_,this._property).addRgb(a,o,h)}}}else this._Setter(e[0],e[1],e[2])}AfterChangeProperty(){const t=this._propertyTrack.GetInstance();if(!Bg.has(t))return;const e=Bg.get(t),s=this._propertyTrack.GetSourceAdapterId();if(!e.has(s))return;const i=e.get(s);if(!i.has(this._property))return;const r=i.get(this._property),n=r.used,a=r.color;n&&this._Setter(a.getR(),a.getG(),a.getB()),0===i.size&&e.delete(s),0===e.size&&Bg.delete(t)}_Getter(){const t=this._propertyTrack.GetSourceAdapterId(),e=this._GetTarget(),s=this._GetIndex();switch(t){case"behavior":case"plugin":return this._GetColorFromArray(e.GetPropertyValueByIndex(s));case"effect":return e[s].clone();case"world-instance":return this.GetWorldInfo().GetUnpremultipliedColor().clone()}}_Setter(t,e,s){const i=this._propertyTrack.GetSourceAdapterId(),r=this._GetTarget(),n=this._GetIndex();switch(i){case"behavior":case"plugin":Lg[0]=t,Lg[1]=e,Lg[2]=s,r.SetPropertyValueByIndex(n,Lg);break;case"effect":r[n].setRgb(t,e,s);break;case"world-instance":this.GetWorldInfo().SetUnpremultipliedColorRGB(t,e,s)}}_SaveToJson(){}_LoadFromJson(t){}}Og.PropertyTrackState.PropertyInterpolationAdapter.ColorInterpolationAdapter=kg}{const Ng=self.C3,Ug=Ng.PropertyTrackState;class Wg extends Ng.PropertyTrackState.PropertyInterpolationAdapter{constructor(t){super(t)}SetResetState(){}SetInitialState(){}SetResumeState(){}GetCurrentState(){return this._Getter()}CompareInitialStateWithCurrent(){return this._FirstKeyframeGetter()!==this.GetCurrentState()}CompareSaveStateWithCurrent(){return!Ng.IsNullOrUndefined(this._saveState)&&this._saveState!==this.GetCurrentState()}MayNeedBeforeAndAfterInterpolate(){return!1}ChangeProperty(t,e,s,i,r,n,a,o){const h=this._propertyTrack,l=h.GetTrack(),c=h.GetSourceAdapterId(),u=h.GetTimeline(),_=l.GetInstance(),d=h.GetSourceAdapter(),p=this._property,f=u.GetSimilarPropertyTracks(_,d,p,h);if(f&&f.length>1){const s=this._GetPropertyKeyframeStubs(f),i=t+l.GetStartOffset(),r=this._GetLastPropertyKeyframeStub(u,i,s);r&&(e=r.value)}switch(h.GetPropertyKeyframeType()){case"numeric":if(!Ug.NumericTypeAdapter.WillChange(this._GetIndex(),this._GetTarget(),e,c))return;this._Setter(e,s,i);break;case"angle":if(!Ug.AngleTypeAdapter.WillChange(this._GetIndex(),this._GetTarget(),e,c))return;this._Setter(e,s,i);break;case"boolean":if(!Ug.BooleanTypeAdapter.WillChange(this._GetIndex(),this._GetTarget(),e,c))return;this._Setter(e,s,i);break;case"color":if(!Ug.ColorTypeAdapter.WillChange(this._GetIndex(),this._GetTarget(),e,c))return;this._Setter(e,s,i);break;case"text":{const t=this._ForceChanges();if(!Ug.TextTypeAdapter.WillChange(this._GetIndex(),this._GetTarget(),e,c)&&!t)return;this._Setter(e,s,i);break}}}_ForceChanges(){switch(this._propertyTrack.GetSourceAdapterId()){case"behavior":case"effect":case"instance-variable":return!1;case"plugin":return this.GetSourceAdapter().ForceChanges()}return!1}_Getter(){const t=this._propertyTrack.GetSourceAdapterId(),e=this._GetTarget(),s=this._GetIndex();switch(t){case"behavior":case"plugin":return e.GetPropertyValueByIndex(s);case"effect":return e[s];case"instance-variable":return e.GetInstanceVariableValue(s)}}_Setter(t,e,s){const i=this._propertyTrack.GetSourceAdapterId(),r=this._GetTarget(),n=this._GetIndex();switch(i){case"behavior":r.SetPropertyValueByIndex(n,t);break;case"effect":r[n]=t;break;case"instance-variable":r.SetInstanceVariableValue(n,t);break;case"plugin":r.SetPropertyValueByIndex(n,t,this.GetSourceAdapter().GetOptionalCallbacks(e,s))}}}Ng.PropertyTrackState.PropertyInterpolationAdapter.NoInterpolationAdapter=Wg}{const jg=self.C3,Vg=(jg.PropertyTrackState.PropertyInterpolationAdapter,new Map),zg=(t,e,s,i,r,n=!1,a=null,o=null)=>{Vg.set(t,{setter:e,absolute_setter:s,getter:i,round:r,fRound:n,init:a,reset:o})},Hg=(t,e,s,i=0)=>{const r=e.GetTimeline().GetTrackFromInstance(t.GetInstance());if(!r)return i;const n=r.GetPropertyTrack(s);if(!n)return i;const a=n.GetPropertyTrackDataItem().GetPropertyKeyframeData();if(!a)return i;const o=a.GetLastPropertyKeyframeDataItem();return o?o.GetValue():i},Yg=t=>{const e=[];let s=t.GetParent();for(;s;)e.push(s),s=s.GetParent();return e.reverse(),e};zg("offsetX",(t,e,s,i)=>{"relative"===i._propertyTrack.GetResultMode()?t.OffsetX(e,s.GetTimeline().GetTransformWithSceneGraph()):t.OffsetX(e)},(t,e)=>t.SetX(e),t=>t.GetX(),!0),zg("offsetY",(t,e,s,i)=>{"relative"===i._propertyTrack.GetResultMode()?t.OffsetY(e,s.GetTimeline().GetTransformWithSceneGraph()):t.OffsetY(e)},(t,e)=>t.SetY(e),t=>t.GetY(),!0),zg("offsetWidth",(t,e,s,i,r=!1,n=!0)=>{if(0===e)return;const a="relative"===i._propertyTrack.GetResultMode(),o=1===i._typeAdapter.GetType();if((a||o)&&t.HasParent()&&t.GetTransformWithParentWidth()){if(isNaN(i._absoluteToFactor)){const e=Yg(t);let s;s=o?e[e.length-1].GetWidth():e[e.length-1]._GetSceneGraphInfo()._GetStartWidth(),i._absoluteToFactor=0===s?Number.EPSILON:s}if(r)return;i._absoluteWidthOffset+=e;const s=e/i._absoluteToFactor;t.OffsetWidth(s,n),i._changeAccumulator+=s}else t.OffsetWidth(e),i._changeAccumulator+=e},(t,e)=>t.SetWidth(e),t=>t.GetWidth(),!0,!1,null,t=>{t._changeAccumulator=0,t._absoluteWidthOffset=0}),zg("offsetHeight",(t,e,s,i,r=!1,n=!0)=>{if(0===e)return;const a="relative"===i._propertyTrack.GetResultMode(),o=1===i._typeAdapter.GetType();if((a||o)&&t.HasParent()&&t.GetTransformWithParentHeight()){if(isNaN(i._absoluteToFactor)){const e=Yg(t);let s;s=o?e[e.length-1].GetHeight():e[e.length-1]._GetSceneGraphInfo()._GetStartHeight(),i._absoluteToFactor=0===s?Number.EPSILON:s}if(r)return;i._absoluteHeightOffset+=e;const s=e/i._absoluteToFactor;t.OffsetHeight(s,n),i._changeAccumulator+=s}else t.OffsetHeight(e),i._changeAccumulator+=e},(t,e)=>t.SetHeight(e),t=>t.GetHeight(),!0,!1,null,t=>{t._changeAccumulator=0,t._absoluteHeightOffset=0}),zg("offsetAngle",(t,e,s,i,r)=>{t.OffsetAngle(e)},(t,e)=>t.SetAngle(e),t=>t.GetAngle(),!1,!0),zg("offsetOpacity",(t,e,s,i,r)=>{e/=i._opacityFactor?i._opacityFactor:1;const n=t.GetOpacity()+e;if(0===i._clampAccumulator)n>1?i._clampAccumulator+=n-1:n<0&&(i._clampAccumulator+=n),t.OffsetOpacity(e);else{const s=t.GetOpacity()+e;e>0&&i._clampAccumulator>0?s>1&&(i._clampAccumulator+=s-1):e>0&&i._clampAccumulator<0?(i._clampAccumulator+=e,i._clampAccumulator>0&&(t.OffsetOpacity(i._clampAccumulator),i._clampAccumulator=0)):e<0&&i._clampAccumulator>0?(i._clampAccumulator+=e,i._clampAccumulator<0&&(t.OffsetOpacity(i._clampAccumulator),i._clampAccumulator=0)):e<0&&i._clampAccumulator<0&&s<0&&(i._clampAccumulator+=s)}},(t,e)=>{t.SetOpacity(e)},t=>t.GetOpacity(),!1,!0,(t,e,s)=>{switch(t._clampAccumulator=0,t._propertyTrack.GetResultMode()){case"relative":{t._propertyTrack.GetPropertyTrackData();const e=t._propertyTrack.GetPropertyTrackDataItem().GetPropertyKeyframeData().GetPropertyKeyframeDataItemArray();let s=t.GetWorldInfo().GetOpacity(),i=s;for(const r of e){const e=r.GetTime();i=s+t._propertyTrack.GetInterpolatedValue(e),i=jg.clamp(i,0,1)}t._totalForewardOpacityDelta=s-i,t._totalForewardOpacityDelta=Math.round(100*(t._totalForewardOpacityDelta+Number.EPSILON))/100,i=s;for(let s=e.length-1;s>=0;s--){const r=e[s].GetTime();i-=t._propertyTrack.GetInterpolatedValue(r),i=jg.clamp(i,0,1)}t._totalBackwardOpacityDelta=i,t._totalBackwardOpacityDelta=Math.round(100*(t._totalBackwardOpacityDelta+Number.EPSILON))/100;break}}const i="relative"===t._propertyTrack.GetResultMode(),r=1===t._typeAdapter.GetType();if((i||r)&&e.HasParent()&&e.GetTransformWithParentOpacity()){const i=Yg(e);let r=i[0]._GetSceneGraphInfo().GetStartOpacity();r+=Hg(i[0],s,"offsetOpacity");for(let t=1;t<i.length;t++)r+=Hg(i[t],s,"offsetOpacity");t._opacityFactor=0===r?1:r}},t=>{switch(t._propertyTrack.GetResultMode()){case"relative":{t._clampAccumulator=0;const e=t.GetWorldInfo();let s=e.GetOpacity();s=Math.round(100*(s+Number.EPSILON))/100,t._propertyTrack.GetTimeline().IsForwardPlayBack()?(e.SetOpacity(s+t._totalForewardOpacityDelta),t._lastValue=0):(e.SetOpacity(s-t._totalBackwardOpacityDelta),t._lastValue=t.GetSourceAdapter().GetValueAtTime());break}}}),zg("offsetOriginX",(t,e)=>t.OffsetOriginX(e),(t,e)=>t.SetOriginX(e),t=>t.GetOriginX(),!1),zg("offsetOriginY",(t,e)=>t.OffsetOriginY(e),(t,e)=>t.SetOriginY(e),t=>t.GetOriginY(),!1),zg("offsetZElevation",(t,e)=>t.OffsetZElevation(e),(t,e)=>t.SetZElevation(e),t=>t.GetZElevation(),!0),zg("offsetScaleX",(t,e,s,i)=>{if(0===e)return;const r=t.GetWidth()<0?-1:1;if(i._absoluteScaleXOffset+=e,"relative"===i._propertyTrack.GetResultMode()&&t.HasParent()&&t.GetTransformWithParentWidth()){const n=Hg(t,s,"offsetWidth"),a=isNaN(i._originalSize)?s.GetOriginalWidth():i._originalSize,o=(a+n/(t._GetSceneGraphInfo()._GetStartWidth()/a))*r*e;isNaN(i._absoluteToFactor)&&Vg.get("offsetWidth").setter(t,1,s,i,!0);const h=o/i._absoluteToFactor;t.OffsetWidth(h,!0),i._changeAccumulator+=h}else{const n=(isNaN(i._originalSize)?s.GetOriginalWidth():i._originalSize)*r*e;t.OffsetWidth(n),i._changeAccumulator+=n}},(t,e,s)=>{t.SetWidth(s.GetOriginalWidth()*e)},(t,e)=>{const s=t.GetWidth()<0?-1:1;if(t.GetTransformWithParentWidth()){const i=t.GetParent(),r=e.GetTimeline().GetTrackFromInstance(i.GetInstance());let n=NaN;if(r)n=i.GetWidth()/r.GetOriginalWidth();else{const t=i.GetInstance().GetSdkInstance();n=t.IsOriginalSizeKnown()?i.GetWidth()/t.GetOriginalWidth():1}return t.GetWidth()*s/(e.GetOriginalWidth()*n)}return t.GetWidth()*s/e.GetOriginalWidth()},!1,!1,null,t=>{t._changeAccumulator=0,t._originalSize=NaN,t._absoluteScaleXOffset=0}),zg("offsetScaleY",(t,e,s,i)=>{if(0===e)return;const r=t.GetHeight()<0?-1:1;if(i._absoluteScaleYOffset+=e,"relative"===i._propertyTrack.GetResultMode()&&t.HasParent()&&t.GetTransformWithParentHeight()){const n=Hg(t,s,"offsetHeight"),a=isNaN(i._originalSize)?s.GetOriginalHeight():i._originalSize,o=(a+n/(t._GetSceneGraphInfo()._GetStartHeight()/a))*r*e;isNaN(i._absoluteToFactor)&&Vg.get("offsetHeight").setter(t,1,s,i,!0);const h=o/i._absoluteToFactor;t.OffsetHeight(h,!0),i._changeAccumulator+=h}else{const n=(isNaN(i._originalSize)?s.GetOriginalHeight():i._originalSize)*r*e;t.OffsetHeight(n),i._changeAccumulator+=n}},(t,e,s)=>{t.SetHeight(s.GetOriginalHeight()*e)},(t,e)=>{const s=t.GetHeight()<0?-1:1;if(t.GetTransformWithParentHeight()){const i=t.GetParent(),r=e.GetTimeline().GetTrackFromInstance(i.GetInstance());let n=NaN;if(r)n=i.GetHeight()/r.GetOriginalHeight();else{const t=i.GetInstance().GetSdkInstance();n=t.IsOriginalSizeKnown()?i.GetHeight()/t.GetOriginalHeight():1}return t.GetHeight()*s/(e.GetOriginalHeight()*n)}return t.GetHeight()*s/e.GetOriginalHeight()},!1,!1,null,t=>{t._changeAccumulator=0,t._originalSize=NaN,t._absoluteScaleYOffset=0});class Xg extends jg.PropertyTrackState.PropertyInterpolationAdapter{constructor(t){super(t),this._lastValue=0,this._clampAccumulator=0,this._totalForewardOpacityDelta=0,this._totalBackwardOpacityDelta=0,this._opacityFactor=NaN,this._absoluteToFactor=NaN,this._changeAccumulator=0,this._originalSize=NaN,this._absoluteWidthOffset=0,this._absoluteScaleXOffset=0,this._absoluteHeightOffset=0,this._absoluteScaleYOffset=0,this._angleReflectMirrorOrFlip=void 0,this._angleReflectMirrorAndFlip=void 0,this._instance_getter=null,this._instance_setter=null,this._instance_absolute_setter=null,this._reset_action=null,this._init_action=null,this._source_adapter_getter=null,this._source_adapter_setter=null,this._source_adapter_absolute_setter=null,this._round=!1,this._fRound=!1,jg.IsInstanceOf(this._propertyTrack.GetTimeline(),jg.TweenState)?this._typeAdapter=new jg.PropertyTrackState.PropertyInterpolationAdapter.NumericInterpolationAdapterForTween(this):this._typeAdapter=new jg.PropertyTrackState.PropertyInterpolationAdapter.NumericInterpolationAdapterForTimeline(this);const e=this._propertyTrack.GetPropertyName();switch(this._propertyTrack.GetSourceAdapterId()){case"world-instance":{const t=Vg.get(e);this._instance_getter=t.getter,this._instance_setter=t.setter,this._instance_absolute_setter=t.absolute_setter,this._round=t.round,this._fRound=t.fRound,this._init_action=t.init,this._reset_action=t.reset;break}case"audio":this._source_adapter_getter=t.Getter,this._source_adapter_setter=t.Setter,this._source_adapter_absolute_setter=t.AbsoluteSetter,this._round=!!t.DoesRounding(),this._fRound=!1}}Release(){this._typeAdapter=null,this._instance_getter=null,this._instance_setter=null,this._instance_absolute_setter=null,this._reset_action=null,this._init_action=null,this._source_adapter_getter=null,this._source_adapter_setter=null,this._source_adapter_absolute_setter=null,super.Release()}MayNeedBeforeAndAfterInterpolate(){return this._typeAdapter.MayNeedBeforeAndAfterInterpolate()}GetLastValue(){return this._lastValue}SetLastValue(t){this._lastValue=t}SetResetState(){this._reset_action&&this._reset_action(this)}SetInitialState(){const t=this._typeAdapter.SetInitialState();if("number"==typeof t&&(this._lastValue=t),this._init_action){const t=this.GetWorldInfo(),e=this._propertyTrack.GetTrack();this._init_action(this,t,e)}}SetResumeState(){const t=this._typeAdapter.SetResumeState();"number"==typeof t&&(this._lastValue=t)}GetCurrentState(){return this._Getter()}CompareInitialStateWithCurrent(){return this._FirstKeyframeGetter()!==this.GetCurrentState()}CompareSaveStateWithCurrent(){return!jg.IsNullOrUndefined(this._saveState)&&this._saveState!==this.GetCurrentState()}BeforeChangeProperty(t,e){this._typeAdapter.BeforeChangeProperty(t,e)}ChangeProperty(t,e,s,i,r,n,a,o){return this._typeAdapter.ChangeProperty(t,e,s,i,r,n,a,o)}AfterChangeProperty(t,e){this._typeAdapter.AfterChangeProperty(t,e)}_Getter(){const t=this._GetTarget(),e=this._GetIndex(),s=this.GetWorldInfo(),i=this._propertyTrack.GetTrack();switch(this._propertyTrack.GetSourceAdapterId()){case"behavior":case"plugin":return t.GetPropertyValueByIndex(e);case"effect":return t[e];case"instance-variable":return t.GetInstanceVariableValue(e);case"world-instance":return this._instance_getter(s,i);case"audio":return this._source_adapter_getter.call(this.GetSourceAdapter(),s,i)}}_Setter(t,e,s,i=!0){const r=this._GetTarget(),n=this._GetIndex(),a=this.GetWorldInfo(),o=this._propertyTrack.GetTrack();switch(this._propertyTrack.GetSourceAdapterId()){case"behavior":r.OffsetPropertyValueByIndex(n,t);break;case"effect":r[n]+=t;break;case"instance-variable":r.SetInstanceVariableOffset(n,t);break;case"plugin":r.OffsetPropertyValueByIndex(n,t,this.GetSourceAdapter().GetOptionalCallbacks(e,s));break;case"world-instance":this._instance_setter(a,t,o,this,!1,i);break;case"audio":this._source_adapter_setter.call(this.GetSourceAdapter(),a,t,o,this)}}_SetterAbsolute(t,e,s,i,r){let n=this._propertyTrack.GetInterpolationMode();if(n="default"===n?"continuous":n,"discrete"===n&&!e)return;if("discrete"===n&&s){const t=this._propertyTrack.GetTimeline().GetTime();if(!this._propertyTrack.GetPropertyKeyFrameDataItemAtTime(t))return}const a=this._GetTarget(),o=this._GetIndex(),h=this.GetWorldInfo(),l=this._propertyTrack.GetTrack();switch(this._propertyTrack.GetSourceAdapterId()){case"behavior":a.SetPropertyValueByIndex(o,t);break;case"effect":a[o]=t;break;case"instance-variable":a.SetInstanceVariableValue(o,t);break;case"plugin":a.SetPropertyValueByIndex(o,t,this.GetSourceAdapter().GetOptionalCallbacks(i,r));break;case"world-instance":this._instance_absolute_setter(h,t,l);break;case"audio":this._source_adapter_absolute_setter.call(this.GetSourceAdapter(),h,t,l)}}_MaybeEnsureValue(t,e,s,i,r,n,a,o){this._typeAdapter._MaybeEnsureValue(t,e,s,i,r,n,a,o)}_AddDelta(t,e,s,i,r){"angle"===this._propertyTrack.GetPropertyType()&&(t=jg.toDegrees(t));const n=(t.toString().split(".")[1]||"").length,a=this._Getter();let o;switch(o=0===n?this._round?Math.round(a):this._fRound?"angle"===this._propertyTrack.GetPropertyType()?jg.toRadians(Math.round(jg.toDegrees(a))):Number(jg.toFixed(a,2)):a:this._round?Number(jg.toFixed(a,n)):(this._fRound,a),this._Setter(o-a,e,s,!1),this._propertyTrack.GetPropertyName()){case"offsetWidth":case"offsetScaleX":{const t=this.GetWorldInfo(),e=t.GetWidth(),s=Number(jg.toFixed(e,2));t.OffsetWidth(s-e);break}case"offsetHeight":case"offsetScaleY":{const t=this.GetWorldInfo(),e=t.GetHeight(),s=Number(jg.toFixed(e,2));t.OffsetHeight(s-e);break}}}_SaveToJson(){return Object.assign(super._SaveToJson(),{v:this._lastValue,a:this._clampAccumulator,fod:this._totalForewardOpacityDelta,bod:this._totalBackwardOpacityDelta,of:this._opacityFactor,sf:this._absoluteToFactor,armorf:this._angleReflectMirrorOrFlip,armandf:this._angleReflectMirrorAndFlip,ca:this._changeAccumulator,os:this._originalSize,awo:this._absoluteWidthOffset,aho:this._absoluteHeightOffset,asxo:this._absoluteScaleXOffset,asyo:this._absoluteScaleYOffset})}_LoadFromJson(t){t&&(super._LoadFromJson(t),this._lastValue=t.v,this._clampAccumulator=t.a,this._totalForewardOpacityDelta=jg.IsFiniteNumber(t.fod)?t.fod:0,this._totalBackwardOpacityDelta=jg.IsFiniteNumber(t.bod)?t.bod:0,this._opacityFactor=jg.IsFiniteNumber(t.of)?t.of:NaN,this._absoluteToFactor=jg.IsFiniteNumber(t.sf)?t.sf:NaN,this._angleReflectMirrorOrFlip=jg.IsFiniteNumber(t.armorf)?t.armorf:void 0,this._angleReflectMirrorAndFlip=jg.IsFiniteNumber(t.armandf)?t.armandf:void 0,this._changeAccumulator=jg.IsFiniteNumber(t.ca)?t.ca:0,this._originalSize=jg.IsFiniteNumber(t.os)?t.os:NaN,this._absoluteWidthOffset=jg.IsFiniteNumber(t.awo)?t.awo:0,this._absoluteHeightOffset=jg.IsFiniteNumber(t.aho)?t.aho:0,this._absoluteScaleXOffset=jg.IsFiniteNumber(t.asxo)?t.asxo:0,this._absoluteScaleYOffset=jg.IsFiniteNumber(t.asyo)?t.asyo:0)}SetOriginalSizeProperty(t){this._originalSize=t}GetChangeAccumulatorProperty(){return this._changeAccumulator}GetAbsoluteWidthOffsetProperty(){return this._absoluteWidthOffset}GetAbsoluteHeightOffsetProperty(){return this._absoluteHeightOffset}GetAbsoluteScaleXOffsetProperty(){return this._absoluteScaleXOffset}GetAbsoluteScaleYOffsetProperty(){return this._absoluteScaleYOffset}}jg.PropertyTrackState.PropertyInterpolationAdapter.NumericInterpolationAdapter=Xg}{const qg=self.C3;class Jg{constructor(t){this._used=!1,this._value=0,this._propertyKeyframeReached=!1,this._endState=!1,this._propertyTracks=t;for(let t=0,e=this._propertyTracks.length;t<e;t++)this._propertyTracks[t].SetAbsoluteValueObject(this)}GetPropertyTracks(){return this._propertyTracks}SetUsed(){this._used=!0}GetUsed(){return this._used}SetValue(t){this._value=t}GetValue(){return this._value}SetPropertyKeyframeReached(t){this._propertyKeyframeReached=t}GetPropertyKeyframeReached(){return this._propertyKeyframeReached}SetEndState(t){this._endState=t}GetEndState(){return this._endState}Reset(){this._used=!1,this._value=0,this._propertyKeyframeReached=!1,this._endState=!1}}class Qg{constructor(t){this._numericInterpolationAdapter=t}Release(){this._numericInterpolationAdapter=null}GetType(){return 0}SetInitialState(){const t=this._numericInterpolationAdapter;return this._numericInterpolationAdapter.GetPropertyTrack(),t._PickResultMode(()=>t._PickTimelinePlaybackMode(()=>0,()=>t.GetSourceAdapter().GetValueAtTime()),()=>{})}SetResumeState(){}MayNeedBeforeAndAfterInterpolate(){switch(this._numericInterpolationAdapter,this._numericInterpolationAdapter.GetPropertyTrack().GetResultMode()){case"relative":return!1;case"absolute":return!0}}BeforeChangeProperty(t,e){this._numericInterpolationAdapter;const s=this._numericInterpolationAdapter.GetPropertyTrack(),i=s.GetPropertyName();switch(s.GetResultMode()){case"relative":break;case"absolute":if(s.HasAbsoluteValueObject())s.GetAbsoluteValueObject().Reset();else{const t=s.GetTimeline(),e=s.GetInstance(),r=s.GetSourceAdapter(),n=t.GetSimilarPropertyTracks(e,r,i,s);n&&n.length>1&&new Jg(n)}}}ChangeProperty(t,e,s,i,r,n,a,o){const h=this._numericInterpolationAdapter,l=this._numericInterpolationAdapter.GetPropertyTrack();switch(l.GetResultMode()){case"relative":{const a=h.GetLastValue();h._Setter(e-a,s,i),n&&this._MaybeEnsureValue(t,s,i,r,a,e),h.SetLastValue(e);break}case"absolute":{const t=l.GetTimeline(),r=l.GetTrack();if(l.GetInstance(),l.GetSourceAdapter(),l.HasAbsoluteValueObject()){const s=l.GetAbsoluteValueObject(),i=s.GetPropertyTracks(),n=h._GetPropertyKeyframeStubs(i,!0),c=h._GetLastPropertyKeyframeStub(t,t.GetTime(),n);if(c){const t=r.GetStartOffset(),i=c.time-t;if(0===i)s.SetEndState(a),s.SetPropertyKeyframeReached(o),s.SetUsed(),s.SetValue(s.GetValue()+e);else{if(i<0)return;const t=l.GetInterpolatedValue(i);s.SetEndState(a),s.SetPropertyKeyframeReached(o),s.SetUsed(),s.SetValue(s.GetValue()+(e-t))}}}else h._SetterAbsolute(e,o,a,s,i);break}}}AfterChangeProperty(t,e){const s=this._numericInterpolationAdapter,i=this._numericInterpolationAdapter.GetPropertyTrack();switch(i.GetResultMode()){case"relative":break;case"absolute":if(i.HasAbsoluteValueObject()){const r=i.GetAbsoluteValueObject();r.GetUsed()&&s._SetterAbsolute(r.GetValue(),r.GetPropertyKeyframeReached(),r.GetEndState(),t,e)}}}_MaybeEnsureValue(t,e,s,i,r,n){const a=this._numericInterpolationAdapter;i||(e&&t===e.GetTime()?a._AddDelta(e.GetValueWithResultMode(),e,s):s&&t===s.GetTime()?a._AddDelta(s.GetValueWithResultMode(),e,s):n-r===0&&a._AddDelta(e.GetValueWithResultMode(),e,s))}}qg.PropertyTrackState.PropertyInterpolationAdapter.NumericInterpolationAdapterForTimeline=Qg}{const Kg=self.C3;class Zg{constructor(t){this._numericInterpolationAdapter=t}Release(){this._numericInterpolationAdapter=null}GetType(){return 1}SetInitialState(){const t=this._numericInterpolationAdapter;return t.SetFirstAbsoluteUpdate(!0),this._GetAbsoluteInitialValue(t._FirstKeyframeGetter())}SetResumeState(){const t=this._numericInterpolationAdapter;if(t._FirstKeyframeGetter()!==t._CurrentKeyframeGetter())return t.SetFirstAbsoluteUpdate(!0),this._GetAbsoluteInitialValue(t._CurrentKeyframeGetter())}MayNeedBeforeAndAfterInterpolate(){return!1}BeforeChangeProperty(){}ChangeProperty(t,e,s,i,r,n,a,o){const h=this._numericInterpolationAdapter,l=h.GetLastValue();switch(h.GetPropertyTrack().GetResultMode()){case"relative":h._Setter(e-l,s,i),n&&this._MaybeEnsureValue(t,s,i,r,l,e,!1,a);break;case"absolute":h.GetFirstAbsoluteUpdate()?(h.SetFirstAbsoluteUpdate(!1),h._Setter(l,s,i)):0===t&&0===h.GetPropertyTrack().GetTimeline().GetTotalTime()?h._SetterAbsolute(e,!0,!1,s,i):(h._Setter(e-l,s,i),n&&this._MaybeEnsureValue(t,s,i,r,l,e,this._ForceEndValue(),a))}h.SetLastValue(e)}AfterChangeProperty(){}_GetAbsoluteInitialValue(t){return t-this._numericInterpolationAdapter.GetCurrentState()}_ForceEndValue(){const t=this._numericInterpolationAdapter,e=t.GetWorldInfo().GetInstance(),s=t.GetPropertyTrack().GetRuntime().GetTimelineManager();let i=0;for(const t of s.GetPlayingTimelines())0===t.GetType()?t.HasTrackInstance(e)&&i++:1===t.GetType()&&t.GetInstance()===e&&i++;return i<=1}_MaybeEnsureValue(t,e,s,i,r,n,a,o){const h=this._numericInterpolationAdapter;i?e&&t===e.GetTime()?h._AddDelta(e.GetValueWithResultMode(),e,s,a,o):s&&t===s.GetTime()?h._AddDelta(s.GetValueWithResultMode(),e,s,a,o):s||h._AddDelta(e.GetValueWithResultMode(),e,s,a,o):e&&t===e.GetTime()?h._AddDelta(e.GetValueWithResultMode(),e,s,a,o):s&&t===s.GetTime()?h._AddDelta(s.GetValueWithResultMode(),e,s,a,o):n-r===0&&h._AddDelta(e.GetValueWithResultMode(),e,s,a,o)}}Kg.PropertyTrackState.PropertyInterpolationAdapter.NumericInterpolationAdapterForTween=Zg}{const $g=self.C3,tm=self.Ease;$g.PropertyTrackState.NumericTypeAdapter=class{constructor(){}static WillChange(t,e,s,i){let r;switch(i){case"behavior":case"plugin":r=e.GetPropertyValueByIndex(t);break;case"effect":r=e[t];break;case"instance-variable":r=e.GetInstanceVariableValue(t)}return r!==s}static Interpolate(t,e,s,i){if(!s){const t=i.GetPropertyTrackDataItem();return i.GetPropertyTrackData().GetLastPropertyKeyframeDataItem(t).GetValueWithResultMode()}let r=i.GetInterpolationMode();if("default"===r&&(r="continuous"),"combo"===i.GetPropertyType()&&(r="discrete"),"discrete"===r)return $g.PropertyTrackState.GetPropertyKeyframeValueWithPlaybackDirection(e,s,i);if("continuous"===r||"step"===r){const n=i.GetTimeline().GetStep();if("step"===r&&0!==n){const e=1/n;t=Math.floor(t*e)/e}const a=e.GetValueWithResultMode(),o=s.GetValueWithResultMode(),h=e.GetAddOn("cubic-bezier"),l=s.GetAddOn("cubic-bezier"),c=h&&h.GetStartEnable()&&l&&l.GetEndEnable();if(!c&&a===o)return a;const u=e.GetTime(),_=s.GetTime();"step"===r&&0!==n&&(t=$g.clamp(t,u,_));const d=$g.normalize(t,u,_),p=e.GetEase();let f;if(c){const t=_-u;f=tm.GetRuntimeEase(p)(t*d,0,1,t),f=tm.GetRuntimeEase("cubicbezier")(f,a,a+h.GetStartAnchor(),o+l.GetEndAnchor(),o)}else f=tm.GetRuntimeEase(p)((_-u)*d,a,o-a,_-u);return"integer"===i.GetPropertyType()?Math.floor(f):f}}}}{const em=self.C3;em.PropertyTrackState.AngleTypeAdapter=class{constructor(){}static WillChange(t,e,s,i){let r;switch(i){case"behavior":case"plugin":r=e.GetPropertyValueByIndex(t);break;case"effect":r=e[t];break;case"instance-variable":r=e.GetInstanceVariableValue(t)}return r!==s}static Interpolate(t,e,s,i){if(!s){const t=i.GetPropertyTrackDataItem();return i.GetPropertyTrackData().GetLastPropertyKeyframeDataItem(t).GetValueWithResultMode()}let r=i.GetInterpolationMode();if("default"===r&&(r="continuous"),"combo"===i.GetPropertyType()&&(r="discrete"),"discrete"===r)return em.PropertyTrackState.GetPropertyKeyframeValueWithPlaybackDirection(e,s,i);if("continuous"===r||"step"===r){const n=i.GetTimeline().GetStep();if("step"===r&&0!==n){const e=1/n;t=Math.floor(t*e)/e}const a=e.GetTime(),o=s.GetTime(),h=e.GetValueWithResultMode(),l=s.GetValueWithResultMode();"step"===r&&0!==n&&(t=em.clamp(t,a,o));const c=e.GetAddOn("angle");if(!c){if(h===l)return h;const s=em.normalize(t,a,o),i=self.Ease.GetRuntimeEase(e.GetEase());return em.angleLerp(h,l,i(s,0,1,1))}{const s=c.GetRevolutions();if(h===l&&0===s)return h;const i=em.normalize(t,a,o),r=self.Ease.GetRuntimeEase(e.GetEase())(i,0,1,1);switch(c.GetDirection()){case"closest":return em.angleLerp(h,l,r,s);case"clockwise":return em.angleLerpClockwise(h,l,r,s);case"anti-clockwise":return em.angleLerpAntiClockwise(h,l,r,s)}}}}}}{const sm=self.C3;sm.PropertyTrackState.BooleanTypeAdapter=class{constructor(){}static WillChange(t,e,s,i){let r;switch(i){case"behavior":case"plugin":r=e.GetPropertyValueByIndex(t);break;case"effect":r=e[t];break;case"instance-variable":r=e.GetInstanceVariableValue(t)}return!!r!=!!s}static Interpolate(t,e,s,i){if(!s){const t=i.GetPropertyTrackDataItem();return i.GetPropertyTrackData().GetLastPropertyKeyframeDataItem(t).GetValueWithResultMode()?1:0}return sm.PropertyTrackState.GetPropertyKeyframeValueWithPlaybackDirection(e,s,i)?1:0}}}{const im=self.C3,rm=[0,0,0],nm=[0,0,0],am=[0,0,0];im.PropertyTrackState.ColorTypeAdapter=class{constructor(){}static WillChange(t,e,s,i){let r;switch(i){case"behavior":case"plugin":r=e.GetPropertyValueByIndex(t);break;case"effect":r=e[t];break;case"instance-variable":r=e.GetInstanceVariableValue(t)}return Array.isArray(s)?(rm[0]=s[0],rm[1]=s[1],rm[2]=s[2]):(am.parseCommaSeparatedRgb(s),rm[0]=Math.floor(255*am.getR()),rm[1]=Math.floor(255*am.getG()),rm[2]=Math.floor(255*am.getB())),Array.isArray(r)?(nm[0]=r[0],nm[1]=r[1],nm[2]=r[2]):(am.parseCommaSeparatedRgb(r),nm[0]=Math.floor(255*am.getR()),nm[1]=Math.floor(255*am.getG()),nm[2]=Math.floor(255*am.getB())),rm[0]!==nm[0]||rm[1]!==nm[1]||rm[2]!==nm[2]}static Interpolate(t,e,s,i){if(!s){const t=i.GetPropertyTrackDataItem(),e=i.GetPropertyTrackData().GetLastPropertyKeyframeDataItem(t).GetValueWithResultMode();return rm[0]=e[0],rm[1]=e[1],rm[2]=e[2],rm}let r=i.GetInterpolationMode();if("default"===r&&(r="continuous"),"discrete"===r){const t=im.PropertyTrackState.GetPropertyKeyframeValueWithPlaybackDirection(e,s,i);return rm[0]=t[0],rm[1]=t[1],rm[2]=t[2],rm}if("continuous"===r||"step"===r){const n=i.GetTimeline().GetStep();if("step"===r&&0!==n){const e=1/n;t=Math.floor(t*e)/e}const a=e.GetTime(),o=s.GetTime(),h=e.GetValueWithResultMode(),l=s.GetValueWithResultMode();"step"===r&&0!==n&&(t=im.clamp(t,a,o));const c=im.normalize(t,a,o),u=e.GetEase(),_=h[0],d=h[1],p=h[2],f=l[0],g=l[1],m=l[2],S=self.Ease.GetRuntimeEase(u),y=o-a,G=y*c;return rm[0]=_===f?_:S(G,_,f-_,y),rm[1]=d===g?d:S(G,d,g-d,y),rm[2]=p===m?p:S(G,p,m-p,y),rm}}}}{const om=self.C3;om.PropertyTrackState.TextTypeAdapter=class{constructor(){}static WillChange(t,e,s,i){let r;switch(i){case"behavior":case"plugin":r=e.GetPropertyValueByIndex(t);break;case"effect":r=e[t];break;case"instance-variable":r=e.GetInstanceVariableValue(t)}return r!==s}static Interpolate(t,e,s,i){if(!s){const t=i.GetPropertyTrackDataItem();return i.GetPropertyTrackData().GetLastPropertyKeyframeDataItem(t).GetValueWithResultMode()}return om.PropertyTrackState.GetPropertyKeyframeValueWithPlaybackDirection(e,s,i)}}}{const hm=self.C3;hm.TimelineDataManager=class{constructor(){this._timelineDataItems=new Map}Release(){for(const t of this._timelineDataItems.values())t.Release();this._timelineDataItems.clear(),this._timelineDataItems=null}Add(t){const e=new hm.TimelineDataItem(t),s=e.GetName();this._timelineDataItems.set(s,e)}Get(t){return this._timelineDataItems.get(t)}GetNameId(){return 0}static _CreateDataItems(t,e,s,i){if(e)for(const r of e)hm.TimelineDataManager._CreateDataItem("create",r,t,s,i)}static _CreateDataItemsIncludingDisabled(t,e,s,i){if(e)for(const r of e)hm.TimelineDataManager._CreateDataItem("create-including-disabled",r,t,s,i)}static _LoadDataItemsFromJson(t,e,s,i){t.length?e.forEach((e,s)=>{t[s]._LoadFromJson(e)}):e.forEach(e=>{hm.TimelineDataManager._CreateDataItem("load",e,t,s,i)})}static _CreateDataItem(t,e,s,i,r){let n;if("function"==typeof i)switch(t){case"load":n=new i(null,r);break;case"create":case"create-including-disabled":n=new i(e,r)}else if("object"==typeof i){const s=e[i.prop],a=i.map.get(s);switch(t){case"load":n=new a(null,r);break;case"create":case"create-including-disabled":n=new a(e,r)}}switch(t){case"load":n._LoadFromJson(e),s.push(n);break;case"create":if("function"==typeof n.GetEnable&&!n.GetEnable())return n.Release();s.push(n);break;case"create-including-disabled":s.push(n)}}}}{const lm=self.C3;lm.TimelineDataItem=class{constructor(t){this._name="",this._totalTime=NaN,this._step=0,this._interpolationMode="default",this._resultMode="default",this._loop=!1,this._pingPong=!1,this._repeatCount=1,this._trackData=null,this._startOnLayout="",this._transformWithSceneGraph=!1,this._useSystemTimescale=!0,t&&(this._name=t[0],this._totalTime=t[1],this._step=t[2],this._interpolationMode=t[3],this._resultMode=t[4],this._loop=!!t[6],this._pingPong=!!t[7],this._repeatCount=t[8],this._startOnLayout=t[9],this._transformWithSceneGraph=!!t[10],this._useSystemTimescale=!!t[11],this._trackData=new lm.TrackData(t[5],this))}Release(){this._trackData.Release(),this._trackData=null}GetTrackData(){return this._trackData||(this._trackData=new lm.TrackData(null,this)),this._trackData}GetName(){return this._name}SetName(t){this._name=t}GetTotalTime(){return this._totalTime}SetTotalTime(t){this._totalTime=t}GetStep(){return this._step}SetStep(t){this._step=t}GetInterpolationMode(){return this._interpolationMode}SetInterpolationMode(t){this._interpolationMode=t}GetResultMode(){return this._resultMode}SetResultMode(t){this._resultMode=t}GetLoop(){return this._loop}SetLoop(t){this._loop=t}GetPingPong(){return this._pingPong}SetPingPong(t){this._pingPong=t}GetRepeatCount(){return this._repeatCount}SetRepeatCount(t){this._repeatCount=t}GetStartOnLayout(){return this._startOnLayout}GetTransformWithSceneGraph(){return this._transformWithSceneGraph}GetUseSystemTimescale(){return this._useSystemTimescale}_SaveToJson(){return{trackDataJson:this._trackData._SaveToJson(),name:this._name,totalTime:this._totalTime,step:this._step,interpolationMode:this._interpolationMode,resultMode:this._resultMode,loop:this._loop,pingPong:this._pingPong,repeatCount:this._repeatCount,startOnLayout:this._startOnLayout,transformWithSceneGraph:!!this._transformWithSceneGraph,useSystemTimescale:this._useSystemTimescale}}_LoadFromJson(t){t&&(this.GetTrackData()._LoadFromJson(t.trackDataJson),this._name=t.name,this._totalTime=t.totalTime,this._step=t.step,this._interpolationMode=t.interpolationMode,this._resultMode=t.resultMode,this._loop=t.loop,this._pingPong=t.pingPong,this._repeatCount=t.repeatCount,this._startOnLayout=t.startOnLayout,this._transformWithSceneGraph=!!t.transformWithSceneGraph,this._useSystemTimescale=!!t.useSystemTimescale)}}}{const cm=self.C3;class um{constructor(t,e){this._trackData=e,this._instanceData=null,this._additionalInstanceData=null,this._instanceUid=NaN,this._objectClassIndex=NaN,this._interpolationMode="default",this._resultMode="default",this._enabled=!1,this._keyframeData=null,this._propertyTrackData=null,this._id="",this._nestedData=null,this._startOffset=0,this._localTotalTime=this._trackData.GetTimelineDataItem().GetTotalTime(),this._type=0,this._name="",t&&(t[0]&&(this._instanceData=t[0],this._instanceUid=t[0][2],this._objectClassIndex=t[0][1]),this._interpolationMode=t[1],this._resultMode=t[2],this._enabled=!!t[3],t[6]&&(this._id=t[6]),t[7]&&(this._nestedData=t[7],this._startOffset=t[7][0],this._localTotalTime=t[7][1]),t[8]&&(this._additionalInstanceData=t[8]),t[8]&&(this._additionalInstanceData=t[8]),t[9]&&(this._type=t[9]),t[10]&&(this._name=t[10]),this._keyframeData=new cm.KeyframeData(t[4],this),this._propertyTrackData=new cm.PropertyTrackData(t[5],this))}Release(){this._instanceData=null,this._trackData=null,this._keyframeData&&(this._keyframeData.Release(),this._keyframeData=null),this._propertyTrackData&&(this._propertyTrackData.Release(),this._propertyTrackData=null),this._nestedData=null}GetTrackData(){return this._trackData}GetKeyframeData(){return this._keyframeData||(this._keyframeData=new cm.KeyframeData(null,this)),this._keyframeData}GetPropertyTrackData(){return this._propertyTrackData||(this._propertyTrackData=new cm.PropertyTrackData(null,this)),this._propertyTrackData}GetInstanceData(){return this._instanceData}GetObjectClassIndex(){return this._objectClassIndex}SetObjectClassIndex(t){this._objectClassIndex=t}GetInstanceUID(){return this._instanceUid}SetInstanceUID(t){this._instanceUid=t}GetInterpolationMode(){return this._interpolationMode}SetInterpolationMode(t){this._interpolationMode=t}GetResultMode(){return this._resultMode}SetResultMode(t){this._resultMode=t}GetEnable(){return this._enabled}SetEnable(t){this._enabled=!!t}GetId(){return this._id}GetStartOffset(){return this._startOffset}GetLocalTotalTime(){return this._localTotalTime}SetLocalTotalTime(t){this._localTotalTime=t}GetOriginalWidth(){return this._additionalInstanceData[0]}SetOriginalWidth(t){this._additionalInstanceData||(this._additionalInstanceData=[]),this._additionalInstanceData[0]=t}GetOriginalHeight(){return this._additionalInstanceData||(this._additionalInstanceData=[]),this._additionalInstanceData[1]}SetOriginalHeight(t){this._additionalInstanceData||(this._additionalInstanceData=[]),this._additionalInstanceData[1]=t}GetType(){return this._type}GetName(){return this._name}_SaveToJson(){return{keyframeDataJson:this._keyframeData._SaveToJson(),propertyTrackDataJson:this._propertyTrackData._SaveToJson(),instanceData:this._instanceData,additionalInstanceData:this._additionalInstanceData,instanceUid:this._instanceUid,objectClassIndex:this._objectClassIndex,interpolationMode:this._interpolationMode,resultMode:this._resultMode,enabled:this._enabled,id:this._id,nestedData:this._nestedData,type:this._type,name:this._name}}_LoadFromJson(t){t&&(this._instanceData=t.instanceData,this._instanceUid=t.instanceUid,this._objectClassIndex=t.objectClassIndex,this._interpolationMode=t.interpolationMode,this._resultMode=t.resultMode,this._enabled=t.enabled,this._id=t.id,this._type=t.type?t.type:0,this._name=t.name?t.name:"",this._localTotalTime=this._trackData.GetTimelineDataItem().GetTotalTime(),t.nestedData&&(this._nestedData=t.nestedData,this._startOffset=this._nestedData[0],this._localTotalTime=this._nestedData[1]),t.additionalInstanceData&&(this._additionalInstanceData=t.additionalInstanceData),this.GetKeyframeData()._LoadFromJson(t.keyframeDataJson),this.GetPropertyTrackData()._LoadFromJson(t.propertyTrackDataJson))}}cm.TrackData=class{constructor(t,e){this._timelineDataItem=e,this._trackDataItems=[],cm.TimelineDataManager._CreateDataItems(this._trackDataItems,t,um,this)}Release(){this._timelineDataItem=null;for(const t of this._trackDataItems)t.Release();cm.clearArray(this._trackDataItems),this._trackDataItems=null}GetTimelineDataItem(){return this._timelineDataItem}AddEmptyTrackDataItem(){const t=new um(null,this);return this._trackDataItems.push(t),t}GetFirstKeyframeDataItem(t){return t.GetKeyframeData().GetKeyframeDataItemArray()[0]}GetLastKeyframeDataItem(t){return t.GetKeyframeData().GetKeyframeDataItemArray().at(-1)}GetKeyFrameDataItemAtTime(t,e){const s=e.GetKeyframeData().GetKeyframeDataItemArray(),i=s.length;for(let e=0;e<i;e++){const i=s[e];if(i.GetTime()===t)return i}}GetFirstKeyFrameDataItemHigherThan(t,e){const s=e.GetKeyframeData().GetKeyframeDataItemArray(),i=s.length;for(let e=0;e<i;e++){const i=s[e];if(i.GetTime()>t)return i}}GetFirstKeyFrameDataItemHigherOrEqualThan(t,e){const s=e.GetKeyframeData().GetKeyframeDataItemArray(),i=s.length;for(let e=0;e<i;e++){const i=s[e];if(i.GetTime()>=t)return i}}GetFirstKeyFrameDataItemLowerOrEqualThan(t,e){const s=e.GetKeyframeData().GetKeyframeDataItemArray();for(let e=s.length-1;e>=0;e--){const i=s[e];if(i.GetTime()<=t)return i}}*trackDataItems(){for(const t of this._trackDataItems)yield t}_SaveToJson(){return{trackDataItemsJson:this._trackDataItems.map(t=>t._SaveToJson())}}_LoadFromJson(t){t&&cm.TimelineDataManager._LoadDataItemsFromJson(this._trackDataItems,t.trackDataItemsJson,um,this)}}}{const _m=self.C3;class dm{constructor(t,e){this._propertyTrackData=e,this._sourceAdapterId="",this._sourceAdapterArguments=null,this._property=null,this._type=null,this._min=NaN,this._max=NaN,this._interpolationMode="default",this._resultMode="default",this._enabled=!1,this._propertyKeyframeData=null,this._canHavePropertyKeyframes=!0,t&&(this._sourceAdapterId=t[0][0],this._sourceAdapterArguments=t[0].slice(1),this._property=t[1],this._type=t[2],this._min=t[3],this._max=t[4],this._interpolationMode=t[5],this._resultMode=t[6],this._enabled=!!t[7],this._propertyKeyframeData=new _m.PropertyKeyframeData(t[8],this),this._canHavePropertyKeyframes=t[9])}Release(){this._propertyKeyframeData.Release(),this._propertyKeyframeData=null,this._propertyTrackData=null,this._sourceAdapterArguments=null}GetPropertyTrackData(){return this._propertyTrackData}GetPropertyKeyframeData(){return this._propertyKeyframeData||(this._propertyKeyframeData=new _m.PropertyKeyframeData(null,this)),this._propertyKeyframeData}GetSourceAdapterId(){return this._sourceAdapterId}SetSourceAdapterId(t){this._sourceAdapterId=t}GetSourceAdapterArguments(){return this._sourceAdapterArguments}SetSourceAdapterArguments(t){this._sourceAdapterArguments=t}GetProperty(){return this._property}SetProperty(t){this._property=t}GetType(){return this._type}SetType(t){this._type=t}GetMin(){return this._min}SetMin(t){this._min=t}GetMax(){return this._max}SetMax(t){this._max=t}GetInterpolationMode(){return this._interpolationMode}SetInterpolationMode(t){this._interpolationMode=t}GetResultMode(){return this._resultMode}SetResultMode(t){this._resultMode=t}GetEnable(){return this._enabled}SetEnable(t){this._enabled=!!t}CanHavePropertyKeyframes(){return!!this._canHavePropertyKeyframes}_SaveToJson(){return{propertyKeyframeDataJson:this._propertyKeyframeData._SaveToJson(),sourceAdapterId:this._sourceAdapterId,sourceAdapterArguments:this._sourceAdapterArguments,property:this._property,type:this._type,min:this._min,max:this._max,interpolationMode:this._interpolationMode,resultMode:this._resultMode,enabled:this._enabled,canHavePropertyKeyframes:this._canHavePropertyKeyframes}}_LoadFromJson(t){t&&(this._sourceAdapterId=t.sourceAdapterId,this._sourceAdapterArguments=t.sourceAdapterArguments,this._property=t.property,this._type=t.type,this._min=t.min,this._max=t.max,this._interpolationMode=t.interpolationMode,this._resultMode=t.resultMode,this._enabled=t.enabled,this._canHavePropertyKeyframes=t.canHavePropertyKeyframes,this.GetPropertyKeyframeData()._LoadFromJson(t.propertyKeyframeDataJson))}}_m.PropertyTrackData=class{constructor(t,e){this._trackDataItem=e,this._propertyTrackDataItems=[],_m.TimelineDataManager._CreateDataItems(this._propertyTrackDataItems,t,dm,this)}Release(){this._trackDataItem=null;for(const t of this._propertyTrackDataItems)t.Release();_m.clearArray(this._propertyTrackDataItems),this._propertyTrackDataItems=null}GetTrackDataItem(){return this._trackDataItem}AddEmptyPropertyTrackDataItem(){const t=new dm(null,this);return this._propertyTrackDataItems.push(t),t}GetFirstPropertyKeyframeDataItem(t){return t.GetPropertyKeyframeData().GetPropertyKeyframeDataItemArray()[0]}GetLastPropertyKeyframeDataItem(t){return t.GetPropertyKeyframeData().GetPropertyKeyframeDataItemArray().at(-1)}GetPropertyKeyFrameDataItemAtTime(t,e){const s=e.GetPropertyKeyframeData().GetPropertyKeyframeDataItemArray(),i=s.length;for(let e=0;e<i;e++){const i=s[e];if(i.GetTime()===t)return i}}GetFirstPropertyKeyFrameDataItemHigherThan(t,e){const s=e.GetPropertyKeyframeData().GetPropertyKeyframeDataItemArray(),i=s.length;for(let e=0;e<i;e++){const i=s[e];if(i.GetTime()>t)return i}}GetFirstPropertyKeyFrameDataItemHigherOrEqualThan(t,e){const s=e.GetPropertyKeyframeData().GetPropertyKeyframeDataItemArray(),i=s.length;for(let e=0;e<i;e++){const i=s[e];if(i.GetTime()>=t)return i}}GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(t,e){const s=e.GetPropertyKeyframeData().GetPropertyKeyframeDataItemArray();for(let e=s.length-1;e>=0;e--){const i=s[e];if(i.GetTime()<=t)return i}}*propertyTrackDataItems(){for(const t of this._propertyTrackDataItems)yield t}_SaveToJson(){return{propertyTrackDataItemsJson:this._propertyTrackDataItems.map(t=>t._SaveToJson())}}_LoadFromJson(t){t&&_m.TimelineDataManager._LoadDataItemsFromJson(this._propertyTrackDataItems,t.propertyTrackDataItemsJson,dm,this)}}}{const pm=self.C3;class fm{constructor(t,e){if(this._keyframeData=e,this._time=-1,this._ease="noease",this._enable=!1,this._tags=null,this._lowerTags=null,!t)return;this._time=t[0],this._ease=t[1],this._enable=!!t[2];const s=t[3];this._tags=s?s.split(" "):[],this._lowerTags=new Set(this._tags.map(t=>t.toLowerCase())),this._next=null,this._last=null}Release(){this._keyframeData=null,pm.clearArray(this._tags),this._tags=null,this._lowerTags.clear(),this._lowerTags=null,this._next=null}GetKeyframeData(){return this._keyframeData}GetNext(){return this._next}SetNext(t){this._next=t}GetLast(){return this._last}SetLast(t){this._last=t}GetTime(){return this._time}SetTime(t){this._time=t,this._keyframeData._LinkKeyframeDataItems()}GetEase(){return this._ease}SetEase(t){this._ease=t}GetEnable(){return this._enable}SetEnable(t){this._enable=!!t}GetTags(){return this._tags}SetTags(t){this._tags=t?t.split(" "):[],this._lowerTags=new Set(this._tags.map(t=>t.toLowerCase()))}GetLowerTags(){return this._lowerTags}GetTagsString(){return Array.from(this._lowerTags).join(",").trim()}HasTag(t){return this._lowerTags.has(t.toLowerCase())}_SaveToJson(){return{time:this._time,ease:this._ease,enable:this._enable,tags:this._tags}}_LoadFromJson(t){t&&(this._time=t.time,this._ease=t.ease,this._enable=t.enable,this._tags=t.tags,this._lowerTags=new Set(this._tags.map(t=>t.toLowerCase())))}}pm.KeyframeData=class{constructor(t,e){this._trackDataItem=e,this._keyframeDataItems=[],pm.TimelineDataManager._CreateDataItems(this._keyframeDataItems,t,fm,this),this._LinkKeyframeDataItems()}Release(){this._trackDataItem=null;for(const t of this._keyframeDataItems)t.Release();pm.clearArray(this._keyframeDataItems),this._keyframeDataItems=null}_LinkKeyframeDataItems(){this._keyframeDataItems.sort((t,e)=>t.GetTime()-e.GetTime());for(let t=0;t<this._keyframeDataItems.length;t++){const e=this._keyframeDataItems[t];e.SetNext(this._keyframeDataItems[t+1]),e.SetLast(this._keyframeDataItems[t-1])}}GetTrackDataItem(){return this._trackDataItem}GetKeyframeDataItemCount(){return this._keyframeDataItems.length}GetKeyframeDataItemArray(){return this._keyframeDataItems}AddEmptyKeyframeDataItem(){const t=new fm(null,this);return this._keyframeDataItems.push(t),this._LinkKeyframeDataItems(),t}DeleteKeyframeDataItems(t){for(const e of this._keyframeDataItems){if(!t(e))continue;const s=this._keyframeDataItems.indexOf(e);-1!==s&&(e.Release(),this._keyframeDataItems.splice(s,1))}this.SortKeyframeDataItems(),this._LinkKeyframeDataItems()}SortKeyframeDataItems(){this._keyframeDataItems.sort((t,e)=>t.GetTime()-e.GetTime())}GetKeyframeDataItemIndex(t){return this._keyframeDataItems.indexOf(t)}GetKeyframeDataItemFromIndex(t){return this._keyframeDataItems[t]}*keyframeDataItems(){for(const t of this._keyframeDataItems)yield t}*keyframeDataItemsReverse(){for(let t=this._keyframeDataItems.length-1;t>=0;t--)yield this._keyframeDataItems[t]}_SaveToJson(){return{keyframeDataItemsJson:this._keyframeDataItems.map(t=>t._SaveToJson())}}_LoadFromJson(t){t&&(pm.TimelineDataManager._LoadDataItemsFromJson(this._keyframeDataItems,t.keyframeDataItemsJson,fm,this),this._LinkKeyframeDataItems())}}}{const gm=self.C3;class mm{constructor(t,e){this._propertyKeyframeData=e,this._value=null,this._aValue=null,this._type="",this._time=NaN,this._ease="noease",this._enable=!1,this._addonData=null,this._addonInstance=void 0,this._pathMode="line",t&&(this._value=t[0][0],this._aValue=t[0][1],this._type=t[0][2],this._time=t[1],this._ease=t[2],this._enable=!!t[3],this._pathMode=t[5],this._addonData=null,t[4]&&(this._addonData=new gm.AddonData(t[4],this)),this._next=null,this._prev=null)}Release(){this._propertyKeyframeData=null,this._addonData&&(this._addonData.Release(),this._addonData=null),this._next=null,this._prev=null}GetAddonData(){return this._addonData}SetNext(t){this._next=t}GetNext(){return this._next}SetPrevious(t){this._prev=t}GetPrevious(){return this._prev}GetValue(){return this._value}SetValue(t){"color"===this._type&&gm.IsFiniteNumber(t)?(this._value[0]=gm.GetRValue(t),this._value[1]=gm.GetGValue(t),this._value[2]=gm.GetBValue(t)):this._value=t}GetAbsoluteValue(){return this._aValue}SetAbsoluteValue(t){"color"===this._type&&gm.IsFiniteNumber(t)?(this._aValue[0]=gm.GetRValue(t),this._aValue[1]=gm.GetGValue(t),this._aValue[2]=gm.GetBValue(t)):this._aValue=t}GetValueWithResultMode(){const t=this._propertyKeyframeData.GetPropertyTrackDataItem().GetResultMode();return"relative"===t?this.GetValue():"absolute"===t?this.GetAbsoluteValue():void 0}GetType(){return this._type}SetType(t){this._type=t}GetTime(){return this._time}SetTime(t){this._time=t,this._propertyKeyframeData._LinkPropertyKeyframeDataItems()}GetEase(){return this._ease}SetEase(t){this._ease=t}GetEnable(){return this._enable}SetEnable(t){this._enable=!!t}GetPathMode(){return this._pathMode}GetAddOn(t){if(!this._addonData)return;if(this._addonInstance||null===this._addonInstance)return this._addonInstance;const e=this._addonData.GetAddDataItemArray();if(!e)return this._addonInstance=null,this._addonInstance;const s=e.length;for(let i=0;i<s;i++){const s=e[i];if(s.GetId()===t)return this._addonInstance=s,this._addonInstance}return this._addonInstance=null,this._addonInstance}_SaveToJson(){const t=this._addonData;return{addonDataJson:t?t._SaveToJson():t,value:this._value,aValue:this._aValue,type:this._type,time:this._time,ease:this._ease,enable:this._enable}}_LoadFromJson(t){t&&(t.addonDataJson&&this._addonData._SetFromJson(t.addonDataJson),this._value=t.value,this._aValue=t.aValue,this._type=t.type,this._time=t.time,this._ease=t.ease,this._enable=t.enable)}}gm.PropertyKeyframeData=class{constructor(t,e){this._propertyTrackDataItem=e,this._propertyKeyframeDataItems=[],this._propertyKeyframeDataItemsIncludingDisabled=[],gm.TimelineDataManager._CreateDataItems(this._propertyKeyframeDataItems,t,mm,this),gm.TimelineDataManager._CreateDataItemsIncludingDisabled(this._propertyKeyframeDataItemsIncludingDisabled,t,mm,this),this._LinkPropertyKeyframeDataItems()}Release(){this._propertyTrackDataItem=null;for(const t of this._propertyKeyframeDataItems)t.Release();gm.clearArray(this._propertyKeyframeDataItems),this._propertyKeyframeDataItems=null;for(const t of this._propertyKeyframeDataItemsIncludingDisabled)t.Release();gm.clearArray(this._propertyKeyframeDataItemsIncludingDisabled),this._propertyKeyframeDataItemsIncludingDisabled=null}_LinkPropertyKeyframeDataItems(){let t=this._propertyKeyframeDataItems;t.sort((t,e)=>t.GetTime()-e.GetTime());for(let e=0;e<t.length;e++){const s=t[e];e+1<t.length&&s.SetNext(t[e+1]),e-1>=0&&s.SetPrevious(t[e-1])}t=this._propertyKeyframeDataItemsIncludingDisabled,t.sort((t,e)=>t.GetTime()-e.GetTime());for(let e=0;e<t.length;e++){const s=t[e];e+1<t.length&&s.SetNext(t[e+1]),e-1>=0&&s.SetPrevious(t[e-1])}}AddEmptyPropertyKeyframeDataItem(){const t=new mm(null,this);return this._propertyKeyframeDataItems.push(t),this._LinkPropertyKeyframeDataItems(),t}DeletePropertyKeyframeDataItems(t){for(const e of this._propertyKeyframeDataItems){if(!t(e))continue;const s=this._propertyKeyframeDataItems.indexOf(e);-1!==s&&(e.Release(),this._propertyKeyframeDataItems.splice(s,1))}this.SortPropertyKeyFrameDataItems(),this._LinkPropertyKeyframeDataItems()}SortPropertyKeyFrameDataItems(){this._propertyKeyframeDataItems.sort((t,e)=>t.GetTime()-e.GetTime())}GetPropertyTrackDataItem(){return this._propertyTrackDataItem}GetPropertyKeyframeDataItemCount(){return this._propertyKeyframeDataItems.length}GetLastPropertyKeyframeDataItem(){return this._propertyKeyframeDataItems[this._propertyKeyframeDataItems.length-1]}GetPropertyKeyframeDataItemArray(){return this._propertyKeyframeDataItems}GetPropertyKeyframeDataItemArrayIncludingDisabled(){return this._propertyKeyframeDataItemsIncludingDisabled}*propertyKeyframeDataItems(){for(const t of this._propertyKeyframeDataItems)yield t}*propertyKeyframeDataItemsReverse(){for(let t=this._propertyKeyframeDataItems.length-1;t>=0;t--)yield this._propertyKeyframeDataItems[t]}_SaveToJson(){const t=this._propertyKeyframeDataItems,e=this._propertyKeyframeDataItemsIncludingDisabled;return{propertyKeyframeDataItemsJson:t.map(t=>t._SaveToJson()),propertyKeyframeDataItemsIncludingDisabledJson:e.map(t=>t._SaveToJson())}}_LoadFromJson(t){t&&(gm.TimelineDataManager._LoadDataItemsFromJson(this._propertyKeyframeDataItems,t.propertyKeyframeDataItemsJson,mm,this),gm.TimelineDataManager._LoadDataItemsFromJson(this._propertyKeyframeDataItemsIncludingDisabled,t.propertyKeyframeDataItemsIncludingDisabledJson,mm,this),this._LinkPropertyKeyframeDataItems())}}}{const Sm=self.C3;class ym{constructor(t,e){this._addonData=e,this._id=t[0],this._data=t[1]}Release(){this._addonData=null,this._data=null}GetAddonData(){return this._addonData}GetId(){return this._id}_SaveToJson(){return{id:this._id,data:this._data}}_LoadFromJson(t){t&&(this._id=t.id,this._data=t.data)}}class Gm extends ym{constructor(t,e){super(t,e),this._startAnchor=this._data[0],this._startEnable=!!this._data[1],this._endAnchor=this._data[2],this._endEnable=!!this._data[3]}Release(){super.Release()}GetStartAnchor(){return this._startAnchor}GetStartEnable(){return this._startEnable}GetEndAnchor(){return this._endAnchor}GetEndEnable(){return this._endEnable}_SaveToJson(){return Object.assign(super._SaveToJson(),{startAnchor:this._startAnchor,startEnable:!!this._startEnable,endAnchor:this._endAnchor,endEnable:!!this._endEnable})}_LoadFromJson(t){t&&(super._LoadFromJson(t),this._startAnchor=t.startAnchor,this._startEnable=!!t.startEnable,this._endAnchor=t.endAnchor,this._endEnable=!!t.endEnable)}}class Tm extends ym{constructor(t,e){super(t,e),this._direction=this._data[0],this._revolutions=this._data[1]}Release(){super.Release()}GetDirection(){return this._direction}GetRevolutions(){return this._revolutions}_SaveToJson(){return Object.assign(super._SaveToJson(),{direction:this._direction,revolutions:this._revolutions})}_LoadFromJson(t){t&&(super._LoadFromJson(t),this._direction=t.direction,this._revolutions=t.revolutions)}}class Im extends ym{constructor(t,e){super(t,e),this._startFrom=this._data[0]}Release(){super.Release()}GetStartFrom(){return this._startFrom}_SaveToJson(){return Object.assign(super._SaveToJson(),{startFrom:this._startFrom})}_LoadFromJson(t){t&&(super._LoadFromJson(t),this._startFrom=t.startFrom)}}Sm.AddonData=class{constructor(t,e){this._propertyKeyframeDataItem=e,this._addonDataItems=[],Sm.TimelineDataManager._CreateDataItems(this._addonDataItems,t,{prop:0,map:new Map([["cubic-bezier",Gm],["angle",Tm],["initial-animation",Im]])},this)}Release(){this._propertyKeyframeDataItem=null;for(const t of this._addonDataItems)t.Release();Sm.clearArray(this._addonDataItems),this._addonDataItems=null}GetPropertyKeyframeDataItem(){return this._propertyKeyframeDataItem}GetAddDataItemArray(){return this._addonDataItems}*addonDataItems(){for(const t of this._addonDataItems)yield t}_SaveToJson(){return{addonDataItemsJson:this._addonDataItems.map(t=>t._SaveToJson())}}_LoadFromJson(t){t&&Sm.TimelineDataManager._LoadDataItemsFromJson(this._addonDataItems,t.addonDataItemsJson,{prop:"id",map:new Map([["cubic-bezier",Gm],["angle",Tm],["initial-animation",Im]])},this)}}}{const Cm=self.C3;let bm=0;Cm.TweenState=class extends Cm.TimelineState{constructor(t,e){super("tween-"+bm++,t,e),this._id="",this._destroyInstanceOnComplete=!1,this._initialValueMode="start-value",this._instance=null,this._on_completed_callbacks=null,this._on_started_callbacks=null,this._releasePromise=null,this._releaseResolve=null,this._behInst=null,this._track=null,this._iTweenState=null}Release(){this.IsReleased()||(this._TweenTrigger(Cm.Behaviors.Tween.Cnds.OnTweensReleased),this._TweenTrigger(Cm.Behaviors.Tween.Cnds.OnAnyTweensReleased),this.ResolveReleasePromise(),super.Release(),this._instance=null,this._on_completed_callbacks=null,this._on_started_callbacks=null,this._behInst=null,this._track=null,this._releasePromise=null,this._releaseResolve=null)}FireReleaseEvent(t){const e=Cm.New(Cm.Event,"tweenstatereleased");e.tweenState=this,t.dispatchEvent(e)}GetType(){return 1}CreateTrackStates(){for(const t of this._timelineDataItem.GetTrackData().trackDataItems())this._tracks.push(Cm.TweenTrackState.Create(this,t));this._track=this._tracks[0]}AddTrack(){const t=this._timelineDataItem.GetTrackData().AddEmptyTrackDataItem(),e=Cm.TweenTrackState.Create(this,t);return this._tracks.push(e),this._CacheTrack(),e}_CacheTrack(){this._track=this._tracks[0]}GetPropertyTrack(t){return this._track.GetPropertyTracks()[0]}SetPropertyType(t){this._propertyType=t}GetInstance(){const t=this.GetTracks();if(!t||!t.length)return;const e=t[0];if(this._track=e,!e)return;const s=e.GetInstance();return e.IsInstanceValid()?s:void 0}SetBehaviorInstance(t){this._behInst=t}GetReleasePromise(){return this._releasePromise||(this._releasePromise=new Promise(t=>{this._releaseResolve=t})),this._releasePromise}ResolveReleasePromise(){this._releasePromise&&(this._releaseResolve&&this._releaseResolve(),this._releasePromise=null,this._releaseResolve=null)}AddStartedCallback(t){this._on_started_callbacks||(this._on_started_callbacks=[]),this._on_started_callbacks.push(t)}AddCompletedCallback(t){this._on_completed_callbacks||(this._on_completed_callbacks=[]),this._on_completed_callbacks.push(t)}RemoveStartedCallback(t){if(!this._on_started_callbacks)return;const e=this._on_started_callbacks.indexOf(t);-1!==e&&this._on_started_callbacks.splice(e,1)}RemoveCompletedCallback(t){if(!this._on_completed_callbacks)return;const e=this._on_completed_callbacks.indexOf(t);-1!==e&&this._on_completed_callbacks.splice(e,1)}SetStartValue(t,e){for(const s of this._tracks)for(const i of s._propertyTracks){if(i.GetPropertyName()!==e)continue;const s=i.GetPropertyTrackData(),r=i.GetPropertyTrackDataItem(),n=s.GetFirstPropertyKeyframeDataItem(r);n.SetValue(t),n.SetAbsoluteValue(t)}}_GetPropertyTrackState(t){for(const e of this._tracks)for(const s of e._propertyTracks)if(s.GetPropertyName()===t)return s}BeforeSetEndValues(t){let e=!1;for(const s of t){const t=this._GetPropertyTrackState(s);t&&(this.SetStartValue(t.GetCurrentState(),s),e=!0)}if(e){if(this.IsForwardPlayBack()){const t=this.GetTotalTime()-this.GetTime();this.SetTotalTime(t);for(const e of this._tracks)e.SetLocalTotalTime(t);this._SetTime(0)}else{const t=this.GetTime();this.SetTotalTime(t);for(const e of this._tracks)e.SetLocalTotalTime(t);this._SetTime(t)}this.SetInitialStateFromSetTime()}}SetEndValue(t,e){const s=this._GetPropertyTrackState(e);if(!s)return;const i=s.GetPropertyTrackData(),r=s.GetPropertyTrackDataItem(),n=i.GetLastPropertyKeyframeDataItem(r);n.SetTime(this.GetTotalTime()),n.SetValue(t),n.SetAbsoluteValue(t)}SetId(t){this._id=t}GetId(){return this._id}SetInitialValueMode(t){this._initialValueMode=t}GetInitialValueMode(){return this._initialValueMode}SetDestroyInstanceOnComplete(t){this._destroyInstanceOnComplete=t}GetDestroyInstanceOnComplete(){return this._destroyInstanceOnComplete}OnStarted(){if(this._on_started_callbacks)for(const t of this._on_started_callbacks)t(this);if(!this.IsComplete())for(const t of this._tracks)t.CompareSaveStateWithCurrent()}OnCompleted(){this._completedTick=this._runtime.GetTickCount()}FinishTriggers(){if(!this._finishedTriggers&&(this._finishedTriggers=!0,this._on_completed_callbacks))for(const t of this._on_completed_callbacks)t(this)}SetTime(t){this._DeleteIntermediateKeyframes(),super.SetTime(t)}_SetTimeAndReset(t){Cm.IsFiniteNumber(t)||(t=this.GetTotalTime()),t<0?this._playheadTime=0:t>=this.GetTotalTime()?this._playheadTime=this.GetTotalTime():this._playheadTime=t,this._track.SetResetState()}SetInitialState(t){if(!this.InitialStateSet()&&"current-state"===this.GetInitialValueMode())for(const t of this._tracks)t.CompareInitialStateWithCurrent();super.SetInitialState(t)}Stop(t=!1){if(super.Stop(t),!this.IsComplete())for(const t of this._tracks)t.SaveState()}Reset(t=!0,e=!1){this._DeleteIntermediateKeyframes(),super.Reset(t,e)}_DeleteIntermediateKeyframes(){for(const t of this._tracks){const e=t=>{const e=t.GetTime(),s=this.GetTotalTime();return 0!==e&&e!==s};t.DeleteKeyframes(e),t.DeletePropertyKeyframes(e)}}_OnBeforeChangeLayout(){if(this.IsReleased())return!0;const t=this.GetInstance();return!(t&&t.GetObjectClass().IsGlobal()||(this._timelineManager.CompleteTimelineBeforeChangeOfLayout(this),this.ResetBeforeChangeLayout(),0))}Tick(t,e,s){if(this._instance||(this._instance=this.GetInstance()),!this._instance||this._instance.IsDestroyed())return this.Stop(!0),void this.OnCompleted();const i=this._instance.GetTimeScale();if(-1!==i&&(t=s*i),0===t&&0===this._lastDelta)return;this._lastDelta=t;const r=this._playheadTime+this._overshoot+t*this._playbackRate,n=this._timelineDataItem._totalTime;r<0?(this._playheadTime=0,this._overshoot=-r):r>=n?(this._playheadTime=n,this._overshoot=this._playheadTime-r):(this._playheadTime=r,this._overshoot=0);let a=!1,o=!1;const h=this.GetLoop(),l=this.GetPingPong();if(h||l?h&&!l?this._playbackRate>0?this._playheadTime>=n&&(this._SetTimeAndReset(0),this._TweenTrigger(Cm.Behaviors.Tween.Cnds.OnAnyTweenLoop),this._TweenTrigger(Cm.Behaviors.Tween.Cnds.OnTweensLoop),o=!0):this._playheadTime<=0&&(this._SetTimeAndReset(n),this._TweenTrigger(Cm.Behaviors.Tween.Cnds.OnAnyTweenLoop),this._TweenTrigger(Cm.Behaviors.Tween.Cnds.OnTweensLoop),o=!0):!h&&l?this._playbackRate>0?this._playheadTime>=n&&(this._SetTime(n),this.SetPlaybackRate(-1*this.GetPlaybackRate()),o=!0,1===this._pingPongState?this._currentRepeatCount<this.GetRepeatCount()?(this._currentRepeatCount++,this._TweenTrigger(Cm.Behaviors.Tween.Cnds.OnAnyTweenLoop),this._TweenTrigger(Cm.Behaviors.Tween.Cnds.OnTweensLoop),this._TweenTrigger(Cm.Behaviors.Tween.Cnds.OnAnyTweenPingPong),this._TweenTrigger(Cm.Behaviors.Tween.Cnds.OnTweensPingPong),this.IsPlaying()?this._pingPongState=0:this._resumePingPongState=0):(this._TweenTrigger(Cm.Behaviors.Tween.Cnds.OnAnyTweenPingPong),this._TweenTrigger(Cm.Behaviors.Tween.Cnds.OnTweensPingPong),a=!0):0===this._pingPongState&&(this._TweenTrigger(Cm.Behaviors.Tween.Cnds.OnAnyTweenPingPong),this._TweenTrigger(Cm.Behaviors.Tween.Cnds.OnTweensPingPong),this.IsPlaying()?this._pingPongState=1:this._resumePingPongState=1)):this._playheadTime<=0&&(this._SetTime(0),this.SetPlaybackRate(-1*this.GetPlaybackRate()),o=!0,1===this._pingPongState?this._currentRepeatCount<this.GetRepeatCount()?(this._currentRepeatCount++,this._TweenTrigger(Cm.Behaviors.Tween.Cnds.OnAnyTweenLoop),this._TweenTrigger(Cm.Behaviors.Tween.Cnds.OnTweensLoop),this._TweenTrigger(Cm.Behaviors.Tween.Cnds.OnAnyTweenPingPong),this._TweenTrigger(Cm.Behaviors.Tween.Cnds.OnTweensPingPong),this.IsPlaying()?this._pingPongState=0:this._resumePingPongState=0):(a=!0,this._TweenTrigger(Cm.Behaviors.Tween.Cnds.OnAnyTweenPingPong),this._TweenTrigger(Cm.Behaviors.Tween.Cnds.OnTweensPingPong)):0===this._pingPongState&&(this._TweenTrigger(Cm.Behaviors.Tween.Cnds.OnAnyTweenPingPong),this._TweenTrigger(Cm.Behaviors.Tween.Cnds.OnTweensPingPong),this.IsPlaying()?this._pingPongState=1:this._resumePingPongState=1)):h&&l&&(this._playbackRate>0?this._playheadTime>=n&&(this._SetTime(n),this.SetPlaybackRate(-1*this.GetPlaybackRate()),o=!0,0===this._pingPongState&&(this._TweenTrigger(Cm.Behaviors.Tween.Cnds.OnAnyTweenPingPong),this._TweenTrigger(Cm.Behaviors.Tween.Cnds.OnTweensPingPong)),1===this._pingPongState&&(this._TweenTrigger(Cm.Behaviors.Tween.Cnds.OnAnyTweenLoop),this._TweenTrigger(Cm.Behaviors.Tween.Cnds.OnTweensLoop),this._TweenTrigger(Cm.Behaviors.Tween.Cnds.OnAnyTweenPingPong),this._TweenTrigger(Cm.Behaviors.Tween.Cnds.OnTweensPingPong)),this.IsPlaying()?(this._pingPongState++,this._pingPongState=Cm.wrap(this._pingPongState,0,2)):(this._resumePingPongState=this._pingPongState+1,this._resumePingPongState=Cm.wrap(this._resumePingPongState,0,2))):this._playheadTime<=0&&(this._SetTime(0),this.SetPlaybackRate(-1*this.GetPlaybackRate()),o=!0,0===this._pingPongState&&(this._TweenTrigger(Cm.Behaviors.Tween.Cnds.OnAnyTweenPingPong),this._TweenTrigger(Cm.Behaviors.Tween.Cnds.OnTweensPingPong)),1===this._pingPongState&&(this._TweenTrigger(Cm.Behaviors.Tween.Cnds.OnAnyTweenLoop),this._TweenTrigger(Cm.Behaviors.Tween.Cnds.OnTweensLoop),this._TweenTrigger(Cm.Behaviors.Tween.Cnds.OnAnyTweenPingPong),this._TweenTrigger(Cm.Behaviors.Tween.Cnds.OnTweensPingPong)),this.IsPlaying()?(this._pingPongState++,this._pingPongState=Cm.wrap(this._pingPongState,0,2)):(this._resumePingPongState=this._pingPongState+1,this._resumePingPongState=Cm.wrap(this._resumePingPongState,0,2)))):this._playbackRate>0?this._playheadTime>=n&&(this._currentRepeatCount<this.GetRepeatCount()?(this._currentRepeatCount++,this._SetTimeAndReset(0),this._TweenTrigger(Cm.Behaviors.Tween.Cnds.OnAnyTweenLoop),this._TweenTrigger(Cm.Behaviors.Tween.Cnds.OnTweensLoop),o=!0):(this._SetTime(n),a=!0)):this._playheadTime<=0&&(this._currentRepeatCount<this.GetRepeatCount()?(this._currentRepeatCount++,this._SetTimeAndReset(n),this._TweenTrigger(Cm.Behaviors.Tween.Cnds.OnAnyTweenLoop),this._TweenTrigger(Cm.Behaviors.Tween.Cnds.OnTweensLoop),o=!0):(this._SetTime(0),a=!0)),!this.IsReleased()&&this.IsPlaying()){if(a)return this._track.SetEndState(),this.Stop(!0),void this.OnCompleted();this._track.Interpolate(this._playheadTime,!0,!1,o,this._firstTick,!1),this._firstTick&&(this._firstTick=!1)}}_TweenTrigger(t){const e=this.GetInstance();this._behInst.PushTriggerTween(this),this._runtime.Trigger(t,e,this._behInst.GetBehaviorType()),this._behInst.PopTriggerTween()}_SaveToJson(){const t=super._SaveToJson(),e=this.GetTimelineDataItem();return Object.assign(t,{tweenDataItemJson:e._SaveToJson(),id:this._id,destroyInstanceOnComplete:this._destroyInstanceOnComplete,initialValueMode:this._initialValueMode})}_LoadFromJson(t){t&&(this.GetTimelineDataItem()._LoadFromJson(t.tweenDataItemJson),super._LoadFromJson(t),this._id=t.id,this._destroyInstanceOnComplete=t.destroyInstanceOnComplete,this._initialValueMode=t.initialValueMode,this._CacheTrack())}static IsPlaying(t){return t.IsPlaying()}static IsPaused(t){return t.IsPaused()}static IsPing(t){return!!t.GetPingPong()&&0===t.GetPingPongState()}static IsPong(t){return!!t.GetPingPong()&&1===t.GetPingPongState()}static Build(t){const e=t.runtime.GetTimelineManager(),s=new Cm.TimelineDataItem;if(t.json){s._LoadFromJson(t.json.tweenDataItemJson);const i=new Cm.TweenState(s,e);return i._LoadFromJson(t.json),i}{const i=new Cm.TweenState(s,e);Cm.IsArray(t.propertyTracksConfig)||(t.propertyTracksConfig=[t.propertyTracksConfig]),i.SetId(t.id),i.SetTags(t.tags),i.SetInitialValueMode(t.initialValueMode),i.SetDestroyInstanceOnComplete(t.releaseOnComplete),i.SetLoop(t.loop),i.SetPingPong(t.pingPong),i.SetTotalTime(t.time),i.SetStep(0),i.SetInterpolationMode("default"),i.SetResultMode(t.propertyTracksConfig[0].resultMode),i.SetRepeatCount(t.repeatCount);const r=i.AddTrack();r.SetInstanceUID(t.instance.GetUID()),r.SetInterpolationMode("default"),r.SetResultMode(t.propertyTracksConfig[0].resultMode),r.SetEnable(!0),r.SetObjectClassIndex(t.instance.GetObjectClass().GetIndex());const n=t.instance.GetSdkInstance(),a=n.IsOriginalSizeKnown()?n.GetOriginalWidth():t.instance.GetWorldInfo().GetWidth(),o=n.IsOriginalSizeKnown()?n.GetOriginalHeight():t.instance.GetWorldInfo().GetHeight();r.SetOriginalWidth(a),r.SetOriginalHeight(o);const h=r.AddKeyframe();h.SetTime(0),h.SetEase("noease"),h.SetEnable(!0),h.SetTags("");const l=r.AddKeyframe();l.SetTime(t.time),l.SetEase("noease"),l.SetEnable(!0),l.SetTags("");for(const e of t.propertyTracksConfig){const s=r.AddPropertyTrack();s.SetSourceAdapterId(e.sourceId),s.SetSourceAdapterArgs(e.sourceArgs),s.SetPropertyName(e.property),s.SetPropertyType(e.type),s.SetMin(NaN),s.SetMax(NaN),s.SetInterpolationMode("default"),s.SetResultMode(e.resultMode),s.SetEnable(!0);const i=s.AddPropertyKeyframe();i.SetType(e.valueType),i.SetTime(0),i.SetEase(e.ease),i.SetEnable(!0),i.SetValue(e.startValue),i.SetAbsoluteValue(e.startValue);const n=s.AddPropertyKeyframe();n.SetType(e.valueType),n.SetTime(t.time),n.SetEase(e.ease),n.SetEnable(!0),n.SetValue(e.endValue),n.SetAbsoluteValue(e.endValue),s.GetSourceAdapter()}return i}}static SetInstanceUID(t,e){if(!isNaN(e))for(const s of t.GetTracks())s.SetInstanceUID(e)}static SetBehaviorInstance(t,e){t.SetBehaviorInstance(e)}GetITweenState(t,e){return this._iTweenState||(this._iTweenState=Cm.New(self.ITweenState,this,t,e)),this._iTweenState}}}{const xm=self.C3;xm.TweenTrackState=class extends xm.TrackState{constructor(t,e){super(t,e),this._firstPropertyTrack=null,this._secondPropertyTrack=null}static Create(t,e){return xm.New(xm.TweenTrackState,t,e)}_CachePropertyTracks(){1===this._propertyTracks.length?this._firstPropertyTrack=this._propertyTracks[0]:(this._firstPropertyTrack=this._propertyTracks[0],this._secondPropertyTrack=this._propertyTracks[1])}CreatePropertyTrackStates(){for(const t of this._trackDataItem.GetPropertyTrackData().propertyTrackDataItems())this._propertyTracks.push(xm.TweenPropertyTrackState.Create(this,t));this._CachePropertyTracks()}AddPropertyTrack(){const t=this._trackDataItem.GetPropertyTrackData().AddEmptyPropertyTrackDataItem(),e=xm.TweenPropertyTrackState.Create(this,t);return this._propertyTracks.push(e),this._CachePropertyTracks(),e}SetInitialState(){if(this.MaybeGetInstance(),!this.IsInstanceValid()&&this.IsInstanceTrack())return;const t=this.GetTimeline().IsForwardPlayBack()?0:this.GetLocalTotalTime();for(const e of this._propertyTracks)e.SetInitialState(t),0===this._worldInfoChange&&1===e.GetWorldInfoChange()&&(this._worldInfoChange=1),0===this._renderChange&&1===e.GetRenderChange()&&(this._renderChange=1);this._needsBeforeAndAfter=0,this._propertyTracks.some(t=>t.GetNeedsBeforeAndAfter())&&(this._needsBeforeAndAfter=1),this._lastKeyframeDataItem=this._GetLastKeyFrameBeforeTime(t),this._initialStateOfNestedSet=!1,this._endStateOfNestedSet=!1,this.Interpolate(t)}BeforeInterpolate(){}Interpolate(t,e=!1,s=!1,i=!1,r=!1,n=!1,a=!1){if(this._instance||this.GetInstance(),this._instance)return!this._instance.IsDestroyed()&&(!n||!this.GetObjectClass().IsGlobal())&&(this._secondPropertyTrack?(this._firstPropertyTrack.Interpolate(t,s,i,a),this._secondPropertyTrack.Interpolate(t,s,i,a)):this._firstPropertyTrack.Interpolate(t,s,i,a),void(0!==this._firstPropertyTrack.GetWorldInfoChange()&&(this._worldInfo||(this._worldInfo=this._instance.GetWorldInfo()),this._worldInfo&&this._worldInfo.SetBboxChanged())))}AfterInterpolate(){}_LoadFromJson(t){super._LoadFromJson(t),this._CachePropertyTracks()}}}{const wm=self.C3;wm.TweenPropertyTrackState=class extends wm.PropertyTrackState{constructor(t,e){super(t,e),this._basic=!1}static Create(t,e){return wm.New(wm.TweenPropertyTrackState,t,e)}Interpolate(t,e=!1,s=!1,i=!1){let r,n;if(this._basic)r=this._propertyKeyframeDataItems[0],n=this._propertyKeyframeDataItems[1];else if(e)r=this._propertyTrackData.GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(t,this._propertyTrackDataItem),n=r.GetNext();else{if(this._lastPropertyKeyframeDataItem){const e=this.GetTimeline(),s=this._lastPropertyKeyframeDataItem.GetNext(),i=this._lastPropertyKeyframeDataItem.GetTime(),r=s?s.GetTime():e.GetTotalTime();(t<=i||t>=r)&&(this._lastPropertyKeyframeDataItem=this._propertyTrackData.GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(t,this._propertyTrackDataItem))}else this._lastPropertyKeyframeDataItem=this._propertyTrackData.GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(t,this._propertyTrackDataItem);r=this._lastPropertyKeyframeDataItem,n=r.GetNext()}this._sourceAdapter.Interpolate(t,r,n,e,s,i)}AddPropertyKeyframe(){const t=this._propertyTrackDataItem.GetPropertyKeyframeData().AddEmptyPropertyKeyframeDataItem();return this._lastPropertyKeyframeDataItem=null,this._basic=this.GetPropertyKeyframeDataItems().length<=2,t}DeletePropertyKeyframes(t){this._lastPropertyKeyframeDataItem=null,this._propertyTrackDataItem.GetPropertyKeyframeData().DeletePropertyKeyframeDataItems(t),this._basic=this.GetPropertyKeyframeDataItems().length<=2}_SaveToJson(){return{sourceAdapterJson:this.GetSourceAdapter()._SaveToJson(),basic:this._basic}}_LoadFromJson(t){t&&(this.GetSourceAdapter()._LoadFromJson(t.sourceAdapterJson),this._basic=t.basic)}}}{const Mm=self.C3,Pm=self.Ease;Mm.Transition=class extends Mm.DefendedBase{constructor(t,e=!0){super(),this._name=t[0],this._linear=t[2],this._transitionKeyframes=[];for(const e of t[1]){const t=Mm.TransitionKeyframe.Create(this,e);this._transitionKeyframes.push(t)}for(let t=0;t<this._transitionKeyframes.length;t++){const e=this._transitionKeyframes[t],s=this._transitionKeyframes[t+1],i=this._transitionKeyframes[t-1];e.SetNext(s),e.SetPrevious(i)}this._precalculatedSamples=new Map,this._transitionKeyframeCache=new Map,this._PreCalcSamples(),e&&Pm.AddCustomEase(this._name,(t,e,s,i)=>this.Interpolate(t,e,s,i),null,{transition:this})}static Create(t){return Mm.New(Mm.Transition,t)}Release(){for(const t of this._transitionKeyframes)t.Release();Mm.clearArray(this._transitionKeyframes),this._transitionKeyframes=null,this._precalculatedSamples.clear(),this._precalculatedSamples=null,this._transitionKeyframeCache.clear(),this._transitionKeyframeCache=null}MakeLinear(t){this._linear=!!t}GetTransitionKeyFrameAt(t){const e=this._transitionKeyframeCache.get(t);if(e)return e;for(const e of this._transitionKeyframes)if(e.GetValueX()===t)return this._transitionKeyframeCache.set(t,e),e}GetFirstTransitionKeyFrameLowerOrEqualThan(t){for(let e=this._transitionKeyframes.length-1;e>=0;e--){const s=this._transitionKeyframes[e],i=s.GetValueX();if(i<=t){let e=s;if(i<t)return e;if(i===t){for(;e;){const t=e.GetPrevious();if(!t)break;if(t.GetValueX()!==e.GetValueX())break;e=t}return e}}}}Interpolate(t,e,s,i){let r=t/i;if(this._linear){const r=this.GetTransitionKeyFrameAt(0),n=this.GetTransitionKeyFrameAt(1),a=e+(e+s)*r.GetValueY(),o=(e+s)*n.GetValueY()-a;return 0===i?a+o:Pm.NoEase(t,a,o,i)}0===i&&(r=1);let n=this.GetFirstTransitionKeyFrameLowerOrEqualThan(r),a=n.GetNext();if(!a){const t=n.GetPrevious(),e=n;n=t,a=e}const o=a.GetValueX()-n.GetValueX(),h=Mm.mapToRange(r,n.GetValueX(),a.GetValueX(),0,o);if(n.IsSegmentLinear()||0===o){const t=e+(e+s)*n.GetValueY(),i=(e+s)*a.GetValueY()-t;return 0===o?1===h?t+i:t:Pm.NoEase(h,t,i,o)}const l=n.GetValueX(),c=n.GetValueY(),u=n.GetValueX()+n.GetStartAnchorX(),_=n.GetValueY()+n.GetStartAnchorY(),d=a.GetValueX()+a.GetEndAnchorX(),p=a.GetValueY()+a.GetEndAnchorY(),f=a.GetValueX(),g=a.GetValueY();let m=Pm.GetRuntimeEase("spline")(h,l,c,u,_,d,p,f,g,this._precalculatedSamples.get(n));return m+=n.GetValueY(),(1-m)*e+m*(e+s)}_PreCalcSamples(){this._precalculatedSamples.clear();for(let t=0;t<this._transitionKeyframes.length-1;t++){const e=this._transitionKeyframes[t];if(!e.GetStartEnable())continue;const s=e,i=this._transitionKeyframes[t+1];if(!i.GetEndEnable())continue;const r=s.GetValueX(),n=s.GetValueX()+s.GetStartAnchorX(),a=i.GetValueX()+i.GetEndAnchorX(),o=i.GetValueX();this._precalculatedSamples.set(s,Pm.GetBezierSamples(r,n,a,o))}}}}{const vm=self.C3;vm.TransitionKeyframe=class extends vm.DefendedBase{constructor(t,e){super(),this._transition=t,this._valueX=e[0],this._valueY=e[1],this._startAnchorX=e[2],this._startAnchorY=e[3],this._endAnchorX=e[4],this._endAnchorY=e[5],this._startEnable=e[6],this._endEnable=e[7],this._segmentMode=e[8],this._next=null,this._prev=null}Release(){this._transition=null}static Create(t,e){return vm.New(vm.TransitionKeyframe,t,e)}SetNext(t){this._next=t}GetNext(){return this._next}SetPrevious(t){this._prev=t}GetPrevious(){return this._prev}GetValueX(){return this._valueX}GetValueY(){return this._valueY}GetStartAnchorX(){return this._startAnchorX}GetStartAnchorY(){return this._startAnchorY}GetEndAnchorX(){return this._endAnchorX}GetEndAnchorY(){return this._endAnchorY}GetStartEnable(){return this._startEnable}GetEndEnable(){return this._endEnable}IsSegmentLinear(){return"linear"===this._segmentMode}IsSegmentCubic(){return"cubic"===this._segmentMode}}}{const Rm=self.C3;Rm.TransitionManager=class extends Rm.DefendedBase{constructor(t){super(),this._runtime=t,this._transitions=[]}Release(){for(const t of this._transitions)t.Release();Rm.clearArray(this._transitions),this._transitions=null}Create(t){this._transitions.push(Rm.Transition.Create(t))}}}{const Am=self.C3;Am.TemplateManager=class extends Am.DefendedBase{constructor(t){super(),this._runtime=t,this._templateDataMap=null,this._instanceToTemplateNameMap=null,this._instanceDestroy=t=>this._OnInstanceDestroy(t.instance)}Release(){if(this.RemoveRuntimeListeners(),this._templateDataMap){for(const t of this._templateDataMap.values())t.clear();this._templateDataMap.clear()}this._templateDataMap=null,this._runtime=null}Create(t){if(this._templateDataMap||(this._templateDataMap=new Map),!t)return;const e=t[0][16][0],s=t[1];this._templateDataMap.has(s)||this._templateDataMap.set(s,new Map),this._templateDataMap.get(s).set(e,t)}AddRuntimeListeners(){const t=this._runtime.Dispatcher();t&&t.addEventListener("instancedestroy",this._instanceDestroy)}RemoveRuntimeListeners(){const t=this._runtime.Dispatcher();t&&t.removeEventListener("instancedestroy",this._instanceDestroy)}HasTemplates(){return!!this._templateDataMap&&0!==this._templateDataMap.size}GetTemplateData(t,e){let s=0;if(s=t instanceof Am.ObjectClass?t.GetIndex():t,!this._templateDataMap.has(s))return;const i=this._templateDataMap.get(s).get(e);return i?JSON.parse(JSON.stringify(i)):void 0}MapInstanceToTemplateName(t,e){this._instanceToTemplateNameMap||(this._instanceToTemplateNameMap=new WeakMap),this._instanceToTemplateNameMap.has(t)||this._instanceToTemplateNameMap.set(t,e)}GetInstanceTemplateName(t){if(!this._instanceToTemplateNameMap)return"";return this._instanceToTemplateNameMap.get(t)||""}_OnInstanceDestroy(t){this._instanceToTemplateNameMap&&this._instanceToTemplateNameMap.has(t)&&this._instanceToTemplateNameMap.delete(t)}}}{const Dm=self.C3;Dm.FlowchartManager=class{constructor(t){this._runtime=t,this._flowchartDataManager=new Dm.FlowchartDataManager}Release(){this._flowchartDataManager.Release(),this._flowchartDataManager=null,this._runtime=null}GetRuntime(){return this._runtime}Create(t){this._flowchartDataManager.Add(t)}GetFlowchartDataItemByName(t){return this._flowchartDataManager.Get(t)}HasFlowcharts(){return this._flowchartDataManager.HasFlowcharts()}}}{const Em=self.C3;Em.FlowchartState=class{constructor(t,e,s,i,r,n,a){this._runtime=r.GetRuntime(),this._flowchartManager=r,this._flowchartName=t,this._startNodeTag=s,this._flowchartDataItem=i,this._tag=e,this._pluginInstance=n,this._pluginUID=a??n.GetInstance().GetUID(),this._SetStartFlowchartNode(),this._currentFlowchartNodeId=this._startFlowchartNode?.GetFlowchartId()??-1,this._previousFlowchartNodeIds=[],this._previousFlowchartState=null,this._previousFlowchartStateStartNodeId=NaN,this._referenceFlowchartStates=null,this._currentReferenceFlowchartState=null,this._rootFlowchartState=null,this._previousFlowchartStateTag="",this._referenceFlowchartStatesJson=null,this._currentReferenceFlowchartStateTag="",this._rootFlowchartStateTag="",this._triggerCount=0,this._markForRelease=!1,this._released=!1}Release(){this._released||(Em.clearArray(this._previousFlowchartNodeIds),this._previousFlowchartNodeIds=null,this._runtime=null,this._flowchartManager=null,this._flowchartDataItem=null,this._pluginInstance=null,this._previousFlowchartState=null,this._previousFlowchartStateStartNodeId=NaN,this._referenceFlowchartStates&&this._referenceFlowchartStates.clear(),this._referenceFlowchartStates=null,this._currentReferenceFlowchartState=null,this._rootFlowchartState=null,this._previousFlowchartStateTag="",this._referenceFlowchartStatesJson=null,this._currentReferenceFlowchartStateTag="",this._rootFlowchartStateTag="",this._released=!0)}WasReleased(){return this._released}GetFlowchartManager(){return this._flowchartManager}GetRuntime(){return this._runtime}GetName(){return this._flowchartName}GetFlowchartDataItem(){return this._flowchartDataItem}GetTag(){return this._tag}GetPluginInstance(){return this._pluginInstance||(this._pluginInstance=this._runtime.GetInstanceByUID(this._pluginUID).GetSdkInstance()),this._pluginInstance}GetCurrentNode(){return this.GetFlowchartElementById(this._currentFlowchartNodeId)}GetCurrentNodeTag(){const t=this.GetCurrentNode();return t?t.GetTag():""}GetCurrentNodeTags(){const t=this.GetCurrentNode();return t?t.GetTags():[]}CurrentNodeHasTags(t){const e=this.GetCurrentNodeTags();if(!e)return!1;if(!e.length)return!1;const s=Em.FlowchartState._GetTagArray(t);return!(!s||!s.length)&&s.every(Em.FlowchartState._HasTag,e)}CurrentNodeCompareTags(t,e){const s=this.GetCurrentNodeTags();if(!s)return!1;if(!s.length)return!1;const i=Em.FlowchartState._GetTagArray(t);return!(!i||!i.length)&&i.every(t=>Em.FlowchartState._CompareTag.call(s,t,e))}static _HasTag(t){const e=this;return""===t?1===e.length&&""===e[0]:e.map(t=>t.trim().toLowerCase()).includes(t.trim().toLowerCase())}static _GetTagArray(t){return t.trim().split(" ")}static _CompareTag(t,e){const s=this;return""===t?1===s.length&&""===s[0]:s.some(s=>Em.compare(s.trim(),e,t.trim()))}GetCurrentNodeParent(t){const e=this.GetCurrentNode();if(e){if(Em.IsFiniteNumber(t)){const s=e.GetParentFlowchartIds(),i=s?s[t]:void 0;if(Em.IsFiniteNumber(i))return this.GetFlowchartElementById(i)}if("string"==typeof t)for(const s of e.GetParentFlowchartIds()){const e=this.GetFlowchartElementById(s);if(e.HasTags(t))return this.GetFlowchartElementById(e.GetFlowchartId())}}}GetCurrentNodeParentTag(t){const e=this.GetCurrentNodeParent(t);return e?e.GetTag():""}GetCurrentNodeParentTags(t){const e=this.GetCurrentNodeParent(t);return e?e.GetTags():""}GetCurrentNodeParentIndex(t){const e=this.GetCurrentNode();if(!e)return-1;const s=e.GetParentFlowchartIds();if(!s)return-1;const i=this.GetCurrentNodeParent(t);return i?s.indexOf(i.GetFlowchartId()):-1}GetCurrentNodeParentCount(){const t=this.GetCurrentNode();if(!t)return 0;const e=t.GetParentFlowchartIds();return e?e.length:0}GetFlowchartElementById(t){return this._flowchartDataItem.GetFlowchartElementById(t)}Reset(){this._GetRootFlowchartState()._Reset(!0)}_Reset(t){if(this._GetReferenceFlowchartStates()){for(const[t,e]of this._GetReferenceFlowchartStates().entries())e._Reset(!1);this._GetReferenceFlowchartStates().clear()}if(this._referenceFlowchartStates=null,this._previousFlowchartState=null,this._previousFlowchartStateStartNode=null,this._currentReferenceFlowchartState=null,this._previousFlowchartStateTag="",this._referenceFlowchartStatesJson=null,this._currentReferenceFlowchartStateTag="",this._rootFlowchartStateTag="",this._previousFlowchartNodeIds=[],t){this._flowchartManager.SetCurrentFlowchartState(this);const t=this._startFlowchartNode.GetFlowchartId();t!==this._currentFlowchartNodeId&&this._GotoFlowchartNode(t)}else this._currentFlowchartNodeId=this._startFlowchartNode.GetFlowchartId()}GetCurrentNodeOutputCount(){const t=this._flowchartDataItem.GetFlowchartElementById(this._currentFlowchartNodeId);return t?t.GetFlowchartNodeOutputData().GetFlowchartNodeOutputDataItemCount():0}IsIndexOfDefaultOutput(t){return!(t<0)&&t===this.GetDefaultOutputIndex()}GetDefaultOutputIndex(){const t=this._flowchartDataItem.GetFlowchartElementById(this._currentFlowchartNodeId);if(!t)return-1;let e=t.GetFlowchartNodeOutputData().GetFlowchartNodeOutputDefault();return e?t.GetFlowchartNodeOutputData().GetFlowchartNodeOutputDataItems().indexOf(e):-1}GetCurrentNodeOutputNameAt(t){const e=this._GetFlowchartNodeOutputAt(t);return e?e.GetName():""}GetCurrentNodeOutputValueAt(t){let e;return Em.IsFiniteNumber(t)&&(e=this._GetFlowchartNodeOutputAt(t)),"string"==typeof t&&(e=this._GetFlowchartNodeOutputByName(t)),"number"!=typeof t&&"string"!=typeof t&&console.warn("[Flowcharts] unexpected argument type in GetCurrentNodeOutputValueAt expression"),e?e.GetValue():""}_MaybeByPassNodes(t,e){if(t.GetEnable())return t.GetFlowchartId();{const s=t.GetFlowchartNodeOutputData().GetFlowchartNodeOutputDefault();if(!s)return e.GetFlowchartId();const i=s.GetConnectedFlowchartNodeFlowchartId();if(!Em.IsFiniteNumber(i))return e.GetFlowchartId();const r=this.GetFlowchartElementById(i);return r?this._MaybeByPassNodes(r,e):e.GetFlowchartId()}}_MaybeByPassNodesInReferenceFlowchart(t,e){if(t.GetEnable()){if("reference"===t.GetType()){const e=t.GetReferenceFlowchartName(),s=t.GetReferenceFlowchartStartNodeTag(),i=this._flowchartManager.GetFlowchartDataItemByName(e);if(!i)return[-1,null];const r=i.GetFlowchartNodeByTags(s);return r?this._MaybeByPassNodesInReferenceFlowchart(r,i):this._MaybeByPassNodesInReferenceFlowchart(i.GetFlowchartStartNode(),i)}return[t.GetFlowchartId(),e]}{const s=t.GetFlowchartNodeOutputData().GetFlowchartNodeOutputDefault();if(!s)return[-1,null];const i=s.GetConnectedFlowchartNodeFlowchartId();if(!Em.IsFiniteNumber(i))return[-1,null];const r=e.GetFlowchartElementById(i);return r?this._MaybeByPassNodesInReferenceFlowchart(r,e):[-1,null]}}_ProcessAllByPasses(t,e){let s=this.GetFlowchartElementById(t);if(s){if(!s.GetEnable()){const e=this.GetFlowchartElementById(this._currentFlowchartNodeId);t=this._MaybeByPassNodes(s,e)}if(Em.IsFiniteNumber(t)&&t!==this._currentFlowchartNodeId)if(s=this.GetFlowchartElementById(t),"reference"===s.GetType()){const i=s.GetReferenceFlowchartName(),r=s.GetReferenceFlowchartStartNodeTag(),n=this._flowchartManager.GetFlowchartDataItemByName(i);let a=n.GetFlowchartNodeByTags(r);if(a){const s=this._MaybeByPassNodesInReferenceFlowchart(a,n);if(-1===s[0])return;e(this._currentFlowchartNodeId,t,s[1],s[0])}else e(this._currentFlowchartNodeId,t)}else e(this._currentFlowchartNodeId,t)}}GotoNextFlowchartNode(t){let e;if(Em.IsFiniteNumber(t)&&(e=this._GetFlowchartNodeOutputAt(t)),"string"==typeof t&&(e=this._GetFlowchartNodeOutputByName(t)),!e)return;let s=e.GetConnectedFlowchartNodeFlowchartId();Em.IsFiniteNumber(s)&&this._ProcessAllByPasses(s,(t,e,s,i)=>{this._previousFlowchartNodeIds.push(t),this._GotoFlowchartNode(e,s,i)})}GotoNextFlowchartNodeDefault(){const t=this._GetFlowchartNodeOutputDefault();if(!t)return;const e=t.GetConnectedFlowchartNodeFlowchartId();Em.IsFiniteNumber(e)&&this._ProcessAllByPasses(e,(t,e,s,i)=>{this._previousFlowchartNodeIds.push(t),this._GotoFlowchartNode(e,s,i)})}GotoAnyFlowchartNode(t){const e=this._flowchartDataItem.GetFlowchartNodeByTags(t);if(!e)return;const s=e.GetFlowchartId();Em.IsFiniteNumber(s)&&this._ProcessAllByPasses(s,(t,e,s,i)=>{this._previousFlowchartNodeIds.push(t),this._GotoFlowchartNode(e,s,i)})}GotoPreviousFlowchartNode(){const t=this._previousFlowchartNodeIds.pop();Em.IsFiniteNumber(t)?this._GotoFlowchartNode(t):this._GetPreviousFlowchartState()&&(this._flowchartManager.SetCurrentFlowchartState(this._GetPreviousFlowchartState(),!0,!1,!1),this._GetPreviousFlowchartState()._GotoFlowchartNode(this._GetPreviousFlowchartStateStartNodeId()),this._GetRootFlowchartState()._SetCurrentReferenceFlowchart(this._GetPreviousFlowchartState()))}GotoParentFlowchartNode(t){if(!this.GetCurrentNode())return;const e=this.GetCurrentNodeParent(t);if(e){if(!e.GetEnable())return;const t=e.GetFlowchartId();if(!Em.IsFiniteNumber(t))return;this._previousFlowchartNodeIds.push(this._currentFlowchartNodeId),this._GotoFlowchartNode(e.GetFlowchartId())}}HasOutput(t){if(Em.IsFiniteNumber(t))return!!this._flowchartDataItem.GetFlowchartElementById(this._currentFlowchartNodeId).GetFlowchartNodeOutputData().GetFlowchartNodeOutputDataItems()[t];if("string"==typeof t){const e=this._flowchartDataItem.GetFlowchartElementById(this._currentFlowchartNodeId).GetFlowchartNodeOutputData().GetFlowchartNodeOutputDataItems();for(let s=0;s<e.length;s++)if(e[s].GetName()===t)return!0;return!1}return!1}MarkForRelease(){this._markForRelease=!0}IsInTriggerState(){return this._triggerCount>0}PushIsTriggerState(){this._triggerCount++}PopIsTriggerState(){this._triggerCount--,0===this._triggerCount&&this._markForRelease&&this._flowchartManager.RemoveFlowchartState(this)}_GotoFlowchartNode(t,e,s){const i=this._currentFlowchartNodeId,r=this.GetPluginInstance().GetInstance();this.PushIsTriggerState(),this._flowchartManager.PushFlowchartState(this),this._runtime.Trigger(Em.Plugins.Flowchart.Cnds.OnBeforeAnyNodeChange,r),this._runtime.Trigger(Em.Plugins.Flowchart.Cnds.OnBeforeTaggedNodeChange,r),this._runtime.Trigger(Em.Plugins.Flowchart.Cnds.OnBeforeAnyNodeChangeInFlowchart,r),this._runtime.Trigger(Em.Plugins.Flowchart.Cnds.OnBeforeTaggedNodeChangeInFlowchart,r),this._currentFlowchartNodeId=t;let n=this.GetFlowchartElementById(this._currentFlowchartNodeId);if("dictionary"===n.GetType()&&(this._runtime.Trigger(Em.Plugins.Flowchart.Cnds.OnAnyNodeChange,r),this._runtime.Trigger(Em.Plugins.Flowchart.Cnds.OnTaggedNodeChange,r),this._runtime.Trigger(Em.Plugins.Flowchart.Cnds.OnAnyNodeChangeInFlowchart,r),this._runtime.Trigger(Em.Plugins.Flowchart.Cnds.OnTaggedNodeChangeInFlowchart,r)),this._flowchartManager.PopFlowchartState(),this.PopIsTriggerState(),!this.WasReleased()&&(n=this.GetFlowchartElementById(this._currentFlowchartNodeId),"reference"===n.GetType())){const t=e?e.GetName():n.GetReferenceFlowchartName();if(this._HasReferenceFlowchartState(n)){this._previousFlowchartNodeIds.pop();const t=this._GetReferenceFlowchartState(n);this._flowchartManager.SetCurrentFlowchartState(t,!0,!0,!1),t._SetPreviousFlowchart(this,i),this._GetRootFlowchartState()._SetCurrentReferenceFlowchart(t)}else{const e="number"==typeof s?s:n.GetReferenceFlowchartStartNodeTag();if(t){this._previousFlowchartNodeIds.pop();let s=n.GetReferenceFlowchartTag();if(s){let t=this._flowchartManager.GetFlowchartState(s);for(;t;)s=Em.IncrementNumberAtEndOf(s),t=this._flowchartManager.GetFlowchartState(s)}else{s=`${t}-ref`;let e=this._flowchartManager.GetFlowchartState(s);for(;e;)s=Em.IncrementNumberAtEndOf(s),e=this._flowchartManager.GetFlowchartState(s)}const r=this._flowchartManager.AddFlowchartState(t,e,s,this._pluginInstance,!0);r._SetPreviousFlowchart(this,i),this._SetReferenceFlowchartState(n,r);const a=this._GetRootFlowchartState();r._SetRootFlowchartState(a),a._SetCurrentReferenceFlowchart(r)}}}}_GetFlowchartNodeOutputDefault(){const t=this._flowchartDataItem.GetFlowchartElementById(this._currentFlowchartNodeId);return t?t.GetFlowchartNodeOutputData().GetFlowchartNodeOutputDefault():null}_GetFlowchartNodeOutputAt(t){const e=this._flowchartDataItem.GetFlowchartElementById(this._currentFlowchartNodeId);if(!e)return null;const s=e.GetFlowchartNodeOutputData().GetFlowchartNodeOutputDataItems();if(!s)return null;return s[t]||null}_GetFlowchartNodeOutputByName(t){const e=this._flowchartDataItem.GetFlowchartElementById(this._currentFlowchartNodeId);if(!e)return null;return e.GetFlowchartNodeOutputData().GetFlowchartNodeOutputDataItemByName(t)||null}_SetStartFlowchartNode(t){if("number"==typeof t){let e=this.GetFlowchartElementById(t);e||(e=this._flowchartDataItem.GetFlowchartStartNode()),this._startFlowchartNode=e}else if("number"==typeof this._startNodeTag){let t=this.GetFlowchartElementById(this._startNodeTag);t||(t=this._flowchartDataItem.GetFlowchartStartNode()),this._startFlowchartNode=t}else{let t=this._flowchartDataItem.GetFlowchartNodeByTags(this._startNodeTag);t||(t=this._flowchartDataItem.GetFlowchartStartNode()),this._startFlowchartNode=t}}_SaveToJson(){return this._markForRelease?null:{flowchartName:this._flowchartName,flowchartTag:this._tag,startNodeTag:this._startNodeTag,currentNodeId:this._currentFlowchartNodeId,previousNodeIds:this._previousFlowchartNodeIds,pluginUID:this._pluginInstance.GetInstance().GetUID(),reference:{previousFlowchartTag:this._GetPreviousFlowchartState()?this._GetPreviousFlowchartState().GetTag():"",previousStartNodeId:Em.IsFiniteNumber(this._GetPreviousFlowchartStateStartNodeId())?this._GetPreviousFlowchartStateStartNodeId():NaN,referencesJson:this._GetFlowchartReferencesJson(),currentReferenceFlowchartTag:this.GetCurrentReferenceFlowchart()?this.GetCurrentReferenceFlowchart().GetTag():"",rootFlowchartTag:this._GetRootFlowchartState()?this._GetRootFlowchartState().GetTag():""}}}_GetFlowchartReferencesJson(){if(!this._HasReferenceFlowchartStates())return null;const t=[];for(const[e,s]of this._GetReferenceFlowchartStates().entries())t.push({flowchartElementId:e.GetFlowchartId(),flowchartStateTag:s.GetTag()});return t.length?t:null}_LoadFromJson(t){if(t){if(this._flowchartName=t.flowchartName,this._tag=t.flowchartTag,this._startNodeTag=t.startNodeTag,this._currentFlowchartNodeId=t.currentNodeId,this._previousFlowchartNodeIds=t.previousNodeIds,this._pluginUID=t.pluginUID,t.hasOwnProperty("reference")){const e=t.reference;this._previousFlowchartStateTag=e.previousFlowchartTag,this._previousFlowchartStateStartNodeId=e.previousStartNodeId,this._referenceFlowchartStatesJson=e.referencesJson,this._currentReferenceFlowchartStateTag=e.currentReferenceFlowchartTag,this._rootFlowchartStateTag=e.rootFlowchartTag}this._SetStartFlowchartNode()}}_GetPreviousFlowchartState(){return"string"==typeof this._previousFlowchartStateTag&&this._previousFlowchartStateTag&&(this._previousFlowchartState=this._flowchartManager.GetFlowchartState(this._previousFlowchartStateTag),this._previousFlowchartStateTag=""),this._previousFlowchartState}_GetPreviousFlowchartStateStartNodeId(){return this._previousFlowchartStateStartNodeId}_SetPreviousFlowchart(t,e){this._previousFlowchartState=t,this._previousFlowchartStateStartNodeId=e}GetCurrentReferenceFlowchart(){return"string"==typeof this._currentReferenceFlowchartStateTag&&this._currentReferenceFlowchartStateTag&&(this._currentReferenceFlowchartState=this._flowchartManager.GetFlowchartState(this._currentReferenceFlowchartStateTag),this._currentReferenceFlowchartStateTag=""),this._currentReferenceFlowchartState}_SetCurrentReferenceFlowchart(t){this._currentReferenceFlowchartState=t,this._currentReferenceFlowchartState===this&&(this._currentReferenceFlowchartState=null)}_GetRootFlowchartState(){return"string"==typeof this._rootFlowchartStateTag&&this._rootFlowchartStateTag&&(this._rootFlowchartState=this._flowchartManager.GetFlowchartState(this._rootFlowchartStateTag),this._rootFlowchartStateTag=""),this._rootFlowchartState?this._rootFlowchartState:this}_SetRootFlowchartState(t){this._rootFlowchartState=t}_HasReferenceFlowchartStates(){return this._RebuildReferenceFlowchartStates(),!!this._referenceFlowchartStates}_HasReferenceFlowchartState(t){return this._RebuildReferenceFlowchartStates(),this._referenceFlowchartStates&&this._referenceFlowchartStates.has(t)}_RebuildReferenceFlowchartStates(){if(this._referenceFlowchartStatesJson){this._referenceFlowchartStates&&this._referenceFlowchartStates.clear(),this._referenceFlowchartStates||(this._referenceFlowchartStates=new Map);for(const t of this._referenceFlowchartStatesJson){const e=this._flowchartManager.GetFlowchartState(t.flowchartStateTag),s=e.GetFlowchartElementById(t.flowchartElementId);this._referenceFlowchartStates.set(s,e)}this._referenceFlowchartStatesJson=null}}_GetReferenceFlowchartStates(){return this._RebuildReferenceFlowchartStates(),this._referenceFlowchartStates}_GetReferenceFlowchartState(t){return this._RebuildReferenceFlowchartStates(),this._referenceFlowchartStates.get(t)}_SetReferenceFlowchartState(t,e){this._referenceFlowchartStates||(this._referenceFlowchartStates=new Map),this._referenceFlowchartStates.set(t,e)}}}{const Fm=self.C3;Fm.FlowchartStateManager=class{constructor(t){this._runtime=t,this._flowchartStates=new Map,this._currentFlowchartState=null,this._flowchartStateStack=[],this._on_after_load=()=>this._OnAfterLoad(),this._loadJson=null}Release(){Fm.clearArray(this._flowchartStateStack),this._flowchartStateStack=null,this._flowchartStates.clear(),this._flowchartStates=null,this._currentFlowchartState=null,this._runtime=null,this._loadJson=null}GetRuntime(){return this._runtime}GetFlowchartDataItemByName(t){return this._runtime.GetFlowchartManager().GetFlowchartDataItemByName(t)}AddFlowchartState(t,e,s,i,r,n){const a=this._runtime.GetFlowchartManager().GetFlowchartDataItemByName(t);if(!a)return void console.warn(`[Flowcharts] no flowchart found with name '${t}'`);if(this._flowchartStates.has(s)){const t=this._flowchartStates.get(s);t&&this.RemoveFlowchartState(t)}const o=new Fm.FlowchartState(t,s,e,a,this,i,n);return this._flowchartStates.set(s,o),r&&this.SetCurrentFlowchartState(o,!0),o}RemoveFlowchartState(t){if(t.MarkForRelease(),t.IsInTriggerState())return;const e=t.GetTag();this._flowchartStates.delete(e),t.Release(),this._currentFlowchartState===t&&(this._currentFlowchartState=null)}ResetFlowchartState(t){t.Reset()}GetFlowchartState(t){return this._flowchartStates.get(t)}PushFlowchartState(t){this._flowchartStateStack.push(t)}PopFlowchartState(){this._flowchartStateStack.pop()}SetCurrentFlowchartState(t,e=!1,s=!1,i=!0){if(i){const e=t.GetCurrentReferenceFlowchart();t=e||t}t!==this._currentFlowchartState&&(this._TriggerBeforeFlowchartChange(),this._TriggerAfterFlowchartChange(t,e,s))}GetCurrentFlowchartState(t){return"string"==typeof t?this.GetFlowchartState(t):this._flowchartStateStack.length?this._flowchartStateStack[this._flowchartStateStack.length-1]:this._currentFlowchartState}_TriggerBeforeFlowchartChange(){if(!this._currentFlowchartState)return;if(this._currentFlowchartState.WasReleased())return;const t=this._currentFlowchartState.GetPluginInstance().GetInstance();this._currentFlowchartState.PushIsTriggerState(),this.PushFlowchartState(this._currentFlowchartState),this._runtime.Trigger(Fm.Plugins.Flowchart.Cnds.OnBeforeFlowchartChange,t),this.PopFlowchartState(),this._currentFlowchartState.PopIsTriggerState()}_TriggerAfterFlowchartChange(t,e=!1,s=!1){if(this._currentFlowchartState=t,!this._currentFlowchartState)return;if(this._currentFlowchartState.WasReleased())return;const i=this._currentFlowchartState.GetPluginInstance().GetInstance();this._currentFlowchartState.PushIsTriggerState(),this.PushFlowchartState(this._currentFlowchartState),this._runtime.Trigger(Fm.Plugins.Flowchart.Cnds.OnFlowchartChange,i),!0!==s&&"number"!=typeof s||this._currentFlowchartState._SetStartFlowchartNode(s),e&&(this._runtime.Trigger(Fm.Plugins.Flowchart.Cnds.OnAnyNodeChange,i),this._runtime.Trigger(Fm.Plugins.Flowchart.Cnds.OnTaggedNodeChange,i),this._runtime.Trigger(Fm.Plugins.Flowchart.Cnds.OnAnyNodeChangeInFlowchart,i),this._runtime.Trigger(Fm.Plugins.Flowchart.Cnds.OnTaggedNodeChangeInFlowchart,i)),this.PopFlowchartState(),this._currentFlowchartState.PopIsTriggerState()}_SaveToJson(){return{flowchartJsonObjects:[...this._flowchartStates.values()].map(t=>t._SaveToJson()),currentFlowchartTag:this._currentFlowchartState?this._currentFlowchartState.GetTag():null}}_LoadFromJson(t){if(!t)return;this._loadJson=t;const e=new Map;for(const t of this._loadJson.flowchartJsonObjects){const s=t.flowchartTag;if(this._flowchartStates.has(s)){const i=this._flowchartStates.get(s);i._LoadFromJson(t),e.set(s,i)}else{const s=this.AddFlowchartState(t.flowchartName,t.startNodeTag,t.flowchartTag,null,!1,t.pluginUID);s._LoadFromJson(t),e.set(t.flowchartTag,s)}}for(const[t,s]of this._flowchartStates.entries())e.has(t)||s.Release();this._flowchartStates.clear(),this._flowchartStates=e,this._runtime.IsLoadingState()?this._runtime.Dispatcher().addEventListener("afterload",this._on_after_load):this._OnAfterLoad()}_OnAfterLoad(){this._runtime.Dispatcher().removeEventListener("afterload",this._on_after_load);const t=this._flowchartStates.get(this._loadJson.currentFlowchartTag);t&&this.SetCurrentFlowchartState(t,!0),this._loadJson=null}}}{const Om=self.C3;Om.FlowchartDataManager=class{constructor(){this._flowchartDataItems=new Map}Release(){for(const t of this._flowchartDataItems.values())t.Release();this._flowchartDataItems.clear(),this._flowchartDataItems=null}Add(t){const e=new Om.FlowchartDataItem(t),s=e.GetName();this._flowchartDataItems.set(s,e)}Get(t){return this._flowchartDataItems.get(t)}HasFlowcharts(){return!!this._flowchartDataItems.size}static CreateDataItems(t,e,s,i){if(e)for(const r of e){const e=new s(r,i);t.push(e)}}}}{const Bm=self.C3;Bm.FlowchartDataItem=class{constructor(t){this._name=t[0],this._flowchartNodeData=new Bm.FlowchartNodeData(t[1],this)}Release(){this._flowchartNodeData.Release(),this._flowchartNodeData=null}GetFlowchartNodeData(){return this._flowchartNodeData}GetFlowchartElementById(t){return this._flowchartNodeData.GetFlowchartElementById(t)}GetFlowchartNodeByTags(t){return this._flowchartNodeData.GetFlowchartNodeByTags(t)}GetFlowchartStartNode(){return this._flowchartNodeData.GetFlowchartStartNode()}GetName(){return this._name}}}{const Lm=self.C3;class km{constructor(t,e){this._flowchartNodeData=e,this._type=t[7],this._flowchartId=t[0],this._tag=t[1],this._tag?this._tags=this._tag.trim().split(" ").map(t=>t.trim()):this._tags=[],this._parentFlowchartIds=t[2],this._parentOutputFlowchartIds=null,this._childrenFlowchartIds=null,this._enable=!1,"dictionary"===this._type&&(this._parentOutputFlowchartIds=t[3],this._childrenFlowchartIds=t[4],this._enable=t[8]),this._isStart=t[6],this._referenceFlowchartName=null,this._referenceFlowchartStartNodeTag=null,this._referenceFlowchartTag=null,"reference"===this._type&&(this._referenceFlowchartName=t[8],this._referenceFlowchartStartNodeTag=t[9],this._referenceFlowchartTag=t[10],this._enable=t[11]),this._flowchartNodeOutputData=new Lm.FlowchartNodeOutputData(t[5],this)}Release(){this._flowchartNodeData=null}GetFlowchartNodeData(){return this._flowchartNodeData}GetFlowchartNodeOutputData(){return this._flowchartNodeOutputData}GetFlowchartId(){return this._flowchartId}GetTag(){return this._tag}GetTags(){return this._tags}HasTags(t){if(!this._tags)return!1;if(!this._tags.length)return!1;const e=Lm.FlowchartState._GetTagArray(t);return!(!e||!e.length)&&e.every(Lm.FlowchartState._HasTag,this._tags)}GetIsStart(){return this._isStart}SetIsStart(t){this._isStart=!!t}CanBeStartNode(){if("dictionary"===this._type)return!0;if("reference"===this._type)return!1;throw new Error(`unexpected flowchart node type: ${this._type}`)}GetParentFlowchartIds(){return this._parentFlowchartIds}GetParentOutputFlowchartIds(){return this._parentOutputFlowchartIds}GetChildrenFlowchartIds(){return this._childrenFlowchartIds}GetType(){return this._type}GetEnable(){return this._enable}GetReferenceFlowchartName(){return this._referenceFlowchartName}GetReferenceFlowchartStartNodeTag(){return this._referenceFlowchartStartNodeTag}GetReferenceFlowchartTag(){return this._referenceFlowchartTag}}Lm.FlowchartNodeData=class{constructor(t,e){this._flowchartDataItem=e,this._flowchartNodeItems=[],this._flowchartNodeItemsIdMap=new Map,this._flowchartNodeItemsTagMap=new Map,this._flowchartNodeStartItem=null,Lm.FlowchartDataManager.CreateDataItems(this._flowchartNodeItems,t,km,this);for(const t of this._flowchartNodeItems){const e=t.GetFlowchartId(),s=t.GetTag(),i=t.GetTags(),r=t.GetIsStart();if(this._flowchartNodeItemsIdMap.set(e,t),s)for(const e of i)this._flowchartNodeItemsTagMap.has(e)||this._flowchartNodeItemsTagMap.set(e,new Set),this._flowchartNodeItemsTagMap.get(e).add(t);r&&(this._flowchartNodeStartItem=t);const n=t.GetFlowchartNodeOutputData();for(const t of n.flowchartNodeOutputDataItems()){const e=t.GetFlowchartId();this._flowchartNodeItemsIdMap.set(e,t)}}this._flowchartNodeStartItem||this._SetStartNodeIfMissing()}Release(){this._flowchartDataItem=null;for(const t of this._flowchartNodeItems)t.Release();Lm.clearArray(this._flowchartNodeItems),this._flowchartNodeItems=null}GetFlowchartDataItem(){return this._flowchartDataItem}GetFlowchartElementById(t){return this._flowchartNodeItemsIdMap.get(t)}GetFlowchartNodeByTags(t){if(!t||!t.length)return null;const e=[];for(const s of t.trim().split(" ")){let t=this._flowchartNodeItemsTagMap.get(s.trim())??new Set;if(0===t.size)return null;e.push(t)}return[...e.reduce((t,e)=>e.size<t.size?e:t)].filter(t=>e.every(e=>e.has(t)))[0]}GetFlowchartStartNode(){return this._flowchartNodeStartItem}*flowchartNodeDataItems(){for(const t of this._flowchartNodeItems)yield t}_SetStartNodeIfMissing(){let t=0;for(const e of this.flowchartNodeDataItems())e.GetIsStart()&&t++;if(0===t){for(const t of this.flowchartNodeDataItems())if(t.CanBeStartNode()&&!t.GetIsStart())return void t.SetIsStart(!0)}else{if(1===t)return;if(t>1){let t=!0;for(const e of this.flowchartNodeDataItems())e.CanBeStartNode()&&(e.GetIsStart()&&t?t=!1:e.GetIsStart()&&!t&&e.SetIsStart(!1))}}for(const t of this.flowchartNodeDataItems())if(t.CanBeStartNode()&&t.GetIsStart())return void(this._flowchartNodeStartItem=t)}}}{const Nm=self.C3;class Um{constructor(t,e){this._flowchartNodeOutputData=e,this._flowchartId=t[0],this._name=t[1],this._value=t[2],this._connectedFlowchartNodeFlowchartId=t[3],this._enable=t[4],this._default=t[5]}Release(){this._flowchartNodeOutputData=null}GetFlowchartNodeOutputData(){return this._flowchartNodeOutputData}GetFlowchartId(){return this._flowchartId}GetName(){return this._name}GetValue(){return this._value}GetConnectedFlowchartNodeFlowchartId(){return this._connectedFlowchartNodeFlowchartId}GetEnable(){return this._enable}GetDefault(){return this._default}}Nm.FlowchartNodeOutputData=class{constructor(t,e){this._flowchartDataNodeItem=e,this._flowchartNodeOutputItems=[],this._flowchartNodeOutputItemsNameMap=new Map,Nm.FlowchartDataManager.CreateDataItems(this._flowchartNodeOutputItems,t,Um,this),this._enabledFlowchartNodeOutputItems=this._flowchartNodeOutputItems.filter(t=>t.GetEnable());for(const t of this._enabledFlowchartNodeOutputItems)this._flowchartNodeOutputItemsNameMap.set(t.GetName(),t)}Release(){this._flowchartDataNodeItem=null;for(const t of this._flowchartNodeOutputItems)t.Release();Nm.clearArray(this._flowchartNodeOutputItems),this._flowchartNodeOutputItems=null,Nm.clearArray(this._enabledFlowchartNodeOutputItems),this._enabledFlowchartNodeOutputItems=null}GetFlowchartNodeDataItem(){return this._flowchartDataNodeItem}GetFlowchartNodeOutputDataItemCount(){return this._enabledFlowchartNodeOutputItems.length}GetFlowchartNodeOutputDataItems(){return this._enabledFlowchartNodeOutputItems}GetFlowchartNodeOutputDataItemByName(t){return this._flowchartNodeOutputItemsNameMap.get(t)}GetFlowchartNodeOutputDefault(){for(const t of this._enabledFlowchartNodeOutputItems)if(t.GetDefault())return t}*flowchartNodeOutputDataItems(){for(const t of this._enabledFlowchartNodeOutputItems)yield t}}}{const Wm=self.C3;Wm.SolStack=class extends Wm.DefendedBase{constructor(t){super(),this._objectClass=t,this._stack=[],this._stack.push(Wm.New(Wm.Sol,this)),this._index=0,this._current=this._stack[0]}Release(){for(const t of this._stack)t.Release();Wm.clearArray(this._stack),this._current=null,this._objectClass=null}GetObjectClass(){return this._objectClass}GetCurrentSol(){return this._current}GetOneBelowCurrentSol(){return this._stack[this._index-1]}Clear(){this.GetCurrentSol().Clear()}PushClean(){const t=this._stack,e=++this._index;if(e===t.length){const e=Wm.New(Wm.Sol,this);t.push(e),this._current=e}else{const s=t[e];s.Reset(),this._current=s}}PushCopy(){const t=this._stack,e=++this._index;e===t.length&&t.push(Wm.New(Wm.Sol,this));const s=t[e];s.Copy(t[e-1]),this._current=s}Pop(){this._current=this._stack[--this._index]}RemoveInstances(t){const e=this._stack;for(let s=0,i=e.length;s<i;++s)e[s].RemoveInstances(t)}}}{const jm=self.C3;jm.Sol=class extends jm.DefendedBase{constructor(t){super(),this._stack=t,this._objectClass=this._stack.GetObjectClass(),this._eventStack=this._objectClass.GetRuntime().GetEventStack(),this._selectAll=!0,this._instances=[],this._elseInstances=[]}Release(){this.ClearArrays(),this._stack=null,this._objectClass=null,this._eventStack=null}ClearArrays(){jm.clearArray(this._instances),jm.clearArray(this._elseInstances)}GetObjectClass(){return this._objectClass}IsSelectAll(){return this._selectAll}HasAnyInstances(){return this._selectAll?!!this._objectClass.GetInstanceCount():!!this._instances.length}GetInstances(){return this._selectAll?this._objectClass.GetInstances():this._instances}HasAnyElseInstances(){return!!this._elseInstances.length}GetElseInstances(){return this._elseInstances}GetExpressionInstances(){const t=this.GetInstances();return t.length?t:this._elseInstances}Reset(){this._selectAll=!0,jm.clearArray(this._elseInstances)}Clear(){this._selectAll=!0}Copy(t){t.IsSelectAll()?this.Reset():(this._selectAll=!1,jm.shallowAssignArray(this._instances,t._instances),jm.clearArray(this._elseInstances))}_PushInstance(t){this._instances.push(t)}_PushElseInstance(t){this._elseInstances.push(t)}_SetSelectAll(t){this._selectAll=!!t}_GetOwnInstances(){return this._instances}_GetOwnElseInstances(){return this._elseInstances}SetSinglePicked(t){this._selectAll=!1,jm.clearArray(this._instances),this._instances.push(t)}SetArrayPicked(t){this._selectAll=!1,jm.shallowAssignArray(this._instances,t)}SetSetPicked(t){this._selectAll=!1,jm.clearArray(this._instances);for(const e of t)this._instances.push(e)}AddElseInstances(t,e){for(const s of e)t.has(s)||this._elseInstances.push(s)}TransferElseInstancesToOwn(t){for(const e of t)this._instances.push(e);jm.arrayRemoveAllInSet(this._elseInstances,t)}ClearElseInstances(){jm.clearArray(this._elseInstances)}PickOne(t){if(t)if(this._eventStack.GetCurrentStackFrame().GetCurrentEvent().IsOrBlock()){this.IsSelectAll()&&(jm.clearArray(this._instances),jm.shallowAssignArray(this._elseInstances,t.GetObjectClass().GetInstances()),this._selectAll=!1);const e=this._elseInstances.indexOf(t);-1!==e&&(this._instances.push(this._elseInstances[e]),this._elseInstances.splice(e,1))}else this.SetSinglePicked(t)}RemoveInstances(t){jm.arrayRemoveAllInSet(this._instances,t),jm.arrayRemoveAllInSet(this._elseInstances,t)}}}{const Vm=self.C3;Vm.EventStack=class extends Vm.DefendedBase{constructor(t){super(),this._eventSheetManager=t,this._runtime=this._eventSheetManager.GetRuntime(),this._stack=[],this._stack.push(Vm.New(Vm.EventStackFrame,this,null)),this._index=0,this._expFuncStack=[]}Release(){for(const t of this._stack)t.Release();Vm.clearArray(this._stack),Vm.clearArray(this._expFuncStack),this._eventSheetManager=null,this._runtime=null}GetEventSheetManager(){return this._eventSheetManager}GetRuntime(){return this._runtime}GetCurrentStackFrame(){return this._stack[this._index]}GetAllStackFrames(){return this._stack}GetCurrentStackFrameIndex(){return this._index}Push(t){const e=this._stack,s=++this._index;if(s===e.length){const s=Vm.New(Vm.EventStackFrame,this,t);return e.push(s),s}{const i=e[s];return i.Reset(t),i}}Pop(){--this._index}PushExpFunc(t){this._expFuncStack.push(t)}PopExpFunc(){this._expFuncStack.pop()}GetCurrentExpFuncStackFrame(){const t=this._expFuncStack;return 0===t.length?null:t.at(-1)}}}{const zm=self.C3;zm.EventStackFrame=class extends zm.DefendedBase{constructor(t,e){super(),this._stack=t,this._runtime=this._stack.GetRuntime(),this._currentEvent=e,this._cndIndex=0,this._actIndex=0,this._lastEventTrue=!1,this._elseBranchRan=!1,this._expressionObjectClass=null,this._functionReturnType=0,this._functionReturnValue=0,this._dynamicSolModifiers=null}Release(){this.Reset(null),this._stack=null,this._runtime=null}Reset(t){this._currentEvent=t,this._cndIndex=0,this._actIndex=0,this._lastEventTrue=!1,this._elseBranchRan=!1,this._dynamicSolModifiers=null}_Restore(t,e){this._currentEvent=t,this._cndIndex=0,this._actIndex=e}ResetQuick(){this._cndIndex=0,this._actIndex=0}GetCurrentEvent(){return this._currentEvent}SetCurrentEvent(t){this._currentEvent=t}GetConditionIndex(){return this._cndIndex}SetConditionIndex(t){this._cndIndex=t}GetActionIndex(){return this._actIndex}SetActionIndex(t){this._actIndex=t}SetLastEventTrue(t){this._lastEventTrue=!!t}GetLastEventTrue(){return this._lastEventTrue}SetElseBranchRan(t){this._elseBranchRan=!!t}GetElseBranchRan(){return this._elseBranchRan}SetExpressionObjectClass(t){this._expressionObjectClass=t}GetExpressionObjectClass(){return this._expressionObjectClass}InitCallFunctionExpression(t,e){this._functionReturnType=t,this._functionReturnValue=e}GetFunctionReturnType(){return this._functionReturnType}SetFunctionReturnValue(t){this._functionReturnValue=t}GetFunctionReturnValue(){return this._functionReturnValue}IsSolModifierAfterCnds(){const t=this._currentEvent;return!!t.IsSolWriterAfterCnds()||this._cndIndex<t.GetConditionCount()-1&&!!t.GetSolModifiers().length}SetDynamicSolModifiers(t){this._dynamicSolModifiers=t}GetDynamicSolModifiers(){return this._dynamicSolModifiers}}}{const Hm=self.C3;Hm.LocalVarStack=class extends Hm.DefendedBase{constructor(t){super(),this._eventSheetManager=t,this._runtime=this._eventSheetManager.GetRuntime(),this._stack=[],this._index=-1,this._current=null,this._initialValues=[]}Release(){Hm.clearArray(this._stack),this._eventSheetManager=null,this._runtime=null}_SetInitialValues(t){this._initialValues=t;const e=this._initialValues.slice(0);this._stack.push(e),this._index=0,this._current=e}GetEventSheetManager(){return this._eventSheetManager}GetRuntime(){return this._runtime}GetCurrent(){return this._current}Push(){const t=++this._index,e=this._stack;t===e.length?e.push(this._initialValues.slice(0)):Hm.shallowAssignArray(e[t],this._initialValues),this._current=e[t]}Pop(){this._current=this._stack[--this._index]}}}{const Ym=self.C3;Ym.LoopStack=class extends Ym.DefendedBase{constructor(t){super(),this._eventSheetManager=t,this._runtime=this._eventSheetManager.GetRuntime(),this._stack=[],this._index=-1}Release(){Ym.clearArray(this._stack),this._eventSheetManager=null,this._runtime=null}GetEventSheetManager(){return this._eventSheetManager}GetRuntime(){return this._runtime}IsInLoop(){return this._index>=0}GetCurrent(){return this._stack[this._index]}Push(){if(++this._index,this._index===this._stack.length){const t=Ym.New(Ym.Loop,this);return this._stack.push(t),t}{const t=this._stack[this._index];return t.Reset(),t}}Pop(){--this._index}FindByName(t){const e=this._stack;for(let s=this._index;s>=0;--s){const i=e[s];if(i.GetName()===t)return i}return null}_GetStack(){return this._stack.slice(0,this._index+1)}}}{const Xm=self.C3;Xm.Loop=class extends Xm.DefendedBase{constructor(t){super(),this._loopStack=t,this._name="",this._index=0,this._isStopped=!1,this._end=NaN}Reset(){this._name="",this._index=0,this._isStopped=!1,this._end=NaN}SetName(t){this._name=t}GetName(){return this._name}SetIndex(t){this._index=t}GetIndex(){return this._index}Stop(){this._isStopped=!0}IsStopped(){return this._isStopped}SetEnd(t){this._end=t}GetEnd(){return this._end}}}{const qm=self.C3;qm.ArrayStack=class extends qm.DefendedBase{constructor(){super(),this._stack=[],this._index=-1}Release(){qm.clearArray(this._stack)}GetCurrent(){return this._stack[this._index]}Push(){if(++this._index,this._index===this._stack.length){const t=[];return this._stack.push(t),t}return this._stack[this._index]}Pop(){--this._index}}}{let Jm=function(t,e){return t.GetIndex()-e.GetIndex()},Qm=function(t,e){for(let s=0,i=t.length;s<i;++s)if(t[s]!==e[s])return!1;return!0};0;const Km=self.C3;self.assert;Km.EventSheetManager=class extends Km.DefendedBase{constructor(t){super(),this._runtime=t,this._allSheets=[],this._sheetsByName=new Map,this._allGroups=[],this._groupsByName=new Map,this._blocksBySid=new Map,this._cndsBySid=new Map,this._actsBySid=new Map,this._allUniqueSolModifiers=new Map,this._eventVarsBySid=new Map,this._nextLocalVarIndex=0,this._allGlobalVars=[],this._allLocalVars=[],this._localVarInitialValues=[],this._functionBlocksByName=new Map,this._customActionBlocksMap=new Map,this._eventStack=Km.New(Km.EventStack,this),this._localVarStack=Km.New(Km.LocalVarStack,this),this._loopStack=Km.New(Km.LoopStack,this),this._triggersToPostInit=[],this._queuedTriggers=[],this._queuedDebugTriggers=[],this._runningEventsDepth=0,this._executingTriggerDepth=0,this._blockFlushingDepth=0,this._scheduledWaits=[],this._asyncActionPromises=[],this._signalTags=[],this._signalPromises=new Map,this._instSignals=new Map,self.c3_callFunction=(t,e)=>this._InvokeFunctionFromJS(t,e)}Release(){this.ClearAllScheduledWaits(),this._eventStack.Release(),this._eventStack=null,this._localVarStack.Release(),this._localVarStack=null,Km.clearArray(this._queuedTriggers),Km.clearArray(this._queuedDebugTriggers),this._runtime=null,Km.clearArray(this._allSheets),this._sheetsByName.clear()}Create(t){const e=Km.New(Km.EventSheet,this,t);this._allSheets.push(e),this._sheetsByName.set(e.GetName().toLowerCase(),e)}_AddTriggerToPostInit(t){this._triggersToPostInit.push(t)}_PostInit(){for(const t of this._customActionBlocksMap.values())t._CheckOverrideState();for(const t of this._functionBlocksByName.values())t._PostInit();for(const t of this._customActionBlocksMap.values())t._PostInit();for(const t of this._allSheets)t._PostInit();for(const t of this._allSheets)t._UpdateDeepIncludes();for(const t of this._triggersToPostInit)t._PostInit(!1);Km.clearArray(this._triggersToPostInit),this._localVarStack._SetInitialValues(this._localVarInitialValues)}GetRuntime(){return this._runtime}GetEventSheetByName(t){return this._sheetsByName.get(t.toLowerCase())||null}_RegisterGroup(t){this._allGroups.push(t),this._groupsByName.set(t.GetGroupName(),t)}_RegisterEventBlock(t){this._blocksBySid.set(t.GetSID(),t)}_RegisterCondition(t){this._cndsBySid.set(t.GetSID(),t)}_RegisterAction(t){this._actsBySid.set(t.GetSID(),t)}_RegisterFunctionBlock(t){switch(t.GetFunctionType()){case 0:this._functionBlocksByName.set(t.GetFunctionName().toLowerCase(),t);break;case 1:this._customActionBlocksMap.set(t.GetFunctionName().toLowerCase(),t)}}_RegisterEventVariable(t){this._eventVarsBySid.set(t.GetSID(),t),t.IsGlobal()?this._allGlobalVars.push(t):this._allLocalVars.push(t)}_DeduplicateSolModifierList(t){t.length>=2&&t.sort(Jm);let e=this._allUniqueSolModifiers.get(t.length);e||(e=[],this._allUniqueSolModifiers.set(t.length,e));for(let s=0,i=e.length;s<i;++s){const i=e[s];if(Qm(t,i))return i}return e.push(t),t}_GetNextLocalVarIndex(t){return this._localVarInitialValues.push(t.GetInitialValue()),this._nextLocalVarIndex++}GetEventStack(){return this._eventStack}GetCurrentEventStackFrame(){return this.GetEventStack().GetCurrentStackFrame()}GetCurrentEvent(){return this.GetCurrentEventStackFrame().GetCurrentEvent()}GetCurrentCondition(){const t=this.GetCurrentEventStackFrame();return t.GetCurrentEvent().GetConditionAt(t.GetConditionIndex())}GetCurrentAction(){const t=this.GetCurrentEventStackFrame();return t.GetCurrentEvent().GetActionAt(t.GetActionIndex())}GetLocalVarStack(){return this._localVarStack}GetLoopStack(){return this._loopStack}GetAllLocalVariablesInScope(t){const e=[];for(t=t.GetScopeParent();t;)Km.appendArray(e,t._GetAllLocalVariablesInScope()),t=t.GetScopeParent();return e}_GetLocalVariablesScriptInterface(t){const e={};for(const s of this.GetAllLocalVariablesInScope(t))e[s.GetJsPropName()]=s._GetScriptInterfaceDescriptor();return Object.create(Object.prototype,e)}GetEventVariableBySID(t){return this._eventVarsBySid.get(t)||null}GetEventBlockBySID(t){return this._blocksBySid.get(t)||null}GetConditionBySID(t){return this._cndsBySid.get(t)||null}GetActionBySID(t){return this._actsBySid.get(t)||null}GetFunctionBlockByName(t){return this._functionBlocksByName.get(t.toLowerCase())||null}GetCustomActionBlockByName(t,e){let s=this._customActionBlocksMap.get((t.GetName()+"."+e).toLowerCase());if(s)return s;if(!t.IsFamily())for(const i of t.GetFamilies())if(s=this._customActionBlocksMap.get((i.GetName()+"."+e).toLowerCase()),s)return s;return null}GetAllGlobalVariables(){return this._allGlobalVars}GetAllLocalVariables(){return this._allLocalVars}ResetAllGlobalsToInitialValue(t){for(const t of this._allGlobalVars)t.ResetToInitialValue();if(t)for(const t of this._allLocalVars)t.IsStatic()&&t.ResetToInitialValue()}GetEventGroupByName(t){return this._groupsByName.get(t.toLowerCase())||null}GetEventGroupBySID(t){const e=this._blocksBySid.get(t);return e&&e.IsGroup()?e:null}GetAllGroups(){return this._allGroups}ResetAllGroupsInitialActivation(){for(const t of this._allGroups)t.ResetInitialActivation()}_ResetAllHasRunFlags(){for(const t of this._allSheets)t._ResetHasRunFlag()}RunEvents(t){this._ResetAllHasRunFlags(),this._runningEventsDepth++;for(const e of t.runningLayouts()){const t=e.GetEventSheet();t&&(this._runtime.PushCurrentLayout(e),t.Run(),this._runtime.PopCurrentLayout())}this._runningEventsDepth--}async DebugRunEvents(t){this._ResetAllHasRunFlags(),this._runningEventsDepth++;for(const e of this._DebugRunEventsGen(t))await this._runtime.DebugBreak(e);this._runningEventsDepth--}*_DebugRunEventsGen(t){for(const e of t.runningLayouts()){const t=e.GetEventSheet();t&&(this._runtime.PushCurrentLayout(e),yield*t.DebugRun(),this._runtime.PopCurrentLayout())}}_Trigger(t,e,s,i){let r=!1;if(!t.GetMainRunningLayout())return this.QueueTrigger(e,s,i);this._executingTriggerDepth++;for(const n of t.runningLayouts()){const t=n.GetEventSheet();if(!t)continue;this._runtime.PushCurrentLayout(n);for(const n of t.deepIncludes()){const t=n._Trigger(e,s,i);r=r||t}const a=t._Trigger(e,s,i);r=r||a,this._runtime.PopCurrentLayout()}return this._executingTriggerDepth--,r}*_DebugTrigger(t,e,s,i){let r=!1;if(!t.GetMainRunningLayout())return this.QueueTrigger(e,s,i);this._executingTriggerDepth++;for(const n of t.runningLayouts()){const t=n.GetEventSheet();if(!t)continue;this._runtime.PushCurrentLayout(n);for(const n of t.deepIncludes()){const t=yield*n._DebugTrigger(e,s,i);r=r||t}const a=yield*t._DebugTrigger(e,s,i);r=r||a,this._runtime.PopCurrentLayout()}return this._executingTriggerDepth--,r}QueueTrigger(t,e,s){return this._queuedTriggers.push([t,e,s]),!1}QueueDebugTrigger(t,e,s){let i=null;const r=new Promise(t=>i=t);return this._queuedDebugTriggers.push([t,e,s,i]),r}*_RunQueuedDebugTriggersGen(){if(this._runtime.HitBreakpoint())throw new Error("should not be in breakpoint");const t=this._runtime.GetLayoutManager();for(;this._queuedDebugTriggers.length;){const[e,s,i,r]=this._queuedDebugTriggers.shift();r(yield*this._DebugTrigger(t,e,s,i))}}async RunQueuedDebugTriggersAsync(){for(const t of this._RunQueuedDebugTriggersGen())await this._runtime.DebugBreak(t)}_FastTrigger(t,e,s,i){let r=!1;const n=t.GetMainRunningLayout(),a=n.GetEventSheet();if(!a)return;this._executingTriggerDepth++,this._runtime.PushCurrentLayout(n);const o=a.deepIncludes();for(let t=0,n=o.length;t<n;++t){const n=o[t]._FastTrigger(e,s,i);r=r||n}const h=a._FastTrigger(e,s,i);return r=r||h,this._runtime.PopCurrentLayout(),this._executingTriggerDepth--,r}*_DebugFastTrigger(t,e,s,i){let r=!1;const n=t.GetMainRunningLayout(),a=n.GetEventSheet();if(!a)return;this._executingTriggerDepth++,this._runtime.PushCurrentLayout(n);const o=a.deepIncludes();for(let t=0,n=o.length;t<n;++t){const n=yield*o[t]._DebugFastTrigger(e,s,i);r=r||n}const h=yield*a._DebugFastTrigger(e,s,i);return r=r||h,this._runtime.PopCurrentLayout(),this._executingTriggerDepth--,r}GetTriggerDepth(){return this._executingTriggerDepth}IsInTrigger(){return this.GetTriggerDepth()>0}_IncTriggerDepth(){return++this._executingTriggerDepth}_DecTriggerDepth(){--this._executingTriggerDepth}IsRunningEvents(){return this._runningEventsDepth>0}IsInEventEngine(){return this.IsRunningEvents()||this.IsInTrigger()}_RunQueuedTriggers(t){for(const[e,s,i]of this._queuedTriggers)this._Trigger(t,e,s,i);Km.clearArray(this._queuedTriggers)}BlockFlushingInstances(t){t?this._blockFlushingDepth++:this._blockFlushingDepth--}IsFlushingBlocked(){return this._blockFlushingDepth>0}ClearSol(t){for(let e=0,s=t.length;e<s;++e)t[e].GetSolStack().Clear()}PushCleanSol(t){for(let e=0,s=t.length;e<s;++e)t[e].GetSolStack().PushClean()}PushCopySol(t){for(let e=0,s=t.length;e<s;++e)t[e].GetSolStack().PushCopy()}PopSol(t){for(let e=0,s=t.length;e<s;++e)t[e].GetSolStack().Pop()}GetDynamicSolModifiersSet(t){const e=new Set,s=this._eventStack.GetAllStackFrames(),i=this._eventStack.GetCurrentStackFrameIndex();for(let r=0;r<=i;++r){const i=s[r].GetDynamicSolModifiers();if(i)for(const s of i)t&&t.has(s)||e.add(s)}return e}PushCleanSolDynamic(t){const e=new Set([...t]),s=this.GetDynamicSolModifiersSet(e);if(s.size>0){for(const t of s)t.GetSolStack().PushClean();return[...s]}return null}AddScheduledWait(){const t=Km.New(Km.ScheduledWait,this);return this._scheduledWaits.push(t),t}scheduledWaits(){return this._scheduledWaits}RunScheduledWaits(){if(!this._scheduledWaits.length)return;const t=this.GetCurrentEventStackFrame();let e=!1;this._runningEventsDepth++;for(let s=0,i=this._scheduledWaits.length;s<i;++s){const i=this._scheduledWaits[s];i._ShouldRun()&&i._Run(t),i.ShouldRelease()&&(e=!0)}e&&(this._FilterScheduledWaitsToRelease(),t.Reset(null)),this._runningEventsDepth--}async DebugRunScheduledWaits(){if(!this._scheduledWaits.length)return;const t=this.GetCurrentEventStackFrame();let e=!1;this._runningEventsDepth++;for(let s=0,i=this._scheduledWaits.length;s<i;++s){const i=this._scheduledWaits[s];i._ShouldRun()&&await i._DebugRun(t),i.ShouldRelease()&&(e=!0)}e&&(this._FilterScheduledWaitsToRelease(),t.Reset(null)),this._runningEventsDepth--}_FilterScheduledWaitsToRelease(){const t=Km.arrayFilterOut(this._scheduledWaits,t=>t.ShouldRelease());for(const e of t)e.Release()}ClearAllScheduledWaits(){for(const t of this._scheduledWaits)t.Release();Km.clearArray(this._scheduledWaits)}_OnInstancesReleased(t){for(const e of this._scheduledWaits)e.RemoveInstances(t);for(const e of t){const t=this._instSignals.get(e);if(this._instSignals.delete(e),t)for(const{resolve:e}of t.signalPromises.values())e(!0)}}AddAsyncActionPromise(t){this._asyncActionPromises.push({promise:t,triggerDepth:this.GetTriggerDepth()})}ClearAsyncActionPromises(){Km.clearArray(this._asyncActionPromises)}GetPromiseForAllAsyncActions(){const t=this.GetTriggerDepth(),e=Promise.all(this._asyncActionPromises.filter(e=>e.triggerDepth===t).map(t=>t.promise));return this._asyncActionPromises=this._asyncActionPromises.filter(e=>e.triggerDepth<t),e}Signal(t){const e=t.toLowerCase();this._signalTags.push(e),this._runtime.Trigger(Km.Plugins.System.Cnds.OnSignal,null),this._signalTags.pop();for(const t of this._runtime.GetEventSheetManager().scheduledWaits())t.IsSignal()&&t.GetSignalTag()===e&&t.SetSignalled();const s=this._signalPromises.get(e);s&&(s.resolve(),this._signalPromises.delete(e))}WaitForSignal(t){const e=t.toLowerCase(),s=this._signalPromises.get(e);if(s)return s.promise;{let t=null;const s=new Promise(e=>t=e);return this._signalPromises.set(e,{promise:s,resolve:t}),s}}GetCurrentSignalTag(){if(0===this._signalTags.length)throw new Error("not in a signal");return this._signalTags.at(-1)}_GetInstanceSignalState(t){let e=this._instSignals.get(t);return e||(e={signalTags:[],signalPromises:new Map},this._instSignals.set(t,e)),e}InstanceSignal(t,e){const s=this._GetInstanceSignalState(t),i=e.toLowerCase();s.signalTags.push(i),this._runtime.Trigger(t.GetPlugin().GetConstructor().Cnds.OnInstanceSignal,t),s.signalTags.pop();for(const e of this._runtime.GetEventSheetManager().scheduledWaits())e.IsInstanceSignals()&&e.GetSignalTag()===i&&e.SetInstanceSignalled(t);const r=s.signalPromises.get(i);r&&(r.resolve(!1),s.signalPromises.delete(i)),0===s.signalTags.length&&0===s.signalPromises.size&&this._instSignals.delete(t)}WaitForInstanceSignal(t,e){const s=this._GetInstanceSignalState(t),i=e.toLowerCase(),r=s.signalPromises.get(i);if(r)return r.promise;{let t=null;const e=new Promise(e=>t=e);return s.signalPromises.set(i,{promise:e,resolve:t}),e}}GetCurrentInstanceSignalTag(t){const e=this._GetInstanceSignalState(t);if(!e||0===e.signalTags.length)throw new Error("not in a signal");return e.signalTags.at(-1)}_SaveToJson(){return{groups:this._SaveGroupsToJson(),cnds:this._SaveCndsToJson(),acts:this._SaveActsToJson(),vars:this._SaveVarsToJson(),waits:this._SaveScheduledWaitsToJson()}}_LoadFromJson(t){this._LoadGroupsFromJson(t.groups),this._LoadCndsFromJson(t.cnds),this._LoadActsFromJson(t.acts),this._LoadVarsFromJson(t.vars),this._LoadScheduledWaitsFromJson(t.waits)}_SaveGroupsToJson(){const t={};for(const e of this.GetAllGroups())t[e.GetSID().toString()]=e.IsGroupActive();return t}_LoadGroupsFromJson(t){for(const[e,s]of Object.entries(t)){const t=parseInt(e,10),i=this.GetEventGroupBySID(t);i&&i.SetGroupActive(s)}}_SaveCndsToJson(){const t={};for(const[e,s]of this._cndsBySid){const i=s._SaveToJson();i&&(t[e.toString()]=i)}return t}_LoadCndsFromJson(t){const e=new Map;for(const[s,i]of Object.entries(t))e.set(parseInt(s,10),i);for(const[t,s]of this._cndsBySid)s._LoadFromJson(e.get(t)||null)}_SaveActsToJson(){const t={};for(const[e,s]of this._actsBySid){const i=s._SaveToJson();i&&(t[e.toString()]=i)}return t}_LoadActsFromJson(t){const e=new Map;for(const[s,i]of Object.entries(t))e.set(parseInt(s,10),i);for(const[t,s]of this._actsBySid)s._LoadFromJson(e.get(t)||null)}_SaveVarsToJson(){const t={};for(const[e,s]of this._eventVarsBySid)s.IsConstant()||!s.IsGlobal()&&!s.IsStatic()||(t[e.toString()]=s.GetValue());return t}_LoadVarsFromJson(t){for(const[e,s]of Object.entries(t)){const t=parseInt(e,10),i=this.GetEventVariableBySID(t);i&&i.SetValue(s)}}_SaveScheduledWaitsToJson(){return this._scheduledWaits.filter(t=>!t.IsPromise()).map(t=>t._SaveToJson())}_LoadScheduledWaitsFromJson(t){this.ClearAllScheduledWaits();for(const e of t){const t=Km.ScheduledWait._CreateFromJson(this,e);t&&this._scheduledWaits.push(t)}}_GetPerfRecords(){return[...this._runtime.GetLayoutManager().runningLayouts()].map(t=>t.GetEventSheet()).filter(t=>t).map(t=>t._GetPerfRecord())}FindFirstFunctionBlockParent(t){for(;t;){const e=t.GetScopeParent();if(e instanceof Km.FunctionBlock)return e;t=e}return null}_InvokeFunctionFromJS(t,e){Array.isArray(e)||(e=[]);const s=this.GetFunctionBlockByName(t.toLowerCase());if(!s)return null;if(!s.IsEnabled())return s.GetDefaultReturnValue();const i=s.GetFunctionParameters();if(e.length<i.length){e=e.slice(0);do{e.push(i[e.length].GetInitialValue())}while(e.length<i.length)}const r=s.GetEventBlock();return r.RunAsExpressionOrJSFunctionCall(r.GetSolModifiersIncludingParents(),!1,s.GetReturnType(),s.GetDefaultReturnValue(),null,...e)}}}{const Zm=self.C3;Zm.EventSheet=class extends Zm.DefendedBase{constructor(t,e){super(),this._eventSheetManager=t,this._runtime=t.GetRuntime(),this._name=e[0],this._events=[],this._triggers=new Map,this._fastTriggers=new Map,this._eventsByDisplayNumber=new Map,this._hasRun=!1,this._shallowIncludes=[],this._deepIncludes=[],this._alreadyIncludedSheets=new Set;for(const t of e[1])this._CreateEvent(t,null,this._events);this._perfRecord=this._runtime.IsDebug()?{type:"sheet",name:this._name,totalTimeCounter:0,children:[]}:null}Release(){this._eventSheetManager=null,this._runtime=null}_CreateEvent(t,e,s){switch(t[0]){case 0:case 3:this._CreateEventBlock(t,e,s);break;case 1:this._CreateEventVariable(t,e,s);break;case 2:this._CreateInclude(t,e,s);break;case 4:this._CreateFunctionBlock(t,e);break;case 5:this._CreateScriptBlock(t,e,s);break;case 6:this._CreateCustomACEBlock(t,e);break;default:throw new Error("invalid event type")}}_CreateEventBlock(t,e,s){const i=Zm.EventBlock.Create(this,e,t);if(i.IsOrBlock()){s.push(i);const t=i.GetConditions();for(let e=0,s=t.length;e<s;++e)t[e].IsTrigger()&&this._InitTrigger(i,e)}else i.IsTrigger()?this._InitTrigger(i,0):s.push(i)}_CreateFunctionBlock(t,e){const s=Zm.FunctionBlock.CreateFunctionBlock(this,e,t);this._eventSheetManager._RegisterFunctionBlock(s)}_CreateCustomACEBlock(t,e){const s=Zm.FunctionBlock.CreateCustomACEBlock(this,e,t);this._eventSheetManager._RegisterFunctionBlock(s)}_CreateEventVariable(t,e,s){const i=Zm.EventVariable.Create(this,e,t);s.push(i)}_CreateInclude(t,e,s){const i=Zm.EventInclude.Create(this,e,t);s.push(i)}_CreateScriptBlock(t,e,s){const i=Zm.EventScript.Create(this,e,t);s.push(i)}_InitTrigger(t,e){t.IsOrBlock()||this._eventSheetManager._AddTriggerToPostInit(t);const s=t.GetConditionAt(e),i=s._GetFunc(),r=s.GetObjectClass();if(s.IsFastTrigger()){let n=this._fastTriggers.get(r);n||(n=new Map,this._fastTriggers.set(r,n));const a=s.GetFastTriggerValue().toLowerCase();let o=n.get(i);o||(o=new Map,n.set(i,o));let h=o.get(a);h||(h=[],o.set(a,h)),h.push([t,e])}else{let n=this._triggers.get(r);n||(n={methodMap:new Map,behaviors:new Map},this._triggers.set(r,n));const a=s.GetBehaviorType();let o;a?(o=n.behaviors.get(a),o||(o=new Map,n.behaviors.set(a,o))):o=n.methodMap;let h=o.get(i);h||(h=[],o.set(i,h)),h.push([t,e])}}_PostInit(){const t=this._events;for(let e=0,s=t.length;e<s;++e){const i=e<s-1&&t[e+1]instanceof Zm.EventBlock&&t[e+1].IsElseBlock();t[e]._PostInit(i)}}_AddShallowInclude(t){this._shallowIncludes.push(t)}_UpdateDeepIncludes(){Zm.clearArray(this._deepIncludes),this._AddDeepIncludes(this),this._alreadyIncludedSheets.clear()}_AddDeepIncludes(t){const e=t._deepIncludes,s=t._alreadyIncludedSheets;for(const i of this._shallowIncludes){const r=i.GetIncludeSheet();i.IsActive()&&t!==r&&!s.has(r)&&(s.add(r),r._AddDeepIncludes(t),e.push(r))}}deepIncludes(){return this._deepIncludes}GetEventSheetManager(){return this._eventSheetManager}GetRuntime(){return this._runtime}GetName(){return this._name}_RegisterEventByDisplayNumber(t,e){this._eventsByDisplayNumber.set(e,t)}_GetEventByDisplayNumber(t){return this._eventsByDisplayNumber.get(t)||null}_ResetHasRunFlag(){this._hasRun=!1}Run(){if(this._hasRun)return;const t=this._runtime,e=t.IsCPUProfiling(),s=e?performance.now():0;this._hasRun=!0;const i=this.GetEventSheetManager(),r=i.GetCurrentEventStackFrame();for(const e of this._events)e.Run(r),i.ClearSol(e.GetSolModifiers()),i.ClearAsyncActionPromises(),t.FlushPendingInstances();r.Reset(null),e&&(this._perfRecord.totalTimeCounter+=performance.now()-s)}*DebugRun(){if(this._hasRun)return;this._hasRun=!0;const t=this._runtime,e=this.GetEventSheetManager(),s=e.GetCurrentEventStackFrame();for(const i of this._events)yield*i.DebugRun(s),e.ClearSol(i.GetSolModifiers()),e.ClearAsyncActionPromises(),t.FlushPendingInstances();s.Reset(null)}_Trigger(t,e,s){if(!e)return this._TriggerForClass(t,e,null,null);{const i=e.GetObjectClass();let r=!1,n=this._TriggerForClass(t,e,i,s);r=r||n;for(const a of i.GetFamilies())n=this._TriggerForClass(t,e,a,s),r=r||n}}_TriggerForClass(t,e,s,i){const r=this._triggers.get(s);if(!r)return!1;const n=i?r.behaviors.get(i):r.methodMap;if(!n)return!1;const a=n.get(t);if(!a)return!1;let o=!1;for(const[t,s]of a){const i=this._ExecuteTrigger(e,t,s);o=o||i}return o}*_DebugTrigger(t,e,s){if(!e)return yield*this._DebugTriggerForClass(t,e,null,null);{const i=e.GetObjectClass();let r=!1,n=yield*this._DebugTriggerForClass(t,e,i,s);r=r||n;for(const a of i.GetFamilies())n=yield*this._DebugTriggerForClass(t,e,a,s),r=r||n}}*_DebugTriggerForClass(t,e,s,i){const r=this._triggers.get(s);if(!r)return!1;const n=i?r.behaviors.get(i):r.methodMap;if(!n)return!1;const a=n.get(t);if(!a)return!1;let o=!1;for(const[t,s]of a){let i;i=t.DebugCanRunFast()?this._ExecuteTrigger(e,t,s):yield*this._DebugExecuteTrigger(e,t,s),o=o||i}return o}_FastTrigger(t,e,s){const i=e.GetObjectClass(),r=this._fastTriggers.get(i);if(!r)return!1;const n=r.get(t);if(!n)return!1;const a=n.get(s);if(!a)return!1;let o=!1;for(let t=0,e=a.length;t<e;++t){const e=a[t],s=this._ExecuteTrigger(null,e[0],e[1]);o=o||s}return o}*_DebugFastTrigger(t,e,s){const i=e.GetObjectClass(),r=this._fastTriggers.get(i);if(!r)return!1;const n=r.get(t);if(!n)return!1;const a=n.get(s);if(!a)return!1;let o=!1;for(let t=0,e=a.length;t<e;++t){const e=a[t],s=e[0],i=e[1];let r;r=s.DebugCanRunFast()?this._ExecuteTrigger(null,s,i):yield*this._DebugExecuteTrigger(null,s,i),o=o||r}return o}_ExecuteTrigger(t,e,s){const i=this._runtime,r=this._eventSheetManager,n=r.GetCurrentEvent(),a=r.GetEventStack(),o=r.GetTriggerDepth();let h=!1;n&&r.PushCleanSol(n.GetSolModifiersIncludingParents()),r.PushCleanSol(e.GetSolModifiersIncludingParents());const l=o>1;l&&r.GetLocalVarStack().Push();const c=a.Push(e);t&&(e.GetConditions()[s].GetObjectClass().GetCurrentSol().SetSinglePicked(t),t.IsInContainer()&&t.SetSiblingsSinglePicked());let u=!0;if(e.GetParent()){const t=e.GetTriggerParents();for(let e=0,s=t.length;e<s;++e)if(!t[e].RunPreTrigger(c)){u=!1;break}}return u&&(e.IsOrBlock()?e.RunOrBlockTrigger(c,s):e.Run(c),h=c.GetLastEventTrue()),a.Pop(),l&&r.GetLocalVarStack().Pop(),r.PopSol(e.GetSolModifiersIncludingParents()),n&&r.PopSol(n.GetSolModifiersIncludingParents()),n||1!==o||(r.ClearAsyncActionPromises(),r.IsFlushingBlocked()||i.FlushPendingInstances()),h}*_DebugExecuteTrigger(t,e,s){const i=this._runtime,r=this._eventSheetManager,n=r.GetCurrentEvent(),a=r.GetEventStack(),o=r.GetTriggerDepth();let h=!1;n&&r.PushCleanSol(n.GetSolModifiersIncludingParents()),r.PushCleanSol(e.GetSolModifiersIncludingParents());const l=o>1;l&&r.GetLocalVarStack().Push();const c=a.Push(e);t&&(e.GetConditions()[s].GetObjectClass().GetCurrentSol().SetSinglePicked(t),t.IsInContainer()&&t.SetSiblingsSinglePicked());let u=!0;if(e.GetParent()){const t=e.GetTriggerParents();for(let e=0,s=t.length;e<s;++e)if(!(yield*t[e].DebugRunPreTrigger(c))){u=!1;break}}return u&&(e.IsOrBlock()?yield*e.DebugRunOrBlockTrigger(c,s):yield*e.DebugRun(c),h=c.GetLastEventTrue()),a.Pop(),l&&r.GetLocalVarStack().Pop(),r.PopSol(e.GetSolModifiersIncludingParents()),n&&r.PopSol(n.GetSolModifiersIncludingParents()),n||1!==o||(r.ClearAsyncActionPromises(),r.IsFlushingBlocked()||i.FlushPendingInstances()),h}_GetPerfRecord(){return this._perfRecord}}}{let $m=function(t,e){return!0};0;const tS=self.C3,eS=[];function*sS(t,e){return!0}tS.EventBlock=class extends tS.DefendedBase{constructor(t,e,s){super(),this._eventSheet=t,this._runtime=t.GetRuntime(),this._parent=e,this._scopeParent=null,this._eventStack=this._runtime.GetEventSheetManager().GetEventStack(),this._solModifiers=[],this._solModifiersIncludingParents=[],this._hasGotSolModifiersIncludingParents=!1,this._isSolWriterAfterCnds=!1,this._isTopLevelGroup=!1,this._hasElseBlock=!1,this._isOrBlock=!!s[2],this._isElseBlock=!1,this._triggerParents=null,this._conditions=[],this._actions=[],this._subEvents=[],this._RunActions=$m,this._DebugRunActions=sS,this._isGroup=!1,this._isInitiallyActive=!1,this._groupName="",this._isGroupActive=!1,this._containedIncludes=null,this._perfRecord=null,this._sid=s[4],this._displayNumber=s[5],this._eventSheet._RegisterEventByDisplayNumber(this,this._displayNumber),this._debugData=this._runtime.IsDebug()?{isBreakpoint:s[3][0],isBreakable:s[3][1],canRunAllConditionsFast:!1,canRunAllActionsFast:!1,canRunAllSubEventsFast:!1,canRunSelfFast:!1}:null,this.GetEventSheetManager()._RegisterEventBlock(this),3===s[0]&&this._InitGroup(s[1]);let i=0;for(const t of s[6]){const e=tS.Condition.Create(this,t,i++);this._conditions.push(e),this._AddSolModifier(e.GetObjectClass())}i=0;for(const t of s[7]){const e=tS.Action.Create(this,t,i++);this._actions.push(e)}if(9===s.length){const t=s[8];for(const e of t)this._eventSheet._CreateEvent(e,this,this._subEvents)}this._conditions.length&&(this._isElseBlock=null===this._conditions[0].GetObjectClass()&&this._conditions[0]._GetFunc()===tS.Plugins.System.Cnds.Else),0===this._conditions.length&&(this._conditions=eS),0===this._actions.length&&(this._actions=eS),0===this._subEvents.length&&(this._subEvents=eS)}static Create(t,e,s){return tS.New(tS.EventBlock,t,e,s)}_InitGroup(t){this._isGroup=!0,this._isInitiallyActive=!!t[0],this._isGroupActive=this._isInitiallyActive,this._groupName=t[1].toLowerCase(),this._containedIncludes=[],this.GetEventSheetManager()._RegisterGroup(this),this._runtime.IsDebug()&&(this._perfRecord={type:"group",name:t[1],totalTimeCounter:0,children:[]})}_AddContainedInclude(t){this._containedIncludes.push(t)}_AddContainerSolModifierToList(t,e){for(const s of t.GetContainer().objectTypes())e.includes(s)||e.push(s)}_AddSolModifierToList(t,e){if(t)if(e.includes(t)||e.push(t),t.IsFamily())for(const s of t.GetFamilyMembers())s.IsInContainer()&&this._AddContainerSolModifierToList(s,e);else t.IsInContainer()&&this._AddContainerSolModifierToList(t,e)}_AddSolModifier(t){this._AddSolModifierToList(t,this._solModifiers)}_AddParentSolModifier(t){this._AddSolModifierToList(t,this._solModifiersIncludingParents)}SetAllSolModifiers(){this._solModifiers=this._runtime.GetAllObjectClasses()}_PostInit(t){this._hasElseBlock=!!t,this._IdentifyTopLevelGroup(),this._IdentifyTriggerParents();for(const t of this._conditions)t._PostInit();if(this._actions.length>0){let t=!1;for(const e of this._actions)e._PostInit(),e.HasReturnType()&&(t=!0);t?(this._RunActions=this._RunActions_ReturnValue,this._DebugRunActions=this._DebugRunActions_ReturnValue):(this._RunActions=this._RunActions_Fast,this._DebugRunActions=this._DebugRunActions_Fast)}const e=this._subEvents;for(let t=0,s=e.length;t<s;++t){const i=t<s-1&&e[t+1]instanceof tS.EventBlock&&e[t+1].IsElseBlock();e[t]._PostInit(i)}this._debugData&&this._UpdateCanRunFast(),this._perfRecord&&this._GetPerfRecordParent()._GetPerfRecord().children.push(this._perfRecord)}_GetPerfRecord(){return this._perfRecord}_GetPerfRecordParent(){let t=this.GetParent();for(;t;){if(t.IsGroup())return t;t=t.GetParent()}return this._eventSheet}_UpdateCanRunFast(){const t=this._debugData;t.canRunAllConditionsFast=this._conditions.every(t=>t.DebugCanRunFast()),t.canRunAllActionsFast=this._actions.every(t=>t.DebugCanRunFast()),t.canRunAllSubEventsFast=this._subEvents.every(t=>t.DebugCanRunFast()),t.canRunSelfFast=t.canRunAllConditionsFast&&t.canRunAllActionsFast&&t.canRunAllSubEventsFast}_UpdateCanRunFastRecursive(){let t=this;do{t._UpdateCanRunFast(),t=t.GetParent()}while(t)}_IdentifyTopLevelGroup(){if(!this.IsGroup())return;let t=this.GetParent();for(this._isTopLevelGroup=!0;t;){if(!t.IsGroup()){this._isTopLevelGroup=!1;break}t=t.GetParent()}}_IdentifySolModifiersIncludingParents(){const t=this._runtime.GetAllObjectClasses();if(this._solModifiers===t)this._solModifiersIncludingParents=t;else{this._solModifiersIncludingParents=tS.cloneArray(this._solModifiers);let t=this.GetParent();for(;t;){for(const e of t._solModifiers)this._AddParentSolModifier(e);t=t.GetParent()}const e=this.GetEventSheetManager();this._solModifiers=e._DeduplicateSolModifierList(this._solModifiers),this._solModifiersIncludingParents=e._DeduplicateSolModifierList(this._solModifiersIncludingParents)}}_IdentifyTriggerParents(){if(!this.HasAnyTriggeredCondition())return;this._triggerParents=[];let t=this.GetParent();for(;t;)this._triggerParents.push(t),t=t.GetParent();this._triggerParents.reverse()}SetSolWriterAfterCnds(){this._isSolWriterAfterCnds=!0,this._parent&&this._parent.SetSolWriterAfterCnds()}IsSolWriterAfterCnds(){return this._isSolWriterAfterCnds}GetSolModifiers(){return this._solModifiers}GetSolModifiersIncludingParents(){return this._hasGotSolModifiersIncludingParents||(this._hasGotSolModifiersIncludingParents=!0,this._IdentifySolModifiersIncludingParents()),this._solModifiersIncludingParents}HasSolModifier(t){return this._solModifiers.includes(t)}GetTriggerParents(){return this._triggerParents}GetEventSheet(){return this._eventSheet}GetEventSheetManager(){return this._eventSheet.GetEventSheetManager()}GetRuntime(){return this._runtime}GetParent(){return this._parent}_SetScopeParent(t){this._scopeParent=t}GetScopeParent(){return this._scopeParent||this._parent}GetDisplayNumber(){return this._displayNumber}IsDebugBreakable(){return this._debugData&&this._debugData.isBreakable}IsDebugBreakpoint(){return this.IsDebugBreakable()&&this._debugData.isBreakpoint}_SetDebugBreakpoint(t){this._debugData.isBreakpoint=!!t,this._UpdateCanRunFastRecursive()}IsGroup(){return this._isGroup}IsTopLevelGroup(){return this._isTopLevelGroup}IsElseBlock(){return this._isElseBlock}HasElseBlock(){return this._hasElseBlock}GetGroupName(){return this._groupName}IsGroupActive(){return this._isGroupActive}ResetInitialActivation(){this.SetGroupActive(this._isInitiallyActive)}SetGroupActive(t){if(t=!!t,!this._isGroup)throw new Error("not a group");if(this._isGroupActive!==t){this._isGroupActive=t;for(const t of this._containedIncludes)t.UpdateActive();if(this._containedIncludes.length){const t=this._runtime.GetCurrentLayout().GetEventSheet();t&&t._UpdateDeepIncludes()}}}GetSID(){return this._sid}IsOrBlock(){return this._isOrBlock}IsTrigger(){return this._conditions.length&&this._conditions[0].IsTrigger()}IsForFunctionBlock(){return this._scopeParent&&this._scopeParent instanceof tS.FunctionBlock}HasAnyTriggeredCondition(){return this.IsForFunctionBlock()||this._conditions.some(t=>t.IsTrigger())}GetConditions(){return this._conditions}GetConditionCount(){return this._conditions.length}GetConditionAt(t){if((t=Math.floor(t))<0||t>=this._conditions.length)throw new RangeError("invalid condition index");return this._conditions[t]}GetConditionByDebugIndex(t){return this.GetConditionAt(t)}IsFirstConditionOfType(t){let e=t.GetIndex();if(0===e)return!0;--e;const s=t.IsSystemOrSingleGlobalCondition()?t.GetFirstObjectParameterObjectClass():t.GetObjectClass();for(;e>=0;--e){const t=this._conditions[e];if(s===t.GetObjectClass()||t.IsSystemOrSingleGlobalCondition()&&t.GetFirstObjectParameterObjectClass()===s)return!1}return!0}GetActions(){return this._actions}GetActionCount(){return this._actions.length}GetActionAt(t){if((t=Math.floor(t))<0||t>=this._actions.length)throw new RangeError("invalid action index");return this._actions[t]}GetActionByDebugIndex(t){t=Math.floor(t);const e=this._actions.find(e=>e.GetDebugIndex()===t);if(!e)throw new RangeError("invalid action debug index");return e}_HasActionIndex(t){return(t=Math.floor(t))>=0&&t<this._actions.length}GetSubEvents(){return this._subEvents}_GetAllLocalVariablesInScope(){return this._subEvents.filter(t=>t instanceof tS.EventVariable)}RunPreTrigger(t){t.SetCurrentEvent(this);const e=this._conditions;let s=0===e.length;for(let i=0,r=e.length;i<r;++i){const r=e[i];if(t.SetConditionIndex(i),r.IsLooping())throw new Error("trigger cannot be used as sub-event to a loop");if(r.Run())s=!0;else if(!this._isOrBlock)return!1}return!this._isOrBlock||s}RunOrBlockTrigger(t,e){t.SetCurrentEvent(this),t.SetConditionIndex(e),this._conditions[e].Run()&&(this._RunActions(t,0)&&this._RunSubEvents(t),t.SetLastEventTrue(!0))}*DebugRunPreTrigger(t){t.SetCurrentEvent(this);const e=this._conditions;let s=0===e.length;for(let i=0,r=e.length;i<r;++i){const r=e[i];if(t.SetConditionIndex(i),r.IsLooping())throw new Error("trigger cannot be used as sub-event to a loop");let n;if(n=r.DebugCanRunFast()?r.Run():yield*r.DebugRun(),n)s=!0;else if(!this._isOrBlock)return!1}return!this._isOrBlock||s}*DebugRunOrBlockTrigger(t,e){t.SetCurrentEvent(this),t.SetConditionIndex(e);const s=this._conditions[e];let i;if(i=s.DebugCanRunFast()?s.Run():yield*s.DebugRun(),i){let e;e=this.DebugCanRunActionsFast()?this._RunActions(t,0):yield*this._DebugRunActions(t,0),e&&(this.DebugCanRunSubEventsFast()?this._RunSubEvents():yield*this._DebugRunSubEvents()),t.SetLastEventTrue(!0)}}Run(t){t.SetCurrentEvent(this),this._isElseBlock||t.SetElseBranchRan(!1),this._isOrBlock?this._RunOrBlock(t):this._RunAndBlock(t)}*DebugRun(t){(this.IsDebugBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),t.SetCurrentEvent(this),this._isElseBlock||t.SetElseBranchRan(!1),this._isOrBlock?yield*this._DebugRunOrBlock(t):yield*this._DebugRunAndBlock(t)}_RunOrBlock(t){const e=this._conditions;let s=0===e.length;for(let i=0,r=e.length;i<r;++i){const r=e[i];if(r.IsTrigger())continue;t.SetConditionIndex(i);const n=r.Run();s=s||n}t.SetLastEventTrue(s),s&&(this._RunActions(t,0)&&this._RunSubEvents(t),this._hasElseBlock&&t.SetElseBranchRan(!0))}*_DebugRunOrBlock(t){const e=this._conditions;let s=0===e.length;for(let i=0,r=e.length;i<r;++i){const r=e[i];if(r.IsTrigger())continue;let n;t.SetConditionIndex(i),n=r.DebugCanRunFast()?r.Run():yield*r.DebugRun(),s=s||n}if(t.SetLastEventTrue(s),s){let e;e=this.DebugCanRunActionsFast()?this._RunActions(t,0):yield*this._DebugRunActions(t,0),e&&(this.DebugCanRunSubEventsFast()?this._RunSubEvents():yield*this._DebugRunSubEvents()),this._hasElseBlock&&t.SetElseBranchRan(!0)}}_RunAndBlock(t){const e=this._conditions;for(let s=0,i=e.length;s<i;++s){const i=e[s];if(t.SetConditionIndex(s),!i.Run())return void t.SetLastEventTrue(!1)}t.SetLastEventTrue(!0),this._RunActions(t,0)&&this._RunSubEvents(t),t.GetLastEventTrue()&&this._hasElseBlock&&t.SetElseBranchRan(!0)}*_DebugRunAndBlock(t){const e=this._conditions;for(let s=0,i=e.length;s<i;++s){const i=e[s];let r;if(t.SetConditionIndex(s),r=i.DebugCanRunFast()?i.Run():yield*i.DebugRun(),!r)return void t.SetLastEventTrue(!1)}let s;t.SetLastEventTrue(!0),s=this.DebugCanRunActionsFast()?this._RunActions(t,0):yield*this._DebugRunActions(t,0),s&&(this.DebugCanRunSubEventsFast()?this._RunSubEvents():yield*this._DebugRunSubEvents()),t.GetLastEventTrue()&&this._hasElseBlock&&t.SetElseBranchRan(!0)}_RunActions_Fast(t,e){const s=this._actions;for(let i=e,r=s.length;i<r;++i){const e=s[i];t.SetActionIndex(i),e.Run()}return!0}*_DebugRunActions_Fast(t,e){const s=this._actions;for(let i=e,r=s.length;i<r;++i){const e=s[i];t.SetActionIndex(i),e.DebugCanRunFast()?e.Run():yield*e.DebugRun()}return!0}_RunActions_ReturnValue(t,e){const s=this.GetEventSheetManager(),i=this._actions;for(let r=e,n=i.length;r<n;++r){const e=i[r];t.SetActionIndex(r);const n=e.Run();if(e.CanBailOut()&&!0===n)return!1;e.IsAsync()&&n instanceof Promise&&s.AddAsyncActionPromise(n)}return!0}*_DebugRunActions_ReturnValue(t,e){const s=this.GetEventSheetManager(),i=this._actions;for(let r=e,n=i.length;r<n;++r){const e=i[r];let n;if(t.SetActionIndex(r),n=e.DebugCanRunFast()?e.Run():yield*e.DebugRun(),e.CanBailOut()&&!0===n)return!1;e.IsAsync()&&n instanceof Promise&&s.AddAsyncActionPromise(n)}return!0}_ResumeActionsAndSubEvents(t){this._RunActions(t,t.GetActionIndex())&&this._RunSubEvents()}*_DebugResumeActionsAndSubEvents(t){(yield*this._DebugRunActions(t,t.GetActionIndex()))&&(yield*this._DebugRunSubEvents())}_RunSubEvents(){if(!this._subEvents.length)return;const t=this.IsGroup()&&this._runtime.IsCPUProfiling(),e=t?performance.now():0,s=this._eventStack,i=s.Push(this);this._isSolWriterAfterCnds?this._RunSubEvents_SolWriterAfterCnds(i):this._RunSubEvents_Fast(i),s.Pop(),t&&(this._perfRecord.totalTimeCounter+=performance.now()-e)}_RunSubEvents_SolWriterAfterCnds(t){const e=this._isGroup,s=this._isTopLevelGroup,i=this.GetEventSheetManager(),r=this._subEvents;for(let n=0,a=r.length,o=a-1;n<a;++n){const a=r[n],h=a.GetSolModifiers(),l=!s||!e&&n<o;l&&i.PushCopySol(h),a.Run(t),l?i.PopSol(h):i.ClearSol(h)}}_RunSubEvents_Fast(t){const e=this._subEvents;for(let s=0,i=e.length;s<i;++s)e[s].Run(t)}*_DebugRunSubEvents(){if(!this._subEvents.length)return;const t=this._eventStack,e=t.Push(this);this._isSolWriterAfterCnds?yield*this._DebugRunSubEvents_SolWriterAfterCnds(e):yield*this._DebugRunSubEvents_Fast(e),t.Pop()}*_DebugRunSubEvents_SolWriterAfterCnds(t){const e=this._isGroup,s=this._isTopLevelGroup,i=this.GetEventSheetManager(),r=this._subEvents;for(let n=0,a=r.length,o=a-1;n<a;++n){const a=r[n],h=a.GetSolModifiers(),l=!s||!e&&n<o;l&&i.PushCopySol(h),yield*a.DebugRun(t),l?i.PopSol(h):i.ClearSol(h)}}*_DebugRunSubEvents_Fast(t){const e=this._subEvents;for(let s=0,i=e.length;s<i;++s)yield*e[s].DebugRun(t)}Retrigger(t,e){e.ResetQuick();const s=this._conditions;if(!this.IsOrBlock())for(let i=t.GetConditionIndex()+1,r=s.length;i<r;++i){const t=s[i];if(e.SetConditionIndex(i),!t.Run())return!1}return this._RunActions(e,0)&&this._RunSubEvents(e),!0}*DebugRetrigger(t,e){e.ResetQuick();const s=this._conditions;if(!this.IsOrBlock())for(let i=t.GetConditionIndex()+1,r=s.length;i<r;++i){const t=s[i];let r;if(e.SetConditionIndex(i),r=t.DebugCanRunFast()?t.Run():yield*t.DebugRun(),!r)return!1}let i;return i=this.DebugCanRunActionsFast()?this._RunActions(e,0):yield*this._DebugRunActions(e,0),i&&(this.DebugCanRunSubEventsFast()?this._RunSubEvents():yield*this._DebugRunSubEvents()),!0}DebugCanRunFast(){return!this.IsDebugBreakpoint()&&!this._runtime.DebugBreakNext()&&this._debugData.canRunSelfFast}DebugCanRunActionsFast(){return!this._runtime.DebugBreakNext()&&this._debugData.canRunAllActionsFast}DebugCanRunSubEventsFast(){return!this._runtime.DebugBreakNext()&&this._debugData.canRunAllSubEventsFast}_CheckParentsOKToRun(t){if(this.GetParent()){const e=this.GetTriggerParents();for(let s=0,i=e.length;s<i;++s)if(!e[s].RunPreTrigger(t))return!1}return!0}*_DebugCheckParentsOKToRun(t){if(this.GetParent()){const e=this.GetTriggerParents();for(let s=0,i=e.length;s<i;++s)if(!(yield*e[s].DebugRunPreTrigger(t)))return!1}return!0}_EvaluateFunctionCallParameters(t,e,s){if(e.length>0)if(s){const s=e.map(t=>t.Get(0));t.GetLocalVarStack().Push(),this._scopeParent.SetFunctionParameters(s)}else this._scopeParent.EvaluateFunctionParameters(e);else s&&t.GetLocalVarStack().Push()}#e(t,e,s,i){let r=null;if(e.copyFromObjectClass){const t=s?e.copyFromObjectClass.GetCurrentSol():e.copyFromObjectClass.GetSolStack().GetOneBelowCurrentSol(),i=e.copyToObjectClass.GetCurrentSol();i.SetArrayPicked(t.GetInstances()),i.ClearElseInstances(),s||e.copyToObjectClass.ApplySolToContainer()}else if(e.pickObjectClass){const t=e.pickObjectClass.GetCurrentSol();t.SetArrayPicked(e.pickInstances),t.ClearElseInstances()}return e.pushCleanSolDynamic&&(r=t.PushCleanSolDynamic(i)),r}RunAsFunctionCall(t,e,s,i){let r,n;const a=t.length>0;let o=null;const h=this._runtime,l=this._eventStack,c=h.GetEventSheetManager(),u=this._scopeParent,_=u.IsAsync(),d=c._IncTriggerDepth()>1;this._EvaluateFunctionCallParameters(c,e,d),a&&(s?c.PushCopySol(t):c.PushCleanSol(t)),null!==i&&(o=this.#e(c,i,s,t));const p=l.Push(this);return s&&p.SetDynamicSolModifiers(t),this._CheckParentsOKToRun(p)&&(p.SetCurrentEvent(this),_&&([n,r]=u.StartAsyncFunctionCall()),this._RunAndBlock(p),_&&u.MaybeFinishAsyncFunctionCall(n)),l.Pop(),d&&c.GetLocalVarStack().Pop(),null!==o&&c.PopSol(o),a&&c.PopSol(t),c._DecTriggerDepth(),r}*DebugRunAsFunctionCall(t,e,s,i){let r,n;(this.IsDebugBreakpoint()||this._runtime.DebugBreakNext())&&(yield this);const a=t.length>0;let o=null;const h=this._runtime,l=this._eventStack,c=h.GetEventSheetManager(),u=this._scopeParent,_=u.IsAsync(),d=c._IncTriggerDepth()>1;if(this._EvaluateFunctionCallParameters(c,e,d),a&&(s?c.PushCopySol(t):c.PushCleanSol(t)),null!==i){if(i.copyFromObjectClass){const t=s?i.copyFromObjectClass.GetCurrentSol():i.copyFromObjectClass.GetSolStack().GetOneBelowCurrentSol(),e=i.copyToObjectClass.GetCurrentSol();e.SetArrayPicked(t.GetInstances()),e.ClearElseInstances(),s||i.copyToObjectClass.ApplySolToContainer()}else if(i.pickObjectClass){const t=i.pickObjectClass.GetCurrentSol();t.SetArrayPicked(i.pickInstances),t.ClearElseInstances()}i.pushCleanSolDynamic&&(o=c.PushCleanSolDynamic(t))}const p=l.Push(this);return s&&p.SetDynamicSolModifiers(t),(yield*this._DebugCheckParentsOKToRun(p))&&(p.SetCurrentEvent(this),_&&([n,r]=u.StartAsyncFunctionCall()),yield*this._DebugRunAndBlock(p),_&&u.MaybeFinishAsyncFunctionCall(n)),l.Pop(),d&&c.GetLocalVarStack().Pop(),null!==o&&c.PopSol(o),a&&c.PopSol(t),c._DecTriggerDepth(),r}RunAsMappedFunctionCall(t,e){const s=this.GetSolModifiersIncludingParents(),i=s.length>0,r=this._runtime,n=this._eventStack,a=r.GetEventSheetManager(),o=a._IncTriggerDepth()>1;o&&a.GetLocalVarStack().Push(),this._scopeParent.SetFunctionParameters(t),i&&(e?a.PushCopySol(s):a.PushCleanSol(s));const h=n.Push(this);this._CheckParentsOKToRun(h)&&(h.SetCurrentEvent(this),this._RunAndBlock(h)),n.Pop(),o&&a.GetLocalVarStack().Pop(),i&&a.PopSol(s),a._DecTriggerDepth()}*DebugRunAsMappedFunctionCall(t,e){(this.IsDebugBreakpoint()||this._runtime.DebugBreakNext())&&(yield this);const s=this.GetSolModifiersIncludingParents(),i=s.length>0,r=this._runtime,n=this._eventStack,a=r.GetEventSheetManager(),o=a._IncTriggerDepth()>1;o&&a.GetLocalVarStack().Push(),this._scopeParent.SetFunctionParameters(t),i&&(e?a.PushCopySol(s):a.PushCleanSol(s));const h=n.Push(this);(yield*this._DebugCheckParentsOKToRun(h))&&(h.SetCurrentEvent(this),yield*this._DebugRunAndBlock(h)),n.Pop(),o&&a.GetLocalVarStack().Pop(),i&&a.PopSol(s),a._DecTriggerDepth()}RunAsExpressionOrJSFunctionCall(t,e,s,i,r,...n){let a,o;const h=t.length>0;let l=null;const c=this._runtime,u=this._eventStack,_=c.GetEventSheetManager(),d=this._scopeParent,p=d.IsAsync(),f=_._IncTriggerDepth()>1;f&&_.GetLocalVarStack().Push(),n.length>0&&this._scopeParent.SetFunctionParameters(n),h&&(e?_.PushCopySol(t):_.PushCleanSol(t)),null!==r&&(l=this.#e(_,r,e,t));const g=u.Push(this);return g.InitCallFunctionExpression(s,i),e&&g.SetDynamicSolModifiers(t),u.PushExpFunc(g),c.SetDebuggingEnabled(!1),this._CheckParentsOKToRun(g)&&(g.SetCurrentEvent(this),p&&([o,a]=d.StartAsyncFunctionCall()),this._RunAndBlock(g),p&&d.MaybeFinishAsyncFunctionCall(o)),c.SetDebuggingEnabled(!0),u.Pop(),u.PopExpFunc(),f&&_.GetLocalVarStack().Pop(),null!==l&&_.PopSol(l),h&&_.PopSol(t),_._DecTriggerDepth(),a||g.GetFunctionReturnValue()}}}{const iS=self.C3,rS=[];let nS=!1;iS.EventScript=class extends iS.DefendedBase{constructor(t,e,s){super();const i=t.GetRuntime(),r=t.GetEventSheetManager();this._eventSheet=t,this._eventSheetManager=r,this._runtime=t.GetRuntime(),this._parent=e;const n=i.GetObjectReference(s[1]);this._func=n,this._displayNumber=s[2],this._eventSheet._RegisterEventByDisplayNumber(this,this._displayNumber),this._debugData=i.IsDebug()?{isBreakpoint:s[3][0],isBreakable:s[3][1]}:null}static Create(t,e,s){return iS.New(iS.EventScript,t,e,s)}_PostInit(){const t=this._func,e=this._runtime.GetEventSheetManager()._GetLocalVariablesScriptInterface(this);this._func=t.bind(null,this._runtime.GetIRuntime(),e)}GetParent(){return this._parent}GetScopeParent(){return this._parent}GetEventSheet(){return this._eventSheet}GetDisplayNumber(){return this._displayNumber}IsDebugBreakable(){return this._debugData&&this._debugData.isBreakable}IsDebugBreakpoint(){return this.IsDebugBreakable()&&this._debugData.isBreakpoint}_SetDebugBreakpoint(t){this._debugData.isBreakpoint=!!t}IsElseBlock(){return!1}GetSolModifiers(){return rS}GetSolModifiersIncludingParents(){return this._parent?this._parent.GetSolModifiersIncludingParents():rS}Run(t){t.SetCurrentEvent(this),this._eventSheetManager.AddAsyncActionPromise(this._RunUserScript())}async _RunUserScript(){try{await this._func()}catch(t){console.error(`Unhandled exception running script %c${this.GetEventSheet().GetName()}, event ${this.GetDisplayNumber()}:`,"font-size: 1.2em; font-weight: bold;",t),self.C3Debugger&&self.C3Debugger._SetLastErrorScript(this),nS||(console.info("%cTip:%c run this to highlight in Construct the last script that had an error: %cgoToLastErrorScript()","font-weight: bold; text-decoration: underline","","font-weight: bold"),nS=!0)}}*DebugRun(t){t.SetCurrentEvent(this),(this.IsDebugBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),this.Run(t)}DebugCanRunFast(){return!this.IsDebugBreakpoint()&&!this._runtime.DebugBreakNext()}static HadUserScriptException(){return nS}static SetHadUserScriptException(){nS=!0}}}{const aS=self.C3;self.assert;aS.FunctionBlock=class extends aS.DefendedBase{constructor(t,e,s){super(),this._eventSheet=t,this._runtime=t.GetRuntime(),this._parent=e,this._functionType=0,this._functionName="",this._returnType=0,this._functionParameters=[],this._isEnabled=!0,this._aceName="",this._objectClass=null,this._hasOverrides=!1,this._innerLocalVariables=[],this._isCopyPicked=!1,this._isAsync=!1,this._nextAsyncId=0,this._currentAsyncId=-1,this._asyncMap=new Map,this._eventBlock=aS.EventBlock.Create(t,e,s),this._eventBlock._SetScopeParent(this)}InitFunctionBlock(t){this._functionType=0,this._functionName=t[0],this._returnType=t[1],this._functionParameters=t[2].map(t=>aS.EventVariable.Create(this._eventSheet,this,t)),this._isEnabled=t[3],this._isAsync=t[4],this._isCopyPicked=t[5]}InitCustomACEBlock(t){this._functionType=1,this._aceName=t[1],this._objectClass=this._runtime.GetObjectClassByIndex(t[2]),this._eventBlock._AddSolModifier(this._objectClass),this._functionName=this._objectClass.GetName()+"."+this._aceName,this._returnType=t[3],this._functionParameters=t[4].map(t=>aS.EventVariable.Create(this._eventSheet,this,t)),this._isEnabled=t[5],this._isAsync=t[6],this._isCopyPicked=t[7],this._objectClass.AddCustomAction(this)}static CreateFunctionBlock(t,e,s){const i=aS.New(aS.FunctionBlock,t,e,s),r=s[1];return i.InitFunctionBlock(r),i}static CreateCustomACEBlock(t,e,s){const i=aS.New(aS.FunctionBlock,t,e,s),r=s[1];return i.InitCustomACEBlock(r),i}_CheckOverrideState(){if(this._objectClass&&this._objectClass.IsFamily())for(const t of this._objectClass.GetFamilyMembers())if(t.HasOwnCustomActionByName(this._aceName)){this._hasOverrides=!0;break}}_PostInit(){for(const t of this._functionParameters)t._PostInit();this._eventBlock._PostInit(!1)}GetFunctionType(){return this._functionType}_GetAllLocalVariablesInScope(){return this._functionParameters}GetFunctionParameters(){return this._functionParameters}GetFunctionParameterCount(){return this._functionParameters.length}_RegisterLocalVariable(t){this._innerLocalVariables.push(t)}_GetAllInnerLocalVariables(){return this._innerLocalVariables}EvaluateFunctionParameters(t){const e=this._functionParameters;for(let s=0,i=e.length;s<i;++s)e[s].SetValue(t[s].Get(0))}SetFunctionParameters(t){const e=this._functionParameters;for(let s=0,i=e.length;s<i;++s)e[s].SetValue(t[s])}CaptureFunctionParameters(){return this._functionParameters.map(t=>t.GetValue())}GetParent(){return this._parent}GetScopeParent(){return this._parent}GetFunctionName(){return this._functionName}GetACEName(){return this._aceName}HasCustomACEOverrides(){return this._hasOverrides}GetReturnType(){return this._returnType}GetObjectClass(){return this._objectClass}IsEnabled(){return this._isEnabled}GetDefaultReturnValue(){switch(this._returnType){case 0:return null;case 2:return"";default:return 0}}GetEventBlock(){return this._eventBlock}IsCopyPicked(){return this._isCopyPicked}IsAsync(){return this._isAsync}StartAsyncFunctionCall(){const t=this._nextAsyncId++;let e;this._currentAsyncId=t;const s=new Promise(t=>e=t);return this._asyncMap.set(t,{resolve:e,pauseCount:0}),[t,s]}MaybeFinishAsyncFunctionCall(t){const e=this._asyncMap.get(t);0===e.pauseCount&&(e.resolve(),this._asyncMap.delete(t)),this._currentAsyncId=-1}PauseCurrentAsyncFunction(){return this._asyncMap.get(this._currentAsyncId).pauseCount++,this._currentAsyncId}ResumeAsyncFunction(t){this._currentAsyncId=t,this._asyncMap.get(t).pauseCount--}RunAsFamilyCustomActionWithOverrides(t,e){const s=new Map,i=[];for(const t of this._objectClass.GetCurrentSol().GetInstances()){const e=t.GetObjectClass();if(e.HasOwnCustomActionByName(this._aceName)){const i=s.get(e);Array.isArray(i)?i.push(t):s.set(e,[t])}else i.push(t)}if(i.length>0&&this._eventBlock.RunAsFunctionCall(t,e,this._isCopyPicked,{pickObjectClass:this._objectClass,pickInstances:i}),s.size>0)for(const[i,r]of s){const s=i.GetOwnCustomActionByName(this._aceName).GetEventBlock(),n=[...new Set([...t,...s.GetSolModifiers()])];s.RunAsFunctionCall(n,e,this._isCopyPicked,{pickObjectClass:i,pickInstances:r})}}*DebugRunAsFamilyCustomActionWithOverrides(t,e){const s=new Map,i=[];for(const t of this._objectClass.GetCurrentSol().GetInstances()){const e=t.GetObjectClass();if(e.HasOwnCustomActionByName(this._aceName)){const i=s.get(e);Array.isArray(i)?i.push(t):s.set(e,[t])}else i.push(t)}if(i.length>0&&(yield*this._eventBlock.DebugRunAsFunctionCall(t,e,this._isCopyPicked,{pickObjectClass:this._objectClass,pickInstances:i})),s.size>0)for(const[i,r]of s){const s=i.GetOwnCustomActionByName(this._aceName).GetEventBlock(),n=[...new Set([...t,...s.GetSolModifiers()])];yield*s.DebugRunAsFunctionCall(n,e,this._isCopyPicked,{pickObjectClass:i,pickInstances:r})}}}}{const oS=self.C3,hS=[];oS.EventVariable=class extends oS.DefendedBase{constructor(t,e,s){super();const i=t.GetEventSheetManager();this._eventSheet=t,this._eventSheetManager=i,this._runtime=t.GetRuntime(),this._parent=e,this._localVarStack=i.GetLocalVarStack(),this._name=s[1],this._type=s[2],this._initialValue=s[3],this._isStatic=!!s[4],this._isConstant=!!s[5],this._isFunctionParameter=e instanceof oS.FunctionBlock,this._sid=s[6],this._jsPropName=this._runtime.GetJsPropName(s[8]),this._scriptSetter=t=>this._ScriptSetValue(t),this._scriptGetter=()=>this.GetTypedValue(),this._hasSingleValue=!this._parent||this._isStatic||this._isConstant,this._value=this._initialValue,this._localIndex=-1,this.IsBoolean()&&(this._value=this._value?1:0),!this.IsLocal()||this.IsStatic()||this.IsConstant()||(this._localIndex=i._GetNextLocalVarIndex(this)),i._RegisterEventVariable(this)}static Create(t,e,s){return oS.New(oS.EventVariable,t,e,s)}_PostInit(){if(this.IsLocal()&&!this.IsStatic()&&!this.IsConstant()&&!this.IsFunctionParameter()){const t=this._eventSheetManager.FindFirstFunctionBlockParent(this);t&&t._RegisterLocalVariable(this)}}GetName(){return this._name}GetJsPropName(){return this._jsPropName}GetParent(){return this._parent}GetScopeParent(){return this.GetParent()}IsGlobal(){return!this.GetParent()}IsLocal(){return!this.IsGlobal()}IsFunctionParameter(){return this._isFunctionParameter}IsStatic(){return this._isStatic}IsConstant(){return this._isConstant}IsNumber(){return 0===this._type}IsString(){return 1===this._type}IsBoolean(){return 2===this._type}IsElseBlock(){return!1}GetSID(){return this._sid}GetInitialValue(){return this._initialValue}GetSolModifiers(){return hS}Run(t){!this.IsLocal()||this.IsStatic()||this.IsConstant()||this.SetValue(this.GetInitialValue())}DebugCanRunFast(){return!0}*DebugRun(t){this.Run(t)}SetValue(t){this.IsNumber()?"number"!=typeof t&&(t=parseFloat(t)):this.IsString()?"string"!=typeof t&&(t=t.toString()):this.IsBoolean()&&(t=t?1:0),this._hasSingleValue?this._value=t:this._localVarStack.GetCurrent()[this._localIndex]=t}_ScriptSetValue(t){if(this.IsConstant())throw new Error(`assignment to constant event variable '${this.GetName()}'`);this.SetValue(t)}GetValue(){return this._hasSingleValue?this._value:this._localVarStack.GetCurrent()[this._localIndex]}GetTypedValue(){let t=this.GetValue();return this.IsBoolean()&&(t=!!t),t}ResetToInitialValue(){this._value=this._initialValue}_GetScriptInterfaceDescriptor(){return{configurable:!1,enumerable:!0,get:this._scriptGetter,set:this._scriptSetter}}}}{const lS=self.C3,cS=(self.assert,[]);lS.EventInclude=class extends lS.DefendedBase{constructor(t,e,s){super();const i=t.GetEventSheetManager();this._eventSheet=t,this._eventSheetManager=i,this._runtime=t.GetRuntime(),this._parent=e,this._includeSheet=null,this._includeSheetName=s[1],this._isActive=!0}static Create(t,e,s){return lS.New(lS.EventInclude,t,e,s)}_PostInit(){this._includeSheet=this._eventSheetManager.GetEventSheetByName(this._includeSheetName),this._eventSheet._AddShallowInclude(this);let t=this.GetParent();for(;t;)t instanceof lS.EventBlock&&t.IsGroup()&&t._AddContainedInclude(this),t=t.GetParent();this.UpdateActive(),this._runtime.IsDebug()&&this._eventSheet._GetPerfRecord().children.push(this._includeSheet._GetPerfRecord())}GetParent(){return this._parent}GetSolModifiers(){return cS}GetIncludeSheet(){return this._includeSheet}Run(t){const e=!!this.GetParent(),s=this._runtime.GetAllObjectClasses();e&&this._eventSheetManager.PushCleanSol(s),this._includeSheet.Run(),e&&this._eventSheetManager.PopSol(s)}*DebugRun(t){const e=!!this.GetParent(),s=this._runtime.GetAllObjectClasses();e&&this._eventSheetManager.PushCleanSol(s),yield*this._includeSheet.DebugRun(),e&&this._eventSheetManager.PopSol(s)}DebugCanRunFast(){return!1}IsActive(){return this._isActive}UpdateActive(){let t=this.GetParent();for(;t;){if(t instanceof lS.EventBlock&&t.IsGroup()&&!t.IsGroupActive())return void(this._isActive=!1);t=t.GetParent()}this._isActive=!0}}}{let uS=function(t,e){return t>=e?t%e:t<0?(t<=-e&&(t%=e),t<0&&(t+=e),t):t};0;const _S=self.C3;self.assert;_S.ExpNode=class extends _S.DefendedBase{constructor(t){super(),this._owner=t,this._runtime=t.GetRuntime()}_PostInit(){}static CreateNode(t,e){const s=e[0],i=[mS,fS,gS,SS,dS,pS];return _S.New(i[s],t,e)}};class dS extends _S.ExpNode{constructor(t,e){super(t),this._systemPlugin=this._runtime.GetSystemPlugin(),this._func=this._runtime.GetObjectReference(e[1]),this._func!==_S.Plugins.System.Exps.random&&this._func!==_S.Plugins.System.Exps.choose||this._owner.SetVariesPerInstance()}GetBoundMethod(){return this._systemPlugin._GetBoundACEMethod(this._func,this._systemPlugin)}}class pS extends _S.ExpNode{constructor(t,e){super(t),this._functionBlock=null,this._functionName=e[1],this._owner.SetVariesPerInstance()}_PostInit(){const t=this._runtime.GetEventSheetManager();this._functionBlock=t.GetFunctionBlockByName(this._functionName),this._functionName=null;const e=this._owner.GetEventBlock(),s=this._functionBlock.GetEventBlock();this._combinedSolModifiers=[...new Set([...e.GetSolModifiersIncludingParents(),...s.GetSolModifiersIncludingParents()])],this._combinedSolModifiers=t._DeduplicateSolModifierList(this._combinedSolModifiers)}GetBoundMethod(){const t=this._functionBlock;if(t.IsEnabled()){const e=t.GetEventBlock();return _S.EventBlock.prototype.RunAsExpressionOrJSFunctionCall.bind(e,this._combinedSolModifiers,t.IsCopyPicked(),t.GetReturnType(),t.GetDefaultReturnValue(),null)}{const e=t.GetDefaultReturnValue();return()=>e}}}class fS extends _S.ExpNode{constructor(t,e){super(t),this._objectClass=this._runtime.GetObjectClassByIndex(e[1]),this._func=this._runtime.GetObjectReference(e[2]),this._returnsString=!!e[3],this._eventStack=this._runtime.GetEventSheetManager().GetEventStack(),this._owner._MaybeVaryFor(this._objectClass)}GetBoundMethod(){return this._objectClass.GetPlugin()._GetBoundACEMethod(this._func,this._objectClass.GetSingleGlobalInstance().GetSdkInstance())}ExpObject(...t){const e=this._objectClass,s=e.GetCurrentSol().GetExpressionInstances(),i=s.length;if(0===i)return this._returnsString?"":0;const r=uS(this._owner.GetSolIndex(),i);return this._eventStack.GetCurrentStackFrame().SetExpressionObjectClass(e),this._func.apply(s[r].GetSdkInstance(),t)}ExpObject_InstExpr(t,...e){const s=this._objectClass,i=s.GetInstances(),r=i.length;if(0===r||"number"!=typeof t)return this._returnsString?"":0;const n=uS(t,r);return this._eventStack.GetCurrentStackFrame().SetExpressionObjectClass(s),this._func.apply(i[n].GetSdkInstance(),e)}}class gS extends _S.ExpNode{constructor(t,e){super(t),this._objectClass=this._runtime.GetObjectClassByIndex(e[1]),this._varIndex=e[3],this._returnsString=!!e[2],this._owner._MaybeVaryFor(this._objectClass)}ExpInstVar(){const t=this._objectClass.GetCurrentSol().GetExpressionInstances(),e=t.length;return 0===e?this._returnsString?"":0:t[uS(this._owner.GetSolIndex(),e)]._GetInstanceVariableValueUnchecked(this._varIndex)}ExpInstVar_Family(){const t=this._objectClass,e=t.GetCurrentSol().GetExpressionInstances(),s=e.length;if(0===s)return this._returnsString?"":0;const i=e[uS(this._owner.GetSolIndex(),s)],r=i.GetObjectClass().GetFamilyInstanceVariableOffset(t.GetFamilyIndex());return i._GetInstanceVariableValueUnchecked(this._varIndex+r)}ExpInstVar_InstExpr(t){const e=this._objectClass,s=e.GetInstances(),i=s.length;if(0===i||"number"!=typeof t)return this._returnsString?"":0;const r=s[uS(t,i)];let n=0;return e.IsFamily()&&(n=r.GetObjectClass().GetFamilyInstanceVariableOffset(e.GetFamilyIndex())),r._GetInstanceVariableValueUnchecked(this._varIndex+n)}}class mS extends _S.ExpNode{constructor(t,e){super(t),this._objectClass=this._runtime.GetObjectClassByIndex(e[1]),this._behaviorType=this._objectClass.GetBehaviorTypeByName(e[2]),this._behaviorIndex=this._objectClass.GetBehaviorIndexByName(e[2]),this._func=this._runtime.GetObjectReference(e[3]),this._returnsString=!!e[4],this._eventStack=this._runtime.GetEventSheetManager().GetEventStack(),this._owner._MaybeVaryFor(this._objectClass)}ExpBehavior(...t){const e=this._objectClass,s=e.GetCurrentSol().GetExpressionInstances(),i=s.length;if(0===i)return this._returnsString?"":0;const r=uS(this._owner.GetSolIndex(),i);this._eventStack.GetCurrentStackFrame().SetExpressionObjectClass(e);const n=s[r];let a=0;return e.IsFamily()&&(a=n.GetObjectClass().GetFamilyBehaviorOffset(e.GetFamilyIndex())),this._func.apply(n.GetBehaviorInstances()[this._behaviorIndex+a].GetSdkInstance(),t)}ExpBehavior_InstExpr(t,...e){const s=this._objectClass,i=s.GetInstances(),r=i.length;if(0===r||"number"!=typeof t)return this._returnsString?"":0;const n=uS(t,r);this._eventStack.GetCurrentStackFrame().SetExpressionObjectClass(s);const a=i[n];let o=0;return s.IsFamily()&&(o=a.GetObjectClass().GetFamilyBehaviorOffset(s.GetFamilyIndex())),this._func.apply(a.GetBehaviorInstances()[this._behaviorIndex+o].GetSdkInstance(),e)}}class SS extends _S.ExpNode{constructor(t,e){super(t),this._eventVar=null,this._eventVarSid=e[1]}_PostInit(){this._eventVar=this._runtime.GetEventSheetManager().GetEventVariableBySID(this._eventVarSid)}GetVar(){return this._eventVar}}}{let yS=function(t){const e=self.C3_ExpressionFuncs[t];if(!e)throw new Error("invalid expression number");return e};0;const GS=self.C3;self.assert;GS.Parameter=class extends GS.DefendedBase{constructor(t,e,s){super(),this._owner=t,this._index=s,this._type=e,this.Get=null,this._variesPerInstance=!1,this._isConstant=!1}static Create(t,e,s){const i=e[0],r=[TS,IS,vS,bS,wS,CS,MS,TS,bS,bS,RS,AS,vS,ES,IS,PS,xS,DS,FS,OS,BS,LS];return GS.New(r[i],t,i,s,e)}_PostInit(){}SetVariesPerInstance(){this._variesPerInstance=!0}_MaybeVaryFor(t){this._variesPerInstance||t&&(t.GetPlugin().IsSingleGlobal()||(this._variesPerInstance=!0))}VariesPerInstance(){return this._variesPerInstance}GetIndex(){return this._index}GetRuntime(){return this._owner.GetRuntime()}GetEventBlock(){return this._owner.GetEventBlock()}IsConstant(){return this._isConstant}IsObjectParameter(){return 4===this._type}};class TS extends GS.Parameter{constructor(t,e,s,i){super(t,e,s),this._solIndex=0;const r=i[1];this._expressionNumber=r[0],this._numberedNodes=[],this._expressionFunc=null;for(let t=1,e=r.length;t<e;++t)this._numberedNodes.push(GS.ExpNode.CreateNode(this,r[t]));this._numberedNodes.length?this.Get=this.GetExpression:(this.Get=yS(this._expressionNumber),this._isConstant=!0)}_GetNode(t){if(t<0||t>=this._numberedNodes.length)throw new RangeError("invalid numbered node");return this._numberedNodes[t]}_PostInit(){for(const t of this._numberedNodes)t._PostInit();const t=yS(this._expressionNumber);this._numberedNodes.length?this._expressionFunc=t(this):this._expressionFunc=t}GetSolIndex(){return this._solIndex}GetExpression(t){return this._solIndex=t,this._expressionFunc()}}class IS extends TS{constructor(t,e,s,i){super(t,e,s,i),this.Get=this.GetStringExpression,14===e&&(this.GetEventBlock().SetAllSolModifiers(),this._owner instanceof GS.Action&&this.GetEventBlock().SetSolWriterAfterCnds())}GetStringExpression(t){this._solIndex=t;const e=this._expressionFunc();return"string"==typeof e?e:""}_GetFastTriggerValue(){return yS(this._expressionNumber)()}}class CS extends TS{constructor(t,e,s,i){super(t,e,s,i),t.GetImplementationSdkVersion()>=2?this.Get=this.GetILayer:this.Get=this.GetLayer,this._isConstant=!1}GetLayer(t){this._solIndex=t;const e=this._expressionFunc();return this.GetRuntime().GetCurrentLayout().GetLayer(e)}GetILayer(t){const e=this.GetLayer(t);return e?e.GetILayer():null}}class bS extends GS.Parameter{constructor(t,e,s,i){super(t,e,s),this._combo=i[1],this.Get=this.GetCombo,this._isConstant=!0}GetCombo(){return this._combo}}class xS extends GS.Parameter{constructor(t,e,s,i){super(t,e,s),this._bool=i[1],this.Get=this.GetBoolean,this._isConstant=!0}GetBoolean(){return this._bool}}class wS extends GS.Parameter{constructor(t,e,s,i){super(t,e,s),this._objectClass=this.GetRuntime().GetObjectClassByIndex(i[1]),t.GetImplementationSdkVersion()>=2?this.Get=this.GetIObjectClass:this.Get=this.GetObjectClass;const r=this.GetEventBlock();r._AddSolModifier(this._objectClass),this._owner instanceof GS.Action?r.SetSolWriterAfterCnds():r.GetParent()&&r.GetParent().SetSolWriterAfterCnds(),this._isConstant=!0}GetObjectClass(){return this._objectClass}GetIObjectClass(){return this._objectClass?this._objectClass.GetIObjectClass():null}}class MS extends GS.Parameter{constructor(t,e,s,i){super(t,e,s),this._layout=this.GetRuntime().GetLayoutManager().GetLayoutByName(i[1]),t.GetImplementationSdkVersion()>=2?this.Get=this.GetILayout:this.Get=this.GetLayout,this._isConstant=!0}GetLayout(){return this._layout}GetILayout(){return this._layout?this._layout.GetILayout():null}}class PS extends GS.Parameter{constructor(t,e,s,i){super(t,e,s),this._timeline=this.GetRuntime().GetTimelineManager().GetTimelineByName(i[1]),t.GetImplementationSdkVersion()>=2?this.Get=this.GetITimelineState:this.Get=this.GetTimeline,this._isConstant=!0}GetTimeline(){return this._timeline}GetITimelineState(){return this._timeline?this._timeline.GetITimelineState():null}}class vS extends GS.Parameter{constructor(t,e,s,i){super(t,e,s),this._fileInfo=i[1],this.Get=this.GetFile,this._isConstant=!0}GetFile(){return this._fileInfo}}class RS extends GS.Parameter{constructor(t,e,s,i){super(t,e,s),this._instVarIndex=i[1];const r=this._owner.GetObjectClass();this._owner instanceof GS.Condition&&this._owner.IsStatic()?(this.Get=this.GetInstanceVariable,this._isConstant=!0):r&&r.IsFamily()?(this.Get=this.GetFamilyInstanceVariable,this.SetVariesPerInstance()):(this.Get=this.GetInstanceVariable,this._isConstant=!0)}GetInstanceVariable(){return this._instVarIndex}GetFamilyInstanceVariable(t){t=t||0;const e=this._owner.GetObjectClass(),s=e.GetCurrentSol(),i=s.GetInstances();let r=null;if(i.length)r=i[t%i.length].GetObjectClass();else if(s.HasAnyElseInstances()){const e=s.GetElseInstances();r=e[t%e.length].GetObjectClass()}else{if(!(e.GetInstanceCount()>0))return 0;{const s=e.GetInstances();r=s[t%s.length].GetObjectClass()}}return this._instVarIndex+r.GetFamilyInstanceVariableOffset(e.GetFamilyIndex())}}class AS extends GS.Parameter{constructor(t,e,s,i){super(t,e,s),this._eventVarSid=i[1],this._eventVar=null,t.GetImplementationSdkVersion()>=2?this.Get=this.GetIEventVariable:this.Get=this.GetEventVariable,this._isConstant=!0}_PostInit(){this._eventVar=this.GetRuntime().GetEventSheetManager().GetEventVariableBySID(this._eventVarSid)}GetEventVariable(){return this._eventVar}GetIEventVariable(){return null}}class DS extends GS.Parameter{constructor(t,e,s,i){super(t,e,s),this._functionBlockName=i[1],this._functionBlock=null,t.GetImplementationSdkVersion()>=2?this.Get=this.GetIFunction:this.Get=this.GetFunction,this._isConstant=!0}_PostInit(){this._functionBlock=this.GetRuntime().GetEventSheetManager().GetFunctionBlockByName(this._functionBlockName),this._functionBlockName=null}GetFunction(){return this._functionBlock}GetIFunction(){return null}}class ES extends GS.Parameter{constructor(t,e,s,i){super(t,e,s),this._subParams=[],this._variadicRet=[],this._isConstant=!0;for(let t=1,e=i.length;t<e;++t){const e=GS.Parameter.Create(this._owner,i[t],0);this._subParams.push(e),this._variadicRet.push(0),e.IsConstant()||(this._isConstant=!1)}this.Get=this.GetVariadic}_PostInit(){for(const t of this._subParams)t._PostInit()}GetVariadic(){const t=this._subParams,e=this._variadicRet;for(let s=0,i=t.length;s<i;++s)e[s]=t[s].Get(0);return e}}class FS extends GS.Parameter{constructor(t,e,s,i){super(t,e,s),this._easeIndex=i[1],this.Get=this.GetEase,this._isConstant=!0}GetEase(){return this._easeIndex}}class OS extends GS.Parameter{constructor(t,e,s,i){super(t,e,s),this._brushIndex=i[1],this.Get=this.GetTilemapBrush,this._isConstant=!0}GetTilemapBrush(){return this._brushIndex}}class BS extends TS{constructor(t,e,s,i){super(t,e,s,i),this.Get=this.GetTemplateName,this._isConstant=!1}GetTemplateName(){return this._expressionFunc()}}class LS extends GS.Parameter{constructor(t,e,s,i){super(t,e,s),this._flowchartDataItem=this.GetRuntime().GetFlowchartManager().GetFlowchartDataItemByName(i[1]),this.Get=this.GetFlowchartName,this._isConstant=!0}GetFlowchartName(){return this._flowchartDataItem.GetName()}}}{let kS=function(t,e){for(let s=0,i=t.length;s<i;++s)e[s]=t[s].Get(0)};0;const NS=self.C3,US=(self.assert,[]),WS=function(){};NS.Condition=class extends NS.DefendedBase{constructor(t,e,s){if(super(),this._eventBlock=t,this._runtime=t.GetRuntime(),this._index=s,this._func=this._runtime.GetObjectReference(e[1]),this._isTrigger=e[3]>0,this._isFastTrigger=2===e[3],this._isLooping=!!e[4],this._isInverted=!!e[5],this._isStatic=!!e[6],this._sid=e[7],this._isInOrBlock=this._eventBlock.IsOrBlock(),this._objectClass=null,this._behaviorType=null,this._behaviorIndex=-1,this._systemPlugin=null,this.Run=WS,this.DebugRun=WS,this._parameters=[],this._results=[],this._anyParamVariesPerInstance=!1,this._savedData=null,this._unsavedData=null,this._debugData=this._runtime.IsDebug()?{isBreakpoint:e[8][0],canDebug:e[8][1]}:null,-1===e[0]?this._systemPlugin=this._runtime.GetSystemPlugin():(this._objectClass=this._runtime.GetObjectClassByIndex(e[0]),e[2]&&(this._behaviorType=this._objectClass.GetBehaviorTypeByName(e[2]),this._behaviorIndex=this._objectClass.GetBehaviorIndexByName(e[2])),this._eventBlock.GetParent()&&this._eventBlock.GetParent().SetSolWriterAfterCnds()),10===e.length){let t=e[9];for(let e of t)this._parameters.push(NS.Parameter.Create(this,e,this._parameters.length)),this._results.push(0)}0===this._parameters.length&&(this._parameters=US,this._results=US),this._eventBlock.GetEventSheetManager()._RegisterCondition(this)}static Create(t,e,s){return NS.New(NS.Condition,t,e,s)}_PostInit(){for(const t of this._parameters)t._PostInit(),t.VariesPerInstance()&&(this._anyParamVariesPerInstance=!0);this._isFastTrigger?(this.Run=this._RunFastTrigger,this.DebugRun=this._DebugRunFastTrigger):this._systemPlugin?(this._SetSystemRunMethod(),this.DebugRun=this._DebugRunSystem):this._objectClass.GetPlugin().IsSingleGlobal()?(this._SetSingleGlobalRunMethod(),this.DebugRun=this._DebugRunSingleGlobal):this._isStatic?(this.Run=this._RunStatic,this.DebugRun=this._DebugRunStatic):(this.Run=this._RunObject,this.DebugRun=this._DebugRunObject)}_SetSystemRunMethod(){const t=this._systemPlugin,e=this._systemPlugin;this._SetRunMethodForBoundFunc(t,e,this._RunSystem)}_SetSingleGlobalRunMethod(){const t=this._objectClass.GetPlugin(),e=this._objectClass.GetSingleGlobalInstance().GetSdkInstance();this._SetRunMethodForBoundFunc(t,e,this._RunSingleGlobal)}_SetRunMethodForBoundFunc(t,e,s){const i=this._func,r=this._isInverted,n=this._parameters;if(0===n.length){const s=t._GetBoundACEMethod(i,e);this.Run=r?function(){return NS.xor(s(),r)}:s}else if(1===n.length){const s=n[0];if(!r&&s.IsConstant())this.Run=t._GetBoundACEMethod_1param(i,e,s.Get(0));else{const n=t._GetBoundACEMethod(i,e);this.Run=function(){return NS.xor(n(s.Get(0)),r)}}}else if(2===n.length){const s=n[0],a=n[1];if(!r&&s.IsConstant()&&a.IsConstant())this.Run=t._GetBoundACEMethod_2params(i,e,s.Get(0),a.Get(0));else{const n=t._GetBoundACEMethod(i,e);this.Run=function(){return NS.xor(n(s.Get(0),a.Get(0)),r)}}}else if(3===n.length){const s=n[0],a=n[1],o=n[2];if(!r&&s.IsConstant()&&a.IsConstant()&&o.IsConstant())this.Run=t._GetBoundACEMethod_3params(i,e,s.Get(0),a.Get(0),o.Get(0));else{const n=t._GetBoundACEMethod(i,e);this.Run=function(){return NS.xor(n(s.Get(0),a.Get(0),o.Get(0)),r)}}}else this.Run=s}GetSID(){return this._sid}_GetFunc(){return this._func}GetObjectClass(){return this._objectClass}GetBehaviorType(){return this._behaviorType}GetImplementationAddon(){return this._behaviorType?this._behaviorType.GetBehavior():this._objectClass?this._objectClass.GetPlugin():null}GetImplementationSdkVersion(){const t=this.GetImplementationAddon();return t?t.GetSdkVersion():1}GetEventBlock(){return this._eventBlock}GetRuntime(){return this._runtime}GetIndex(){return this._index}GetDebugIndex(){return this.GetIndex()}IsTrigger(){return this._isTrigger}IsFastTrigger(){return this._isFastTrigger}IsInverted(){return this._isInverted}IsLooping(){return this._isLooping}IsStatic(){return this._isStatic}IsBreakpoint(){return this._debugData.isBreakpoint}IsSystemCondition(){return!!this._systemPlugin}IsSystemOrSingleGlobalCondition(){return this.IsSystemCondition()||this._objectClass.GetPlugin().IsSingleGlobal()}GetFirstObjectParameterObjectClass(){for(const t of this._parameters)if(t.IsObjectParameter())return t.GetObjectClass();return null}_SetBreakpoint(t){this._debugData.isBreakpoint=!!t,this._eventBlock._UpdateCanRunFastRecursive()}_DebugReturnsGenerator(){return this._debugData.canDebug}DebugCanRunFast(){return!this.IsBreakpoint()&&!this._runtime.DebugBreakNext()&&!this._DebugReturnsGenerator()}GetSavedDataMap(){return this._savedData||(this._savedData=new Map),this._savedData}GetUnsavedDataMap(){return this._unsavedData||(this._unsavedData=new Map),this._unsavedData}_RunSystem(){const t=this._results;return kS(this._parameters,t),NS.xor(this._func.apply(this._systemPlugin,t),this._isInverted)}*_DebugRunSystem(){if((this.IsBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),this._DebugReturnsGenerator()){const t=this._results;kS(this._parameters,t);let e=this._func.apply(this._systemPlugin,t);return NS.IsIterator(e)&&(e=yield*e),NS.xor(e,this._isInverted)}return this.Run()}_RunSingleGlobal(){const t=this._results;kS(this._parameters,t);const e=this._objectClass.GetSingleGlobalInstance().GetSdkInstance();return NS.xor(this._func.apply(e,t),this._isInverted)}*_DebugRunSingleGlobal(){if((this.IsBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),this._DebugReturnsGenerator()){const t=this._results;kS(this._parameters,t);const e=this._objectClass.GetSingleGlobalInstance().GetSdkInstance();let s=this._func.apply(e,t);return NS.IsIterator(s)&&(s=yield*s),NS.xor(s,this._isInverted)}return this.Run()}_RunFastTrigger(){return!0}*_DebugRunFastTrigger(){return(this.IsBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),!0}_GetStaticConditionThis(){return this._behaviorType?this._behaviorType.GetBehavior().GetSdkVersion()>=2?this._behaviorType.GetIBehaviorType():this._behaviorType:this._objectClass.GetPlugin().GetSdkVersion()>=2?this._objectClass.GetIObjectClass():this._objectClass}_RunStatic(){const t=this._results;kS(this._parameters,t);const e=this._func.apply(this._GetStaticConditionThis(),t);return this._objectClass.ApplySolToContainer(),e}*_DebugRunStatic(){if((this.IsBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),this._DebugReturnsGenerator()){const t=this._results;kS(this._parameters,t);let e=this._func.apply(this._GetStaticConditionThis(),t);return NS.IsIterator(e)&&(e=yield*e),this._objectClass.ApplySolToContainer(),e}return this.Run()}_RunObject(){const t=this._parameters,e=this._results,s=this._objectClass.GetCurrentSol();for(let s=0,i=t.length;s<i;++s){const i=t[s];i.VariesPerInstance()||(e[s]=i.Get(0))}return s.IsSelectAll()?this._RunObject_FirstFilter(s):this._RunObject_NextFilter(s)}*_DebugRunObject(){return(this.IsBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),this._RunObject()}_EvaluateVaryingParameters(t){const e=this._parameters,s=this._results;for(let i=0,r=e.length;i<r;++i){const r=e[i];r.VariesPerInstance()&&(s[i]=r.Get(t))}}_RunObject_FirstFilter(t){const e=this._objectClass,s=e.IsFamily(),i=e.GetFamilyIndex(),r=this._behaviorIndex,n=r>=0,a=e.GetInstances(),o=this._anyParamVariesPerInstance,h=this._results,l=this._func,c=this._isInverted,u=this._isInOrBlock&&!this._isTrigger;t.ClearArrays();for(let e=0,_=a.length;e<_;++e){const _=a[e];let d;if(o&&this._EvaluateVaryingParameters(e),n){const t=s?_.GetObjectClass().GetFamilyBehaviorOffset(i):0;d=l.apply(_.GetBehaviorInstances()[r+t].GetSdkInstance(),h)}else d=l.apply(_.GetSdkInstance(),h);NS.xor(d,c)?t._PushInstance(_):u&&t._PushElseInstance(_)}return e.FinishCondition(!0),t._SetSelectAll(!1),e.ApplySolToContainer(),t.HasAnyInstances()}_RunObject_NextFilter(t){const e=this._objectClass,s=e.IsFamily(),i=e.GetFamilyIndex(),r=e.IsInContainer(),n=this._behaviorIndex,a=n>=0,o=this._anyParamVariesPerInstance,h=this._results,l=this._func,c=this._isInverted,u=this._isInOrBlock&&!this._isTrigger,_=t._GetOwnInstances(),d=t._GetOwnElseInstances(),p=u&&!this._eventBlock.IsFirstConditionOfType(this),f=p?d:_;let g=0,m=!1;for(let t=0,e=f.length;t<e;++t){const e=f[t];let S;if(o&&this._EvaluateVaryingParameters(t),a){const t=s?e.GetObjectClass().GetFamilyBehaviorOffset(i):0;S=l.apply(e.GetBehaviorInstances()[n+t].GetSdkInstance(),h)}else S=l.apply(e.GetSdkInstance(),h);NS.xor(S,c)?(m=!0,p?(_.push(e),r&&e._PushSiblingsToSolInstances()):(f[g]=e,r&&e._SetSiblingsToSolInstancesIndex(g),++g)):p?(f[g]=e,r&&e._SetSiblingsToSolElseInstancesIndex(g),++g):u&&(d.push(e),r&&e._PushSiblingsToSolElseInstances())}NS.truncateArray(f,g),r&&e._TruncateContainerSols(p,g);const S=m;return p&&!m&&(m=this._OrBlockCheckInstances(_)),e.FinishCondition(S||u),u?m:t.HasAnyInstances()}_OrBlockCheckInstances(t){const e=this._objectClass,s=e.IsFamily(),i=e.GetFamilyIndex(),r=this._anyParamVariesPerInstance,n=this._behaviorIndex,a=n>=0,o=this._results,h=this._func,l=this._isInverted;for(let e=0,c=t.length;e<c;++e){const c=t[e];let u;if(r&&this._EvaluateVaryingParameters(e),a){const t=s?c.GetObjectClass().GetFamilyBehaviorOffset(i):0;u=h.apply(c.GetBehaviorInstances()[n+t].GetSdkInstance(),o)}else u=h.apply(c.GetSdkInstance(),o);if(NS.xor(u,l))return!0}return!1}ReevaluateParameter(t,e){return this._parameters[t].Get(e)}GetFastTriggerValue(){const t=this._parameters;if(!t.length)throw new Error("no parameters");return t[0]._GetFastTriggerValue()}_SaveToJson(){if(!this._savedData||!this._savedData.size)return null;const t={};for(const[e,s]of this._savedData.entries()){let i=s;"collmemory"===e&&(i=[...s.entries()].map(t=>[t[0].GetUID(),t[1].GetUID(),t[2]])),t[e]=i}return{ex:t}}_LoadFromJson(t){if(this._savedData&&(this._savedData.clear(),this._savedData=null),!t)return;const e=this._runtime,s=t.ex;if(s){const t=this.GetSavedDataMap();t.clear();for(const[i,r]of Object.entries(s)){let s=r;"collmemory"===i&&(s=NS.New(NS.PairMap,r.map(t=>[e.GetInstanceByUID(t[0]),e.GetInstanceByUID(t[1]),t[2]]).filter(t=>t[0]&&t[1]))),t.set(i,s)}}}}}{let jS=function(t,e){for(let s=0,i=t.length;s<i;++s)e[s]=t[s].Get(0)};0;const VS=self.C3,zS=(self.assert,[]),HS=function(){},YS=function*(){};VS.Action=class extends VS.DefendedBase{constructor(t,e,s){super(),this._eventBlock=t;const i=t.GetRuntime();this._runtime=i,this._index=s,this._sid=e.length>=4?e[3]:-1,this._actionType=e.length>=5?255&e[4]:0,this._flags=e.length>=5?e[4]>>8:0,this._func=null,this._objectClass=null,this._behaviorType=null,this._behaviorIndex=-1,this._systemPlugin=null,this._callFunctionName="",this._callCustomAceObjectClass=null,this._callEventBlock=null,this.Run=HS,this.DebugRun=HS,this._parameters=[],this._results=[],this._anyParamVariesPerInstance=!1;const r=-3===e[0],n=r?e[2]:e[5];if(this._debugData=i.IsDebug()||r?{isBreakpoint:n[0],canDebug:n[1],index:n[2]}:null,-1===e[0])this._systemPlugin=i.GetSystemPlugin(),this._func=i.GetObjectReference(e[1]);else if(-2===e[0])this._callFunctionName=e[1];else if(r){const t=i.GetObjectReference(e[1]);this._func=t,this.Run=this.RunUserScript,this.DebugRun=this.DebugRunUserScript,this._flags|=8}else this._objectClass=i.GetObjectClassByIndex(e[0]),4&this._flags?(this._callFunctionName=e[1],this._callCustomAceObjectClass=i.GetObjectClassByIndex(e[2])):(e[2]&&(this._behaviorType=this._objectClass.GetBehaviorTypeByName(e[2]),this._behaviorIndex=this._objectClass.GetBehaviorIndexByName(e[2])),this._func=i.GetObjectReference(e[1]));if(7===e.length){const t=e[6];for(const e of t)this._parameters.push(VS.Parameter.Create(this,e,this._parameters.length)),this._results.push(0)}0===this._parameters.length&&(this._parameters=zS,this._results=zS),this.CanPickAnyObjectClass()&&(this._eventBlock.SetAllSolModifiers(),this._eventBlock.SetSolWriterAfterCnds()),this._eventBlock.GetEventSheetManager()._RegisterAction(this)}static Create(t,e,s){return VS.New(VS.Action,t,e,s)}_PostInit(){for(const t of this._parameters)t._PostInit(),t.VariesPerInstance()&&(this._anyParamVariesPerInstance=!0);if(this._systemPlugin)this._SetSystemRunMethod(),this.DebugRun=this._DebugRunSystem;else if(this._callFunctionName)4&this._flags?this._SetCallCustomActionRunMethod():this._SetCallFunctionRunMethod(),this._callFunctionName="",this._callCustomAceObjectClass=null;else if(this.Run===this.RunUserScript){const t=this._func,e=this._runtime.GetEventSheetManager()._GetLocalVariablesScriptInterface(this._eventBlock);this._func=t.bind(null,this._runtime.GetIRuntime(),e)}else this._behaviorType?this.IsAsync()?(this.Run=this._RunBehavior_Async,this.DebugRun=this._DebugRunBehavior_Async):(this.Run=this._RunBehavior,this.DebugRun=this._DebugRunBehavior):this._objectClass.GetPlugin().IsSingleGlobal()?(this._SetSingleGlobalRunMethod(),this.DebugRun=this._DebugRunSingleGlobal):this.IsStatic()?(this.Run=this._RunObject_Static,this.DebugRun=this._DebugRunObject_Static):this.IsAsync()?(this.Run=this._RunObject_Async,this.DebugRun=this._DebugRunObject_Async):this.CallBeforeAfterHooks()?(this.Run=this._RunObject_BeforeAfterHooks,this.DebugRun=this._DebugRunObject_BeforeAfterHooks):this._parameters.length?this._parameters.every(t=>t.VariesPerInstance())?(this.Run=this._RunObject_AllParamsVary,this.DebugRun=this._DebugRunObject_AllParamsVary):this._anyParamVariesPerInstance?(this.Run=this._RunObject_SomeParamsVary,this.DebugRun=this._DebugRunObject_SomeParamsVary):this._parameters.every(t=>t.IsConstant())?(jS(this._parameters,this._results),this.Run=this._RunObject_ParamsConst,this.DebugRun=this._DebugRunObject_ParamsConst):(this.Run=this._RunObject_ParamsDontVary,this.DebugRun=this._DebugRunObject_ParamsDontVary):(this.Run=this._RunObject_ParamsConst,this.DebugRun=this._DebugRunObject_ParamsConst)}_SetSystemRunMethod(){const t=this._systemPlugin,e=this._systemPlugin;this._SetRunMethodForBoundFunc(t,e,this._RunSystem)}_SetSingleGlobalRunMethod(){const t=this._objectClass.GetPlugin(),e=this._objectClass.GetSingleGlobalInstance().GetSdkInstance();this._SetRunMethodForBoundFunc(t,e,this._RunSingleGlobal)}_SetCallFunctionRunMethod(){const t=this._eventBlock.GetEventSheetManager(),e=t.GetFunctionBlockByName(this._callFunctionName);if(e.IsEnabled()){const s=!!(2&this._flags);this._callEventBlock=e.GetEventBlock();let i=[...new Set([...this._eventBlock.GetSolModifiersIncludingParents(),...this._callEventBlock.GetSolModifiersIncludingParents()])];i=t._DeduplicateSolModifierList(i);const r=!e.IsCopyPicked()&&this._HasCopyPickedParent()?{pushCleanSolDynamic:!0}:null;if(this.Run=VS.EventBlock.prototype.RunAsFunctionCall.bind(this._callEventBlock,i,this._parameters,s,r),this._runtime.IsDebug()){const t=this;this.DebugRun=function*(){return(t.IsBreakpoint()||t._runtime.DebugBreakNext())&&(yield t),yield*t._callEventBlock.DebugRunAsFunctionCall(i,t._parameters,s,r)}}else this.DebugRun=YS}else this.Run=HS,this.DebugRun=YS}_SetCallCustomActionRunMethod(){const t=this._eventBlock.GetEventSheetManager(),e=t.GetCustomActionBlockByName(this._callCustomAceObjectClass,this._callFunctionName);if(e.IsEnabled()){const s=!!(2&this._flags);this._callEventBlock=e.GetEventBlock();let i=[...new Set([...this._eventBlock.GetSolModifiersIncludingParents(),...this._callEventBlock.GetSolModifiersIncludingParents(),this._objectClass,e.GetObjectClass()])];i=t._DeduplicateSolModifierList(i);const r=!this._objectClass.IsFamily()&&!e.GetObjectClass().IsFamily(),n=!this._objectClass.IsFamily()&&e.GetObjectClass().IsFamily(),a=this._objectClass.IsFamily();let o=null;if(!e.IsCopyPicked()&&this._HasCopyPickedParent()&&(o=o||{},o.pushCleanSolDynamic=!0),!n&&s||(o=o||{},o.copyFromObjectClass=this._objectClass,o.copyToObjectClass=e.GetObjectClass()),r||n||a&&!e.HasCustomACEOverrides()?this.Run=VS.EventBlock.prototype.RunAsFunctionCall.bind(this._callEventBlock,i,this._parameters,s,o):a&&(this.Run=VS.FunctionBlock.prototype.RunAsFamilyCustomActionWithOverrides.bind(e,i,this._parameters)),this._runtime.IsDebug()){const t=this;r||n||a&&!e.HasCustomACEOverrides()?this.DebugRun=function*(){return(t.IsBreakpoint()||t._runtime.DebugBreakNext())&&(yield t),yield*t._callEventBlock.DebugRunAsFunctionCall(i,t._parameters,s,o)}:a&&(this.DebugRun=function*(){return(t.IsBreakpoint()||t._runtime.DebugBreakNext())&&(yield t),yield*e.DebugRunAsFamilyCustomActionWithOverrides(i,t._parameters)})}else this.DebugRun=YS}else this.Run=HS,this.DebugRun=YS}_SetRunMethodForBoundFunc(t,e,s){const i=this._func,r=this._parameters;if(0===r.length)this.Run=t._GetBoundACEMethod(i,e);else if(1===r.length){const s=r[0];if(s.IsConstant())this.Run=t._GetBoundACEMethod_1param(i,e,s.Get(0));else{const r=t._GetBoundACEMethod(i,e);this.Run=function(){return r(s.Get(0))}}}else if(2===r.length){const s=r[0],n=r[1];if(s.IsConstant()&&n.IsConstant())this.Run=t._GetBoundACEMethod_2params(i,e,s.Get(0),n.Get(0));else{const r=t._GetBoundACEMethod(i,e);this.Run=function(){return r(s.Get(0),n.Get(0))}}}else if(3===r.length){const s=r[0],n=r[1],a=r[2];if(s.IsConstant()&&n.IsConstant()&&a.IsConstant())this.Run=t._GetBoundACEMethod_3params(i,e,s.Get(0),n.Get(0),a.Get(0));else{const r=t._GetBoundACEMethod(i,e);this.Run=function(){return r(s.Get(0),n.Get(0),a.Get(0))}}}else this.Run=s}GetSID(){return this._sid}IsAsync(){return!!(8&this._flags)}CanBailOut(){return!!(16&this._flags)}CallBeforeAfterHooks(){return 1===this._actionType}IsStatic(){return 2===this._actionType}CanPickAnyObjectClass(){return!!(1&this._flags)}HasReturnType(){return this.IsAsync()||this.CanBailOut()}GetObjectClass(){return this._objectClass}GetImplementationAddon(){return this._behaviorType?this._behaviorType.GetBehavior():this._objectClass?this._objectClass.GetPlugin():null}GetImplementationSdkVersion(){const t=this.GetImplementationAddon();return t?t.GetSdkVersion():1}GetEventBlock(){return this._eventBlock}_HasCopyPickedParent(){let t=this._eventBlock;do{if(t instanceof VS.FunctionBlock&&t.IsCopyPicked())return!0;t=t.GetScopeParent()}while(t);return!1}GetRuntime(){return this._runtime}GetIndex(){return this._index}GetDebugIndex(){return this._debugData.index}IsBreakpoint(){return this._debugData.isBreakpoint}_SetBreakpoint(t){this._debugData.isBreakpoint=!!t,this._eventBlock._UpdateCanRunFastRecursive()}_DebugReturnsGenerator(){return this._debugData.canDebug}DebugCanRunFast(){return!this.IsBreakpoint()&&!this._runtime.DebugBreakNext()&&!this._DebugReturnsGenerator()}_RunSystem(){const t=this._results;return jS(this._parameters,t),this._func.apply(this._systemPlugin,t)}*_DebugRunSystem(){if((this.IsBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),this._DebugReturnsGenerator()){const t=this._results;return jS(this._parameters,t),yield*this._func.apply(this._systemPlugin,t)}return this.Run()}_RunSingleGlobal(){const t=this._results;return jS(this._parameters,t),this._func.apply(this._objectClass.GetSingleGlobalInstance().GetSdkInstance(),t)}*_DebugRunSingleGlobal(){if((this.IsBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),this._DebugReturnsGenerator()){const t=this._results;return jS(this._parameters,t),yield*this._func.apply(this._objectClass.GetSingleGlobalInstance().GetSdkInstance(),t)}return this.Run()}_RunObject_ParamsConst(){const t=this._results,e=this._objectClass.GetCurrentSol().GetInstances();for(let s=0,i=e.length;s<i;++s)this._func.apply(e[s].GetSdkInstance(),t)}*_DebugRunObject_ParamsConst(){if((this.IsBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),this._DebugReturnsGenerator()){const t=this._results,e=this._objectClass.GetCurrentSol().GetInstances();for(let s=0,i=e.length;s<i;++s)yield*this._func.apply(e[s].GetSdkInstance(),t)}else this._RunObject_ParamsConst()}_RunObject_ParamsDontVary(){const t=this._results;jS(this._parameters,t);const e=this._objectClass.GetCurrentSol().GetInstances();for(let s=0,i=e.length;s<i;++s)this._func.apply(e[s].GetSdkInstance(),t)}*_DebugRunObject_ParamsDontVary(){if((this.IsBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),this._DebugReturnsGenerator()){const t=this._results;jS(this._parameters,t);const e=this._objectClass.GetCurrentSol().GetInstances();for(let s=0,i=e.length;s<i;++s)yield*this._func.apply(e[s].GetSdkInstance(),t)}else this._RunObject_ParamsDontVary()}_RunObject_AllParamsVary(){const t=this._parameters,e=this._results,s=this._func,i=this._objectClass.GetCurrentSol().GetInstances();for(let r=0,n=i.length;r<n;++r){const n=i[r];for(let s=0,i=t.length;s<i;++s)e[s]=t[s].Get(r);s.apply(n.GetSdkInstance(),e)}}*_DebugRunObject_AllParamsVary(){if((this.IsBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),this._DebugReturnsGenerator()){const t=this._parameters,e=this._results,s=this._func,i=this._objectClass.GetCurrentSol().GetInstances();for(let r=0,n=i.length;r<n;++r){const n=i[r];for(let s=0,i=t.length;s<i;++s)e[s]=t[s].Get(r);yield*s.apply(n.GetSdkInstance(),e)}}else this._RunObject_AllParamsVary()}_RunObject_SomeParamsVary(){const t=this._parameters,e=this._results,s=this._func,i=this._objectClass.GetCurrentSol().GetInstances();for(let s=0,i=t.length;s<i;++s){const i=t[s];i.VariesPerInstance()||(e[s]=i.Get(0))}for(let r=0,n=i.length;r<n;++r){const n=i[r];for(let s=0,i=t.length;s<i;++s){const i=t[s];i.VariesPerInstance()&&(e[s]=i.Get(r))}s.apply(n.GetSdkInstance(),e)}}*_DebugRunObject_SomeParamsVary(){if((this.IsBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),this._DebugReturnsGenerator()){const t=this._parameters,e=this._results,s=this._func,i=this._objectClass.GetCurrentSol().GetInstances();for(let s=0,i=t.length;s<i;++s){const i=t[s];i.VariesPerInstance()||(e[s]=i.Get(0))}for(let r=0,n=i.length;r<n;++r){const n=i[r];for(let s=0,i=t.length;s<i;++s){const i=t[s];i.VariesPerInstance()&&(e[s]=i.Get(r))}yield*s.apply(n.GetSdkInstance(),e)}}else this._RunObject_SomeParamsVary()}_RunObject_BeforeAfterHooks(){const t=this._parameters,e=this._results,s=this._func,i=this._objectClass,r=i.GetSdkType(),n=i.GetCurrentSol().GetInstances();r.BeforeRunAction(s);for(let i=0,r=n.length;i<r;++i){const r=n[i];for(let s=0,r=t.length;s<r;++s)e[s]=t[s].Get(i);s.apply(r.GetSdkInstance(),e)}r.AfterRunAction(s)}*_DebugRunObject_BeforeAfterHooks(){if((this.IsBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),this._DebugReturnsGenerator()){const t=this._parameters,e=this._results,s=this._func,i=this._objectClass,r=i.GetSdkType(),n=i.GetCurrentSol().GetInstances();r.BeforeRunAction(s);for(let i=0,r=n.length;i<r;++i){const r=n[i];for(let s=0,r=t.length;s<r;++s)e[s]=t[s].Get(i);yield*s.apply(r.GetSdkInstance(),e)}r.AfterRunAction(s)}else this._RunObject_BeforeAfterHooks()}_GetStaticActionThis(){return this._behaviorType?this._behaviorType.GetBehavior().GetSdkVersion()>=2?this._behaviorType.GetIBehaviorType():this._behaviorType:this._objectClass.GetPlugin().GetSdkVersion()>=2?this._objectClass.GetIObjectClass():this._objectClass}_RunObject_Static(){const t=this._results;return jS(this._parameters,t),this._func.apply(this._GetStaticActionThis(),t)}*_DebugRunObject_Static(){if((this.IsBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),this._DebugReturnsGenerator()){const t=this._results;jS(this._parameters,t);let e=this._func.apply(this._GetStaticActionThis(),t);return VS.IsIterator(e)&&(e=yield*e),e}return this._RunObject_Static()}_RunBehavior(){const t=this._objectClass,e=t.IsFamily(),s=t.GetFamilyIndex(),i=this._parameters,r=this._anyParamVariesPerInstance,n=this._results,a=this._func,o=this._behaviorIndex,h=t.GetCurrentSol().GetInstances();for(let t=0,e=i.length;t<e;++t){const e=i[t];e.VariesPerInstance()||(n[t]=e.Get(0))}for(let t=0,l=h.length;t<l;++t){const l=h[t];if(r)for(let e=0,s=i.length;e<s;++e){const s=i[e];s.VariesPerInstance()&&(n[e]=s.Get(t))}const c=e?l.GetObjectClass().GetFamilyBehaviorOffset(s):0;a.apply(l.GetBehaviorInstances()[o+c].GetSdkInstance(),n)}}*_DebugRunBehavior(){if((this.IsBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),this._DebugReturnsGenerator()){const t=this._objectClass,e=t.IsFamily(),s=t.GetFamilyIndex(),i=this._parameters,r=this._anyParamVariesPerInstance,n=this._results,a=this._func,o=this._behaviorIndex,h=t.GetCurrentSol().GetInstances();for(let t=0,e=i.length;t<e;++t){const e=i[t];e.VariesPerInstance()||(n[t]=e.Get(0))}for(let t=0,l=h.length;t<l;++t){const l=h[t];if(r)for(let e=0,s=i.length;e<s;++e){const s=i[e];s.VariesPerInstance()&&(n[e]=s.Get(t))}const c=e?l.GetObjectClass().GetFamilyBehaviorOffset(s):0;yield*a.apply(l.GetBehaviorInstances()[o+c].GetSdkInstance(),n)}}else this._RunBehavior()}_RunObject_Async(){const t=this._parameters,e=this._results,s=this._func,i=this._objectClass.GetCurrentSol().GetInstances(),r=[];for(let n=0,a=i.length;n<a;++n){const a=i[n];for(let s=0,i=t.length;s<i;++s)e[s]=t[s].Get(n);r.push(s.apply(a.GetSdkInstance(),e))}return Promise.all(r)}*_DebugRunObject_Async(){if((this.IsBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),this._DebugReturnsGenerator()){const t=this._parameters,e=this._results,s=this._func,i=this._objectClass.GetCurrentSol().GetInstances(),r=[];for(let n=0,a=i.length;n<a;++n){const a=i[n];for(let s=0,i=t.length;s<i;++s)e[s]=t[s].Get(n);r.push(yield*s.apply(a.GetSdkInstance(),e))}return Promise.all(r)}return this._RunObject_Async()}_RunBehavior_Async(){const t=this._objectClass,e=t.IsFamily(),s=t.GetFamilyIndex(),i=this._parameters,r=this._results,n=this._func,a=this._behaviorIndex,o=t.GetCurrentSol().GetInstances(),h=[];for(let t=0,l=o.length;t<l;++t){const l=o[t];for(let e=0,s=i.length;e<s;++e)r[e]=i[e].Get(t);const c=e?l.GetObjectClass().GetFamilyBehaviorOffset(s):0;h.push(n.apply(l.GetBehaviorInstances()[a+c].GetSdkInstance(),r))}return Promise.all(h)}*_DebugRunBehavior_Async(){if((this.IsBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),this._DebugReturnsGenerator()){const t=this._objectClass,e=t.IsFamily(),s=t.GetFamilyIndex(),i=this._parameters,r=this._results,n=this._func,a=this._behaviorIndex,o=t.GetCurrentSol().GetInstances(),h=[];for(let t=0,l=o.length;t<l;++t){const l=o[t];for(let e=0,s=i.length;e<s;++e)r[e]=i[e].Get(t);const c=e?l.GetObjectClass().GetFamilyBehaviorOffset(s):0;h.push(yield*n.apply(l.GetBehaviorInstances()[a+c].GetSdkInstance(),r))}return Promise.all(h)}return this._RunBehavior_Async()}async RunUserScript(){try{await this._func()}catch(t){console.error(`Unhandled exception running script %c${this._eventBlock.GetEventSheet().GetName()}, event ${this._eventBlock.GetDisplayNumber()}, action ${this.GetDebugIndex()+1}:`,"font-size: 1.2em; font-weight: bold;",t),self.C3Debugger&&self.C3Debugger._SetLastErrorScript(this),VS.EventScript.HadUserScriptException()||(console.info("%cTip:%c run this to highlight in Construct the last script that had an error: %cgoToLastErrorScript()","font-weight: bold; text-decoration: underline","","font-weight: bold"),VS.EventScript.SetHadUserScriptException())}}*DebugRunUserScript(){return(this.IsBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),this.RunUserScript()}_SaveToJson(){return this._savedData&&this._savedData.size?{ex:VS.ToSuperJSON(this._savedData)}:null}_LoadFromJson(t){if(this._savedData&&(this._savedData.clear(),this._savedData=null),!t)return;const e=t.ex;e&&(this._savedData=VS.FromSuperJSON(e))}}}{let XS=function(t){return t instanceof py?dy._UnwrapScriptInterface(t):t.GetInstance()},qS=function(t){return XS(t).GetWorldInfo()},JS=function(t){return dy._UnwrapScriptInterface(t)},QS=function(t){return JS(t).GetWorldInfo()},KS=function(t){return t instanceof fy?dy._UnwrapScriptInterface(t):t},ZS=function(t){return t instanceof gy?dy._UnwrapScriptInterface(t):t},$S=function(t,e,s,i){e.GetUID()<s.GetUID()?t.Set(e,s,i):t.Set(s,e,i)},ty=function(t,e,s){e.GetUID()<s.GetUID()?t.Delete(e,s):t.Delete(s,e)},ey=function(t,e){t.DeleteEither(e)},sy=function(t,e,s){return e.GetUID()<s.GetUID()?t.Get(e,s):t.Get(s,e)},iy=function(t,e,s,i){if(!e)return!1;const r=0!==s||0!==i,n=t.GetWorldInfo(),a=dy.GetCollisionEngine(),o=dy.GetCurrentCondition(),h=o.GetEventBlock().IsOrBlock(),l=o.GetObjectClass(),c=o.IsInverted(),u=e.GetCurrentSol(),_=l!==e;let d;Ty=e,Gy=_&&!c,Iy=!1;let p=0,f=0,g=!1;u.IsSelectAll()?(my.copy(n.GetBoundingBox()),my.offset(s,i),a.GetCollisionCandidates(n.GetLayer(),e,my,yy),d=yy):h?dy.IsCurrentConditionFirst()&&!u._GetOwnElseInstances().length&&u._GetOwnInstances().length?d=u._GetOwnInstances():(d=u._GetOwnElseInstances(),Iy=!0):d=u._GetOwnInstances(),r&&(p=n.GetX(),f=n.GetY(),n.OffsetXY(s,i),n.SetBboxChanged());for(const e of d)if(a.TestOverlap(t,e)){if(g=!0,c)break;_&&Cy.add(e)}return r&&(n.SetXY(p,f),n.SetBboxChanged()),hy.clearArray(yy),g},ry=function(t){const e=dy.GetCurrentEvent().IsOrBlock(),s=Ty.GetCurrentSol(),i=s._GetOwnInstances(),r=s._GetOwnElseInstances();s.IsSelectAll()?(s.SetSetPicked(Cy),e&&(hy.clearArray(r),s.AddElseInstances(Cy,Ty.GetInstances()))):e?Iy?s.TransferElseInstancesToOwn(Cy):(s.AddElseInstances(Cy,i),s.SetSetPicked(Cy)):s.SetSetPicked(Cy),Ty.ApplySolToContainer()},ny=function(t,e){Gy&&(e&&ry(t),Cy.clear(),Ty=null,Gy=!1)},ay=function(t,e){const s=dy.GetInstanceByUID(e);if(!s)return!1;const i=t.GetCurrentSol();if(!i.IsSelectAll()&&!i._GetOwnInstances().includes(s))return!1;if(t.IsFamily()){if(s.GetObjectClass().BelongsToFamily(t))return i.PickOne(s),t.ApplySolToContainer(),!0}else if(s.GetObjectClass()===t)return i.PickOne(s),t.ApplySolToContainer(),!0;return!1},oy=function(t,e){const s=t.GetCurrentSol();if(s.IsSelectAll()){s._SetSelectAll(!1),s.ClearArrays();const i=t.GetInstances();for(let t=0,r=i.length;t<r;++t){const r=i[t];r.GetUID()===e?s._PushElseInstance(r):s._PushInstance(r)}return t.ApplySolToContainer(),!!s._GetOwnInstances().length}{const i=s._GetOwnInstances();let r=0;for(let t=0,n=i.length;t<n;++t){const n=i[t];i[r]=n,n.GetUID()===e?s._PushElseInstance(n):++r}return hy.truncateArray(i,r),t.ApplySolToContainer(),!!i.length}};0;const hy=self.C3,ly=new hy.Color,cy={},uy={},_y={};let dy=null;hy.CommonACES_SetRuntime=function(t){dy=t};const py=self.IInstance,fy=self.IObjectClass,gy=self.ILayer;uy.CompareX=function(t,e){return hy.compare(this.GetWorldInfo().GetX(),t,e)},_y.CompareX=function(t,e){return hy.compare(this.x,t,e)},uy.CompareY=function(t,e){return hy.compare(this.GetWorldInfo().GetY(),t,e)},_y.CompareY=function(t,e){return hy.compare(this.y,t,e)},uy.IsOnScreen=function(){return this.GetWorldInfo().IsInViewport2()},_y.IsOnScreen=function(){return this.isOnScreen()},cy.IsOutsideLayout=function(){const t=qS(this),e=t.GetLayout(),s=t.GetBoundingBox();return s.getRight()<0||s.getBottom()<0||s.getLeft()>e.GetWidth()||s.getTop()>e.GetHeight()},cy.PickDistance=function(t,e,s){const i=KS(this).GetCurrentSol(),r=i.GetInstances();if(!r.length)return!1;let n=r[0],a=n.GetWorldInfo(),o=n,h=hy.distanceSquared(a.GetX(),a.GetY(),e,s);for(let i=1,l=r.length;i<l;++i){n=r[i],a=n.GetWorldInfo();const l=hy.distanceSquared(a.GetX(),a.GetY(),e,s);(0===t&&l<h||1===t&&l>h)&&(h=l,o=n)}return i.PickOne(o),!0},uy.SetX=function(t){const e=this.GetWorldInfo();e.GetX()!==t&&(e.SetX(t),e.SetBboxChanged())},_y.SetX=function(t){this.x=+t},uy.SetY=function(t){const e=this.GetWorldInfo();e.GetY()!==t&&(e.SetY(t),e.SetBboxChanged())},_y.SetY=function(t){this.y=+t},uy.SetPos=function(t,e){const s=this.GetWorldInfo();s.EqualsXY(t,e)||(s.SetXY(t,e),s.SetBboxChanged())},_y.SetPos=function(t,e){this.setPosition(t,e)},cy.SetPosToObject=function(t,e){if(!(t=KS(t)))return;const s=XS(this),i=t.GetPairedInstance(s);if(!i)return;const[r,n]=i.GetImagePoint(e),a=s.GetWorldInfo();a.GetX()===r&&a.GetY()===n||(a.SetXY(r,n),a.SetBboxChanged())},cy.MoveForward=function(t){if(0===t)return;const e=qS(this);e.OffsetXY(e.GetCosAngle()*t,e.GetSinAngle()*t),e.SetBboxChanged()},uy.MoveAtAngle=function(t,e){if(0===e)return;const s=this.GetWorldInfo();t=hy.toRadians(t),s.OffsetXY(Math.cos(t)*e,Math.sin(t)*e),s.SetBboxChanged()},_y.MoveAtAngle=function(t,e){0!==e&&(t=hy.toRadians(t),this.offsetPosition(Math.cos(t)*e,Math.sin(t)*e))},uy.GetX=function(){return this.GetWorldInfo().GetX()},_y.GetX=function(){return this.x},uy.GetY=function(){return this.GetWorldInfo().GetY()},_y.GetY=function(){return this.y},cy.GetDt=function(){return dy.GetDt(XS(this))},uy.CompareWidth=function(t,e){return hy.compare(this.GetWorldInfo().GetWidth(),t,e)},_y.CompareWidth=function(t,e){return hy.compare(this.width,t,e)},uy.CompareHeight=function(t,e){return hy.compare(this.GetWorldInfo().GetHeight(),t,e)},_y.CompareHeight=function(t,e){return hy.compare(this.height,t,e)},uy.SetWidth=function(t){const e=this.GetWorldInfo();e.GetWidth()!==t&&(e.SetWidth(t),e.SetBboxChanged())},_y.SetWidth=function(t){this.width=t},uy.SetHeight=function(t){const e=this.GetWorldInfo();e.GetHeight()!==t&&(e.SetHeight(t),e.SetBboxChanged())},_y.SetHeight=function(t){this.height=t},uy.SetSize=function(t,e){const s=qS(this);s.GetWidth()===t&&s.GetHeight()===e||(s.SetSize(t,e),s.SetBboxChanged())},_y.SetSize=function(t,e){this.setSize(t,e)},uy.GetWidth=function(){return this.GetWorldInfo().GetWidth()},_y.GetWidth=function(){return this.width},uy.GetHeight=function(){return this.GetWorldInfo().GetHeight()},_y.GetHeight=function(){return this.height},cy.GetBboxLeft=function(){return qS(this).GetBoundingBox().getLeft()},cy.GetBboxTop=function(){return qS(this).GetBoundingBox().getTop()},cy.GetBboxRight=function(){return qS(this).GetBoundingBox().getRight()},cy.GetBboxBottom=function(){return qS(this).GetBoundingBox().getBottom()},cy.GetBboxMidX=function(){const t=qS(this).GetBoundingBox();return(t.getLeft()+t.getRight())/2},cy.GetBboxMidY=function(){const t=qS(this).GetBoundingBox();return(t.getTop()+t.getBottom())/2},cy.IsAngleWithin=function(t,e){return hy.angleDiff(qS(this).GetAngle(),hy.toRadians(e))<=hy.toRadians(t)},cy.IsAngleClockwiseFrom=function(t){return hy.angleClockwise(qS(this).GetAngle(),hy.toRadians(t))},cy.IsBetweenAngles=function(t,e){const s=hy.toRadians(t),i=hy.toRadians(e),r=qS(this).GetAngle();return hy.angleClockwise(i,s)?hy.angleClockwise(r,s)&&!hy.angleClockwise(r,i):!(!hy.angleClockwise(r,s)&&hy.angleClockwise(r,i))},uy.SetAngle=function(t){const e=this.GetWorldInfo(),s=hy.clampAngle(hy.toRadians(t));isNaN(s)||e.GetAngle()===s||(e.SetAngle(s),e.SetBboxChanged())},_y.SetAngle=function(t){this.angleDegrees=t},cy.RotateClockwise=function(t){if(isNaN(t)||0===t)return;const e=qS(this);e.SetAngle(e.GetAngle()+hy.toRadians(t)),e.SetBboxChanged()},cy.RotateCounterclockwise=function(t){if(isNaN(t)||0===t)return;const e=qS(this);e.SetAngle(e.GetAngle()-hy.toRadians(t)),e.SetBboxChanged()},cy.RotateTowardAngle=function(t,e){const s=qS(this),i=s.GetAngle(),r=hy.angleRotate(i,hy.toRadians(e),hy.toRadians(t));isNaN(r)||i===r||(s.SetAngle(r),s.SetBboxChanged())},cy.RotateTowardPosition=function(t,e,s){const i=qS(this),r=i.GetAngle(),n=e-i.GetX(),a=s-i.GetY(),o=Math.atan2(a,n),h=hy.angleRotate(r,o,hy.toRadians(t));isNaN(h)||r===h||(i.SetAngle(h),i.SetBboxChanged())},cy.SetTowardPosition=function(t,e){const s=qS(this),i=s.GetAngle(),r=t-s.GetX(),n=e-s.GetY(),a=Math.atan2(n,r);isNaN(a)||i===a||(s.SetAngle(a),s.SetBboxChanged())},uy.GetAngle=function(){return hy.toDegrees(this.GetWorldInfo().GetAngle())},_y.GetAngle=function(){return this.angleDegrees},cy.CompareOpacity=function(t,e){return hy.compare(hy.roundToDp(100*qS(this).GetOpacity(),6),t,e)},uy.IsVisible=function(){return this.GetWorldInfo().IsVisible()},_y.IsVisible=function(){return this.isVisible},cy.SetVisible=function(t){const e=qS(this);t=2===t?!e.IsVisible():0!==t,e.IsVisible()!==t&&(e.SetVisible(t),dy.UpdateRender())},cy.SetOpacity=function(t){const e=hy.clamp(t/100,0,1),s=qS(this);if(s.GetTransformWithParentOpacity()){if(s._GetSceneGraphInfo().GetOwnOpacity()===e)return}else if(s.GetOpacity()===e)return;s.SetOpacity(e),dy.UpdateRender()},cy.SetDefaultColor=function(t){ly.setFromRgbValue(t);const e=qS(this);e.GetUnpremultipliedColor().equalsIgnoringAlpha(ly)||(e.SetUnpremultipliedColor(ly),dy.UpdateRender())},cy.GetColor=function(){const t=qS(this).GetUnpremultipliedColor();return hy.PackRGBAEx(t.getR(),t.getG(),t.getB(),t.getA())},cy.GetOpacity=function(){return hy.roundToDp(100*qS(this).GetOpacity(),6)},cy.IsOnLayer=function(t){return!!(t=ZS(t))&&qS(this).GetLayer()===t},cy.PickTopBottom=function(t){const e=KS(this).GetCurrentSol(),s=e.GetInstances();if(!s.length)return!1;let i=s[0];for(let e=1,r=s.length;e<r;++e){const r=s[e],n=r.GetWorldInfo(),a=i.GetWorldInfo(),o=n.GetLayer().GetIndex(),h=a.GetLayer().GetIndex();0===t?(o>h||o===h&&n.GetZIndex()>a.GetZIndex())&&(i=r):(o<h||o===h&&n.GetZIndex()<a.GetZIndex())&&(i=r)}return e.PickOne(i),!0},uy.CompareZElevation=function(t,e,s){const i=this.GetWorldInfo(),r=0===t?i.GetZElevation():i.GetTotalZElevation();return hy.compare(r,e,s)},_y.CompareZElevation=function(t,e,s){const i=0===t?this.zElevation:this.totalZElevation;return hy.compare(i,e,s)},uy.MoveToTop=function(){this.GetWorldInfo().ZOrderMoveToTop()},_y.MoveToTop=function(){this.moveToTop()},uy.MoveToBottom=function(){this.GetWorldInfo().ZOrderMoveToBottom()},_y.MoveToBottom=function(){this.moveToBottom()},cy.MoveToLayer=function(t){(t=ZS(t))&&qS(this).ZOrderMoveToLayer(t)},cy.ZMoveToObject=function(t,e){const s=0===t;if(!(e=KS(e)))return;const i=XS(this),r=e.GetFirstPicked(i);r&&i.GetWorldInfo().ZOrderMoveAdjacentToInstance(r,s)},uy.SetZElevation=function(t){const e=this.GetWorldInfo();e.GetZElevation()!==t&&(e.SetZElevation(t),dy.UpdateRender())},_y.SetZElevation=function(t){this.zElevation=t},cy.LayerNumber=function(){return qS(this).GetLayer().GetIndex()},cy.LayerName=function(){return qS(this).GetLayer().GetName()},uy.ZIndex=function(){return this.GetWorldInfo().GetZIndex()},_y.ZIndex=function(){return this.zIndex},uy.ZElevation=function(){return this.GetWorldInfo().GetZElevation()},_y.ZElevation=function(){return this.zElevation},uy.TotalZElevation=function(){return this.GetWorldInfo().GetTotalZElevation()},_y.TotalZElevation=function(){return this.totalZElevation},cy.IsEffectEnabled=function(t){const e=XS(this),s=e.GetObjectClass().GetEffectList().GetEffectTypeByName(t);if(!s)return;const i=s.GetIndex();return e.GetWorldInfo().GetInstanceEffectList().IsEffectIndexActive(i)},cy.SetEffectEnabled=function(t,e){const s=XS(this),i=s.GetObjectClass().GetEffectList().GetEffectTypeByName(e);if(!i)return;const r=i.GetIndex(),n=1===t,a=s.GetWorldInfo().GetInstanceEffectList();a.IsEffectIndexActive(r)!==n&&(a.SetEffectIndexActive(r,n),a.UpdateActiveEffects(),dy.UpdateRender())},cy.SetEffectParam=function(t,e,s){const i=XS(this),r=i.GetObjectClass().GetEffectList().GetEffectTypeByName(t);if(!r)return;e=Math.floor(e);const n=r.GetShaderProgram().GetParameterType(e);if(!n)return;"color"===n?(ly.setFromRgbValue(s),s=ly):"percent"===n&&(s/=100);const a=r.GetIndex(),o=i.GetWorldInfo().GetInstanceEffectList();o.SetEffectParameter(a,e,s)&&o.IsEffectIndexActive(a)&&dy.UpdateRender()};const my=hy.New(hy.Rect),Sy=[],yy=[];let Gy=!1,Ty=null,Iy=!1;const Cy=new Set;function*by(t){if(!t)return!1;const e=this.GetRuntime(),s=e.GetCollisionEngine(),i=e.GetEventSheetManager(),r=i.GetEventStack(),n=i.GetCurrentCondition(),a=n.GetObjectClass(),o=n.GetSavedDataMap(),h=n.GetUnsavedDataMap(),l=r.GetCurrentStackFrame(),c=e.GetTickCount(),u=c-1,_=l.GetCurrentEvent(),d=r.Push(_);let p=o.get("collmemory");p||(p=hy.New(hy.PairMap),o.set("collmemory",p)),h.get("collisionCreatedDestroyCallback")||(h.set("collisionCreatedDestroyCallback",!0),e.Dispatcher().addEventListener("instancedestroy",t=>ey(p,t.instance)));const f=a.GetCurrentSol(),g=t.GetCurrentSol(),m=f.GetInstances();let S=null;for(let e=0;e<m.length;++e){const r=m[e];g.IsSelectAll()?(s.GetCollisionCandidates(r.GetWorldInfo().GetLayer(),t,r.GetWorldInfo().GetBoundingBox(),Sy),S=Sy,s.AddRegisteredCollisionCandidates(r,t,S)):S=g.GetInstances();for(let e=0;e<S.length;++e){const n=S[e];if(s.TestOverlap(r,n)||s.CheckRegisteredCollision(r,n)){const e=sy(p,r,n);let s=!1,o=-2;"number"==typeof e&&(s=!0,o=e);const h=!s||o<u;if($S(p,r,n,c),h){const e=_.GetSolModifiers();i.PushCopySol(e);const s=a.GetCurrentSol(),o=t.GetCurrentSol();if(s._SetSelectAll(!1),o._SetSelectAll(!1),a===t){const t=s._GetOwnInstances();hy.clearArray(t),t.push(r),t.push(n),a.ApplySolToContainer()}else{const e=s._GetOwnInstances(),i=o._GetOwnInstances();hy.clearArray(e),hy.clearArray(i),e.push(r),i.push(n),a.ApplySolToContainer(),t.ApplySolToContainer()}yield*_.DebugRetrigger(l,d),i.PopSol(e)}}else ty(p,r,n)}hy.clearArray(Sy)}return r.Pop(),!1}cy.OnCollision=function(t){const e=KS(this);t=KS(t);const s=e.GetRuntime();if(s.IsDebugging())return by.call(e,t);if(!t)return!1;const i=s.GetCollisionEngine(),r=s.GetEventSheetManager(),n=r.GetEventStack(),a=r.GetCurrentCondition(),o=a.GetObjectClass(),h=a.GetSavedDataMap(),l=a.GetUnsavedDataMap(),c=n.GetCurrentStackFrame(),u=s.GetTickCount(),_=u-1,d=c.GetCurrentEvent(),p=n.Push(d);let f=h.get("collmemory");f||(f=hy.New(hy.PairMap),h.set("collmemory",f)),l.get("collisionCreatedDestroyCallback")||(l.set("collisionCreatedDestroyCallback",!0),s.Dispatcher().addEventListener("instancedestroy",t=>ey(f,t.instance)));const g=o.GetCurrentSol(),m=t.GetCurrentSol(),S=g.GetInstances();let y=null;for(let e=0;e<S.length;++e){const s=S[e];m.IsSelectAll()?(i.GetCollisionCandidates(s.GetWorldInfo().GetLayer(),t,s.GetWorldInfo().GetBoundingBox(),Sy),y=Sy,i.AddRegisteredCollisionCandidates(s,t,y)):y=m.GetInstances();for(let e=0;e<y.length;++e){const n=y[e];if(i.TestOverlap(s,n)||i.CheckRegisteredCollision(s,n)){const e=sy(f,s,n);let i=!1,a=-2;"number"==typeof e&&(i=!0,a=e);const h=!i||a<_;if($S(f,s,n,u),h){const e=d.GetSolModifiers();r.PushCopySol(e);const i=o.GetCurrentSol(),a=t.GetCurrentSol();if(i._SetSelectAll(!1),a._SetSelectAll(!1),o===t){const t=i._GetOwnInstances();hy.clearArray(t),t.push(s),t.push(n),o.ApplySolToContainer()}else{const e=i._GetOwnInstances(),r=a._GetOwnInstances();hy.clearArray(e),hy.clearArray(r),e.push(s),r.push(n),o.ApplySolToContainer(),t.ApplySolToContainer()}d.Retrigger(c,p),r.PopSol(e)}}else ty(f,s,n)}hy.clearArray(Sy)}return n.Pop(),!1},cy.IsOverlapping=function(t){return t=KS(t),iy(XS(this),t,0,0)},cy.IsOverlappingOffset=function(t,e,s){return t=KS(t),iy(XS(this),t,e,s)},cy.OnHierarchyReady=function(){return!0},cy.HasParent=function(){return qS(this).HasParent()},cy.HasChildren=function(){return qS(this).HasChildren()},cy.PickParent=function(t,e){const s=KS(this);t=KS(t);const i=s.GetRuntime(),r=this.GetCurrentSol().GetInstances();if(0===r.length)return!1;const n=t.GetCurrentSol();let a=n.GetInstances();if(n.IsSelectAll()){const e=[...i.instancesPendingCreateForObjectClass(t)];e.length>0&&(a=a.concat(e))}if(0===a.length)return!1;const o=n.IsSelectAll()?null:new Set(a),h=new Set;for(let s=0,i=r.length;s<i;++s){const i=r[s];if(1===e)for(const e of i.parents())e.BelongsToObjectClass(t)&&(null===o||o.has(e))&&h.add(e);else{let s;if(0===e){if(s=i.GetParent(),null===s)continue}else s=i.GetTopParent();s.BelongsToObjectClass(t)&&(null===o||o.has(s))&&h.add(s)}}return 0!==h.size&&(n.SetSetPicked(h),t.ApplySolToContainer(),!0)},cy.PickChildren=function(t,e){const s=KS(this);t=KS(t);const i=s.GetRuntime(),r=s.GetCurrentSol().GetInstances();if(0===r.length)return!1;const n=t.GetCurrentSol();let a=n.GetInstances();if(n.IsSelectAll()){const e=[...i.instancesPendingCreateForObjectClass(t)];e.length>0&&(a=a.concat(e))}if(0===a.length)return!1;const o=n.IsSelectAll()?null:new Set(a),h=new Set;for(let s=0,i=r.length;s<i;++s){const i=r[s];2!==e||i.HasChildren()||!i.BelongsToObjectClass(t)||null!==o&&!o.has(i)||h.add(i);for(const s of 0===e?i.children():i.allChildren())2===e&&s.HasChildren()||s.BelongsToObjectClass(t)&&(null===o||o.has(s))&&h.add(s)}return 0!==h.size&&(n.SetSetPicked(h),t.ApplySolToContainer(),!0)},cy.PickNthChild=function(t,e,s){const i=KS(this);t=KS(t);const r=i.GetRuntime(),n=i.GetCurrentSol().GetInstances();if(0===n.length)return!1;const a=t.GetCurrentSol();let o=a.GetInstances();if(a.IsSelectAll()){const e=[...r.instancesPendingCreateForObjectClass(t)];e.length>0&&(o=o.concat(e))}if(0===o.length)return!1;const h=a.IsSelectAll()?null:new Set(o),l=[];for(let i=0,r=n.length;i<r;++i){const r=n[i];if(0===e){const e=r.GetChildAt(s);null!==e&&e.BelongsToObjectClass(t)&&(null===h||h.has(e))&&l.push(e)}else if(1===e)for(const e of r.children())if(e.BelongsToObjectClass(t)){if(0===s){(null===h||h.has(e))&&l.push(e);break}--s}}return 0!==l.length&&(a.SetArrayPicked(l),t.ApplySolToContainer(),!0)},cy.CompareChildCount=function(t,e,s){const i=XS(this);switch(t){case 0:default:return hy.compare(i.GetChildCount(),e,s);case 1:return hy.compare(i.GetAllChildCount(),e,s)}},cy.AddChild=function(t,e,s,i,r,n,a,o,h,l){t=KS(t);const c=XS(this),u=dy.GetCurrentAction().GetObjectClass();for(const _ of t.allCorrespondingInstances(c,u)){if(!_.GetPlugin().SupportsSceneGraph())return;c.AddChild(_,{transformX:e,transformY:s,transformWidth:i,transformHeight:r,transformAngle:n,transformOpacity:a,transformZElevation:o,transformVisibility:h,destroyWithParent:l})}},cy.RemoveChild=function(t){t=KS(t);const e=XS(this),s=dy.GetCurrentAction().GetObjectClass();for(const i of t.allCorrespondingInstances(e,s))e.RemoveChild(i)},cy.RemoveFromParent=function(){const t=XS(this);t.HasParent()&&t.GetParent().RemoveChild(t)},cy.ParentUID=function(){const t=XS(this).GetParent();return t?t.GetUID():-1},cy.ChildCount=function(){return XS(this).GetChildCount()},cy.AllChildCount=function(){return XS(this).GetAllChildCount()},cy.SetMeshSize=function(t,e){t=Math.floor(t),e=Math.floor(e);const s=qS(this);t<2||e<2||!isFinite(t)||!isFinite(e)?(s.ReleaseMesh(),s.SetBboxChanged()):s.CreateMesh(t,e)},cy.SetMeshPoint=function(t,e,s,i,r,n,a,o){const h=qS(this);h.SetMeshPoint(t,e,{mode:0===s?"absolute":"relative",x:i,y:r,zElevation:n,u:a,v:o})&&h.SetBboxChanged()},cy.MeshColumns=function(){const t=qS(this);return t.HasMesh()?t.GetSourceMesh().GetHSize():0},cy.MeshRows=function(){const t=qS(this);return t.HasMesh()?t.GetSourceMesh().GetVSize():0},cy.SetElementVisible=function(t){const e=qS(this);t=2===t?!e.IsVisible():0!==t,e.IsVisible()!==t&&e.SetVisible(t)},cy.SetElementCSSStyle=function(t,e){this instanceof self.IInstance?this.setElementCSSStyle(t,e):this.SetElementCSSStyle(t,e)},cy.SetElementAttribute=function(t,e){this instanceof self.IInstance?this.setElementAttribute(t,""+e):this.SetElementAttribute(t,""+e)},cy.RemoveElementAttribute=function(t){this instanceof self.IInstance?this.removeElementAttribute(t):this.RemoveElementAttribute(t)},cy.SetElementFocus=function(){this instanceof self.IInstance?this.focusElement():this.FocusElement()},cy.SetElementBlur=function(){this instanceof self.IInstance?this.blurElement():this.BlurElement()},cy.IsElementFocused=function(){return this instanceof self.IInstance?this.isElementFocused():this.IsElementFocused()},cy.SetElementEnabled=function(t){this instanceof self.IInstance?this._setEnabled(0!==t):this._SetEnabled(0!==t)},cy.IsElementEnabled=function(){return this instanceof self.IInstance?this._isEnabled():this._IsEnabled()},uy.CompareInstanceVar=function(t,e,s){return hy.compare(this.GetInstance().GetInstanceVariableValue(t),e,s)},_y.CompareInstanceVar=function(t,e,s){return hy.compare(JS(this).GetInstanceVariableValue(t),e,s)},uy.IsBoolInstanceVarSet=function(t){return!!this.GetInstance().GetInstanceVariableValue(t)},_y.IsBoolInstanceVarSet=function(t){return!!JS(this).GetInstanceVariableValue(t)},cy.PickInstVarHiLow=function(t,e){const s=KS(this),i=s.GetCurrentSol(),r=i.GetInstances();if(!r.length)return!1;const n=s.IsFamily();let a=null,o=0;for(let i=0,h=r.length;i<h;++i){const h=r[i],l=n?h.GetObjectClass().GetFamilyInstanceVariableOffset(s.GetFamilyIndex()):0,c=h.GetInstanceVariableValue(l+e);(null===a||0===t&&c<o||1===t&&c>o)&&(o=c,a=h)}return i.PickOne(a),!0},cy.PickByUID=function(t){const e=KS(this);return e.GetRuntime().GetCurrentCondition().IsInverted()?oy(e,t):ay(e,t)},cy.HasTags=function(t){const e=XS(this);return t.includes(" ")?new Set(hy.splitStringAndNormalize(t.toLowerCase())).isSubsetOf(e.GetLowercaseTagsSet()):!t||e.HasTag(t)},cy.Tags=function(){return XS(this).GetTagsString()},cy.TagsCount=function(){return XS(this).GetTagsSet().size},cy.TagAt=function(t){return XS(this).GetTagAt(t)},cy.ChangeTags=function(t,e){const s=hy.splitStringAndNormalize(e),i=XS(this);if(2===t)return void i.SetTagsSet(new Set(s));if(0===s.length)return;const r=new Set(i.GetTagsSet());if(0===t)for(const t of s)r.add(t);else if(1===t)for(const t of s)if(!r.delete(t)){const e=t.toLowerCase();for(const t of r)if(t.toLowerCase()===e){r.delete(t);break}}i.SetTagsSet(r)},cy.Destroy=function(){dy.DestroyInstance(XS(this))},cy.OnCreated=function(){return!0},cy.OnDestroyed=function(){return!0},uy.SetInstanceVar=function(t,e){this.GetInstance().SetInstanceVariableValue(t,e)},_y.SetInstanceVar=function(t,e){JS(this).SetInstanceVariableValue(t,e)},uy.AddInstanceVar=function(t,e){const s=this.GetInstance(),i=s.GetInstanceVariableValue(t);"number"==typeof i&&"number"!=typeof e?e=parseFloat(e):"string"==typeof i&&"string"!=typeof e&&(e=e.toString()),s.SetInstanceVariableValue(t,i+e)},_y.AddInstanceVar=function(t,e){const s=JS(this),i=s.GetInstanceVariableValue(t);"number"==typeof i&&"number"!=typeof e?e=parseFloat(e):"string"==typeof i&&"string"!=typeof e&&(e=e.toString()),s.SetInstanceVariableValue(t,i+e)},uy.SubInstanceVar=function(t,e){const s=this.GetInstance(),i=s.GetInstanceVariableValue(t);"number"==typeof i&&("number"!=typeof e&&(e=parseFloat(e)),s.SetInstanceVariableValue(t,i-e))},_y.SubInstanceVar=function(t,e){const s=JS(this),i=s.GetInstanceVariableValue(t);"number"==typeof i&&("number"!=typeof e&&(e=parseFloat(e)),s.SetInstanceVariableValue(t,i-e))},uy.SetBoolInstanceVar=function(t,e){this.GetInstance().SetInstanceVariableValue(t,e?1:0)},_y.SetBoolInstanceVar=function(t,e){JS(this).SetInstanceVariableValue(t,e?1:0)},uy.ToggleBoolInstanceVar=function(t){const e=this.GetInstance();e.SetInstanceVariableValue(t,0===e.GetInstanceVariableValue(t)?1:0)},_y.ToggleBoolInstanceVar=function(t){const e=JS(this);e.SetInstanceVariableValue(t,0===e.GetInstanceVariableValue(t)?1:0)},cy.LoadFromJsonString=function(t){let e;try{e=JSON.parse(t)}catch(t){return void console.error("Failed to load from JSON string: ",t)}const s=XS(this),i="state";dy.ClearIntancesNeedingAfterLoad(),s._OnBeforeLoad(i),s.LoadFromJson(e,i),dy.DoAfterLoad(i,{setFromJson:!0})},cy.AsJSON=function(){return JSON.stringify(XS(this).SaveToJson("state"))},cy.ObjectTypeName=function(){return XS(this).GetObjectClass().GetName()},cy.Count=function(){const t=dy.GetCurrentEventStackFrame().GetExpressionObjectClass();let e=t.GetInstanceCount();for(const s of dy.instancesPendingCreateForObjectClass(t))++e;return e},cy.PickedCount=function(){return dy.GetCurrentEventStackFrame().GetExpressionObjectClass().GetCurrentSol().GetInstances().length},uy.GetIID=function(){return this.GetInstance().GetIID()},_y.GetIID=function(){return JS(this).GetIID()},uy.GetUID=function(){return this.GetInstance().GetUID()},_y.GetUID=function(){return JS(this).GetUID()},cy.OnInstanceSignal=function(t){const e=XS(this);return t.toLowerCase()===dy.GetEventSheetManager().GetCurrentInstanceSignalTag(e)},cy.InstanceSignal=function(t){const e=XS(this);dy.GetEventSheetManager().InstanceSignal(e,t)},cy.InstanceWaitForSignal=function(t){const e=KS(this);return dy.GetEventSheetManager().AddScheduledWait().InitInstanceSignals(e.GetCurrentSol().GetInstances(),t),!0},cy.TemplateName=function(){return XS(this).GetTemplateName()},hy.AddCommonACEs=function(t,e,s){const i=t[1],r=t[3],n=t[4],a=t[5],o=t[6],h=t[7],l=t[8],c=t[10],u=t[11],_=t[12],d=t[13],p=t[14],f=t[15],g=t[16],m=e.Cnds,S=e.Acts,y=e.Exps,G=Object.assign({},cy,s>=2?_y:uy);r&&(m.CompareX=G.CompareX,m.CompareY=G.CompareY,m.IsOnScreen=G.IsOnScreen,m.IsOutsideLayout=G.IsOutsideLayout,m.PickDistance=G.PickDistance,S.SetX=G.SetX,S.SetY=G.SetY,S.SetPos=G.SetPos,S.SetPosToObject=G.SetPosToObject,S.MoveForward=G.MoveForward,S.MoveAtAngle=G.MoveAtAngle,y.X=G.GetX,y.Y=G.GetY,y.dt=G.GetDt),n&&(m.CompareWidth=G.CompareWidth,m.CompareHeight=G.CompareHeight,S.SetWidth=G.SetWidth,S.SetHeight=G.SetHeight,S.SetSize=G.SetSize,y.Width=G.GetWidth,y.Height=G.GetHeight,y.BBoxLeft=G.GetBboxLeft,y.BBoxTop=G.GetBboxTop,y.BBoxRight=G.GetBboxRight,y.BBoxBottom=G.GetBboxBottom,y.BBoxMidX=G.GetBboxMidX,y.BBoxMidY=G.GetBboxMidY),a&&(m.AngleWithin=G.IsAngleWithin,m.IsClockwiseFrom=G.IsAngleClockwiseFrom,m.IsBetweenAngles=G.IsBetweenAngles,S.SetAngle=G.SetAngle,S.RotateClockwise=G.RotateClockwise,S.RotateCounterclockwise=G.RotateCounterclockwise,S.RotateTowardAngle=G.RotateTowardAngle,S.RotateTowardPosition=G.RotateTowardPosition,S.SetTowardPosition=G.SetTowardPosition,y.Angle=G.GetAngle),o&&(m.IsVisible=G.IsVisible,m.CompareOpacity=G.CompareOpacity,S.SetVisible=G.SetVisible,S.SetOpacity=G.SetOpacity,S.SetDefaultColor=G.SetDefaultColor,y.Opacity=G.GetOpacity,y.ColorValue=G.GetColor),h&&(m.IsOnLayer=G.IsOnLayer,m.PickTopBottom=G.PickTopBottom,m.CompareZElevation=G.CompareZElevation,S.MoveToTop=G.MoveToTop,S.MoveToBottom=G.MoveToBottom,S.MoveToLayer=G.MoveToLayer,S.ZMoveToObject=G.ZMoveToObject,S.SetZElevation=G.SetZElevation,y.LayerNumber=G.LayerNumber,y.LayerName=G.LayerName,y.ZIndex=G.ZIndex,y.ZElevation=G.ZElevation,y.TotalZElevation=G.TotalZElevation),l&&(m.IsEffectEnabled=G.IsEffectEnabled,S.SetEffectEnabled=G.SetEffectEnabled,S.SetEffectParam=G.SetEffectParam),d&&(m.OnHierarchyReady=G.OnHierarchyReady,m.HasParent=G.HasParent,m.HasChildren=G.HasChildren,m.PickParent=G.PickParent,m.PickChildren=G.PickChildren,m.PickNthChild=G.PickNthChild,m.CompareChildCount=G.CompareChildCount,S.AddChild=G.AddChild,S.RemoveChild=G.RemoveChild,S.RemoveFromParent=G.RemoveFromParent,y.ParentUID=G.ParentUID,y.ChildCount=G.ChildCount,y.AllChildCount=G.AllChildCount),p&&(S.SetMeshSize=G.SetMeshSize,S.SetMeshPoint=G.SetMeshPoint,y.MeshColumns=G.MeshColumns,y.MeshRows=G.MeshRows),c&&(m.IsVisible=G.IsVisible,S.SetVisible=G.SetElementVisible,S.SetCSSStyle=G.SetElementCSSStyle,S.SetElemAttribute=G.SetElementAttribute,S.RemoveElemAttribute=G.RemoveElementAttribute),u&&(m.IsFocused=G.IsElementFocused,S.SetFocus=G.SetElementFocus,S.SetBlur=G.SetElementBlur),_&&(m.IsEnabled=G.IsElementEnabled,S.SetEnabled=G.SetElementEnabled),f&&(m.OnCollision=G.OnCollision,m.IsOverlapping=G.IsOverlapping,m.IsOverlappingOffset=G.IsOverlappingOffset,e.FinishCollisionCondition=ny),i||(m.CompareInstanceVar=G.CompareInstanceVar,m.IsBoolInstanceVarSet=G.IsBoolInstanceVarSet,m.PickInstVarHiLow=G.PickInstVarHiLow,m.PickByUID=G.PickByUID,m.HasTags=G.HasTags,S.SetInstanceVar=G.SetInstanceVar,S.AddInstanceVar=G.AddInstanceVar,S.SubInstanceVar=G.SubInstanceVar,S.SetBoolInstanceVar=G.SetBoolInstanceVar,S.ToggleBoolInstanceVar=G.ToggleBoolInstanceVar,S.ChangeTags=G.ChangeTags,m.OnCreated=G.OnCreated,m.OnDestroyed=G.OnDestroyed,S.Destroy=G.Destroy,S.LoadFromJsonString||(S.LoadFromJsonString=G.LoadFromJsonString),y.AsJSON||(y.AsJSON=G.AsJSON),y.Count=G.Count,y.PickedCount=G.PickedCount,y.IID=G.GetIID,y.UID=G.GetUID,y.ObjectTypeName=G.ObjectTypeName,y.Tags=G.Tags,y.TagsCount=G.TagsCount,y.TagAt=G.TagAt,m.OnInstanceSignal=G.OnInstanceSignal,S.InstanceSignal=G.InstanceSignal,S.InstanceWaitForSignal=G.InstanceWaitForSignal),g&&(y.TemplateName=G.TemplateName)}}{const xy=self.C3;xy.ScheduledWait=class extends xy.DefendedBase{constructor(t){super(),this._eventSheetManager=t,this._type="",this._time=-1,this._signalTag="",this._isSignalled=!1,this._event=null,this._actIndex=0,this._solModifiers=[],this._dynamicSolModifiers=null,this._sols=new Map,this._pendingInstances=null,this._callingFunctionBlock=null,this._asyncId=-1,this._functionParameters=null,this._functionInnerLocalVars=null,this._shouldRelease=!1}Release(){this._type="",this._time=-1,this._signalTag="",this._event=null,this._callingFunctionBlock=null,this._functionParameters=null,this._functionInnerLocalVars=null,this._asyncId=-1,xy.clearArray(this._solModifiers),this._dynamicSolModifiers&&(this._dynamicSolModifiers.clear(),this._dynamicSolModifiers=null);for(const t of this._sols.values())t.Release();this._sols.clear(),this._pendingInstances=null}_Init(){const t=this._eventSheetManager,e=t.GetRuntime().GetAllObjectClasses(),s=t.GetCurrentEventStackFrame();this._event=s.GetCurrentEvent(),this._actIndex=s.GetActionIndex()+1;const i=t.FindFirstFunctionBlockParent(this._event);i&&(this._callingFunctionBlock=i,this._functionParameters=i.CaptureFunctionParameters(),this._functionInnerLocalVars=i._GetAllInnerLocalVariables().map(t=>t.GetValue()),i.IsAsync()&&(this._asyncId=i.PauseCurrentAsyncFunction()));for(const t of e){const e=t.GetCurrentSol();e.IsSelectAll()&&!this._event.HasSolModifier(t)||(this._solModifiers.push(t),this._sols.set(t,xy.New(xy.SolState,e)))}const r=t.GetDynamicSolModifiersSet();this._dynamicSolModifiers=r.size>0?r:null}InitTimer(t){this._type="timer",this._Init(),this._time=this._eventSheetManager.GetRuntime().GetGameTime()+t}InitWallTimer(t){this._type="walltimer",this._Init(),this._time=this._eventSheetManager.GetRuntime().GetWallTime()+t}InitSignal(t){this._type="signal",this._Init(),this._signalTag=t.toLowerCase()}InitInstanceSignals(t,e){this._type="instance-signals",this._Init(),this._signalTag=e.toLowerCase(),this._pendingInstances=new Set(t)}InitPromise(t){this._type="promise",this._Init(),t.then(()=>this.SetSignalled()).catch(t=>{console.warn("[C3 runtime] Promise rejected in 'Wait for previous actions to complete': ",t),this.SetSignalled()})}IsTimer(){return"timer"===this._type}IsWallTimer(){return"walltimer"===this._type}IsSignal(){return"signal"===this._type}IsInstanceSignals(){return"instance-signals"===this._type}IsPromise(){return"promise"===this._type}GetSignalTag(){return this._signalTag}IsSignalled(){return this._isSignalled}SetSignalled(){this._isSignalled=!0}SetInstanceSignalled(t){this._pendingInstances.delete(t),0===this._pendingInstances.size&&this.SetSignalled()}_ShouldRun(){return this.IsTimer()?this._time<=this._eventSheetManager.GetRuntime().GetGameTime():this.IsWallTimer()?this._time<=this._eventSheetManager.GetRuntime().GetWallTime():this.IsSignalled()}_RestoreState(t){t._Restore(this._event,this._actIndex);for(const[t,e]of this._sols.entries()){const s=t.GetCurrentSol();e._Restore(s)}this._dynamicSolModifiers&&t.SetDynamicSolModifiers([...this._dynamicSolModifiers]);const e=this._callingFunctionBlock;e&&(e.SetFunctionParameters(this._functionParameters),e._GetAllInnerLocalVariables().map((t,e)=>t.SetValue(this._functionInnerLocalVars[e])),e.IsAsync()&&e.ResumeAsyncFunction(this._asyncId))}_Run(t){this._RestoreState(t),this._event._ResumeActionsAndSubEvents(t),this._callingFunctionBlock&&this._callingFunctionBlock.IsAsync()&&this._callingFunctionBlock.MaybeFinishAsyncFunctionCall(this._asyncId),this._eventSheetManager.ClearSol(this._solModifiers),this._shouldRelease=!0}async _DebugRun(t){this._RestoreState(t);for(const e of this._event._DebugResumeActionsAndSubEvents(t))await this._eventSheetManager.GetRuntime().DebugBreak(e);this._callingFunctionBlock&&this._callingFunctionBlock.IsAsync()&&this._callingFunctionBlock.MaybeFinishAsyncFunctionCall(this._asyncId),this._eventSheetManager.ClearSol(this._solModifiers),this._shouldRelease=!0}ShouldRelease(){return this._shouldRelease}RemoveInstances(t){for(const e of this._sols.values())e.RemoveInstances(t);if("instance-signals"===this._type){for(const e of t)this._pendingInstances.delete(e);0===this._pendingInstances.size&&this.SetSignalled()}}_SaveToJson(){const t={},e={wt:this._type,t:this._time,st:this._signalTag,s:this._isSignalled,ev:this._event.GetSID(),sm:this._solModifiers.map(t=>t.GetSID()),dsm:this._dynamicSolModifiers?[...this._dynamicSolModifiers].map(t=>t.GetSID()):null,sols:t};this._event._HasActionIndex(this._actIndex)&&(e.act=this._event.GetActionAt(this._actIndex).GetSID());for(const[e,s]of this._sols)t[e.GetSID().toString()]=s._SaveToJson();return"instance-signals"===this._type&&(e.pi=[...this._pendingInstances].map(t=>t.GetUID())),e}static _CreateFromJson(t,e){const s=t.GetRuntime(),i=t.GetEventBlockBySID(e.ev);if(!i)return null;let r=0;if(e.hasOwnProperty("act")){const s=t.GetActionBySID(e.act);if(!s)return null;r=s.GetIndex()}const n=xy.New(xy.ScheduledWait,t);n._time=e.t,e.hasOwnProperty("wt")?n._type=e.wt:n._type=-1===n._time?"signal":"timer",n._signalTag=e.st,n._isSignalled=e.s,n._event=i,n._actIndex=r;for(const t of e.sm){const e=s.GetObjectClassBySID(t);e&&n._solModifiers.push(e)}if(Array.isArray(e.dsm))for(const t of e.dsm){const e=s.GetObjectClassBySID(t);e&&(n._dynamicSolModifiers||(n._dynamicSolModifiers=new Set),n._dynamicSolModifiers.add(e))}for(const[i,r]of Object.entries(e.sols)){const e=parseInt(i,10),a=s.GetObjectClassBySID(e);if(!a)continue;const o=xy.New(xy.SolState,null);o._LoadFromJson(t,r),n._sols.set(a,o)}if("instance-signals"===n._type){n._pendingInstances=new Set;for(const t of e.pi){const e=s.GetInstanceByUID(t);e&&n._pendingInstances.add(e)}}return n}}}{const wy=self.C3;wy.SolState=class extends wy.DefendedBase{constructor(t){super(),this._objectClass=null,this._isSelectAll=!0,this._instances=[],t&&(this._objectClass=t.GetObjectClass(),this._isSelectAll=t.IsSelectAll(),wy.shallowAssignArray(this._instances,t._GetOwnInstances()))}Release(){this._objectClass=null,wy.clearArray(this._instances)}_Restore(t){t._SetSelectAll(this._isSelectAll),wy.shallowAssignArray(t._GetOwnInstances(),this._instances)}RemoveInstances(t){wy.arrayRemoveAllInSet(this._instances,t)}_SaveToJson(){return{sa:this._isSelectAll,insts:this._instances.map(t=>t.GetUID())}}_LoadFromJson(t,e){const s=t.GetRuntime();this._isSelectAll=!!e.sa,wy.clearArray(this._instances);for(const t of e.insts){const e=s.GetInstanceByUID(t);e&&this._instances.push(e)}}}}{let My=function(t,e){let s=t.get(e);return s||(s=new Map,t.set(e,s)),s};0;const Py=self.C3;Py.SDKPluginBase=class extends Py.DefendedBase{constructor(t){super(),this._runtime=t.runtime,this._id=t.id,this._name=t.name??"",this._isSingleGlobal=!!t.isSingleGlobal,this._isWorldType=!!t.isWorld,this._isRotatable=!!t.isRotatable,this._mustPredraw=!!t.mustPredraw,this._hasEffects=!!t.hasEffects,this._supportsSceneGraph=!!t.supportsSceneGraph,this._supportsMesh=!!t.supportsMesh,this._isHTMLElementType=!!t.isHTMLElementType,this._is3d=!!t.is3d,this._sdkVersion=t.sdkVersion,this._exportData=t.exportData,this._singleGlobalObjectClass=null,this._boundACEMethodCache=new Map,this._boundACEMethodCache_1param=new Map,this._boundACEMethodCache_2params=new Map,this._boundACEMethodCache_3params=new Map,this._scriptInterfaceClass=t.scriptInterfaceClass,this._iPlugin=null}Release(){this._runtime=null}GetRuntime(){return this._runtime}GetID(){return this._id}GetName(){return this._name}OnCreate(){}GetConstructor(){return this.GetSdkVersion()>=2?this._iPlugin.constructor:this.constructor}GetSdkVersion(){return this._sdkVersion}GetScriptInterfaceClass(t=!1){let e=this._scriptInterfaceClass;return t&&"function"!=typeof e&&this.GetSdkVersion()>=2&&(e=globalThis.ISDKPluginBase),e}GetExportData(){return this._exportData}IsSingleGlobal(){return this._isSingleGlobal}IsWorldType(){return this._isWorldType}IsHTMLElementType(){return this._isHTMLElementType}Is3D(){return this._is3d}IsRotatable(){return this._isRotatable}MustPreDraw(){return this._mustPredraw}HasEffects(){return this._hasEffects}SupportsSceneGraph(){return this._supportsSceneGraph}SupportsMesh(){return this._supportsMesh}_GetBoundACEMethod(t,e){if(!e)throw new Error("missing 'this' binding");let s=this._boundACEMethodCache.get(t);return s||(s=t.bind(e),this._boundACEMethodCache.set(t,s),s)}_GetBoundACEMethod_1param(t,e,s){if(!e)throw new Error("missing 'this' binding");const i=My(this._boundACEMethodCache_1param,t);let r=i.get(s);return r||(r=t.bind(e,s),i.set(s,r),r)}_GetBoundACEMethod_2params(t,e,s,i){if(!e)throw new Error("missing 'this' binding");const r=My(this._boundACEMethodCache_2params,t),n=My(r,s);let a=n.get(i);return a||(a=t.bind(e,s,i),n.set(i,a),a)}_GetBoundACEMethod_3params(t,e,s,i,r){if(!e)throw new Error("missing 'this' binding");const n=My(this._boundACEMethodCache_3params,t),a=My(n,s),o=My(a,i);let h=o.get(r);return h||(h=t.bind(e,s,i,r),o.set(r,h),h)}_SetSingleGlobalObjectClass(t){if(!this.IsSingleGlobal())throw new Error("must be single-global plugin");this._singleGlobalObjectClass=t}GetSingleGlobalObjectClass(){if(!this.IsSingleGlobal())throw new Error("must be single-global plugin");return this._singleGlobalObjectClass}GetSingleGlobalInstance(){if(!this.IsSingleGlobal())throw new Error("must be single-global plugin");return this._singleGlobalObjectClass.GetSingleGlobalInstance()}_InitScriptInterface(){const t=this.GetSdkVersion();Py.AddonManager._PushInitObject(this,t);const e=this.GetScriptInterfaceClass(!0);if(e){if(this._iPlugin=new e,!(this._iPlugin instanceof self.IPlugin))throw new TypeError("plugin class must derive from IPlugin")}else this._iPlugin=new self.IPlugin;Py.AddonManager._PopInitObject(t)}GetIPlugin(){return this._iPlugin}}}{const vy=self.C3;vy.SDKDOMPluginBase=class extends vy.SDKPluginBase{constructor(t,e){super(t),this._domComponentId=e,this._nextElementId=0,this._instMap=new Map,this.AddElementMessageHandler("elem-focused",t=>t._OnElemFocused()),this.AddElementMessageHandler("elem-blurred",t=>{t&&t._OnElemBlurred()})}Release(){super.Release()}_AddElement(t){const e=this._nextElementId++;return this._instMap.set(e,t),e}_RemoveElement(t){this._instMap.delete(t)}AddElementMessageHandler(t,e){this._runtime.AddDOMComponentMessageHandler(this._domComponentId,t,t=>{const s=this._instMap.get(t.elementId);e(s,t)})}}}{const Ry=self.C3;Ry.SDKTypeBase=class extends Ry.DefendedBase{constructor(t){super(),this._objectClass=t,this._runtime=t.GetRuntime(),this._plugin=t.GetPlugin()}Release(){this._objectClass=null,this._runtime=null,this._plugin=null}GetObjectClass(){return this._objectClass}GetRuntime(){return this._runtime}GetPlugin(){return this._plugin}GetImageInfo(){return this._objectClass.GetImageInfo()}OnCreate(){}FinishCondition(t){}BeforeRunAction(t){}AfterRunAction(t){}LoadTextures(t){}ReleaseTextures(){}OnDynamicTextureLoadComplete(){}PreloadTexturesWithInstances(t){}LoadTilemapData(){}GetScriptInterfaceClass(){return null}DispatchScriptEvent(t,e,s){const i=Ry.New(Ry.Event,t,e);i.objectClass=this,s&&Object.assign(i,s),this.GetObjectClass().DispatchUserScriptEvent(i)}}}{const Ay=self.C3;Ay.SDKInstanceBase=class extends Ay.DefendedBase{constructor(t,e){super(),this._inst=t,this._domComponentId=e,this._wrapperComponentId=null,this._runtime=t.GetRuntime(),this._objectClass=this._inst.GetObjectClass(),this._sdkType=this._objectClass.GetSdkType(),this._tickFunc=null,this._tick2Func=null,this._isTicking=!1,this._isTicking2=!1,this._disposables=null,this._wasReleased=!1}Release(){this._wasReleased=!0,this._StopTicking(),this._StopTicking2(),this._tickFunc=null,this._tick2Func=null,this._disposables&&(this._disposables.Release(),this._disposables=null),this._inst=null,this._runtime=null,this._objectClass=null,this._sdkType=null}WasReleased(){return this._wasReleased}GetInstance(){return this._inst}GetRuntime(){return this._runtime}GetObjectClass(){return this._objectClass}GetPlugin(){return this._sdkType.GetPlugin()}GetSdkType(){return this._sdkType}GetScriptInterface(){return this._inst.GetInterfaceClass()}Trigger(t){return this._runtime.Trigger(t,this._inst,null)}DebugTrigger(t){return this._runtime.DebugTrigger(t,this._inst,null)}TriggerAsync(t){return this._runtime.TriggerAsync(t,this._inst,null)}FastTrigger(t,e){return this._runtime.FastTrigger(t,this._inst,e)}DebugFastTrigger(t,e){return this._runtime.DebugFastTrigger(t,this._inst,e)}ScheduleTriggers(t){return this._runtime.ScheduleTriggers(t)}AddDOMMessageHandler(t,e){this._runtime.AddDOMComponentMessageHandler(this._domComponentId,t,e)}AddDOMMessageHandlers(t){for(const[e,s]of t)this.AddDOMMessageHandler(e,s)}PostToDOM(t,e){this._runtime.PostComponentMessageToDOM(this._domComponentId,t,e)}PostToDOMAsync(t,e){return this._runtime.PostComponentMessageToDOMAsync(this._domComponentId,t,e)}_PostToDOMMaybeSync(t,e){if(!this._runtime.IsInWorker())return window.c3_runtimeInterface._OnMessageFromRuntime({type:"event",component:this._domComponentId,handler:t,data:e,responseId:null});this.PostToDOM(t,e)}SetWrapperExtensionComponentId(t){if(!t)throw new Error("cannot set empty component id");this._wrapperComponentId=t}IsWrapperExtensionAvailable(){if(!this._wrapperComponentId)throw new Error("wrapper extension component id not set");return this._runtime.HasWrapperComponentId(this._wrapperComponentId)}AddWrapperExtensionMessageHandler(t,e){if(!this._wrapperComponentId)throw new Error("wrapper extension component id not set");this._runtime.AddWrapperExtensionMessageHandler(this._wrapperComponentId,t,e)}AddWrapperExtensionMessageHandlers(t){for(const[e,s]of t)this.AddWrapperExtensionMessageHandler(e,s)}SendWrapperExtensionMessage(t,e){if(!this._wrapperComponentId)throw new Error("wrapper extension component id not set");this._runtime.SendWrapperExtensionMessage(this._wrapperComponentId,t,e)}SendWrapperExtensionMessageAsync(t,e){if(!this._wrapperComponentId)throw new Error("wrapper extension component id not set");return this._runtime.SendWrapperExtensionMessageAsync(this._wrapperComponentId,t,e)}Tick(){}Tick2(){}_StartTicking(){if(!this._isTicking){if(!this._tickFunc)if(this._runtime.IsDebug()){const t=globalThis.C3Debugger,e=this.GetPlugin();this._tickFunc=()=>{const s=performance.now();this.Tick(),t.AddIndividualPluginTickTime(e,performance.now()-s)}}else this._tickFunc=()=>this.Tick();this._runtime.Dispatcher().addEventListener("tick",this._tickFunc),this._isTicking=!0}}_StopTicking(){this._isTicking&&(this._runtime.Dispatcher().removeEventListener("tick",this._tickFunc),this._isTicking=!1)}IsTicking(){return this._isTicking}_StartTicking2(){if(!this._isTicking2){if(!this._tick2Func)if(this._runtime.IsDebug()){const t=globalThis.C3Debugger,e=this.GetPlugin();this._tick2Func=()=>{const s=performance.now();this.Tick2(),t.AddIndividualPluginTickTime(e,performance.now()-s)}}else this._tick2Func=()=>this.Tick2();this._runtime.Dispatcher().addEventListener("tick2",this._tick2Func),this._isTicking2=!0}}_StopTicking2(){this._isTicking2&&(this._runtime.Dispatcher().removeEventListener("tick2",this._tick2Func),this._isTicking2=!1)}IsTicking2(){return this._isTicking2}GetDebuggerProperties(){return[]}SaveToJson(){return null}LoadFromJson(t){}GetPropertyValueByIndex(t){}SetPropertyValueByIndex(t,e){}OffsetPropertyValueByIndex(t,e,s){if(0===e)return;const i=this.GetPropertyValueByIndex(t);if("number"!=typeof i)throw new Error("expected number");this.SetPropertyValueByIndex(t,i+e,s)}SetPropertyColorOffsetValueByIndex(t,e,s,i){}CallAction(t,...e){t.call(this,...e)}CallExpression(t,...e){return t.call(this,...e)}GetScriptInterfaceClass(){return null}DispatchScriptEvent(t,e,s){if(!this._inst.HasScriptInterface())return;const i=this.GetScriptInterface(),r=Ay.New(Ay.Event,t,e);r.instance=i,s&&Object.assign(r,s),i.dispatchEvent(r)}MustPreDraw(){return!1}}}{const Dy=self.C3;Dy.SDKWorldInstanceBase=class extends Dy.SDKInstanceBase{constructor(t,e){super(t,e),this._worldInfo=t.GetWorldInfo(),this._renderercontextlost_handler=null,this._renderercontextrestored_handler=null}Release(){if(this._renderercontextlost_handler){const t=this._runtime.Dispatcher();t.removeEventListener("renderercontextlost",this._renderercontextlost_handler),t.removeEventListener("renderercontextrestored",this._renderercontextrestored_handler),this._renderercontextlost_handler=null,this._renderercontextrestored_handler=null}this._worldInfo=null,super.Release()}HandleWebGLContextLoss(){this.HandleRendererContextLoss()}OnWebGLContextLost(){}OnWebGLContextRestored(){}HandleRendererContextLoss(){if(this._renderercontextlost_handler)return;this._renderercontextlost_handler=()=>this.OnRendererContextLost(),this._renderercontextrestored_handler=()=>this.OnRendererContextRestored();const t=this._runtime.Dispatcher();t.addEventListener("renderercontextlost",this._renderercontextlost_handler),t.addEventListener("renderercontextrestored",this._renderercontextrestored_handler)}OnRendererContextLost(){this.OnWebGLContextLost()}OnRendererContextRestored(){this.OnWebGLContextRestored()}GetWorldInfo(){return this._worldInfo}IsOriginalSizeKnown(){return!1}GetOriginalWidth(){if(!this.IsOriginalSizeKnown())throw new Error("original size not known");const t=this.GetCurrentImageInfo();if(t)return t.GetWidth()}GetOriginalHeight(){if(!this.IsOriginalSizeKnown())throw new Error("original size not known");const t=this.GetCurrentImageInfo();if(t)return t.GetHeight()}GetCurrentImageInfo(){return null}GetCurrentSurfaceSize(){const t=this.GetCurrentImageInfo();if(t){const e=t.GetTexture();if(e)return[e.GetWidth(),e.GetHeight()]}return[100,100]}GetCurrentTexRect(){const t=this.GetCurrentImageInfo();return t?t.GetTexRect():null}GetCurrentTexQuad(){const t=this.GetCurrentImageInfo();return t?t.GetTexQuad():null}IsCurrentTexRotated(){const t=this.GetCurrentImageInfo();return!!t&&t.IsRotated()}GetImagePoint(t){const e=this._inst.GetWorldInfo();return[e.GetX(),e.GetY(),e.GetTotalZElevation()]}LoadTilemapData(t,e,s){}TestPointOverlapTile(t,e){}RendersToOwnZPlane(){return!0}}}{const Ey=self.C3,Fy=Ey.New(Ey.Rect);Ey.SDKDOMInstanceBase=class extends Ey.SDKWorldInstanceBase{constructor(t,e){super(t,e),this._elementId=this.GetPlugin()._AddElement(this),this._isElementShowing=!0,this._elemHasFocus=!1,this._autoFontSize=!1,this._autoFontSizeOffset=-.2,this._lastRect=Ey.New(Ey.Rect,0,0,-1,-1);const s=this._runtime.GetCanvasManager();this._lastWindowWidth=s.GetLastWidth(),this._lastWindowHeight=s.GetLastHeight(),this._lastHTMLIndex=-1,this._lastHTMLZIndex=-1,this._isPendingUpdateState=!1,this._StartTicking()}Release(){this.GetPlugin()._RemoveElement(this._elementId),this.PostToDOMElement("destroy"),this._elementId=-1,super.Release()}_GetElementInDOMMode(){if(this._runtime.IsInWorker())throw new Error("not valid in worker mode");return this._PostToDOMElementMaybeSync("get-element")}PostToDOMElement(t,e){e||(e={}),e.elementId=this._elementId,this.PostToDOM(t,e)}_PostToDOMElementMaybeSync(t,e){return e||(e={}),e.elementId=this._elementId,this._PostToDOMMaybeSync(t,e)}PostToDOMElementAsync(t,e){return e||(e={}),e.elementId=this._elementId,this.PostToDOMAsync(t,e)}CreateElement(t){t||(t={});const e=this.GetWorldInfo();t.elementId=this._elementId,t.isVisible=e.IsVisible(),t.htmlIndex=e.GetLayer().GetHTMLIndex(),t.htmlZIndex=e.GetHTMLZIndex(),Object.assign(t,this.GetElementState()),this._isElementShowing=!!t.isVisible,this._PostToDOMMaybeSync("create",t),this._UpdatePosition(!0)}SetElementVisible(t){t=!!t,this._isElementShowing!==t&&(this._isElementShowing=t,this.PostToDOMElement("set-visible",{isVisible:t}))}Tick(){this._UpdatePosition(!1)}_ShouldPreserveElement(){const t=this._runtime.GetCanvasManager().GetFullscreenMode();return"Android"===Ey.Platform.OS&&("scale-inner"===t||"scale-outer"===t||"crop"===t)}_UpdatePosition(t){if(this.GetInstance().IsDestroyed())return;const e=this.GetWorldInfo(),s=e.GetLayer(),i=e.GetBoundingBox();let[r,n]=s.LayerToCanvasCss(i.getLeft(),i.getTop()),[a,o]=s.LayerToCanvasCss(i.getRight(),i.getBottom());const h=this._runtime.GetCanvasManager(),l=h.GetCssWidth(),c=h.GetCssHeight();if(!e.IsVisible()||!s.IsVisible())return void this.SetElementVisible(!1);if(!this._ShouldPreserveElement()&&(a<=0||o<=0||r>=l||n>=c))return void this.SetElementVisible(!1);Fy.set(r,n,a,o);const u=h.GetLastWidth(),_=h.GetLastHeight(),d=s.GetHTMLIndex(),p=e.GetHTMLZIndex();if(!t&&Fy.equals(this._lastRect)&&this._lastWindowWidth===u&&this._lastWindowHeight===_&&this._lastHTMLIndex===d&&this._lastHTMLZIndex===p)return void this.SetElementVisible(!0);this._lastRect.copy(Fy),this._lastWindowWidth=u,this._lastWindowHeight=_,this._lastHTMLIndex=d,this._lastHTMLZIndex=p,this.SetElementVisible(!0);let f=null;this._autoFontSize&&(f=s.GetDisplayScale()+this._autoFontSizeOffset),this._PostToDOMElementMaybeSync("update-position",{left:Math.round(this._lastRect.getLeft()),top:Math.round(this._lastRect.getTop()),width:Math.round(this._lastRect.width()),height:Math.round(this._lastRect.height()),htmlIndex:d,htmlZIndex:p,fontSize:f})}FocusElement(){this._PostToDOMElementMaybeSync("focus",{focus:!0})}BlurElement(){this._PostToDOMElementMaybeSync("focus",{focus:!1})}_OnElemFocused(){this._elemHasFocus=!0}_OnElemBlurred(){this._elemHasFocus=!1}IsElementFocused(){return this._elemHasFocus}SetElementCSSStyle(t,e){this.PostToDOMElement("set-css-style",{prop:Ey.CSSToCamelCase(t),val:e})}SetElementAttribute(t,e){this.PostToDOMElement("set-attribute",{name:t,val:e})}RemoveElementAttribute(t){this.PostToDOMElement("remove-attribute",{name:t})}UpdateElementState(){this._isPendingUpdateState||(this._isPendingUpdateState=!0,Promise.resolve().then(()=>{this._isPendingUpdateState=!1,this.PostToDOMElement("update-state",this.GetElementState())}))}GetElementState(){}GetElementId(){return this._elementId}}}{const Oy=self.C3,By=self.IBehavior;Oy.SDKBehaviorBase=class extends Oy.DefendedBase{constructor(t){super(),this._runtime=t.runtime,this._id=t.id,this._name=t.name??"",this._myObjectClasses=Oy.New(Oy.ArraySet),this._myInstances=Oy.New(Oy.ArraySet),this._sdkVersion=t.sdkVersion,this._scriptInterfaceClass=t.scriptInterfaceClass,this._iBehavior=null}Release(){this._myInstances.Release(),this._myObjectClasses.Release(),this._runtime=null}GetRuntime(){return this._runtime}GetID(){return this._id}GetName(){return this._name}OnCreate(){}GetSdkVersion(){return this._sdkVersion}GetScriptInterfaceClass(t=!1){let e=this._scriptInterfaceClass;return t&&"function"!=typeof e&&this.GetSdkVersion()>=2&&(e=globalThis.ISDKBehaviorBase),e}_AddObjectClass(t){this._myObjectClasses.Add(t)}GetObjectClasses(){return this._myObjectClasses.GetArray()}_AddInstance(t){this._myInstances.Add(t)}_RemoveInstance(t){this._myInstances.Delete(t)}GetInstances(){return this._myInstances.GetArray()}_InitScriptInterface(){const t=this.GetSdkVersion();Oy.AddonManager._PushInitObject(this,t);const e=this.GetScriptInterfaceClass(!0);if(e){if(this._iBehavior=new e,!(this._iBehavior instanceof By))throw new TypeError("behavior class must derive from IBehavior")}else this._iBehavior=new By;Oy.AddonManager._PopInitObject(t)}GetIBehavior(){return this._iBehavior}}}{const Ly=self.C3;Ly.SDKBehaviorTypeBase=class extends Ly.DefendedBase{constructor(t){super(),this._runtime=t.GetRuntime(),this._behaviorType=t,this._objectClass=t.GetObjectClass(),this._behavior=t.GetBehavior(),this._behavior._AddObjectClass(this._objectClass)}Release(){this._runtime=null,this._behaviorType=null,this._objectClass=null,this._behavior=null}OnCreate(){}GetBehaviorType(){return this._behaviorType}GetObjectClass(){return this._objectClass}GetRuntime(){return this._runtime}GetBehavior(){return this._behavior}}}{const ky=self.C3;ky.SDKBehaviorInstanceBase=class extends ky.DefendedBase{constructor(t,e){super(),this._behInst=t,this._domComponentId=e,this._inst=t.GetObjectInstance(),this._runtime=t.GetRuntime(),this._behaviorType=t.GetBehaviorType(),this._sdkType=this._behaviorType.GetSdkType(),this._isTicking=!1,this._isTicking2=!1,this._isPostTicking=!1,this._disposables=null}Release(){this._StopTicking(),this._StopTicking2(),this._StopPostTicking(),this._disposables&&(this._disposables.Release(),this._disposables=null),this._behInst=null,this._inst=null,this._runtime=null,this._behaviorType=null,this._sdkType=null}GetBehavior(){return this._behaviorType.GetBehavior()}GetBehaviorInstance(){return this._behInst}GetObjectInstance(){return this._inst}GetObjectClass(){return this._inst.GetObjectClass()}GetWorldInfo(){return this._inst.GetWorldInfo()}GetRuntime(){return this._runtime}GetBehaviorType(){return this._behaviorType}GetSdkType(){return this._sdkType}GetScriptInterface(){return this._behInst.GetScriptInterface()}Trigger(t){return this._runtime.Trigger(t,this._inst,this._behaviorType)}DebugTrigger(t){return this._runtime.DebugTrigger(t,this._inst,this._behaviorType)}TriggerAsync(t){return this._runtime.TriggerAsync(t,this._inst,this._behaviorType)}PostCreate(){}Tick(){}Tick2(){}PostTick(){}_StartTicking(){this._isTicking||(this._runtime._AddBehInstToTick(this),this._isTicking=!0)}_StopTicking(){this._isTicking&&(this._runtime._RemoveBehInstToTick(this),this._isTicking=!1)}IsTicking(){return this._isTicking}_StartTicking2(){this._isTicking2||(this._runtime._AddBehInstToTick2(this),this._isTicking2=!0)}_StopTicking2(){this._isTicking2&&(this._runtime._RemoveBehInstToTick2(this),this._isTicking2=!1)}IsTicking2(){return this._isTicking2}_StartPostTicking(){this._isPostTicking||(this._runtime._AddBehInstToPostTick(this),this._isPostTicking=!0)}_StopPostTicking(){this._isPostTicking&&(this._runtime._RemoveBehInstToPostTick(this),this._isPostTicking=!1)}IsPostTicking(){return this._isPostTicking}GetDebuggerProperties(){return[]}AddDOMMessageHandler(t,e){this._runtime.AddDOMComponentMessageHandler(this._domComponentId,t,e)}OnSpriteFrameChanged(t,e){}SaveToJson(){return null}LoadFromJson(t){}GetPropertyValueByIndex(t){}SetPropertyValueByIndex(t,e){}OffsetPropertyValueByIndex(t,e){if(0===e)return;const s=this.GetPropertyValueByIndex(t);if("number"!=typeof s)throw new Error("expected number");this.SetPropertyValueByIndex(t,s+e)}SetPropertyColorOffsetValueByIndex(t,e,s,i){}CallAction(t,...e){t.call(this,...e)}CallExpression(t,...e){return t.call(this,...e)}GetScriptInterfaceClass(){return null}DispatchScriptEvent(t,e,s){if(!this._behInst.HasScriptInterface())return;const i=this.GetScriptInterface(),r=ky.New(ky.Event,t,e);r.behaviorInstance=i,r.instance=i.instance,s&&Object.assign(r,s),i.dispatchEvent(r)}}}{let Ny=function(t){if(t!==Wy)throw new Error("invalid internal API token")};0;const Uy=self.C3;Uy.Plugins={},Uy.Behaviors={};const Wy=Uy._GetInternalAPIToken();let jy=[],Vy=[],zy=[],Hy=null,Yy=null,Xy=null,qy=null;const Jy=new Map,Qy=new Map;Uy.AddonManager=class extends Uy.DefendedBase{#e=null;#t=[];#i=null;#s=[];#r=new Map;#a=null;#h=null;#n;constructor(t,e){super(),this.#e=t,this.#n=new Set(e)}CreatePlugin(t){const e=t[19],s=this.#e.GetObjectReference(t[0]);if(!s)throw new Error("missing plugin");Uy.AddCommonACEs(t,s,e);const i=e>=2?Uy.SDKPluginBase:s,r=Uy.New(i,{runtime:this.#e,isSingleGlobal:t[1],isWorld:t[2],isRotatable:t[5],hasEffects:t[8],mustPredraw:t[9],supportsSceneGraph:t[13],supportsMesh:t[14],isHTMLElementType:t[17],is3d:t[18],sdkVersion:e,id:t[20],name:t[21],scriptInterfaceClass:e>=2?s:null,exportData:t[22]});r.OnCreate(),this.#t.push(r),Jy.set(s,r)}CreateSystemPlugin(){this.#i=Uy.New(Uy.Plugins.System,{runtime:this.#e,isSingleGlobal:!0}),this.#i.OnCreate()}CreateBehavior(t){const e=t[1],s=t[2],i=t[3],r=this.#e.GetObjectReference(t[0]);if(!r)throw new Error("missing behavior");this.#r.set(r,()=>{const t=e>=2?Uy.SDKBehaviorBase:r,n=Uy.New(t,{runtime:this.#e,id:s,name:i,sdkVersion:e,scriptInterfaceClass:e>=2?r:null});n.OnCreate(),this.#s.push(n),Qy.set(r,n),!this.#a&&Uy.Behaviors.solid&&n instanceof Uy.Behaviors.solid?this.#a=n:!this.#h&&Uy.Behaviors.jumpthru&&n instanceof Uy.Behaviors.jumpthru&&(this.#h=n),n._InitScriptInterface()})}_DelayCreateBehavior(t){const e=this.#r.get(t);e&&(e(),this.#r.delete(t))}static _PushInitObject(t,e=1){if(Uy.AddonManager._PushInitObject!==Hy)throw new Error("invalid method");1===e&&jy.push(t),Vy.push(t)}static _PopInitObject(t=1){if(Uy.AddonManager._PopInitObject!==Yy)throw new Error("invalid method");1===t&&jy.pop(),Vy.pop()}static _GetInitObject(){if(Uy.AddonManager._GetInitObject!==Xy)throw new Error("invalid method");if(0===jy.length)throw new Error("no init object set");return jy.at(-1)}static _GetInitObject2(t){if(Uy.AddonManager._GetInitObject2!==qy)throw new Error("invalid method");if(Ny(t),0===Vy.length)throw new Error("no init object set");return Vy.at(-1)}static _PushInitProperties(t){zy.push(t)}static _PopInitProperties(){zy.pop()}static _GetInitProperties(){if(0===zy.length)throw new Error("no init properties set");return zy.at(-1)}_InitAddonScriptInterfaces(){for(const t of this.#t)t._InitScriptInterface()}static GetPluginByConstructorFunction(t){return Jy.get(t)||null}static GetBehaviorByConstructorFunction(t){return Qy.get(t)||null}GetSystemPlugin(){return this.#i}GetSolidBehavior(){return this.#a}GetJumpthruBehavior(){return this.#h}HasWrapperComponentId(t){return this.#n.has(t)}},Hy=Uy.AddonManager._PushInitObject,Yy=Uy.AddonManager._PopInitObject,Xy=Uy.AddonManager._GetInitObject,qy=Uy.AddonManager._GetInitObject2}{const Ky=self.C3,Zy=new Set;Ky.ImageInfo=class extends Ky.DefendedBase{constructor(){super(),this._generation=0,this._url="",this._size=0,this._offsetX=0,this._offsetY=0,this._width=0,this._height=0,this._isRotated=!1,this._hasMetaData=!1,this._imageAsset=null,this._textureState="",this._rcTex=Ky.New(Ky.Rect),this._quadTex=Ky.New(Ky.Quad),this._blobUrl="",this._iImageInfo=new self.IImageInfo(this),Zy.add(this)}Release(){this.ReleaseTexture(),this._imageAsset&&0===this._imageAsset.GetRefCount()&&this._imageAsset.Release(),this._imageAsset=null,Zy.delete(this),this.ReleaseBlobURL()}static OnRendererContextLost(){for(const t of Zy)t._textureState="",t._rcTex.set(0,0,0,0),t._quadTex.setFromRect(t._rcTex)}LoadData(t){this._url=t[0],this._size=t[1],this._offsetX=t[2],this._offsetY=t[3],this._width=t[4],this._height=t[5],this._isRotated=t[6],this._hasMetaData=!0}LoadDynamicAsset(t,e,s){if(s=!!s,this._imageAsset)throw new Error("already loaded asset");this._url=e;const i={isTiled:s};return Ky.IsAbsoluteURL(e)&&(i.loadPolicy="remote"),this.LoadAsset(t,i),this._imageAsset.Load()}LoadDynamicBlobAsset(t,e){if(this._imageAsset)throw new Error("already loaded asset");this._url="",this._size=e.size,this._imageAsset=Ky.New(Ky.ImageAsset,t.GetAssetManager(),{blob:e,size:this._size,loadPolicy:"local"})}ReplaceWith(t){if(t===this)throw new Error("cannot replace with self");this._generation++,this.ReleaseTexture(),this._url=t._url,this._size=t._size,this._offsetX=t._offsetX,this._offsetY=t._offsetY,this._width=t._width,this._height=t._height,this._isRotated=t._isRotated,this._hasMetaData=t._hasMetaData,this._imageAsset=t._imageAsset,this._textureState=t._textureState,this._rcTex=t._rcTex,this._quadTex=t._quadTex,this.ReleaseBlobURL()}GetURL(){return this._url}GetSize(){return this._size}GetOffsetX(){return this._offsetX}GetOffsetY(){return this._offsetY}IsRotated(){return this._isRotated}GetWidth(){return this._width}GetHeight(){return this._height}GetSheetWidth(){return this._imageAsset.GetWidth()}GetSheetHeight(){return this._imageAsset.GetHeight()}LoadAsset(t,e){if(this._imageAsset)throw new Error("already got asset");e=Object.assign({},e,{url:this.GetURL(),size:this.GetSize()}),this._imageAsset=t.LoadImage(e)}IsLoaded(){return this._imageAsset&&this._imageAsset.IsLoaded()}async LoadStaticTexture(t,e){if(!this._imageAsset)throw new Error("no asset");if(this._textureState)throw new Error("already loaded texture");const s=this._generation;this._textureState="loading";const i=await this._imageAsset.LoadStaticTexture(t,e);if(this._generation!==s)return null;if(!i)return this._textureState="",null;this._textureState="loaded",this._hasMetaData||(this._width=i.GetWidth(),this._height=i.GetHeight(),this._hasMetaData=!0);const r=this._isRotated?this._height:this._width,n=this._isRotated?this._width:this._height;return this._rcTex.set(this._offsetX,this._offsetY,this._offsetX+r,this._offsetY+n),this._rcTex.divide(i.GetWidth(),i.GetHeight()),this._quadTex.setFromRect(this._rcTex),this._isRotated&&this._quadTex.rotatePointsAnticlockwise(),i}ReleaseTexture(){this._textureState&&(this._imageAsset&&this._imageAsset.ReleaseTexture(),this._textureState="",this._rcTex.set(0,0,0,0),this._quadTex.setFromRect(this._rcTex))}GetTexture(){return this._imageAsset&&"loaded"===this._textureState?this._imageAsset.GetTexture():null}GetTexRect(){return this._rcTex}GetTexQuad(){return this._quadTex}GetIImageInfo(){return this._iImageInfo}GetImageAsset(){return this._imageAsset}async ExtractImageToCanvas(t){t||(t=await this._imageAsset.LoadToDrawable()),this._hasMetaData||(this._width=t.width,this._height=t.height,this._hasMetaData=!0);const e=Ky.CreateCanvas(this._width,this._height),s=e.getContext("2d");return this._isRotated?(s.rotate(Math.PI/-2),s.translate(-this._height,0),s.drawImage(t,this._offsetX,this._offsetY,this._height,this._width,0,0,this._height,this._width)):s.drawImage(t,this._offsetX,this._offsetY,this._width,this._height,0,0,this._width,this._height),e}async ExtractImageToBlobURL(t){if(this._blobUrl)return this._blobUrl;const e=await this.ExtractImageToCanvas(t),s=await Ky.CanvasToBlob(e);return this._blobUrl=URL.createObjectURL(s),this._blobUrl}ReleaseBlobURL(){this._blobUrl&&(URL.revokeObjectURL(this._blobUrl),this._blobUrl="")}}}{const $y=self.C3;$y.AnimationInfo=class extends $y.DefendedBase{constructor(t){super(),this._name=t[0],this._speed=t[1],this._isLooping=!!t[2],this._repeatCount=t[3],this._repeatTo=t[4],this._isPingPong=!!t[5],this._sid=t[6],this._frames=t[7].map(t=>$y.New($y.AnimationFrameInfo,t)),this._iAnimation=new self.IAnimation(this)}static CreateDynamic(t,e){const s=$y.New($y.AnimationInfo,[e,0,!1,0,0,!1,Math.floor(1e15*Math.random()),[]]);return s._frames.push($y.AnimationFrameInfo.CreateDynamic(t)),s}Release(){for(const t of this._frames)t.Release();$y.clearArray(this._frames)}LoadAllAssets(t){for(const e of this._frames)e.GetImageInfo().LoadAsset(t)}LoadAllTextures(t,e){return Promise.all(this._frames.map(s=>s.GetImageInfo().LoadStaticTexture(t,e)))}ReleaseAllTextures(){for(const t of this._frames)t.GetImageInfo().ReleaseTexture()}GetName(){return this._name}GetSID(){return this._sid}GetFrameCount(){return this._frames.length}GetFrames(){return this._frames}GetFrameAt(t){if((t=Math.floor(t))<0||t>=this._frames.length)throw new RangeError("invalid frame");return this._frames[t]}InsertFrameAt(t,e){(e=Math.floor(e))<0?this._frames.unshift(t):e>=this._frames.length?this._frames.push(t):this._frames.splice(e,0,t)}RemoveFrameAt(t){if((t=Math.floor(t))<0||t>=this._frames.length)throw new RangeError("invalid frame");this._frames[t].Release(),this._frames.splice(t,1)}GetFrameIndexByTag(t){for(let e=0,s=this._frames.length;e<s;++e)if($y.equalsNoCase(this._frames[e].GetTag(),t))return e;return-1}FrameTagOrIndexToIndex(t){if("string"==typeof t){const e=this.GetFrameIndexByTag(t);if(-1===e)throw new Error(`cannot find animation frame with tag ${t}`);return e}return t}GetSpeed(){return this._speed}IsLooping(){return this._isLooping}GetRepeatCount(){return this._repeatCount}GetRepeatTo(){return this._repeatTo}IsPingPong(){return this._isPingPong}GetIAnimation(){return this._iAnimation}}}{const tG=self.C3,eG=(()=>{const t=atob("iVBORw0KGgoAAAANSUhEUgAAAGQAAABkAQMAAABKLAcXAAAAAXNSR0IArs4c6QAAAANQTFRFAAAAp3o92gAAAAF0Uk5TAEDm2GYAAAATSURBVBgZYxgFo2AUjIJRQFcAAAV4AAHcRQIbAAAAAElFTkSuQmCC"),e=new Uint8Array(t.length);for(let s=0,i=t.length;s<i;++s)e[s]=t.charCodeAt(s);return new Blob([e],{type:"image/png"})})();tG.AnimationFrameInfo=class extends tG.DefendedBase{constructor(t){super(),this._imageInfo=tG.New(tG.ImageInfo),this._imageInfo.LoadData(t),this._duration=t[7],this._origin=tG.New(tG.Vector2,t[8],t[9]),this._imagePoints=t[10].map(t=>tG.New(tG.ImagePoint,this,t)),this._imagePointsByName=new Map;for(const t of this._imagePoints)this._imagePointsByName.set(t.GetName().toLowerCase(),t);this._collisionPoly=null;const e=t[11];e.length>=6&&(this._collisionPoly=tG.New(tG.CollisionPoly,e)),this._tag=t[12]?t[12]:"",this._iAnimationFrame=new self.IAnimationFrame(this)}static CreateDynamic(t){const e=tG.New(tG.AnimationFrameInfo,["",0,0,0,100,100,!1,1,0,0,[],[],""]);return e._imageInfo.LoadDynamicBlobAsset(t,eG),e}Release(){this._collisionPoly&&(this._collisionPoly.Release(),this._collisionPoly=null),this._imageInfo.Release(),this._imageInfo=null}GetImageInfo(){return this._imageInfo}GetDuration(){return this._duration}GetOriginX(){return this._origin.getX()}GetOriginY(){return this._origin.getY()}GetCollisionPoly(){return this._collisionPoly}GetImagePointByName(t){return this._imagePointsByName.get(t.toLowerCase())||null}GetImagePointByIndex(t){return(t=Math.floor(t))<0||t>=this._imagePoints.length?null:this._imagePoints[t]}GetImagePointCount(){return this._imagePoints.length}GetTag(){return this._tag}GetIAnimationFrame(){return this._iAnimationFrame}}}{const sG=self.C3;sG.ImagePoint=class extends sG.DefendedBase{constructor(t,e){super(),this._afi=t,this._name=e[0],this._pos=sG.New(sG.Vector2,e[1],e[2])}Release(){}GetName(){return this._name}GetX(){return this._pos.getX()}GetY(){return this._pos.getY()}GetVec2(){return this._pos}}}{const iG=globalThis.C3,rG=globalThis.C3Debugger,nG=(globalThis.IObjectClass,globalThis.IObjectType),aG=globalThis.IFamily;globalThis.assert;iG.ObjectClass=class extends iG.DefendedBase{constructor(t,e,s){super();const i=t.GetObjectReference(s[1]);this._runtime=t,this._plugin=iG.AddonManager.GetPluginByConstructorFunction(i),this._sdkType=null,this._instSdkCtor=i.Instance,this._index=e,this._sid=s[11],this._name=s[0],this._jsPropName=this._runtime.GetJsPropName(s[14]),this._isGlobal=!!s[9],this._isFamily=!!s[2],this._isOnLoaderLayout=!!s[10],this._instVars=s[3].map(e=>({sid:e[0],type:e[1],name:e[2],jsPropName:t.GetJsPropName(e[3])})),this._behaviorsCount=s[4],this._effectsCount=s[5],this._isWorldType=this._plugin.IsWorldType(),this._dispatcher=iG.New(iG.Event.Dispatcher),this._effectList=null;const[r,n]=t.GetCollisionEngine().GetCollisionCellSize();if(this._collisionGrid=iG.New(iG.SparseGrid,r,n),this._anyCollisionCellChanged=!0,this._familyMembers=null,this._familyMembersSet=null,this._familyIndex=-1,this._families=null,this._familiesSet=null,this._familyInstVarMap=null,this._familyBehaviorMap=null,this._familyEffectMap=null,this._isInContainer=!1,this._container=null,this._behaviorTypes=s[8].map(t=>iG.BehaviorType.Create(this,t)),this._behaviorTypesIncludingInherited=[],this._behaviorsByName=new Map,this._behaviorNameToIndex=new Map,this._usedBehaviorCtors=new Set,this._customActionMap=new Map,this._solStack=iG.New(iG.SolStack,this),this._defaultInstanceData=null,this._defaultLayerIndex=0,this._isContained=!1,this._container=null,this._imageInfo=null,this._animations=null,this._animationsByName=null,this._animationsBySid=null,this._textureRefCount=0,this._savedData=new Map,this._instances=[],this._worldInfosByLayer=new Map,this._iidsStale=!0,this._plugin.HasEffects()&&(this._effectList=iG.New(iG.EffectList,this,s[12])),s[6]&&(this._imageInfo=iG.New(iG.ImageInfo),this._imageInfo.LoadData(s[6])),s[7]){this._animations=s[7].map(t=>iG.New(iG.AnimationInfo,t)),this._animationsByName=new Map,this._animationsBySid=new Map;for(const t of this._animations)this._animationsByName.set(t.GetName().toLowerCase(),t),this._animationsBySid.set(t.GetSID(),t)}this._isFamily?(this._familyMembers=[],this._familyMembersSet=new Set,this._familyIndex=this._runtime._GetNextFamilyIndex()):(this._families=[],this._familiesSet=new Set,this._familyInstVarMap=[],this._familyBehaviorMap=[],this._familyEffectMap=[]);const a=this._plugin.GetSdkVersion();if(a<2&&(this._sdkType=iG.New(i.Type,this,s[15]),!(this._sdkType instanceof iG.SDKTypeBase)))throw new Error("v1 sdk type must derive from SDKTypeBase");let o;if(this._iObjectClass=null,this._instanceUserScriptClass=null,this._userScriptDispatcher=iG.New(iG.Event.Dispatcher),iG.AddonManager._PushInitObject(this,a),a>=2?(o=i.Type,o||(o=globalThis.ISDKObjectTypeBase)):o=this._sdkType.GetScriptInterfaceClass(),o&&!this._isFamily){if(this._iObjectClass=new o(a<2?this:null),a<2&&!(this._iObjectClass instanceof nG))throw new TypeError("script interface class must derive from IObjectType");if(a>=2&&!(this._iObjectClass instanceof globalThis.ISDKObjectTypeBase))throw new TypeError("script interface class must derive from ISDKObjectTypeBase")}else{const t=this._isFamily?aG:nG;this._iObjectClass=new t}if(iG.AddonManager._PopInitObject(a),s[13]){const t=s[13];if(t){const e=t[0],s=t[1],i=t[2];this._sdkType.LoadTilemapData(e,s,i)}}this._runtime.UsesLoaderLayout()&&!this._isFamily&&!this._isOnLoaderLayout&&this._isWorldType||this.OnCreate(),this._plugin.IsSingleGlobal()&&(this._plugin._SetSingleGlobalObjectClass(this),this._CreateSingleGlobalInstance(s)),this._loadInstancesJson=null}static Create(t,e,s){return iG.New(iG.ObjectClass,t,e,s)}Release(){if(this._dispatcher.Release(),this._dispatcher=null,this._imageInfo&&(this._imageInfo.Release(),this._imageInfo=null),this._animations){for(const t of this._animations)t.Release();iG.clearArray(this._animations),this._animationsByName.clear(),this._animationsBySid.clear()}this._loadInstancesJson=null,this._solStack.Release(),this._solStack=null,this._savedData.clear(),this._container=null,this._runtime=null}_LoadFamily(t){for(let e=1,s=t.length;e<s;++e){const s=this._runtime.GetObjectClassByIndex(t[e]);this._familyMembers.push(s),this._familyMembersSet.add(s),s._families.push(this),s._familiesSet.add(this)}}_SetContainer(t){this._isInContainer=!0,this._container=t}IsInContainer(){return this._isInContainer}GetContainer(){return this._container}_OnAfterCreate(){let t=0;if(!this._isFamily)for(const e of this._families)for(const s of e.GetBehaviorTypes()){const e=s.GetName().toLowerCase();this._behaviorsByName.set(e,s),this._behaviorNameToIndex.set(e,t),this._behaviorTypesIncludingInherited.push(s),++t}for(const e of this.GetBehaviorTypes()){const s=e.GetName().toLowerCase();this._behaviorsByName.set(s,e),this._behaviorNameToIndex.set(s,t),this._behaviorTypesIncludingInherited.push(e),++t}for(const t of this._behaviorTypesIncludingInherited)this._usedBehaviorCtors.add(t.GetBehavior().constructor);if(!this._isFamily&&this._families.length){const t=this._runtime.GetFamilyCount();iG.extendArray(this._familyInstVarMap,t,0),iG.extendArray(this._familyBehaviorMap,t,0),iG.extendArray(this._familyEffectMap,t,0);const e=[];let s=0,i=0,r=0;for(const t of this._families){const n=t.GetFamilyIndex();this._familyInstVarMap[n]=s,s+=t.GetInstanceVariablesCount(),this._familyBehaviorMap[n]=i,i+=t.GetBehaviorTypesCount(),this._familyEffectMap[n]=r,r+=t.GetEffectTypesCount();const a=t.GetEffectList();if(a&&this._effectList)for(const t of a.GetAllEffectTypes())e.push(t.Clone(this._effectList))}this._effectList&&this._effectList.PrependEffectTypes(e)}}_CreateSingleGlobalInstance(t){const e=iG.IsFiniteNumber(t[17])?t[17]:this._runtime._GetNewUID(),s=iG.New(iG.Instance,{runtime:this._runtime,objectType:this,uid:e});s._CreateSdkInstance(t[16],[]),this._runtime._MapInstanceByUID(e,s),this._instances.push(s)}GetSdkType(){return this._sdkType}IsOnLoaderLayout(){return this._isOnLoaderLayout}Dispatcher(){return this._dispatcher}OnCreate(){this._isFamily||(this._sdkType?this._sdkType.OnCreate():this._iObjectClass._onCreate())}HasLoadedTextures(){return this._textureRefCount>0}async LoadTextures(t){this._isFamily||(this._textureRefCount++,1===this._textureRefCount&&(this._sdkType?await this._sdkType.LoadTextures(t):await this._iObjectClass._loadTextures(this._runtime.GetCanvasManager().GetIRenderer())))}ReleaseTextures(){if(!this._isFamily){if(this._textureRefCount--,this._textureRefCount<0)throw new Error("released textures too many times");0===this._textureRefCount&&(this._sdkType?this._sdkType.ReleaseTextures():this._iObjectClass._releaseTextures(this._runtime.GetCanvasManager().GetIRenderer()))}}OnDynamicTextureLoadComplete(){if(this._isFamily)throw new Error("not applicable to family");this._sdkType?this._sdkType.OnDynamicTextureLoadComplete():this._iObjectClass._onDynamicTextureLoadComplete()}async PreloadTexturesWithInstances(t){this._isFamily||(this._sdkType?await this._sdkType.PreloadTexturesWithInstances(t):await this._iObjectClass._preloadTexturesWithInstances(this._runtime.GetCanvasManager().GetIRenderer()))}GetRuntime(){return this._runtime}GetPlugin(){return this._plugin}GetInstanceSdkCtor(){return this._instSdkCtor}GetName(){return this._name}GetJsPropName(){return this._jsPropName}GetIndex(){return this._index}GetSID(){return this._sid}IsFamily(){return this._isFamily}IsGlobal(){return this._isGlobal}IsWorldType(){return this._isWorldType}GetFamilyIndex(){return this._familyIndex}GetBehaviorTypes(){return this._behaviorTypes}GetBehaviorTypesCount(){return this._behaviorsCount}UsesBehaviorByCtor(t){return t&&this._usedBehaviorCtors.has(t)}GetInstanceVariablesCount(){return this._instVars.length}GetInstanceVariableSIDs(){return this._instVars.map(t=>t.sid)}GetInstanceVariableIndexBySID(t){return this._instVars.findIndex(e=>e.sid===t)}GetInstanceVariableIndexByName(t){return this._instVars.findIndex(e=>e.name===t)}_GetAllInstanceVariableNames(){return this._instVars.map(t=>t.name)}_GetAllInstanceVariableJsPropNames(){return this._instVars.map(t=>t.jsPropName)}GetInstanceVariableType(t){if((t=Math.floor(t))<0||t>=this._instVars.length)throw new RangeError("invalid instance variable index");return this._instVars[t].type}GetInstanceVariableName(t){if((t=Math.floor(t))<0||t>=this._instVars.length)throw new RangeError("invalid instance variable index");return this._instVars[t].name}GetEffectTypesCount(){return this._effectsCount}GetBehaviorTypesIncludingInherited(){return this._behaviorTypesIncludingInherited}GetBehaviorTypeByName(t){return this._behaviorsByName.get(t.toLowerCase())||null}GetBehaviorIndexByName(t){const e=this._behaviorNameToIndex.get(t.toLowerCase());return void 0===e?-1:e}GetEffectList(){return this._effectList}HasEffects(){return this._plugin.HasEffects()}UsesEffects(){return this._effectList&&this._effectList.HasAnyEffectType()}GetSolStack(){return this._solStack}GetCurrentSol(){return this._solStack.GetCurrentSol()}GetImageInfo(){return this._imageInfo}SetDefaultInstanceData(t){this._defaultInstanceData=t}GetDefaultInstanceData(){return this._defaultInstanceData}_SetDefaultLayerIndex(t){this._defaultLayerIndex=t}GetDefaultLayerIndex(){return this._defaultLayerIndex}GetAnimations(){return this._animations}GetAnimationCount(){return this._animations.length}GetFamilies(){return this._families}BelongsToFamily(t){return this._familiesSet.has(t)}GetFamilyMembers(){return this._familyMembers}FamilyHasMember(t){return this._familyMembersSet.has(t)}GetFamilyBehaviorOffset(t){return this._familyBehaviorMap[t]}GetFamilyInstanceVariableOffset(t){return this._familyInstVarMap[t]}AddCustomAction(t){this._customActionMap.set(t.GetACEName().toLowerCase(),t)}HasOwnCustomActionByName(t){return!!this.GetOwnCustomActionByName(t)}GetOwnCustomActionByName(t){const e=this._customActionMap.get(t.toLowerCase());return e&&e.IsEnabled()?e:null}GetAllAnimations(){return this._animations}GetAnimationByName(t){if(!this._animations)throw new Error("no animations");return this._animationsByName.get(t.toLowerCase())||null}GetAnimationBySID(t){if(!this._animations)throw new Error("no animations");return this._animationsBySid.get(t)||null}AddAnimation(t){if(this.GetAnimationByName(t))throw new Error(`animation name '${t}' already exists`);const e=iG.AnimationInfo.CreateDynamic(this.GetRuntime(),t);return this._animations.push(e),this._animationsByName.set(e.GetName().toLowerCase(),e),this._animationsBySid.set(e.GetSID(),e),e}RemoveAnimation(t){const e=this.GetAnimationByName(t);if(!e)throw new Error(`animation name '${t}' does not exist`);if(1===this._animations.length)throw new Error("cannot remove last animation");const s=this._animations.indexOf(e);this._animations.splice(s,1),this._animationsByName.delete(e.GetName().toLowerCase()),this._animationsBySid.delete(e.GetSID()),e.Release()}GetFirstAnimation(){if(!this._animations)throw new Error("no animations");return this._animations[0]}GetFirstAnimationFrame(){return this.GetFirstAnimation().GetFrameAt(0)}GetDefaultInstanceSize(){if(this._animations){const t=this.GetFirstAnimationFrame().GetImageInfo();return[t.GetWidth(),t.GetHeight()]}return this._imageInfo?[this._imageInfo.GetWidth(),this._imageInfo.GetHeight()]:[100,100]}GetSingleGlobalInstance(){if(!this._plugin.IsSingleGlobal())throw new Error("not a single-global plugin");return this._instances[0]}GetInstances(){return this._instances}*instances(){yield*this._instances}*instancesIncludingPendingCreate(){yield*this._instances,yield*this._runtime.instancesPendingCreateForObjectClass(this)}GetInstanceCount(){return this._instances.length}_AddInstance(t){this._instances.push(t)}_SetIIDsStale(){this._iidsStale=!0}_UpdateIIDs(){if(!this._iidsStale||this._isFamily)return;const t=this._instances;let e=0;for(let s=t.length;e<s;++e)t[e]._SetIID(e);const s=this._runtime._GetInstancesPendingCreate();for(const t of s)t.GetObjectClass()===this&&t._SetIID(e++);this._iidsStale=!1}GetInstanceByIID(t){const e=this._instances;if(t<e.length)return e[t];t-=e.length;const s=this._runtime._GetInstancesPendingCreate();for(const e of s)if(e.GetObjectClass()===this){if(0===t)return e;--t}return null}GetFirstPicked(t){if(t&&t.IsInContainer()&&t.GetObjectClass()!==this)for(const e of t.siblings())if(e.GetObjectClass()===this)return e;const e=this.GetCurrentSol().GetInstances();return e.length?e[0]:null}GetPairedInstance(t){const e=this.GetCurrentSol().GetInstances();return e.length>0?e[t.GetIID()%e.length]:null}*allCorrespondingInstances(t,e){const s=this.GetCurrentSol().GetInstances(),i=s.length,r=e.GetCurrentSol(),n=e.GetCurrentSol().GetInstances(),a=n.length;let o=t.GetIID();!e.IsFamily()&&r.IsSelectAll()||(o=n.indexOf(t));const h=Math.ceil(i/a),l=i%a;let c=0,u=0;0===l||o<l?(c=o*h,u=h):(c=l*h+(o-l)*(h-1),u=h-1);for(let t=c,e=c+u;t<e;++t)yield s[t]}FinishCondition(t){this._sdkType?.FinishCondition(t)}ApplySolToContainer(){if(!this._isInContainer||this._isFamily)return;this._UpdateIIDs();const t=this.GetCurrentSol(),e=t._GetOwnInstances(),s=t.IsSelectAll(),i=this._runtime.GetCurrentEventStackFrame(),r=i&&i.GetCurrentEvent()&&i.GetCurrentEvent().IsOrBlock();for(const i of this._container.objectTypes()){if(i===this)continue;i._UpdateIIDs();const n=i.GetCurrentSol();if(n._SetSelectAll(s),!s){const s=n._GetOwnInstances();iG.clearArray(s);for(const t of e)s.push(i.GetInstanceByIID(t.GetIID()));if(r){const e=t._GetOwnElseInstances(),s=n._GetOwnElseInstances();iG.clearArray(s);for(const t of e)s.push(i.GetInstanceByIID(t.GetIID()))}}}}_TruncateContainerSols(t,e){for(const s of this.GetContainer().objectTypes()){const i=s.GetCurrentSol();t?iG.truncateArray(i._GetOwnElseInstances(),e):iG.truncateArray(i._GetOwnInstances(),e)}}_GetCollisionCellGrid(){return this._collisionGrid}_SetAnyCollisionCellChanged(t){this._anyCollisionCellChanged=!!t}_UpdateAllCollisionCells(){if(this._anyCollisionCellChanged&&this._isWorldType){for(const t of this._instances)t.GetWorldInfo()._UpdateCollisionCell();for(const t of this._runtime._GetInstancesPendingCreate())t.GetObjectClass()===this&&t.GetWorldInfo()._UpdateCollisionCell();this._anyCollisionCellChanged=!1}}_OnWorldInstanceLayerChanged(t,e,s){if(e){const s=this._worldInfosByLayer.get(e);s&&(s.delete(t),0===s.size&&this._worldInfosByLayer.delete(e))}if(s){let e=this._worldInfosByLayer.get(s);e||(e=new Set,this._worldInfosByLayer.set(s,e)),e.add(t)}}*layersHasInstancesOn(){if(this.IsFamily()){const t=new Set;for(const e of this._familyMembers)for(const s of e.layersHasInstancesOn())t.add(s);yield*t.values()}else for(const t of this._worldInfosByLayer.keys())t.WasReleased()||(yield t)}GetSavedDataMap(){return this._savedData||(this._savedData=new Map),this._savedData}HasSolidBehavior(){return this.UsesBehaviorByCtor(iG.Behaviors.solid)}HasJumpthruBehavior(){return this.UsesBehaviorByCtor(iG.Behaviors.jumpthru)}HasNoSaveBehavior(){return this.UsesBehaviorByCtor(iG.Behaviors.NoSave)}HasPersistBehavior(){return this.UsesBehaviorByCtor(iG.Behaviors.Persist)}_SaveToJson(){const t={instances:this._instances.map(t=>t.SaveToJson())};return this._savedData&&this._savedData.size&&(t.ex=iG.ToSuperJSON(this._savedData)),t}_LoadFromJson(t,e){this._savedData&&(this._savedData.clear(),this._savedData=null);const s=t.ex;s&&(this._savedData=iG.FromSuperJSON(s));const i=this._instances,r=t.instances;for(let t=0,e=Math.min(i.length,r.length);t<e;++t)i[t].LoadFromJson(r[t]);for(let t=r.length,e=i.length;t<e;++t)this._runtime.DestroyInstance(i[t]);for(let t=i.length,s=r.length;t<s;++t){const s=r[t];let i=null;if(this.IsWorldType()&&(i=this._runtime.GetMainRunningLayout().GetLayerBySID(s.w.l),!i))continue;const n=this._runtime.CreateInstanceFromData(this._defaultInstanceData||this,i,!1,0,0,!0);n.LoadFromJson(s),e&&e.add(n)}this._loadInstancesJson=r,this._SetIIDsStale()}_GetLoadInstancesJson(){return this._loadInstancesJson}_ClearLoadInstancesJson(){this._loadInstancesJson=null}_SetupSceneGraphConnectionsOnChangeOfLayout(){for(let t=0,e=this._instances;t<e;++t)this._instances[t]._SetupSceneGraphConnectionsOnChangeOfLayout()}GetIObjectClass(){return this._iObjectClass}UserScriptDispatcher(){return this._userScriptDispatcher}_GetUserScriptInstanceClass(){return this._instanceUserScriptClass}_SetUserScriptInstanceClass(t){this._instanceUserScriptClass=t}DispatchUserScriptEvent(t){const e=this._runtime,s=e.IsDebug()&&!e.GetEventSheetManager().IsInEventEngine();s&&rG.StartMeasuringScriptTime(),this._userScriptDispatcher.dispatchEvent(t),s&&rG.AddScriptTime()}}}{const oG=self.C3;oG.Container=class extends oG.DefendedBase{constructor(t,e){super(),this._runtime=t,this._objectTypes=e;for(const t of this._objectTypes)t._SetContainer(this)}Release(){this._runtime=null}GetRuntime(){return this._runtime}GetObjectTypes(){return this._objectTypes}objectTypes(){return this._objectTypes}HasAnyWorldType(){return this._objectTypes.some(t=>t.IsWorldType())}}}{const hG=self.C3,lG=self.C3Debugger,cG=(self.IInstance,hG.AddonManager),uG=[],_G=new Set;let dG=0;const pG=new WeakMap;hG.Instance=class extends hG.DefendedBase{#e=null;constructor(t){if(hG.AddonManager!==cG)throw new Error("invalid addon manager");super(),this._runtime=t.runtime,this._objectType=t.objectType,this._worldInfo=null,this._sdkInst=null,this._iScriptInterface=null,this._iid=0,this._uid=t.uid,this._puid=dG++,this._flags=0;const e=hG.splitStringAndNormalize(t.tags);e.length>0&&this.SetTagsSet(new Set(e)),this._instVarValues=uG,this._behaviorInstances=uG;const s=this._objectType.GetBehaviorTypesIncludingInherited();s.length>0&&(this._behaviorInstances=s.map((t,e)=>hG.New(hG.BehaviorInstance,{runtime:this._runtime,behaviorType:t,instance:this,index:e}))),this._siblings=this._objectType.IsInContainer()?[]:null,this._timeScale=-1,this._dispatcher=null;const i=this.GetPlugin();if(i.MustPreDraw()&&(this._flags|=4),i.IsWorldType())if(this._worldInfo=hG.New(hG.WorldInfo,this,t.layer),t.worldData)this._worldInfo.Init(t.worldData);else{this._worldInfo.InitNoData();const[t,e]=this._objectType.GetDefaultInstanceSize();this._worldInfo.SetSize(t,e),this.GetObjectClass().UsesEffects()&&this._worldInfo.GetInstanceEffectList().LoadDefaultEffectParameters()}t.instVarData?this._LoadInstanceVariableData(t.instVarData):this._LoadDefaultInstanceVariables()}Release(){if(this._iScriptInterface&&(this._iScriptInterface._release(),this._iScriptInterface=null),this._behaviorInstances.length>0){for(const t of this._behaviorInstances)t.Release();hG.clearArray(this._behaviorInstances)}this._sdkInst&&(this._sdkInst.Release(),this._sdkInst=null);const t=pG.get(this);t&&(t.clear(),pG.delete(this)),this._siblings&&hG.clearArray(this._siblings),this._dispatcher&&(this._dispatcher.Release(),this._dispatcher=null),this.#e&&(this.#e.originalTags.clear(),this.#e.lowercaseTags.clear()),this.#e=null,this._runtime=null,this._objectType=null,this._instVarValues.length>0&&hG.clearArray(this._instVarValues),this._worldInfo&&(this._worldInfo.Release(),this._worldInfo=null)}_LoadInstanceVariableData(t){t.length>0&&(this._instVarValues=[],hG.shallowAssignArray(this._instVarValues,t))}_LoadDefaultInstanceVariables(){const t=this._objectType.GetInstanceVariablesCount();if(0===t)return;this._instVarValues=[];const e=[0,0,""];for(let s=0;s<t;++s)this._instVarValues.push(e[this._objectType.GetInstanceVariableType(s)])}_CreateSdkInstance(t,e){if(this._sdkInst)throw new Error("already got sdk instance");for(let t=0,s=this._behaviorInstances.length;t<s;++t)this._behaviorInstances[t]._CreateSdkInstance(e?e[t]:null);if(this.GetPlugin().GetSdkVersion()<2){if(this._sdkInst=hG.New(this._objectType.GetInstanceSdkCtor(),this,t),!(this._sdkInst instanceof hG.SDKInstanceBase))throw new Error("sdk type must derive from SDKInstanceBase");!this.GetPlugin().IsWorldType()&&this._objectType._GetUserScriptInstanceClass()&&this.GetInterfaceClass()}else{const e=this.GetPlugin().GetScriptInterfaceClass();this._InitUserScriptInterface(e.Instance,t)}}GetSdkInstance(){return this._sdkInst??this._iScriptInterface}GetWorldInfo(){return this._worldInfo}GetRuntime(){return this._runtime}GetTimeScale(){return this._timeScale}GetActiveTimeScale(){const t=this._timeScale;return-1===t?this.GetRuntime().GetTimeScale():t}SetTimeScale(t){((t=+t)<0||!isFinite(t))&&(t=0),this._timeScale=t,this.GetObjectClass().UsesEffects()&&this._runtime._SetTrackingInstanceTime(this,!0)}RestoreTimeScale(){this._timeScale=-1,this.GetObjectClass().UsesEffects()&&this._runtime._SetTrackingInstanceTime(this,!1)}GetInstanceGameTime(){return this._runtime._GetInstanceGameTime(this)}Dispatcher(){return this._dispatcher||(this._dispatcher=hG.New(hG.Event.Dispatcher)),this._dispatcher}Draw(t){this._sdkInst?this._sdkInst.Draw(t):this._iScriptInterface._draw(this._runtime.GetCanvasManager().GetIRenderer())}OnCreate(t){this._sdkInst.OnCreate(t)}_SetHasTilemap(){this._flags|=2}HasTilemap(){return!!(2&this._flags)}_MarkDestroyed(){this._flags|=1}IsDestroyed(){return!!(1&this._flags)}MustPreDraw(){return!!(4&this._flags)||(this._sdkInst?this._sdkInst.MustPreDraw():this._iScriptInterface._mustPreDraw())}SetMustMitigateZFighting(){this._flags|=32}MustMitigateZFighting(){return!!(32&this._flags)}_IsSolidEnabled(){return!!(8&this._flags)}_SetSolidEnabled(t){t?this._flags|=8:this._flags&=-9}_IsSolidUsingInstanceTags(){return!!(16&this._flags)}_SetSolidUsingInstanceTags(t){t?this._flags|=16:this._flags&=-17}_IsJumpthruEnabled(){return!!(32&this._flags)}_SetJumpthruEnabled(t){t?this._flags|=32:this._flags&=-33}_IsDrawingWithEffects(){return!!(64&this._flags)}_SetIsDrawingWithEffects(t){t?this._flags|=64:this._flags&=-65}SetFlag(t,e){t<<=16,e?this._flags|=t:this._flags&=~t}GetFlag(t){return!!(this._flags&t<<16)}GetCurrentImageInfo(){return this._sdkInst?this._sdkInst.GetCurrentImageInfo():null}GetCurrentSurfaceSize(){return this._sdkInst?this._sdkInst.GetCurrentSurfaceSize():null}GetCurrentTexRect(){return this._sdkInst?this._sdkInst.GetCurrentTexRect():null}GetCurrentTexQuad(){return this._sdkInst?this._sdkInst.GetCurrentTexQuad():null}IsCurrentTexRotated(){return!!this._sdkInst&&this._sdkInst.IsCurrentTexRotated()}GetImagePoint(t){return this._sdkInst?this._sdkInst.GetImagePoint(t):[this._iScriptInterface.x,this._iScriptInterface.y,this._iScriptInterface.totalZElevation]}GetObjectClass(){return this._objectType}RendersToOwnZPlane(){return this._sdkInst?this._sdkInst.RendersToOwnZPlane():this._iScriptInterface._rendersToOwnZPlane()}BelongsToObjectClass(t){return t.IsFamily()?t.FamilyHasMember(this.GetObjectClass()):this.GetObjectClass()===t}CollectInstancesToPick(t,e,s){const i=(e,s)=>{const i=s||e.GetObjectClass(),r=t.get(i);r?r.add(e):t.set(i,new Set([e]))};if(i(this,e),this.IsInContainer())for(const t of this.siblings())i(t);if(s)for(const t of this.allChildren())i(t)}VerifySupportsSceneGraph(){if(!this.GetPlugin().SupportsSceneGraph())throw new Error("object does not support scene graph")}HasParent(){return null!==this.GetParent()}GetParent(){const t=this.GetWorldInfo();if(!t)return null;const e=t.GetParent();return e?e.GetInstance():null}GetTopParent(){const t=this.GetWorldInfo();if(!t)return null;const e=t.GetTopParent();return e?e.GetInstance():null}*parents(){const t=this.GetWorldInfo();if(t)for(const e of t.parents())yield e.GetInstance()}HasChild(t){if(!t)return!1;for(const e of this.children())if(e===t)return!0;return!1}HasChildren(){const t=this.GetWorldInfo();return!!t&&t.HasChildren()}GetChildrenOfObjectClass(t){const e=this.GetWorldInfo();if(!e)return[];const s=t.GetName();return e.GetChildren().map(t=>t.GetInstance()).filter(t=>t.GetObjectClass().GetName()===s)}GetChildren(){const t=this.GetWorldInfo();return t?t.GetChildren().map(t=>t.GetInstance()):[]}*children(){const t=this.GetWorldInfo();if(t)for(const e of t.children())yield e.GetInstance()}*allChildren(){const t=this.GetWorldInfo();if(t)for(const e of t.allChildren())yield e.GetInstance()}GetChildCount(){const t=this.GetWorldInfo();return t?t.GetChildCount():0}GetParentCount(){return[...this.parents()].length}GetAllChildCount(){const t=this.GetWorldInfo();return t?t.GetAllChildCount():0}GetChildAt(t){const e=this.GetWorldInfo();if(!e)return null;const s=e.GetChildAt(t);return s?s.GetInstance():null}GetIndexInParent(){const t=this.GetWorldInfo();if(!t)return NaN;const e=t.GetParent();return e?e.GetChildIndex(t):NaN}HasChildWithUID(t){for(const e of this.GetWorldInfo().GetChildren())if(e.GetInstance().GetUID()===t)return!0;return!1}AddChild(t,e){this.VerifySupportsSceneGraph(),t.VerifySupportsSceneGraph(),this.GetWorldInfo().AddChild(t.GetWorldInfo(),e||{})}RemoveChild(t){const e=this.GetWorldInfo();e&&e.RemoveChild(t.GetWorldInfo())}GetDestroyWithParent(){const t=this.GetWorldInfo();return!!t&&t.GetDestroyWithParent()}SetupInitialSceneGraphConnections(){const t=this.GetWorldInfo();if(!t)return;const e=t.GetSceneGraphChildrenExportData();if(e)for(const t of e){const e=this._runtime.GetInstanceByUID(t[2]);if(e){const s=t[3];this.AddChild(e,{transformX:!!(1&s),transformY:!!(s>>1&1),transformWidth:!!(s>>2&1),transformHeight:!!(s>>3&1),transformAngle:!!(s>>4&1),destroyWithParent:!!(s>>5&1),transformZElevation:!!(s>>6&1),transformOpacity:!!(s>>7&1),transformVisibility:!!(s>>8&1)})}}}SetupPersistedSceneGraphConnections(t,e){const s=t.get(this);if(s)for(const t of s.sceneGraphJson.children){const s=e.get(t.index);if(!s)continue;const i=t.flags;this.AddChild(s,{transformX:!!(1&i),transformY:!!(i>>1&1),transformWidth:!!(i>>2&1),transformHeight:!!(i>>3&1),transformAngle:!!(i>>4&1),destroyWithParent:!!(i>>5&1),transformZElevation:!!(i>>6&1),transformOpacity:!!(i>>7&1),transformVisibility:!!(i>>8&1)})}}GetTemplateName(){const t=this._runtime.GetTemplateManager();return t?t.GetInstanceTemplateName(this):""}IsInContainer(){return null!==this._siblings}_ClearSiblings(){hG.clearArray(this._siblings)}_AddSibling(t){this._siblings.push(t)}GetSiblings(){return this._siblings}HasSibling(t){return!!this.GetSibling(t)}GetSibling(t){const e=this.siblings();if(null===e||0===e.length)return!1;for(const s of e)if(s.GetObjectClass()===t)return s;return null}siblings(){return this._siblings}SetSiblingsSinglePicked(){for(const t of this.siblings())t.GetObjectClass().GetCurrentSol().SetSinglePicked(t)}_PushSiblingsToSolInstances(){for(const t of this.siblings())t.GetObjectClass().GetCurrentSol()._PushInstance(t)}_SetSiblingsToSolInstancesIndex(t){for(const e of this.siblings())e.GetObjectClass().GetCurrentSol()._GetOwnInstances()[t]=e}_PushSiblingsToSolElseInstances(){for(const t of this.siblings())t.GetObjectClass().GetCurrentSol()._PushElseInstance(t)}_SetSiblingsToSolElseInstancesIndex(t){for(const e of this.siblings())e.GetObjectClass().GetCurrentSol()._GetOwnElseInstances()[t]=e}GetPlugin(){return this._objectType.GetPlugin()}_SetIID(t){this._iid=t}GetIID(){return this._objectType._UpdateIIDs(),this._iid}GetUID(){return this._uid}SetUID(t){this._uid=t}GetPUID(){return this._puid}SetTagsSet(t){if(this.#e&&(this.#e.originalTags.clear(),this.#e.lowercaseTags.clear()),0===t.size)this.#e=null;else{this.#e||(this.#e={originalTags:new Set,lowercaseTags:new Set});for(const e of t){const t=e.toLowerCase();this.#e.lowercaseTags.has(t)||(this.#e.originalTags.add(e),this.#e.lowercaseTags.add(t))}}}GetTagsSet(){return this.#e?this.#e.originalTags:_G}GetLowercaseTagsSet(){return this.#e?this.#e.lowercaseTags:_G}_GetLowercaseTagsSetMaybeNull(){return this.#e?this.#e.lowercaseTags:null}HasTag(t){return!!this.#e&&this.#e.lowercaseTags.has(t.toLowerCase())}GetTagsString(){return Array.from(this.GetTagsSet()).join(" ")}GetTagAt(t){t=Math.floor(t);for(const e of this.GetTagsSet()){if(0===t)return e;--t}return""}GetBehaviorInstances(){return this._behaviorInstances}GetBehaviorInstanceFromCtor(t){if(!t)return null;for(const e of this._behaviorInstances)if(e.GetBehavior()instanceof t)return e;return null}GetBehaviorSdkInstanceFromCtor(t){if(!t)return null;const e=this.GetBehaviorInstanceFromCtor(t);return e?e.GetSdkInstance():null}GetBehaviorIndexBySID(t){const e=this._behaviorInstances;for(let s=0,i=e.length;s<i;++s)if(e[s].GetBehaviorType().GetSID()===t)return s;return-1}GetAllInstanceVariableValues(){return this._instVarValues}_GetAllInstanceVariableNames(){return this._objectType._GetAllInstanceVariableNames()}GetInstanceVariableCount(){return this._instVarValues.length}GetInstanceVariableValue(t){t|=0;const e=this._instVarValues;if(t<0||t>=e.length)throw new RangeError("invalid instance variable");return e[t]}_GetInstanceVariableValueUnchecked(t){return this._instVarValues[t]}_GetInstanceVariableTypedValue(t){const e=this._instVarValues[t];return 0===this._objectType.GetInstanceVariableType(t)?!!e:e}SetInstanceVariableValue(t,e){t|=0;const s=this._instVarValues;if(t<0||t>=s.length)throw new RangeError("invalid instance variable");switch(this._objectType.GetInstanceVariableType(t)){case 0:s[t]=e?1:0;break;case 1:s[t]="number"==typeof e?e:parseFloat(e);break;case 2:s[t]="string"==typeof e?e:e.toString();break;default:throw new Error("unknown instance variable type")}}SetInstanceVariableOffset(t,e){if(0===e)return;t|=0;const s=this._instVarValues;if(t<0||t>=s.length)throw new RangeError("invalid instance variable");const i=s[t];if("number"!=typeof i)throw"boolean"==typeof i?new Error("can not set offset of boolean variable"):"string"==typeof i?new Error("can not set offset of string variable"):new Error("unknown instance variable type");s[t]+="number"==typeof e?e:parseFloat(e)}GetSavedDataMap(){let t=pG.get(this);return t||(t=new Map,pG.set(this,t),t)}_HasAnyCreateDestroyHandler(t){const e=this.GetObjectClass();if(e.UserScriptDispatcher().HasAnyHandlerFor(t))return!0;for(const s of e.GetFamilies())if(s.UserScriptDispatcher().HasAnyHandlerFor(t))return!0;return!!this._runtime.UserScriptDispatcher().HasAnyHandlerFor(t)}_TriggerOnCreatedOnSelfAndRelated(t=void 0){const e=t??new Set;if(e.has(this))return;e.add(this);const s=this.GetWorldInfo();if(s&&s.HasChildren())for(const t of this.allChildren())if(e.add(t),t.IsInContainer())for(const s of t.siblings())e.add(s);if(this.IsInContainer())for(const t of this.siblings())t._TriggerOnCreatedOnSelfAndRelated(e);if(!t){for(const t of e.values())t._TriggerOnCreated();this._OnHierarchyReady()}}_OnCreatedCommon(){this._objectType._GetUserScriptInstanceClass()&&this.GetInterfaceClass();for(const t of this._behaviorInstances)t.PostCreate()}_OnCreatedForLoadingSavegame(){this._OnCreatedCommon()}_TriggerOnCreated(){if(this._OnCreatedCommon(),this._HasAnyCreateDestroyHandler("instancecreate")){const t=this.GetObjectClass(),e=new hG.Event("instancecreate");e.instance=this.GetInterfaceClass(),t.DispatchUserScriptEvent(e);for(const s of t.GetFamilies())s.DispatchUserScriptEvent(e);this._runtime.DispatchUserScriptEvent(e)}this._runtime.Trigger(this.GetPlugin().GetConstructor().Cnds.OnCreated,this,null)}_OnHierarchyReady(){if(this.GetPlugin().SupportsSceneGraph()){if(this.DispatchUserScriptEvent(new hG.Event("hierarchyready")),this._HasAnyCreateDestroyHandler("hierarchyready")){const t=this.GetObjectClass(),e=new hG.Event("hierarchyready");e.instance=this.GetInterfaceClass(),t.DispatchUserScriptEvent(e);for(const s of t.GetFamilies())s.DispatchUserScriptEvent(e);this._runtime.DispatchUserScriptEvent(e)}this._runtime.Trigger(this.GetPlugin().GetConstructor().Cnds.OnHierarchyReady,this,null)}}_TriggerOnDestroyed(){this._runtime.Trigger(this.GetPlugin().GetConstructor().Cnds.OnDestroyed,this,null)}_FireDestroyedScriptEvents(t){if(this._iScriptInterface){const e=new hG.Event("destroy");e.isEndingLayout=t,this.DispatchUserScriptEvent(e)}if(!this._HasAnyCreateDestroyHandler("instancedestroy"))return;const e=this.GetObjectClass(),s=new hG.Event("instancedestroy");s.instance=this.GetInterfaceClass(),s.isEndingLayout=t,e.DispatchUserScriptEvent(s);for(const t of e.GetFamilies())t.DispatchUserScriptEvent(s);this._runtime.DispatchUserScriptEvent(s)}_GetDebuggerProperties(){return this._sdkInst?this._sdkInst.GetDebuggerProperties():this._iScriptInterface._getDebuggerProperties()}SaveToJson(t="full",e=null){const s={};"full"===t?s.uid=this.GetUID():s.c3=!0;const i=this.GetTagsSet();if(i.size>0&&(s.tags=Array.from(i)),"visual-state"!==t){const e=pG.get(this);if(e&&e.size&&(s.ex=hG.ToSuperJSON(e)),-1!==this.GetTimeScale()&&(s.mts=this.GetTimeScale()),this._objectType.GetInstanceVariablesCount()>0){const t={},e=this._objectType.GetInstanceVariableSIDs();for(let s=0,i=this._instVarValues.length;s<i;++s)t[e[s].toString()]=this._instVarValues[s];s.ivs=t}if(this._behaviorInstances.length){const e={};for(const s of this._behaviorInstances){const i=s.SaveToJson(t);i&&(e[s.GetBehaviorType().GetSID().toString()]=i)}s.behs=e}}this._worldInfo&&(s.w=this._worldInfo._SaveToJson(t,e));const r=this._sdkInst?this._sdkInst.SaveToJson():this._iScriptInterface._saveToJson();return r&&(s.data=r),s}_OnBeforeLoad(t="full",e=null){this._worldInfo&&this._worldInfo._OnBeforeLoad(t)}_OnAfterLoad(t,e="full",s=null){this._worldInfo&&this._worldInfo._OnAfterLoad(t,e,s)}_OnAfterLoad2(t,e="full",s=null){this._worldInfo&&this._worldInfo._OnAfterLoad2(t,e,s)}_SetupSceneGraphConnectionsOnChangeOfLayout(){this.GetPlugin().IsWorldType()&&this._worldInfo._SetupSceneGraphConnectionsOnChangeOfLayout()}LoadFromJson(t,e="full",s=null){if("full"===e)this._uid=t.uid;else if(!t.c3)return;if(this.SetTagsSet(new Set(t.tags??[])),"visual-state"!==e){let e=pG.get(this);e&&(e.clear(),pG.delete(this));const s=t.ex;s&&(e=hG.FromSuperJSON(s),pG.set(this,e)),this._timeScale=t.hasOwnProperty("mts")?t.mts:-1;const i=t.ivs;if(i)for(const[t,e]of Object.entries(i)){const s=parseInt(t,10),i=this._objectType.GetInstanceVariableIndexBySID(s);if(i<0||i>=this._instVarValues.length)continue;let r=e;null===r&&(r=NaN),this._instVarValues[i]=r}}if(this.GetPlugin().IsWorldType()){const i=t.w;if(i){const t=i.l;if(this._worldInfo.GetLayer().GetSID()!==t){const s=this._worldInfo.GetLayer(),i=s.GetLayout().GetLayerBySID(t);i?(this._worldInfo._SetLayer(i),s._RemoveInstance(this,!0),i._AddInstance(this,!0),i.SetZIndicesChanged(this),this._worldInfo.SetBboxChanged()):"full"===e&&this._runtime.DestroyInstance(this)}this._worldInfo._LoadFromJson(i,e,s)}}if("visual-state"!==e){const s=t.behs;if(s)for(const[t,i]of Object.entries(s)){const s=parseInt(t,10),r=this.GetBehaviorIndexBySID(s);r<0||r>=this._behaviorInstances.length||this._behaviorInstances[r].LoadFromJson(i,e)}}const i=t.data;i&&(this._sdkInst?this._sdkInst.LoadFromJson(i,e):this._iScriptInterface._loadFromJson(i))}MoveToLayerWithSID(t){if(this._worldInfo.GetLayer().GetSID()===t)return;const e=this._worldInfo.GetLayer(),s=e.GetLayout().GetLayerBySID(t);s&&(this._worldInfo._SetLayer(s),e._RemoveInstance(this,!0),s._AddInstance(this,!0),s.SetZIndicesChanged(this),this._worldInfo.SetBboxChanged())}GetInterfaceClass(){return this._iScriptInterface||this._InitUserScriptInterface()}HasScriptInterface(){return!!this._iScriptInterface}_InitUserScriptInterface(t,e){const s=this._worldInfo?t?self.ISDKWorldInstanceBase:self.IWorldInstance:t?self.ISDKInstanceBase:self.IInstance,i=t||this._sdkInst.GetScriptInterfaceClass(),r=this._objectType._GetUserScriptInstanceClass(),n=r||i||s,a=this.GetPlugin().GetSdkVersion();if(hG.AddonManager._PushInitObject(this,a),hG.AddonManager._PushInitProperties(e),this._iScriptInterface=new n,hG.AddonManager._PopInitProperties(),hG.AddonManager._PopInitObject(a),i&&!(this._iScriptInterface instanceof s))throw new TypeError(`script interface class '${i.name}' does not extend the right base class '${s.name}'`);if(r){const t=i||s;if(!(this._iScriptInterface instanceof t))throw new TypeError(`setInstanceClass(): class '${r.name}' does not extend the right base class - check it extends the right class, e.g. globalThis.InstanceType.MyObjectName`)}return this._iScriptInterface}_GetInstVarsScriptDescriptor(t){if(0===this._instVarValues.length)return;const e={},s=this._objectType._GetAllInstanceVariableJsPropNames();for(let t=0,i=s.length;t<i;++t)e[s[t]]={configurable:!1,enumerable:!0,get:hG.Instance.prototype._GetInstanceVariableTypedValue.bind(this,t),set:hG.Instance.prototype.SetInstanceVariableValue.bind(this,t)};const i=Object.create(Object.prototype,e);t.instVars={value:i,writable:!1}}_GetBehaviorsScriptDescriptor(t){const e=this._behaviorInstances;if(0===e.length)return;const s={};for(const t of e)s[t.GetBehaviorType().GetJsPropName()]={value:t.GetScriptInterface(),writable:!1};const i=Object.create(Object.prototype,s);t.behaviors={value:i,writable:!1}}DispatchUserScriptEvent(t){if(!this.HasScriptInterface())return;const e=this.GetInterfaceClass();t.instance=e;const s=this._runtime,i=s.IsDebug()&&!s.GetEventSheetManager().IsInEventEngine();i&&lG.StartMeasuringScriptTime(),e.dispatchEvent(t),i&&lG.AddScriptTime()}}}{const fG=self.C3,gG=new Map;fG.SceneGraphInfo=class extends fG.DefendedBase{constructor(t){super(),this._owner=t,this._parent=null,this._children=[],this._startWidth=t.GetWidth(),this._startHeight=t.GetHeight(),this._startScaleX=1,this._startScaleY=1,this._parentStartAngle=0,this._ownOpacity=1,this._startOpacity=t.GetOpacity(),this._tmpSceneGraphChildren=null,this._tmpSceneGraphChildrenIndexes=null,this._indexInParent=NaN,this._originalSizeKnown=!1,this._originalWidth=NaN,this._originalHeight=NaN,this._on_instance_create=e=>{if(e.instance!==this._parent.GetInstance())return;t.GetRuntime().Dispatcher().removeEventListener("instancecreate",this._on_instance_create);const s=this._parent.GetInstance().GetSdkInstance();this._originalSizeKnown=!!s.IsOriginalSizeKnown(),this._originalWidth=this._originalSizeKnown?s.GetOriginalWidth():NaN,this._originalHeight=this._originalSizeKnown?s.GetOriginalHeight():NaN}}Release(){this._parent=null,this._tmpSceneGraphChildren=null,this._tmpSceneGraphChildrenIndexes=null,this._indexInParent=NaN,this._originalSizeKnown=!1,this._originalWidth=NaN,this._originalHeight=NaN,fG.clearArray(this._children)}SetParent(t){if(this._ownOpacity=this._owner.GetOpacity(),this._startOpacity=this._ownOpacity,this._parent=t,this._parentStartAngle=t?t.GetAngle():0,this._parent){const t=this._owner.GetRuntime();if(this._parent.GetInstance().GetPlugin().GetSdkVersion()<2){const e=this._parent.GetInstance().GetSdkInstance();e?(this._originalSizeKnown=!!e.IsOriginalSizeKnown(),this._originalWidth=this._originalSizeKnown?e.GetOriginalWidth():NaN,this._originalHeight=this._originalSizeKnown?e.GetOriginalHeight():NaN):this._parent.GetInstance().IsDestroyed()||t.Dispatcher().addEventListener("instancecreate",this._on_instance_create)}else this._originalSizeKnown=!1,this._originalWidth=NaN,this._originalHeight=NaN}else this._originalSizeKnown=!1,this._originalWidth=NaN,this._originalHeight=NaN}GetParent(){return this._parent}HasChildren(){return this._children.length>0}GetChildren(){return this._children}_MaybeSortChildren(){this.HasChildren()&&1!==this._children.length&&(this._tmpSceneGraphChildrenIndexes?this._children.sort((t,e)=>{const s=this._tmpSceneGraphChildrenIndexes.get(t.GetInstance()),i=this._tmpSceneGraphChildrenIndexes.get(e.GetInstance());return fG.IsFiniteNumber(s)&&fG.IsFiniteNumber(i)?s-i:0}):this._children.sort((t,e)=>{const s=t._GetSceneGraphInfo()._GetIndexInParent(),i=e._GetSceneGraphInfo()._GetIndexInParent();return fG.IsFiniteNumber(s)&&fG.IsFiniteNumber(i)?s-i:0}))}_GetIndexInParent(){return this._indexInParent}GetStartScaleX(){return this._startScaleX}SetStartScaleX(t){this._startScaleX=t}GetStartScaleY(){return this._startScaleY}SetStartScaleY(t){this._startScaleY=t}GetStartOpacity(){return this._startOpacity}GetOwnOpacity(){return this._ownOpacity}SetOwnOpacity(t){this._ownOpacity=t}_GetStartWidth(){return 0===this._startWidth?Number.EPSILON:this._startWidth}_GetStartHeight(){return 0===this._startHeight?Number.EPSILON:this._startHeight}GetParentScaleX(){if(this._owner.GetTransformWithParentWidth()){const t=this._parent;let e=t.GetWidth(),s=t._GetSceneGraphInfo()._GetStartWidth();return 0===e&&(e=Number.EPSILON),s===Number.EPSILON&&e===Number.EPSILON?1:s===Number.EPSILON&&e!==Number.EPSILON&&this._originalSizeKnown?1+e/this._originalWidth:e/s}return 1}GetParentScaleY(){if(this._owner.GetTransformWithParentHeight()){const t=this._parent;let e=t.GetHeight(),s=t._GetSceneGraphInfo()._GetStartHeight();return 0===e&&(e=Number.EPSILON),s===Number.EPSILON&&e===Number.EPSILON?1:s===Number.EPSILON&&e!==Number.EPSILON&&this._originalSizeKnown?1+e/this._originalHeight:e/s}return 1}GetParentStartAngle(){return 0}_SaveToJsonProperties(){return{sw:this._startWidth,sh:this._startHeight,sx:this._startScaleX,sy:this._startScaleY,psa:this._parentStartAngle,oo:this._ownOpacity,so:this._startOpacity,pi:this._owner.GetInstance().GetIndexInParent()}}_SaveToJson(t,e=null){const s=this._SaveToJsonProperties();return e&&e.selfOnly?Object.assign(s,{p:null,c:[]}):Object.assign(s,{p:this._GetParentJson(t),c:this._GetChildrenJson(t)})}_GetFlagsString(t){let e="";return t.GetTransformWithParentX()&&(e+="x"),t.GetTransformWithParentY()&&(e+="y"),t.GetTransformWithParentWidth()&&(e+="w"),t.GetTransformWithParentHeight()&&(e+="h"),t.GetTransformWithParentAngle()&&(e+="a"),t.GetTransformWithParentZElevation()&&(e+="z"),t.GetDestroyWithParent()&&(e+="d"),t.GetTransformWithParentOpacity()&&(e+="o"),t.GetTransformWithParentVisibility()&&(e+="v"),e}_GetParentJson(t){return this._parent?!this._parent.GetInstance()||this._parent.GetInstance().IsDestroyed()?null:this._GetInstanceJson(this._parent,this._owner,t):null}_GetChildrenJson(t){return this._children.map(e=>this._GetInstanceJson(e,e,t)).filter(t=>t)}_GetInstanceJson(t,e,s){const i=t.GetInstance();if(i&&i.IsDestroyed())return null;const r={};return r.uid=i.GetUID(),r.f=this._GetFlagsString(e),r.offsets=e._SaveSceneGraphPropertiesToJson(),r.data=fG.SceneGraphInfo.GetSceneGraphInstanceDataFromInstance(i),r.oci=i.GetObjectClass().GetIndex(),"state"===s?(r.inst=i.SaveToJson("full",{selfOnly:!0}),r.instIndex=NaN):(r.instIndex=i.GetObjectClass().GetInstances().indexOf(i),r.inst=null),r}_LoadFromJson(t){this._startWidth=t.sw,this._startHeight=t.sh,this._startScaleX=t.sx,this._startScaleY=t.sy,this._parentStartAngle=t.psa,this._ownOpacity=t.oo,this._startOpacity=t.so,this._indexInParent=fG.IsFiniteNumber(t.pi)?t.pi:NaN}_SetTmpSceneGraphChildren(t,e,s,i){if(!t&&!e)if(i?.setFromJson){if(this._tmpSceneGraphChildren)for(const t of this._tmpSceneGraphChildren)t.IsDestroyed()||t.HasParent()||t.GetRuntime().DestroyInstance(t)}else if(this._tmpSceneGraphChildren)for(const t of this._tmpSceneGraphChildren)if(s.c&&s.c.length){if(!s.c.some(e=>e.uid===t.GetUID()))continue;t.IsDestroyed()||t.HasParent()||t.GetRuntime().DestroyInstance(t)}this._tmpSceneGraphChildren=t,this._tmpSceneGraphChildrenIndexes=e}_GetInstanceByUID(t){const e=this._owner.GetRuntime();return gG.has(t)?gG.get(t):e.GetInstanceByUID(t)}_OnAfterLoad(t,e){const s=this._owner,i=s.GetRuntime(),r=e?.processedWorldInfo??new Set;if(t.p&&!this._parent){const n=t.p.uid,a=this._GetInstanceByUID(n);if(a){const n=a.GetWorldInfo();a.HasChild(s.GetInstance())?this._parent=n:(a.HasChildWithUID(s.GetInstance().GetUID())?(i.DestroyInstance(s.GetInstance()),i._RemoveInstanceFromUIDMap(s.GetInstance().GetUID()),gG.delete(s.GetInstance().GetUID())):a.AddChild(s.GetInstance(),this._GetFlagsObj(t.p.f)),r.has(s)||(s._LoadSceneGraphPropertiesFromJson(t.p.offsets),this._LoadInstancePropertiesFromJson(a,t.p,e),this._UpdateUIDInstanceMap(a,a.GetUID(),s.GetRuntime(),e)),r.add(s),a.GetWorldInfo()._GetSceneGraphInfo()._MaybeSortChildren())}else if(fG.IsFiniteNumber(t.p.oci)){const r=i.CreateInstance(i.GetObjectClassByIndex(t.p.oci),s.GetLayer(),0,0,!0);if(r){const n=this._GetInstanceData(t.p,i);n&&r.LoadFromJson(n);const a=r.GetWorldInfo(),o=!!e?.setFromJson;a.GetLayer().SortAndAddInstancesByZIndex(r,!1,o),r.AddChild(s.GetInstance(),this._GetFlagsObj(t.p.f)),gG.set(r.GetUID(),r),this._UpdateUIDInstanceMap(r,r.GetUID(),i,e),r.GetWorldInfo()._GetSceneGraphInfo()._MaybeSortChildren()}}}const n=[];for(const e of t.c){const t=e.uid,s=this._GetInstanceByUID(t);s&&n.push(s)}let a=0;for(const o of t.c){const h=o.uid,l=this._GetInstanceByUID(h);if(l){if(this._tmpSceneGraphChildren){if(this._tmpSceneGraphChildren.includes(l)){const i=l;if(i.GetObjectClass()!==l.GetObjectClass()){a++;continue}if(i.IsDestroyed()){a++;continue}const o=t.c[a];if(!e?.setFromJson&&this._HasAllChildrenOfType(i,n,s)){if(s.GetInstance().GetChildAt(a)){const n=i.GetObjectClass().GetIndex(),h=o.oci,l=s.GetInstance().GetChildAt(a).GetObjectClass().GetIndex();if(n!==h||h!==l){this._RefreshAllChildren(t.c,s,r,e);break}this._UpdateInstance(a,o,s,r,e)}else this._UpdateInstance(a,o,s,r,e);a++;continue}if(i.HasParent()&&i.GetParent()!==s.GetInstance()){const t=this._CreateNewChildInstance(o,e);this._AddAndSetChildInstance(t,o,r,e),a++;continue}this._AddAndSetChildInstance(i.GetWorldInfo(),o,r,e,!0),a++;continue}if(this._tmpSceneGraphChildren[a]){const i=this._tmpSceneGraphChildren[a];if(i.GetObjectClass()!==l.GetObjectClass()){a++;continue}if(i.IsDestroyed()){a++;continue}const o=t.c[a];if(!e?.setFromJson&&this._HasAllChildrenOfType(i,n,s)){if(s.GetInstance().GetChildAt(a)){const n=i.GetObjectClass().GetIndex(),h=o.oci,l=s.GetInstance().GetChildAt(a).GetObjectClass().GetIndex();if(n!==h||h!==l){this._RefreshAllChildren(t.c,s,r,e);break}this._UpdateInstance(a,o,s,r,e)}else this._UpdateInstance(a,o,s,r,e);a++;continue}if(i.HasParent()&&i.GetParent()!==s.GetInstance()){const t=this._CreateNewChildInstance(o,e);this._AddAndSetChildInstance(t,o,r,e),a++;continue}this._AddAndSetChildInstance(i.GetWorldInfo(),o,r,e,!0),a++;continue}}const i=l.GetObjectClass();if(this._GetInstancesOfObjectClassCount(n,i)===s.GetInstance().GetChildrenOfObjectClass(i).length){for(const t of s.GetInstance().GetChildren()){if(t.GetObjectClass()!==i)continue;const s=t.GetWorldInfo();if(s&&!r.has(s)){r.add(s),s._LoadSceneGraphPropertiesFromJson(o.offsets),this._LoadInstancePropertiesFromJson(t,o,e);break}}a++;continue}if(l.HasParent()&&l.GetParent()!==s.GetInstance()){const t=this._CreateNewChildInstance(o,e);this._AddAndSetChildInstance(t,o,r,e),a++;continue}this._AddAndSetChildInstance(l.GetWorldInfo(),o,r,e)}else if(this._tmpSceneGraphChildren&&this._tmpSceneGraphChildren[a]){const h=this._tmpSceneGraphChildren[a],l=i.GetObjectClassByIndex(this._GetObjectClassIndex(o));if(h.GetObjectClass()!==l){a++;continue}if(h.IsDestroyed()){a++;continue}const c=t.c[a];if(!e?.setFromJson&&this._HasAllChildrenOfType(h,n,s)){if(s.GetInstance().GetChildAt(a)){const i=h.GetObjectClass().GetIndex(),n=c.oci,o=s.GetInstance().GetChildAt(a).GetObjectClass().GetIndex();if(i!==n||n!==o){this._RefreshAllChildren(t.c,s,r,e);break}this._UpdateInstance(a,c,s,r,e)}else this._UpdateInstance(a,c,s,r,e);a++;continue}if(h.HasParent()&&h.GetParent()!==s.GetInstance()){const t=this._CreateNewChildInstance(c,e);this._AddAndSetChildInstance(t,c,r,e),a++;continue}this._AddAndSetChildInstance(h.GetWorldInfo(),c,r,e)}else{const t=this._CreateNewChildInstance(o,e);this._AddAndSetChildInstance(t,o,r,e)}a++}}_RefreshAllChildren(t,e,s,i){const r=e.GetRuntime();for(const t of e.GetInstance().children())t&&!t.IsDestroyed()&&(r.DestroyInstance(t),r._RemoveInstanceFromUIDMap(t.GetUID()),gG.delete(t.GetUID()));this._tmpSceneGraphChildren&&(this._tmpSceneGraphChildren=[]),this._tmpSceneGraphChildrenIndexes&&(this._tmpSceneGraphChildrenIndexes=new WeakMap),Object.assign({},i,{assignZIndex:!1});for(const e of t){const t=this._CreateNewChildInstance(e,i);this._AddAndSetChildInstance(t,e,s,i),this._tmpSceneGraphChildren.push(t.GetInstance()),this._tmpSceneGraphChildrenIndexes.set(t.GetInstance(),this._tmpSceneGraphChildren.length-1)}e._GetSceneGraphInfo()._MaybeSortChildren()}_HasAllChildrenOfType(t,e,s){const i=t.GetObjectClass();return this._GetInstancesOfObjectClassCount(e,i)===s.GetInstance().GetChildrenOfObjectClass(i).length}_UpdateInstance(t,e,s,i,r){const n=s.GetInstance().GetChildAt(t);if(!n)return;const a=n.GetWorldInfo();a&&(i.has(a)||(a._LoadSceneGraphPropertiesFromJson(e.offsets),this._LoadInstancePropertiesFromJson(n,e,r)),i.add(a))}_GetFlagsObj(t){const e={};return e.transformX=t.includes("x"),e.transformY=t.includes("y"),e.transformWidth=t.includes("w"),e.transformHeight=t.includes("h"),e.transformAngle=t.includes("a"),e.transformZElevation=t.includes("z"),e.destroyWithParent=t.includes("d"),e.transformOpacity=t.includes("o"),e.transformVisibility=t.includes("v"),e}_GetObjectClassIndex(t){return fG.IsFiniteNumber(t.oci)?t.oci:t[1]}_CreateNewChildInstance(t,e){if(!fG.IsFiniteNumber(t.oci))return;const s=this._owner,i=s.GetRuntime();let r;const n=!e.hasOwnProperty("createHierarchy")||e.createHierarchy;if(r=t.data?i.CreateInstanceFromData(t.data,s.GetLayer(),!1,0,0,!1,n):i.CreateInstance(i.GetObjectClassByIndex(t.oci),s.GetLayer(),0,0,n),!r)return;const a=this._GetInstanceData(t,i);a&&r.LoadFromJson(a);const o=r.GetWorldInfo(),h=!!e?.setFromJson;return o.GetLayer().SortAndAddInstancesByZIndex(r,!0,h),o}_UpdateUIDInstanceMap(t,e,s,i){if(this._GetInstanceByUID(e)&&!i?.setFromJson){const i=this._GetInstanceByUID(e);i!==t&&s.DestroyInstance(i)}s._RemoveInstanceFromUIDMap(e),s._MapInstanceByUID(e,t)}_AddAndSetChildInstance(t,e,s,i,r=!0){const n=this._owner,a=n.AddChild(t,this._GetFlagsObj(e.f));a&&r?(s.has(t)||(t._LoadSceneGraphPropertiesFromJson(e.offsets),this._LoadInstancePropertiesFromJson(t.GetInstance(),e,i)),s.add(t)):a&&(gG.set(t.GetInstance().GetUID(),t.GetInstance()),this._UpdateUIDInstanceMap(t.GetInstance(),e.uid,n.GetRuntime(),i)),this._MaybeSortChildren()}_LoadInstancePropertiesFromJson(t,e,s){let i=this._GetInstanceData(e,this._owner.GetRuntime());if(!i)return;const r=!s.hasOwnProperty("clearChildren")||s.clearChildren,n=!s.hasOwnProperty("assignZIndex")||s.assignZIndex,a=t.GetRuntime();if(gG.set(t.GetUID(),t),i=JSON.parse(JSON.stringify(i)),r&&t.GetUID()!==i.uid){for(const e of t.children())e&&!e.IsDestroyed()&&(a.DestroyInstance(e),a._RemoveInstanceFromUIDMap(e.GetUID()),gG.delete(e.GetUID()));if(i.w?.sgi&&i.w.sgi.c?.length)for(const e of i.w.sgi.c){const i=Object.assign({},s,{clearChildren:!1,createHierarchy:!1}),r=this._CreateNewChildInstance(e,i);gG.set(r.GetInstance().GetUID(),r.GetInstance()),t.AddChild(r.GetInstance(),this._GetFlagsObj(e.f)),r._LoadSceneGraphPropertiesFromJson(e.offsets),this._LoadInstancePropertiesFromJson(r.GetInstance(),e,i)}}const o=i.w?.zi,h=i.w?.l;i.w=null,t.LoadFromJson(i),s?.setFromJson||(fG.IsFiniteNumber(o)&&n&&t.GetWorldInfo()._SetZIndex(o),fG.IsFiniteNumber(h)&&t.MoveToLayerWithSID(h)),this._UpdateUIDInstanceMap(t,i.uid,a,s)}_GetInstancesOfObjectClassCount(t,e){return t.filter(t=>t.GetObjectClass().GetName()===e.GetName()).length}_GetInstanceData(t,e){if(fG.IsFiniteNumber(t.instIndex)){const s=e.GetObjectClassByIndex(t.oci)._GetLoadInstancesJson();return s?s[t.instIndex]:null}return fG.IsString(t.inst)?JSON.parse(t.inst):t.inst?t.inst:void 0}static GetSceneGraphInstanceDataFromInstance(t){let e=t.GetWorldInfo().GetLayer().GetInitialInstanceData(t.GetUID());if(!e)return null;e=JSON.parse(JSON.stringify(e));const s=[];for(const e of[...t.GetChildren()]){const t=e.GetWorldInfo();s.push([t.GetLayout().GetSID(),t.GetLayer().GetIndex(),e.GetUID(),fG.SceneGraphInfo._GetFlagsNumber(t),e.GetObjectClass().IsInContainer()?1:0,t.GetZIndex(),fG.SceneGraphInfo.GetSceneGraphInstanceDataFromInstance(e)])}return fG.IsArray(e[0][14])?e[0][14][1]=s:(e[0][14]=[],e[0][14][0]=fG.SceneGraphInfo._GetDefaultFlagsNumber(),e[0][14][1]=s,e[0][14][2]=t.GetWorldInfo().GetZIndex()),e}static _GetFlagsNumber(t){let e=0;return e|=Number(t.GetTransformWithParentVisibility())<<8,e|=Number(t.GetTransformWithParentOpacity())<<7,e|=Number(t.GetTransformWithParentZElevation())<<6,e|=Number(t.GetDestroyWithParent())<<5,e|=Number(t.GetTransformWithParentAngle())<<4,e|=Number(t.GetTransformWithParentHeight())<<3,e|=Number(t.GetTransformWithParentWidth())<<2,e|=Number(t.GetTransformWithParentY())<<1,e|=0|Number(t.GetTransformWithParentX()),e}static _GetDefaultFlagsNumber(t){let e=0;return e|=256,e|=128,e|=64,e|=32,e|=16,e|=8,e|=4,e|=2,e|=1,511}static ClearUpdatedInstances(){gG.clear()}}}{const mG=self.C3,SG=self.glMatrix,yG=(SG.vec3,SG.vec4,mG.New(mG.Rect)),GG=mG.New(mG.Quad),TG=mG.New(mG.Event,"bboxchange",!1),IG=mG.New(mG.Color,0,0,0,0),CG=mG.New(mG.CollisionPoly),bG=mG.New(mG.Color,1,1,1,1),xG=mG.New(mG.Rect,0,0,-1,-1),wG=mG.New(mG.Rect,0,0,-1,-1),MG=new Set(["absolute","relative"]),PG=[];let vG=!0;const RG=new WeakMap,AG=new WeakMap;mG.WorldInfo=class extends mG.DefendedBase{constructor(t,e){super(),this._inst=t,this._objectClass=t.GetObjectClass(),this._runtime=t.GetRuntime(),this._layer=e,this._objectClass._OnWorldInstanceLayerChanged(this,null,e),this._zIndex=-1,this._htmlZIndex=-1,this._flags=196635,this._objectClass.GetPlugin().IsRotatable()&&(this._flags|=128),this._x=NaN,this._y=NaN,this._zElevation=NaN,this._w=NaN,this._h=NaN,this._depth=NaN,this._a=NaN,this._sinA=NaN,this._cosA=NaN,this._ox=NaN,this._oy=NaN,this._boundingBox=mG.New(mG.Rect),this._boundingQuad=mG.New(mG.Quad),this._collisionCells=wG,this._renderCells=xG,this._sourceCollisionPoly=null,this._transformedPolyInfo=null,this._solidFilterTags=null,this._color=bG,this._colorPremultiplied=bG,this._stateGroup=null,this._instanceEffectList=null,this._inst.GetObjectClass().UsesEffects()&&(this._instanceEffectList=mG.New(mG.InstanceEffectList,this._inst,this)),this._sceneGraphInfo=null,this._tmpSceneGraphChildren=null,this._tmpSceneGraphChildrenIndexes=null,this._tmpHierarchyPosition=-1,this._meshInfo=null}_MarkDestroyed(){this._flags|=256}IsDestroyed(){return!!(256&this._flags)}Release(){if(this._objectClass._OnWorldInstanceLayerChanged(this,this._layer,null),this._stateGroup&&(this._runtime.GetRenderer().ReleaseStateGroup(this._stateGroup),this._stateGroup=null),this._sourceCollisionPoly=null,this._transformedPolyInfo&&(this._transformedPolyInfo.poly.Release(),this._transformedPolyInfo=null),this._solidFilterTags&&(this._solidFilterTags.clear(),this._solidFilterTags=null),this.ReleaseMesh(),this._instanceEffectList&&this._instanceEffectList.Release(),this.HasParent()&&this.GetParent().RemoveChild(this),this.HasChildren()){const t=[...this.GetChildren()];for(const e of t)this.RemoveChild(e)}this._ReleaseSceneGraphInfo(),this._ReleaseTmpSceneGraphInfo(),RG.delete(this),AG.delete(this),this._inst=null,this._objectClass=null,this._runtime=null,this._layer=null}Init(t){if(vG=!1,this.SetXY(t[0],t[1]),this.SetZElevation(t[2]),this.SetSize(t[3],t[4]),this._depth=0,this.IsRotatable()?this.SetAngle(t[6]):this._a=0,IG.setFromJSON(t[7]),this._SetColor(IG),this.SetOriginX(t[8]),this.SetOriginY(t[9]),this.SetBlendMode(t[10]),this._instanceEffectList&&this._instanceEffectList._LoadEffectParameters(t[12]),t[14]&&RG.set(this,{childrenData:t[14][1],zIndexData:t[14][2]}),t[15]){const e=t[15];this.CreateMesh(e[0],e[1]);const s=this.GetSourceMesh(),i=e[2];for(let t=0,e=i.length;t<e;++t){const e=i[t];for(let i=0,r=e.length;i<r;++i){const r=e[i],n=s.GetMeshPointAt(i,t);n.SetX(r[0]),n.SetY(r[1]),n.SetZElevation(r[2]),n.SetU(r[3]),n.SetV(r[4])}}}if(t[16]){const e=t[16][0],s=t[16][1],i=!!s,r=!i,n=this._runtime.GetTemplateManager();i&&n&&n.MapInstanceToTemplateName(this.GetInstance(),s),r&&n&&n.MapInstanceToTemplateName(this.GetInstance(),e)}vG=!0,this._UpdateRendererStateGroup()}InitNoData(){this._x=0,this._y=0,this._zElevation=0,this._w=0,this._h=0,this._depth=0,this._a=0,this._sinA=0,this._cosA=1,this._ox=0,this._oy=0,this._UpdateRendererStateGroup()}GetRuntime(){return this._runtime}GetObjectClass(){return this._objectClass}GetInstance(){return this._inst}_GetParentOffsetAngle(){return this.GetTransformWithParentAngle()?this._MaybeReflectAngleForMirrorFlip(this.GetParent()._GetAngleNoReflect()-this._sceneGraphInfo.GetParentStartAngle()):0}SetX(t){if(t=+t,this.GetTransformWithParentX()){const e=this._sceneGraphInfo,s=t-this.GetX(),i=-this._GetParentOffsetAngle();0===i?this._x+=s/e.GetParentScaleX():(this._x+=Math.cos(i)*s/e.GetParentScaleX(),this.GetTransformWithParentY()&&(this._y+=Math.sin(i)*s/e.GetParentScaleY()))}else this._x=t}OffsetX(t,e=!1){t=+t,e?this._x+=t:this.GetTransformWithParentX()?this.SetX(this.GetX()+t):this._x+=t}GetX(){if(this.GetTransformWithParentX()){let t=this._x;const e=this._sceneGraphInfo,s=this.GetParent(),i=this._GetParentOffsetAngle();return 0===i?t*=e.GetParentScaleX():(t=t*e.GetParentScaleX()*Math.cos(i),this.GetTransformWithParentY()&&(t-=this._y*e.GetParentScaleY()*Math.sin(i))),s.GetX()+t}return this._x}SetY(t){if(t=+t,this.GetTransformWithParentY()){const e=this._sceneGraphInfo,s=t-this.GetY(),i=-this._GetParentOffsetAngle();0===i?this._y+=s/e.GetParentScaleY():(this.GetTransformWithParentX()&&(this._x-=Math.sin(i)*s/e.GetParentScaleX()),this._y+=Math.cos(i)*s/e.GetParentScaleY())}else this._y=t}OffsetY(t,e=!1){t=+t,e?this._y+=t:this.GetTransformWithParentY()?this.SetY(this.GetY()+t):this._y+=t}GetY(){if(this.GetTransformWithParentY()){let t=this._y;const e=this._sceneGraphInfo,s=this.GetParent(),i=this._GetParentOffsetAngle();return 0===i?t*=e.GetParentScaleY():(t=t*e.GetParentScaleY()*Math.cos(i),this.GetTransformWithParentX()&&(t+=this._x*e.GetParentScaleX()*Math.sin(i))),s.GetY()+t}return this._y}SetXY(t,e){if(t=+t,e=+e,this.GetTransformWithParentXOrY()){const s=this.GetTransformWithParentX(),i=this.GetTransformWithParentY(),r=this._sceneGraphInfo,n=t-this.GetX(),a=e-this.GetY(),o=-this._GetParentOffsetAngle();if(0===o)s?this._x+=n/r.GetParentScaleX():this._x=t,i?this._y+=a/r.GetParentScaleY():this._y=e;else{const h=Math.sin(o),l=Math.cos(o);s?this._x+=i?(l*n-h*a)/r.GetParentScaleX():l*n/r.GetParentScaleX():this._x=t,i?this._y+=s?(h*n+l*a)/r.GetParentScaleY():l*a/r.GetParentScaleY():this._y=e}}else this._x=t,this._y=e}GetXY(){return[this.GetX(),this.GetY()]}OffsetXY(t,e){t=+t,e=+e,this.GetTransformWithParentXOrY()?this.SetXY(this.GetX()+t,this.GetY()+e):(this._x+=t,this._y+=e)}EqualsXY(t,e){return this.GetX()===t&&this.GetY()===e}SetZElevation(t){if(t=+t,this.GetTransformWithParentZElevation()&&(t-=this.GetParent().GetZElevation()),this._zElevation===t)return;this._zElevation=t,this._UpdateZElevation();const e=this.GetLayer();0!==this._zElevation&&e._SetAnyInstanceZElevated(),e.SetZIndicesChanged(this)}_UpdateZElevation(){if(this._UpdateRendererStateGroup(),this.HasChildren()){const t=this.GetChildren();for(let e=0,s=t.length;e<s;e++){const s=t[e];s.GetTransformWithParentZElevation()&&s._UpdateZElevation()}}}OffsetZElevation(t){this.SetZElevation(this.GetZElevation()+t)}GetZElevation(){return this.GetTransformWithParentZElevation()?this.GetParent().GetZElevation()+this._zElevation:this._zElevation}GetTotalZElevation(){return this.GetLayer().GetZElevation()+this.GetZElevation()}IsOriginalSizeKnown(){return this.GetInstance().GetPlugin().GetSdkVersion()<2&&this.GetInstance().GetSdkInstance().IsOriginalSizeKnown()}SetWidth(t){if(t=+t,this.GetTransformWithParentWidth()){const e=this.GetWidth();0===e?this._w=Number.EPSILON:this._w*=t/e}else this._w=t;this._MarkSinCosAngleChanged()}OffsetWidth(t,e){t=+t,e?this._w+=t:this.GetTransformWithParentWidth()?this.SetWidth(this.GetWidth()+t):this._w+=t,this._MarkSinCosAngleChanged()}GetWidth(){if(this.GetTransformWithParentWidth()){const t=this.GetParent(),e=t.GetWidth();return t._GetSceneGraphInfo()._GetStartWidth()===Number.EPSILON?(this._GetSceneGraphInfo()._GetStartWidth()+e)*this._w:e*this._w}return this._w}SetHeight(t){if(t=+t,this.GetTransformWithParentHeight()){const e=this.GetHeight();0===e?this._h=Number.EPSILON:this._h*=t/e}else this._h=t;this._MarkSinCosAngleChanged()}OffsetHeight(t,e){t=+t,e?this._h+=t:this.GetTransformWithParentHeight()?this.SetHeight(this.GetHeight()+t):this._h+=t,this._MarkSinCosAngleChanged()}GetHeight(){if(this.GetTransformWithParentHeight()){const t=this.GetParent(),e=t.GetHeight();return t._GetSceneGraphInfo()._GetStartHeight()===Number.EPSILON?(this._GetSceneGraphInfo()._GetStartHeight()+e)*this._h:e*this._h}return this._h}SetSize(t,e){if(t=+t,e=+e,this.GetTransformWithParentWidth()){const e=this.GetWidth();0===e?this._w=Number.EPSILON:this._w*=t/e}else this._w=t;if(this.GetTransformWithParentHeight()){const t=this.GetHeight();0===t?this._h=Number.EPSILON:this._h*=e/t}else this._h=e;this._MarkSinCosAngleChanged()}GetSize(){return[this.GetWidth(),this.GetHeight()]}GetDepth(){return this._depth}SetDepth(t){if(t<0)throw new RangeError("invalid depth");this._depth=t}GetSceneGraphScale(){if(this.HasParent()){const t=this._sceneGraphInfo;return Math.min(t.GetParentScaleX(),t.GetParentScaleY())}return 1}IsRotatable(){return!!(128&this._flags)}SetAngle(t){t=+t,this.IsRotatable()&&(this.GetTransformWithParentAngle()&&(t-=this.GetParent().GetAngle()),t=mG.clampAngle(t),this._a!==t&&(this._a=t,this._MarkSinCosAngleChanged()))}OffsetAngle(t){0!==(t=+t)&&this.IsRotatable()&&(this._a=mG.clampAngle(this._a+t),this._MarkSinCosAngleChanged())}_MarkSinCosAngleChanged(){if(this._flags|=262144,this.HasChildren()){const t=this.GetChildren();for(let e=0,s=t.length;e<s;e++)t[e]._MarkSinCosAngleChanged()}}GetAngle(){return this.GetTransformWithParentAngle()&&this.IsRotatable()?this._MaybeReflectAngleForMirrorFlip(mG.clampAngle(this.GetParent()._GetAngleNoReflect()+this._a)):this._a}_GetAngleNoReflect(){return this.GetTransformWithParentAngle()&&this.IsRotatable()?mG.clampAngle(this.GetParent()._GetAngleNoReflect()+this._a):this._a}_MaybeReflectAngleForMirrorFlip(t){return this.GetTransformWithParentWidth()&&this.GetTopParent().GetWidth()<0&&(t=mG.clampAngle(mG.angleReflect(t,this.GetTopParent().GetAngle()+Math.PI))),this.GetTransformWithParentHeight()&&this.GetTopParent().GetHeight()<0&&(t=mG.angleReflect(t,this.GetTopParent().GetAngle())),t}_NeedsReflectAngleForMirrorOrFlip(){const t=this.GetParent();return!!(this.GetTransformWithParentWidth()&&t.GetWidth()<0)||!!(this.GetTransformWithParentHeight()&&t.GetHeight()<0)}_NeedsReflectAngleForMirrorAndFlip(){const t=this.GetParent();return!!(this.GetTransformWithParentWidth()&&t.GetWidth()<0&&this.GetTransformWithParentHeight()&&t.GetHeight()<0)}_MaybeUpdateSinCosAngle(){const t=this._flags;if(!(262144&t))return;const e=this.GetAngle();this._sinA=Math.sin(e),this._cosA=Math.cos(e),this._flags=-262145&t}GetSinAngle(){return this._MaybeUpdateSinCosAngle(),this._sinA}GetCosAngle(){return this._MaybeUpdateSinCosAngle(),this._cosA}SetOriginX(t){this._ox=+t}OffsetOriginX(t){this._ox+=+t}GetOriginX(){return this._ox}SetOriginY(t){this._oy=+t}OffsetOriginY(t){this._oy+=+t}GetOriginY(){return this._oy}_SetColor(t){this._color.equals(t)||(this._color===bG?(this._color=mG.New(mG.Color,t),this._colorPremultiplied=mG.New(mG.Color,t),this._colorPremultiplied.premultiply()):t.equalsRgba(1,1,1,1)?(this._color=bG,this._colorPremultiplied=bG):(this._color.set(t),this._colorPremultiplied.set(t),this._colorPremultiplied.premultiply()),this._UpdateRendererStateGroup())}SetOpacity(t){if(t=mG.clamp(+t,0,1),this.GetTransformWithParentOpacity()){if(this._GetSceneGraphInfo().GetOwnOpacity()===t)return;this._GetSceneGraphInfo().SetOwnOpacity(t),t=this.GetOpacity()}else if(this._color.a===t)return;this._SetColorWithOpacity(t)}_SetOpacityOfChildren(){if(!this.HasChildren())return;const t=this.GetChildren();for(let e=0,s=t.length;e<s;e++){const s=t[e];s._SetColorWithOpacity(s.GetOpacity())}}_SetColorWithOpacity(t){IG.copyRgb(this._color),IG.a=t,this._SetColor(IG),this._SetOpacityOfChildren()}OffsetOpacity(t){this.GetTransformWithParentOpacity()?this.SetOpacity(this._GetSceneGraphInfo().GetOwnOpacity()+t):this.SetOpacity(this.GetOpacity()+t)}GetOpacity(){return this.GetTransformWithParentOpacity()?this.GetParent().GetOpacity()*this._GetSceneGraphInfo().GetOwnOpacity():this._color.a}SetUnpremultipliedColor(t){this._color.equalsIgnoringAlpha(t)||(IG.copyRgb(t),IG.a=this.GetOpacity(),this._SetColor(IG))}SetUnpremultipliedColorRGB(t,e,s){IG.setRgb(t,e,s),this.SetUnpremultipliedColor(IG)}OffsetUnpremultipliedColorRGB(t,e,s){0===t&&0===e&&0===s||(IG.copyRgb(this._color),IG.r+=t,IG.g+=e,IG.b+=s,this.SetUnpremultipliedColor(IG))}GetUnpremultipliedColor(){return this._color}GetPremultipliedColor(){return this._colorPremultiplied}GetDestroyWithParent(){return!!(512&this._flags)}SetDestroyWithParent(t){this._SetFlag(512,t)}GetTransformWithParentX(){return!!(1024&this._flags)}SetTransformWithParentX(t){this._SetFlag(1024,t)}GetTransformWithParentY(){return!!(2048&this._flags)}GetTransformWithParentXOrY(){return!!(3072&this._flags)}SetTransformWithParentY(t){this._SetFlag(2048,t)}GetTransformWithParentWidth(){return!!(4096&this._flags)}SetTransformWithParentWidth(t){this._SetFlag(4096,t)}GetTransformWithParentHeight(){return!!(8192&this._flags)}SetTransformWithParentHeight(t){this._SetFlag(8192,t)}GetTransformWithParentAngle(){return!!(16384&this._flags)}SetTransformWithParentAngle(t){this._SetFlag(16384,t)}GetTransformWithParentZElevation(){return!!(32768&this._flags)}SetTransformWithParentZElevation(t){this._SetFlag(32768,t)}GetTransformWithParentOpacity(){return!!(4194304&this._flags)}SetTransformWithParentOpacity(t){this._SetFlag(4194304,t)}GetTransformWithParentVisibility(){return!!(8388608&this._flags)}SetTransformWithParentVisibility(t){this._SetFlag(8388608,t)}_ClearAllSceneGraphFlags(){this._flags&=-12647937}AddChild(t,e){if(t===this)return!1;if(t.HasParent())return!1;if(this._HasChildRecursive(t))return!1;if(this._HasAnyParent(t))return!1;const s=t.GetX(),i=t.GetY(),r=t.GetWidth(),n=t.GetHeight(),a=t.GetAngle(),o=t.GetZElevation(),h=t.GetOpacity();t._SetParent(this),t.SetTransformWithParentX(e.transformX),t.SetTransformWithParentY(e.transformY),t.SetTransformWithParentWidth(e.transformWidth),t.SetTransformWithParentHeight(e.transformHeight),t.SetTransformWithParentAngle(e.transformAngle),t.SetTransformWithParentZElevation(e.transformZElevation),t.SetTransformWithParentOpacity(e.transformOpacity),t.SetTransformWithParentVisibility(e.transformVisibility),t.SetDestroyWithParent(e.destroyWithParent);const l=s-this.GetX(),c=i-this.GetY(),u=-this.GetAngle(),_=Math.cos(u),d=Math.sin(u);if(e.transformX&&(e.transformAngle?t._x=l*_-c*d:t._x=l,e.transformWidth)){const e=this.GetWidth()/this._sceneGraphInfo._GetStartWidth();0!==e&&(t._x/=e)}if(e.transformY&&(e.transformAngle?t._y=l*d+c*_:t._y=c,e.transformHeight)){const e=this.GetHeight()/this._sceneGraphInfo._GetStartHeight();0!==e&&(t._y/=e)}if(e.transformWidth){const e=this.GetWidth();0===e||e===Number.EPSILON?(t._w=1,t._sceneGraphInfo.SetStartScaleX(1)):(t._w=r/this.GetWidth(),t._sceneGraphInfo.SetStartScaleX(t._w))}if(e.transformHeight){const e=this.GetHeight();0===e||e===Number.EPSILON?(t._h=1,t._sceneGraphInfo.SetStartScaleY(1)):(t._h=n/this.GetHeight(),t._sceneGraphInfo.SetStartScaleY(t._h))}return e.transformAngle&&(t._a=a-this.GetAngle()),e.transformZElevation&&(t._zElevation=o-this.GetZElevation()),e.transformOpacity&&t._sceneGraphInfo.SetOwnOpacity(h),e.transformVisibility&&t.SetVisible(this.IsVisible()),this._AddChildToSceneGraphInfo(t),this.SetBboxChanged(),this._SetOpacityOfChildren(),!0}RemoveChild(t){if(t.GetParent()!==this)return;const e=t.GetX(),s=t.GetY(),i=t.GetWidth(),r=t.GetHeight(),n=t.GetAngle(),a=t.GetZElevation(),o=t.GetOpacity();t._SetParent(null),t._ClearAllSceneGraphFlags(),t.SetXY(e,s),t.SetSize(i,r),t.SetAngle(n),t.SetZElevation(a),t.SetOpacity(o),this._RemoveChildFromSceneGraphInfo(t),this.SetBboxChanged()}GetTmpHierarchyPosition(){return this._tmpHierarchyPosition}_ResetAllSceneGraphState(){this._BuildTmpSceneGraphData();const t=[...this.children()];for(const e of t)this.RemoveChild(e);const e=this.GetParent();e&&e.RemoveChild(this),this._ClearAllSceneGraphFlags()}_BuildTmpSceneGraphData(){if(this._SetTmpHierarchyPosition(),!this._tmpSceneGraphChildren){const t=[...this.children()];t.length&&(this._tmpSceneGraphChildren=[],this._tmpSceneGraphChildrenIndexes=new WeakMap);let e=0;for(const s of t){const t=s.GetInstance();this._tmpSceneGraphChildren.push(t),this._tmpSceneGraphChildrenIndexes.set(t,e),e++}}const t=this.GetParent();t&&t._BuildTmpSceneGraphData()}_SetTmpHierarchyPosition(){if(-1!==this._tmpHierarchyPosition)return;const t=[...this.parents()];this._tmpHierarchyPosition=t.length;for(const e of t)e._SetTmpHierarchyPosition();const e=[...this.children()];for(const t of e)t._SetTmpHierarchyPosition()}_ReleaseTmpSceneGraphInfo(){this._tmpSceneGraphChildren&&(this._tmpSceneGraphChildren.length=0),this._tmpSceneGraphChildren=null,this._tmpSceneGraphChildrenIndexes=null;const t=this.GetParent();t&&t._ReleaseTmpSceneGraphInfo(),this._tmpHierarchyPosition=-1}HasParent(){return null!==this.GetParent()}GetParent(){const t=this._sceneGraphInfo;return null!==t?t.GetParent():null}GetTopParent(){let t=this;for(;t.HasParent();)t=t.GetParent();return t}*parents(){let t=this.GetParent();for(;t;)yield t,t=t.GetParent()}HasChild(t){return this.GetChildren().includes(t)}HasChildren(){const t=this._sceneGraphInfo;return null!==t&&t.HasChildren()}GetChildren(){const t=this._sceneGraphInfo;return null!==t?t.GetChildren():PG}children(){return this.GetChildren()}*allChildren(){for(const t of this.children())yield t,yield*t.allChildren()}GetChildCount(){return this.GetChildren().length}GetAllChildCount(){return[...this.allChildren()].length}GetChildAt(t){const e=this.GetChildren();return(t=Math.floor(+t))<0||t>=e.length?null:e[t]}GetChildIndex(t){if(!t)return NaN;const e=this.GetChildren();if(!e)return NaN;for(let s=0;s<e.length;s++)if(t===e[s])return s;return NaN}_CreateSceneGraphInfo(t){this._sceneGraphInfo||(this._sceneGraphInfo=mG.New(mG.SceneGraphInfo,this)),t&&this._sceneGraphInfo.SetParent(t)}_GetSceneGraphInfo(){return this._sceneGraphInfo}_ReleaseSceneGraphInfo(){this._sceneGraphInfo&&(this._sceneGraphInfo.Release(),this._sceneGraphInfo=null)}_SetParent(t){t?(t._CreateSceneGraphInfo(null),this._CreateSceneGraphInfo(t)):(this._sceneGraphInfo&&this._sceneGraphInfo.SetParent(null),this.HasChildren()||this._ReleaseSceneGraphInfo())}_HasAnyParent(t){if(!this.HasParent())return!1;const e=this.GetParent();return e===t||e._HasAnyParent(t)}_HasChildRecursive(t){if(this.HasChild(t))return!0;for(const e of this.GetChildren())if(e._HasChildRecursive(t))return!0;return!1}_AddChildToSceneGraphInfo(t){this._sceneGraphInfo.GetChildren().push(t)}_RemoveChildFromSceneGraphInfo(t){const e=this._sceneGraphInfo.GetChildren(),s=e.indexOf(t);-1!==s&&e.splice(s,1),0!==e.length||this.HasParent()||this._ReleaseSceneGraphInfo(),t.HasChildren()||t._ReleaseSceneGraphInfo()}GetSceneGraphChildrenExportData(){const t=RG.get(this);return t?t.childrenData:null}GetSceneGraphZIndexExportData(){const t=RG.get(this);return t?t.zIndexData:NaN}GetSceneGraphZIndex(){const t=AG.get(this);return mG.IsFiniteNumber(t)?t:NaN}SetSceneGraphZIndex(t){AG.set(this,t)}SetUsePointsShaderProgram(){this._SetFlag(524288,!0),this._UpdateRendererStateGroup()}_UpdateRendererStateGroup(){if(!vG)return;const t=this._runtime.GetRenderer();let e;this._stateGroup&&t.ReleaseStateGroup(this._stateGroup),e=524288&this._flags?t.GetPointsRenderingProgram()||"<point>":t.GetTextureFillShaderProgram()||"<default>",this._stateGroup=t.AcquireStateGroup(e,this.GetBlendMode(),this._colorPremultiplied,this.GetZElevation(),this.IsBackFaceCulling()?1:0,0)}GetRendererStateGroup(){return this._stateGroup}HasDefaultColor(){return this._color===bG}SetBlendMode(t){if((t|=0)<0||t>31)throw new RangeError("invalid blend mode");this.GetBlendMode()!==t&&(this._flags=-2080374785&this._flags|t<<26,this._UpdateRendererStateGroup())}GetBlendMode(){return(2080374784&this._flags)>>26}_SetLayer(t,e){const s=e&&this._layer!==t;s&&this._RemoveFromRenderCells(),this._objectClass._OnWorldInstanceLayerChanged(this,this._layer,t),this._layer=t,s&&this._UpdateRenderCell(),0!==this.GetZElevation()&&this._layer._SetAnyInstanceZElevated()}GetLayer(){return this._layer}GetLayout(){return this.GetLayer().GetLayout()}_SetZIndex(t){this._zIndex=0|t}GetZIndex(){return this._layer._UpdateZIndices(),this._zIndex}_SetHTMLZIndex(t){this._htmlZIndex=0|t}GetHTMLZIndex(){return this._layer._UpdateHTMLZIndices(),this._htmlZIndex}_GetLastCachedZIndex(){return this._zIndex}_SetFlag(t,e){e?this._flags|=t:this._flags&=~t}IsVisible(){return!!(1&this._flags)}SetVisible(t){if(this._SetFlag(1,t),this.HasChildren())for(const e of this.GetChildren())e.GetTransformWithParentVisibility()&&e.SetVisible(t)}IsCollisionEnabled(){return!!(8&this._flags)}SetCollisionEnabled(t){t=!!t,this.IsCollisionEnabled()!==t&&(this._SetFlag(8,t),t?this.SetBboxChanged():this._RemoveFromCollisionCells())}SetSolidCollisionFilter(t,e){this._SetFlag(32,t),this._solidFilterTags&&this._solidFilterTags.clear();for(const t of e)this._solidFilterTags||(this._solidFilterTags=new Set),this._solidFilterTags.add(t.toLowerCase());this._solidFilterTags&&0===this._solidFilterTags.size&&(this._solidFilterTags=null)}IsSolidCollisionAllowed(t){const e=t._IsSolidUsingInstanceTags()?t._GetLowercaseTagsSetMaybeNull():t.GetSavedDataMap().get("solidTags"),s=!!(32&this._flags),i=this._solidFilterTags;if(!e||!i)return!s;for(const t of i)if(e.has(t))return s;return!s}SetBboxChanged(){if(this._flags|=65554,this._objectClass._SetAnyCollisionCellChanged(!0),this._runtime.UpdateRender(),this._layer.UsesRenderCells()&&(this.CalculateBbox(this._boundingBox,this._boundingQuad,!0),this._flags&=-3,this._UpdateRenderCell()),4&this._flags&&this._inst.Dispatcher().dispatchEvent(TG),null!==this._sceneGraphInfo){const t=this._sceneGraphInfo.GetChildren();for(let e=0,s=t.length;e<s;++e)t[e].SetBboxChanged()}}CalculateBbox(t,e,s){const i=this.GetX(),r=this.GetY(),n=this.GetWidth(),a=this.GetHeight(),o=this.GetAngle();t.setWH(i-this._ox*n,r-this._oy*a,n,a),s&&this.HasMesh()&&this._ExpandBboxForMesh(t),0===o?e.setFromRect(t):(t.offset(-i,-r),e.setFromRotatedRectPrecalc(t,this.GetSinAngle(),this.GetCosAngle()),e.offset(i,r),e.getBoundingBox(t)),t.normalize()}_UpdateBbox(){const t=this._flags;2&t&&(this.CalculateBbox(this._boundingBox,this._boundingQuad,!0),this._flags=-3&t)}GetBoundingBox(){return this._UpdateBbox(),this._boundingBox}GetBoundingQuad(){return this._UpdateBbox(),this._boundingQuad}PixelRoundQuad(t){const e=this.GetX(),s=this.GetY(),i=Math.round(e)-e,r=Math.round(s)-s;return 0===i&&0===r?t:(GG.copy(t),GG.offset(i,r),GG)}OverwriteBoundingBox(t){this._boundingBox.copy(t),this._boundingQuad.setFromRect(this._boundingBox),this._flags&=-3,this._UpdateCollisionCell(),this._UpdateRenderCell()}SetBboxChangeEventEnabled(t){this._SetFlag(4,t)}IsBboxChangeEventEnabled(){return!!(4&this._flags)}IsInViewport(t,e,s){return e&&0!==this.GetDepth()?this.IsInViewport3D(this.GetLayer()._GetViewFrustum()):0===this.GetZElevation()||s?t.intersectsRect(this.GetBoundingBox()):this._IsInViewport_ZElevated()}_IsInViewport_ZElevated(){const t=this.GetLayer(),e=this.GetTotalZElevation();return!(e>=t.Get2DCameraZ())&&(t.GetViewportForZ(e,yG),yG.intersectsRect(this.GetBoundingBox()))}IsInViewport3D(t){const e=this.GetBoundingBox(),s=e.getLeft(),i=e.getRight(),r=e.getTop(),n=e.getBottom(),a=this.GetTotalZElevation(),o=a+this.GetDepth();return t.ContainsAABB(s,r,a,i,n,o)}IsInViewport2(){const t=this.GetLayer();if(t.Has3DCamera())return this.IsInViewport3D(t._GetViewFrustum());{const e=t.GetLayout();return this.IsInViewport(t.GetViewport(),e.HasVanishingPointOutsideViewport(),e.IsOrthographicProjection())}}_SetDrawBackFaceOnly(t){this._SetFlag(1048576,t)}_SetDrawNonBackFacesOnly(t){this._SetFlag(2097152,t)}IsDrawBackFaceOnly(){return!!(1048576&this._flags)}IsDrawNonBackFacesOnly(){return!!(2097152&this._flags)}SetBackFaceCulling(t){(t=!!t)!==this.IsBackFaceCulling()&&(this._SetFlag(16777216,t),this._UpdateRendererStateGroup())}IsBackFaceCulling(){return!!(16777216&this._flags)}SetSourceCollisionPoly(t){this._sourceCollisionPoly=t,this._DiscardTransformedCollisionPoly(),this.HasMesh()&&(this._meshInfo.meshPoly=null)}GetSourceCollisionPoly(){return this._sourceCollisionPoly}HasOwnCollisionPoly(){return null!==this._sourceCollisionPoly||this.HasMesh()}GetTransformedCollisionPoly(){return this._GetCustomTransformedCollisionPolyPrecalc(this.GetWidth(),this.GetHeight(),this.GetAngle(),this.GetSinAngle(),this.GetCosAngle())}GetCustomTransformedCollisionPoly(t,e,s){let i=0,r=1;return 0!==s&&(i=Math.sin(s),r=Math.cos(s)),this._GetCustomTransformedCollisionPolyPrecalc(t,e,s,i,r)}_GetCustomTransformedCollisionPolyPrecalc(t,e,s,i,r){let n=this._transformedPolyInfo;null===n&&(n={poly:mG.New(mG.CollisionPoly),width:NaN,height:NaN,angle:NaN},this._transformedPolyInfo=n);const a=n.poly;if(n.width===t&&n.height===e&&n.angle===s)return a;const o=this._sourceCollisionPoly;if(this.HasMesh()){const s=this.GetOriginX(),n=this.GetOriginY(),h=this.GetSourceMesh();let l=this._meshInfo.meshPoly;l||(o?(CG.copy(o),CG.offset(s,n)):CG.setDefaultPoints(),l=h.InsertPolyMeshVertices(CG),this._meshInfo.meshPoly=l),h.TransformCollisionPoly(l,a),a.offset(-s,-n),a.transformPrecalc(t,e,i,r)}else o?(a.copy(o),a.transformPrecalc(t,e,i,r)):a.setFromQuad(this.GetBoundingQuad(),-this.GetX(),-this.GetY());return n.width=t,n.height=e,n.angle=s,a}_DiscardTransformedCollisionPoly(){this.SetPhysicsBodyChanged(!0);const t=this._transformedPolyInfo;null!==t&&(t.width=NaN)}CreateMesh(t,e){if(t=Math.floor(t),e=Math.floor(e),!this.GetInstance().GetPlugin().SupportsMesh())throw new Error("object does not support mesh");this.ReleaseMesh(),this._meshInfo={sourceMesh:mG.New(mG.Gfx.Mesh,t,e),transformedMesh:mG.New(mG.Gfx.Mesh,t,e),meshPoly:null}}HasMesh(){return null!==this._meshInfo}GetSourceMesh(){if(!this.HasMesh())throw new Error("no mesh");return this._meshInfo.sourceMesh}GetTransformedMesh(){if(!this.HasMesh())throw new Error("no mesh");return this._meshInfo.transformedMesh}SetMeshChanged(t){this._SetFlag(65536,t)}IsMeshChanged(){return!!(65536&this._flags)}SetPhysicsBodyChanged(t){this._SetFlag(131072,t)}IsPhysicsBodyChanged(){return!!(131072&this._flags)}_ExpandBboxForMesh(t){const e=this._meshInfo.sourceMesh,s=Math.min(e.GetMinX(),0),i=Math.min(e.GetMinY(),0),r=Math.max(e.GetMaxX(),1),n=Math.max(e.GetMaxY(),1),a=t.width(),o=t.height();t.offsetLeft(s*a),t.offsetTop(i*o),t.offsetRight((r-1)*a),t.offsetBottom((n-1)*o),this._depth=e.GetMaxZ()}ReleaseMesh(){this._meshInfo&&(this._meshInfo.sourceMesh.Release(),this._meshInfo.transformedMesh.Release(),this._meshInfo=null,this._DiscardTransformedCollisionPoly())}SetMeshPoint(t,e,s){t=Math.floor(t),e=Math.floor(e);const i=s.mode||"absolute";if(!MG.has(i))throw new Error("invalid mode");const r="relative"===i;let n=s.x,a=s.y;const o=s.zElevation;let h="number"==typeof s.u?s.u:r?0:-1,l="number"==typeof s.v?s.v:r?0:-1;if(!this.HasMesh())return!1;const c=this.GetSourceMesh(),u=c.GetMeshPointAt(t,e);if(null===u)return!1;let _=!1;return"number"==typeof o&&u.GetZElevation()!==o&&(u.SetZElevation(o),_=!0),r&&(n+=t/(c.GetHSize()-1),a+=e/(c.GetVSize()-1)),-1!==h||r?(r&&(h+=t/(c.GetHSize()-1)),h=mG.clamp(h,0,1)):h=u.GetU(),-1!==l||r?(r&&(l+=e/(c.GetVSize()-1)),l=mG.clamp(l,0,1)):l=u.GetV(),u.GetX()===n&&u.GetY()===a&&u.GetU()===h&&u.GetV()===l?_:(u.SetX(n),u.SetY(a),u.SetU(h),u.SetV(l),this._DiscardTransformedCollisionPoly(),!0)}HasTilemap(){return this._inst.HasTilemap()}ContainsPoint(t,e){return!!this.GetBoundingBox().containsPoint(t,e)&&!!this.GetBoundingQuad().containsPoint(t,e)&&(this.HasTilemap()?this._inst.GetSdkInstance().TestPointOverlapTile(t,e):!this.HasOwnCollisionPoly()||this.GetTransformedCollisionPoly().containsPoint(t-this.GetX(),e-this.GetY()))}_IsCollisionCellChanged(){return!!(16&this._flags)}_UpdateCollisionCell(){if(!this._IsCollisionCellChanged()||!this.IsCollisionEnabled()||this.IsDestroyed())return;const t=this.GetBoundingBox(),e=this._objectClass._GetCollisionCellGrid(),s=this._collisionCells;if(yG.set(e.XToCell(t.getLeft()),e.YToCell(t.getTop()),e.XToCell(t.getRight()),e.YToCell(t.getBottom())),s.equals(yG))return;const i=this._inst;s===wG?(e.Update(i,null,yG),this._collisionCells=mG.New(mG.Rect,yG)):(e.Update(i,s,yG),s.copy(yG)),this._flags&=-17}_SetCollisionCellChanged(){this._flags|=16}_RemoveFromCollisionCells(){const t=this._collisionCells;t!==wG&&(this._objectClass._GetCollisionCellGrid().Update(this._inst,t,null),this._collisionCells=wG)}_UpdateRenderCell(){const t=this.GetLayer();if(!t.UsesRenderCells()||this.IsDestroyed())return;const e=t.GetRenderGrid(),s=this.GetBoundingBox(),i=this._renderCells;if(yG.set(e.XToCell(s.getLeft()),e.YToCell(s.getTop()),e.XToCell(s.getRight()),e.YToCell(s.getBottom())),i.equals(yG))return;const r=this._inst;i===xG?(e.Update(r,null,yG),this._renderCells=mG.New(mG.Rect,yG)):(e.Update(r,i,yG),i.copy(yG)),t.SetRenderListStale()}_RemoveFromRenderCells(){const t=this._renderCells;t!==xG&&(this.GetLayer().GetRenderGrid().Update(this._inst,t,null),this._renderCells=xG)}GetRenderCellRange(){return this._renderCells}ZOrderMoveToTop(){if(this.IsDestroyed())return;const t=this._inst,e=this._layer,s=e._GetInstances();s.length&&s.at(-1)===t||(e._RemoveInstance(t,!1),e._AddInstance(t,!1),this._runtime.UpdateRender())}ZOrderMoveToBottom(){if(this.IsDestroyed())return;const t=this._inst,e=this._layer,s=e._GetInstances();s.length&&s[0]===t||(e._RemoveInstance(t,!1),e._PrependInstance(t,!1),this._runtime.UpdateRender())}ZOrderMoveToLayer(t){if(this.IsDestroyed())return;const e=this._inst,s=this._layer;if(s.GetLayout()!==t.GetLayout())throw new Error("layer from different layout");t!==s&&(s._RemoveInstance(e,!0),this._SetLayer(t),t._AddInstance(e,!0),this._runtime.UpdateRender())}ZOrderMoveAdjacentToInstance(t,e){if(this.IsDestroyed())return;const s=this._inst;let i=!1;const r=this._layer;if(t.GetUID()===s.GetUID())return;const n=t.GetWorldInfo();if(!n)throw new Error("expected world instance");const a=n.GetLayer();r.GetIndex()!==a.GetIndex()&&(r._RemoveInstance(s,!0),this._SetLayer(a),a._AddInstance(s,!0),i=!0);const o=a.MoveInstanceAdjacent(s,t,!!e);(i||o)&&this._runtime.UpdateRender()}GetInstanceEffectList(){return this._instanceEffectList}_SetHasAnyActiveEffect(t){this._SetFlag(64,t)}HasAnyActiveEffect(){return!!(64&this._flags)}_SaveToJson(t,e=null){const s={x:this.GetX(),y:this.GetY(),w:this.GetWidth(),h:this.GetHeight(),l:this.GetLayer().GetSID(),zi:this.GetZIndex()};0!==this.GetZElevation()&&(s.ze=this.GetZElevation()),0!==this.GetAngle()&&(s.a=this._GetAngleNoReflect()),this.HasDefaultColor()||(s.c=this._color.toJSON()),.5!==this.GetOriginX()&&(s.oX=this.GetOriginX()),.5!==this.GetOriginY()&&(s.oY=this.GetOriginY()),0!==this.GetBlendMode()&&(s.bm=this.GetBlendMode()),this.IsVisible()||(s.v=this.IsVisible()),this.IsCollisionEnabled()||(s.ce=this.IsCollisionEnabled()),this.IsBboxChangeEventEnabled()&&(s.be=this.IsBboxChangeEventEnabled()),this._instanceEffectList&&(s.fx=this._instanceEffectList._SaveToJson());const i=!!(32&this._flags);return i&&(s.sfi=i),this._solidFilterTags&&(s.sft=[...this._solidFilterTags].join(" ")),this._sceneGraphInfo&&"visual-state"!==t&&(s.sgi=this._sceneGraphInfo._SaveToJson(t,e),RG.has(this)&&(s.sgcd=RG.get(this).childrenData,s.sgzid=RG.get(this).zIndexData)),this.HasMesh()&&(s.mesh=this.GetSourceMesh().SaveToJson()),s}_SaveSceneGraphPropertiesToJson(){return{x:this._x,y:this._y,z:this._zElevation,w:this._w,h:this._h,a:this._a,sgi:this._GetSceneGraphInfo()?this._GetSceneGraphInfo()._SaveToJsonProperties():null}}_LoadSceneGraphPropertiesFromJson(t){t&&(this._x=t.x,this._y=t.y,this._zElevation=t.z,this._w=t.w,this._h=t.h,this._a=t.a,t.sgi&&this._GetSceneGraphInfo()&&this._GetSceneGraphInfo()._LoadFromJson(t.sgi),this._MarkSinCosAngleChanged(),this.SetBboxChanged())}_SetupSceneGraphConnectionsOnChangeOfLayout(){this._ReleaseTmpSceneGraphInfo(),this._ResetAllSceneGraphState(),this._CreateSceneGraphInfo(null),this._sceneGraphInfo&&this._sceneGraphInfo._SetTmpSceneGraphChildren(this._tmpSceneGraphChildren,this._tmpSceneGraphChildrenIndexes)}_OnBeforeLoad(t){"visual-state"!==t&&this._ResetAllSceneGraphState()}_OnAfterLoad(t,e="full",s=null){if(t.hasOwnProperty("sgi")&&"visual-state"!==e){if(this.IsDestroyed())return;this._sceneGraphInfo._OnAfterLoad(t.sgi,s)}}_OnAfterLoad2(t,e="full",s=null){if("visual-state"!==e)if(this.IsDestroyed())this._ReleaseTmpSceneGraphInfo();else{if(t.hasOwnProperty("sgi"))this._sceneGraphInfo._SetTmpSceneGraphChildren(null,null,t.sgi,s);else if(s?.setFromJson&&this._tmpSceneGraphChildren)for(const t of this._tmpSceneGraphChildren)t.IsDestroyed()||this._runtime.DestroyInstance(t);this._ReleaseTmpSceneGraphInfo(),this.SetBboxChanged()}}_LoadFromJson(t,e,s=null){if(vG=!1,this.SetX(t.x),this.SetY(t.y),this.SetWidth(t.w),this.SetHeight(t.h),this._SetZIndex(t.zi),this.SetZElevation(t.hasOwnProperty("ze")?t.ze:0),this.SetAngle(t.hasOwnProperty("a")?t.a:0),t.hasOwnProperty("c")?IG.setFromJSON(t.c):t.hasOwnProperty("o")?(IG.copyRgb(this._color),IG.a=t.o):IG.setRgba(1,1,1,1),this._SetColor(IG),this.SetOriginX(t.hasOwnProperty("oX")?t.oX:.5),this.SetOriginY(t.hasOwnProperty("oY")?t.oY:.5),this.SetBlendMode(t.hasOwnProperty("bm")?t.bm:0),this.SetVisible(!t.hasOwnProperty("v")||t.v),this.SetCollisionEnabled(!t.hasOwnProperty("ce")||t.ce),this.SetBboxChangeEventEnabled(!!t.hasOwnProperty("be")&&t.be),this.SetSolidCollisionFilter(!!t.hasOwnProperty("sfi")&&t.sfi,t.hasOwnProperty("sft")?t.sft:""),this._instanceEffectList&&t.hasOwnProperty("fx")&&this._instanceEffectList._LoadFromJson(t.fx),t.hasOwnProperty("sgi")&&"visual-state"!==e){this._CreateSceneGraphInfo(null);const e=this._sceneGraphInfo,s=t.sgi;e._LoadFromJson(s),e._SetTmpSceneGraphChildren(this._tmpSceneGraphChildren,this._tmpSceneGraphChildrenIndexes),this._SetSceneGraphExportData(t.sgcd,t.sgzid)}if(t.hasOwnProperty("mesh")){const e=t.mesh;this.CreateMesh(e.cols,e.rows),this.GetSourceMesh().LoadFromJson(e)}else this.ReleaseMesh();this.SetBboxChanged(),vG=!0,this._UpdateRendererStateGroup(),"visual-state"!==e&&this._runtime.AddInstanceNeedingAfterLoad(this.GetInstance(),t)}_SetSceneGraphExportData(t,e){t&&mG.IsFiniteNumber(e)&&RG.set(this,{childrenData:t,zIndexData:e})}}}{const DG=self.C3;DG.BehaviorType=class extends DG.DefendedBase{constructor(t,e){super();const s=t.GetRuntime(),i=s.GetObjectReference(e[1]);s.GetAddonManager()._DelayCreateBehavior(i),this._runtime=s,this._objectClass=t,this._behavior=DG.AddonManager.GetBehaviorByConstructorFunction(i),this._sdkType=null,this._iBehaviorType=null,this._instSdkCtor=i.Instance,this._sid=e[2],this._name=e[0],this._jsPropName=this._runtime.GetJsPropName(e[3]);const r=this._behavior.GetSdkVersion();if(r<2&&(this._sdkType=DG.New(i.Type,this),!(this._sdkType instanceof DG.SDKBehaviorTypeBase)))throw new Error("v1 sdk type must derive from SDKBehaviorBase");if(DG.AddonManager._PushInitObject(this,r),r>=2){const t=i.Type??globalThis.ISDKBehaviorTypeBase;if(this._iBehaviorType=new t,!(this._iBehaviorType instanceof globalThis.ISDKBehaviorTypeBase))throw new Error("script interface class must derive from ISDKBehaviorTypeBase")}else this._iBehaviorType=new globalThis.IBehaviorType;DG.AddonManager._PopInitObject(r),this.OnCreate()}static Create(t,e){return DG.New(DG.BehaviorType,t,e)}Release(){this._runtime=null,this._behavior=null,this._sdkType&&(this._sdkType.Release(),this._sdkType=null),this._instSdkCtor=null}GetSdkType(){return this._sdkType}OnCreate(){this._sdkType?this._sdkType.OnCreate():this._iBehaviorType&&this._iBehaviorType._onCreate()}GetRuntime(){return this._runtime}GetObjectClass(){return this._objectClass}GetBehavior(){return this._behavior}GetInstanceSdkCtor(){return this._instSdkCtor}GetName(){return this._name}GetSID(){return this._sid}GetIBehaviorType(){return this._iBehaviorType}GetJsPropName(){return this._jsPropName}}}{const EG=self.C3,FG=self.IBehaviorInstance;EG.BehaviorInstance=class extends EG.DefendedBase{constructor(t){super(),this._runtime=t.runtime,this._behaviorType=t.behaviorType,this._behavior=this._behaviorType.GetBehavior(),this._inst=t.instance,this._index=t.index,this._sdkInst=null,this._iScriptInterface=null,this._behavior._AddInstance(this._inst)}Release(){this._iScriptInterface&&(this._iScriptInterface._release(),this._iScriptInterface=null),this._behavior._RemoveInstance(this._inst),this._sdkInst&&(this._sdkInst.Release(),this._sdkInst=null),this._runtime=null,this._behaviorType=null,this._behavior=null,this._inst=null}_CreateSdkInstance(t){if(this._sdkInst)throw new Error("already got sdk instance");if(this.GetBehavior().GetSdkVersion()<2){if(this._sdkInst=EG.New(this._behaviorType.GetInstanceSdkCtor(),this,t),!(this._sdkInst instanceof EG.SDKBehaviorInstanceBase))throw new Error("v1 sdk type must derive from SDKBehaviorInstanceBase")}else{const e=this.GetBehavior().GetScriptInterfaceClass();this._InitScriptInterface(e.Instance,t)}}GetSdkInstance(){return this._sdkInst??this._iScriptInterface}GetObjectInstance(){return this._inst}GetRuntime(){return this._runtime}GetBehaviorType(){return this._behaviorType}GetBehavior(){return this._behavior}_GetIndex(){return this._index}PostCreate(){this._sdkInst?this._sdkInst.PostCreate():this._iScriptInterface._postCreate()}OnSpriteFrameChanged(t,e){this._sdkInst&&this._sdkInst.OnSpriteFrameChanged(t,e)}_GetDebuggerProperties(){return this._sdkInst?this._sdkInst.GetDebuggerProperties():this._iScriptInterface._getDebuggerProperties()}SaveToJson(t="full"){return this._sdkInst?this._sdkInst.SaveToJson(t):this._iScriptInterface._saveToJson(t)}LoadFromJson(t,e="full"){if(this._sdkInst)return this._sdkInst.LoadFromJson(t,e);this._iScriptInterface._loadFromJson(t,e)}static SortByTickSequence(t,e,s){const i=globalThis.ISDKBehaviorInstanceBase;let r,n;r=e instanceof i?t._UnwrapScriptInterface(e):e.GetBehaviorInstance(),n=s instanceof i?t._UnwrapScriptInterface(s):s.GetBehaviorInstance();const a=r.GetObjectInstance(),o=n.GetObjectInstance(),h=a.GetObjectClass().GetIndex(),l=o.GetObjectClass().GetIndex();if(h!==l)return h-l;const c=a.GetPUID(),u=o.GetPUID();return c!==u?c-u:r._GetIndex()-n._GetIndex()}_InitScriptInterface(t,e){const s=FG,i=t??this._sdkInst.GetScriptInterfaceClass(),r=i||s,n=this.GetBehavior().GetSdkVersion();if(EG.AddonManager._PushInitObject(this,n),EG.AddonManager._PushInitProperties(e),this._iScriptInterface=new r,EG.AddonManager._PopInitProperties(),EG.AddonManager._PopInitObject(n),i&&!(this._iScriptInterface instanceof s))throw new TypeError(`script interface class '${i.name}' does not extend the right base class '${s.name}'`);return this._iScriptInterface}GetScriptInterface(){return this._iScriptInterface||this._InitScriptInterface()}HasScriptInterface(){return!!this._iScriptInterface}}}{const OG=self.C3;OG.EffectList=class extends OG.DefendedBase{constructor(t,e){super(),this._owner=t,this._allEffectTypes=[],this._activeEffectTypes=[],this._effectTypesByName=new Map,this._effectParams=[],this._effectParamBuffers=[],this._allInstanceEffectLists=new Set,this._preservesOpaqueness=!0;for(const t of e){const e=OG.New(OG.EffectType,this,t,this._allEffectTypes.length);this._allEffectTypes.push(e),this._effectTypesByName.set(e.GetName().toLowerCase(),e),t.length>=3&&this._effectParams.push(this._LoadSingleEffectParameters(e,t[2]))}this.GetRuntime()._AddEffectList(this)}Release(){this.GetRuntime()._RemoveEffectList(this);for(const t of this._effectParamBuffers)t.Release();OG.clearArray(this._effectParamBuffers),OG.clearArray(this._allEffectTypes),OG.clearArray(this._activeEffectTypes),this._effectTypesByName.clear(),OG.clearArray(this._effectParams),this._owner=null}_AddInstanceEffectList(t){this._allInstanceEffectLists.add(t)}_RemoveInstanceEffectList(t){this._allInstanceEffectLists.delete(t)}_InitRenderer(t){t.IsWebGPU()&&(this._effectParamBuffers=this._allEffectTypes.map(t=>{const e=t.GetShaderProgram();return e.GetCustomParametersByteSize()>0?OG.New(OG.Gfx.WebGPUEffectCustomParamsBuffer,e):null}),this._UpdateAllEffectParamBuffers());for(const e of this._allInstanceEffectLists)e._InitRenderer(t)}PrependEffectTypes(t){if(t.length){this._allEffectTypes=t.concat(this._allEffectTypes);for(const e of t)this._effectTypesByName.set(e.GetName().toLowerCase(),e);for(let t=0,e=this._allEffectTypes.length;t<e;++t)this._allEffectTypes[t]._SetIndex(t)}}_LoadSingleEffectParameters(t,e){t.SetActive(e[0]);const s=e.slice(1);for(let t=0,e=s.length;t<e;++t){const e=s[t];if(Array.isArray(e)){const i=OG.New(OG.Color);i.setFromJSON(e),s[t]=i}}return s}GetOwner(){return this._owner}GetRuntime(){return this._owner.GetRuntime()}UpdateActiveEffects(){OG.clearArray(this._activeEffectTypes);let t=!0;for(const e of this._allEffectTypes)e.IsActive()&&(this._activeEffectTypes.push(e),e.GetShaderProgram().PreservesOpaqueness()||(t=!1));this._preservesOpaqueness=t}GetAllEffectTypes(){return this._allEffectTypes}HasAnyEffectType(){return this._allEffectTypes.length>0}GetEffectTypeByName(t){return this._effectTypesByName.get(t.toLowerCase())||null}GetEffectTypeByIndex(t){if((t=Math.floor(+t))<0||t>=this._allEffectTypes.length)throw new RangeError("invalid effect type index");return this._allEffectTypes[t]}IsEffectIndexActive(t){return this.GetEffectTypeByIndex(t).IsActive()}SetEffectIndexActive(t,e){this.GetEffectTypeByIndex(t).SetActive(e)}GetActiveEffectTypes(){return this._activeEffectTypes}HasAnyActiveEffect(){return this._activeEffectTypes.length>0}PreservesOpaqueness(){return this._preservesOpaqueness}GetEffectParametersForIndex(t){return this._effectParams[t]}_GetEffectChainShaderParametersForIndex(t){return t<this._effectParamBuffers.length?this._effectParamBuffers[t]:this._effectParams[t]}GetEffectParameter(t,e){if(t<0||t>=this._effectParams.length)return null;const s=this._effectParams[t];return e<0||e>=s.length?null:s[e]}SetEffectParameter(t,e,s){if(t<0||t>=this._effectParams.length)return!1;const i=this._effectParams[t];if(e<0||e>=i.length)return!1;const r=i[e];if(r instanceof OG.Color){if(r.equalsIgnoringAlpha(s))return!1;r.copyRgb(s)}else{if(r===s)return!1;i[e]=s}return t<this._effectParamBuffers.length&&this._effectParamBuffers[t].SetParameterValue(e,s),!0}_UpdateAllEffectParamBuffers(){const t=this._effectParams,e=this._effectParamBuffers;for(let s=0,i=Math.min(t.length,e.length);s<i;++s){const i=e[s],r=t[s];for(let t=0,e=r.length;t<e;++t)i.SetParameterValue(t,r[t])}}static SaveFxParamToJson(t){return t&&t instanceof OG.Color?{t:"color",v:t.toJSON()}:t}static LoadFxParamFromJson(t){if(null===t)return NaN;if("object"==typeof t){if("color"===t.t){const e=OG.New(OG.Color);return e.setFromJSON(t.v),e}throw new Error("invalid effect parameter type")}return t}static SaveFxParamsToJson(t){return t.map(OG.EffectList.SaveFxParamToJson)}static LoadFxParamsFromJson(t){return t.map(OG.EffectList.LoadFxParamFromJson)}SaveToJson(){return this._allEffectTypes.map(t=>({name:t.GetName(),active:t.IsActive(),params:OG.EffectList.SaveFxParamsToJson(this._effectParams[t.GetIndex()])}))}LoadFromJson(t){for(const e of t){const t=this.GetEffectTypeByName(e.name);t&&(t.SetActive(e.active),this._effectParams[t.GetIndex()]=OG.EffectList.LoadFxParamsFromJson(e.params))}this.UpdateActiveEffects(),this._UpdateAllEffectParamBuffers()}}}{const BG=self.C3;BG.EffectType=class extends BG.DefendedBase{constructor(t,e,s){super(),this._effectList=t,this._id=e[0],this._name=e[1],this._index=s,this._shaderProgram=null,this._isActive=!0}Release(){this._effectList=null,this._shaderProgram=null}Clone(t){const e=BG.New(BG.EffectType,t,[this._id,this._name],-1);return e._shaderProgram=this._shaderProgram,e._isActive=this._isActive,e}_InitRenderer(t){const e=t.GetShaderProgramByName(this._id);if(!e)throw new Error("failed to find shader program '"+this._id+"'");this._shaderProgram=e}GetEffectList(){return this._effectList}GetName(){return this._name}_SetIndex(t){this._index=t}GetIndex(){return this._index}GetOwner(){return this._effectList.GetOwner()}GetRuntime(){return this._effectList.GetRuntime()}SetActive(t){this._isActive=!!t}IsActive(){return this._isActive}GetShaderProgram(){return this._shaderProgram}GetDefaultParameterValues(){const t=[];for(let e=0,s=this._shaderProgram.GetParameterCount();e<s;++e){const s=this._shaderProgram.GetParameterType(e);if("float"===s||"percent"===s)t.push(0);else{if("color"!==s)throw new TypeError("unknown effect parameter type");t.push(BG.New(BG.Color,1,1,1,1))}}return t}}}{const LG=self.C3;LG.InstanceEffectList=class extends LG.DefendedBase{constructor(t,e){super(),this._inst=t,this._wi=e,this._effectList=t.GetObjectClass().GetEffectList(),this._needsRebuildSteps=!0,this._wasDefaultColor=!0,this._was3D=!1,this._wasRotatedOrNegativeSize=!1,this._wasTexRotated=!1,this._wasMustPreDraw=!1,this._effectChain=LG.New(LG.Gfx.EffectChain,t.GetRuntime().GetCanvasManager().GetEffectChainManager(),{drawContent:(t,e)=>{const s=e.GetContentObject(),i=s.GetWorldInfo();t.SetColor(i.GetPremultipliedColor()),t.SetCurrentZ(i.GetTotalZElevation()),s.Draw(t),t.SetCurrentZ(0)},getSourceTextureInfo:t=>{const e=t.GetCurrentTexRect(),[s,i]=t.GetCurrentSurfaceSize();return{srcTexRect:e,srcWidth:s,srcHeight:i}},getShaderParameters:t=>this._GetEffectChainShaderParametersForIndex(t)}),this._activeEffectFlags=[],this._activeEffectTypes=[],this._preservesOpaqueness=!0,this._effectParams=[],this._effectParamBuffers=[],this._InitRenderer(t.GetRuntime().GetRenderer());for(let t=0,e=this._effectList.GetAllEffectTypes().length;t<e;++t)this._activeEffectFlags.push(!0);this.UpdateActiveEffects(),this._effectList._AddInstanceEffectList(this)}Release(){this._effectList._RemoveInstanceEffectList(this);for(const t of this._effectParamBuffers)t&&t.Release();LG.clearArray(this._effectParamBuffers),this._effectChain.Release(),this._effectChain=null,LG.clearArray(this._activeEffectFlags),LG.clearArray(this._activeEffectTypes),LG.clearArray(this._effectParams),this._inst=null,this._effectList=null}_InitRenderer(t){t.IsWebGPU()&&(this._effectParamBuffers=this._effectList.GetAllEffectTypes().map(t=>{const e=t.GetShaderProgram();return e.GetCustomParametersByteSize()>0?LG.New(LG.Gfx.WebGPUEffectCustomParamsBuffer,e):null}))}_LoadEffectParameters(t){let e=0;for(const s of t)this._effectParams.push(this._LoadSingleEffectParameters(e,s)),++e;this._UpdateAllEffectParamBuffers(),this.UpdateActiveEffects()}_LoadSingleEffectParameters(t,e){this._activeEffectFlags[t]=e[0];const s=e.slice(1);for(let t=0,e=s.length;t<e;++t){const e=s[t];if(Array.isArray(e)){const i=LG.New(LG.Color);i.setFromJSON(e),s[t]=i}}return s}LoadDefaultEffectParameters(){for(const t of this._effectList.GetAllEffectTypes())this._effectParams.push(t.GetDefaultParameterValues());this._UpdateAllEffectParamBuffers()}GetOwner(){return this._owner}GetEffectList(){return this._effectList}GetEffectChain(){return this._MaybeRebuildEffectChainSteps(),this._effectChain}GetRuntime(){return this._inst.GetRuntime()}UpdateActiveEffects(){LG.clearArray(this._activeEffectTypes);const t=this._wi,e=this._effectList.GetAllEffectTypes(),s=this._activeEffectTypes,i=this._activeEffectFlags;let r=!0;for(let t=0,n=e.length;t<n;++t)if(i[t]){const i=e[t];s.push(i),i.GetShaderProgram().PreservesOpaqueness()||(r=!1)}this._preservesOpaqueness=r,t._SetHasAnyActiveEffect(!!s.length),this._needsRebuildSteps=!0}_MaybeRebuildEffectChainSteps(){const t=this._inst,e=this._wi,s=e.HasDefaultColor(),i=t.GetPlugin().Is3D(),r=0!==e.GetAngle()||0!==e.GetLayer().GetAngle()||e.GetWidth()<0||e.GetHeight()<0,n=t.IsCurrentTexRotated(),a=t.MustPreDraw();(this._needsRebuildSteps||s!==this._wasDefaultColor||i!==this._was3D||r!==this._wasRotatedOrNegativeSize||n!==this._wasTexRotated||a!==this._wasMustPreDraw||this._effectChain.NeedsRebuild())&&(this._effectChain.BuildSteps(this._activeEffectTypes.map(t=>t.GetShaderProgram()),{indexMap:this._activeEffectTypes.map(t=>t.GetIndex()),forcePreDraw:!s||a,is3D:i,isSourceTextureRotated:n,isRotatedOrNegativeSizeInstance:r}),this._needsRebuildSteps=!1,this._wasDefaultColor=s,this._was3D=i,this._wasRotatedOrNegativeSize=r,this._wasTexRotated=n,this._wasMustPreDraw=a)}GetActiveEffectTypes(){return this._activeEffectTypes}GetEffectParametersForIndex(t){return this._effectParams[t]}_GetEffectChainShaderParametersForIndex(t){return t<this._effectParamBuffers.length?this._effectParamBuffers[t]:this._effectParams[t]}GetEffectParameter(t,e){if(t<0||t>=this._effectParams.length)return null;const s=this._effectParams[t];return e<0||e>=s.length?null:s[e]}SetEffectParameter(t,e,s){if(t<0||t>=this._effectParams.length)return!1;const i=this._effectParams[t];if(e<0||e>=i.length)return!1;const r=i[e];if(r instanceof LG.Color){if(r.equalsIgnoringAlpha(s))return!1;r.copyRgb(s)}else{if(r===s)return!1;i[e]=s}return t<this._effectParamBuffers.length&&this._effectParamBuffers[t].SetParameterValue(e,s),!0}_UpdateAllEffectParamBuffers(){const t=this._effectParams,e=this._effectParamBuffers;for(let s=0,i=e.length;s<i;++s){const i=e[s],r=t[s];for(let t=0,e=r.length;t<e;++t)i.SetParameterValue(t,r[t])}}PreservesOpaqueness(){return this._preservesOpaqueness}HasAnyActiveBackgroundBlendingEffect(){return this._activeEffectTypes.some(t=>t.GetShaderProgram().BlendsBackground())}IsEffectIndexActive(t){return this._activeEffectFlags[t]}SetEffectIndexActive(t,e){this._activeEffectFlags[t]=!!e}GetAllEffectTypes(){return this._effectList.GetAllEffectTypes()}_SaveToJson(){return this._effectList.GetAllEffectTypes().map(t=>({name:t.GetName(),active:this._activeEffectFlags[t.GetIndex()],params:LG.EffectList.SaveFxParamsToJson(this._effectParams[t.GetIndex()])}))}_LoadFromJson(t){for(const e of t){const t=this._effectList.GetEffectTypeByName(e.name);t&&(this._activeEffectFlags[t.GetIndex()]=e.active,this._effectParams[t.GetIndex()]=LG.EffectList.LoadFxParamsFromJson(e.params))}this.UpdateActiveEffects(),this._UpdateAllEffectParamBuffers()}}}{const kG=self.C3,NG=[],UG=[],WG=[],jG=kG.New(kG.CollisionPoly),VG=kG.New(kG.CollisionPoly),zG=kG.New(kG.Quad),HG=kG.New(kG.Rect),YG=kG.New(kG.Rect);let XG=null,qG=null,JG=null;kG.CollisionEngine=class extends kG.DefendedBase{constructor(t){super(),this._runtime=t,this._collisionCellWidth=0,this._collisionCellHeight=0,this._registeredCollisions=[],this._collisionCheckCount=0,this._collisionCheckSec=0,this._polyCheckCount=0,this._polyCheckSec=0,this._iCollisionEngine=new self.ICollisionEngine(this)}Release(){this._runtime=null}GetRuntime(){return this._runtime}GetICollisionEngine(){return this._iCollisionEngine}_Update1sStats(){this._collisionCheckSec=this._collisionCheckCount,this._collisionCheckCount=0,this._polyCheckSec=this._polyCheckCount,this._polyCheckCount=0}Get1secCollisionChecks(){return this._collisionCheckSec}Get1secPolyChecks(){return this._polyCheckSec}RegisterCollision(t,e){const s=t.GetWorldInfo(),i=e.GetWorldInfo();s&&i&&s.IsCollisionEnabled()&&i.IsCollisionEnabled()&&this._registeredCollisions.push([t,e])}AddRegisteredCollisionCandidates(t,e,s){for(const[i,r]of this._registeredCollisions){let n=null;if(t===i)n=r;else{if(t!==r)continue;n=i}n.BelongsToObjectClass(e)&&(s.includes(n)||s.push(n))}}CheckRegisteredCollision(t,e){if(!this._registeredCollisions.length)return!1;for(const[s,i]of this._registeredCollisions)if(t===s&&e===i||t===i&&e===s)return!0;return!1}ClearRegisteredCollisions(){kG.clearArray(this._registeredCollisions)}TestOverlap(t,e){if(!t||!e||t===e)return!1;const s=t.GetWorldInfo(),i=e.GetWorldInfo();if(!s.IsCollisionEnabled()||!i.IsCollisionEnabled())return!1;this._collisionCheckCount++;const r=s.GetLayer(),n=i.GetLayer();return r.IsTransformCompatibleWith(n)?this._TestOverlap_SameLayers(s,i):this._TestOverlap_DifferentLayers(s,i)}_TestOverlap_SameLayers(t,e){if(!t.GetBoundingBox().intersectsRect(e.GetBoundingBox()))return!1;if(this._polyCheckCount++,!t.GetBoundingQuad().intersectsQuad(e.GetBoundingQuad()))return!1;if(t.HasTilemap()&&e.HasTilemap())return!1;if(t.HasTilemap())return this.TestTilemapOverlap(t,e);if(e.HasTilemap())return this.TestTilemapOverlap(e,t);if(!t.HasOwnCollisionPoly()&&!e.HasOwnCollisionPoly())return!0;const s=t.GetTransformedCollisionPoly(),i=e.GetTransformedCollisionPoly();return s.intersectsPoly(i,e.GetX()-t.GetX(),e.GetY()-t.GetY())}_TestOverlap_DifferentLayers(t,e){const s=t.HasTilemap(),i=e.HasTilemap();if(s&&!i)return this.TestTilemapOverlapDifferentLayers(t,e);if(i&&!s)return this.TestTilemapOverlapDifferentLayers(e,t);if(i||s)return!1;{const s=t.GetLayer(),i=e.GetLayer();jG.copy(t.GetTransformedCollisionPoly()),VG.copy(e.GetTransformedCollisionPoly());const r=jG.pointsArr();for(let e=0,i=r.length;e<i;e+=2){const i=e+1,n=r[e],a=r[i],[o,h]=s.LayerToCanvasCss(n+t.GetX(),a+t.GetY());r[e]=o,r[i]=h}const n=VG.pointsArr();for(let t=0,s=n.length;t<s;t+=2){const s=t+1,r=n[t],a=n[s],[o,h]=i.LayerToCanvasCss(r+e.GetX(),a+e.GetY());n[t]=o,n[s]=h}return jG.setBboxChanged(),VG.setBboxChanged(),this._polyCheckCount++,jG.intersectsPoly(VG,0,0)}}TestTilemapOverlapDifferentLayers(t,e){const s=t.GetLayer(),i=e.GetLayer();XG||(XG=kG.New(kG.CollisionPoly)),qG||(qG=kG.New(kG.Rect)),JG||(JG=kG.New(kG.Quad));const r=e.GetX(),n=e.GetY(),[a,o]=i.LayerToCanvasCss(r,n),[h,l]=s.CanvasCssToLayer(a,o),c=h-r,u=l-n;if(qG.copy(e.GetBoundingBox()),qG.offset(c,u),!t.GetBoundingBox().intersectsRect(qG))return!1;if(JG.copy(e.GetBoundingQuad()),JG.offset(c,u),this._polyCheckCount++,!t.GetBoundingQuad().intersectsQuad(JG))return!1;XG.copy(e.GetTransformedCollisionPoly());const _=XG.pointsArr();for(let t=0,e=_.length;t<e;t+=2){const e=t+1;_[t]+=c,_[e]+=u}return XG.setBboxChanged(),this.TestTilemapOverlap(t,e,h,l,XG,qG,JG)}TestTilemapOverlap(t,e,s,i,r,n,a){const o=void 0!==n?n:e.GetBoundingBox(),h=t.GetX(),l=t.GetY(),c=t.GetInstance().GetSdkInstance(),u=void 0!==s?s:e.GetX(),_=void 0!==i?i:e.GetY(),d=e.HasOwnCollisionPoly(),p=void 0!==a?a:e.GetBoundingQuad(),f=UG;c.GetCollisionRectCandidates(o,f);for(let t=0,s=f.length;t<s;++t){const s=f[t],i=s.GetRect();if(this._collisionCheckCount++,o.intersectsRectOffset(i,h,l)&&(zG.setFromRect(i),zG.offset(h,l),zG.intersectsQuad(p)))if(d){const t=void 0!==r?r:e.GetTransformedCollisionPoly();let n=u,a=_;void 0!==r&&(n=e.GetX(),a=e.GetY());const o=s.GetPoly();if(o){if(this._polyCheckCount++,o.intersectsPoly(t,n-(h+i.getLeft()),a-(l+i.getTop())))return kG.clearArray(f),!0}else if(jG.setFromQuad(zG,0,0),jG.intersectsPoly(t,n,a))return kG.clearArray(f),!0}else{const t=s.GetPoly();if(!t)return kG.clearArray(f),!0;if(jG.setFromQuad(p,0,0),t.intersectsPoly(jG,-(h+i.getLeft()),-(l+i.getTop())))return kG.clearArray(f),!0}}return kG.clearArray(f),!1}TestAndSelectCanvasPointOverlap(t,e,s){const i=t.GetCurrentSol(),r=this._runtime.GetCurrentEvent();if(!r)throw new Error("cannot call outside event");const n=r.IsOrBlock(),a=new kG.LayerStateCache;if(i.IsSelectAll()){s||(i._SetSelectAll(!1),kG.clearArray(i._GetOwnInstances())),n&&kG.clearArray(i._GetOwnElseInstances());for(const r of t.GetInstances()){const t=r.GetWorldInfo(),o=t.GetLayer();let h=!1;if(a.IsInteractive(o)&&t.IsInViewport2()&&(h=e.some(([e,s])=>{const[i,r]=a.CanvasCssToLayer(o,e,s,t.GetTotalZElevation());return t.ContainsPoint(i,r)})),h){if(s)return!1;i._PushInstance(r)}else n&&i._PushElseInstance(r)}}else{let t,o=!1;n&&!r.IsFirstConditionOfType(this._runtime.GetCurrentCondition())?this._runtime.IsCurrentConditionFirst()&&!i._GetOwnElseInstances().length&&i._GetOwnInstances().length?t=i._GetOwnInstances():(t=i._GetOwnElseInstances(),o=!0):t=i._GetOwnInstances();let h=0;for(let r=0,l=t.length;r<l;++r){const l=t[r],c=l.GetWorldInfo(),u=c.GetLayer();let _=!1;if(a.IsInteractive(u)&&c.IsInViewport2()&&(_=e.some(([t,e])=>{const[s,i]=a.CanvasCssToLayer(u,t,e,c.GetTotalZElevation());return c.ContainsPoint(s,i)})),_){if(s)return!1;o?i._PushInstance(l):t[h++]=l}else o?t[h++]=l:n&&i._PushElseInstance(l)}s||(t.length=h)}return t.ApplySolToContainer(),a.Release(),!!s||i.HasAnyInstances()}_ObjectClassCanUseCollisionCells(t,e){if(!t)return!0;for(const s of e.layersHasInstancesOn())if(!t.IsTransformCompatibleWith(s))return!1;return!0}GetCollisionCandidates(t,e,s,i){if(e.IsFamily())for(const r of e.GetFamilyMembers())this._ObjectClassCanUseCollisionCells(t,r)?(r._UpdateAllCollisionCells(),r._GetCollisionCellGrid().QueryRange(s,i)):kG.appendArray(i,r.GetInstances());else this._ObjectClassCanUseCollisionCells(t,e)?(e._UpdateAllCollisionCells(),e._GetCollisionCellGrid().QueryRange(s,i)):kG.appendArray(i,e.GetInstances())}GetObjectClassesCollisionCandidates(t,e,s,i){for(const r of e)this.GetCollisionCandidates(t,r,s,i)}GetSolidCollisionCandidates(t,e,s){const i=this._runtime.GetSolidBehavior();i&&this.GetObjectClassesCollisionCandidates(t,i.GetObjectClasses(),e,s)}GetJumpthruCollisionCandidates(t,e,s){const i=this._runtime.GetJumpthruBehavior();i&&this.GetObjectClassesCollisionCandidates(t,i.GetObjectClasses(),e,s)}IsSolidCollisionAllowed(t,e){return t._IsSolidEnabled()&&(!e||e.GetWorldInfo().IsSolidCollisionAllowed(t))}TestOverlapSolid(t){const e=t.GetWorldInfo();this.GetSolidCollisionCandidates(e.GetLayer(),e.GetBoundingBox(),NG);for(const e of NG)if(this.IsSolidCollisionAllowed(e,t)&&this.TestOverlap(t,e))return kG.clearArray(NG),e;return kG.clearArray(NG),null}TestRectOverlapSolid(t,e){this.GetSolidCollisionCandidates(null,t,NG);for(const s of NG)if(this.IsSolidCollisionAllowed(s,e)&&this.TestRectOverlap(t,s))return kG.clearArray(NG),s;return kG.clearArray(NG),null}TestOverlapJumpthru(t,e){let s=null;e&&(s=WG,kG.clearArray(s));const i=t.GetWorldInfo();this.GetJumpthruCollisionCandidates(i.GetLayer(),i.GetBoundingBox(),NG);for(const i of NG)if(i._IsJumpthruEnabled()&&this.TestOverlap(t,i)){if(!e)return kG.clearArray(NG),i;s.push(i)}return kG.clearArray(NG),s}PushOut(t,e,s,i,r){i=i||50;const n=t.GetWorldInfo(),a=n.GetX(),o=n.GetY();for(let h=0;h<i;++h)if(n.SetXY(a+e*h,o+s*h),n.SetBboxChanged(),!this.TestOverlap(t,r))return!0;return n.SetXY(a,o),n.SetBboxChanged(),!1}PushOutSolid(t,e,s,i,r,n){i=i||50;const a=t.GetWorldInfo(),o=a.GetX(),h=a.GetY();let l=null,c=null;for(let u=0;u<i;++u)if(a.SetXY(o+e*u,h+s*u),a.SetBboxChanged(),!this.TestOverlap(t,l))if(l=this.TestOverlapSolid(t),l)c=l;else if(r&&(l=n?this.TestOverlap(t,n)?n:null:this.TestOverlapJumpthru(t),l&&(c=l)),!l)return c&&this.PushInFractional(t,e,s,c,16,!0),!0;return a.SetXY(o,h),a.SetBboxChanged(),!1}PushOutSolidAxis(t,e,s,i){i=i||50;const r=t.GetWorldInfo(),n=r.GetX(),a=r.GetY();let o=null,h=null;for(let l=0;l<i;++l)for(let i=0;i<2;++i){const c=2*i-1;if(r.SetXY(n+e*l*c,a+s*l*c),r.SetBboxChanged(),!this.TestOverlap(t,o)){if(o=this.TestOverlapSolid(t),!o)return h&&this.PushInFractional(t,e*c,s*c,h,16,!0),!0;h=o}}return r.SetXY(n,a),r.SetBboxChanged(),!1}PushInFractional(t,e,s,i,r,n){let a=2,o=!1,h=!1;const l=t.GetWorldInfo();let c=l.GetX(),u=l.GetY();for(;a<=r;){const r=1/a;a*=2,l.OffsetXY(e*r*(o?1:-1),s*r*(o?1:-1)),l.SetBboxChanged(),this.TestOverlap(t,i)||n&&this.TestOverlapSolid(t)?(o=!0,h=!0):(o=!1,h=!1,c=l.GetX(),u=l.GetY())}h&&(l.SetXY(c,u),l.SetBboxChanged())}PushOutSolidNearest(t,e=100){let s=0;const i=t.GetWorldInfo(),r=i.GetX(),n=i.GetY();let a=0,o=this.TestOverlapSolid(t);if(!o)return!0;for(;s<=e;){let e=0,h=0;switch(a){case 0:e=0,h=-1,s++;break;case 1:e=1,h=-1;break;case 2:e=1,h=0;break;case 3:e=1,h=1;break;case 4:e=0,h=1;break;case 5:e=-1,h=1;break;case 6:e=-1,h=0;break;case 7:e=-1,h=-1}if(a=(a+1)%8,i.SetXY(Math.floor(r+e*s),Math.floor(n+h*s)),i.SetBboxChanged(),!this.TestOverlap(t,o)&&(o=this.TestOverlapSolid(t),!o))return!0}return i.SetXY(r,n),i.SetBboxChanged(),!1}CalculateBounceAngle(t,e,s,i){const r=t.GetWorldInfo(),n=r.GetX(),a=r.GetY(),o=Math.max(10,kG.distanceTo(e,s,n,a)),h=kG.angleTo(e,s,n,a),l=i||this.TestOverlapSolid(t);if(!l)return kG.clampAngle(h+Math.PI);let c=l,u=0,_=0;const d=kG.toRadians(5);let p;for(p=1;p<36;++p){const n=h-p*d;if(r.SetXY(e+Math.cos(n)*o,s+Math.sin(n)*o),r.SetBboxChanged(),!this.TestOverlap(t,c)&&(c=i?null:this.TestOverlapSolid(t),!c)){u=n;break}}for(36===p&&(u=kG.clampAngle(h+Math.PI)),c=l,p=1;p<36;++p){const n=h+p*d;if(r.SetXY(e+Math.cos(n)*o,s+Math.sin(n)*o),r.SetBboxChanged(),!this.TestOverlap(t,c)&&(c=i?null:this.TestOverlapSolid(t),!c)){_=n;break}}if(36===p&&(_=kG.clampAngle(h+Math.PI)),r.SetXY(n,a),r.SetBboxChanged(),_===u)return _;const f=kG.angleDiff(_,u)/2;let g;g=kG.angleClockwise(_,u)?kG.clampAngle(u+f+Math.PI):kG.clampAngle(_+f);const m=Math.cos(h),S=Math.sin(h),y=Math.cos(g),G=Math.sin(g),T=m*y+S*G,I=m-2*T*y,C=S-2*T*G;return kG.angleTo(0,0,I,C)}TestSegmentOverlap(t,e,s,i,r){if(!r)return!1;const n=r.GetWorldInfo();return!!n.IsCollisionEnabled()&&(this._collisionCheckCount++,HG.set(Math.min(t,s),Math.min(e,i),Math.max(t,s),Math.max(e,i)),!!n.GetBoundingBox().intersectsRect(HG)&&(r.HasTilemap()?this._TestSegmentOverlapTilemap(t,e,s,i,r,n):(this._polyCheckCount++,!!n.GetBoundingQuad().intersectsSegment(t,e,s,i)&&(!n.HasOwnCollisionPoly()||n.GetTransformedCollisionPoly().intersectsSegment(n.GetX(),n.GetY(),t,e,s,i)))))}_TestSegmentOverlapTilemap(t,e,s,i,r,n){const a=n.GetX(),o=n.GetY(),h=r.GetSdkInstance(),l=UG;YG.set(t,e,s,i),YG.normalize(),h.GetCollisionRectCandidates(YG,l);for(let r=0,n=l.length;r<n;++r){const n=l[r],h=n.GetRect();if(this._collisionCheckCount++,HG.intersectsRectOffset(h,a,o)&&(zG.setFromRect(h),zG.offset(a,o),zG.intersectsSegment(t,e,s,i))){const r=n.GetPoly();if(!r)return kG.clearArray(l),!0;if(this._polyCheckCount++,r.intersectsSegment(a+h.getLeft(),o+h.getTop(),t,e,s,i))return kG.clearArray(l),!0}}return kG.clearArray(l),!1}TestRectOverlap(t,e){if(!e)return!1;const s=e.GetWorldInfo();if(!s.IsCollisionEnabled())return!1;if(this._collisionCheckCount++,!s.GetBoundingBox().intersectsRect(t))return!1;if(e.HasTilemap())return this._TestRectOverlapTilemap(t,e,s);if(this._polyCheckCount++,zG.setFromRect(t),!s.GetBoundingQuad().intersectsQuad(zG))return!1;if(!s.HasOwnCollisionPoly())return!0;const i=jG;i.setFromRect(t,s.GetX(),s.GetY());const r=s.GetTransformedCollisionPoly();return i.intersectsPoly(r,0,0)}_TestRectOverlapTilemap(t,e,s){const i=s.GetX(),r=s.GetY(),n=e.GetSdkInstance(),a=UG;n.GetCollisionRectCandidates(t,a);for(let e=0,s=a.length;e<s;++e){const s=a[e],n=s.GetRect();if(this._collisionCheckCount++,t.intersectsRectOffset(n,i,r)){const e=s.GetPoly();if(!e)return kG.clearArray(a),!0;if(this._polyCheckCount++,jG.setFromRect(t,0,0),e.intersectsPoly(jG,-(i+n.getLeft()),-(r+n.getTop())))return kG.clearArray(a),!0}}return kG.clearArray(a),!1}TestRayIntersectsInstance(t,e){if(!t)return;const s=t.GetWorldInfo();s.IsCollisionEnabled()&&(this._collisionCheckCount++,s.GetBoundingBox().intersectsRect(e.rect)&&(t.HasTilemap()?this._TestRayIntersectsTilemap(t,s,e):(this._polyCheckCount++,s.HasOwnCollisionPoly()?e.TestInstancePoly(t,s.GetX(),s.GetY(),s.GetTransformedCollisionPoly()):e.TestInstanceQuad(t,s.GetBoundingQuad()))))}_TestRayIntersectsTilemap(t,e,s){const i=e.GetX(),r=e.GetY(),n=UG;t.GetSdkInstance().GetCollisionRectCandidates(s.rect,n);for(let a=0,o=n.length;a<o;a++){const o=n[a],h=o.GetRect();if(this._collisionCheckCount++,s.rect.intersectsRectOffset(h,i,r)){const n=o.GetPoly();this._polyCheckCount++,n?s.TestInstancePoly(t,i+h.getLeft(),r+h.getTop(),n):s.TestInstanceRect(t,e.GetX(),e.GetY(),h)}}kG.clearArray(n)}SetCollisionCellSize(t,e){if(t===this._collisionCellWidth&&e===this._collisionCellHeight)return;this._collisionCellWidth=t,this._collisionCellHeight=e;const s=this._runtime.GetAllObjectClasses();for(const i of s)if(i.IsWorldType()){for(const t of i.instancesIncludingPendingCreate())t.GetWorldInfo()._RemoveFromCollisionCells();i._GetCollisionCellGrid().SetCellSize(t,e),i._SetAnyCollisionCellChanged();for(const t of i.instancesIncludingPendingCreate()){const e=t.GetWorldInfo();e._SetCollisionCellChanged(),e._UpdateCollisionCell()}}}GetCollisionCellSize(){return[this._collisionCellWidth,this._collisionCellHeight]}_InitCollisionCellSize(t,e){this._collisionCellWidth=t,this._collisionCellHeight=e}}}{const QG=self.C3;QG.SparseGrid=class extends QG.DefendedBase{constructor(t,e){super(),this._cellWidth=t,this._cellHeight=e,this._cells=QG.New(QG.PairMap)}Release(){this._cells.Release(),this._cells=null}SetCellSize(t,e){if(!this._cells.IsEmpty())throw new Error("grid not empty");this._cellWidth=t,this._cellHeight=e}GetCell(t,e,s){let i=this._cells.Get(t,e);return i||(s?(i=QG.New(QG.GridCell,this,t,e),this._cells.Set(t,e,i),i):null)}XToCell(t){const e=Math.floor(t/this._cellWidth);return isFinite(e)?e:0}YToCell(t){const e=Math.floor(t/this._cellHeight);return isFinite(e)?e:0}Update(t,e,s){if(e)for(let i=e.getLeft(),r=e.getRight();i<=r;++i)for(let r=e.getTop(),n=e.getBottom();r<=n;++r){if(s&&s.containsPoint(i,r))continue;const e=this.GetCell(i,r,!1);e&&(e.Remove(t),e.IsEmpty()&&this._cells.Delete(i,r))}if(s)for(let i=s.getLeft(),r=s.getRight();i<=r;++i)for(let r=s.getTop(),n=s.getBottom();r<=n;++r)e&&e.containsPoint(i,r)||this.GetCell(i,r,!0).Insert(t)}QueryRange(t,e){let s=this.XToCell(t.getLeft());const i=this.YToCell(t.getTop()),r=this.XToCell(t.getRight()),n=this.YToCell(t.getBottom());if(isFinite(r)&&isFinite(n))for(;s<=r;++s)for(let t=i;t<=n;++t){const i=this.GetCell(s,t,!1);i&&i.Dump(e)}}}}{const KG=self.C3;KG.GridCell=class extends KG.DefendedBase{constructor(t,e,s){super(),this._grid=t,this._x=e,this._y=s,this._instances=KG.New(KG.ArraySet)}Release(){this._instances.Release(),this._instances=null,this._grid=null}IsEmpty(){return this._instances.IsEmpty()}Insert(t){this._instances.Add(t)}Remove(t){this._instances.Delete(t)}Dump(t){KG.appendArray(t,this._instances.GetArray())}}}{const ZG=self.C3,$G=1e-6;ZG.Ray=class{constructor(){this.x1=0,this.y1=0,this.x2=0,this.y2=0,this.dx=0,this.dy=0,this.rect=new ZG.Rect,this.hitFraction=2,this.hitUid=null,this.hitNormal=0,this.hitNormalDx=0,this.hitNormalDy=0,this.hitX=0,this.hitY=0,this.distance=0,this.normalX=1,this.normalY=0,this.reflectionX=1,this.reflectionY=0}DidCollide(){return this.hitFraction<1.000001}Reset(){this.hitFraction=2}Set(t,e,s,i){return this.x1=t,this.y1=e,this.x2=s,this.y2=i,this.dx=s-t,this.dy=i-e,this.rect.set(t,e,s,i),this.rect.normalize(),this.hitFraction=2,this.hitUid=null,this.hitNormal=0,this.hitNormalDx=0,this.hitNormalDy=0,this.hitX=0,this.hitY=0,this.distance=0,this.normalX=1,this.normalY=0,this.reflectionX=1,this.reflectionY=0,this}Complete(){if(!1===this.DidCollide())return;const t=this.dx*this.hitFraction,e=this.dy*this.hitFraction,s=ZG.hypot2DFast(t,e),i=t/s,r=e/s;this.distance=s-$G,this.hitX=this.x1+i*this.distance,this.hitY=this.y1+r*this.distance,this.hitNormal=Math.atan2(this.hitNormalDy,this.hitNormalDx)+Math.PI/2,this.normalX=Math.cos(this.hitNormal),this.normalY=Math.sin(this.hitNormal);const n=i*this.normalX+r*this.normalY;if(this.reflectionX=i-2*this.normalX*n,this.reflectionY=r-2*this.normalY*n,n>0){const t=Math.PI;this.hitNormal=ZG.clampAngle(this.hitNormal+t),this.normalX=-this.normalX,this.normalY=-this.normalY}}TestInstanceSegment(t,e,s,i,r){const n=ZG.rayIntersect(this.x1,this.y1,this.x2,this.y2,e,s,i,r);n>=0&&n<this.hitFraction&&(this.hitFraction=n,this.hitUid=t.GetUID(),this.hitNormalDx=e-i,this.hitNormalDy=s-r)}TestInstanceRect(t,e,s,i){const r=e+i.getLeft(),n=e+i.getRight(),a=s+i.getTop(),o=s+i.getBottom();this.TestInstanceSegment(t,r,a,n,a),this.TestInstanceSegment(t,n,a,n,o),this.TestInstanceSegment(t,n,o,r,o),this.TestInstanceSegment(t,r,o,r,a)}TestInstanceQuad(t,e){const s=e.getTlx(),i=e.getTly(),r=e.getTrx(),n=e.getTry(),a=e.getBrx(),o=e.getBry(),h=e.getBlx(),l=e.getBly();this.TestInstanceSegment(t,s,i,r,n),this.TestInstanceSegment(t,r,n,a,o),this.TestInstanceSegment(t,a,o,h,l),this.TestInstanceSegment(t,h,l,s,i)}TestInstancePoly(t,e,s,i){const r=i.pointsArr();for(let i=0,n=r.length;i<n;i+=2){const a=(i+2)%n,o=r[i]+e,h=r[i+1]+s,l=r[a]+e,c=r[a+1]+s;this.TestInstanceSegment(t,o,h,l,c)}}}}{const tT=self.C3;tT.LayerStateCache=class{constructor(){this._layerCache=new Map}Release(){for(const t of this._layerCache.values())t.layerPts.Clear();this._layerCache.clear()}_GetLayerCache(t){let e=this._layerCache.get(t);return void 0===e&&(e={isInteractive:null,layerPts:new tT.PairMap},this._layerCache.set(t,e)),e}IsInteractive(t){const e=this._GetLayerCache(t);return null===e.isInteractive&&(e.isInteractive=t.IsSelfAndParentsInteractive()),e.isInteractive}CanvasCssToLayer(t,e,s,i){if(0!==i)return t.CanvasCssToLayer(e,s,i);const r=this._GetLayerCache(t);let n=r.layerPts.Get(e,s);return void 0===n&&(n=t.CanvasCssToLayer(e,s,i),r.layerPts.Set(e,s,n)),n}}}{const eT=self.C3,sT=new Set(["off","crop","scale-inner","scale-outer","letterbox-scale","letterbox-integer-scale"]),iT=new Set(["high","low"]),rT=self.glMatrix,nT=rT.mat4,aT=(rT.vec3,nT.create()),oT=eT.New(eT.Quad),hT=eT.New(eT.Rect);eT.CanvasManager=class extends eT.DefendedBase{constructor(t){super(),this._runtime=t,this._canvasLayers=[],this._isWebGPUEnabled=!1,this._webglRenderer=null,this._webgpuRenderer=null,this._iRenderer=null,this._gpuPreference="high-performance",this._isLimitedToWebGL1=!1,this._multitexturingMode="auto",this._windowInnerWidth=0,this._windowInnerHeight=0,this._cssDisplayMode="",this._canvasCssWidth=0,this._canvasCssHeight=0,this._canvasDeviceWidth=0,this._canvasDeviceHeight=0,this._canvasCssOffsetX=0,this._canvasCssOffsetY=0,this._zAxisScale="normalized",this._initFieldOfView=0,this._zNear=1,this._zFar=1e4,this._enableMipmaps=!0,this._textureAnisotropy=0,this._drawWidth=0,this._drawHeight=0,this._fullscreenMode="letterbox-scale",this._documentFullscreenMode="letterbox-scale",this._deviceTransformOffX=0,this._deviceTransformOffY=0,this._defaultProjectionMatrix=nT.create(),this._wantFullscreenScalingQuality="high",this._fullscreenScalingQuality=this._wantFullscreenScalingQuality,this._isDocumentFullscreen=!1,this._availableAdditionalRenderTargets=[],this._usedAdditionalRenderTargets=new Set,this._shaderData=self.C3_Shaders,this._effectChainManager=eT.New(eT.Gfx.EffectChainManager,{getDrawSize:()=>[this.GetDrawWidth(),this.GetDrawHeight()],getRenderTarget:()=>this.GetEffectCompositorRenderTarget(),releaseRenderTarget:t=>this.ReleaseEffectCompositorRenderTarget(t),getTime:()=>this.GetRuntime().GetGameTime(),redraw:()=>this.GetRuntime().UpdateRender()}),this._gpuTimeStartFrame=0,this._gpuTimeEndFrame=0,this._gpuLastUtilisation=NaN,this._gpuFrameTimingsBuffer=null,this._layersGpuProfile=new Map,this._gpuCurUtilisation=NaN,this._webgpuFrameTimings=new Map,this._snapshotFormat="",this._snapshotQuality=1,this._snapshotArea=eT.New(eT.Rect),this._snapshotUrl="",this._snapshotPromise=null,this._snapshotResolve=null,this._isPastingToDrawingCanvas=0,this._loaderStartTime=0,this._rafId=-1,this._loadingProgress=0,this._loadingprogress_handler=t=>this._loadingProgress=t.progress,this._percentText=null,this._splashTextures={logo:null,powered:null,website:null},this._splashFrameNumber=0,this._splashFadeInFinishTime=0,this._splashFadeOutStartTime=0,this._splashState="fade-in",this._splashDoneResolve=null,this._splashDonePromise=new Promise(t=>this._splashDoneResolve=t)}_SetGPUPowerPreference(t){this._gpuPreference=t}_SetWebGPUEnabled(t){this._isWebGPUEnabled=!!t}_SetZAxisScale(t){this._zAxisScale=t}GetZAxisScale(){return this._zAxisScale}_SetInitFieldOfView(t){this._initFieldOfView=t}_SetZDistances(t,e){this._zNear=t,this._zFar=e}_SetLimitedToWebGL1(t){this._isLimitedToWebGL1=!!t}_SetMultitexturingMode(t){this._multitexturingMode=t}async CreateCanvas(t){let e=t.canvas;this._canvasLayers.push({canvas:e,ctx:null}),this._runtime.AddDOMComponentMessageHandler("runtime","window-resize",t=>this._OnWindowResize(t)),this._runtime.AddDOMComponentMessageHandler("runtime","fullscreenchange",t=>this._OnFullscreenChange(t)),this._runtime.AddDOMComponentMessageHandler("runtime","fullscreenerror",t=>this._OnFullscreenError(t)),e.addEventListener("webglcontextlost",t=>this._OnWebGLContextLost(t)),e.addEventListener("webglcontextrestored",t=>this._OnWebGLContextRestored(t)),this._isDocumentFullscreen=!!t.isFullscreen,this._cssDisplayMode=t.cssDisplayMode;const s=navigator.gpu&&this._isWebGPUEnabled;let i=!1;if(s)try{await this._InitWebGPUContext(!0)}catch(t){this._MaybeLogRendererError("WebGPU",t),this._webgpuRenderer=null}if(!this.GetRenderer())try{await this._InitWebGLContext(!0)}catch(t){this._MaybeLogRendererError("WebGL",t),this._webglRenderer=null}if(this.GetRenderer()||(i=!0),!this.GetRenderer()&&s)try{await this._InitWebGPUContext(!1)}catch(t){this._MaybeLogRendererError("WebGPU",t),this._webgpuRenderer=null}if(!this.GetRenderer())try{await this._InitWebGLContext(!1)}catch(t){this._MaybeLogRendererError("WebGL",t),this._webglRenderer=null}const r=this.GetRenderer();if(!r)throw new Error("failed to acquire a renderer - check WebGL or WebGPU is supported");r.SetHasMajorPerformanceCaveat(i),this._webgpuRenderer&&(this._webgpuRenderer.ondevicelost=()=>this._OnWebGPUDeviceLost(),this._webgpuRenderer.ondevicerestored=()=>this._OnWebGPUDeviceRestored()),"normalized"===this._zAxisScale?r.SetZAxisScaleNormalized():(r.SetZAxisScaleRegular(),r.SetFovY(this._initFieldOfView)),this.SetSize(t.windowInnerWidth,t.windowInnerHeight,!0),await this._InitRenderer()}_MaybeLogRendererError(t,e){e&&"string"==typeof e.message&&e.message.startsWith("renderer-unavailable")||console.error(`Error creating ${t} renderer: `,e)}async _InitWebGPUContext(t){const e={nearZ:this._zNear,farZ:this._zFar};let s=!0;"no"===this._multitexturingMode?s=!1:"auto"===this._multitexturingMode&&(s=eT.Platform.IsDesktop);let i="nearest";this._runtime.UsesAnyCrossSampling()&&"nearest"!==this._runtime.GetSampling()&&(i="bilinear");const r={powerPreference:this._gpuPreference,depth:this._runtime.Uses3DFeatures(),failIfMajorPerformanceCaveat:t,usesBackgroundBlending:this._runtime.UsesAnyBackgroundBlending(),canSampleBackbuffer:this._runtime.UsesAnyCrossSampling(),backTextureSampling:i,canSampleDepth:this._runtime.UsesAnyDepthSampling(),isMultiTexturingAllowed:s};this._webgpuRenderer=eT.New(eT.Gfx.WebGPURenderer,e),await this._webgpuRenderer.Create(this._canvasLayers[0].canvas,r)}async _InitWebGLContext(t){const e={alpha:!0,powerPreference:this._gpuPreference,enableGpuProfiling:"xbox-uwp-webview2"!==this._runtime.GetExportType(),depth:this._runtime.Uses3DFeatures(),canSampleDepth:this._runtime.UsesAnyDepthSampling(),failIfMajorPerformanceCaveat:t,nearZ:this._zNear,farZ:this._zFar};this._isLimitedToWebGL1&&(e.maxWebGLVersion=1),this._webglRenderer=eT.New(eT.Gfx.WebGLRenderer,this._canvasLayers[0].canvas,e),await this._webglRenderer.InitState()}async _InitWebGPU(){if(this._shaderData){const t=[];for(const[e,s]of Object.entries(this._shaderData)){s.src=s.wgsl;const i=eT.Gfx.WebGPUShaderProgram.GetDefaultVertexShaderSource(this._webgpuRenderer.IsColorDataF16());t.push(this._webgpuRenderer.CreateShaderProgram(Object.assign({vertexSrc:i,name:e},s)))}await Promise.all(t)}}async _InitWebGL(){if(this._shaderData){const t=[];for(const[e,s]of Object.entries(this._shaderData)){let i;if(s.glslWebGL2&&this._webglRenderer.GetWebGLVersionNumber()>=2)s.src=s.glslWebGL2,i=eT.Gfx.WebGLShaderProgram.GetDefaultVertexShaderSource_WebGL2();else{if(!s.glsl)throw new Error(`shader '${e}' does not support WebGL 1`);s.src=s.glsl,i=eT.Gfx.WebGLShaderProgram.GetDefaultVertexShaderSource()}t.push(this._webglRenderer.CreateShaderProgram(Object.assign({vertexSrc:i,name:e},s)))}await Promise.all(t),this._webglRenderer.ResetLastProgram(),this._webglRenderer.SetTextureFillMode()}this._webglRenderer.SupportsGPUProfiling()&&(this._gpuFrameTimingsBuffer=eT.New(eT.Gfx.WebGLQueryResultBuffer,this._webglRenderer))}async _InitRenderer(){this._webgpuRenderer?await this._InitWebGPU():this._webglRenderer&&await this._InitWebGL();const t=this.GetRenderer();t.SetMipmapsEnabled(this._enableMipmaps),t.SupportsGPUProfiling()&&(this._gpuLastUtilisation=0);for(const e of this._runtime._GetAllEffectLists()){for(const s of e.GetAllEffectTypes())s._InitRenderer(t);e._InitRenderer(t),e.UpdateActiveEffects()}this._iRenderer=new self.IRenderer(this._runtime,t)}Release(){this._runtime=null,this._webglRenderer=null,this._canvasLayers.length=0}IsInWorker(){return this._runtime.IsInWorker()}_OnWindowResize(t){const e=this._runtime;if(e.IsExportToVideo())return;const s=t.devicePixelRatio;this.IsInWorker()&&(self.devicePixelRatio=s),e._SetDevicePixelRatio(s),this._isDocumentFullscreen=!!t.isFullscreen,this._cssDisplayMode=t.cssDisplayMode,this.SetSize(t.innerWidth,t.innerHeight),e.UpdateRender();const i=new eT.Event("window-resize");i.data=t,e.Dispatcher().dispatchEventAndWaitAsyncSequential(i);const r=new eT.Event("resize");r.cssWidth=this.GetCssWidth(),r.cssHeight=this.GetCssHeight(),r.deviceWidth=this.GetDeviceWidth(),r.deviceHeight=this.GetDeviceHeight(),e.DispatchUserScriptEvent(r),this._runtime.GetCurrentLayout()?.BoundScrolling(),e.IsDebug()&&(e.HitBreakpoint()||self.C3Debugger.IsDebuggerPaused())&&e.Render()}_OnFullscreenChange(t){this._isDocumentFullscreen=!!t.isFullscreen,this.SetSize(t.innerWidth,t.innerHeight,!0),this._runtime.UpdateRender()}_OnFullscreenError(t){this._isDocumentFullscreen=!!t.isFullscreen,this.SetSize(t.innerWidth,t.innerHeight,!0),this._runtime.UpdateRender()}SetSize(t,e,s=!1){if(t=Math.floor(t),e=Math.floor(e),t<=0||e<=0)throw new Error("invalid size");if(this._windowInnerWidth===t&&this._windowInnerHeight===e&&!s)return;this._windowInnerWidth=t,this._windowInnerHeight=e;const i=this.GetCurrentFullscreenMode();"letterbox-scale"===i?this._CalculateLetterboxScale(t,e):"letterbox-integer-scale"===i?this._CalculateLetterboxIntegerScale(t,e):"off"===i?this._CalculateFixedSizeCanvas(t,e):this._CalculateFullsizeCanvas(t,e),this._UpdateFullscreenScalingQuality(i);for(const{canvas:t}of this._canvasLayers)t.width=this._canvasDeviceWidth,t.height=this._canvasDeviceHeight;this._runtime.PostComponentMessageToDOM("canvas","update-size",{marginLeft:this._canvasCssOffsetX,marginTop:this._canvasCssOffsetY,styleWidth:this._canvasCssWidth,styleHeight:this._canvasCssHeight,displayScale:this.GetDisplayScale()});const r=this.GetRenderer();r.SetSize(this._canvasDeviceWidth,this._canvasDeviceHeight,!0);for(const t of this._availableAdditionalRenderTargets)r.DeleteRenderTarget(t);eT.clearArray(this._availableAdditionalRenderTargets),this.UpdateDefaultProjectionMatrix();const n=this._runtime.GetLayoutManager();n.SetAllLayerProjectionChanged(),n.SetAllLayerMVChanged()}UpdateDefaultProjectionMatrix(){this.GetRenderer().CalculatePerspectiveMatrix(this._defaultProjectionMatrix,this.GetDrawWidth()/this.GetDrawHeight())}GetDefaultProjectionMatrix(){return this._defaultProjectionMatrix}_CalculateLetterboxScale(t,e){const s=this._runtime.GetDevicePixelRatio(),i=this._runtime.GetOriginalViewportWidth(),r=this._runtime.GetOriginalViewportHeight(),n=i/r;if(t/e>n){const s=e*n;this._canvasCssWidth=Math.round(s),this._canvasCssHeight=e,this._canvasCssOffsetX=Math.floor((t-this._canvasCssWidth)/2),this._canvasCssOffsetY=0}else{const s=t/n;this._canvasCssWidth=t,this._canvasCssHeight=Math.round(s),this._canvasCssOffsetX=0,this._canvasCssOffsetY=Math.floor((e-this._canvasCssHeight)/2)}this._canvasDeviceWidth=Math.round(this._canvasCssWidth*s),this._canvasDeviceHeight=Math.round(this._canvasCssHeight*s),this._runtime.SetViewportSize(i,r)}_CalculateLetterboxIntegerScale(t,e){const s=this._runtime.GetDevicePixelRatio();1!==s&&(t+=1,e+=1);const i=this._runtime.GetOriginalViewportWidth(),r=this._runtime.GetOriginalViewportHeight(),n=i/r;let a;a=t/e>n?e*n*s/i:t/n*s/r,a>1?a=Math.floor(a):a<1&&(a=1/Math.ceil(1/a)),this._canvasDeviceWidth=Math.round(i*a),this._canvasDeviceHeight=Math.round(r*a),this._canvasCssWidth=this._canvasDeviceWidth/s,this._canvasCssHeight=this._canvasDeviceHeight/s,this._canvasCssOffsetX=Math.max(Math.floor((t-this._canvasCssWidth)/2),0),this._canvasCssOffsetY=Math.max(Math.floor((e-this._canvasCssHeight)/2),0),this._runtime.SetViewportSize(i,r)}_CalculateFullsizeCanvas(t,e){const s=this._runtime.GetDevicePixelRatio();this._canvasCssWidth=t,this._canvasCssHeight=e,this._canvasDeviceWidth=Math.round(this._canvasCssWidth*s),this._canvasDeviceHeight=Math.round(this._canvasCssHeight*s),this._canvasCssOffsetX=0,this._canvasCssOffsetY=0;const i=this.GetDisplayScale();this._runtime.SetViewportSize(this._canvasCssWidth/i,this._canvasCssHeight/i)}_CalculateFixedSizeCanvas(t,e){const s=this._runtime.GetDevicePixelRatio();this._canvasCssWidth=this._runtime.GetViewportWidth(),this._canvasCssHeight=this._runtime.GetViewportHeight(),this._canvasDeviceWidth=Math.round(this._canvasCssWidth*s),this._canvasDeviceHeight=Math.round(this._canvasCssHeight*s),this.IsDocumentFullscreen()?(this._canvasCssOffsetX=Math.floor((t-this._canvasCssWidth)/2),this._canvasCssOffsetY=Math.floor((e-this._canvasCssHeight)/2)):(this._canvasCssOffsetX=0,this._canvasCssOffsetY=0),this._runtime.SetViewportSize(this._runtime.GetViewportWidth(),this._runtime.GetViewportHeight())}_UpdateFullscreenScalingQuality(t){if("high"===this._wantFullscreenScalingQuality)this._drawWidth=this._canvasDeviceWidth,this._drawHeight=this._canvasDeviceHeight,this._fullscreenScalingQuality="high";else{let e,s;if("off"===this.GetCurrentFullscreenMode()?(e=this._runtime.GetViewportWidth(),s=this._runtime.GetViewportHeight()):(e=this._runtime.GetOriginalViewportWidth(),s=this._runtime.GetOriginalViewportHeight()),this._canvasDeviceWidth<e||this._canvasDeviceHeight<s)this._drawWidth=this._canvasDeviceWidth,this._drawHeight=this._canvasDeviceHeight,this._fullscreenScalingQuality="high";else if(this._drawWidth=e,this._drawHeight=s,this._fullscreenScalingQuality="low","scale-inner"===t){const t=e/s,i=this._windowInnerWidth/this._windowInnerHeight;i<t?this._drawWidth=this._drawHeight*i:i>t&&(this._drawHeight=this._drawWidth/i)}else if("scale-outer"===t){const t=e/s,i=this._windowInnerWidth/this._windowInnerHeight;i>t?this._drawWidth=this._drawHeight*i:i<t&&(this._drawHeight=this._drawWidth/i)}}}GetRuntime(){return this._runtime}GetMainCanvas(){return this._canvasLayers[0].canvas}GetEffectChainManager(){return this._effectChainManager}IsDocumentFullscreen(){return this._isDocumentFullscreen}GetCssDisplayMode(){return this._cssDisplayMode}SetFullscreenMode(t){if(!sT.has(t))throw new Error("invalid fullscreen mode");this._fullscreenMode=t;const e=this._runtime.GetLayoutManager();e.SetAllLayerProjectionChanged(),e.SetAllLayerMVChanged()}GetFullscreenMode(){return this._fullscreenMode}SetDocumentFullscreenMode(t){if(!sT.has(t))throw new Error("invalid fullscreen mode");this._documentFullscreenMode=t;const e=this._runtime.GetLayoutManager();e.SetAllLayerProjectionChanged(),e.SetAllLayerMVChanged()}GetDocumentFullscreenMode(){return this._documentFullscreenMode}GetCurrentFullscreenMode(){return this.IsDocumentFullscreen()?this.GetDocumentFullscreenMode():this.GetFullscreenMode()}SetFullscreenScalingQuality(t){if(!iT.has(t))throw new Error("invalid fullscreen scaling quality");this._wantFullscreenScalingQuality=t,this._runtime.GetLayoutManager().SetAllLayerProjectionChanged()}GetSetFullscreenScalingQuality(){return this._wantFullscreenScalingQuality}GetCurrentFullscreenScalingQuality(){return this._fullscreenScalingQuality}static _FullscreenModeNumberToString(t){switch(t){case 0:return"off";case 1:return"crop";case 2:return"scale-inner";case 3:return"scale-outer";case 4:return"letterbox-scale";case 5:return"letterbox-integer-scale";default:throw new Error("invalid fullscreen mode")}}GetLastWidth(){return this._windowInnerWidth}GetLastHeight(){return this._windowInnerHeight}GetDrawWidth(){return this._drawWidth}GetDrawHeight(){return this._drawHeight}SetMipmapsEnabled(t){this._enableMipmaps=!!t}GetMipmapsEnabled(){return this._enableMipmaps}_SetTextureAnisotropy(t){this._textureAnisotropy=t}GetTextureAnisotropy(){return this._textureAnisotropy}IsRendererContextLost(){return this.GetRenderer().IsContextLost()}_OnWebGLContextLost(t){console.log("[Construct] WebGL context lost"),t.preventDefault(),this._availableAdditionalRenderTargets=[],this._usedAdditionalRenderTargets.clear(),this._effectChainManager.OnContextLost(),this._webglRenderer.OnContextLost(),this._runtime._OnRendererContextLost()}_OnWebGPUDeviceLost(){console.log("[Construct] WebGPU device lost"),this._availableAdditionalRenderTargets=[],this._usedAdditionalRenderTargets.clear(),this._effectChainManager.OnContextLost(),this._runtime._OnRendererContextLost()}async _OnWebGLContextRestored(t){await this._webglRenderer.OnContextRestored(),await this._InitRenderer(),await this._runtime._OnRendererContextRestored(),console.log("[Construct] WebGL context restored")}async _OnWebGPUDeviceRestored(){await this._InitRenderer(),await this._runtime._OnRendererContextRestored(),console.log("[Construct] WebGPU device restored")}GetWebGLRenderer(){return this._webglRenderer}GetWebGPURenderer(){return this._webgpuRenderer}GetRenderer(){return this._webgpuRenderer||this._webglRenderer}GetIRenderer(){return this._iRenderer}GetRendererString(){let t="";return t=this._runtime.GetWebGPURenderer()?"webgpu":"webgl"+this._runtime.GetWebGLRenderer().GetWebGLVersionNumber(),this._runtime.GetRenderer().HasMajorPerformanceCaveat()&&(t+="-software"),t}GetRendererDetailString(){return this._runtime.GetWebGPURenderer()?this._runtime.GetWebGPURenderer().GetAdapterInfoString():this._runtime.GetWebGLRenderer().GetUnmaskedRenderer()}GetRenderScale(){return"low"===this._fullscreenScalingQuality?1/this._runtime.GetDevicePixelRatio():this.GetDisplayScale()}GetDisplayScale(){const t=this.GetCurrentFullscreenMode();if("off"===t||"crop"===t)return 1;const e=this._runtime.GetOriginalViewportWidth(),s=this._runtime.GetOriginalViewportHeight(),i=e/s,r=this._canvasDeviceWidth/this._canvasDeviceHeight;return"scale-inner"!==t&&r>i||"scale-inner"===t&&r<i?this._canvasCssHeight/s:this._canvasCssWidth/e}GetEffectLayerScaleParam(){return"low"===this.GetCurrentFullscreenScalingQuality()?1:this.GetDisplayScale()}GetEffectDevicePixelRatioParam(){return"low"===this.GetCurrentFullscreenScalingQuality()?1:this._runtime.GetDevicePixelRatio()}SetDeviceTransformOffset(t,e){this._deviceTransformOffX=t,this._deviceTransformOffY=e}SetDeviceTransform(t,e,s,i=!0){e=e||this._drawWidth,s=s||this._drawHeight;const r=e/2+this._deviceTransformOffX,n=s/2+this._deviceTransformOffY;if(i){let i=this.GetDefaultProjectionMatrix();e===this._drawWidth&&s===this._drawHeight||(t.CalculatePerspectiveMatrix(aT,e/s),i=aT),t.SetProjectionMatrix(i)}const a=t.CalculateLookAtModelView2(r,n,t.GetDefaultCameraZ(s),r,n,0,s);t.SetModelViewMatrix(a)}SetCssTransform(t,e=!0){const s=this.GetCssWidth(),i=this.GetCssHeight(),r=s/2,n=i/2;e&&t.SetProjectionMatrix(this.GetDefaultProjectionMatrix());const a=t.CalculateLookAtModelView2(r,n,t.GetDefaultCameraZ(i),r,n,0,i);t.SetModelViewMatrix(a)}GetDeviceWidth(){return this._canvasDeviceWidth}GetDeviceHeight(){return this._canvasDeviceHeight}GetCssWidth(){return this._canvasCssWidth}GetCssHeight(){return this._canvasCssHeight}GetCanvasClientX(){return this._canvasCssOffsetX}GetCanvasClientY(){return this._canvasCssOffsetY}GetHTMLLayerCount(){return this._canvasLayers.length}_CanUseImageBitmapRenderingContext(){return"undefined"!=typeof OffscreenCanvas&&this.GetMainCanvas()instanceof OffscreenCanvas&&("Chromium"!==eT.Platform.BrowserEngine||eT.Platform.BrowserVersionNumber>=124)}async SetHTMLLayerCount(t,e=!1){if(t<1)throw new Error("invalid HTML layer count");if(this._canvasLayers.length===t)return;const s={count:t,layersDomState:this._runtime.GetLayoutManager().GetMainRunningLayout()._GetRootLayers().filter(t=>t.IsHTMLElementsLayer()).map(t=>t._GetHTMLLayerDOMState()),immediate:e,marginLeft:this._canvasCssOffsetX,marginTop:this._canvasCssOffsetY,styleWidth:this._canvasCssWidth,styleHeight:this._canvasCssHeight};let i;if(i=this.IsInWorker()?await this._runtime.PostComponentMessageToDOMAsync("canvas","set-html-layer-count",s):self.c3_runtimeInterface._OnSetHTMLLayerCount(s),t<this._canvasLayers.length)this._canvasLayers.length=t;else for(const t of i.addedCanvases){t.width=this._canvasDeviceWidth,t.height=this._canvasDeviceHeight;const e=this._CanUseImageBitmapRenderingContext()?"bitmaprenderer":"2d",s=t.getContext(e);if(!s)throw new Error(`failed to acquire '${e}' canvas context`);this._canvasLayers.push({canvas:t,ctx:s})}this._runtime.UpdateRender()}BlitMainCanvasToHTMLLayerCanvas(t){if(t>=this._canvasLayers.length)return;const e=this.GetMainCanvas(),s=this._canvasLayers[t].ctx;this._CanUseImageBitmapRenderingContext()?s.transferFromImageBitmap(e.transferToImageBitmap()):(s.globalCompositeOperation="copy",s.drawImage(e,0,0))}GetAdditionalRenderTarget(t){t.depth=this._runtime.Uses3DFeatures();const e=this._availableAdditionalRenderTargets,s=e.findIndex(e=>e.IsCompatibleWithOptions(t));let i;return-1!==s?(i=e[s],e.splice(s,1)):i=this.GetRenderer().CreateRenderTarget(t),this._usedAdditionalRenderTargets.add(i),i}ReleaseAdditionalRenderTarget(t){if(!this._usedAdditionalRenderTargets.has(t))throw new Error("render target not in use");this._usedAdditionalRenderTargets.delete(t),this._availableAdditionalRenderTargets.push(t)}GetEffectCompositorRenderTarget(){const t={sampling:this._runtime.GetSampling()};return"low"===this.GetCurrentFullscreenScalingQuality()&&(t.width=this.GetDrawWidth(),t.height=this.GetDrawHeight()),this.GetAdditionalRenderTarget(t)}ReleaseEffectCompositorRenderTarget(t){this.ReleaseAdditionalRenderTarget(t)}*activeLayersGpuProfiles(){for(const t of this._runtime.GetLayoutManager().runningLayouts())for(const e of t.GetLayers()){const t=this._layersGpuProfile.get(e);t&&(yield t)}}GetLayerTimingsBuffer(t){if(!this.GetRenderer().SupportsGPUProfiling())return null;let e=this._layersGpuProfile.get(t);return e||(e={layer:t,name:t.GetName(),timingsBuffer:eT.New(eT.Gfx.WebGLQueryResultBuffer,this._webglRenderer),curUtilisation:0,lastTotalUtilisation:0,lastSelfUtilisation:0},this._layersGpuProfile.set(t,e)),e.timingsBuffer}_Update1sFrameRange(){const t=this.GetRenderer();if(t.SupportsGPUProfiling()&&0===this._gpuTimeEndFrame){this._gpuTimeEndFrame=t.GetFrameNumber(),this._gpuCurUtilisation=NaN;for(const t of this.activeLayersGpuProfiles())t.curUtilisation=NaN}}_UpdateTick(){this._webglRenderer&&this._webglRenderer.SupportsGPUProfiling()&&this._UpdateTick_WebGL(),this._webgpuRenderer&&this._webgpuRenderer.SupportsGPUProfiling()&&this._UpdateTick_WebGPU()}_UpdateTick_WebGL(){if(isNaN(this._gpuCurUtilisation)&&(this._gpuCurUtilisation=this._gpuFrameTimingsBuffer.GetFrameRangeResultSum(this._gpuTimeStartFrame,this._gpuTimeEndFrame),!isNaN(this._gpuCurUtilisation))){if(this._runtime.IsDebug())for(const t of this.activeLayersGpuProfiles())if(t.curUtilisation=t.timingsBuffer.GetFrameRangeResultSum(this._gpuTimeStartFrame,this._gpuTimeEndFrame),isNaN(t.curUtilisation))return;if(this._gpuFrameTimingsBuffer.DeleteAllBeforeFrameNumber(this._gpuTimeEndFrame),this._gpuLastUtilisation=Math.min(this._gpuCurUtilisation,1),this._runtime.IsDebug()){const t=new Map;for(const e of this.activeLayersGpuProfiles())e.timingsBuffer.DeleteAllBeforeFrameNumber(this._gpuTimeEndFrame),e.lastTotalUtilisation=Math.min(e.curUtilisation,1),t.set(e.layer,e.lastTotalUtilisation);for(const e of this.activeLayersGpuProfiles()){const s=e.layer,i=(t.get(s)||0)-s.GetSubLayers().reduce((e,s)=>e+(t.get(s)||0),0);e.lastSelfUtilisation=eT.clamp(i,0,1)}const e=this._runtime.GetMainRunningLayout(),s=this._gpuLastUtilisation-e._GetRootLayers().reduce((e,s)=>e+(t.get(s)||0),0);self.C3Debugger.UpdateGPUProfile(eT.clamp(s,0,1),this._gpuLastUtilisation,[...this.activeLayersGpuProfiles()])}this._gpuTimeStartFrame=this._gpuTimeEndFrame,this._gpuTimeEndFrame=0}}GetGPUFrameTimingsBuffer(){return this._gpuFrameTimingsBuffer}_UpdateTick_WebGPU(){if(0===this._gpuTimeEndFrame)return;for(let t=this._gpuTimeStartFrame;t<this._gpuTimeEndFrame;++t){const e=this._webgpuFrameTimings.get(t);if(e&&!e.HasResult())return}const t=this._runtime.GetMainRunningLayout(),e=eT.MakeFilledArray(t.GetLayerCount()+1,0);let s=0;for(let t=this._gpuTimeStartFrame;t<this._gpuTimeEndFrame;++t){const i=this._webgpuFrameTimings.get(t);if(!i)continue;const r=i.GetResult();let n=BigInt(0),a=BigInt(0);const o=BigInt(0);for(let t=0,s=Math.min(e.length,r.length/2);t<s;++t){const s=r[2*t],i=r[2*t+1];s!==o&&(n===o||s<n)&&(n=s),i>a&&(a=i);const h=Number(i-s)/1e9;e[t]+=h}s+=Number(a-n)/1e9}if(this._gpuLastUtilisation=eT.clamp(s,0,1),this._runtime.IsDebug()){const s=t.GetLayers(),i=new Map;for(let t=0,r=Math.min(s.length,e.length-1);t<r;++t){const r=e[t+1];i.set(s[t],r)}const r=[],n=new Map;for(const[t,e]of i){const s=[...t.selfAndAllSubLayers()].reduce((t,e)=>t+(i.get(e)||0),0);n.set(t,s),r.push({name:t.GetName(),lastSelfUtilisation:eT.clamp(e,0,1),lastTotalUtilisation:eT.clamp(s,0,1)})}const a=this._gpuLastUtilisation-t._GetRootLayers().reduce((t,e)=>t+(n.get(e)||0),0);self.C3Debugger.UpdateGPUProfile(eT.clamp(a,0,1),this._gpuLastUtilisation,r)}for(let t=this._gpuTimeStartFrame;t<this._gpuTimeEndFrame;++t)this._webgpuFrameTimings.delete(t);this._gpuTimeStartFrame=this._gpuTimeEndFrame,this._gpuTimeEndFrame=0}_AddWebGPUFrameTiming(t){this._webgpuFrameTimings.set(this._webgpuRenderer.GetFrameNumber(),t)}GetGPUUtilisation(){return this._gpuLastUtilisation}SnapshotCanvas(t,e,s,i,r,n){return this._snapshotFormat=t,this._snapshotQuality=e,this._snapshotArea.setWH(s,i,r,n),this._snapshotPromise||(this._snapshotPromise=new Promise(t=>{this._snapshotResolve=t})),this._snapshotPromise}_MaybeTakeSnapshot(){if(!this._snapshotFormat)return;let t=this.GetMainCanvas();const e=this._snapshotArea,s=eT.clamp(Math.floor(e.getLeft()),0,t.width),i=eT.clamp(Math.floor(e.getTop()),0,t.height);let r=e.width();r=0===r?t.width-s:eT.clamp(Math.floor(r),0,t.width-s);let n=e.height();if(n=0===n?t.height-i:eT.clamp(Math.floor(n),0,t.height-i),(0!==s||0!==i||r!==t.width||n!==t.height)&&r>0&&n>0){const e=eT.CreateCanvas(r,n);e.getContext("2d").drawImage(t,s,i,r,n,0,0,r,n),t=e}eT.CanvasToBlob(t,this._snapshotFormat,this._snapshotQuality).then(t=>{this._snapshotUrl&&URL.revokeObjectURL(this._snapshotUrl),this._snapshotUrl=URL.createObjectURL(t),this._snapshotPromise=null,this._snapshotResolve(t)}),this._snapshotFormat="",this._snapshotQuality=1}GetCanvasSnapshotUrl(){return this._snapshotUrl}SetIsPastingToDrawingCanvas(t){t?this._isPastingToDrawingCanvas++:this._isPastingToDrawingCanvas--}IsPastingToDrawingCanvas(){return this._isPastingToDrawingCanvas>0}InitLoadingScreen(t){const e=this.GetRenderer();if(2===t)this._percentText=eT.New(eT.Gfx.RendererText,this.GetRenderer()),this._percentText.SetFontName("Arial"),this._percentText.SetFontSize(16),this._percentText.SetHorizontalAlignment("center"),this._percentText.SetVerticalAlignment("center"),this._percentText.SetSize(300,200);else if(0===t){const t=this._runtime.GetLoadingLogoAsset();t&&t.LoadStaticTexture(e).catch(t=>console.warn("[C3 runtime] Failed to create texture for loading logo: ",t))}else 4===t&&(this._LoadSvgSplashImage("data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4NCjwhLS0gR2VuZXJhdG9yOiBBZG9iZSBJbGx1c3RyYXRvciAxNi4wLjAsIFNWRyBFeHBvcnQgUGx1Zy1JbiAuIFNWRyBWZXJzaW9uOiA2LjAwIEJ1aWxkIDApICAtLT4NCjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+DQo8c3ZnIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgeD0iMHB4IiB5PSIwcHgiDQoJIHdpZHRoPSIxNzAwLjc5MDA0cHgiIGhlaWdodD0iMTcwMC43OTAwNHB4IiB2aWV3Qm94PSIyODcgMzE3IDExMjUgMTEyNSINCgkgZW5hYmxlLWJhY2tncm91bmQ9Im5ldyAwIDAgMTcwMC43OTAwNCAxNzAwLjc5MDA0IiB4bWw6c3BhY2U9InByZXNlcnZlIj4NCjxnIGlkPSJsb2dvIj4NCgk8Zz4NCgkJPGc+DQoJCQk8cGF0aCBmaWxsLXJ1bGU9ImV2ZW5vZGQiIGNsaXAtcnVsZT0iZXZlbm9kZCIgZmlsbD0iI0ZGRkZGRiIgZD0iTTM1NC45Nzc1NCwxMTk1LjYyMzA1DQoJCQkJYzExLjM4NDc3LDAsMjIuMDEyNywzLjIzNzMsMzEuMDE3NTgsOC44Mzc4OWMxLjk0NjI5LDEuMjEwOTQsMi41ODQ5NiwzLjc0OTAyLDEuNDM4NDgsNS43MzQzOGwtNC45MzI2Miw4LjU0MTk5DQoJCQkJYy0zLjI3ODMyLDUuNjc5NjktMTAuMDMzMiw4LjM3Njk1LTE2LjMxNzM4LDYuNTAwOThjLTIuNzY0NjUtMC44MjUyLTUuNjkzMzYtMS4yNjg1NS04LjcyNjU2LTEuMjY4NTUNCgkJCQljLTE2LjgyOTEsMC0zMC40NzI2NiwxMy42NDM1NS0zMC40NzI2NiwzMC40NzI2NmMwLDE2LjgyODEzLDEzLjY0MzU1LDMwLjQ3MjY2LDMwLjQ3MjY2LDMwLjQ3MjY2DQoJCQkJYzMuMDMzMiwwLDUuOTYxOTEtMC40NDMzNiw4LjcyNjU2LTEuMjY4NTVjNi4yOTQ5Mi0xLjg3OTg4LDEzLjAzMzIsMC44MTE1MiwxNi4zMTczOCw2LjUwMDk4bDQuOTMxNjQsOC41NDE5OQ0KCQkJCWMxLjE0NzQ2LDEuOTg4MjgsMC41MTA3NCw0LjUyMzQ0LTEuNDM4NDgsNS43MzQzOGMtOS4wMDM5MSw1LjYwMTU2LTE5LjYzMTg0LDguODM3ODktMzEuMDE2Niw4LjgzNzg5DQoJCQkJYy0zMi40ODUzNSwwLTU4LjgxOTM0LTI2LjMzNDk2LTU4LjgxOTM0LTU4LjgxOTM0QzI5Ni4xNTgyLDEyMjEuOTU3MDMsMzIyLjQ5MjE5LDExOTUuNjIzMDUsMzU0Ljk3NzU0LDExOTUuNjIzMDUNCgkJCQlMMzU0Ljk3NzU0LDExOTUuNjIzMDV6IE03MDMuMjE0ODQsMTI1OS4xNzU3OGMtMTQuNTU5NTctOS44MTczOC0yMC4yMDMxMy0yMC4wMzIyMy0yMC4yMDMxMy0zMy4wODAwOA0KCQkJCWMwLTE4LjQ4OTI2LDE1LjcxNDg0LTI5Ljc2MzY3LDM4LjI2NjYtMjkuNzYzNjdjOS42NTcyMywwLDE4LjcyMTY4LDIuNTQyOTcsMjYuNTU5NTcsNi45OTQxNA0KCQkJCWMyLjA0OTgsMS4xNjQwNiwyLjc2MTcyLDMuNzgzMiwxLjU4MzAxLDUuODI0MjJsLTMuNDE3OTcsNS45MTk5MmMtMy4yNDcwNyw1LjYyNDAyLTkuOTA4Miw4LjMzMTA1LTE2LjE1MzMyLDYuNTQ4ODMNCgkJCQljLTIuNzIzNjMtMC43NzYzNy01LjU5ODYzLTEuMTkyMzgtOC41NzEyOS0xLjE5MjM4Yy0xMC40OTAyMywwLTExLjU5ODYzLDkuNTc2MTctNC44NTc0MiwxNC4xMjMwNWwyMy42ODY1MiwxNS45NzY1Ng0KCQkJCWM5Ljk5MDIzLDYuNzM4MjgsMTUuODk1NTEsMTcuMDY2NDEsMTUuODk1NTEsMjguNzE4NzVjMCwxOC43ODYxMy0xNS4wMDY4NCwzMy4zMDc2Mi0zOC4yNjc1OCwzMy4zMDc2Mg0KCQkJCWMtOS41MjI0NiwwLTE4LjU4Nzg5LTEuOTU3MDMtMjYuODE1NDMtNS40OTAyM2MtNy43ODEyNS0zLjMzOTg0LTEwLjkzMzU5LTEyLjc4MjIzLTYuNjk3MjctMjAuMTE4MTZsMy40ODczLTYuMDQxOTkNCgkJCQljMS4yMTM4Ny0yLjA5OTYxLDMuOTMxNjQtMi43NTk3Nyw1Ljk3NDYxLTEuNDU2MDVjNi44NTkzOCw0LjM4MjgxLDE2LjQ5MDIzLDcuNTk0NzMsMjQuNzU4NzksNy41OTQ3Mw0KCQkJCWMxMC41NDU5LDAsMTEuMzI4MTMtOS45NTg5OCwzLjc2NzU4LTE1LjA1NzYyTDcwMy4yMTQ4NCwxMjU5LjE3NTc4TDcwMy4yMTQ4NCwxMjU5LjE3NTc4eiBNOTg0LjYzMDg2LDEyMDIuMDAwOTgNCgkJCQljMC0yLjM0NzY2LDEuOTAzMzItNC4yNTE5NSw0LjI1MTk1LTQuMjUxOTVoOS45MjE4OGM3LjgyNzE1LDAsMTQuMTcyODUsNi4zNDU3LDE0LjE3Mjg1LDE0LjE3MzgzdjU3LjQwMTM3DQoJCQkJYzAsOC42MTAzNSw2Ljk4MDQ3LDE1LjU5MDgyLDE1LjU5MDgyLDE1LjU5MDgyczE1LjU5MDgyLTYuOTgwNDcsMTUuNTkwODItMTUuNTkwODJ2LTU3LjQwMTM3DQoJCQkJYzAtNy44MjgxMyw2LjM0NTctMTQuMTczODMsMTQuMTcyODUtMTQuMTczODNoOS45MjA5YzIuMzQ4NjMsMCw0LjI1MTk1LDEuOTA0Myw0LjI1MTk1LDQuMjUxOTV2NjcuMzIzMjQNCgkJCQljMCwyNC4yNjU2My0xOS42NzA5LDQzLjkzNzUtNDMuOTM2NTIsNDMuOTM3NXMtNDMuOTM3NS0xOS42NzE4OC00My45Mzc1LTQzLjkzNzVWMTIwMi4wMDA5OEw5ODQuNjMwODYsMTIwMi4wMDA5OHoNCgkJCQkgTTQ2Ni44NjkxNCwxMTk1LjYyMzA1YzMyLjQ4NDM4LDAsNTguODE4MzYsMjYuMzMzOTgsNTguODE4MzYsNTguODE5MzRjMCwzMi40ODQzOC0yNi4zMzM5OCw1OC44MTkzNC01OC44MTgzNiw1OC44MTkzNA0KCQkJCWMtMzIuNDg2MzMsMC01OC44MTkzNC0yNi4zMzQ5Ni01OC44MTkzNC01OC44MTkzNEM0MDguMDQ5OCwxMjIxLjk1NzAzLDQzNC4zODI4MSwxMTk1LjYyMzA1LDQ2Ni44NjkxNCwxMTk1LjYyMzA1DQoJCQkJTDQ2Ni44NjkxNCwxMTk1LjYyMzA1eiBNNDY2Ljg2OTE0LDEyMjUuMDMzMmMtMTYuMjQzMTYsMC0yOS40MTAxNiwxMy4xNjY5OS0yOS40MTAxNiwyOS40MDkxOA0KCQkJCXMxMy4xNjY5OSwyOS40MDgyLDI5LjQxMDE2LDI5LjQwODJjMTYuMjQxMjEsMCwyOS40MDgyLTEzLjE2NjAyLDI5LjQwODItMjkuNDA4MlM0ODMuMTEwMzUsMTIyNS4wMzMyLDQ2Ni44NjkxNCwxMjI1LjAzMzINCgkJCQlMNDY2Ljg2OTE0LDEyMjUuMDMzMnogTTU1Ni43MzI0MiwxMzExLjEzNDc3Yy0yLjM0NzY2LDAtNC4yNTE5NS0xLjkwMjM0LTQuMjUxOTUtNC4yNXYtOTQuOTYxOTENCgkJCQljMC03LjgyODEzLDYuMzQ1Ny0xNC4xNzM4MywxNC4xNzM4My0xNC4xNzM4M2gzLjk1ODk4YzQuNjI1LDAsOC45NTg5OCwyLjI1Njg0LDExLjYxMTMzLDYuMDQ1OWw0MS4xMjIwNyw1OC43NDcwN3YtNTAuNjE5MTQNCgkJCQljMC03LjgyODEzLDYuMzQ1Ny0xNC4xNzM4MywxNC4xNzI4NS0xNC4xNzM4M2g5LjkyMTg4YzIuMzQ3NjYsMCw0LjI1MTk1LDEuOTA0Myw0LjI1MTk1LDQuMjUxOTV2OTQuOTYwOTQNCgkJCQljMCw3LjgyOTEtNi4zNDU3LDE0LjE3Mjg1LTE0LjE3MzgzLDE0LjE3Mjg1aC0zLjk1ODk4Yy00LjYyNSwwLTguOTU4OTgtMi4yNTU4Ni0xMS42MTEzMy02LjA0NDkybC00MS4xMjIwNy01OC43NDYwOXY1MC42MTgxNg0KCQkJCWMwLDcuODI5MS02LjM0NTcsMTQuMTcyODUtMTQuMTcyODUsMTQuMTcyODVINTU2LjczMjQyTDU1Ni43MzI0MiwxMzExLjEzNDc3eiBNMTIxNS4wMjA1MSwxMjExLjkyMjg1DQoJCQkJYzAtNy44MjgxMyw2LjM0NTctMTQuMTczODMsMTQuMTcyODUtMTQuMTczODNoNTAuMzE1NDNjMi4zNDg2MywwLDQuMjUxOTUsMS45MDQzLDQuMjUxOTUsNC4yNTE5NXY1LjY2OTkyDQoJCQkJYzAsNy44MjcxNS02LjM0NTcsMTQuMTcyODUtMTQuMTcyODUsMTQuMTcyODVoLTYuMDI0NDF2NzUuMTE4MTZjMCw3LjgyOTEtNi4zNDU3LDE0LjE3Mjg1LTE0LjE3Mjg1LDE0LjE3Mjg1aC05LjkyMTg4DQoJCQkJYy0yLjM0ODYzLDAtNC4yNTE5NS0xLjkwMjM0LTQuMjUxOTUtNC4yNXYtODUuMDQxMDJoLTE1Ljk0NDM0Yy0yLjM0ODYzLDAtNC4yNTE5NS0xLjkwMzMyLTQuMjUxOTUtNC4yNTE5NVYxMjExLjkyMjg1DQoJCQkJTDEyMTUuMDIwNTEsMTIxMS45MjI4NXogTTc3Ni40NDkyMiwxMjExLjkyMjg1YzAtNy44MjgxMyw2LjM0NTctMTQuMTczODMsMTQuMTczODMtMTQuMTczODNoNTAuMzE0NDUNCgkJCQljMi4zNDk2MSwwLDQuMjUxOTUsMS45MDQzLDQuMjUxOTUsNC4yNTE5NXY1LjY2OTkyYzAsNy44MjcxNS02LjM0NTcsMTQuMTcyODUtMTQuMTcxODgsMTQuMTcyODVoLTYuMDI1Mzl2NzUuMTE4MTYNCgkJCQljMCw3LjgyOTEtNi4zNDU3LDE0LjE3Mjg1LTE0LjE3Mjg1LDE0LjE3Mjg1aC05LjkyMDljLTIuMzQ5NjEsMC00LjI1MTk1LTEuOTAyMzQtNC4yNTE5NS00LjI1di04NS4wNDEwMmgtMTUuOTQ1MzENCgkJCQljLTIuMzQ3NjYsMC00LjI1MTk1LTEuOTAzMzItNC4yNTE5NS00LjI1MTk1VjEyMTEuOTIyODVMNzc2LjQ0OTIyLDEyMTEuOTIyODV6IE05MjkuNjA0NDksMTI3Mi4wMjI0NmwyNi45NTgwMSwzMi4xMjc5Mw0KCQkJCWMyLjMxNDQ1LDIuNzU3ODEsMC4zNDM3NSw2Ljk4NDM4LTMuMjU2ODQsNi45ODQzOGgtMTkuNzA1MDhjLTQuMTg5NDUsMC04LjE2NTA0LTEuODUxNTYtMTAuODU3NDItNS4wNjA1NWwtMjIuNjgxNjQtMjcuMDMxMjUNCgkJCQl2MjcuODQxOGMwLDIuMzQ3NjYtMS45MDMzMiw0LjI1LTQuMjUxOTUsNC4yNWgtOS45MjA5Yy03LjgyNzE1LDAtMTQuMTcyODUtNi4zNDM3NS0xNC4xNzI4NS0xNC4xNzI4NXYtODUuMDM5MDYNCgkJCQljMC03LjgyODEzLDYuMzQ1Ny0xNC4xNzM4MywxNC4xNzI4NS0xNC4xNzM4M2gyOS43NjM2N2MyMi43MDAyLDAsNDEuMTAyNTQsMTcuMTMzNzksNDEuMTAyNTQsMzguMjY4NTUNCgkJCQlDOTU2Ljc1NDg4LDEyNTIuNTkwODIsOTQ1LjQzNjUyLDEyNjYuNzAyMTUsOTI5LjYwNDQ5LDEyNzIuMDIyNDZMOTI5LjYwNDQ5LDEyNzIuMDIyNDZ6IE05MDAuMDYxNTIsMTIyMS44NDM3NXYzMi41OTg2M2g4LjUwMzkxDQoJCQkJYzEwLjk1ODk4LDAsMTkuODQyNzctNy4yOTc4NSwxOS44NDI3Ny0xNi4yOTg4M2MwLTkuMDAxOTUtOC44ODM3OS0xNi4yOTk4LTE5Ljg0Mjc3LTE2LjI5OThIOTAwLjA2MTUyTDkwMC4wNjE1MiwxMjIxLjg0Mzc1eg0KCQkJCSBNMTE1OC4zNTkzOCwxMTk1LjYyMzA1YzExLjM4NDc3LDAsMjIuMDEyNywzLjIzNzMsMzEuMDE3NTgsOC44Mzc4OWMxLjk0NzI3LDEuMjEwOTQsMi41ODQ5NiwzLjc0OTAyLDEuNDM4NDgsNS43MzQzOA0KCQkJCWwtNC45MzI2Miw4LjU0MTk5Yy0zLjI3ODMyLDUuNjc5NjktMTAuMDMzMiw4LjM3Njk1LTE2LjMxNzM4LDYuNTAwOThjLTIuNzY0NjUtMC44MjUyLTUuNjkzMzYtMS4yNjg1NS04LjcyNTU5LTEuMjY4NTUNCgkJCQljLTE2LjgyOTEsMC0zMC40NzI2NiwxMy42NDM1NS0zMC40NzI2NiwzMC40NzI2NmMwLDE2LjgyODEzLDEzLjY0MzU1LDMwLjQ3MjY2LDMwLjQ3MjY2LDMwLjQ3MjY2DQoJCQkJYzMuMDMyMjMsMCw1Ljk2MDk0LTAuNDQzMzYsOC43MjU1OS0xLjI2ODU1YzYuMjk1OS0xLjg3OTg4LDEzLjAzMzIsMC44MTE1MiwxNi4zMTgzNiw2LjUwMDk4bDQuOTMwNjYsOC41NDE5OQ0KCQkJCWMxLjE0NzQ2LDEuOTg4MjgsMC41MTA3NCw0LjUyMzQ0LTEuNDM3NSw1LjczNDM4Yy05LjAwNDg4LDUuNjAxNTYtMTkuNjMyODEsOC44Mzc4OS0zMS4wMTc1OCw4LjgzNzg5DQoJCQkJYy0zMi40ODUzNSwwLTU4LjgxOTM0LTI2LjMzNDk2LTU4LjgxOTM0LTU4LjgxOTM0QzEwOTkuNTQwMDQsMTIyMS45NTcwMywxMTI1Ljg3NDAyLDExOTUuNjIzMDUsMTE1OC4zNTkzOCwxMTk1LjYyMzA1eiIvPg0KCQkJPHBhdGggZmlsbC1ydWxlPSJldmVub2RkIiBjbGlwLXJ1bGU9ImV2ZW5vZGQiIGZpbGw9IiMwMEZGREEiIGQ9Ik0xMzE4LjE5NzI3LDEyMDYuMDMyMjMNCgkJCQljMC03LjgyODEzLDYuMzQ1Ny0xNC4xNzM4MywxNC4xNzI4NS0xNC4xNzM4M2MyMC42NTYyNSwwLDQxLjMxMjUsMCw2MS45Njg3NSwwYzMuNDI5NjksMCw1LjQ1MDIsMy44ODA4NiwzLjQ4MzQsNi42OTA0Mw0KCQkJCWwtMTkuMjk2ODgsMjcuNTY3MzhjMTUuNTQyOTcsOC4zNzU5OCwyNi4xMDY0NSwyNC44MDA3OCwyNi4xMDY0NSw0My42OTUzMWMwLDI3LjM5NzQ2LTIyLjIwODk4LDQ5LjYwNjQ1LTQ5LjYwNjQ1LDQ5LjYwNjQ1DQoJCQkJYy0xNi42ODg0OCwwLTMxLjQ1MTE3LTguMjQwMjMtNDAuNDQzMzYtMjAuODc1OThjLTEuNDUwMi0yLjAzOTA2LTAuODMxMDUtNC44OTk0MSwxLjMzNTk0LTYuMTUyMzRsMTAuOTc3NTQtNi4zMzc4OQ0KCQkJCWM0Ljg4MTg0LTIuODE4MzYsMTAuOTc5NDktMi40NzU1OSwxNS41MTQ2NSwwLjg3MzA1YzMuNTI4MzIsMi42MDU0Nyw3Ljg5MTYsNC4xNDY0OCwxMi42MTUyMyw0LjE0NjQ4DQoJCQkJYzExLjc0MjE5LDAsMjEuMjU5NzctOS41MTg1NSwyMS4yNTk3Ny0yMS4yNTk3N3MtOS41MTc1OC0yMS4yNTk3Ny0yMS4yNTk3Ny0yMS4yNTk3N2gtMTUuMjE3NzcNCgkJCQljLTMuNDI5NjksMC01LjQ1MDItMy44ODA4Ni0zLjQ4NDM4LTYuNjkwNDNsMTguMTM1NzQtMjUuOTA4MmgtMzIuMDA5NzdjLTIuMzQ4NjMsMC00LjI1MTk1LTEuOTAzMzItNC4yNTE5NS00LjI1MTk1VjEyMDYuMDMyMjN6DQoJCQkJIi8+DQoJCTwvZz4NCgkJPGc+DQoJCQk8Zz4NCgkJCQk8cGF0aCBmaWxsLXJ1bGU9ImV2ZW5vZGQiIGNsaXAtcnVsZT0iZXZlbm9kZCIgZmlsbD0iI0RBRThGNyIgZD0iTTg1MC4zOTU1MSw4NTcuNTkxOA0KCQkJCQljLTUwLjM1NjQ1LDAtOTQuMzI1Mi0yNy4zNTY0NS0xMTcuODUyNTQtNjguMDIwNTFsLTgwLjAzMDI3LDQ2LjIwNDFjLTQuNjU1MjcsMi42ODk0NS02LjEzMTg0LDguNzE4NzUtMy4yNDkwMiwxMy4yNTU4Ng0KCQkJCQljNDIuMjM3Myw2Ni40ODYzMywxMTYuNTMzMiwxMTAuNjA3NDIsMjAxLjEzMTg0LDExMC42MDc0MmM4OC4xMjU5OCwwLDE2NS4wNzEyOS00Ny44NzUsMjA2LjI0MzE2LTExOS4wMzYxM2wtODAuNDg3My00Ni40Njk3Mw0KCQkJCQljLTQuMzEzNDgtMi40OTAyMy05LjgwMTc2LTEuMjA1MDgtMTIuNTcwMzEsMi45MzU1NUM5MzkuMTc1NzgsODMzLjU2MjUsODk3LjU5MTgsODU3LjU5MTgsODUwLjM5NTUxLDg1Ny41OTE4DQoJCQkJCUw4NTAuMzk1NTEsODU3LjU5MTh6IE0xMTM2LjcyMTY4LDU1Ni4yMTc3N2M0LjYxNDI2LTIuNjYzMDksNi4xMTAzNS04LjYxOTE0LDMuMzEyNS0xMy4xNTEzNw0KCQkJCQljLTU5LjkxNTA0LTk3LjAzMDI3LTE2Ny4yMjQ2MS0xNjEuNjk0MzQtMjg5LjYzODY3LTE2MS42OTQzNGMtMTI1Ljg5MzU1LDAtMjM1LjgxMzQ4LDY4LjM5MjU4LTI5NC42MzM3OSwxNzAuMDQ5OA0KCQkJCQlsODAuMzc2OTUsNDYuNDA2MjVjNC4zOTc0NiwyLjUzOTA2LDEwLjAwMTk1LDEuMTQ5NDEsMTIuNzEwOTQtMy4xNDU1MQ0KCQkJCQljNDIuMTY0MDYtNjYuODUxNTYsMTE2LjY2ODk1LTExMS4yNjM2NywyMDEuNTQ1OS0xMTEuMjYzNjdjODguMTI1OTgsMCwxNjUuMDcxMjksNDcuODc1OTgsMjA2LjI0MzE2LDExOS4wMzYxMw0KCQkJCQlMMTEzNi43MjE2OCw1NTYuMjE3Nzd6Ii8+DQoJCQkJPHBhdGggZmlsbC1ydWxlPSJldmVub2RkIiBjbGlwLXJ1bGU9ImV2ZW5vZGQiIGZpbGw9IiNBNUJBQzgiIGQ9Ik04NTAuMzk1NTEsOTU5LjYzODY3DQoJCQkJCWMtODQuNTk4NjMsMC0xNTguODk0NTMtNDQuMTIxMDktMjAxLjEzMTg0LTExMC42MDc0MmMtMi44NzY5NS00LjUzMDI3LTEuMzk5NDEtMTAuNTcwMzEsMy4yNDkwMi0xMy4yNTU4Nmw4MC4wMzAyNy00Ni4yMDQxDQoJCQkJCWMtMTEuNTgxMDUtMjAuMDE2Ni0xOC4yMDk5Ni00My4yNTQ4OC0xOC4yMDk5Ni02OC4wNDE5OWMwLTc0Ljc4NTE2LDYwLjU1NzYyLTEzNi4wNjI1LDEzNi4wNjI1LTEzNi4wNjI1DQoJCQkJCWM0Ny4xOTYyOSwwLDg4Ljc4MDI3LDI0LjAyOTMsMTEzLjE4NTU1LDYwLjUyMjQ2YzIuNzY0NjUsNC4xMzM3OSw4LjI2MzY3LDUuNDIxODgsMTIuNTcwMzEsMi45MzU1NWw4MC40ODczLTQ2LjQ2OTczDQoJCQkJCWMtNDEuMTcxODgtNzEuMTYwMTYtMTE4LjExNzE5LTExOS4wMzYxMy0yMDYuMjQzMTYtMTE5LjAzNjEzYy04NC44NzY5NSwwLTE1OS4zODE4NCw0NC40MTIxMS0yMDEuNTQ1OSwxMTEuMjYzNjcNCgkJCQkJYy0yLjcwNjA1LDQuMjkxMDItOC4zMTgzNiw1LjY4MTY0LTEyLjcxMDk0LDMuMTQ1NTFsLTgwLjM3Njk1LTQ2LjQwNjI1DQoJCQkJCWMtMjguOTUyMTUsNTAuMDQwMDQtNDUuNTIzNDQsMTA4LjEzOTY1LTQ1LjUyMzQ0LDE3MC4xMDc0MmMwLDE4Ni45NjM4NywxNTEuMzk0NTMsMzQwLjE1NzIzLDM0MC4xNTcyMywzNDAuMTU3MjMNCgkJCQkJYzEyMi40MTQwNiwwLDIyOS43MjM2My02NC42NjQwNiwyODkuNjM4NjctMTYxLjY5NTMxYzIuNzk0OTItNC41MjYzNywxLjI5NDkyLTEwLjQ5MDIzLTMuMzEyNS0xMy4xNTEzN2wtODAuMDgzMDEtNDYuMjM3Mw0KCQkJCQlDMTAxNS40NjY4LDkxMS43NjM2Nyw5MzguNTIxNDgsOTU5LjYzODY3LDg1MC4zOTU1MSw5NTkuNjM4Njd6Ii8+DQoJCQk8L2c+DQoJCQk8cGF0aCBmaWxsLXJ1bGU9ImV2ZW5vZGQiIGNsaXAtcnVsZT0iZXZlbm9kZCIgZmlsbD0iIzAwRkZEQSIgZD0iTTExMzcuMTg1NTUsNzU4LjExMzI4di03My4xNjc5N2wtNjMuMzY1MjMsMzYuNTgzOTgNCgkJCQlMMTEzNy4xODU1NSw3NTguMTEzMjhMMTEzNy4xODU1NSw3NTguMTEzMjh6IE0xMDI2LjU3NjE3LDcwNS4xNjQwNmwxMjAuMDU4NTktNjkuMzE2NDENCgkJCQljMTIuNTY4MzYtNy4yNTU4NiwyOC4zNDQ3MywxLjg1MjU0LDI4LjM0NTcsMTYuMzY2MjF2MTM4LjYzMDg2Yy0wLjAwMDk4LDE0LjUxMjctMTUuNzc3MzQsMjMuNjIyMDctMjguMzQ1NywxNi4zNjYyMQ0KCQkJCWwtMTIwLjA1ODU5LTY5LjMxNjQxQzEwMTQuMDI4MzIsNzMwLjY0OTQxLDEwMTQuMDI4MzIsNzEyLjQwOTE4LDEwMjYuNTc2MTcsNzA1LjE2NDA2eiIvPg0KCQk8L2c+DQoJPC9nPg0KPC9nPg0KPC9zdmc+DQo=").then(t=>{"done"===this._splashState?e.DeleteTexture(t):this._splashTextures.logo=t}).catch(t=>console.warn("Failed to load splash image: ",t)),this._LoadBitmapSplashImage("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAABABAMAAACekdKMAAAAMFBMVEUAAAByfYZyfYZyfYZyfYZyfYZyfYZyfYZyfYZyfYZyfYZyfYZyfYZyfYZyfYZyfYYgo7vbAAAAD3RSTlMAmd137hFVqjO7zCKIRGZ881JRAAAFZklEQVR42u2aO68SQRTHR3leQeI3wMRo7CDGZyyg0MTEYlFbEylMLC+JsQYfvTZWFpgYKwuImlhqYiyNfgOsbRBYefn4O+ecGdgF0caEMbv/5N6BYRY4vzNzzplZVKxYsWLFihUrViwHVcIBJdoDqAjqvwGwF6LJ6YgDAI5EHQBuRR3AvBZNAENu73pAI8oAVB74GWkA6gOG0QawF2hFGkACKEcaQA7yna804Z9UG5U6A9ys2SfH8Y2vaWNyQrfm8aC8AiBdgX9aOSkGIBIAl6Qq4pcm3L8r6SELfNQmF6E1oI4iDu4CP+w1xuIEtPx6CEC2A61HSvX1lSwPB5UbCgIgQ/d7YDXIFN9Ex/PUyNM7YD1jAEfAALIlqSO6SqsN0igEoAfSsKWS5i3303JzQ6tLoAfRjF3eEm+NqclgovsMn2GNAJwTAPcgOsyjjIIAFq/ngbrJuS3lhpYA0uSVnAecVYU28EZbzm7Kmhl/jeqEl8ATlauweUXtdD1AX0PtCxlWoQGpYysARl11g17Pmu69mCtHtASwA9Tp30P9uMCeLeKBeMuXUPBVqSZbmSvhGwN4w1NDrHoOdFXKM/EhBGBGQbNPMaSDKvXdx0g5oiWAXbKzZ1zTx9CYrPZB5u0HPFb7Tb38kswsmiDZkzbnaZsTZkAmBOApxxDqqshyqmiAjmgBoADyStt8swy56xrG7K0Se7qDsu72a4uAWDRjmzpIilVVTcvvcn70ggA+Smmgx72WCdLRMB2RBfCiQ0EqZR2Xo+m9g+9s13VtGb3U0kiox8THIr6wrSA+TGqq/wabCiH2/g4vp5w7SSC4HfZbKs2z3fooweuh42cwpRjp06KY2jxetgDSNqInMdIDxhsAyMIv8AckgJpyRAEARzng1ezW6KvK0rMUBmnye57+VfDF2vdGALA19q2+6wFfNwJIYmCm2A5myhUtAYx46duQ2Cdfd1DX9o1T3pxi4ZiDu9UBBiAGWg10X3UjgH1kdhNVyaiuyAKYnZRUaPNzj/LgBw4EVdXk5X+eYuQ6gJ0wgIMbAIjfZY309TxxRTYILr5jEMAuqtrwhm7LtCMIAXiwDkBf3PwzAFkHelRDuaI/Akhiqr1V1xAe69lQ/juAv8+APHzKkXXligIA1mNABiPtrZpuv6kOutp1gfxtAWQCZe0fY8Bes8Gop+E7kwRCAFazgCpgkvIm1I5SmHNvdQWA+NTqb1lAXtijHzijMIBCoA44SDWOn8ZPamdpUxRN1wAkAju7v9UBUi8m9SBnFAaQC1aCjOE2u7SJq5iKDWsAssGyTkrFzZWgUq8x7qGqnFEYgN0L2AK+guN4wO1nVHm03w0BEFsvKqt98Gub9wJVDoUDyq7OaAVA30S0Xem+Dw9ldmwbDZnuEgWfl5cAKuaa3CG1YTd42O4GufFLmogzWgGwD3go9f1Y4hbQZbdJcEiV5OAr7U2WAC4Dz6i9job2vKyBZhCAXNOXt0oB+iPdURiAPRFqGkfmgbnxHmoyJfD9o0q0MWwtAGQBvFfqDO8m+r8/EWrJiZCw0YzcURhA6ExQZsKIl7TtKMDogswAVn+5nbQ7gxCAIUSHzerCVLmjMIDQqbAYPjXBcWTznD3hFQCCSXRUHEwatQMAZkJ12DXlgDunIWEAolfBX0tI6RcsAHJi4DvJAqFrvtcWc8SvFwMABnJf4JZ57tBpyBqAtTtDFZOxXi9uZKROaVPLwTQo1+CtfdyhO0MhAKE7Q/spGEZZWXeOxLejvDtH4ttR0qHTkK2ojwcq0urgk4qyEi6dhmxB6Wa0YyAAZ34asRUB8F35ZcBWxDuGKKuIJypWrFixYsX6B/oFRYsi2zOzWJcAAAAASUVORK5CYII=").then(t=>{"done"===this._splashState?e.DeleteTexture(t):this._splashTextures.powered=t}).catch(t=>console.warn("Failed to load splash image: ",t)),this._LoadBitmapSplashImage("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAABABAMAAACekdKMAAAAMFBMVEUAAAByfYZyfYZyfYZyfYZyfYZyfYZyfYZyfYZyfYZyfYZyfYZyfYZyfYZyfYZyfYYgo7vbAAAAD3RSTlMAdxHdu4hmVZnuRMwzqiLYE4y2AAAFw0lEQVR42u2Yy+9LQRTHp6Xq0VIkXkFvwkYslAWJiGJj2a6sJJe/oF3YWGElEQmxkYi4ErFWNpatWFmIx9Lm1sJCLKgqraqv82h726l6hOuRzDf53TtnOr+ZOZ+ZOffca5ycnJycnJycnJycnJycnJz+pi7g2G9osxjvzX8qB8ABcAAcgH8XwDa85dspNOiaRDuAR4U0PnHtDuyy7IJRJS6gvVmL6TywVkp4ZxIhulUxFvlaXQTrgEHbnMDH5XRjlXCdb+uAnc2ojWgFFTYBZ8e9tzcaswAk6v/3K4sPfPNRFj87IXj+KXQUS9m2jXoH1lMuLq2DtEcAtNMBT9PjanFq7ySAhbABVEAaeDaAwkk2D7GRqctAMQJIq2sBauLnB/VxCfqKpWrbRhSC1W5SMQ9RTgBUwKpF1ccmAIQ2gCxE+20Au9nSESvDgeIDkJSBMpA9vgyXdsj0H0GORL3n2fbwPOKoSQS4Q2cBOGzSJbQYAHDbZEI+rEuBcyZRlF71fIP/x0wBuIBOw6xH3xu2GQFAP2cegmvSwHkeqBZjECzB46UXD3bg8UKJCT6QYzgDY9uiU7hC11doERq6MAZ2CPJ7ipEulOrteDcB4KOZBpBG7zrV1JGzATzmIdnrl/go3bRiBJBHlZc+6ItjuQQ+yFLz8Gka2LZFRVTFGdoQJQ0LPodHnXkS8AjlRWkBLwKQswAs0PDzGpcsAAMNuG+5WgdqxwjgEcp8qcBjN5oZdPhEvOfhU/hsbJuVloWV6WWgp2IBLxXQNEwLDfKqoMXrEQBjATiFA3qePlgAZJRl+EStdaAQjfgALOC1zfeX8ALV+7S69JdALWjxHGqztmxyMnTD6OOBWvAdGDkn60c6vrI5H4CPnOJsWQDe8G0hIU0MB8ojFx+AFAeqeitLy5FkL3w0yNNcSOx3oDxjjxaH9XxldZluY5NBfwrAQvQbRjQXAO8UqVq5dh6A7HCgWzgdFwBdgOX4lMZbTndkWWkDN07Bk+zItllLdHm1+FkLwBSADNDf8B0AnGOp5gFYgJEexwcgGQx4iyeD9ybFkWsbDZbv0+2Y8XvGtqMpWsUimpMAzA1AUrj5ALjm2wCoONKB+ACYsEeDlU04MMs4imeJQqljslSuD4xl/zgAsx6ku/8DgDwaO9AwFU56qhzOPiXpKCzCpSSdb8v+CQDmXshb99cARAPFCOA1chWaFXlP55yn2FqEgiFvOSzYtmiJzisKB7MxQPS8iO63YsD3AHDv8QPgjR92eKuf9vts1wdZjvZhN4XajD35FNDiR7ln0LYBaILY+OZT4DsA+BkTP4AUrgXkxSJcDFps+72X7EGlx6mBbU/lAbdQjvKA7hSAlSuHxdw0gORsHrAUnXkAUuj+AQAZdHGRp9bShX2ECz1JRSk4zNhRJqj5SZQJfpgCUNS2eRsAP/usTDAxPxFKA834AZgAOM1z6qGgxxpdmUDQNjP25LtAsojxu0AehSkAF6RLXWR/EkAdVYEevQtswVtpMwuAB1JGh2jbxQcgBKrig/qSxTD6o2Nm7fttSY6uUnErV+jb4CJyaArAI5luJkCDOy5HAPISSB5A3wYbhJERahvtPALAAw2EI9Vzsh2TTuk23qEceN9d4vVVv227hNroe0CRi/o9IKTZTQFIAc/M8jwGEiouG2/042u8u25uAuPvAavRH7XhzqcBpICdRpssRa+aNLFoh2JeyBzU08fih/ht20WZXghW34s+/ZQnAKhzojsSH4CC/sjARPKamLXacOfTAIwfNSkCbROLluG9Tm2gdl3PY178tu2SBIpFQ6fHH//2GAvAogCkjtGDEAFQYPsu6DdBqw11bgFIF8dNHsQGIEFRSDOe0RS9YYJk23JMrw+/Cr9bFX0VXmNsACbhA088qXhBrMYAlq8Gjhh//FX4YNSGO7cASO9n9B99AuHk5OTk5OTk5OTk5OTk5OTk5OT0VX0B7+fX+9cwWYYAAAAASUVORK5CYII=").then(t=>{"done"===this._splashState?e.DeleteTexture(t):this._splashTextures.website=t}).catch(t=>console.warn("Failed to load splash image: ",t)))}async _LoadSvgSplashImage(t){t=new URL(t,this._runtime.GetRuntimeBaseURL()).toString();const e=await eT.FetchBlob(t),s=await this._runtime.RasterSvgImage(e,2048,2048);return await this.GetRenderer().CreateStaticTextureAsync(s,{mipMapQuality:"high"})}async _LoadBitmapSplashImage(t){t=new URL(t,this._runtime.GetRuntimeBaseURL()).toString();const e=await eT.FetchBlob(t);return await this.GetRenderer().CreateStaticTextureAsync(e,{mipMapQuality:"high"})}HideCordovaSplashScreen(){this._runtime.PostComponentMessageToDOM("runtime","hide-cordova-splash")}StartLoadingScreen(){this._loaderStartTime=Date.now(),this._runtime.Dispatcher().addEventListener("loadingprogress",this._loadingprogress_handler),this._rafId=requestAnimationFrame(()=>this._DrawLoadingScreen()),3!==this._runtime.GetLoaderStyle()&&this.HideCordovaSplashScreen()}async EndLoadingScreen(){const t=this.GetRenderer();this._loadingProgress=1;const e=this._runtime.GetLoaderStyle();4===e&&await this._splashDonePromise,this._splashDoneResolve=null,this._splashDonePromise=null,-1!==this._rafId&&(cancelAnimationFrame(this._rafId),this._rafId=-1),this._runtime.Dispatcher().removeEventListener("loadingprogress",this._loadingprogress_handler),this._loadingprogress_handler=null,this._percentText&&(this._percentText.Release(),this._percentText=null),this._runtime.ReleaseLoadingLogoAsset(),t.Start(),this._splashTextures.logo&&(t.DeleteTexture(this._splashTextures.logo),this._splashTextures.logo=null),this._splashTextures.powered&&(t.DeleteTexture(this._splashTextures.powered),this._splashTextures.powered=null),this._splashTextures.website&&(t.DeleteTexture(this._splashTextures.website),this._splashTextures.website=null),t.ClearRgba(0,0,0,0),t.Finish(),this._splashState="done",this._gpuTimeStartFrame=t.GetFrameNumber(),3===e&&this.HideCordovaSplashScreen()}_DrawLoadingScreen(){if(-1===this._rafId)return;const t=this.GetRenderer();t.Start(),this._rafId=-1;const e=this._runtime.GetAssetManager().HasHadErrorLoading(),s=this._runtime.GetLoaderStyle();if(3!==s&&(this.SetCssTransform(t),t.ClearRgba(0,0,0,0),t.ResetColor(),t.SetTextureFillMode(),t.SetTexture(null)),0===s)this._DrawProgressBarAndLogoLoadingScreen(e);else if(1===s)this._DrawProgressBarLoadingScreen(e,120,0);else if(2===s)this._DrawPercentTextLoadingScreen(e);else if(3===s)eT.noop();else{if(4!==s)throw new Error("invalid loader style");this._DrawSplashLoadingScreen(e)}t.Finish(),this._rafId=requestAnimationFrame(()=>this._DrawLoadingScreen())}_DrawPercentTextLoadingScreen(t){t?this._percentText.SetColorRgb(1,0,0):this._percentText.SetColorRgb(.6,.6,.6),this._percentText.SetText(Math.round(100*this._loadingProgress)+"%");const e=this._canvasCssWidth/2,s=this._canvasCssHeight/2;oT.setRect(e-150,s-100,e+150,s+100);const i=this.GetRenderer();i.SetTexture(this._percentText.GetTexture()),i.Quad3(oT,this._percentText.GetTexRect())}_DrawProgressBarLoadingScreen(t,e,s){const i=this.GetRenderer();i.SetColorFillMode(),t?i.SetColorRgba(1,0,0,1):i.SetColorRgba(.118,.565,1,1);const r=this._canvasCssWidth/2,n=this._canvasCssHeight/2,a=e/2;hT.setWH(r-a,n-4+s,Math.floor(e*this._loadingProgress),8),i.Rect(hT),hT.setWH(r-a,n-4+s,e,8),hT.offset(-.5,-.5),hT.inflate(.5,.5),i.SetColorRgba(0,0,0,1),i.LineRect2(hT),hT.inflate(1,1),i.SetColorRgba(1,1,1,1),i.LineRect2(hT)}_DrawProgressBarAndLogoLoadingScreen(t){const e=this.GetRenderer(),s=this._runtime.GetLoadingLogoAsset();if(!s)return void this._DrawProgressBarLoadingScreen(t,120,0);const i=s.GetTexture();if(!i)return void this._DrawProgressBarLoadingScreen(t,120,0);const r=i.GetWidth(),n=i.GetHeight(),a=this._canvasCssWidth/2,o=this._canvasCssHeight/2,h=r/2,l=n/2;oT.setRect(a-h,o-l,a+h,o+l),e.SetTexture(i),e.Quad(oT),this._DrawProgressBarLoadingScreen(t,r,l+16)}_DrawSplashLoadingScreen(t){const e=this.GetRenderer(),s=this._splashTextures.logo,i=this._splashTextures.powered,r=this._splashTextures.website,n=Date.now();0===this._splashFrameNumber&&(this._loaderStartTime=n);const a=this._runtime.IsPreview()||this._runtime.IsFBInstantAvailable()&&!this._runtime.IsCordova(),o=a?0:200,h=a?0:3e3;let l=1;"fade-in"===this._splashState?l=Math.min((n-this._loaderStartTime)/300,1):"fade-out"===this._splashState&&(l=Math.max(1-(n-this._splashFadeOutStartTime)/300,0)),e.SetColorFillMode(),e.SetColorRgba(.231*l,.251*l,.271*l,l),hT.set(0,0,this._canvasCssWidth,this._canvasCssHeight),e.Rect(hT);const c=Math.ceil(this._canvasCssWidth),u=Math.ceil(this._canvasCssHeight);let _,d;this._canvasCssHeight>256?(e.SetColorRgba(.302*l,.334*l,.365*l,l),_=c,d=Math.max(.005*u,2),hT.setWH(0,.8*u-d/2,_,d),e.Rect(hT),t?e.SetColorRgba(l,0,0,l):e.SetColorRgba(.161*l,.953*l,.816*l,l),_=c*this._loadingProgress,hT.setWH(.5*c-_/2,.8*u-d/2,_,d),e.Rect(hT),e.SetColorRgba(l,l,l,l),e.SetTextureFillMode(),i&&(_=1.5*eT.clamp(.22*u,105,.6*c),d=_/8,hT.setWH(.5*c-_/2,.2*u-d/2,_,d),e.SetTexture(i),e.Rect(hT)),s&&(_=Math.min(.395*u,.95*c),d=_,hT.setWH(.5*c-_/2,.485*u-d/2,_,d),e.SetTexture(s),e.Rect(hT)),r&&(_=1.5*eT.clamp(.22*u,105,.6*c),d=_/8,hT.setWH(.5*c-_/2,.868*u-d/2,_,d),e.SetTexture(r),e.Rect(hT))):(e.SetColorRgba(.302*l,.334*l,.365*l,l),_=c,d=Math.max(.005*u,2),hT.setWH(0,.85*u-d/2,_,d),e.Rect(hT),t?e.SetColorRgba(l,0,0,l):e.SetColorRgba(.161*l,.953*l,.816*l,l),_=c*this._loadingProgress,hT.setWH(.5*c-_/2,.85*u-d/2,_,d),e.Rect(hT),e.SetColorRgba(l,l,l,l),e.SetTextureFillMode(),s&&(_=.55*u,d=_,hT.setWH(.5*c-_/2,.45*u-d/2,_,d),e.SetTexture(s),e.Rect(hT))),this._splashFrameNumber++,"fade-in"===this._splashState&&n-this._loaderStartTime>=300&&this._splashFrameNumber>=2&&(this._splashState="wait",this._splashFadeInFinishTime=n),"wait"===this._splashState&&n-this._splashFadeInFinishTime>=h&&this._loadingProgress>=1&&(this._splashState="fade-out",this._splashFadeOutStartTime=n),("fade-out"===this._splashState&&n-this._splashFadeOutStartTime>=300+o||a&&this._loadingProgress>=1&&n-this._loaderStartTime<500)&&this._splashDoneResolve()}}}{const lT=self.C3,cT=self.C3Debugger,uT=(self.assert,self.ISDKBehaviorInstanceBase),_T={messagePort:null,runtimeBaseUrl:"",headless:!1,hasDom:!0,isInWorker:!1,useAudio:!0,exportType:""};let dT=!0;lT.Runtime=class extends lT.DefendedBase{constructor(t){t=Object.assign({},_T,t),super(),this._messagePort=t.messagePort,this._runtimeBaseUrl=t.runtimeBaseUrl,this._previewUrl=t.previewUrl,this._isHeadless=!!t.headless,this._hasDom=!!t.hasDom,this._isInWorker=!!t.isInWorker,dT=t.ife,this._useAudio=!!t.useAudio,this._exportType=t.exportType,this._isiOSCordova=!!t.isiOSCordova,this._isiOSWebView=!!t.isiOSWebView,this._isWindowsWebView2=!!t.isWindowsWebView2,this._isAnyWebView2Wrapper=!!t.isAnyWebView2Wrapper,this._isFBInstantAvailable=!!t.isFBInstantAvailable,this._isDebug=!("preview"!==this._exportType||!t.isDebug),this._breakpointsEnabled=this._isDebug,this._isDebugging=this._isDebug,this._debuggingDisabled=0,this._additionalLoadPromises=[],this._additionalCreatePromises=[],this._isUsingCreatePromises=!1,this._projectName="",this._projectVersion="",this._projectUniqueId="",this._appId="",this._exportTimestamp=0,this._originalViewportWidth=0,this._originalViewportHeight=0,this._devicePixelRatio=self.devicePixelRatio,this._parallaxXorigin=0,this._parallaxYorigin=0,this._viewportWidth=0,this._viewportHeight=0,this._loaderStyle=0,this._usesLoaderLayout=!1,this._isLoading=!0,this._usesAnyBackgroundBlending=!1,this._usesAnyCrossSampling=!1,this._usesAnyDepthSampling=!1,this._loadingLogoAsset=null,this._assetManager=lT.New(lT.AssetManager,this,t),this._layoutManager=lT.New(lT.LayoutManager,this),this._eventSheetManager=lT.New(lT.EventSheetManager,this),this._addonManager=lT.New(lT.AddonManager,this,t.wrapperComponentIds),this._collisionEngine=lT.New(lT.CollisionEngine,this),this._timelineManager=lT.New(lT.TimelineManager,this),this._transitionManager=lT.New(lT.TransitionManager,this),this._templateManager=lT.New(lT.TemplateManager,this),this._flowchartManager=lT.New(lT.FlowchartManager,this),this._textIconManager=lT.New(lT.TextIconManager,{getIconSetMeta:t=>this._GetTextIconSetMeta(t),getIconSetContent:t=>this._GetTextIconSetContent(t)}),this._iconChangeHandlers=new Map,this._allObjectClasses=[],this._objectClassesByName=new Map,this._objectClassesBySid=new Map,this._familyCount=0,this._allContainers=[],this._allEffectLists=new Set,this._currentLayoutStack=[],this._instancesPendingCreate=[],this._instancesPendingDestroy=new Map,this._hasPendingInstances=!1,this._isFlushingPendingInstances=!1,this._objectCount=0,this._nextUid=0,this._instancesByUid=new Map,this._instancesPendingRelease=new Set,this._instancesPendingReleaseAffectedObjectClasses=new Set,this._objectReferenceTable=[],this._jsPropNameTable=[],this._canvasManager=null,this._uses3dFeatures=!1,this._framerateMode="vsync",this._sampling="trilinear",this._isPixelRoundingEnabled=!1,this._needRender=!0,this._pauseOnBlur=!1,this._isPausedOnBlur=!1,this._exportToVideo=null,this._tickCallbacks={normal:t=>{this._rafId=-1,this._ruafId=-1,this.Tick(t)},tickOnly:t=>{this._ruafId=-1,this.Tick(t,!1,"skip-render")},renderOnly:()=>{this._rafId=-1,this.Render()}},this._rafId=-1,this._ruafId=-1,this._tickCount=0,this._tickCountNoSave=0,this._hasStarted=!1,this._isInTick=!1,this._hasStartedTicking=!1,this._isLayoutFirstTick=!0,this._isAutoSuspendEnabled=!0,this._isPageVisibilitySuspended=!1,this._suspendCount=0,this._scheduleTriggersThrottle=new lT.PromiseThrottle(1),this._randomNumberCallback=()=>Math.random(),this._startTime=0,this._lastTickTime=0,this._dtRaw=0,this._dt1=0,this._dt=0,this._timeScale=1,this._maxDt=1/30,this._minDt=0,this._gameTime=lT.New(lT.KahanSum),this._gameTimeRaw=lT.New(lT.KahanSum),this._wallTime=lT.New(lT.KahanSum),this._instanceTimes=new Map,this._fpsFrameCount=-1,this._fpsLastTime=0,this._fps=0,this._tpsTickCount=-1,this._tps=0,this._mainThreadTimeCounter=0,this._mainThreadTime=0,this._isLoadingState=!1,this._saveToSlotName="",this._saveToJsonString=!1,this._loadFromSlotName="",this._loadFromJson=null,this._lastSaveJson="",this._projectStorage=null,this._savegamesStorage=null,this._dispatcher=lT.New(lT.Event.Dispatcher),this._domEventHandlers=new Map,this._pendingResponsePromises=new Map,this._nextDomResponseId=0,this._didRequestDeviceOrientationEvent=!1,this._didRequestDeviceMotionEvent=!1,this._isReadyToHandleEvents=!1,this._waitingToHandleEvents=[],this._eventObjects={pretick:lT.New(lT.Event,"pretick",!1),tick:lT.New(lT.Event,"tick",!1),tick2:lT.New(lT.Event,"tick2",!1),instancecreate:lT.New(lT.Event,"instancecreate",!1),instancedestroy:lT.New(lT.Event,"instancedestroy",!1),beforelayoutchange:lT.New(lT.Event,"beforelayoutchange",!1),layoutchange:lT.New(lT.Event,"layoutchange",!1),beforerender:lT.New(lT.Event,"beforerender",!1),afterrender:lT.New(lT.Event,"afterrender",!1)},this._eventObjects.instancecreate.instance=null,this._eventObjects.instancedestroy.instance=null,this._userScriptDispatcher=lT.New(lT.Event.Dispatcher),this._userScriptEventObjects=null;const e=(t,e)=>lT.BehaviorInstance.SortByTickSequence(this,t,e);this._behInstsToTick=lT.New(lT.RedBlackSet,e),this._behInstsToPostTick=lT.New(lT.RedBlackSet,e),this._behInstsToTick2=lT.New(lT.RedBlackSet,e),this._jobScheduler=lT.New(lT.JobSchedulerRuntime,this,t.jobScheduler),t.canvas&&(this._canvasManager=lT.New(lT.CanvasManager,this)),this._messagePort.onmessage=t=>this._OnMessageFromDOM(t.data),this.AddDOMComponentMessageHandler("runtime","visibilitychange",t=>this._OnVisibilityChange(t)),this.AddDOMComponentMessageHandler("runtime","wrapper-extension-message",t=>this._OnWrapperExtensionMessage(t)),this.AddDOMComponentMessageHandler("runtime","get-remote-preview-status-info",()=>this._GetRemotePreviewStatusInfo()),this.AddDOMComponentMessageHandler("runtime","js-invoke-function",t=>this._InvokeFunctionFromJS(t)),this.AddDOMComponentMessageHandler("runtime","go-to-last-error-script",self.goToLastErrorScript),this.AddDOMComponentMessageHandler("runtime","offline-audio-render-completed",t=>this._OnOfflineAudioRenderCompleted(t)),this._dispatcher.addEventListener("window-blur",t=>this._OnWindowBlur(t)),this._dispatcher.addEventListener("window-focus",()=>this._OnWindowFocus()),this._timelineManager.AddRuntimeListeners(),this._templateManager.AddRuntimeListeners(),this._iRuntime=null,this._constructVersionCode=0,this._interfaceMap=new WeakMap,this._commonScriptInterfaces={keyboard:null,mouse:null,touch:null,timelineController:null},this._instancesNeedingAfterLoadMap=new WeakMap,this._instancesNeedingAfterLoadArray=[]}static Create(t){return lT.New(lT.Runtime,t)}Release(){lT.clearArray(this._allObjectClasses),this._objectClassesByName.clear(),this._objectClassesBySid.clear(),this._layoutManager.Release(),this._layoutManager=null,this._eventSheetManager.Release(),this._eventSheetManager=null,this._addonManager.Release(),this._addonManager=null,this._assetManager.Release(),this._assetManager=null,this._collisionEngine.Release(),this._collisionEngine=null,this._timelineManager.Release(),this._timelineManager=null,this._transitionManager.Release(),this._transitionManager=null,this._templateManager.Release(),this._templateManager=null,this._flowchartManager.Release(),this._flowchartManager=null,this._textIconManager.Release(),this._textIconManager=null,this._canvasManager&&(this._canvasManager.Release(),this._canvasManager=null),this._dispatcher.Release(),this._dispatcher=null,this._tickEvent=null}_OnMessageFromDOM(t){const e=t.type;if("event"===e)this._OnEventFromDOM(t);else{if("result"!==e)throw new Error(`unknown message '${e}'`);this._OnResultFromDOM(t)}}_OnEventFromDOM(t){if(!this._isReadyToHandleEvents)return void this._waitingToHandleEvents.push(t);const e=t.component,s=t.handler,i=t.data,r=t.dispatchOpts,n=!(!r||!r.dispatchRuntimeEvent),a=!(!r||!r.dispatchUserScriptEvent),o=t.responseId;if("runtime"===e){if(n){const t=new lT.Event(s);t.data=i,this._dispatcher.dispatchEventAndWaitAsyncSequential(t)}if(a){const t=new lT.Event(s,!0);if(i)for(const[e,s]of Object.entries(i))t[e]=s;this.DispatchUserScriptEvent(t)}}const h=this._domEventHandlers.get(e);if(!h)return void(n||a||console.warn(`[Runtime] No DOM event handlers for component '${e}'`));const l=h.get(s);if(!l)return void(n||a||console.warn(`[Runtime] No DOM handler '${s}' for component '${e}'`));let c=null;try{c=l(i)}catch(t){return console.error(`Exception in '${e}' handler '${s}':`,t),void(null!==o&&this._PostResultToDOM(o,!1,""+t))}null!==o&&(c&&c.then?c.then(t=>this._PostResultToDOM(o,!0,t)).catch(t=>{console.error(`Rejection from '${e}' handler '${s}':`,t),this._PostResultToDOM(o,!1,""+t)}):this._PostResultToDOM(o,!0,c))}_PostResultToDOM(t,e,s){this._messagePort.postMessage({type:"result",responseId:t,isOk:e,result:s})}_OnResultFromDOM(t){const e=t.responseId,s=t.isOk,i=t.result,r=this._pendingResponsePromises.get(e);s?r.resolve(i):r.reject(i),this._pendingResponsePromises.delete(e)}AddDOMComponentMessageHandler(t,e,s){let i=this._domEventHandlers.get(t);if(i||(i=new Map,this._domEventHandlers.set(t,i)),i.has(e))throw new Error(`[Runtime] Component '${t}' already has handler '${e}'`);i.set(e,s)}PostComponentMessageToDOM(t,e,s,i){this._messagePort.postMessage({type:"event",component:t,handler:e,data:s,responseId:null},i)}PostComponentMessageToDOMAsync(t,e,s,i){const r=this._nextDomResponseId++,n=new Promise((t,e)=>{this._pendingResponsePromises.set(r,{resolve:t,reject:e})});return this._messagePort.postMessage({type:"event",component:t,handler:e,data:s,responseId:r},i),n}SendWrapperExtensionMessage(t,e,s,i=-1){this.PostComponentMessageToDOM("runtime","send-wrapper-extension-message",{componentId:t,messageId:e,params:s,asyncId:i})}SendRawWrapperExtensionMessage(t){this.PostComponentMessageToDOM("runtime","send-raw-wrapper-extension-message",t)}SendWrapperExtensionMessageAsync(t,e,s){const i=this._nextDomResponseId++,r=new Promise((t,e)=>{this._pendingResponsePromises.set(i,{resolve:t,reject:e})});return this.SendWrapperExtensionMessage(t,e,s,i),r}_OnWrapperExtensionMessage(t){if(-1!==t.asyncId){const e=t.asyncId;this._pendingResponsePromises.get(e).resolve(t.params),this._pendingResponsePromises.delete(e)}else this._OnEventFromDOM({component:"wrapper-extension:"+t.componentId,handler:t.messageId,data:t.params,responseId:null})}AddWrapperExtensionMessageHandler(t,e,s){this.AddDOMComponentMessageHandler("wrapper-extension:"+t,e,s)}HasWrapperComponentId(t){return this._addonManager.HasWrapperComponentId(t)}PostToDebugger(t){if(!this.IsDebug())throw new Error("not in debug mode");this.PostComponentMessageToDOM("runtime","post-to-debugger",t)}async Init(t){lT.CommonACES_SetRuntime(this),this.IsDebug()?await cT.Init(this):self.C3Debugger&&self.C3Debugger.InitPreview(this);const e=await this._assetManager.FetchJson("data.json");if(await this._LoadDataJson(e),await this._InitialiseCanvas(t),this.IsPreview()||console.info("%cMade with Construct, the game and animation creation tool. Visit: https://www.construct.net","font-weight: bold"),this.GetWebGLRenderer()){const t=this.GetWebGLRenderer();console.info(`[C3 runtime] Hosted in ${this.IsInWorker()?"worker":"DOM"}, rendering with WebGL ${t.GetWebGLVersionNumber()} [${t.GetUnmaskedRenderer()}]`)}else this.GetWebGPURenderer()&&console.info(`[C3 runtime] Hosted in ${this.IsInWorker()?"worker":"DOM"}, rendering with WebGPU [${this.GetWebGPURenderer().GetAdapterInfoString()}]`);this.GetRenderer().HasMajorPerformanceCaveat()&&console.warn("[C3 runtime] The renderer indicates a major performance caveat. Software rendering may be in use. This can result in significantly degraded performance."),this._isReadyToHandleEvents=!0;for(const t of this._waitingToHandleEvents)this._OnEventFromDOM(t);lT.clearArray(this._waitingToHandleEvents),this._canvasManager&&this._canvasManager.StartLoadingScreen();for(const e of t.runOnStartupFunctions)this._additionalLoadPromises.push(this._RunOnStartupFunction(e));if(await Promise.all([this._assetManager.WaitForAllToLoad(!1),...this._additionalLoadPromises]),lT.clearArray(this._additionalLoadPromises),!this._assetManager.HasHadErrorLoading())return this._canvasManager&&await this._canvasManager.EndLoadingScreen(),await this._dispatcher.dispatchEventAndWaitAsync(new lT.Event("beforeruntimestart")),await this.Start(),this._messagePort.postMessage({type:"runtime-ready"}),this;this._canvasManager&&this._canvasManager.HideCordovaSplashScreen()}async _RunOnStartupFunction(t){try{await t(this._iRuntime)}catch(t){console.error("[C3 runtime] Error in runOnStartup function: ",t)}}async _LoadDataJson(t){const e=t.project;this._projectName=e[0],this._projectVersion=e[16],this._projectUniqueId=e[31],this._appId=e[38],this._exportTimestamp=e[36];const s=e[39]||"loading-logo.png";this._isPixelRoundingEnabled=!!e[9],this._originalViewportWidth=this._viewportWidth=e[10],this._originalViewportHeight=this._viewportHeight=e[11],this._collisionEngine._InitCollisionCellSize(this._originalViewportWidth,this._originalViewportHeight),this._parallaxXorigin=this._originalViewportWidth/2,this._parallaxYorigin=this._originalViewportHeight/2,this._framerateMode=e[37],this._uses3dFeatures=!!e[40],this._sampling=e[14],this._usesAnyBackgroundBlending=e[15],this._usesAnyCrossSampling=e[42],this._usesAnyDepthSampling=e[17],this._usesLoaderLayout=!!e[18],this._loaderStyle=e[19],this._nextUid=e[21],this._pauseOnBlur=e[22],this._constructVersionCode=e[51];const i=this._assetManager;i._SetAudioFiles(e[7],e[25]),i._SetMediaSubfolder(e[8]),i._SetFontsSubfolder(e[32]),i._SetIconsSubfolder(e[28]),i._SetWebFonts(e[29]),i._SetExportedFileList(e[45]),0===this._loaderStyle&&s&&(this._loadingLogoAsset=i.LoadImage({url:s})),this._canvasManager&&(this._canvasManager.SetFullscreenMode(lT.CanvasManager._FullscreenModeNumberToString(e[12])),this._canvasManager.SetFullscreenScalingQuality(e[23]?"high":"low"),this._canvasManager.SetMipmapsEnabled(0!==e[24]),this._canvasManager._SetGPUPowerPreference(e[34]),this._canvasManager._SetTextureAnisotropy(e[41]),this._canvasManager._SetWebGPUEnabled(e[13]),this._canvasManager._SetZAxisScale(e[30]),this._canvasManager._SetZDistances(e[46],e[47]),this._canvasManager._SetInitFieldOfView(e[26]),this._canvasManager._SetLimitedToWebGL1(e[48]),this._canvasManager._SetMultitexturingMode(e[50]));const r=e[43];r&&await this._LoadExportToVideoData(r),this._InitScriptInterfaces(),this._addonManager.CreateSystemPlugin(),this._objectReferenceTable=self.C3_GetObjectRefTable();const n=e[2];for(const t of n[1])this._addonManager.CreateBehavior(t);for(const t of n[0])this._addonManager.CreatePlugin(t);this._objectReferenceTable=self.C3_GetObjectRefTable(),this._LoadJsPropNameTable(),this._addonManager._InitAddonScriptInterfaces();for(const t of e[3]){const e=lT.ObjectClass.Create(this,this._allObjectClasses.length,t);this._allObjectClasses.push(e),this._objectClassesByName.set(e.GetName().toLowerCase(),e),this._objectClassesBySid.set(e.GetSID(),e)}for(const t of e[4])this._allObjectClasses[t[0]]._LoadFamily(t);for(const t of e[27]){const e=t.map(t=>this._allObjectClasses[t]);this._allContainers.push(lT.New(lT.Container,this,e))}this._InitObjectsScriptInterface();for(const t of this._allObjectClasses)t._OnAfterCreate();for(const t of e[5])this._layoutManager.Create(t);const a=e[1];if(a){const t=this._layoutManager.GetLayoutByName(a);t&&this._layoutManager.SetFirstLayout(t)}for(const t of e[35])this._transitionManager.Create(t);for(const t of e[33])this._timelineManager.Create(t);for(const t of e[44])this._templateManager.Create(t);this._templateManager.HasTemplates()||(this._templateManager.Release(),this._templateManager=null);for(const t of e[49])this._flowchartManager.Create(t);this._flowchartManager.HasFlowcharts()||(this._flowchartManager.Release(),this._flowchartManager=null);for(const t of e[6])this._eventSheetManager.Create(t);this._eventSheetManager._PostInit(),this._InitGlobalVariableScriptInterface(),lT.clearArray(this._objectReferenceTable),this.FlushPendingInstances();let o="any";const h=e[20];1===h?o="portrait":2===h&&(o="landscape"),this.PostComponentMessageToDOM("runtime","set-target-orientation",{targetOrientation:o})}async _LoadExportToVideoData(t){const e=t.format;"image-sequence"===e?this._exportToVideo=new self.C3ExportToImageSequence(this,t):"image-sequence-gif"===e?this._exportToVideo=new self.C3ExportToGIF(this,t):"webm"===e?this._exportToVideo=new self.C3ExportToWebMVideo(this,t):"mp4"===e&&(this._exportToVideo=new self.C3ExportToMP4Video(this,t)),this._framerateMode="unlimited-frame",this._canvasManager.SetFullscreenMode("off"),this._devicePixelRatio=1,self.devicePixelRatio=1,await this.PostComponentMessageToDOMAsync("runtime","set-exporting-to-video",{message:this._exportToVideo.GetExportingMessageForPercent(0),duration:this._exportToVideo.GetDuration()})}GetLoaderStyle(){return this._loaderStyle}IsExportToVideo(){return null!==this._exportToVideo}GetExportVideoDuration(){return this._exportToVideo.GetDuration()}GetExportVideoFramerate(){return this._exportToVideo.GetFramerate()}_InitExportToVideo(){return this._exportToVideo.Init({width:this._canvasManager.GetDeviceWidth(),height:this._canvasManager.GetDeviceHeight()})}_ExportToVideoAddFrame(){const t=this._tickCount/this.GetExportVideoFramerate();return this._exportToVideo.AddFrame(this._canvasManager.GetMainCanvas(),t)}_ExportToVideoAddKeyframe(){this._exportToVideo&&this._exportToVideo.AddKeyframe()}_OnOfflineAudioRenderCompleted(t){this._exportToVideo.OnOfflineAudioRenderCompleted(t)}_ExportToVideoFinish(){return this._exportToVideo.Finish()}IsFBInstantAvailable(){return this._isFBInstantAvailable}IsLoading(){return this._isLoading}AddLoadPromise(t){this._additionalLoadPromises.push(t)}SetUsingCreatePromises(t){this._isUsingCreatePromises=!!t}AddCreatePromise(t){this._isUsingCreatePromises&&this._additionalCreatePromises.push(t)}GetCreatePromises(){return this._additionalCreatePromises}_GetNextFamilyIndex(){return this._familyCount++}GetFamilyCount(){return this._familyCount}_AddEffectList(t){this._allEffectLists.add(t)}_RemoveEffectList(t){this._allEffectLists.delete(t)}_GetAllEffectLists(){return this._allEffectLists}async _InitialiseCanvas(t){this._canvasManager&&(await this._canvasManager.CreateCanvas(t),this._canvasManager.InitLoadingScreen(this._loaderStyle))}async Start(){this._hasStarted=!0,this._startTime=Date.now();let t=null;const e=new Promise(e=>t=e);if(this._usesLoaderLayout){for(const t of this._allObjectClasses)t.IsFamily()||t.IsOnLoaderLayout()||!t.IsWorldType()||t.OnCreate();(async()=>{await this._assetManager.WaitForAllToLoad(!0),await e,this._isLoading=!1,this._OnLoadFinished()})()}else this._isLoading=!1;this._assetManager.SetInitialLoadFinished(),this.IsDebug()&&cT.RuntimeInit(dT);for(const t of this._layoutManager.GetAllLayouts())t._CreateGlobalNonWorlds();this.IsExportToVideo()&&await this._InitExportToVideo();const s=this._layoutManager.GetFirstLayout();await s._Load(null,this.GetRenderer()),await s._StartRunning(!0),this._fpsLastTime=performance.now(),t(),this._usesLoaderLayout||this._OnLoadFinished(),(await this.PostComponentMessageToDOMAsync("runtime","before-start-ticking")).isSuspended&&!this.IsExportToVideo()?(this._suspendCount++,this._isPageVisibilitySuspended=!0):this.Tick()}_OnLoadFinished(){this.Trigger(lT.Plugins.System.Cnds.OnLoadFinished,null,null),this.PostComponentMessageToDOM("runtime","register-sw")}GetObjectReference(t){t=Math.floor(t);const e=this._objectReferenceTable;if(t<0||t>=e.length)throw new Error("invalid object reference");return e[t]}_LoadJsPropNameTable(){for(const t of self.C3_JsPropNameTable){const e=lT.first(Object.keys(t));this._jsPropNameTable.push(e)}}GetJsPropName(t){t=Math.floor(t);const e=this._jsPropNameTable;if(t<0||t>=e.length)throw new Error("invalid prop reference");return e[t]}HasDOM(){return this._hasDom}IsHeadless(){return this._isHeadless}IsInWorker(){return this._isInWorker}GetRuntimeBaseURL(){return this._runtimeBaseUrl}GetPreviewURL(){return this._previewUrl}GetEventSheetManager(){return this._eventSheetManager}GetEventStack(){return this._eventSheetManager.GetEventStack()}GetCurrentEventStackFrame(){return this._eventSheetManager.GetCurrentEventStackFrame()}GetCurrentEvent(){return this._eventSheetManager.GetCurrentEvent()}GetCurrentCondition(){return this._eventSheetManager.GetCurrentCondition()}IsCurrentConditionFirst(){return 0===this.GetCurrentEventStackFrame().GetConditionIndex()}GetCurrentAction(){return this._eventSheetManager.GetCurrentAction()}GetAddonManager(){return this._addonManager}GetSystemPlugin(){return this._addonManager.GetSystemPlugin()}GetObjectClassByIndex(t){if((t=Math.floor(t))<0||t>=this._allObjectClasses.length)throw new RangeError("invalid index");return this._allObjectClasses[t]}GetObjectClassByName(t){return this._objectClassesByName.get(t.toLowerCase())||null}GetObjectClassBySID(t){return this._objectClassesBySid.get(t)||null}GetSingleGlobalObjectClassByCtor(t){const e=lT.AddonManager.GetPluginByConstructorFunction(t);return e?e.GetSingleGlobalObjectClass():null}GetAllObjectClasses(){return this._allObjectClasses}*allInstances(){for(const t of this._allObjectClasses)t.IsFamily()||(yield*t.instances())}Dispatcher(){return this._dispatcher}UserScriptDispatcher(){return this._userScriptDispatcher}DispatchUserScriptEvent(t){t.runtime=this.GetIRuntime();const e=this.IsDebug()&&!this._eventSheetManager.IsInEventEngine();e&&cT.StartMeasuringScriptTime(),this._userScriptDispatcher.dispatchEvent(t),e&&cT.AddScriptTime()}DispatchUserScriptEventAsyncWait(t){return t.runtime=this.GetIRuntime(),this._userScriptDispatcher.dispatchEventAndWaitAsync(t)}GetOriginalViewportWidth(){return this._originalViewportWidth}GetOriginalViewportHeight(){return this._originalViewportHeight}SetOriginalViewportSize(t,e){if(this._originalViewportWidth===t&&this._originalViewportHeight===e)return;this._originalViewportWidth=t,this._originalViewportHeight=e;const s=this.GetLayoutManager();s.SetAllLayerProjectionChanged(),s.SetAllLayerMVChanged()}GetViewportWidth(){return this._viewportWidth}GetViewportHeight(){return this._viewportHeight}SetViewportSize(t,e){if(this._viewportWidth===t&&this._viewportHeight===e)return;this._viewportWidth=t,this._viewportHeight=e;const s=this.GetLayoutManager();s.SetAllLayerProjectionChanged(),s.SetAllLayerMVChanged()}_SetDevicePixelRatio(t){this.IsExportToVideo()||(this._devicePixelRatio=t)}GetDevicePixelRatio(){return this._devicePixelRatio}GetParallaxXOrigin(){return this._parallaxXorigin}GetParallaxYOrigin(){return this._parallaxYorigin}GetCanvasManager(){return this._canvasManager}GetDrawWidth(){return this._canvasManager?this._canvasManager.GetDrawWidth():this._viewportWidth}GetDrawHeight(){return this._canvasManager?this._canvasManager.GetDrawHeight():this._viewportHeight}GetRenderScale(){return this._canvasManager?this._canvasManager.GetRenderScale():1}GetDisplayScale(){return this._canvasManager?this._canvasManager.GetDisplayScale():1}GetEffectLayerScaleParam(){return this._canvasManager?this._canvasManager.GetEffectLayerScaleParam():1}GetEffectDevicePixelRatioParam(){return this._canvasManager?this._canvasManager.GetEffectDevicePixelRatioParam():1}GetCanvasClientX(){return this._canvasManager?this._canvasManager.GetCanvasClientX():0}GetCanvasClientY(){return this._canvasManager?this._canvasManager.GetCanvasClientY():0}GetCanvasCssWidth(){return this._canvasManager?this._canvasManager.GetCssWidth():0}GetCanvasCssHeight(){return this._canvasManager?this._canvasManager.GetCssHeight():0}GetFullscreenMode(){return this._canvasManager?this._canvasManager.GetFullscreenMode():"off"}GetAdditionalRenderTarget(t){return this._canvasManager?this._canvasManager.GetAdditionalRenderTarget(t):null}ReleaseAdditionalRenderTarget(t){this._canvasManager&&this._canvasManager.ReleaseAdditionalRenderTarget(t)}UsesAnyBackgroundBlending(){return this._usesAnyBackgroundBlending}UsesAnyCrossSampling(){return this._usesAnyCrossSampling}UsesAnyDepthSampling(){return this._usesAnyDepthSampling}GetGPUUtilisation(){return this._canvasManager?this._canvasManager.GetGPUUtilisation():NaN}IsLinearSampling(){return"nearest"!==this.GetSampling()}GetFramerateMode(){return this._framerateMode}_SetFramerateMode(t){this._framerateMode!==t&&(this._framerateMode=t,-1===this._rafId&&-1===this._ruafId||(this._CancelAnimationFrame(),this._RequestAnimationFrame()))}GetSampling(){return this._sampling}UsesLoaderLayout(){return this._usesLoaderLayout}GetLoadingLogoAsset(){return this._loadingLogoAsset}ReleaseLoadingLogoAsset(){this._loadingLogoAsset&&(this._loadingLogoAsset.ReleaseTexture(),this._loadingLogoAsset.Release(),this._loadingLogoAsset=null)}GetLayoutManager(){return this._layoutManager}GetMainRunningLayout(){return this._layoutManager.GetMainRunningLayout()}GetTimelineManager(){return this._timelineManager}GetTransitionManager(){return this._transitionManager}GetTemplateManager(){return this._templateManager}GetFlowchartManager(){return this._flowchartManager}GetAssetManager(){return this._assetManager}LoadImage(t){return this._assetManager.LoadImage(t)}CreateInstance(t,e,s,i,r,n){if(n&&this._templateManager){if(t instanceof lT.ObjectClass&&t.IsFamily()){const a=t.GetFamilyMembers(),o=Math.floor(this.Random()*a.length);return this.CreateInstance(a[o],e,s,i,r,n)}const a=this._templateManager.GetTemplateData(t,n);if(a){const t=this.CreateInstanceFromData(a,e,!1,s,i,!1,r,void 0,r);return this._templateManager.MapInstanceToTemplateName(t,n),t}}return this.CreateInstanceFromData(t,e,!1,s,i,!1,r,void 0,r)}CreateInstanceFromData(t,e,s,i,r,n,a,o,h){let l=null,c=null;if(t instanceof lT.ObjectClass){if(c=t,c.IsFamily()){const t=c.GetFamilyMembers();c=t[Math.floor(this.Random()*t.length)]}l=c.GetDefaultInstanceData()}else l=t,c=this.GetObjectClassByIndex(l[1]);const u=c.GetPlugin().IsWorldType();if(this._isLoading&&u&&!c.IsOnLoaderLayout())return null;const _=e;let d;u||(e=null),d=s&&!n&&l&&!this._instancesByUid.has(l[2])?l[2]:this._nextUid++;const p=l?l[0]:null,f=lT.New(lT.Instance,{runtime:this,objectType:c,layer:e,worldData:p,instVarData:l?l[3]:null,uid:d,tags:l?l[6]:null});this._instancesByUid.set(d,f);let g=null;if(u&&(g=f.GetWorldInfo(),void 0!==i&&void 0!==r&&(g.SetX(i),g.SetY(r)),c._SetAnyCollisionCellChanged(!0)),e&&(h||e._AddInstance(f,!0),e.GetLayout().MaybeLoadTexturesFor(c)),this._objectCount++,c.IsInContainer()&&!s&&!n){const t=new Set;for(const e of c.GetContainer().objectTypes()){if(e===c)continue;const s=this._MaybeGetChildInstanceForObjectTypeData(e,g,t);if(s){const t=this.CreateInstanceFromData(s,_,!1,g?g.GetX():i,g?g.GetY():r,!0,!1,void 0,h);f._AddSibling(t)}else{const t=this.CreateInstanceFromData(e,_,!1,g?g.GetX():i,g?g.GetY():r,!0,!1,void 0,h);f._AddSibling(t)}}for(const t of f.siblings()){t._AddSibling(f);for(const e of f.siblings())t!==e&&t._AddSibling(e)}}if(u&&!s&&a&&this._CreateChildInstancesFromData(f,p,g,e,i,r,h),c.IsInContainer()&&!s&&!n&&a)for(const t of f.siblings()){const s=t.GetWorldInfo();if(!s)continue;const i=t.GetPlugin(),r=t.GetObjectClass().GetDefaultInstanceData()[0];i.IsWorldType()?this._CreateChildInstancesFromData(t,r,s,e,s.GetX(),s.GetY(),h):this._CreateChildInstancesFromData(t,r,s,e,void 0,void 0,h)}if(!n&&a){void 0===i&&(i=p[0]),void 0===r&&(r=p[1]);const t=g.GetTopParent(),e=i-g.GetX()+t.GetX(),s=r-g.GetY()+t.GetY();t.SetXY(e,s)}c._SetIIDsStale();const m=l?lT.cloneArray(l[5]):null,S=l?l[4].map(t=>lT.cloneArray(t)):null,y=u&&p&&p[13];if(y&&f._SetHasTilemap(),f._CreateSdkInstance(m,S),y){const t=p[13];f.GetSdkInstance().LoadTilemapData(t[2],t[0],t[1])}this._instancesPendingCreate.push(f),this._hasPendingInstances=!0,this.IsDebug()&&cT.InstanceCreated(f);const G=this._eventObjects.instancecreate;return G.instance=f,this._dispatcher.dispatchEvent(G),f}_GetInstanceData(t){const e=t[0],s=t[1],i=t[2],r=t[6];return r||this._layoutManager.GetLayoutBySID(e).GetLayer(s).GetInitialInstanceData(i)}_MaybeGetChildInstanceForObjectTypeData(t,e,s){const i=e?.GetSceneGraphChildrenExportData()??[];for(const e of i){const i=this._GetInstanceData(e),r=!!e[4],n=this.GetObjectClassByIndex(i[1]);if(!s.has(i)&&t===n&&r)return s.add(i),i}}_CreateChildInstancesFromData(t,e,s,i,r,n,a){const o=s.GetSceneGraphZIndexExportData(),h=s.GetSceneGraphChildrenExportData();if(t.GetWorldInfo().SetSceneGraphZIndex(o),!h)return;void 0===r&&(r=e[0]),void 0===n&&(n=e[1]);const l=new Set,c=e[0],u=e[1];for(const e of h){const s=e[0],o=e[1],h=e[2],_=e[3],d=!!e[4],p=e[5],f=e[6];let g;g=f||this._layoutManager.GetLayoutBySID(s).GetLayer(o).GetInitialInstanceData(h);const m=this.GetObjectClassByIndex(g[1]),S=t.HasSibling(m),y=l.has(m);if(S&&!y&&d){const e=t.GetSibling(m);e.GetWorldInfo().Init(g[0]);const s=r+g[0][0]-c,i=n+g[0][1]-u;e.GetWorldInfo().SetXY(s,i),e.GetWorldInfo().SetSceneGraphZIndex(p),t.AddChild(e,{transformX:!!(1&_),transformY:!!(_>>1&1),transformWidth:!!(_>>2&1),transformHeight:!!(_>>3&1),transformAngle:!!(_>>4&1),destroyWithParent:!!(_>>5&1),transformZElevation:!!(_>>6&1),transformOpacity:!!(_>>7&1),transformVisibility:!!(_>>8&1)}),l.add(m)}else{const e=r+g[0][0]-c,s=n+g[0][1]-u,o=this.CreateInstanceFromData(g,i,!1,e,s,!1,!0,t,a);o.GetWorldInfo().SetSceneGraphZIndex(p),t.AddChild(o,{transformX:!!(1&_),transformY:!!(_>>1&1),transformWidth:!!(_>>2&1),transformHeight:!!(_>>3&1),transformAngle:!!(_>>4&1),destroyWithParent:!!(_>>5&1),transformZElevation:!!(_>>6&1),transformOpacity:!!(_>>7&1),transformVisibility:!!(_>>8&1)})}}}DestroyInstance(t){if(this._instancesPendingRelease.has(t))return;const e=t.GetObjectClass();let s=this._instancesPendingDestroy.get(e);if(s){if(s.has(t))return;s.add(t)}else s=new Set,s.add(t),this._instancesPendingDestroy.set(e,s);if(this.IsDebug()&&cT.InstanceDestroyed(t),t._MarkDestroyed(),this._hasPendingInstances=!0,t.IsInContainer())for(const e of t.siblings())this.DestroyInstance(e);for(const e of t.children())e.GetDestroyWithParent()&&this.DestroyInstance(e);if(!this._layoutManager.IsEndingLayout()&&!this._isLoadingState){const e=this.GetEventSheetManager();e.BlockFlushingInstances(!0),t._TriggerOnDestroyed(),e.BlockFlushingInstances(!1)}t._FireDestroyedScriptEvents(this._layoutManager.IsEndingLayout())}FlushPendingInstances(){this._hasPendingInstances&&(this._isFlushingPendingInstances=!0,this._FlushInstancesPendingCreate(),this._FlushInstancesPendingDestroy(),this._isFlushingPendingInstances=!1,this._hasPendingInstances=!1,this.UpdateRender())}_FlushInstancesPendingCreate(){for(const t of this._instancesPendingCreate){const e=t.GetObjectClass();e._AddInstance(t);for(const s of e.GetFamilies())s._AddInstance(t),s._SetIIDsStale()}lT.clearArray(this._instancesPendingCreate)}_FlushInstancesPendingDestroy(){this._dispatcher.SetDelayRemoveEventsEnabled(!0);for(const[t,e]of this._instancesPendingDestroy.entries())this._FlushInstancesPendingDestroyForObjectClass(t,e),e.clear();this._instancesPendingDestroy.clear(),this._dispatcher.SetDelayRemoveEventsEnabled(!1)}_FlushInstancesPendingDestroyForObjectClass(t,e){for(const t of e){const e=this._eventObjects.instancedestroy;e.instance=t,this._dispatcher.dispatchEvent(e),this._instancesByUid.delete(t.GetUID()),this._instanceTimes.delete(t);const s=t.GetWorldInfo();s&&(s._RemoveFromCollisionCells(),s._RemoveFromRenderCells(),s._MarkDestroyed()),this._instancesPendingRelease.add(t),this._objectCount--}lT.arrayRemoveAllInSet(t.GetInstances(),e),t._SetIIDsStale(),this._instancesPendingReleaseAffectedObjectClasses.add(t);for(const s of t.GetFamilies())lT.arrayRemoveAllInSet(s.GetInstances(),e),s._SetIIDsStale(),this._instancesPendingReleaseAffectedObjectClasses.add(s);if(t.GetPlugin().IsWorldType()){const t=new Set([...e].map(t=>t.GetWorldInfo().GetLayer()));for(const s of t)s._RemoveAllInstancesInSet(e)}}_GetInstancesPendingCreate(){return this._instancesPendingCreate}*instancesPendingCreateForObjectClass(t){for(const e of this._GetInstancesPendingCreate())t.IsFamily()?e.GetObjectClass().BelongsToFamily(t)&&(yield e):e.GetObjectClass()===t&&(yield e)}_GetNewUID(){return this._nextUid++}_MapInstanceByUID(t,e){this._instancesByUid.set(t,e)}_SetAutoSuspendEnabled(t){t=!!t,this._isAutoSuspendEnabled!==t&&(this._isAutoSuspendEnabled=!!t,this._isAutoSuspendEnabled&&this._isPageVisibilitySuspended&&(this.SetSuspended(!1),this._isPageVisibilitySuspended=!1))}_IsAutoSuspendEnabled(){return this._isAutoSuspendEnabled}_OnRendererContextLost(){this._dispatcher.dispatchEvent(lT.New(lT.Event,"renderercontextlost")),this.SetSuspended(!0);for(const t of this._allObjectClasses)!t.IsFamily()&&t.HasLoadedTextures()&&t.ReleaseTextures();const t=this.GetMainRunningLayout();t&&t._OnRendererContextLost(),lT.ImageInfo.OnRendererContextLost(),lT.ImageAsset.OnRendererContextLost()}async _OnRendererContextRestored(){await this.GetMainRunningLayout()._Load(null,this.GetRenderer()),this._dispatcher.dispatchEvent(lT.New(lT.Event,"renderercontextrestored")),this.SetSuspended(!1),this.UpdateRender()}_OnVisibilityChange(t){if(!this._isAutoSuspendEnabled)return;const e=t.hidden;this.SetSuspended(e),this._isPageVisibilitySuspended=e,e||this.UpdateRender()}_OnWindowBlur(t){this.IsPreview()&&this._pauseOnBlur&&!lT.Platform.IsMobile&&(t.data.parentHasFocus||(this.SetSuspended(!0),this._isPausedOnBlur=!0))}_OnWindowFocus(){this._isPausedOnBlur&&(this.SetSuspended(!1),this._isPausedOnBlur=!1)}_RequestAnimationFrame(){const t=this._tickCallbacks;"vsync"===this._framerateMode?-1===this._rafId&&(this._rafId=self.requestAnimationFrame(t.normal)):"unlimited-tick"===this._framerateMode?(-1===this._ruafId&&(this._ruafId=lT.RequestUnlimitedAnimationFrame(t.tickOnly)),-1===this._rafId&&(this._rafId=self.requestAnimationFrame(t.renderOnly))):-1===this._ruafId&&(this._ruafId=lT.RequestUnlimitedAnimationFrame(t.normal))}_CancelAnimationFrame(){-1!==this._rafId&&(self.cancelAnimationFrame(this._rafId),this._rafId=-1),-1!==this._ruafId&&(lT.CancelUnlimitedAnimationFrame(this._ruafId),this._ruafId=-1)}IsSuspended(){return this._suspendCount>0}SetSuspended(t){if(this.IsExportToVideo())return;const e=this.IsSuspended();this._suspendCount+=t?1:-1,this._suspendCount<0&&(this._suspendCount=0);const s=this.IsSuspended();if(!e&&s)console.log("[Construct] Suspending"),this._CancelAnimationFrame(),this._dispatcher.dispatchEvent(lT.New(lT.Event,"suspend")),this.DispatchUserScriptEvent(lT.New(lT.Event,"suspend")),this.Trigger(lT.Plugins.System.Cnds.OnSuspend,null,null);else if(e&&!s){console.log("[Construct] Resuming");const t=performance.now();this._lastTickTime=t,this._fpsLastTime=t,this._fpsFrameCount=0,this._fps=0,this._tpsTickCount=0,this._tps=0,this._mainThreadTime=0,this._mainThreadTimeCounter=0,this._dispatcher.dispatchEvent(lT.New(lT.Event,"resume")),this.DispatchUserScriptEvent(lT.New(lT.Event,"resume")),this.Trigger(lT.Plugins.System.Cnds.OnResume,null,null),this.HitBreakpoint()||this.Tick(t)}}_AddBehInstToTick(t){this._behInstsToTick.Add(t)}_AddBehInstToPostTick(t){this._behInstsToPostTick.Add(t)}_AddBehInstToTick2(t){this._behInstsToTick2.Add(t)}_RemoveBehInstToTick(t){this._behInstsToTick.Remove(t)}_RemoveBehInstToPostTick(t){this._behInstsToPostTick.Remove(t)}_RemoveBehInstToTick2(t){this._behInstsToTick2.Remove(t)}_CallBehaviorTickMethod(t,e){const s=e?performance.now():0;let i;return t instanceof uT?(i=t._tick(),e&&cT.AddIndividualBehaviorTickTime(t.behavior,performance.now()-s)):(i=t.Tick(),e&&cT.AddIndividualBehaviorTickTime(t.GetBehavior(),performance.now()-s)),i}_BehaviorTick(){const t=this.IsDebug();this._behInstsToTick.SetQueueingEnabled(!0);for(const e of this._behInstsToTick)this._CallBehaviorTickMethod(e,t);this._behInstsToTick.SetQueueingEnabled(!1)}_CallBehaviorPostTickMethod(t,e){const s=e?performance.now():0;let i;return t instanceof uT?(i=t._postTick(),e&&cT.AddIndividualBehaviorTickTime(t.behavior,performance.now()-s)):(i=t.PostTick(),e&&cT.AddIndividualBehaviorTickTime(t.GetBehavior(),performance.now()-s)),i}_BehaviorPostTick(){const t=this.IsDebug();this._behInstsToPostTick.SetQueueingEnabled(!0);for(const e of this._behInstsToPostTick)this._CallBehaviorPostTickMethod(e,t);this._behInstsToPostTick.SetQueueingEnabled(!1)}_CallBehaviorTick2Method(t,e){const s=e?performance.now():0;let i;return t instanceof uT?(i=t._tick2(),e&&cT.AddIndividualBehaviorTickTime(t.behavior,performance.now()-s)):(i=t.Tick2(),e&&cT.AddIndividualBehaviorTickTime(t.GetBehavior(),performance.now()-s)),i}_BehaviorTick2(){const t=this.IsDebug();this._behInstsToTick2.SetQueueingEnabled(!0);for(const e of this._behInstsToTick2)this._CallBehaviorTick2Method(e,t);this._behInstsToTick2.SetQueueingEnabled(!1)}*_DebugBehaviorTick(){const t=this.IsDebug();this._behInstsToTick.SetQueueingEnabled(!0);for(const e of this._behInstsToTick){const s=this._CallBehaviorTickMethod(e,t);lT.IsIterator(s)&&(yield*s)}this._behInstsToTick.SetQueueingEnabled(!1)}*_DebugBehaviorPostTick(){const t=this.IsDebug();this._behInstsToPostTick.SetQueueingEnabled(!0);for(const e of this._behInstsToPostTick){const s=this._CallBehaviorPostTickMethod(e,t);lT.IsIterator(s)&&(yield*s)}this._behInstsToPostTick.SetQueueingEnabled(!1)}*_DebugBehaviorTick2(){const t=this.IsDebug();this._behInstsToTick2.SetQueueingEnabled(!0);for(const e of this._behInstsToTick2){const s=this._CallBehaviorTick2Method(e,t);lT.IsIterator(s)&&(yield*s)}this._behInstsToTick2.SetQueueingEnabled(!1)}async Tick(t,e,s){this._hasStartedTicking=!0;const i="background-wake"===s,r="background-wake"!==s&&"skip-render"!==s,n=this.GetLayoutManager(),a=this.GetCanvasManager();if(!this._hasStarted||this.IsSuspended()&&!e&&!i)return;const o=performance.now();this._isInTick=!0,this._MeasureDt(t||0),this._tpsTickCount++,this._ReleasePendingInstances();const h=this.Step_BeforePreTick();this.IsDebugging()&&await h;const l=this._dispatcher.dispatchEventAndWait_AsyncOptional(this._eventObjects.pretick);l instanceof Promise&&await l,this.DispatchUserScriptEvent(this._userScriptEventObjects.pretick);const c=this.Step_AfterPreTick();this.IsDebugging()&&await c,this._NeedsHandleSaveOrLoad()&&await this._HandleSaveOrLoad(),n.IsPendingChangeMainLayout()&&await this._MaybeChangeLayout();const u=this.Step_RunEventsEtc();this.IsDebugging()&&await u;const _=n.GetMainRunningLayout(),d=_._GetPendingSetHTMLLayerCount();let p=!1;if(-1!==d&&(_._ResetPendingHTMLLayerCount(),a.GetHTMLLayerCount()!==d)){const t=this.GetCanvasManager().SetHTMLLayerCount(d);this.IsInWorker()&&(p=!0,await t)}this.PostComponentMessageToDOM("canvas","update-html-layer-dom-state",{layersDomState:_._GetRootLayers().filter(t=>t.IsHTMLElementsLayer()).map(t=>t._GetHTMLLayerDOMState())}),r&&this.Render(),p&&this.PostComponentMessageToDOM("canvas","cleanup-html-layers"),this.IsExportToVideo()&&(await this._ExportToVideoAddFrame(),this.GetGameTime()>=this.GetExportVideoDuration())?this._ExportToVideoFinish():(this.IsSuspended()||i||this._RequestAnimationFrame(),this._tickCount++,this._tickCountNoSave++,this._isInTick=!1,this._mainThreadTimeCounter+=performance.now()-o)}async Step_BeforePreTick(){const t=this._eventSheetManager,e=this.IsDebug();this.FlushPendingInstances(),t.BlockFlushingInstances(!0),this.PushCurrentLayout(this.GetMainRunningLayout()),e&&cT.StartMeasuringTime(),this.IsDebugging()?await t.DebugRunScheduledWaits():t.RunScheduledWaits(),e&&cT.AddEventsTime(),this.PopCurrentLayout(),t.BlockFlushingInstances(!1),this.FlushPendingInstances(),t.BlockFlushingInstances(!0)}async Step_AfterPreTick(){const t=this._eventSheetManager,e=this.IsDebug(),s=this.IsDebugging(),i=this._dispatcher,r=this._eventObjects,n=this._userScriptEventObjects;e&&cT.StartMeasuringTime(),s?await this.DebugIterateAndBreak(this._DebugBehaviorTick()):this._BehaviorTick(),s?await this.DebugIterateAndBreak(this._DebugBehaviorPostTick()):this._BehaviorPostTick(),e&&cT.AddBehaviorTotalTickTime(),e&&cT.StartMeasuringTime(),s?await this.DebugFireGeneratorEventAndBreak(r.tick):i.dispatchEvent(r.tick),e&&cT.AddPluginTotalTickTime(),t.BlockFlushingInstances(!1),this.DispatchUserScriptEvent(n.tick)}async Step_RunEventsEtc(){const t=this._eventSheetManager,e=this._dispatcher,s=this._eventObjects,i=this._userScriptEventObjects,r=this.IsDebug(),n=this.IsDebugging();r&&cT.StartMeasuringTime(),n?await t.DebugRunEvents(this._layoutManager):t.RunEvents(this._layoutManager),r&&cT.AddEventsTime(),this._collisionEngine.ClearRegisteredCollisions(),this._ReleasePendingInstances(),this._isLayoutFirstTick=!1,t.BlockFlushingInstances(!0),r&&cT.StartMeasuringTime(),n?await this.DebugIterateAndBreak(this._DebugBehaviorTick2()):this._BehaviorTick2(),r&&cT.AddBehaviorTotalTickTime(),r&&cT.StartMeasuringTime(),n?await this.DebugFireGeneratorEventAndBreak(s.tick2):e.dispatchEvent(s.tick2),r&&cT.AddPluginTotalTickTime(),t.BlockFlushingInstances(!1),this.DispatchUserScriptEvent(i.tick2),n&&await t.RunQueuedDebugTriggersAsync(),this.FlushPendingInstances(),this._ReleasePendingInstances()}_ReleasePendingInstances(){if(0===this._instancesPendingRelease.size)return;const t=this._dispatcher;t.SetDelayRemoveEventsEnabled(!0);for(const t of this._instancesPendingReleaseAffectedObjectClasses)t.GetSolStack().RemoveInstances(this._instancesPendingRelease);this._instancesPendingReleaseAffectedObjectClasses.clear(),this._eventSheetManager._OnInstancesReleased(this._instancesPendingRelease);for(const t of this._instancesPendingRelease)t.Release();this._instancesPendingRelease.clear(),t.SetDelayRemoveEventsEnabled(!1)}async _MaybeChangeLayout(){const t=this.GetLayoutManager();let e=0;for(;t.IsPendingChangeMainLayout()&&e++<10;)await this._DoChangeLayout(t.GetPendingChangeMainLayout())}_MeasureDt(t){let e=0;this.IsExportToVideo()?(e=1/this.GetExportVideoFramerate(),this._dtRaw=e,this._dt1=e):0!==this._lastTickTime&&(e=Math.max(t-this._lastTickTime,0)/1e3,e>.5&&(e=0),this._dtRaw=e,this._dt1=lT.clamp(e,this._minDt,this._maxDt)),this._lastTickTime=t,this._dt=this._dt1*this._timeScale,this._gameTime.Add(this._dt),this._gameTimeRaw.Add(e*this._timeScale),this._wallTime.Add(this._dt1);for(const[t,e]of this._instanceTimes)e.Add(this._dt1*t.GetTimeScale());this._canvasManager&&this._canvasManager._UpdateTick(),t-this._fpsLastTime>=1e3&&(this._fpsLastTime+=1e3,t-this._fpsLastTime>=1e3&&(this._fpsLastTime=t),this._fps=this._fpsFrameCount,this._fpsFrameCount=0,this._tps=this._tpsTickCount,this._tpsTickCount=0,this._mainThreadTime=Math.min(this._mainThreadTimeCounter/1e3,1),this._mainThreadTimeCounter=0,this._canvasManager&&this._canvasManager._Update1sFrameRange(),this._collisionEngine._Update1sStats(),this.IsDebug()&&cT.Update1sPerfStats())}_SetTrackingInstanceTime(t,e){if(e){if(!this._instanceTimes.has(t)){const e=lT.New(lT.KahanSum);e.Copy(this._gameTime),this._instanceTimes.set(t,e)}}else this._instanceTimes.delete(t)}_GetInstanceGameTime(t){const e=this._instanceTimes.get(t);return e?e.Get():this.GetGameTime()}async _DoChangeLayout(t){const e=this._dispatcher,s=this.GetLayoutManager().GetMainRunningLayout();await s._StopRunning(),s._Unload(t,this.GetRenderer()),s===t&&this._eventSheetManager.ClearAllScheduledWaits(),this._collisionEngine.ClearRegisteredCollisions(),this._ReleasePendingInstances(),e.dispatchEvent(this._eventObjects.beforelayoutchange),lT.Asyncify.SetHighThroughputMode(!0),await t._Load(s,this.GetRenderer()),lT.Asyncify.SetHighThroughputMode(!1),await t._StartRunning(!1),e.dispatchEvent(this._eventObjects.layoutchange),this.UpdateRender(),this._isLayoutFirstTick=!0,this.FlushPendingInstances(),this._ExportToVideoAddKeyframe()}UpdateRender(){this._needRender=!0}GetWebGLRenderer(){return this._canvasManager?this._canvasManager.GetWebGLRenderer():null}GetWebGPURenderer(){return this._canvasManager?this._canvasManager.GetWebGPURenderer():null}GetRenderer(){return this._canvasManager?this._canvasManager.GetRenderer():null}Render(){const t=this._canvasManager;if(!t||t.IsRendererContextLost())return;const e=this.GetRenderer(),s=e.SupportsGPUProfiling(),i=s&&e.IsWebGL(),r=s&&e.IsWebGPU();if(i&&e.CheckForQueryResults(),!this._needRender&&!this.IsExportToVideo())return void e.IncrementFrameNumber();const n=this._layoutManager.GetMainRunningLayout();this._fpsFrameCount++,e.Start();const a=this.IsDebug();a&&cT.StartMeasuringTime(),this._needRender=!1;let o=null;i&&(o=t.GetGPUFrameTimingsBuffer().AddTimeElapsedQuery(),e.StartQuery(o));let h=null;r&&(h=e.StartFrameTiming(2*(1+n.GetLayerCount())),e.StartMeasuringRenderPassTime(0,1)),this.Uses3DFeatures()&&"low"===t.GetCurrentFullscreenScalingQuality()?e.SetFixedSizeDepthBuffer(t.GetDrawWidth(),t.GetDrawHeight()):e.SetAutoSizeDepthBuffer(),this._Render(this.GetRenderer(),n),o&&e.EndQuery(o),r&&(e.StopMeasuringRenderPassTime(),this._canvasManager._AddWebGPUFrameTiming(h)),e.Finish(),a&&(cT.AddDrawCallsTime(),cT.UpdateInspectHighlight()),t&&t._MaybeTakeSnapshot()}_NeedsHTMLLayerCompositing(t){return"low"===this.GetCanvasManager().GetCurrentFullscreenScalingQuality()||t.IsWebGL()&&(this.UsesAnyBackgroundBlending()||this.Uses3DFeatures())}_Render(t,e){t.SetTextureFillMode(),t.SetAlphaBlend(),t.ResetCullState(),t.SetColorRgba(1,1,1,1),t.SetRenderTarget(null),t.SetTexture(null),t.SetDepthEnabled(this.Uses3DFeatures()),this.Dispatcher().dispatchEvent(this._eventObjects.beforerender),this._NeedsHTMLLayerCompositing(t)&&e._MaybeStartDrawToOwnTexture(t);const s=e.GetHTMLLayerCount();for(let i=1;i<s;++i)e.DrawForHTMLLayerIndex(t,i),t.IsWebGPU()&&t.Restart();this._NeedsHTMLLayerCompositing(t)||e._MaybeStartDrawToOwnTexture(t),e.DrawMain(t),this.Dispatcher().dispatchEvent(this._eventObjects.afterrender)}Trigger(t,e,s){if(!this._hasStarted)return!1;const i=!this._isInTick&&!this._eventSheetManager.IsInTrigger();let r=0;i&&(r=performance.now());const n=this.IsDebug();n&&this.SetDebuggingEnabled(!1);const a=this._eventSheetManager._Trigger(this._layoutManager,t,e,s);if(i){const t=performance.now()-r;this._mainThreadTimeCounter+=t,n&&cT.AddTriggersTime(t)}return n&&this.SetDebuggingEnabled(!0),a}DebugTrigger(t,e,s){if(!this.IsDebugging())return this.Trigger(t,e,s);if(this.HitBreakpoint())throw new Error("called DebugTrigger() while stopped on breakpoint");if(!this._isInTick&&!this._eventSheetManager.IsInTrigger())throw new Error("called DebugTrigger() outside of event code - use TriggerAsync() instead");return this._eventSheetManager._DebugTrigger(this._layoutManager,t,e,s)}async TriggerAsync(t,e,s){if(!this.IsDebugging())return this.Trigger(t,e,s);if(!this._hasStarted)return!1;if(this.HitBreakpoint())return this._eventSheetManager.QueueDebugTrigger(t,e,s);if(!this.GetMainRunningLayout())return this._eventSheetManager.QueueTrigger(t,e,s);const i=performance.now(),r=this._eventSheetManager._DebugTrigger(this._layoutManager,t,e,s);let n=r.next();for(;!n.done;)await this.DebugBreak(n.value),n=r.next();return this.IsSuspended()||this._eventSheetManager.IsInTrigger()||(await this._eventSheetManager.RunQueuedDebugTriggersAsync(),this._hasStartedTicking&&!this._isInTick&&this._RequestAnimationFrame()),this._mainThreadTimeCounter+=performance.now()-i,n.value}FastTrigger(t,e,s){const i=this.IsDebug();i&&this.SetDebuggingEnabled(!1);const r=this._eventSheetManager._FastTrigger(this._layoutManager,t,e,s);return i&&this.SetDebuggingEnabled(!0),r}DebugFastTrigger(t,e,s){return this._eventSheetManager._DebugFastTrigger(this._layoutManager,t,e,s)}ScheduleTriggers(t){return this._scheduleTriggersThrottle.Add(t)}PushCurrentLayout(t){this._currentLayoutStack.push(t)}PopCurrentLayout(){if(!this._currentLayoutStack.length)throw new Error("layout stack empty");this._currentLayoutStack.pop()}GetCurrentLayout(){return this._currentLayoutStack.length?this._currentLayoutStack.at(-1):this.GetMainRunningLayout()}GetDt(t){return t&&-1!==t.GetTimeScale()?this._dt1*t.GetTimeScale():this._dt}_GetDtFast(){return this._dt}GetDt1(){return this._dt1}GetDtRaw(){return this._dtRaw}GetTimeScale(){return this._timeScale}SetTimeScale(t){(isNaN(t)||t<0)&&(t=0),this._timeScale=t}SetMinDt(t){this._minDt=Math.max(t,0)}GetMinDt(){return this._minDt}SetMaxDt(t){this._maxDt=Math.max(t,0)}GetMaxDt(){return this._maxDt}GetFramesPerSecond(){return this._fps}GetTicksPerSecond(){return this._tps}GetMainThreadTime(){return this._mainThreadTime}GetStartTime(){return this._startTime}GetGameTime(){return this._gameTime.Get()}GetGameTimeRaw(){return this._gameTimeRaw.Get()}GetWallTime(){return this._wallTime.Get()}GetTickCount(){return this._tickCount}GetTickCountNoSave(){return this._tickCountNoSave}GetObjectCount(){return this._objectCount}GetProjectName(){return this._projectName}GetProjectVersion(){return this._projectVersion}GetProjectUniqueId(){return this._projectUniqueId}GetAppId(){return this._appId}GetExportTimestamp(){return this._exportTimestamp}GetInstanceByUID(t){if(this._isLoadingState)throw new Error("cannot call while loading state - wait until afterload event");return this._instancesByUid.get(t)||null}_RemoveInstanceFromUIDMap(t){if(this._isLoadingState)throw new Error("cannot call while loading state - wait until afterload event");this._instancesByUid.delete(t)}_RefreshUidMap(){this._instancesByUid.clear();for(const t of this._allObjectClasses)if(!t.IsFamily())for(const e of t.GetInstances())this._instancesByUid.set(e.GetUID(),e)}IsPreview(){return"preview"===this._exportType}IsDebug(){return this._isDebug}GetExportType(){return this._exportType}IsCordova(){return"cordova"===this._exportType}IsAndroidWebView(){return"Android"===lT.Platform.OS&&("cordova"===this._exportType||"playable-ad-single-file"===this._exportType||"playable-ad-zip"===this._exportType||"instant-games"===this._exportType)}IsiOSCordova(){return this._isiOSCordova}IsiOSWebView(){return this._isiOSWebView}IsWindowsWebView2(){return this._isWindowsWebView2}IsAnyWebView2Wrapper(){return this._isAnyWebView2Wrapper}GetCollisionEngine(){return this._collisionEngine}GetSolidBehavior(){return this._addonManager.GetSolidBehavior()}GetJumpthruBehavior(){return this._addonManager.GetJumpthruBehavior()}Uses3DFeatures(){return this._uses3dFeatures}GetZScaleFactor(){return this.GetRenderer().GetZAxisScaleFactor(this.GetViewportHeight())}GetDefaultCameraZ(t){return this.GetRenderer().GetDefaultCameraZ(t||this.GetViewportHeight())}IsLayoutFirstTick(){return this._isLayoutFirstTick}SetPixelRoundingEnabled(t){t=!!t,this._isPixelRoundingEnabled!==t&&(this._isPixelRoundingEnabled=t,this.GetLayoutManager().SetAllLayerMVChanged(),this.UpdateRender())}IsPixelRoundingEnabled(){return this._isPixelRoundingEnabled}GetTextIconSet(t){if(!this._iconChangeHandlers.has(t)){const e=()=>this.DeleteTextIconSet(t);this._iconChangeHandlers.set(t,e),t.Dispatcher().addEventListener("animationframeimagechange",e)}const e=this._textIconManager.GetIconSet(t);return e.HasLoaded()||e.LoadContent().then(()=>this.UpdateRender()),e}DeleteTextIconSet(t){this._textIconManager.DeleteIconSet(t)}_GetTextIconSetMeta(t){const e=[];for(const s of t.GetAnimations())for(const t of s.GetFrames()){const s=t.GetImageInfo();e.push({source:t,width:s.GetWidth(),height:s.GetHeight(),tag:t.GetTag()})}return{icons:e}}async _GetTextIconSetContent(t){const e=lT.New(lT.PromiseThrottle),s=[],i=new Map;for(const r of t.GetAnimations())for(const t of r.GetFrames()){const r=t.GetImageInfo().GetImageAsset();i.has(r)||(i.set(r,null),s.push(e.Add(async()=>{const t=await r.LoadToDrawable();i.set(r,t)})))}await Promise.all(s);const r=[];for(const s of t.GetAnimations())for(const t of s.GetFrames())r.push(e.Add(async()=>{const e=t.GetImageInfo(),s=i.get(e.GetImageAsset()),r=await e.ExtractImageToCanvas(s);return{drawable:await createImageBitmap(r)}}));const n=await Promise.all(r);for(const t of i.values())t instanceof ImageBitmap&&t.close&&t.close();return{icons:n}}SaveToSlot(t){this._saveToSlotName=t,this._saveToJsonString=!1}SaveToJsonString(){this._saveToSlotName="",this._saveToJsonString=!0}LoadFromSlot(t){this._loadFromSlotName=t}LoadFromJsonString(t){this._loadFromJson=t}GetLastSaveJsonString(){return this._lastSaveJson}_NeedsHandleSaveOrLoad(){return!!(this._saveToSlotName||this._saveToJsonString||this._loadFromSlotName||null!==this._loadFromJson)}async _HandleSaveOrLoad(){if(this._saveToSlotName&&(this.FlushPendingInstances(),await this._DoSaveToSlot(this._saveToSlotName),this._ClearSaveOrLoad()),this._loadFromSlotName&&(await this._DoLoadFromSlot(this._loadFromSlotName),this._ClearSaveOrLoad(),this.IsDebug()&&cT.StepIfPausedInDebugger()),this._saveToJsonString){const t=await this._SaveToJsonString();this._lastSaveJson=t,await this.TriggerAsync(lT.Plugins.System.Cnds.OnSaveComplete,null),this._lastSaveJson="",this._ClearSaveOrLoad()}if(null!==this._loadFromJson){this.FlushPendingInstances();try{await this._DoLoadFromJsonString(this._loadFromJson),this._lastSaveJson=this._loadFromJson,await this.TriggerAsync(lT.Plugins.System.Cnds.OnLoadComplete,null),this._lastSaveJson=""}catch(t){console.error("[Construct] Failed to load state from JSON string: ",t),await this.TriggerAsync(lT.Plugins.System.Cnds.OnLoadFailed,null)}this._ClearSaveOrLoad()}}_ClearSaveOrLoad(){this._saveToSlotName="",this._saveToJsonString=!1,this._loadFromSlotName="",this._loadFromJson=null}_GetProjectStorage(){return this._projectStorage||(this._projectStorage=localforage.createInstance({name:"c3-localstorage-"+this.GetProjectUniqueId(),description:this.GetProjectName()})),this._projectStorage}_GetSavegamesStorage(){return this._savegamesStorage||(this._savegamesStorage=localforage.createInstance({name:"c3-savegames-"+this.GetProjectUniqueId(),description:this.GetProjectName()})),this._savegamesStorage}async _DoSaveToSlot(t){const e=await this._SaveToJsonString();try{await this._GetSavegamesStorage().setItem(t,e),console.log("[Construct] Saved state to storage ("+e.length+" chars)"),this._lastSaveJson=e,await this.TriggerAsync(lT.Plugins.System.Cnds.OnSaveComplete,null),this._lastSaveJson=""}catch(t){console.error("[Construct] Failed to save state to storage: ",t),await this.TriggerAsync(lT.Plugins.System.Cnds.OnSaveFailed,null)}}async _DoLoadFromSlot(t){try{const e=await this._GetSavegamesStorage().getItem(t);if(!e)throw new Error("empty slot");console.log("[Construct] Loaded state from storage ("+e.length+" chars)"),await this._DoLoadFromJsonString(e),this._lastSaveJson=e,await this.TriggerAsync(lT.Plugins.System.Cnds.OnLoadComplete,null),this._lastSaveJson=""}catch(t){console.error("[Construct] Failed to load state from storage: ",t),await this.TriggerAsync(lT.Plugins.System.Cnds.OnLoadFailed,null)}}async _SaveToJsonString(){const t={c3save:!0,version:1,rt:{time:this.GetGameTime(),timeRaw:this.GetGameTimeRaw(),walltime:this.GetWallTime(),timescale:this.GetTimeScale(),tickcount:this.GetTickCount(),next_uid:this._nextUid,running_layout:this.GetMainRunningLayout().GetSID(),start_time_offset:Date.now()-this._startTime},types:{},layouts:{},events:this._eventSheetManager._SaveToJson(),timelines:this._timelineManager._SaveToJson(),user_script_data:null};for(const e of this._allObjectClasses)e.IsFamily()||e.HasNoSaveBehavior()||(t.types[e.GetSID().toString()]=e._SaveToJson());for(const e of this._layoutManager.GetAllLayouts())t.layouts[e.GetSID().toString()]=e._SaveToJson();const e=this._CreateUserScriptEvent("save");return e.saveData=null,await this.DispatchUserScriptEventAsyncWait(e),t.user_script_data=e.saveData,JSON.stringify(t)}IsLoadingState(){return this._isLoadingState}async _DoLoadFromJsonString(t){const e=this.GetLayoutManager(),s=JSON.parse(t);if(s.c2save)throw new Error("C2 saves are incompatible with C3 runtime");if(!s.c3save)throw new Error("not valid C3 save data");if(s.version>1)throw new Error("C3 save data from future version");this.ClearIntancesNeedingAfterLoad(),this._dispatcher.dispatchEvent(lT.New(lT.Event,"beforeload"));for(const t of this.allInstances())t.GetObjectClass().HasNoSaveBehavior()||t._OnBeforeLoad();const i=s.rt;this._gameTime.Set(i.time),i.hasOwnProperty("timeRaw")&&this._gameTimeRaw.Set(i.timeRaw),this._wallTime.Set(i.walltime),this._timeScale=i.timescale,this._tickCount=i.tickcount,this._startTime=Date.now()-i.start_time_offset;const r=i.running_layout;this._isLoadingState=!0;let n=!1;if(r!==this.GetMainRunningLayout().GetSID()){const t=e.GetLayoutBySID(r);if(!t)return;await this._DoChangeLayout(t),n=!0}for(const[t,i]of Object.entries(s.layouts)){const s=parseInt(t,10),r=e.GetLayoutBySID(s);r&&r._LoadFromJson(i)}const a=new Set;for(const[t,e]of Object.entries(s.types)){const s=parseInt(t,10),i=this.GetObjectClassBySID(s);!i||i.IsFamily()||i.HasNoSaveBehavior()||i._LoadFromJson(e,a)}for(const t of this._layoutManager.GetAllLayouts())for(const e of t.allLayers())e._LoadFromJsonAfterInstances();if(this.FlushPendingInstances(),this._RefreshUidMap(),this._isLoadingState=!1,n){for(const t of this.allInstances())t.SetupInitialSceneGraphConnections();for(const[t,e]of Object.entries(s.types)){const s=parseInt(t,10),i=this.GetObjectClassBySID(s);!i||i.IsFamily()||i.HasNoSaveBehavior()||i._SetupSceneGraphConnectionsOnChangeOfLayout(e)}}this._nextUid=i.next_uid,this._eventSheetManager._LoadFromJson(s.events);for(const t of this._allObjectClasses)if(!t.IsFamily()&&t.IsInContainer())for(const e of t.GetInstances()){const s=e.GetIID();e._ClearSiblings();for(const i of t.GetContainer().objectTypes()){if(i===t)continue;const r=i.GetInstances();if(s<0||s>=r.length)throw new Error("missing sibling instance");e._AddSibling(r[s])}}this._timelineManager._LoadFromJson(s.timelines),e.SetAllLayerProjectionChanged(),e.SetAllLayerMVChanged();for(const t of a)t._OnCreatedForLoadingSavegame();this.DoAfterLoad(),this._dispatcher.dispatchEvent(lT.New(lT.Event,"afterload")),this.DispatchUserScriptEvent(this._CreateUserScriptEvent("afterload"));for(const[t,e]of Object.entries(s.types)){const e=parseInt(t,10),s=this.GetObjectClassBySID(e);s&&s._ClearLoadInstancesJson()}const o=this._CreateUserScriptEvent("load");o.saveData=s.user_script_data,await this.DispatchUserScriptEventAsyncWait(o),this.UpdateRender()}SortOnTmpHierarchyPosition(t,e){return e.GetWorldInfo().GetTmpHierarchyPosition()-t.GetWorldInfo().GetTmpHierarchyPosition()}AddInstanceNeedingAfterLoad(t,e){t.GetWorldInfo()&&(this._instancesNeedingAfterLoadMap.has(t)||(this._instancesNeedingAfterLoadMap.set(t,e),this._instancesNeedingAfterLoadArray.push(t)))}ClearIntancesNeedingAfterLoad(){this._instancesNeedingAfterLoadMap=new WeakMap,lT.clearArray(this._instancesNeedingAfterLoadArray),lT.SceneGraphInfo.ClearUpdatedInstances()}DoAfterLoad(t="full",e=null){this._instancesNeedingAfterLoadArray.sort(this.SortOnTmpHierarchyPosition),e||(e={}),e.processedWorldInfo=new Set;const s=this._instancesNeedingAfterLoadArray.length;for(const s of this._instancesNeedingAfterLoadArray)s._OnAfterLoad(this._instancesNeedingAfterLoadMap.get(s),t,e);for(const s of this._instancesNeedingAfterLoadArray)s._OnAfterLoad2(this._instancesNeedingAfterLoadMap.get(s),t,e);if(this.ClearIntancesNeedingAfterLoad(),s){this.FlushPendingInstances(),this._RefreshUidMap();for(const t of this._layoutManager.GetAllLayouts())for(const e of t.allLayers())e._SortInstancesByLastCachedZIndex(),e.SetZIndicesChanged()}}async AddJobWorkerScripts(t){const e=t.map(t=>new URL(t,location.href).toString());this._jobScheduler.ImportScriptsToJobWorkers(e)}AddJobWorkerBlob(t,e){this._jobScheduler.SendBlobToJobWorkers(t,e)}AddJobWorkerBuffer(t,e){this._jobScheduler.SendBufferToJobWorkers(t,e)}AddJob(t,e,s,i){return this._jobScheduler.AddJob(t,e,s,null,null,i)}BroadcastJob(t,e,s,i){return this._jobScheduler.BroadcastJob(t,e,s,i)}GetMaxNumJobWorkers(){return this._jobScheduler.GetMaxNumWorkers()}InvokeDownload(t,e){this.PostComponentMessageToDOM("runtime","invoke-download",{url:t,filename:e})}async RasterSvgImage(t,e,s,i,r,n){if(i=i||e,r=r||s,this.IsInWorker())return(await this.PostComponentMessageToDOMAsync("runtime","raster-svg-image",{blob:t,imageWidth:e,imageHeight:s,surfaceWidth:i,surfaceHeight:r,imageBitmapOpts:n})).imageBitmap;{const a=await self.C3_RasterSvgImageBlob(t,e,s,i,r);return n?await self.createImageBitmap(a,n):a}}async GetSvgImageSize(t){return this.IsInWorker()?await this.PostComponentMessageToDOMAsync("runtime","get-svg-image-size",{blob:t}):await self.C3_GetSvgImageSize(t)}RequestDeviceOrientationEvent(){this._didRequestDeviceOrientationEvent||(this._didRequestDeviceOrientationEvent=!0,this.PostComponentMessageToDOM("runtime","enable-device-orientation"))}RequestDeviceMotionEvent(){this._didRequestDeviceMotionEvent||(this._didRequestDeviceMotionEvent=!0,this.PostComponentMessageToDOM("runtime","enable-device-motion"))}Random(){return this._randomNumberCallback()}SetRandomNumberGeneratorCallback(t){this._randomNumberCallback=t}_GetRemotePreviewStatusInfo(){const t=this.GetRenderer();return{fps:this.GetFramesPerSecond(),tps:this.GetTicksPerSecond(),cpu:this.GetMainThreadTime(),gpu:this.GetGPUUtilisation(),layout:this.GetMainRunningLayout()?this.GetMainRunningLayout().GetName():"",renderer:t.IsWebGL()?t.GetUnmaskedRenderer():t.GetAdapterInfoString()}}HitBreakpoint(){return!!this.IsDebug()&&cT.HitBreakpoint()}DebugBreak(t){return this.IsDebugging()?cT.DebugBreak(t):Promise.resolve()}DebugBreakNext(){return!!this.IsDebugging()&&cT.BreakNext()}SetDebugBreakpointsEnabled(t){this._breakpointsEnabled=!!t,this._UpdateDebuggingFlag()}AreDebugBreakpointsEnabled(){return this._breakpointsEnabled}IsDebugging(){return this._isDebugging}SetDebuggingEnabled(t){t?this._debuggingDisabled--:this._debuggingDisabled++,this._UpdateDebuggingFlag()}_UpdateDebuggingFlag(){this._isDebugging=this.IsDebug()&&this._breakpointsEnabled&&0===this._debuggingDisabled}IsCPUProfiling(){return this.IsDebug()&&cT.IsCPUProfiling()}IsGPUProfiling(){return this.IsDebug()&&this.GetRenderer().SupportsGPUProfiling()&&cT.IsGPUProfiling()}async DebugIterateAndBreak(t){if(t)for(const e of t)await this.DebugBreak(e)}DebugFireGeneratorEventAndBreak(t){return this.DebugIterateAndBreak(this._dispatcher.dispatchGeneratorEvent(t))}_InvokeFunctionFromJS(t){return this._eventSheetManager._InvokeFunctionFromJS(t.name,t.params)}_GetHTMLLayerWrapElement(t){if(this.IsInWorker())throw new Error("not supported in worker mode");return self.c3_runtimeInterface._GetHTMLWrapElement(t)}GetIRuntime(){return this._iRuntime}GetConstructVersionCode(){return this._constructVersionCode}_CreateUserScriptEvent(t){const e=lT.New(lT.Event,t,!1);return e.runtime=this._iRuntime,e}_InitScriptInterfaces(){this._iRuntime=new self.IRuntime(this),this._userScriptEventObjects={pretick:this._CreateUserScriptEvent("pretick"),tick:this._CreateUserScriptEvent("tick"),tick2:this._CreateUserScriptEvent("tick2")}}_InitObjectsScriptInterface(){const t={};for(const e of this._allObjectClasses)t[e.GetJsPropName()]={value:e.GetIObjectClass(),enumerable:!0,writable:!1};this._iRuntime._InitObjects(t)}_InitGlobalVariableScriptInterface(){const t={};for(const e of this.GetEventSheetManager().GetAllGlobalVariables())t[e.GetJsPropName()]=e._GetScriptInterfaceDescriptor();this._iRuntime._InitGlobalVars(t)}_GetCommonScriptInterfaces(){return this._commonScriptInterfaces}_MapScriptInterface(t,e){this._interfaceMap.set(t,e)}_UnwrapScriptInterface(t){return this._interfaceMap.get(t)}_UnwrapIObjectClass(t){if(!(t instanceof self.IObjectClass))throw new TypeError("expected IObjectClass");const e=this._UnwrapScriptInterface(t);if(!(e&&e instanceof lT.ObjectClass))throw new Error("invalid IObjectClass");return e}_UnwrapIInstance(t){if(!(t instanceof self.IInstance))throw new TypeError("expected IInstance");const e=this._UnwrapScriptInterface(t);if(!(e&&e instanceof lT.Instance))throw new Error("invalid IInstance");return e}_UnwrapIWorldInstance(t){if(!(t instanceof self.IWorldInstance))throw new TypeError("expected IWorldInstance");const e=this._UnwrapScriptInterface(t);if(!(e&&e instanceof lT.Instance))throw new Error("invalid IInstance");return e}},self.C3_CreateRuntime=lT.Runtime.Create,self.C3_InitRuntime=(t,e)=>t.Init(e)}{const pT=self.C3;pT.JobSchedulerRuntime=class extends pT.DefendedBase{constructor(t,e){super(),this._runtime=t,this._jobPromises=new Map,this._nextJobId=0,this._inputPort=e.inputPort,e.outputPort.onmessage=t=>this._OnJobWorkerMessage(t),this._maxNumWorkers=e.maxNumWorkers,this._jobWorkerCount=1,this._isCreatingWorker=!1,this._hadErrorCreatingWorker=!1}GetMaxNumWorkers(){return this._maxNumWorkers}ImportScriptsToJobWorkers(t){this._inputPort.postMessage({type:"_import_scripts",scripts:t})}SendBlobToJobWorkers(t,e){this._inputPort.postMessage({type:"_send_blob",blob:t,id:e})}SendBufferToJobWorkers(t,e){this._inputPort.postMessage({type:"_send_buffer",buffer:t,id:e},[t])}AddJob(t,e,s,i,r,n){if(s||(s=[]),"number"==typeof n&&(n=Math.floor(n))<=0)throw new Error("invalid maxWorkerNum");const a=this._nextJobId++,o={type:t,isBroadcast:!1,maxWorkerNum:n,jobId:a,params:e,transferables:s},h=new Promise((t,e)=>{this._jobPromises.set(a,{resolve:t,progress:i,reject:e,cancelled:!1,maxWorkerNum:n})});return r&&r.SetAction(()=>this._CancelJob(a)),this._inputPort.postMessage(o,s),this._MaybeCreateExtraWorker(),h}BroadcastJob(t,e,s,i){if(s||(s=[]),"number"==typeof i&&(i=Math.floor(i))<=0)throw new Error("invalid maxWorkerNum");const r={type:t,isBroadcast:!0,maxWorkerNum:i,jobId:this._nextJobId++,params:e,transferables:s};this._inputPort.postMessage(r,s)}_CancelJob(t){const e=this._jobPromises.get(t);e&&(e.cancelled=!0,e.resolve=null,e.progress=null,e.reject=null,this._inputPort.postMessage({type:"_cancel",jobId:t}))}_OnJobWorkerMessage(t){const e=t.data,s=e.type,i=e.jobId;switch(s){case"result":this._OnJobResult(i,e.result);break;case"progress":this._OnJobProgress(i,e.progress);break;case"error":this._OnJobError(i,e.error);break;case"ready":this._OnJobWorkerReady();break;default:throw new Error(`unknown message from worker '${s}'`)}}_OnJobResult(t,e){const s=this._jobPromises.get(t);if(!s)throw new Error("invalid job ID");s.cancelled||s.resolve(e),this._jobPromises.delete(t)}_OnJobProgress(t,e){const s=this._jobPromises.get(t);if(!s)throw new Error("invalid job ID");!s.cancelled&&s.progress&&s.progress(e)}_OnJobError(t,e){const s=this._jobPromises.get(t);if(!s)throw new Error("invalid job ID");s.cancelled||s.reject(e),this._jobPromises.delete(t)}_OnJobWorkerReady(){this._isCreatingWorker&&(this._isCreatingWorker=!1,this._jobWorkerCount++,this._jobWorkerCount<this._maxNumWorkers?this._MaybeCreateExtraWorker():this._inputPort.postMessage({type:"_no_more_workers"}))}_GetWorkerCountNeededForPendingJobs(){let t=0;const e=[...this._jobPromises.values()].sort((t,e)=>(t.maxWorkerNum||1/0)-(e.maxWorkerNum||1/0));for(const s of e)t<(s.maxWorkerNum||1/0)&&t++;return t}async _MaybeCreateExtraWorker(){if(!(this._jobWorkerCount>=this._maxNumWorkers||this._isCreatingWorker||this._hadErrorCreatingWorker||this._GetWorkerCountNeededForPendingJobs()<=this._jobWorkerCount))try{this._isCreatingWorker=!0,(await this._runtime.PostComponentMessageToDOMAsync("runtime","create-job-worker")).outputPort.onmessage=t=>this._OnJobWorkerMessage(t)}catch(t){this._hadErrorCreatingWorker=!0,this._isCreatingWorker=!1,console.error(`[Construct] Failed to create job worker; stopping creating any more (created ${this._jobWorkerCount} so far)`,t)}}}}self.C3_Shaders={};{let fT=function(t,e){const s=t[1],i=e[1];if("number"==typeof s&&"number"==typeof i)return s-i;{const t=""+s,e=""+i;return t<e?-1:t>e?1:0}};0;const gT=self.C3;let mT=null,ST="",yT="",GT=[],TT="",IT="",CT="";const bT=gT.New(gT.ArrayStack);gT.Plugins.System=class extends gT.SDKPluginBase{constructor(t){super(t),this._loopStack=this._runtime.GetEventSheetManager().GetLoopStack(),this._eventStack=this._runtime.GetEventSheetManager().GetEventStack(),this._imagesLoadingTotal=0,this._imagesLoadingComplete=0,this._functionMaps=new Map}Release(){super.Release()}UpdateRender(){this._runtime.UpdateRender()}Trigger(t){this._runtime.Trigger(t,null,null)}GetRegex(t,e){return mT&&t===ST&&e===yT||(mT=new RegExp(t,e),ST=t,yT=e),mT.lastIndex=0,mT}GetRegexMatches(t,e,s){if(t===TT&&e===IT&&s===CT)return GT;const i=this.GetRegex(e,s);return GT=t.match(i),TT=t,IT=e,CT=s,GT}async _LoadTexturesForObjectClasses(t,e){if(!e.length)return;this._imagesLoadingTotal+=e.length;const s=[];for(const i of e)s.push(t.MaybeLoadTexturesFor(i));await gT.PromiseAllWithProgress(s,()=>{this._imagesLoadingComplete++}),this._imagesLoadingComplete++,this._imagesLoadingComplete===this._imagesLoadingTotal&&(this._imagesLoadingComplete=0,this._imagesLoadingTotal=0,this._runtime.Trigger(gT.Plugins.System.Cnds.OnImageLoadingComplete,null,null))}GetImageLoadingProgress(){return 0===this._imagesLoadingTotal?1:this._imagesLoadingComplete/this._imagesLoadingTotal}_UnloadTexturesForObjectClasses(t,e){for(const s of e)0===s.GetInstanceCount()&&t.MaybeUnloadTexturesFor(s)}_GetForEachStack(){return bT}_Repeat(t){const e=this._runtime.GetEventSheetManager(),s=e.GetEventStack(),i=s.GetCurrentStackFrame(),r=i.GetCurrentEvent(),n=r.GetSolModifiers(),a=i.IsSolModifierAfterCnds(),o=s.Push(r),h=e.GetLoopStack(),l=h.Push();if(l.SetEnd(t),a)for(let s=0;s<t&&!l.IsStopped();++s)e.PushCopySol(n),l.SetIndex(s),r.Retrigger(i,o),e.PopSol(n);else for(let e=0;e<t&&!l.IsStopped();++e)l.SetIndex(e),r.Retrigger(i,o);return s.Pop(),h.Pop(),!1}*_DebugRepeat(t){const e=this._runtime.GetEventSheetManager(),s=e.GetEventStack(),i=s.GetCurrentStackFrame(),r=i.GetCurrentEvent(),n=r.GetSolModifiers(),a=i.IsSolModifierAfterCnds(),o=s.Push(r),h=e.GetLoopStack(),l=h.Push();if(l.SetEnd(t),a)for(let s=0;s<t&&!l.IsStopped();++s)e.PushCopySol(n),l.SetIndex(s),yield*r.DebugRetrigger(i,o),e.PopSol(n);else for(let e=0;e<t&&!l.IsStopped();++e)l.SetIndex(e),yield*r.DebugRetrigger(i,o);return s.Pop(),h.Pop(),!1}_While(){const t=this._runtime.GetEventSheetManager(),e=t.GetEventStack(),s=e.GetCurrentStackFrame(),i=s.GetCurrentEvent(),r=i.GetSolModifiers(),n=s.IsSolModifierAfterCnds(),a=e.Push(i),o=t.GetLoopStack(),h=o.Push();if(n)for(let e=0;!h.IsStopped();++e)t.PushCopySol(r),h.SetIndex(e),i.Retrigger(s,a)||h.Stop(),t.PopSol(r);else for(let t=0;!h.IsStopped();++t)h.SetIndex(t),i.Retrigger(s,a)||h.Stop();return e.Pop(),o.Pop(),!1}*_DebugWhile(){const t=this._runtime.GetEventSheetManager(),e=t.GetEventStack(),s=e.GetCurrentStackFrame(),i=s.GetCurrentEvent(),r=i.GetSolModifiers(),n=s.IsSolModifierAfterCnds(),a=e.Push(i),o=t.GetLoopStack(),h=o.Push();if(n)for(let e=0;!h.IsStopped();++e)t.PushCopySol(r),h.SetIndex(e),(yield*i.DebugRetrigger(s,a))||h.Stop(),t.PopSol(r);else for(let t=0;!h.IsStopped();++t)h.SetIndex(t),(yield*i.DebugRetrigger(s,a))||h.Stop();return e.Pop(),o.Pop(),!1}_For(t,e,s){const i=this._runtime.GetEventSheetManager(),r=i.GetEventStack(),n=r.GetCurrentStackFrame(),a=n.GetCurrentEvent(),o=a.GetSolModifiers(),h=n.IsSolModifierAfterCnds(),l=r.Push(a),c=i.GetLoopStack(),u=c.Push();if(u.SetName(t),u.SetEnd(s),s<e)if(h)for(let t=e;t>=s&&!u.IsStopped();--t)i.PushCopySol(o),u.SetIndex(t),a.Retrigger(n,l),i.PopSol(o);else for(let t=e;t>=s&&!u.IsStopped();--t)u.SetIndex(t),a.Retrigger(n,l);else if(h)for(let t=e;t<=s&&!u.IsStopped();++t)i.PushCopySol(o),u.SetIndex(t),a.Retrigger(n,l),i.PopSol(o);else for(let t=e;t<=s&&!u.IsStopped();++t)u.SetIndex(t),a.Retrigger(n,l);return r.Pop(),c.Pop(),!1}*_DebugFor(t,e,s){const i=this._runtime.GetEventSheetManager(),r=i.GetEventStack(),n=r.GetCurrentStackFrame(),a=n.GetCurrentEvent(),o=a.GetSolModifiers(),h=n.IsSolModifierAfterCnds(),l=r.Push(a),c=i.GetLoopStack(),u=c.Push();if(u.SetName(t),u.SetEnd(s),s<e)if(h)for(let t=e;t>=s&&!u.IsStopped();--t)i.PushCopySol(o),u.SetIndex(t),yield*a.DebugRetrigger(n,l),i.PopSol(o);else for(let t=e;t>=s&&!u.IsStopped();--t)u.SetIndex(t),yield*a.DebugRetrigger(n,l);else if(h)for(let t=e;t<=s&&!u.IsStopped();++t)i.PushCopySol(o),u.SetIndex(t),yield*a.DebugRetrigger(n,l),i.PopSol(o);else for(let t=e;t<=s&&!u.IsStopped();++t)u.SetIndex(t),yield*a.DebugRetrigger(n,l);return r.Pop(),c.Pop(),!1}_ForEach(t){const e=t.GetCurrentSol(),s=e.GetInstances();if(0===s.length)return!1;const i=this._runtime.GetEventSheetManager(),r=i.GetEventStack(),n=r.GetCurrentStackFrame(),a=n.GetCurrentEvent(),o=a.GetSolModifiers(),h=n.IsSolModifierAfterCnds(),l=r.Push(a),c=i.GetLoopStack(),u=c.Push(),_=t.IsInContainer(),d=bT.Push();if(gT.shallowAssignArray(d,s),u.SetEnd(d.length),h)for(let e=0,s=d.length;e<s&&!u.IsStopped();++e){i.PushCopySol(o);const s=d[e];t.GetCurrentSol().SetSinglePicked(s),_&&s.SetSiblingsSinglePicked(),u.SetIndex(e),a.Retrigger(n,l),i.PopSol(o)}else{e._SetSelectAll(!1);const t=e._GetOwnInstances();gT.clearArray(t),t.push(null);for(let e=0,s=d.length;e<s&&!u.IsStopped();++e){const s=d[e];t[0]=s,_&&s.SetSiblingsSinglePicked(),u.SetIndex(e),a.Retrigger(n,l)}}return r.Pop(),c.Pop(),gT.clearArray(d),bT.Pop(),!1}*_DebugForEach(t){const e=t.GetCurrentSol(),s=e.GetInstances();if(0===s.length)return!1;const i=this._runtime.GetEventSheetManager(),r=i.GetEventStack(),n=r.GetCurrentStackFrame(),a=n.GetCurrentEvent(),o=a.GetSolModifiers(),h=n.IsSolModifierAfterCnds(),l=r.Push(a),c=i.GetLoopStack(),u=c.Push(),_=t.IsInContainer(),d=bT.Push();if(gT.shallowAssignArray(d,s),u.SetEnd(d.length),h)for(let e=0,s=d.length;e<s&&!u.IsStopped();++e){i.PushCopySol(o);const s=d[e];t.GetCurrentSol().SetSinglePicked(s),_&&s.SetSiblingsSinglePicked(),u.SetIndex(e),yield*a.DebugRetrigger(n,l),i.PopSol(o)}else{e._SetSelectAll(!1);const t=e._GetOwnInstances();gT.clearArray(t),t.push(null);for(let e=0,s=d.length;e<s&&!u.IsStopped();++e){const s=d[e];t[0]=s,_&&s.SetSiblingsSinglePicked(),u.SetIndex(e),yield*a.DebugRetrigger(n,l)}}return r.Pop(),c.Pop(),gT.clearArray(d),bT.Pop(),!1}_ForEachOrdered(t,e){const s=t.GetCurrentSol(),i=s.GetInstances();if(0===i.length)return!1;const r=this._runtime.GetEventSheetManager(),n=r.GetEventStack(),a=r.GetCurrentCondition(),o=n.GetCurrentStackFrame(),h=o.GetCurrentEvent(),l=h.GetSolModifiers(),c=o.IsSolModifierAfterCnds(),u=n.Push(h),_=r.GetLoopStack(),d=_.Push(),p=t.IsInContainer(),f=bT.Push();gT.clearArray(f),d.SetEnd(i.length);for(let t=0,e=i.length;t<e;++t)f.push([i[t],a.ReevaluateParameter(1,t)]);if(f.sort(fT),1===e&&f.reverse(),c)for(let e=0,s=f.length;e<s&&!d.IsStopped();++e){r.PushCopySol(l);const s=f[e][0];t.GetCurrentSol().SetSinglePicked(s),p&&s.SetSiblingsSinglePicked(),d.SetIndex(e),h.Retrigger(o,u),r.PopSol(l)}else{s._SetSelectAll(!1);const t=s._GetOwnInstances();gT.clearArray(t),t.push(null);for(let e=0,s=f.length;e<s&&!d.IsStopped();++e){const s=f[e][0];t[0]=s,p&&s.SetSiblingsSinglePicked(),d.SetIndex(e),h.Retrigger(o,u)}}return n.Pop(),_.Pop(),gT.clearArray(f),bT.Pop(),!1}*_DebugForEachOrdered(t,e){const s=t.GetCurrentSol(),i=s.GetInstances();if(0===i.length)return!1;const r=this._runtime.GetEventSheetManager(),n=r.GetEventStack(),a=r.GetCurrentCondition(),o=n.GetCurrentStackFrame(),h=o.GetCurrentEvent(),l=h.GetSolModifiers(),c=o.IsSolModifierAfterCnds(),u=n.Push(h),_=r.GetLoopStack(),d=_.Push(),p=t.IsInContainer(),f=bT.Push();gT.clearArray(f),d.SetEnd(i.length);for(let t=0,e=i.length;t<e;++t)f.push([i[t],a.ReevaluateParameter(1,t)]);if(f.sort(fT),1===e&&f.reverse(),c)for(let e=0,s=f.length;e<s&&!d.IsStopped();++e){r.PushCopySol(l);const s=f[e][0];t.GetCurrentSol().SetSinglePicked(s),p&&s.SetSiblingsSinglePicked(),d.SetIndex(e),yield*h.DebugRetrigger(o,u),r.PopSol(l)}else{s._SetSelectAll(!1);const t=s._GetOwnInstances();gT.clearArray(t),t.push(null);for(let e=0,s=f.length;e<s&&!d.IsStopped();++e){const s=f[e][0];t[0]=s,p&&s.SetSiblingsSinglePicked(),d.SetIndex(e),yield*h.DebugRetrigger(o,u)}}return n.Pop(),_.Pop(),gT.clearArray(f),bT.Pop(),!1}_GetFunctionMap(t,e){let s=this._functionMaps.get(t);return s||(e?(s={defaultFunc:null,strMap:new Map},this._functionMaps.set(t,s),s):null)}_DoCallMappedFunction(t,e,s,i,r){e.GetEventBlock().RunAsMappedFunctionCall(s,e.IsCopyPicked()),i&&t.PopSol(r)}*_DebugDoCallMappedFunction(t,e,s,i,r){yield*e.GetEventBlock().DebugRunAsMappedFunctionCall(s,e.IsCopyPicked()),i&&t.PopSol(r)}}}{const xT=self.C3;xT.Plugins.System.Type=class extends xT.DefendedBase{constructor(t){super(),this._objectClass=t,this._runtime=t.GetRuntime(),this._plugin=t.GetPlugin()}OnCreate(){}Release(){this._objectClass=null,this._runtime=null,this._plugin=null}}}{const wT=self.C3;wT.Plugins.System.Instance=class extends wT.DefendedBase{constructor(t,e){super(),this._inst=t,this._objectClass=this._inst.GetObjectClass(),this._sdkType=this._objectClass.GetSdkType(),this._runtime=this._inst.GetRuntime()}Release(){this._inst=null,this._objectClass=null,this._sdkType=null,this._runtime=null}}}{const MT=self.C3,PT=[];MT.Plugins.System.Cnds={EveryTick:()=>!0,OnLayoutStart:()=>!0,OnLayoutEnd:()=>!0,OnSuspend:()=>!0,OnResume:()=>!0,IsSuspended(){return this._runtime.IsSuspended()},Else(){const t=this._runtime.GetCurrentEventStackFrame();return!t.GetElseBranchRan()&&!t.GetLastEventTrue()},TriggerOnce(){const t=this._runtime.GetCurrentCondition().GetSavedDataMap();let e=t.get("TriggerOnce_lastTick");void 0===e&&(e=-1,t.set("TriggerOnce_lastTick",-1));const s=this._runtime.GetTickCount();return t.set("TriggerOnce_lastTick",s),this._runtime.IsLayoutFirstTick()||e!==s-1},Every(t){const e=this._runtime.GetCurrentCondition().GetSavedDataMap(),s=e.get("Every_lastTime")||0,i=this._runtime.GetGameTime();e.has("Every_seconds")||e.set("Every_seconds",t);const r=e.get("Every_seconds");return i>=s+r?(e.set("Every_lastTime",s+r),i>=e.get("Every_lastTime")+.04&&e.set("Every_lastTime",i),e.set("Every_seconds",t),!0):(i<s-.1&&e.set("Every_lastTime",i),!1)},IsGroupActive(t){const e=this._runtime.GetEventSheetManager().GetEventGroupByName(t);return e&&e.IsGroupActive()},IsPreview(){return this._runtime.IsPreview()},IsMobile:()=>MT.Platform.IsMobile,OnLoadFinished:()=>!0,OnCanvasSnapshot:()=>!0,EffectsSupported:()=>!0,OnSaveComplete:()=>!0,OnSaveFailed:()=>!0,OnLoadComplete:()=>!0,OnLoadFailed:()=>!0,ObjectUIDExists(t){return!!this._runtime.GetInstanceByUID(t)},IsOnPlatform(t){switch(t){case 0:return"browser"===MT.Platform.Context;case 1:return"iOS"===MT.Platform.OS;case 2:return"Android"===MT.Platform.OS;case 8:return"cordova"===MT.Platform.Context;case 9:return"scirra-arcade"===this._runtime.GetExportType();case 13:return"windows-uwp"===this._runtime.GetExportType();default:return!1}},RegexTest(t,e,s){return this.GetRegex(e,s).test(t)},Compare:(t,e,s)=>MT.compare(t,e,s),CompareBetween:(t,e,s)=>t>=e&&t<=s,CompareVar:(t,e,s)=>MT.compare(t.GetValue(),e,s),CompareBoolVar:t=>!!t.GetValue(),CompareTime(t,e){const s=this._runtime.GetGameTime();if(0===t){const t=this._runtime.GetCurrentCondition().GetSavedDataMap();return!t.get("CompareTime_executed")&&s>=e&&(t.set("CompareTime_executed",!0),!0)}return MT.compare(s,t,e)},IsNaN:t=>isNaN(t),AngleWithin:(t,e,s)=>MT.angleDiff(MT.toRadians(t),MT.toRadians(s))<=MT.toRadians(e),IsClockwiseFrom:(t,e)=>MT.angleClockwise(MT.toRadians(t),MT.toRadians(e)),IsBetweenAngles(t,e,s){let i=MT.toRadians(t),r=MT.toRadians(e),n=MT.toRadians(s);return MT.angleClockwise(n,r)?MT.angleClockwise(i,r)&&!MT.angleClockwise(i,n):!(!MT.angleClockwise(i,r)&&MT.angleClockwise(i,n))},IsValueType:(t,e)=>"number"==typeof t?0===e:1===e,EvaluateExpression:t=>!!t,OnSignal(t){return t.toLowerCase()===this._runtime.GetEventSheetManager().GetCurrentSignalTag()},PickByComparison(t,e,s,i){if(!t)return!1;const r=this._GetForEachStack(),n=r.Push(),a=t.GetCurrentSol();MT.shallowAssignArray(n,a.GetInstances()),a.IsSelectAll()&&MT.clearArray(a._GetOwnElseInstances());const o=this._runtime.GetCurrentCondition();let h=0;for(let t=0,r=n.length;t<r;++t){const r=n[t];n[h]=r,e=o.ReevaluateParameter(1,t),i=o.ReevaluateParameter(3,t),MT.compare(e,s,i)?++h:a._PushElseInstance(r)}MT.truncateArray(n,h),a.SetArrayPicked(n);const l=!!n.length;return MT.clearArray(n),r.Pop(),t.ApplySolToContainer(),l},PickByEvaluate(t,e){if(!t)return!1;const s=this._GetForEachStack(),i=s.Push(),r=t.GetCurrentSol();MT.shallowAssignArray(i,r.GetInstances()),r.IsSelectAll()&&MT.clearArray(r._GetOwnElseInstances());const n=this._runtime.GetCurrentCondition();let a=0;for(let t=0,e=i.length;t<e;++t){const e=i[t];i[a]=e,n.ReevaluateParameter(1,t)?++a:r._PushElseInstance(e)}MT.truncateArray(i,a),r.SetArrayPicked(i);const o=!!i.length;return MT.clearArray(i),s.Pop(),t.ApplySolToContainer(),o},PickByHighestLowestValue(t,e,s){if(!t)return!1;const i=t.GetCurrentSol(),r=i.GetInstances();if(0===r.length)return!1;const n=this._runtime.GetCurrentCondition();let a=null,o=0;for(let t=0,i=r.length;t<i;++t){const i=r[t];s=n.ReevaluateParameter(2,t),(null===a||0===e&&s<o||1===e&&s>o)&&(o=s,a=i)}return i.PickOne(a),t.ApplySolToContainer(),!0},PickNth(t,e){if(!t)return!1;const s=t.GetCurrentSol(),i=s.GetInstances();if((e=Math.floor(e))>=i.length)return!1;const r=i[e];return s.PickOne(r),t.ApplySolToContainer(),!0},PickRandom(t){if(!t)return!1;const e=t.GetCurrentSol(),s=e.GetInstances(),i=Math.floor(this._runtime.Random()*s.length);if(i>=s.length)return!1;const r=s[i];return e.PickOne(r),t.ApplySolToContainer(),!0},PickAll:t=>!!t&&(!!t.GetInstanceCount()&&(t.GetCurrentSol()._SetSelectAll(!0),t.ApplySolToContainer(),!0)),PickOverlappingPoint(t,e,s){if(!t)return!1;const i=t.GetCurrentSol(),r=i.GetInstances(),n=this._runtime.GetCurrentEvent().IsOrBlock(),a=this._runtime.GetCurrentCondition().IsInverted();i.IsSelectAll()?(MT.shallowAssignArray(PT,r),i.ClearArrays(),i._SetSelectAll(!1)):n?(MT.shallowAssignArray(PT,i._GetOwnElseInstances()),MT.clearArray(i._GetOwnElseInstances())):(MT.shallowAssignArray(PT,i._GetOwnInstances()),MT.clearArray(i._GetOwnInstances()));for(let t=0,r=PT.length;t<r;++t){const r=PT[t];MT.xor(r.GetWorldInfo().ContainsPoint(e,s),a)?i._PushInstance(r):i._PushElseInstance(r)}return t.ApplySolToContainer(),MT.xor(!!i._GetOwnInstances().length,a)},PickLastCreated(t){if(!t)return!1;const e=t.IsFamily();let s=null;const i=this._runtime._GetInstancesPendingCreate();for(let r=i.length-1;r>=0;--r){const n=i[r];if(e){if(n.GetObjectClass().BelongsToFamily(t)){s=n;break}}else if(n.GetObjectClass()===t){s=n;break}}if(!s){const e=t.GetInstances();e.length&&(s=e.at(-1))}return!!s&&(t.GetCurrentSol().PickOne(s),t.ApplySolToContainer(),!0)},Repeat(t){return this._runtime.IsDebugging()?this._DebugRepeat(t):this._Repeat(t)},While(){return this._runtime.IsDebugging()?this._DebugWhile():this._While()},For(t,e,s){return this._runtime.IsDebugging()?this._DebugFor(t,e,s):this._For(t,e,s)},ForEach(t){return this._runtime.IsDebugging()?this._DebugForEach(t):this._ForEach(t)},ForEachOrdered(t,e,s){return this._runtime.IsDebugging()?this._DebugForEachOrdered(t,s):this._ForEachOrdered(t,s)},LayerVisible:t=>!!t&&t.IsVisible(),LayerInteractive:t=>!!t&&t.IsSelfAndParentsInteractive(),LayerIsHTML:t=>!!t&&t.IsHTMLElementsLayer(),LayerEmpty:t=>!!t&&!t.GetInstanceCount(),LayerCmpOpacity:(t,e,s)=>!!t&&MT.compare(100*t.GetOpacity(),e,s),LayerNameExists(t){const e=this._runtime.GetMainRunningLayout();return!!e&&e.HasLayerByName(t)},OnImageLoadingComplete:()=>!0,IsLoadingImages(){return this._imagesLoadingTotal>0},TemplateExists(t,e){const s=this._runtime.GetTemplateManager();return!!s&&!!e&&!!s.GetTemplateData(t,e)}}}{let vT=function(t,e){const s=t[0]-e[0];return 0!==s?s:t[1]-e[1]},RT=function(t,e){return t[1]-e[1]};0;const AT=self.C3,DT=[],ET=[],FT=AT.New(AT.Rect),OT=AT.New(AT.Color),BT=[];AT.Plugins.System.Acts={SetVar(t,e){t.SetValue(e)},AddVar(t,e){t.IsNumber()&&"number"!=typeof e&&(e=parseFloat(e)),t.SetValue(t.GetValue()+e)},SubVar(t,e){t.IsNumber()&&t.SetValue(t.GetValue()-e)},SetBoolVar(t,e){t.SetValue(!!e)},ToggleBoolVar(t){t.SetValue(!t.GetValue())},ResetEventVar(t){t.SetValue(t.GetInitialValue())},ResetGlobals(t){this._runtime.GetEventSheetManager().ResetAllGlobalsToInitialValue(t)},CreateObject(t,e,s,i,r,n){if(!t||!e)return;const a=this._runtime.CreateInstance(t,e,s,i,r,n);if(!a)return;r&&e.SortAndAddInstancesByZIndex(a);const o=this._runtime.GetEventSheetManager();o.BlockFlushingInstances(!0),a._TriggerOnCreatedOnSelfAndRelated(),o.BlockFlushingInstances(!1);const h=new Map;a.CollectInstancesToPick(h,t,r);for(const[t,e]of h)t.GetCurrentSol().SetSetPicked(e)},CreateObjectByName(t,e,s,i,r,n){if(!t||!e)return;const a=this._runtime.GetObjectClassByName(t);a&&AT.Plugins.System.Acts.CreateObject.call(this,a,e,s,i,r,n)},RecreateInitialObjects(t,e,s,i,r,n,a,o,h,l,c){if(!t)return;const u=this._runtime.GetCurrentLayout();let _=u;if(n){const t=this._runtime.GetLayoutManager().GetLayoutByName(n);if(!t)return;_=t}let d=null;if(("number"!=typeof a||a>=0)&&(d=_.GetLayer(a),!d))return;let p=null;if(("number"!=typeof o||o>=0)&&(p=u.GetLayer(o),!p))return;FT.set(e,s,i,r);const f=_.RecreateInitialObjects(t,FT,d,p,h,l,c);t.GetCurrentSol().SetArrayPicked(f),t.ApplySolToContainer()},StopLoop(){const t=this._loopStack;t.IsInLoop()&&t.GetCurrent().Stop()},SetGroupActive(t,e){const s=this._runtime.GetEventSheetManager().GetEventGroupByName(t);s&&(0===e?s.SetGroupActive(!1):1===e?s.SetGroupActive(!0):s.SetGroupActive(!s.IsGroupActive()))},SetTimescale(t){this._runtime.SetTimeScale(t)},SetObjectTimescale(t,e){if(e<0&&(e=0),!t)return;const s=t.GetCurrentSol().GetInstances();for(const t of s)t.SetTimeScale(e)},RestoreObjectTimescale(t){if(!t)return;const e=t.GetCurrentSol().GetInstances();for(const t of e)t.RestoreTimeScale()},Wait(t,e){if(t<0)return;const s=this._runtime.GetEventSheetManager().AddScheduledWait();return e?s.InitTimer(t):s.InitWallTimer(t),!0},WaitForSignal(t){return this._runtime.GetEventSheetManager().AddScheduledWait().InitSignal(t),!0},WaitForPreviousActions(){const t=this._runtime.GetEventSheetManager();return t.AddScheduledWait().InitPromise(t.GetPromiseForAllAsyncActions()),!0},Signal(t){this._runtime.GetEventSheetManager().Signal(t)},async SnapshotCanvas(t,e,s,i,r,n){const a=this._runtime.GetCanvasManager();a&&(this.UpdateRender(),await a.SnapshotCanvas(0===t?"image/png":"image/jpeg",e/100,s,i,r,n),await this._runtime.TriggerAsync(AT.Plugins.System.Cnds.OnCanvasSnapshot,null))},SetCanvasSize(t,e){if(t<=0||e<=0)return;this._runtime.SetViewportSize(t,e),this._runtime.GetCurrentLayout().BoundScrolling();const s=this._runtime.GetCanvasManager();s&&("off"===s.GetCurrentFullscreenMode()||this._runtime.SetOriginalViewportSize(t,e),s.SetSize(s.GetLastWidth(),s.GetLastHeight(),!0),this._runtime.UpdateRender())},SetFullscreenQuality(t){const e=this._runtime.GetCanvasManager();e&&"off"!==e.GetCurrentFullscreenMode()&&(e.SetFullscreenScalingQuality(0!==t?"high":"low"),e.SetSize(e.GetLastWidth(),e.GetLastHeight(),!0))},SaveState(t){this._runtime.SaveToSlot(t)},SaveStateJSON(){this._runtime.SaveToJsonString()},LoadState(t){this._runtime.LoadFromSlot(t)},LoadStateJSON(t){this._runtime.LoadFromJsonString(t)},SetHalfFramerateMode(t){},ResetPersisted(){for(const t of this._runtime.GetLayoutManager().GetAllLayouts())t.ResetPersistData()},SetPixelRounding(t){this._runtime.SetPixelRoundingEnabled(0!==t)},SetFramerateMinMax(t,e){this._runtime.SetMaxDt(1/t),this._runtime.SetMinDt(1/e)},SetDeltaTimeMinMax(t,e){this._runtime.SetMinDt(t),this._runtime.SetMaxDt(e)},SetFramerateMode(t){this._runtime._SetFramerateMode(["vsync","unlimited-tick","unlimited-frame"][t])},SortZOrderByInstVar(t,e){if(!t)return;const s=t.GetCurrentSol().GetInstances(),i=DT,r=ET,n=this._runtime.GetCurrentLayout(),a=t.IsFamily(),o=t.GetFamilyIndex();for(let t=0,n=s.length;t<n;++t){const n=s[t],h=n.GetWorldInfo();if(!h||h.IsDestroyed())continue;let l;l=a?n.GetInstanceVariableValue(e+n.GetObjectClass().GetFamilyInstanceVariableOffset(o)):n.GetInstanceVariableValue(e),i.push([h.GetLayer().GetIndex(),h.GetZIndex()]),r.push([n,l])}if(!i.length)return;i.sort(vT),r.sort(RT);let h=!1;for(let t=0,e=i.length;t<e;++t){const e=r[t][0],s=n.GetLayerByIndex(i[t][0]),a=i[t][1],o=s._GetInstances();o[a]!==e&&(o[a]=e,e.GetWorldInfo()._SetLayer(s,!0),s.SetZIndicesChanged(e),h=!0)}h&&this._runtime.UpdateRender(),AT.clearArray(DT),AT.clearArray(ET)},SetCollisionCellSize(t,e){t=Math.floor(t),e=Math.floor(e),t<=0||e<=0||!Number.isFinite(t)||!Number.isFinite(e)||this._runtime.GetCollisionEngine().SetCollisionCellSize(t,e)},GoToLayout(t){if(this._runtime.IsLoading())return;const e=this._runtime.GetLayoutManager();e.IsPendingChangeMainLayout()||e.ChangeMainLayout(t)},GoToLayoutByName(t){if(this._runtime.IsLoading())return;const e=this._runtime.GetLayoutManager();if(e.IsPendingChangeMainLayout())return;const s=e.GetLayoutByName(t);s&&e.ChangeMainLayout(s)},NextPrevLayout(t){if(this._runtime.IsLoading())return;const e=this._runtime.GetLayoutManager();if(e.IsPendingChangeMainLayout())return;const s=e.GetAllLayouts(),i=s.indexOf(e.GetMainRunningLayout());if(t&&0===i)return;if(!t&&i===s.length-1)return;const r=s[i+(t?-1:1)];e.ChangeMainLayout(r)},RestartLayout(){if(this._runtime.IsLoading())return;const t=this._runtime.GetLayoutManager();t.IsPendingChangeMainLayout()||(t.ChangeMainLayout(t.GetMainRunningLayout()),this._runtime.GetEventSheetManager().ResetAllGroupsInitialActivation())},SetLayerVisible(t,e){t&&t.SetVisible(e)},SetLayerInteractive(t,e){t&&t.SetInteractive(e)},SetLayerHTML(t,e){t&&t.SetIsHTMLElementsLayer(e)},SetLayerOpacity(t,e){t&&t.SetOpacity(e/100)},SetLayerScale(t,e){t&&t.SetOwnScale(e)},SetLayerScaleRate(t,e){t&&t.SetScaleRate(e)},SetLayerAngle(t,e){t&&t.SetAngle(AT.toRadians(+e))},SetLayerScroll(t,e,s){t&&(t.SetOwnScrollPositionEnabled(!0),t.SetScrollX(e),t.SetScrollY(s))},RestoreLayerScroll(t){t&&t.SetOwnScrollPositionEnabled(!1)},SetLayerParallax(t,e,s){t&&t.SetParallax(e/100,s/100)},SetLayerZElevation(t,e){t&&t.SetZElevation(+e)},SetLayerRenderingMode(t,e){t&&t.SetRenderAs3D(1===e)},SetLayerBackground(t,e){if(!t)return;OT.setFromRgbValue(e),OT.clamp();const s=t.GetBackgroundColor();s.equalsIgnoringAlpha(OT)||(s.copyRgb(OT),this.UpdateRender())},SetLayerTransparent(t,e){t&&t.SetTransparent(e)},SetLayerBlendMode(t,e){t&&t.SetBlendMode(e)},SetLayerEffectEnabled(t,e,s){if(!t)return;const i=t.GetEffectList().GetEffectTypeByName(s);if(!i)return;const r=1===e;i.IsActive()!==r&&(i.SetActive(r),t.UpdateActiveEffects(),this._runtime.UpdateRender())},SetLayerEffectParam(t,e,s,i){if(!t)return;const r=t.GetEffectList(),n=r.GetEffectTypeByName(e);if(!n)return;s=Math.floor(s);const a=n.GetShaderProgram().GetParameterType(s);a&&("color"===a?(OT.setFromRgbValue(i),i=OT):"percent"===a&&(i/=100),r.SetEffectParameter(n.GetIndex(),s,i)&&n.IsActive()&&this._runtime.UpdateRender())},SetLayerForceOwnTexture(t,e){t&&t.SetForceOwnTexture(e)},SetLayoutScale(t){this._runtime.GetCurrentLayout().SetScale(+t)},SetLayoutAngle(t){this._runtime.GetCurrentLayout().SetAngle(AT.toRadians(+t))},SetLayoutEffectEnabled(t,e){const s=this._runtime.GetCurrentLayout(),i=s.GetEffectList().GetEffectTypeByName(e);if(!i)return;const r=1===t;i.IsActive()!==r&&(i.SetActive(r),s.UpdateActiveEffects(),this._runtime.UpdateRender())},SetLayoutEffectParam(t,e,s){const i=this._runtime.GetCurrentLayout().GetEffectList(),r=i.GetEffectTypeByName(t);if(!r)return;e=Math.floor(e);const n=r.GetShaderProgram().GetParameterType(e);n&&("color"===n?(OT.setFromRgbValue(s),s=OT):"percent"===n&&(s/=100),i.SetEffectParameter(r.GetIndex(),e,s)&&r.IsActive()&&this._runtime.UpdateRender())},SetLayoutVanishingPoint(t,e){this._runtime.GetCurrentLayout().SetVanishingPointXY(t/100,e/100)},SetLayoutProjection(t){const e=this._runtime.GetCurrentLayout();0===t?e.SetPerspectiveProjection():e.SetOrthographicProjection()},ScrollX(t){this._runtime.GetCurrentLayout().SetScrollX(t)},ScrollY(t){this._runtime.GetCurrentLayout().SetScrollY(t)},Scroll(t,e){const s=this._runtime.GetCurrentLayout();s.SetScrollX(t),s.SetScrollY(e)},ScrollToObject(t){if(!t)return;const e=t.GetFirstPicked();if(!e)return;const s=e.GetWorldInfo();if(!s)return;const i=this._runtime.GetCurrentLayout();i.SetScrollX(s.GetX()),i.SetScrollY(s.GetY())},AddLayer(t,e,s){const i=this._runtime.GetCurrentLayout();try{i.AddLayer(t,e,s)}catch(t){console.warn("[Construct] Cannot add layer: ",t)}},MoveLayer(t,e,s){if(!t)return;const i=this._runtime.GetCurrentLayout();try{i.MoveLayer(t,e,s)}catch(t){console.warn("[Construct] Cannot move layer: ",t)}},RemoveLayer(t){t&&this._runtime.GetCurrentLayout().RemoveLayer(t)},RemoveAllDynamicLayers(){this._runtime.GetCurrentLayout().RemoveAllDynamicLayers()},async LoadObjectTextures(t){const e=this._runtime.GetMainRunningLayout();if(!e||!t||this._runtime.IsLoading())return;const s=t.IsFamily()?t.GetFamilyMembers():[t];await this._LoadTexturesForObjectClasses(e,s)},async LoadObjectTexturesByName(t){await AT.Plugins.System.Acts.LoadObjectTextures.call(this,this._runtime.GetObjectClassByName(t))},UnloadObjectTextures(t){const e=this._runtime.GetMainRunningLayout();if(!e||!t)return;const s=t.IsFamily()?t.GetFamilyMembers():[t];this._UnloadTexturesForObjectClasses(e,s)},UnloadObjectTexturesByName(t){AT.Plugins.System.Acts.UnloadObjectTextures.call(this,this._runtime.GetObjectClassByName(t))},UnloadUnusedTextures(){const t=this._runtime.GetMainRunningLayout();if(!t)return;const e=t._GetTextureLoadedObjectTypes();this._UnloadTexturesForObjectClasses(t,e)},async LoadLayoutTextures(t){const e=this._runtime.GetMainRunningLayout();t&&e&&!this._runtime.IsLoading()&&await this._LoadTexturesForObjectClasses(e,t._GetInitialObjectClasses())},async LoadLayoutTexturesByName(t){const e=this._runtime.GetMainRunningLayout(),s=this._runtime.GetLayoutManager().GetLayoutByName(t);s&&e&&!this._runtime.IsLoading()&&await this._LoadTexturesForObjectClasses(e,s._GetInitialObjectClasses())},SetFunctionReturnValue(t){const e=this._eventStack.GetCurrentExpFuncStackFrame();if(e)switch(e.GetFunctionReturnType()){case 1:"number"==typeof t&&e.SetFunctionReturnValue(t);break;case 2:"string"==typeof t&&e.SetFunctionReturnValue(t);break;case 3:e.SetFunctionReturnValue(t)}},MapFunction(t,e,s){const i=this._GetFunctionMap(t.toLowerCase(),!0),r=i.strMap,n=e.toLowerCase();r.has(n)&&console.warn(`[Construct] Function map '${t}' string '${e}' already in map; overwriting entry`);const a=AT.first(r.values())||i.defaultFunc;a&&0!==a.GetReturnType()!=(0!==s.GetReturnType())?console.error(`[Construct] Function map '${t}' string '${e}' function return type not compatible with other functions in the map; entry ignored`):r.set(n,s)},MapFunctionDefault(t,e){const s=this._GetFunctionMap(t.toLowerCase(),!0);s.defaultFunc&&console.warn(`[Construct] Function map '${t}' already has a default; overwriting entry`);const i=AT.first(s.strMap.values())||s.defaultFunc;i&&0!==i.GetReturnType()!=(0!==e.GetReturnType())?console.error(`[Construct] Function map '${t}' default: function return type not compatible with other functions in the map; entry ignored`):s.defaultFunc=e},CallMappedFunction(t,e,s){const i=this._runtime,r=i.IsDebugging()?BT:null;s=Math.floor(s);const n=this._GetFunctionMap(t.toLowerCase(),!1);if(!n)return console.warn(`[Construct] Call mapped function: map name '${t}' not found; call ignored`),r;let a=n.strMap.get(e.toLowerCase());if(!a){if(!n.defaultFunc)return console.warn(`[Construct] Call mapped function: no function associated with map '${t}' string '${e}'; call ignored (consider setting a default)`),r;a=n.defaultFunc,s=0}if(!a.IsEnabled())return r;if(0!==a.GetReturnType())return console.warn(`[Construct] Call mapped function: map '${t}' string '${e}' has a return type so cannot be called`),r;const o=i.GetEventSheetManager(),h=o.GetCurrentEvent(),l=h.GetSolModifiersIncludingParents(),c=l.length>0;c&&(a.IsCopyPicked()?o.PushCopySol(l):o.PushCleanSol(l));const u=[],_=o.FindFirstFunctionBlockParent(h);if(_){const t=_.GetFunctionParameters();for(let e=s,i=t.length;e<i;++e)u.push(t[e].GetValue())}const d=a.GetFunctionParameters();for(let t=u.length,e=d.length;t<e;++t)u.push(d[t].GetInitialValue());return i.IsDebugging()?this._DebugDoCallMappedFunction(o,a,u,c,l):this._DoCallMappedFunction(o,a,u,c,l)}}}{const LT=self.C3,kT=LT.New(LT.Color);LT.Plugins.System.Exps={int:function(t){return"string"==typeof t&&(t=parseInt(t,10),isNaN(t)&&(t=0)),Math.floor(t)},float:function(t){return"string"==typeof t&&(t=parseFloat(t),isNaN(t)&&(t=0)),t},str:t=>t.toString(),len:t=>"string"==typeof t?t.length:0,random(t,e){return void 0===e?this._runtime.Random()*t:this._runtime.Random()*(e-t)+t},choose(...t){return t[Math.floor(this._runtime.Random()*t.length)]},chooseindex:(t,...e)=>("number"!=typeof t&&(t=0),e[t=LT.clamp(Math.floor(t),0,e.length-1)]),pi:()=>Math.PI,infinity:()=>1/0,sqrt:t=>Math.sqrt(t),abs:t=>Math.abs(t),round:t=>Math.round(t),roundtodp(t,e){e=Math.max(Math.floor(e),0);const s=Math.pow(10,e);return Math.round((t+Number.EPSILON)*s)/s},floor:t=>Math.floor(t),ceil:t=>Math.ceil(t),sign:t=>Math.sign(t),sin:t=>Math.sin(LT.toRadians(t)),cos:t=>Math.cos(LT.toRadians(t)),tan:t=>Math.tan(LT.toRadians(t)),asin:t=>LT.toDegrees(Math.asin(t)),acos:t=>LT.toDegrees(Math.acos(t)),atan:t=>LT.toDegrees(Math.atan(t)),exp:t=>Math.exp(t),ln:t=>Math.log(t),log10:t=>Math.log10(t),max(...t){let e=t[0];"number"!=typeof e&&(e=0);for(let s=1,i=t.length;s<i;++s){let i=t[s];"number"==typeof i&&e<i&&(e=i)}return e},min(...t){let e=t[0];"number"!=typeof e&&(e=0);for(let s=1,i=t.length;s<i;++s){let i=t[s];"number"==typeof i&&e>i&&(e=i)}return e},clamp:(t,e,s)=>LT.clamp(t,e,s),distance:(t,e,s,i)=>LT.distanceTo(t,e,s,i),angle:(t,e,s,i)=>LT.toDegrees(LT.angleTo(t,e,s,i)),lerp:(t,e,s)=>LT.lerp(t,e,s),unlerp:(t,e,s)=>LT.unlerp(t,e,s),qarp:(t,e,s,i)=>LT.qarp(t,e,s,i),cubic:(t,e,s,i,r)=>LT.cubic(t,e,s,i,r),cosp:(t,e,s)=>LT.cosp(t,e,s),anglediff:(t,e)=>LT.toDegrees(LT.angleDiff(LT.toRadians(t),LT.toRadians(e))),anglelerp:(t,e,s)=>LT.toDegrees(LT.angleLerp(LT.toRadians(t),LT.toRadians(e),s)),anglerotate:(t,e,s)=>LT.toDegrees(LT.angleRotate(LT.toRadians(t),LT.toRadians(e),LT.toRadians(s))),setbit:(t,e,s)=>(t|=0)&~(1<<(e|=0))|(s=0!==s?1:0)<<e,togglebit:(t,e)=>(t|=0)^1<<e,getbit:(t,e)=>(t|=0)&1<<(e|=0)?1:0,newline:()=>"\n",uppercase:t=>"string"==typeof t?t.toUpperCase():"",lowercase:t=>"string"==typeof t?t.toLowerCase():"",left:(t,e)=>"string"==typeof t?t.substr(0,e):"",mid:(t,e,s)=>"string"!=typeof t?"":s<0?t.substr(e):t.substr(e,s),right:(t,e)=>"string"==typeof t?t.substr(Math.max(t.length-e,0)):"",trim:t=>"string"==typeof t?t.trim():"",tokenat(t,e,s){if("string"!=typeof t||"string"!=typeof s)return"";let i=t.split(s);return(e=Math.floor(e))<0||e>=i.length?"":i[e]},tokencount:(t,e)=>"string"==typeof t&&"string"==typeof e&&t.length?t.split(e).length:0,find:(t,e)=>"string"==typeof t&&"string"==typeof e?t.search(new RegExp(LT.EscapeRegex(e),"i")):-1,findcase:(t,e)=>"string"==typeof t&&"string"==typeof e?t.search(new RegExp(LT.EscapeRegex(e),"")):-1,replace:(t,e,s)=>"string"==typeof t&&"string"==typeof e&&"string"==typeof s?t.replace(new RegExp(LT.EscapeRegex(e),"gi"),s):"string"==typeof t?t:"",stringsub(t,...e){let s=t;for(let t=0,i=e.length;t<i;++t)s=s.replaceAll(`{${t}}`,e[t].toString());return s},regexsearch(t,e,s){const i=this.GetRegex(e,s);return t?t.search(i):-1},regexreplace(t,e,s,i){const r=this.GetRegex(e,s);return t?t.replace(r,i):""},regexmatchcount(t,e,s){const i=this.GetRegexMatches(t.toString(),e,s);return i?i.length:0},regexmatchat(t,e,s,i){i=Math.floor(i);const r=this.GetRegexMatches(t.toString(),e,s);return!r||i<0||i>=r.length?"":r[i]},zeropad(t,e){let s=t<0?"-":"";t<0&&(t=-t);const i=e-t.toString().length;return s+="0".repeat(Math.max(i,0)),s+t.toString()},urlencode:t=>encodeURIComponent(t),urldecode:t=>decodeURIComponent(t),dt(){return this._runtime._GetDtFast()},wallclockdt(){return this._runtime.GetDt1()},timescale(){return this._runtime.GetTimeScale()},wallclocktime(){return(Date.now()-this._runtime.GetStartTime())/1e3},unixtime:()=>Date.now(),time(){return this._runtime.GetGameTime()},tickcount(){return this._runtime.GetTickCount()},objectcount(){return this._runtime.GetObjectCount()},fps(){return this._runtime.GetFramesPerSecond()},cpuutilisation(){return this._runtime.GetMainThreadTime()},gpuutilisation(){return this._runtime.GetGPUUtilisation()},windowwidth(){return this._runtime.GetCanvasManager().GetDeviceWidth()},windowheight(){return this._runtime.GetCanvasManager().GetDeviceHeight()},originalwindowwidth(){return this._runtime.GetOriginalViewportWidth()},originalwindowheight(){return this._runtime.GetOriginalViewportHeight()},originalviewportwidth(){return this._runtime.GetOriginalViewportWidth()},originalviewportheight(){return this._runtime.GetOriginalViewportHeight()},scrollx(){return this._runtime.GetCurrentLayout().GetScrollX()},scrolly(){return this._runtime.GetCurrentLayout().GetScrollY()},layoutname(){return this._runtime.GetCurrentLayout().GetName()},layoutscale(){return this._runtime.GetCurrentLayout().GetScale()},layoutangle(){return LT.toDegrees(this._runtime.GetCurrentLayout().GetAngle())},layoutwidth(){return this._runtime.GetCurrentLayout().GetWidth()},layoutheight(){return this._runtime.GetCurrentLayout().GetHeight()},vanishingpointx(){return 100*this._runtime.GetCurrentLayout().GetVanishingPointX()},vanishingpointy(){return 100*this._runtime.GetCurrentLayout().GetVanishingPointY()},viewportleft(t){const e=this._runtime.GetCurrentLayout().GetLayer(t);return e?e.GetViewport3D().getLeft():0},viewporttop(t){const e=this._runtime.GetCurrentLayout().GetLayer(t);return e?e.GetViewport3D().getTop():0},viewportright(t){const e=this._runtime.GetCurrentLayout().GetLayer(t);return e?e.GetViewport3D().getRight():0},viewportbottom(t){const e=this._runtime.GetCurrentLayout().GetLayer(t);return e?e.GetViewport3D().getBottom():0},viewportwidth(t){const e=this._runtime.GetCurrentLayout().GetLayer(t);return e?e.GetViewport3D().width():0},viewportheight(t){const e=this._runtime.GetCurrentLayout().GetLayer(t);return e?e.GetViewport3D().height():0},viewportmidx(t){const e=this._runtime.GetCurrentLayout().GetLayer(t);if(e){const t=e.GetViewport3D();return(t.getLeft()+t.getRight())/2}return 0},viewportmidy(t){const e=this._runtime.GetCurrentLayout().GetLayer(t);if(e){const t=e.GetViewport3D();return(t.getTop()+t.getBottom())/2}return 0},canvastolayerx(t,e,s){const i=this._runtime.GetCurrentLayout().GetLayer(t);return i?i.CanvasCssToLayer(e,s)[0]:0},canvastolayery(t,e,s){const i=this._runtime.GetCurrentLayout().GetLayer(t);return i?i.CanvasCssToLayer(e,s)[1]:0},layertocanvasx(t,e,s){const i=this._runtime.GetCurrentLayout().GetLayer(t);return i?i.LayerToCanvasCss(e,s)[0]:0},layertocanvasy(t,e,s){const i=this._runtime.GetCurrentLayout().GetLayer(t);return i?i.LayerToCanvasCss(e,s)[1]:0},layertolayerx(t,e,s,i){const r=this._runtime.GetCurrentLayout(),n=r.GetLayer(t),a=r.GetLayer(e);if(!n||!a||n===a)return s;const[o,h]=n.LayerToCanvasCss(s,i);return a.CanvasCssToLayer(o,h)[0]},layertolayery(t,e,s,i){const r=this._runtime.GetCurrentLayout(),n=r.GetLayer(t),a=r.GetLayer(e);if(!n||!a||n===a)return i;const[o,h]=n.LayerToCanvasCss(s,i);return a.CanvasCssToLayer(o,h)[1]},layerscale(t){const e=this._runtime.GetCurrentLayout().GetLayer(t);return e?e.GetOwnScale():0},layerangle(t){const e=this._runtime.GetCurrentLayout().GetLayer(t);return e?LT.toDegrees(e.GetOwnAngle()):0},layeropacity(t){const e=this._runtime.GetCurrentLayout().GetLayer(t);return e?100*e.GetOpacity():0},layerscalerate(t){const e=this._runtime.GetCurrentLayout().GetLayer(t);return e?e.GetScaleRate():0},layerscrollx(t){const e=this._runtime.GetCurrentLayout().GetLayer(t);return e?e.GetScrollX():0},layerscrolly(t){const e=this._runtime.GetCurrentLayout().GetLayer(t);return e?e.GetScrollY():0},layerparallaxx(t){const e=this._runtime.GetCurrentLayout().GetLayer(t);return e?100*e.GetParallaxX():0},layerparallaxy(t){const e=this._runtime.GetCurrentLayout().GetLayer(t);return e?100*e.GetParallaxY():0},layerzelevation(t){const e=this._runtime.GetCurrentLayout().GetLayer(t);return e?e.GetZElevation():0},layerindex(t){const e=this._runtime.GetCurrentLayout().GetLayer(t);return e?e.GetIndex():-1},canvassnapshot(){const t=this._runtime.GetCanvasManager();return t?t.GetCanvasSnapshotUrl():""},loopindex(t){const e=this._loopStack;if(!e.IsInLoop())return 0;if(t){const s=e.FindByName(t);return s?s.GetIndex():0}return e.GetCurrent().GetIndex()},savestatejson(){return this._runtime.GetLastSaveJsonString()},callmapped(t,e,...s){const i=this._GetFunctionMap(t.toLowerCase(),!1);if(!i)return console.warn(`[Construct] Call mapped function: map name '${t}' not found; returning 0`),0;let r=i.strMap.get(e.toLowerCase());if(!r){if(!i.defaultFunc)return console.warn(`[Construct] Call mapped function: no function associated with map '${t}' string '${e}'; returning 0 (consider setting a default)`),0;r=i.defaultFunc}const n=r.GetReturnType(),a=r.GetDefaultReturnValue();if(0===n)return console.warn(`[Construct] Call mapped function: map '${t}' string '${e}' has no return type so cannot be called from an expression; returning 0`),0;if(!r.IsEnabled())return a;const o=this._runtime.GetEventSheetManager(),h=o.GetCurrentEvent().GetSolModifiersIncludingParents(),l=h.length>0;l&&(r.IsCopyPicked()?o.PushCopySol(h):o.PushCleanSol(h));const c=r.GetFunctionParameters();for(let t=s.length,e=c.length;t<e;++t)s.push(c[t].GetInitialValue());const u=r.GetEventBlock(),_=u.RunAsExpressionOrJSFunctionCall(u.GetSolModifiersIncludingParents(),r.IsCopyPicked(),n,a,null,...s);return l&&o.PopSol(h),_},loadingprogress(){return this._runtime.GetAssetManager().GetLoadProgress()},imageloadingprogress(){return this.GetImageLoadingProgress()},renderer(){return this._runtime.GetWebGPURenderer()?"webgpu":"webgl"},rendererdetail(){return this._runtime.GetWebGPURenderer()?this._runtime.GetWebGPURenderer().GetAdapterInfoString():this._runtime.GetWebGLRenderer().GetUnmaskedRenderer()},imagememoryusage(){let t=this._runtime.GetRenderer().GetEstimatedTextureMemoryUsage();return Math.round(100*t/1048576)/100},rgb:(t,e,s)=>LT.PackRGB(t,e,s),rgbex:(t,e,s)=>LT.PackRGBEx(t/100,e/100,s/100),rgba:(t,e,s,i)=>LT.PackRGBAEx(t/100,e/100,s/100,i/100),rgbex255:(t,e,s)=>LT.PackRGBEx(t/255,e/255,s/255),rgba255:(t,e,s,i)=>LT.PackRGBAEx(t/255,e/255,s/255,i/255),hexcolor:t=>(kT.setRgba(0,0,0,1),kT.parseHexString(t),LT.PackRGBAEx(kT.getR(),kT.getG(),kT.getB(),kT.getA())),colortohexstring:t=>(kT.setFromRgbValue(t),kT.toHexString(1!==kT.getA())),projectname(){return this._runtime.GetProjectName()},projectversion(){return this._runtime.GetProjectVersion()},projectid(){return this._runtime.GetAppId()},projectuniqueid(){return this._runtime.GetProjectUniqueId()},currenteventsheetname(){return this._runtime.GetCurrentEvent().GetEventSheet().GetName()},currenteventnumber(){return this._runtime.GetCurrentEvent().GetDisplayNumber()},projectfilecount(){return this._runtime.GetAssetManager().GetExportedFileList().length},projectfilenameat(t){t=Math.floor(t);const e=this._runtime.GetAssetManager().GetExportedFileList();return t<0||t>=e.length?"":e[t].name}}}{const NT=self.C3;NT.Plugins.Sprite=class extends NT.SDKPluginBase{constructor(t){super(t)}Release(){super.Release()}}}{const UT=self.C3,WT=self.C3X,jT=[];UT.Plugins.Sprite.Type=class extends UT.SDKTypeBase{constructor(t){super(t),this._animations=t.GetAnimations()}Release(){UT.clearArray(this._animations),super.Release()}OnCreate(){for(const t of this._animations)t.LoadAllAssets(this._runtime)}LoadTextures(t){const e={sampling:this._runtime.GetSampling()};return Promise.all(this._animations.map(s=>s.LoadAllTextures(t,e)))}ReleaseTextures(){for(const t of this._animations)t.ReleaseAllTextures()}OnDynamicTextureLoadComplete(){this._UpdateAllCurrentTexture()}_UpdateAllCurrentTexture(){for(const t of this._objectClass.instancesIncludingPendingCreate())t.GetSdkInstance()._UpdateCurrentTexture()}FinishCondition(t){UT.Plugins.Sprite.FinishCollisionCondition(this,t)}BeforeRunAction(t){jT.push({objectClass:null,createHierarchy:!1,instances:[]})}_SpawnPickInstance(t,e,s){const i=jT.at(-1);i.objectClass=t,i.createHierarchy=s,i.instances.push(e)}AfterRunAction(t){const e=jT.pop(),s=e.objectClass,i=e.createHierarchy;if(!s)return;const r=new Map;for(const t of e.instances)t.CollectInstancesToPick(r,s,i);for(const[t,e]of r)t.GetCurrentSol().SetSetPicked(e)}_AddAnimation(t){const e=this.GetObjectClass().AddAnimation(t),s=this.GetRuntime();return e.GetFrameAt(0).GetImageInfo().LoadStaticTexture(s.GetRenderer(),{sampling:s.GetSampling()}).then(()=>this._UpdateAllCurrentTexture()),e}_RemoveAnimation(t){for(const e of this._objectClass.instancesIncludingPendingCreate())e.GetSdkInstance()._OnAnimationRemoved(t);this.GetObjectClass().RemoveAnimation(t)}_AddAnimationFrame(t,e){const s=this._objectClass.GetAnimationByName(t);if(!s)throw new Error(`cannot find animation name '${t}'`);let i=s.FrameTagOrIndexToIndex(e);i<0&&(i+=s.GetFrameCount()+1);const r=UT.AnimationFrameInfo.CreateDynamic(this.GetRuntime());s.InsertFrameAt(r,i);const n=this.GetRuntime();r.GetImageInfo().LoadStaticTexture(n.GetRenderer(),{sampling:n.GetSampling()}).then(()=>this._UpdateAllCurrentTexture());for(const t of this._objectClass.instancesIncludingPendingCreate())t.GetSdkInstance()._OnAnimationFramesChanged();return r}_RemoveAnimationFrame(t,e){const s=this._objectClass.GetAnimationByName(t);if(!s)throw new Error(`cannot find animation name '${t}'`);if(1===s.GetFrameCount())throw new Error(`cannot remove last frame from animation '${t}'`);let i=s.FrameTagOrIndexToIndex(e);i<0&&(i+=s.GetFrameCount()),s.RemoveFrameAt(i);for(const t of this._objectClass.instancesIncludingPendingCreate())t.GetSdkInstance()._OnAnimationFramesChanged()}GetScriptInterfaceClass(){return self.ISpriteObjectType}};const VT=new WeakMap;self.ISpriteObjectType=class extends self.IObjectType{constructor(t){super(t),VT.set(this,t.GetSdkType())}getAnimation(t){WT.RequireString(t);const e=VT.get(this).GetObjectClass().GetAnimationByName(t);return e?e.GetIAnimation():null}getAllAnimations(){return VT.get(this).GetObjectClass().GetAllAnimations().map(t=>t.GetIAnimation())}addAnimation(t){return WT.RequireString(t),VT.get(this)._AddAnimation(t).GetIAnimation()}removeAnimation(t){WT.RequireString(t),VT.get(this)._RemoveAnimation(t)}addAnimationFrame(t,e){if(WT.RequireString(t),"number"!=typeof e&&"string"!=typeof e)throw new TypeError("invalid insert location");return VT.get(this)._AddAnimationFrame(t,e).GetIAnimationFrame()}removeAnimationFrame(t,e){if(WT.RequireString(t),"number"!=typeof e&&"string"!=typeof e)throw new TypeError("invalid insert location");VT.get(this)._RemoveAnimationFrame(t,e)}}}{const zT=self.C3,HT=self.C3X,YT=0,XT=1,qT=2,JT=3,QT=zT.New(zT.Rect),KT=zT.New(zT.Quad),ZT=zT.New(zT.Vector2),$T=1,tI=2,eI=4;zT.Plugins.Sprite.Instance=class extends zT.SDKWorldInstanceBase{constructor(t,e){super(t);let s=!0,i="",r=0,n=!0;e&&(s=!!e[YT],i=e[XT],r=e[qT],n=e[JT]),this._currentAnimation=this._objectClass.GetAnimationByName(i)||this._objectClass.GetAnimations()[0],this._currentFrameIndex=zT.clamp(r,0,this._currentAnimation.GetFrameCount()-1),this._currentAnimationFrame=this._currentAnimation.GetFrameAt(this._currentFrameIndex);const a=this._currentAnimationFrame.GetImageInfo();this._currentTexture=a.GetTexture(),this._currentRcTex=a.GetTexRect(),this._currentQuadTex=a.GetTexQuad(),this.HandleRendererContextLoss(),t.SetFlag(tI,!0),t.SetFlag($T,this._currentAnimation.GetSpeed()>=0),this._currentAnimationSpeed=Math.abs(this._currentAnimation.GetSpeed()),this._currentAnimationRepeatTo=this._currentAnimation.GetRepeatTo(),this._animationTimer=zT.New(zT.KahanSum),this._frameStartTime=0,this._animationRepeats=0,this._animTriggerName="",this._changeAnimFrameIndex=-1,this._changeAnimationName="",this._changeAnimationFrom=0;const o=this.GetWorldInfo();this._bquadRef=o.GetBoundingQuad(),o.SetVisible(s),o.SetCollisionEnabled(n),o.SetOriginX(this._currentAnimationFrame.GetOriginX()),o.SetOriginY(this._currentAnimationFrame.GetOriginY()),o.SetSourceCollisionPoly(this._currentAnimationFrame.GetCollisionPoly()),o.SetBboxChanged(),1===this._objectClass.GetAnimationCount()&&1===this._objectClass.GetAnimations()[0].GetFrameCount()||0===this._currentAnimationSpeed||this._StartTicking()}Release(){this._currentAnimation=null,this._currentAnimationFrame=null,this._currentTexture=null,this._animationTimer=null,super.Release()}GetCurrentImageInfo(){return this._currentAnimationFrame.GetImageInfo()}IsOriginalSizeKnown(){return!0}OnRendererContextLost(){this._currentTexture=null}OnRendererContextRestored(){this._UpdateCurrentTexture()}Draw(t){const e=this._currentTexture;if(null===e)return;t.SetTexture(e);const s=this.GetWorldInfo();s.HasMesh()?this._DrawMesh(s,t):this._DrawStandard(s,t)}_DrawStandard(t,e){let s=this._bquadRef;this._runtime.IsPixelRoundingEnabled()&&(s=t.PixelRoundQuad(s)),e.Quad4(s,this._currentQuadTex)}_DrawMesh(t,e){const s=t.GetTransformedMesh();if(t.IsMeshChanged()){t.CalculateBbox(QT,KT,!1);let e=KT;this._runtime.IsPixelRoundingEnabled()&&(e=t.PixelRoundQuad(e)),s.CalculateTransformedMesh(t.GetSourceMesh(),e,this._currentQuadTex),t.SetMeshChanged(!1)}s.Draw(e,t.GetTotalZElevation())}GetAnimationTime(){return this._animationTimer.Get()}IsAnimationPlaying(){return this._inst.GetFlag(tI)}SetAnimationPlaying(t){this._inst.SetFlag(tI,t)}IsPlayingForwards(){return this._inst.GetFlag($T)}SetPlayingForwards(t){this._inst.SetFlag($T,t)}IsInAnimationTrigger(){return this._inst.GetFlag(eI)}SetInAnimationTrigger(t){this._inst.SetFlag(eI,t)}Tick(){this._changeAnimationName&&this._DoChangeAnimation(),this._changeAnimFrameIndex>=0&&this._DoChangeAnimFrame();const t=this._currentAnimationSpeed;if(!this.IsAnimationPlaying()||0===t)return void this._StopTicking();const e=this._runtime.GetDt(this._inst);this._animationTimer.Add(e);const s=this.GetAnimationTime(),i=this._currentAnimationFrame,r=i.GetDuration()/t;if(s<this._frameStartTime+r)return;const n=this._currentAnimation,a=this._currentAnimationRepeatTo,o=n.GetFrameCount(),h=n.GetRepeatCount(),l=n.IsLooping(),c=n.IsPingPong();this.IsPlayingForwards()?this._currentFrameIndex++:this._currentFrameIndex--,this._frameStartTime+=r,this._currentFrameIndex>=o&&(c?(this.SetPlayingForwards(!1),this._currentFrameIndex=o-2):l?this._currentFrameIndex=a:(this._animationRepeats++,this._animationRepeats>=h?this._FinishAnimation(!1):this._currentFrameIndex=a)),this._currentFrameIndex<0&&(c?(this._currentFrameIndex=1,this.SetPlayingForwards(!0),l||(this._animationRepeats++,this._animationRepeats>=h&&this._FinishAnimation(!0))):l?this._currentFrameIndex=a:(this._animationRepeats++,this._animationRepeats>=h?this._FinishAnimation(!0):this._currentFrameIndex=a)),this._currentFrameIndex=zT.clamp(this._currentFrameIndex,0,o-1);const u=n.GetFrameAt(this._currentFrameIndex);s>this._frameStartTime+u.GetDuration()/t&&(this._frameStartTime=s),this._OnFrameChanged(i,u)}_FinishAnimation(t){this._currentFrameIndex=t?0:this._currentAnimation.GetFrameCount()-1,this.SetAnimationPlaying(!1),this._animTriggerName=this._currentAnimation.GetName(),this.SetInAnimationTrigger(!0),this.DispatchScriptEvent("animationend",!1,{animationName:this._animTriggerName}),this.Trigger(zT.Plugins.Sprite.Cnds.OnAnyAnimFinished),this.Trigger(zT.Plugins.Sprite.Cnds.OnAnimFinished),this.SetInAnimationTrigger(!1),this._animationRepeats=0}_OnFrameChanged(t,e,s){if(t===e)return;const i=this.GetWorldInfo(),r=t.GetImageInfo(),n=e.GetImageInfo(),a=r.GetWidth(),o=r.GetHeight(),h=n.GetWidth(),l=n.GetHeight();s&&s.onFrameChange?s.onFrameChange(i,a,o,h,l):(a!==h&&i.SetWidth(i.GetWidth()*(h/a)),o!==l&&i.SetHeight(i.GetHeight()*(l/o))),i.SetOriginX(e.GetOriginX()),i.SetOriginY(e.GetOriginY()),i.SetSourceCollisionPoly(e.GetCollisionPoly()),i.SetBboxChanged(),this._currentAnimationFrame=e,this._currentTexture=n.GetTexture(),this._currentRcTex=n.GetTexRect(),this._currentQuadTex=n.GetTexQuad();const c=this.GetInstance().GetBehaviorInstances();for(let s=0,i=c.length;s<i;++s)c[s].OnSpriteFrameChanged(t,e);this.DispatchScriptEvent("framechange",!1,{animationName:this._currentAnimation.GetName(),animationFrame:this._currentFrameIndex}),this.Trigger(zT.Plugins.Sprite.Cnds.OnFrameChanged),this._runtime.UpdateRender()}_StartAnim(t){this.SetAnimationPlaying(!0),this._frameStartTime=this.GetAnimationTime(),1===t&&0!==this._currentFrameIndex&&(this._changeAnimFrameIndex=0,this.IsInAnimationTrigger()||this._DoChangeAnimFrame()),this._StartTicking()}_SetAnim(t,e,s){this._changeAnimationName=t,this._changeAnimationFrom=e,this._StartTicking(),!s&&this.IsInAnimationTrigger()||this._DoChangeAnimation()}_GetCurrentAnimation(){return this._currentAnimation}_GetCurrentAnimationName(){return this._changeAnimationName?this._changeAnimationName:this._currentAnimation.GetName()}_OnAnimationRemoved(t){zT.equalsNoCase(t,this._GetCurrentAnimationName())&&this._SetAnim(this._objectClass.GetFirstAnimation().GetName(),1,!0)}_SetAnimFrame(t){if("string"==typeof t)if(String(Number(t))===t)t=Number(t);else{const e=this._objectClass.GetAnimationByName(this._GetCurrentAnimationName());if(!e)return;if(-1===(t=e.GetFrameIndexByTag(t)))return}isFinite(t)&&(this._changeAnimFrameIndex=t,this.IsInAnimationTrigger()||this._DoChangeAnimFrame())}_OnAnimationFramesChanged(){if(this._changeAnimationName||-1!==this._changeAnimFrameIndex)return;const t=this._currentAnimationFrame,e=this._currentAnimation.GetFrameAt(zT.clamp(this._currentFrameIndex,0,this._currentAnimation.GetFrameCount()-1));t!==e&&this._OnFrameChanged(t,e),this._currentAnimation.GetFrameCount()>1&&this._currentAnimationSpeed>0&&this._StartTicking()}_GetAnimFrame(){return this._currentFrameIndex}_GetAnimFrameTag(){return this._currentAnimationFrame.GetTag()}_SetAnimSpeed(t){this._currentAnimationSpeed=Math.abs(t),this.SetPlayingForwards(t>=0),this._currentAnimationSpeed>0&&this._StartTicking()}_GetAnimSpeed(){return this.IsPlayingForwards()?this._currentAnimationSpeed:-this._currentAnimationSpeed}_SetAnimRepeatToFrame(t){"string"==typeof t&&-1===(t=this._currentAnimation.GetFrameIndexByTag(t))||(t=zT.clamp(Math.floor(t),0,this._currentAnimation.GetFrameCount()-1),this._currentAnimationRepeatTo=t)}_GetAnimRepeatToFrame(){return this._currentAnimationRepeatTo}_DoChangeAnimation(t){const e=this._currentAnimationFrame,s=this._objectClass.GetAnimationByName(this._changeAnimationName);if(this._changeAnimationName="",!s)return;if(s===this._currentAnimation&&this.IsAnimationPlaying())return;this._currentAnimation=s,this.SetPlayingForwards(s.GetSpeed()>=0),this._currentAnimationSpeed=Math.abs(s.GetSpeed()),this._currentAnimationRepeatTo=s.GetRepeatTo(),this._currentFrameIndex=zT.clamp(this._currentFrameIndex,0,this._currentAnimation.GetFrameCount()-1),1===this._changeAnimationFrom&&(this._currentFrameIndex=0),this.SetAnimationPlaying(!0),this._frameStartTime=this.GetAnimationTime();const i=this._currentAnimation.GetFrameAt(this._currentFrameIndex);this._OnFrameChanged(e,i,t)}_DoChangeAnimFrame(t){const e=this._currentAnimationFrame,s=this._currentFrameIndex;if(this._currentFrameIndex=zT.clamp(Math.floor(this._changeAnimFrameIndex),0,this._currentAnimation.GetFrameCount()-1),this._changeAnimFrameIndex=-1,!t&&s===this._currentFrameIndex)return;const i=this._currentAnimation.GetFrameAt(this._currentFrameIndex);this._OnFrameChanged(e,i),this._frameStartTime=this.GetAnimationTime()}_UpdateCurrentTexture(){const t=this._currentAnimationFrame.GetImageInfo();this._currentTexture=t.GetTexture(),this._currentRcTex=t.GetTexRect(),this._currentQuadTex=t.GetTexQuad(),this.GetWorldInfo().SetMeshChanged(!0)}GetTexture(){return this._currentTexture}GetTexRect(){return this._currentRcTex}GetTexQuad(){return this._currentQuadTex}GetImagePointCount(){return this._currentAnimationFrame.GetImagePointCount()}GetImagePoint(t){const e=this._currentAnimationFrame,s=this.GetWorldInfo();let i=null;if("string"==typeof t)i=e.GetImagePointByName(t);else{if("number"!=typeof t)throw new TypeError("expected string or number");i=e.GetImagePointByIndex(t-1)}let r=s.GetTotalZElevation();if(!i)return[s.GetX(),s.GetY(),r];if(ZT.copy(i.GetVec2()),s.HasMesh()){const[t,e,i]=s.GetSourceMesh().TransformPoint(ZT.getX(),ZT.getY());ZT.set(t,e),r+=i}return ZT.offset(-e.GetOriginX(),-e.GetOriginY()),ZT.scale(s.GetWidth(),s.GetHeight()),ZT.rotate(s.GetAngle()),ZT.offset(s.GetX(),s.GetY()),[ZT.getX(),ZT.getY(),r]}GetCollisionPolyPointCount(){return this.GetWorldInfo().GetTransformedCollisionPoly().pointCount()}GetCollisionPolyPoint(t){t=Math.floor(t);const e=this.GetWorldInfo(),s=e.GetTransformedCollisionPoly(),i=s.pointCount();if(t===i&&(t=0),t<0||t>=i)return[0,0];const r=s.pointsArr();return[r[2*t+0]+e.GetX(),r[2*t+1]+e.GetY()]}GetDebuggerProperties(){const t=zT.Plugins.Sprite.Acts,e="plugins.sprite.debugger.animation-properties";return[{title:e+".title",properties:[{name:e+".current-animation",value:this._currentAnimation.GetName(),onedit:e=>this.CallAction(t.SetAnim,e,0)},{name:e+".current-frame",value:this._currentFrameIndex,onedit:e=>this.CallAction(t.SetAnimFrame,e)},{name:e+".is-playing",value:this.IsAnimationPlaying(),onedit:e=>e?this.CallAction(t.StartAnim,0):this.CallAction(t.StopAnim)},{name:e+".speed",value:this._currentAnimationSpeed,onedit:e=>this.CallAction(t.SetAnimSpeed,e)},{name:e+".repeats",value:this._animationRepeats,onedit:t=>this._animationRepeats=t}]}]}SaveToJson(){const t={a:this._currentAnimation.GetSID()};0!==this._frameStartTime&&(t.fs=this._frameStartTime);const e=this.GetAnimationTime();0!==e&&(t.at=e),0!==this._currentFrameIndex&&(t.f=this._currentFrameIndex),0!==this._currentAnimationSpeed&&(t.cas=this._currentAnimationSpeed),1!==this._animationRepeats&&(t.ar=this._animationRepeats),0!==this._currentAnimationRepeatTo&&(t.rt=this._currentAnimationRepeatTo),this.IsAnimationPlaying()||(t.ap=this.IsAnimationPlaying()),this.IsPlayingForwards()||(t.af=this.IsPlayingForwards());const s=this.GetWorldInfo();return s.IsCollisionEnabled()&&(t.ce=s.IsCollisionEnabled()),t}LoadFromJson(t){const e=this.GetObjectClass().GetAnimationBySID(t.a);e&&(this._currentAnimation=e),this._frameStartTime=t.hasOwnProperty("fs")?t.fs:0,this._animationTimer.Set(t.hasOwnProperty("at")?t.at:0);const s=t.hasOwnProperty("f")?t.f:0;this._currentFrameIndex=zT.clamp(s,0,this._currentAnimation.GetFrameCount()-1),this._currentAnimationSpeed=t.hasOwnProperty("cas")?t.cas:0,this._animationRepeats=t.hasOwnProperty("ar")?t.ar:1;const i=t.hasOwnProperty("rt")?t.rt:0;this._currentAnimationRepeatTo=zT.clamp(i,0,this._currentAnimation.GetFrameCount()-1),this.SetAnimationPlaying(!t.hasOwnProperty("ap")||!!t.ap),this.SetPlayingForwards(!t.hasOwnProperty("af")||!!t.af);const r=this._currentAnimation.GetFrameAt(this._currentFrameIndex);this._currentAnimationFrame=r,this._UpdateCurrentTexture();const n=this.GetWorldInfo();n.SetOriginX(r.GetOriginX()),n.SetOriginY(r.GetOriginY()),n.SetSourceCollisionPoly(r.GetCollisionPoly()),n.SetCollisionEnabled(!!t.ce),this.IsAnimationPlaying()&&this._StartTicking()}GetPropertyValueByIndex(t){const e=this.GetWorldInfo();switch(t){case JT:return e.IsCollisionEnabled();case qT:return zT.clamp(this._currentFrameIndex,0,this._currentAnimation.GetFrameCount()-1);case XT:return this._currentAnimation.GetName()}}SetPropertyValueByIndex(t,e,s){const i=this.GetWorldInfo();switch(t){case JT:i.SetCollisionEnabled(!!e);break;case qT:if(s.isChunkDiscreteLike){if(!s.keyframeReached)return;{const t=this._currentAnimation.GetFrameCount()-1,i=e=zT.clamp(e,0,t),r=this._currentAnimation.GetFrameAt(this._currentFrameIndex),n=this._currentAnimation.GetFrameAt(i);this._OnFrameChanged(r,n,s),this._currentFrameIndex=zT.clamp(i,0,t)}}else{this.SetAnimationPlaying(!1);const t=this._currentAnimation.GetFrameCount()-1,i=e=zT.clamp(e,0,t),r=this._currentAnimation.GetFrameAt(this._currentFrameIndex),n=this._currentAnimation.GetFrameAt(i);this._OnFrameChanged(r,n,s),this._currentFrameIndex=zT.clamp(i,0,t)}break;case XT:this._changeAnimationName=e,this._changeAnimationFrom=s?.startFrom??0,this._DoChangeAnimation(s),this._currentAnimation.GetFrameCount()>1&&this._currentAnimation.GetSpeed()>0?this._StartTicking():this._StopTicking()}}GetScriptInterfaceClass(){return self.ISpriteInstance}};const sI=new WeakMap,iI=new Map([["current-frame",0],["beginning",1]]);self.ISpriteInstance=class extends self.IWorldInstance{constructor(){super(),sI.set(this,self.IInstance._GetInitInst().GetSdkInstance())}getImagePointCount(){return sI.get(this).GetImagePointCount()}getImagePointX(t){return this.getImagePoint(t)[0]}getImagePointY(t){return this.getImagePoint(t)[1]}getImagePointZ(t){return this.getImagePoint(t)[2]}getImagePoint(t){if("string"!=typeof t&&"number"!=typeof t)throw new TypeError("expected string or number");return sI.get(this).GetImagePoint(t)}getPolyPointCount(){return sI.get(this).GetCollisionPolyPointCount()}getPolyPointX(t){return HT.RequireFiniteNumber(t),sI.get(this).GetCollisionPolyPoint(t)[0]}getPolyPointY(t){return HT.RequireFiniteNumber(t),sI.get(this).GetCollisionPolyPoint(t)[1]}getPolyPoint(t){return HT.RequireFiniteNumber(t),sI.get(this).GetCollisionPolyPoint(t)}stopAnimation(){sI.get(this).SetAnimationPlaying(!1)}startAnimation(t="current-frame"){HT.RequireString(t);const e=iI.get(t);if(void 0===e)throw new Error("invalid mode");sI.get(this)._StartAnim(e)}setAnimation(t,e="beginning"){HT.RequireString(t),HT.RequireString(e);const s=iI.get(e);if(void 0===s)throw new Error("invalid mode");const i=sI.get(this);if(!i.GetObjectClass().GetAnimationByName(t))throw new Error(`animation name "${t}" does not exist`);i._SetAnim(t,s)}getAnimation(t){HT.RequireString(t);const e=sI.get(this).GetObjectClass().GetAnimationByName(t);return e?e.GetIAnimation():null}get animation(){return sI.get(this)._GetCurrentAnimation().GetIAnimation()}get animationName(){return sI.get(this)._GetCurrentAnimationName()}set animationFrame(t){HT.RequireFiniteNumber(t),sI.get(this)._SetAnimFrame(t)}get animationFrame(){return sI.get(this)._GetAnimFrame()}set animationFrameTag(t){HT.RequireString(t),sI.get(this)._SetAnimFrame(t)}get animationFrameTag(){return sI.get(this)._GetAnimFrameTag()}set animationSpeed(t){HT.RequireFiniteNumber(t),sI.get(this)._SetAnimSpeed(t)}get animationSpeed(){return sI.get(this)._GetAnimSpeed()}set animationRepeatToFrame(t){HT.RequireFiniteNumber(t),sI.get(this)._SetAnimRepeatToFrame(t)}get animationRepeatToFrame(){return sI.get(this)._GetAnimRepeatToFrame()}get imageWidth(){return sI.get(this).GetCurrentImageInfo().GetWidth()}get imageHeight(){return sI.get(this).GetCurrentImageInfo().GetHeight()}getImageSize(){const t=sI.get(this).GetCurrentImageInfo();return[t.GetWidth(),t.GetHeight()]}async replaceCurrentAnimationFrame(t){HT.RequireInstanceOf(t,Blob);const e=sI.get(this),s=e.GetRuntime(),i=e.GetCurrentImageInfo(),r=zT.New(zT.ImageInfo);if(r.LoadDynamicBlobAsset(s,t),await r.LoadStaticTexture(s.GetRenderer(),{sampling:s.GetSampling()}),e.WasReleased())return void r.Release();i.ReplaceWith(r);const n=e.GetSdkType();n._UpdateAllCurrentTexture(),n.GetObjectClass().Dispatcher().dispatchEvent(new zT.Event("animationframeimagechange")),s.UpdateRender()}setSolidCollisionFilter(t,e){"string"==typeof e&&(e=zT.splitStringAndNormalize(e)),sI.get(this).GetWorldInfo().SetSolidCollisionFilter(!!t,e)}}}{const rI=self.C3;rI.Plugins.Sprite.Cnds={IsAnimPlaying(t){return rI.equalsNoCase(this._GetCurrentAnimationName(),t)},CompareFrame(t,e){return rI.compare(this._currentFrameIndex,t,e)},CompareFrameTag(t,e){if("string"!=typeof e)return!1;const s=this._currentAnimationFrame.GetTag();return rI.compare(s.toLowerCase(),t,e.toLowerCase())},CompareAnimSpeed(t,e){return rI.compare(this._GetAnimSpeed(),t,e)},OnAnimFinished(t){return rI.equalsNoCase(this._animTriggerName,t)},OnAnyAnimFinished:()=>!0,OnFrameChanged:()=>!0,IsMirrored(){return this.GetWorldInfo().GetWidth()<0},IsFlipped(){return this.GetWorldInfo().GetHeight()<0},OnURLLoaded:()=>!0,OnURLFailed:()=>!0,IsCollisionEnabled(){return this.GetWorldInfo().IsCollisionEnabled()}}}{const nI=self.C3;nI.Plugins.Sprite.Acts={Spawn(t,e,s,i,r){if(!t||!e)return;const[n,a]=this.GetImagePoint(s),o=this._runtime.CreateInstance(t,e,n,a,i,r);if(!o)return;if(i&&e.SortAndAddInstancesByZIndex(o),t.GetPlugin().IsRotatable()){const t=o.GetWorldInfo();t.SetAngle(this.GetWorldInfo().GetAngle()),t.SetBboxChanged()}const h=this._runtime.GetEventSheetManager();h.BlockFlushingInstances(!0),o._TriggerOnCreatedOnSelfAndRelated(),h.BlockFlushingInstances(!1),t!==this._runtime.GetCurrentAction().GetObjectClass()&&this._sdkType._SpawnPickInstance(t,o,i)},StopAnim(){this.SetAnimationPlaying(!1)},StartAnim(t){this._StartAnim(t)},SetAnim(t,e){this._SetAnim(t,e)},SetAnimFrame(t){this._SetAnimFrame(t)},SetAnimSpeed(t){this._SetAnimSpeed(t)},SetAnimRepeatToFrame(t){this._SetAnimRepeatToFrame(t)},AddRemoveAnimation(t,e){try{0===t?this.GetSdkType()._AddAnimation(e):this.GetSdkType()._RemoveAnimation(e)}catch(e){console.error(`[Construct] Error ${0===t?"adding":"removing"} animation: `,e)}},AddRemoveAnimationFrame(t,e,s){try{0===t?this.GetSdkType()._AddAnimationFrame(e,s):this.GetSdkType()._RemoveAnimationFrame(e,s)}catch(e){console.error(`[Construct] Error ${0===t?"adding":"removing"} animation frame: `,e)}},SetMirrored(t){const e=this.GetWorldInfo(),s=e.GetWidth(),i=Math.abs(s)*(0===t?-1:1);s!==i&&(e.SetWidth(i),e.SetBboxChanged())},SetFlipped(t){const e=this.GetWorldInfo(),s=e.GetHeight(),i=Math.abs(s)*(0===t?-1:1);s!==i&&(e.SetHeight(i),e.SetBboxChanged())},SetScale(t){const e=this._currentAnimationFrame.GetImageInfo(),s=this.GetWorldInfo(),i=s.GetWidth()<0?-1:1,r=s.GetHeight()<0?-1:1,n=e.GetWidth()*t*i,a=e.GetHeight()*t*r;s.GetWidth()===n&&s.GetHeight()===a||(s.SetSize(n,a),s.SetBboxChanged())},async LoadURL(t,e,s){const i=this._currentAnimationFrame.GetImageInfo(),r=this.GetWorldInfo(),n=this._runtime,a=this._sdkType;if(i.GetURL()===t)return 0===e&&(r.SetSize(i.GetWidth(),i.GetHeight()),r.SetBboxChanged()),void this.Trigger(nI.Plugins.Sprite.Cnds.OnURLLoaded);const o=nI.New(nI.ImageInfo);try{if(await o.LoadDynamicAsset(n,t),!o.IsLoaded())throw new Error("image failed to load");if(this.WasReleased())return void o.Release();await o.LoadStaticTexture(n.GetRenderer(),{sampling:n.GetSampling()})}catch(t){return console.error("Load image from URL failed: ",t),void(this.WasReleased()||this.Trigger(nI.Plugins.Sprite.Cnds.OnURLFailed))}this.WasReleased()?o.Release():(i.ReplaceWith(o),a._UpdateAllCurrentTexture(),a.GetObjectClass().Dispatcher().dispatchEvent(new nI.Event("animationframeimagechange")),n.UpdateRender(),0===e&&(r.SetSize(i.GetWidth(),i.GetHeight()),r.SetBboxChanged()),await this.TriggerAsync(nI.Plugins.Sprite.Cnds.OnURLLoaded))},SetCollisions(t){this.GetWorldInfo().SetCollisionEnabled(t)},SetSolidCollisionFilter(t,e){this.GetWorldInfo().SetSolidCollisionFilter(0===t,nI.splitStringAndNormalize(e))},SetEffect(t){this.GetWorldInfo().SetBlendMode(t),this._runtime.UpdateRender()}}}self.C3.Plugins.Sprite.Exps={AnimationFrame(){return this._GetAnimFrame()},AnimationFrameTag(){return this._GetAnimFrameTag()},AnimationFrameCount(){return this._currentAnimation.GetFrameCount()},AnimationName(){return this._currentAnimation.GetName()},AnimationSpeed(){return this._GetAnimSpeed()},OriginalAnimationSpeed(){return this._currentAnimation.GetSpeed()},ImagePointX(t){return this.GetImagePoint(t)[0]},ImagePointY(t){return this.GetImagePoint(t)[1]},ImagePointZ(t){return this.GetImagePoint(t)[2]},ImagePointCount(){return this.GetImagePointCount()},ImageWidth(){return this.GetCurrentImageInfo().GetWidth()},ImageHeight(){return this.GetCurrentImageInfo().GetHeight()},PolyPointXAt(t){return this.GetCollisionPolyPoint(t)[0]},PolyPointYAt(t){return this.GetCollisionPolyPoint(t)[1]},PolyPointCount(){return this.GetCollisionPolyPointCount()}};{const aI=self.C3;aI.Plugins.Mouse=class extends aI.SDKPluginBase{constructor(t){super(t)}Release(){super.Release()}}}{let oI=function(){return cI.GetSingleGlobalInstance().GetSdkInstance()};0;const hI=self.C3,lI=self.C3X;hI.Plugins.Mouse.Type=class extends hI.SDKTypeBase{constructor(t){super(t)}Release(){super.Release()}OnCreate(){}GetScriptInterfaceClass(){return self.IMouseObjectType}};let cI=null;self.IMouseObjectType=class extends self.IObjectType{constructor(t){super(t),cI=t,t.GetRuntime()._GetCommonScriptInterfaces().mouse=this}getMouseX(t){return oI().GetMousePositionForLayer(t)[0]}getMouseY(t){return oI().GetMousePositionForLayer(t)[1]}getMousePosition(t){return oI().GetMousePositionForLayer(t)}isMouseButtonDown(t){return oI().IsMouseButtonDown(t)}setCursorStyle(t){lI.RequireString(t),oI().SetCursorStyle(t)}setCursorObjectClass(t){const e=oI(),s=e.GetRuntime()._UnwrapIObjectClass(t);e.SetCursorObjectClass(s)}}}{const uI=self.C3,_I="mouse";let dI=null;uI.Plugins.Mouse.Instance=class extends uI.SDKInstanceBase{constructor(t,e){super(t,_I),this._buttonMap=[!1,!1,!1,!1,!1],this._mouseXcanvas=0,this._mouseYcanvas=0,this._triggerButton=0,this._triggerType=0,this._triggerDir=0,this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0,this._hasPointerLock=!1,this._movementX=0,this._movementY=0,this.AddDOMMessageHandlers([["pointer-lock-change",t=>this._OnPointerLockChange(t)],["pointer-lock-error",t=>this._OnPointerLockError(t)]]);const s=this.GetRuntime().Dispatcher();this._disposables=new uI.CompositeDisposable(uI.Disposable.From(s,"pointermove",t=>this._OnPointerMove(t.data)),uI.Disposable.From(s,"pointerdown",t=>this._OnPointerDown(t.data)),uI.Disposable.From(s,"pointerup",t=>this._OnPointerUp(t.data)),uI.Disposable.From(s,"dblclick",t=>this._OnDoubleClick(t.data)),uI.Disposable.From(s,"wheel",t=>this._OnMouseWheel(t.data)),uI.Disposable.From(s,"window-blur",()=>this._OnWindowBlur()))}Release(){super.Release()}_OnPointerDown(t){"mouse"===t.pointerType&&(this._mouseXcanvas=t.pageX-this._runtime.GetCanvasClientX(),this._mouseYcanvas=t.pageY-this._runtime.GetCanvasClientY(),this._CheckButtonChanges(t.lastButtons,t.buttons))}_OnPointerMove(t){this._movementX=t.movementX,this._movementY=t.movementY,this.Trigger(uI.Plugins.Mouse.Cnds.OnMovement),this._movementX=0,this._movementY=0,"mouse"===t.pointerType&&(this._mouseXcanvas=t.pageX-this._runtime.GetCanvasClientX(),this._mouseYcanvas=t.pageY-this._runtime.GetCanvasClientY(),this._CheckButtonChanges(t.lastButtons,t.buttons))}_OnPointerUp(t){"mouse"===t.pointerType&&this._CheckButtonChanges(t.lastButtons,t.buttons)}_CheckButtonChanges(t,e){this._CheckButtonChange(t,e,1,0),this._CheckButtonChange(t,e,4,1),this._CheckButtonChange(t,e,2,2),this._CheckButtonChange(t,e,8,3),this._CheckButtonChange(t,e,16,4)}_CheckButtonChange(t,e,s,i){!(t&s)&&e&s?this._OnMouseDown(i):t&s&&!(e&s)&&this._OnMouseUp(i)}_OnMouseDown(t){this._buttonMap[t]=!0,this.Trigger(uI.Plugins.Mouse.Cnds.OnAnyClick),this._triggerButton=t,this._triggerType=0,this.Trigger(uI.Plugins.Mouse.Cnds.OnClick),this.Trigger(uI.Plugins.Mouse.Cnds.OnObjectClicked)}_OnMouseUp(t){this._buttonMap[t]&&(this._buttonMap[t]=!1,this._triggerButton=t,this.Trigger(uI.Plugins.Mouse.Cnds.OnRelease))}_OnDoubleClick(t){this._triggerButton=t.button,this._triggerType=1,this.Trigger(uI.Plugins.Mouse.Cnds.OnClick),this.Trigger(uI.Plugins.Mouse.Cnds.OnObjectClicked)}_OnMouseWheel(t){this._triggerDir=t.deltaY<0?1:0,this._wheelDeltaX=t.deltaX,this._wheelDeltaY=t.deltaY,this._wheelDeltaZ=t.deltaZ,this.Trigger(uI.Plugins.Mouse.Cnds.OnWheel)}_OnWindowBlur(){for(let t=0,e=this._buttonMap.length;t<e;++t){if(!this._buttonMap[t])return;this._buttonMap[t]=!1,this._triggerButton=t,this.Trigger(uI.Plugins.Mouse.Cnds.OnRelease)}}GetMousePositionForLayer(t){const e=this._runtime.GetMainRunningLayout(),s=this._mouseXcanvas,i=this._mouseYcanvas;if(void 0===t)return e.GetLayerByIndex(0).CanvasCssToLayer_DefaultTransform(s,i);{const r=e.GetLayer(t);return r?r.CanvasCssToLayer(s,i):[0,0]}}IsMouseButtonDown(t){return t=Math.floor(t),!!this._buttonMap[t]}_IsMouseOverCanvas(){return this._mouseXcanvas>=0&&this._mouseYcanvas>=0&&this._mouseXcanvas<this._runtime.GetCanvasCssWidth()&&this._mouseYcanvas<this._runtime.GetCanvasCssHeight()}SetCursorStyle(t){dI!==t&&(dI=t,this.PostToDOM("cursor",t))}async SetCursorObjectClass(t){if(uI.Platform.IsMobile||!t)return;const e=t.GetFirstPicked();if(!e)return;const s=e.GetWorldInfo(),i=e.GetCurrentImageInfo();if(!s||!i)return;if(dI===i)return;dI=i;const r=`url(${await i.ExtractImageToBlobURL()}) ${Math.round(s.GetOriginX()*i.GetWidth())} ${Math.round(s.GetOriginY()*i.GetHeight())}, auto`;this.PostToDOM("cursor",r)}_OnPointerLockChange(t){this._UpdatePointerLockState(t["has-pointer-lock"])}_OnPointerLockError(t){this._UpdatePointerLockState(t["has-pointer-lock"]),this.Trigger(uI.Plugins.Mouse.Cnds.OnPointerLockError)}_UpdatePointerLockState(t){this._hasPointerLock!==t&&(this._hasPointerLock=t,this._hasPointerLock?this.Trigger(uI.Plugins.Mouse.Cnds.OnPointerLocked):this.Trigger(uI.Plugins.Mouse.Cnds.OnPointerUnlocked))}GetDebuggerProperties(){const t="plugins.mouse";return[{title:t+".name",properties:[{name:t+".debugger.absolute-position",value:this._mouseXcanvas+","+this._mouseYcanvas},{name:t+".debugger.left-button",value:this._buttonMap[0]},{name:t+".debugger.middle-button",value:this._buttonMap[1]},{name:t+".debugger.right-button",value:this._buttonMap[2]},{name:t+".debugger.button-4",value:this._buttonMap[3]},{name:t+".debugger.button-5",value:this._buttonMap[4]}]},{title:t+".debugger.position-on-each-layer",properties:this._runtime.GetMainRunningLayout().GetLayers().map(t=>({name:"$"+t.GetName(),value:t.CanvasCssToLayer(this._mouseXcanvas,this._mouseYcanvas).join(", ")}))}]}}}{const pI=self.C3;pI.Plugins.Mouse.Cnds={OnClick(t,e){return this._triggerButton===t&&this._triggerType===e},OnAnyClick:()=>!0,IsButtonDown(t){return this._buttonMap[t]},OnRelease(t){return this._triggerButton===t},IsOverObject(t){const e=this._runtime.GetCurrentCondition().IsInverted(),s=[];return this._IsMouseOverCanvas()&&s.push([this._mouseXcanvas,this._mouseYcanvas]),pI.xor(this._runtime.GetCollisionEngine().TestAndSelectCanvasPointOverlap(t,s,e),e)},OnObjectClicked(t,e,s){if(t!==this._triggerButton||e!==this._triggerType)return!1;if(!this._IsMouseOverCanvas())return!1;const i=this._mouseXcanvas,r=this._mouseYcanvas;return this._runtime.GetCollisionEngine().TestAndSelectCanvasPointOverlap(s,[[i,r]],!1)},OnWheel(t){return 2===t||this._triggerDir===t},OnPointerLocked:()=>!0,OnPointerUnlocked:()=>!0,OnPointerLockError:()=>!0,HasPointerLock(){return this._hasPointerLock},OnMovement:()=>!0}}{const fI=self.C3,gI=["auto","pointer","text","crosshair","move","help","wait","none"],mI=["auto","all-scroll","none","help","pointer","progress","wait","cell","crosshair","text","vertical-text","alias","copy","move","not-allowed","grab","grabbing","col-resize","row-resize","ew-resize","ns-resize","nesw-resize","nwse-resize","zoom-in","zoom-out"];fI.Plugins.Mouse.Acts={SetCursor(t){this.SetCursorStyle(gI[t])},SetCursor2(t){this.SetCursorStyle(mI[t])},SetCursorSprite(t){this.SetCursorObjectClass(t)},RequestPointerLock(t){this._PostToDOMMaybeSync("request-pointer-lock",{unadjustedMovement:t})},ReleasePointerLock(){this.PostToDOM("release-pointer-lock")}}}self.C3.Plugins.Mouse.Exps={X(t){return this.GetMousePositionForLayer(t)[0]},Y(t){return this.GetMousePositionForLayer(t)[1]},AbsoluteX(){return this._mouseXcanvas},AbsoluteY(){return this._mouseYcanvas},MovementX(){return this._movementX},MovementY(){return this._movementY},WheelDeltaX(){return this._wheelDeltaX},WheelDeltaY(){return this._wheelDeltaY},WheelDeltaZ(){return this._wheelDeltaZ}};{const SI=self.C3;SI.Plugins.DrawingCanvas=class extends SI.SDKPluginBase{constructor(t){super(t)}Release(){super.Release()}}}{const yI=self.C3;yI.Plugins.DrawingCanvas.Type=class extends yI.SDKTypeBase{constructor(t){super(t)}Release(){super.Release()}OnCreate(){}}}{let GI=function(t){return t.map(t=>t.slice(0))},TI=function(t,e){return t.GetWorldInfo().GetZIndex()-e.GetWorldInfo().GetZIndex()},II=function(t){return AI.setFromJSON(t),AI},CI=function(t){return DI.setFromJSON(t),DI},bI=function(t){if(!NI.has(t))throw new Error("invalid line cap")},xI=function(t){MI.RequireArray(t);for(const e of t)MI.RequireArray(e),MI.RequireFiniteNumber(e[0]),MI.RequireFiniteNumber(e[1])};0;const wI=self.C3,MI=self.C3X,PI=0,vI=1,RI=3,AI=wI.New(wI.Color),DI=wI.New(wI.Color),EI=wI.New(wI.Rect),FI=wI.New(wI.Quad),OI=wI.New(wI.Quad);let BI=0;wI.Plugins.DrawingCanvas.Instance=class extends wI.SDKWorldInstanceBase{constructor(t,e){super(t),this._renderTarget=null,this._rcTex=wI.New(wI.Rect);const s=this.GetWorldInfo();this._isFixedResolution=!1,this._fixedResolutionWidth=Math.floor(s.GetWidth()),this._fixedResolutionHeight=Math.floor(s.GetHeight()),this._multisampling=0,this._texRenderTarget=null,this._drawCommands=[],this._currentPoly=[],this._drawBlendMode=0,this._drawScale=1,this._texScale=1,this._lineDashTexture=null,this._savedImageUrl="",this._snapshot=null,this._tempRect=wI.New(wI.Rect),this._deviceQuadUnrotated=wI.New(wI.Quad),this._deviceQuadRotated=wI.New(wI.Quad),e&&(this._isFixedResolution=1===e[PI],s.SetVisible(!!e[vI]),this._multisampling=[0,2,4,8][e[RI]]);const i=this._runtime.GetRenderer();this._SetDrawingBlendMode(0),i.IsWebGL()&&i.GetWebGLVersionNumber()<2&&(this._multisampling=0),this._StartTicking2()}Release(){this._renderTarget&&(this._renderTarget.GetRenderer().DeleteRenderTarget(this._renderTarget),this._renderTarget=null),this._texRenderTarget&&(this._texRenderTarget.GetRenderer().DeleteRenderTarget(this._texRenderTarget),this._texRenderTarget=null),wI.clearArray(this._drawCommands),super.Release()}IsFixedResolutionMode(){return this._isFixedResolution}_GetLineDashTexture(){return this._MaybeCreateLineDashTexture(),this._lineDashTexture}_MaybeCreateLineDashTexture(){if(this._lineDashTexture)return;const t=wI.CreateCanvas(512,8),e=t.getContext("2d");e.clearRect(0,0,512,8),e.fillStyle="white",e.fillRect(0,0,256,8),this._lineDashTexture=this._runtime.GetRenderer().CreateStaticTexture(t,{wrapX:"repeat",sampling:this._runtime.GetSampling()})}_SetDrawingBlendMode(t){this._drawBlendMode=t}_ApplyCurrentDrawingBlendMode(t){t.SetBlendMode(this._drawBlendMode)}_AddDrawCommand(t){this._drawCommands.push(t),this._runtime.UpdateRender()}_SetFixedResolutionMode(t,e){this._isFixedResolution=!0,this._fixedResolutionWidth=Math.floor(t),this._fixedResolutionHeight=Math.floor(e)}_SetAutoResolutionMode(){this._isFixedResolution=!1}_ClearCanvas(t){wI.clearArray(this._drawCommands),this._AddDrawCommand(new wI.Plugins.DrawingCanvas.DrawCommand.ClearCanvas(t))}_ClearRect(t,e,s,i,r){t!==s&&e!==i&&this._AddDrawCommand(new wI.Plugins.DrawingCanvas.DrawCommand.ClearRect(t,e,s,i,r))}_FillRect(t,e,s,i,r){t!==s&&e!==i&&this._AddDrawCommand(new wI.Plugins.DrawingCanvas.DrawCommand.FillRect(t,e,s,i,r))}_FillLinearGradient(t,e,s,i,r,n,a){t!==s&&e!==i&&this._AddDrawCommand(new wI.Plugins.DrawingCanvas.DrawCommand.FillLinearGradient(t,e,s,i,r,n,a))}_FillEllipse(t,e,s,i,r,n){s<=0||i<=0||this._AddDrawCommand(new wI.Plugins.DrawingCanvas.DrawCommand.FillEllipse(t,e,s,i,r,n))}_OutlineEllipse(t,e,s,i,r,n,a){s<=0||i<=0||n<=0||this._AddDrawCommand(new wI.Plugins.DrawingCanvas.DrawCommand.OutlineEllipse(t,e,s,i,r,n,a))}_OutlineRect(t,e,s,i,r,n){t===s||e===i||n<=0||this._AddDrawCommand(new wI.Plugins.DrawingCanvas.DrawCommand.OutlineRect(t,e,s,i,r,n))}_Line(t,e,s,i,r,n,a){t===s&&e===i||n<=0||this._AddDrawCommand(new wI.Plugins.DrawingCanvas.DrawCommand.Line(t,e,s,i,r,n,a))}_LineDashed(t,e,s,i,r,n,a,o){if(t===s&&e===i||n<=0||a<=0)return;const h=this._GetLineDashTexture();this._AddDrawCommand(new wI.Plugins.DrawingCanvas.DrawCommand.LineDashed(t,e,s,i,r,n,a,h,o))}_LinePoly(t,e,s,i){t.length<2||s<=0||this._AddDrawCommand(new wI.Plugins.DrawingCanvas.DrawCommand.LinePoly(GI(t),e,s,i))}_LineDashedPoly(t,e,s,i,r){if(t.length<2||s<=0||i<=0)return;const n=this._GetLineDashTexture();this._AddDrawCommand(new wI.Plugins.DrawingCanvas.DrawCommand.LineDashedPoly(GI(t),e,s,i,n,r))}_FillPoly(t,e,s){t.length<3||this._AddDrawCommand(new wI.Plugins.DrawingCanvas.DrawCommand.FillPoly(GI(t),e,s))}_SetDrawBlend(t){this._AddDrawCommand(new wI.Plugins.DrawingCanvas.DrawCommand.SetDrawBlend(t))}_PasteInstances(t,e){const s=this.GetWorldInfo(),i=s.GetBoundingBox(),r=s.GetBoundingQuad(),n=t.filter(t=>{const e=t.GetWorldInfo();return e&&i.intersectsRect(e.GetBoundingBox())&&(0===s.GetAngle()||r.intersectsQuad(e.GetBoundingQuad()))});if(0===n.length)return;n.sort(TI);let a=null;const o=new Promise(t=>a=t);return this._AddDrawCommand(new wI.Plugins.DrawingCanvas.DrawCommand.DrawInstances(n,e,s,a)),o}_GetPixelScale(){return 1/(this._drawScale*this._texScale)}_UpdateRenderTargetSize(t,e,s){this._renderTarget&&t.DeleteRenderTarget(this._renderTarget),this._renderTarget=t.CreateRenderTarget({width:e,height:s,sampling:this._runtime.GetSampling(),isSampled:0===this._multisampling,canReadPixels:0===this._multisampling,canUpdate:0===this._multisampling,multisampling:this._multisampling}),this._multisampling>0&&(this._texRenderTarget&&t.DeleteRenderTarget(this._texRenderTarget),this._texRenderTarget=t.CreateRenderTarget({width:e,height:s,sampling:this._runtime.GetSampling(),isSampled:!0,canReadPixels:!0,canUpdate:!0})),t.SetTexture(null)}_GetRenderTarget(){return this._renderTarget}_GetTexRenderTarget(){return this._texRenderTarget}GetMultisampling(){return this._multisampling}_SetRenderTargetDeviceTransform(t){this._runtime.GetCanvasManager().SetDeviceTransform(t,this._renderTarget.GetWidth(),this._renderTarget.GetHeight(),!1)}HasAnyDrawingCommandInQueue(){return this._drawCommands.some(t=>!(t instanceof wI.Plugins.DrawingCanvas.DrawCommand.SaveImage))}_CalculateUnrotatedDeviceCoords(t,e){const s=this.GetWorldInfo(),i=s.GetLayer(),r=i.GetLayout(),n=s.GetAngle(),a=i.GetOwnAngle(),o=r.GetAngle();0===n&&0===a&&0===o||(r.SetAngle(0),i.SetAngle(0),s.SetAngle(0),s.SetBboxChanged());const h=s.GetBoundingQuad(),[l,c]=i.LayerToDrawSurface(h.getTlx(),h.getTly()),[u,_]=i.LayerToDrawSurface(h.getBrx(),h.getBry()),d=l-Math.round(l),p=c-Math.round(c);t.set(l,c,u,_),t.offset(-d,-p),t.normalize(),e.setFromRect(t),0===n&&0===a&&0===o||(r.SetAngle(o),i.SetAngle(a),s.SetAngle(n),s.SetBboxChanged())}_CalculateRotatedDeviceCoords(t){const e=this.GetWorldInfo(),s=e.GetLayer(),i=s.GetLayout(),r=s.GetOwnAngle(),n=i.GetAngle();0===r&&0===n||(i.SetAngle(0),s.SetAngle(0));const a=e.GetBoundingQuad(),[o,h]=s.LayerToDrawSurface(a.getTlx(),a.getTly()),[l,c]=s.LayerToDrawSurface(a.getTrx(),a.getTry()),[u,_]=s.LayerToDrawSurface(a.getBrx(),a.getBry()),[d,p]=s.LayerToDrawSurface(a.getBlx(),a.getBly()),f=o-Math.round(o),g=h-Math.round(h);t.set(o,h,l,c,u,_,d,p),t.offset(f,g),0===r&&0===n||(i.SetAngle(n),s.SetAngle(r))}_CalculateSurfaceDeviceSize(){const t=this._runtime.GetRenderer(),e=this._tempRect;this._CalculateUnrotatedDeviceCoords(e,this._deviceQuadUnrotated),this._CalculateRotatedDeviceCoords(this._deviceQuadRotated);let s=0,i=0;if(this._isFixedResolution)s=this._fixedResolutionWidth,i=this._fixedResolutionHeight,t.IsWebGL()?this._rcTex.set(0,1,1,0):this._rcTex.set(0,0,1,1);else{this.GetWorldInfo().GetLayer().RendersIn3DMode()&&this._deviceQuadRotated.getBoundingBox(e);const r=.01,n=e.width(),a=e.height();s=n-Math.floor(n)<r?Math.floor(n):Math.ceil(n),i=a-Math.floor(a)<r?Math.floor(a):Math.ceil(a),t.IsWebGL()?this._rcTex.set(0,1,e.width()/s,1-e.height()/i):this._rcTex.set(0,0,e.width()/s,e.height()/i)}const r=t.GetMaxTextureSize(),n=Math.max(s,i);return n>r?(this._texScale=r/n,s=Math.round(s*this._texScale),i=Math.round(i*this._texScale)):this._texScale=1,[s,i]}_OnResolutionChanged(){this.DispatchScriptEvent("resolutionchange"),this.Trigger(wI.Plugins.DrawingCanvas.Cnds.OnResolutionChanged)}_MaybeCreateRenderTarget(){if(this._renderTarget)return;const[t,e]=this._CalculateSurfaceDeviceSize();t<=0||e<=0||(this._drawScale=EI.width()/this.GetWorldInfo().GetWidth(),this._UpdateRenderTargetSize(this._runtime.GetRenderer(),t,e),this._OnResolutionChanged())}Tick2(){const t=this._runtime.GetRenderer(),e=this.GetWorldInfo(),s=this._tempRect;++BI;const[i,r]=this._CalculateSurfaceDeviceSize();if(i<=0||r<=0)return void--BI;this._drawScale=this._isFixedResolution?1:s.width()/e.GetWidth();const n=this._drawScale*this._texScale,a=!this._renderTarget||this._renderTarget.GetWidth()!==i||this._renderTarget.GetHeight()!==r;if(a&&this._OnResolutionChanged(),this._drawCommands.length>0||!this._renderTarget){(!this._renderTarget||a&&this.HasAnyDrawingCommandInQueue())&&this._UpdateRenderTargetSize(t,i,r),t.SetRenderTarget(this._renderTarget),this._SetRenderTargetDeviceTransform(t),this._ApplyCurrentDrawingBlendMode(t),t.IsWebGPU()&&this._multisampling>0&&t.SetRenderingToMultisampleCount(this._multisampling);for(const e of this._drawCommands)e.Do(t,n,this);wI.clearArray(this._drawCommands),t.SetAlphaBlend(),t.IsWebGPU()&&this._multisampling>0&&t.SetRenderingToMultisampleCount(0),this._multisampling>0&&(t.SetRenderTarget(this._texRenderTarget),t.CopyRenderTarget(this._renderTarget,"crop"))}--BI}Draw(t){const e=this.GetWorldInfo(),s=e.GetLayer(),i=this._runtime.GetCanvasManager(),r=t.GetRenderTarget();let n=this._deviceQuadUnrotated;if(!this._renderTarget)return;t.IsWebGPU()&&t._MaybeDoPendingClearRenderPass(this._renderTarget),0===this._multisampling?t.SetTexture(this._renderTarget.GetTexture()):t.SetTexture(this._texRenderTarget.GetTexture());let a=!1,o=!1;if(BI>0)this._inst._IsDrawingWithEffects()?n=e.GetBoundingQuad():(i.SetDeviceTransform(t,r.GetWidth(),r.GetHeight(),!1),a=!0,n=this._deviceQuadRotated);else if(0===e.GetAngle()&&0===s.GetAngle()&&0===e.GetTotalZElevation()&&!e.HasMesh()&&s.RendersIn2DMode())if(t.IsWebGL())i.SetDeviceTransform(t),a=!0;else{t.SetNormalizedCoordsProgramVariant(!0),o=!0;const[e,s]=t.GetRenderTargetSize(r);OI.copy(n),OI.divide(e,s),n=OI}else n=e.GetBoundingQuad();e.HasMesh()?this._DrawMesh(t,e):t.Quad3(n,this._rcTex),a&&s._SetTransform(t,!1),o&&t.SetNormalizedCoordsProgramVariant(!1),t.SetTexture(null)}_DrawMesh(t,e){const s=e.GetTransformedMesh();e.IsMeshChanged()&&(e.CalculateBbox(EI,FI,!1),s.CalculateTransformedMesh(e.GetSourceMesh(),FI,this._rcTex),e.SetMeshChanged(!1)),s.Draw(t,e.GetTotalZElevation())}GetSnapshotPixel(t,e){if(!this._snapshot)return[0,0,0,0];const s=this._snapshot.width,i=this._snapshot.height;if(t=Math.floor(t),e=this._runtime.GetRenderer().IsWebGL()?i-1-Math.floor(e):Math.floor(e),t<0||e<0||t>=s||e>=i)return[0,0,0,0];const r=this._snapshot.data,n=e*s*4+4*t;let a=r[n]/255,o=r[n+1]/255,h=r[n+2]/255,l=r[n+3]/255;return 0!==l&&(a/=l,o/=l,h/=l),[100*a,100*o,100*h,100*l]}SetSnapshotPixel(t,e,s){if(!this._snapshot)return[0,0,0,0];AI.setFromRgbValue(s),AI.premultiply();const i=this._snapshot.width,r=this._snapshot.height;if(t=Math.floor(t),e=r-1-Math.floor(e),t<0||e<0||t>=i||e>=r)return;const n=this._snapshot.data,a=e*i*4+4*t;n[a]=Math.floor(255*AI.getR()),n[a+1]=Math.floor(255*AI.getG()),n[a+2]=Math.floor(255*AI.getB()),n[a+3]=Math.floor(255*AI.getA())}GetImagePixelData(){return new Promise(t=>{this._AddDrawCommand(new wI.Plugins.DrawingCanvas.DrawCommand.SaveImage(async e=>{const s=e.data.buffer,i=e.width,r=e.height,n=await this._runtime.AddJob("ProcessImageData",{buffer:s,width:i,height:r,unpremultiply:!0,flipY:this._runtime.GetRenderer().IsWebGL()},[s]);t(new ImageData(new Uint8ClampedArray(n),i,r))}))})}LoadImagePixelData(t,e,s){if(this._MaybeCreateRenderTarget(),!this._renderTarget)throw new Error("invalid canvas size");if(t.width!==this._renderTarget.GetWidth()||t.height!==this._renderTarget.GetHeight())throw new Error(`wrong size ImageData: expected ${this._renderTarget.GetWidth()} x ${this._renderTarget.GetHeight()}, got ${t.width} x ${t.height}`);wI.clearArray(this._drawCommands);const i=this._runtime.GetRenderer();if(this._texRenderTarget){const r=i.GetRenderTarget(),n=this._texRenderTarget.GetTexture();i.UpdateTexture(t,n,{premultiplyAlpha:!!e,flipY:!!s}),i.SetRenderTarget(this._renderTarget),i.CopyRenderTarget(this._texRenderTarget,"crop"),i.SetRenderTarget(r)}else{const r=this._renderTarget.GetTexture();i.UpdateTexture(t,r,{premultiplyAlpha:!!e,flipY:!!s})}this._runtime.UpdateRender()}SaveImage(t,e,s){return new Promise(i=>{this._AddDrawCommand(new wI.Plugins.DrawingCanvas.DrawCommand.SaveImage(async s=>{const r=s.data.buffer,n=s.width,a=s.height,o=this._runtime.GetRenderer().IsWebGL(),h=await this._runtime.AddJob("ProcessImageData",{buffer:r,width:n,height:a,unpremultiply:!0,flipY:o&&!wI.Supports.ImageBitmapOptions},[r]);let l;if(s=new ImageData(new Uint8ClampedArray(h),n,a),wI.Supports.ImageBitmapOptions){const i=await createImageBitmap(s,{premultiplyAlpha:"none",imageOrientation:o?"flipY":"none"});l=await wI.DrawableToBlob(i,t,e)}else l=await wI.ImageDataToBlob(s,t,e);this._savedImageUrl&&URL.revokeObjectURL(this._savedImageUrl),this._savedImageUrl=URL.createObjectURL(l),this.Trigger(wI.Plugins.DrawingCanvas.Cnds.OnSavedImage),i(l)},s))})}GetScriptInterfaceClass(){return self.IDrawingCanvasInstance}};const LI=new WeakMap,kI=["horizontal","vertical"],NI=new Set(["butt","square"]),UI=new Map([["normal",0],["additive",1],["copy",3],["destination-over",4],["source-in",5],["destination-in",6],["source-out",7],["destination-out",8],["source-atop",9],["destination-atop",10],["lighten",11],["darken",12],["multiply",13],["screen",14]]);self.IDrawingCanvasInstance=class extends self.IWorldInstance{constructor(){super(),LI.set(this,self.IInstance._GetInitInst().GetSdkInstance())}setFixedResolutionMode(t,e){MI.RequireFiniteNumber(t),MI.RequireFiniteNumber(e),LI.get(this)._SetFixedResolutionMode(t,e)}setAutoResolutionMode(){LI.get(this)._SetAutoResolutionMode()}clearCanvas(t){MI.RequireArray(t),LI.get(this)._ClearCanvas(II(t))}clearRect(t,e,s,i,r){MI.RequireFiniteNumber(t),MI.RequireFiniteNumber(e),MI.RequireFiniteNumber(s),MI.RequireFiniteNumber(i),MI.RequireArray(r),LI.get(this)._ClearRect(t,e,s,i,II(r))}fillRect(t,e,s,i,r){MI.RequireFiniteNumber(t),MI.RequireFiniteNumber(e),MI.RequireFiniteNumber(s),MI.RequireFiniteNumber(i),MI.RequireArray(r),LI.get(this)._FillRect(t,e,s,i,II(r))}fillLinearGradient(t,e,s,i,r,n,a="horizontal"){MI.RequireFiniteNumber(t),MI.RequireFiniteNumber(e),MI.RequireFiniteNumber(s),MI.RequireFiniteNumber(i),MI.RequireArray(r),MI.RequireArray(n);const o=kI.indexOf(a);if(o<0)throw new Error("invalid gradient direction");LI.get(this)._FillLinearGradient(t,e,s,i,II(r),CI(n),o)}fillEllipse(t,e,s,i,r,n=!0){MI.RequireFiniteNumber(t),MI.RequireFiniteNumber(e),MI.RequireFiniteNumber(s),MI.RequireFiniteNumber(i),MI.RequireArray(r),LI.get(this)._FillEllipse(t,e,s,i,II(r),!!n)}outlineEllipse(t,e,s,i,r,n,a=!0){MI.RequireFiniteNumber(t),MI.RequireFiniteNumber(e),MI.RequireFiniteNumber(s),MI.RequireFiniteNumber(i),MI.RequireArray(r),MI.RequireFiniteNumber(n),LI.get(this)._OutlineEllipse(t,e,s,i,II(r),n,!!a)}outlineRect(t,e,s,i,r,n){MI.RequireFiniteNumber(t),MI.RequireFiniteNumber(e),MI.RequireFiniteNumber(s),MI.RequireFiniteNumber(i),MI.RequireArray(r),MI.RequireFiniteNumber(n),LI.get(this)._OutlineRect(t,e,s,i,II(r),n)}line(t,e,s,i,r,n,a="butt"){MI.RequireFiniteNumber(t),MI.RequireFiniteNumber(e),MI.RequireFiniteNumber(s),MI.RequireFiniteNumber(i),MI.RequireArray(r),MI.RequireFiniteNumber(n),bI(a),LI.get(this)._Line(t,e,s,i,II(r),n,a)}lineDashed(t,e,s,i,r,n,a,o="butt"){MI.RequireFiniteNumber(t),MI.RequireFiniteNumber(e),MI.RequireFiniteNumber(s),MI.RequireFiniteNumber(i),MI.RequireArray(r),MI.RequireFiniteNumber(n),MI.RequireFiniteNumber(a),bI(o),LI.get(this)._LineDashed(t,e,s,i,II(r),n,a,o)}linePoly(t,e,s,i="butt"){xI(t),MI.RequireArray(e),MI.RequireFiniteNumber(s),bI(i),LI.get(this)._LinePoly(t,II(e),s,i)}lineDashedPoly(t,e,s,i,r="butt"){xI(t),MI.RequireArray(e),MI.RequireFiniteNumber(s),MI.RequireFiniteNumber(i),bI(r),LI.get(this)._LineDashedPoly(t,II(e),s,i,r)}fillPoly(t,e,s=!1){xI(t),MI.RequireArray(e),LI.get(this)._FillPoly(t,II(e),!!s)}setDrawBlend(t){const e=UI.get(t);if("number"!=typeof e)throw new Error("invalid blend mode");LI.get(this)._SetDrawBlend(e)}pasteInstances(t,e=!0){MI.RequireArray(t);const s=LI.get(this),i=s.GetRuntime();return s._PasteInstances(t.map(t=>i._UnwrapIWorldInstance(t)),!!e)}getImagePixelData(){return LI.get(this).GetImagePixelData()}loadImagePixelData(t,e=!1){MI.RequireInstanceOf(t,ImageData);const s=LI.get(this);s.LoadImagePixelData(t,e,s.GetRuntime().GetRenderer().IsWebGL())}saveImage(t,e,s){return MI.RequireOptionalString(t),MI.RequireOptionalNumber(e),MI.RequireOptionalInstanceOf(s,DOMRect),s&&(s=wI.Rect.FromObject(s)),LI.get(this).SaveImage(t||"image/png",e,s)}get surfaceDeviceWidth(){const t=LI.get(this);t._MaybeCreateRenderTarget();const e=t._GetRenderTarget();if(!e)throw new Error("invalid canvas size");return e.GetWidth()}get surfaceDeviceHeight(){const t=LI.get(this);t._MaybeCreateRenderTarget();const e=t._GetRenderTarget();if(!e)throw new Error("invalid canvas size");return e.GetHeight()}getSurfaceDeviceSize(){const t=LI.get(this);t._MaybeCreateRenderTarget();const e=t._GetRenderTarget();if(!e)throw new Error("invalid canvas size");return[e.GetWidth(),e.GetHeight()]}get pixelScale(){return LI.get(this)._GetPixelScale()}}}self.C3.Plugins.DrawingCanvas.Cnds={OnSavedImage:()=>!0,OnSnapshot:()=>!0,OnResolutionChanged:()=>!0};{let WI=function(t){return zI.setFromRgbValue(t),zI},jI=function(t){return HI.setFromRgbValue(t),HI};0;const VI=self.C3,zI=VI.New(VI.Color),HI=VI.New(VI.Color);VI.Plugins.DrawingCanvas.Acts={SetEffect(t){this.GetWorldInfo().SetBlendMode(t),this._runtime.UpdateRender()},SetResolutionMode(t,e,s){1===t?this._SetFixedResolutionMode(e,s):this._SetAutoResolutionMode()},ClearCanvas(t){this._ClearCanvas(WI(t))},ClearRect(t,e,s,i,r){this._ClearRect(t,e,s,i,WI(r))},FillRect(t,e,s,i,r){this._FillRect(t,e,s,i,WI(r))},FillLinearGradient(t,e,s,i,r,n,a){this._FillLinearGradient(t,e,s,i,WI(r),jI(n),a)},FillEllipse(t,e,s,i,r,n){this._FillEllipse(t,e,s,i,WI(r),0!==n)},OutlineEllipse(t,e,s,i,r,n,a){this._OutlineEllipse(t,e,s,i,WI(r),n,0!==a)},OutlineRect(t,e,s,i,r,n){this._OutlineRect(t,e,s,i,WI(r),n)},Line(t,e,s,i,r,n,a){const o=0===a?"butt":"square";this._Line(t,e,s,i,WI(r),n,o)},LineDashed(t,e,s,i,r,n,a,o){const h=0===o?"butt":"square";this._LineDashed(t,e,s,i,WI(r),n,a,h)},AddPolyPoint(t,e){this._currentPoly.push([t,e])},ResetPoly(){VI.clearArray(this._currentPoly)},LinePoly(t,e,s){const i=0===s?"butt":"square";this._LinePoly(this._currentPoly,WI(t),e,i)},LineDashedPoly(t,e,s,i){const r=0===i?"butt":"square";this._LineDashedPoly(this._currentPoly,WI(t),e,s,r)},FillPoly(t,e){this._FillPoly(this._currentPoly,WI(t),e)},SetDrawBlend(t){t>=2&&t++,this._SetDrawBlend(t)},PasteObject(t,e){if(t)return this._PasteInstances(t.GetCurrentSol().GetInstances(),0!==e)},SaveImage(t,e,s,i,r,n){const a=0===t?"image/png":"image/jpeg";e/=100;const o=VI.New(VI.Rect);return o.setWH(s,i,r,n),this.SaveImage(a,e,o)},SaveSnapshot(){return new Promise(t=>{this._AddDrawCommand(new VI.Plugins.DrawingCanvas.DrawCommand.SaveImage(e=>{this._snapshot=e,this.Trigger(VI.Plugins.DrawingCanvas.Cnds.OnSnapshot),t()}))})},ClearSnapshot(){this._snapshot=null},SnapshotSetPixel(t,e,s){this.SetSnapshotPixel(t,e,s)},LoadSnapshot(){this._snapshot&&this._renderTarget&&this._snapshot.width===this._renderTarget.GetWidth()&&this._snapshot.height===this._renderTarget.GetHeight()&&this.LoadImagePixelData(this._snapshot,!1)}}}self.C3.Plugins.DrawingCanvas.Exps={SavedImageURL(){return this._savedImageUrl},SnapshotRedAt(t,e){return this.GetSnapshotPixel(t,e)[0]},SnapshotGreenAt(t,e){return this.GetSnapshotPixel(t,e)[1]},SnapshotBlueAt(t,e){return this.GetSnapshotPixel(t,e)[2]},SnapshotAlphaAt(t,e){return this.GetSnapshotPixel(t,e)[3]},SnapshotWidth(){return this._snapshot?this._snapshot.width:0},SnapshotHeight(){return this._snapshot?this._snapshot.height:0},PixelScale(){return this._GetPixelScale()},SurfaceDeviceWidth(){const t=this._GetRenderTarget();return t?t.GetWidth():0},SurfaceDeviceHeight(){const t=this._GetRenderTarget();return t?t.GetHeight():0}};{const YI=self.C3,XI=YI.New(YI.Quad),qI=YI.New(YI.Rect),JI=YI.New(YI.Quad),QI=YI.New(YI.Vector2);YI.Plugins.DrawingCanvas.DrawCommand=class{constructor(){}Do(t){throw new Error("required override")}};const KI=YI.Plugins.DrawingCanvas.DrawCommand;KI.SaveImage=class extends KI{constructor(t,e){super(),this._callback=t,this._areaRect=e}Do(t,e,s){let i=t.GetRenderTarget();if(i.GetMultisampling()>=2){const e=s._GetTexRenderTarget();t.SetRenderTarget(e),t.CopyRenderTarget(i,"crop"),t.SetRenderTarget(i),i=e}t.ReadBackRenderTargetToImageData(i,!1,this._areaRect).then(this._callback)}},KI.ClearCanvas=class extends KI{constructor(t){super(),this._color=YI.New(YI.Color,t),this._color.premultiply()}Do(t){t.Clear(this._color)}},KI.ClearRect=class extends KI{constructor(t,e,s,i,r){super(),this._rect=YI.New(YI.Rect),this._rect.set(t,e,s,i),this._color=YI.New(YI.Color,r),this._color.premultiply()}Do(t,e,s){this._rect.multiply(e,e),t.SetColorFillMode(),t.SetColor(this._color),t.SetBlendMode(3),t.Rect(this._rect),s._ApplyCurrentDrawingBlendMode(t)}},KI.FillRect=class extends KI{constructor(t,e,s,i,r){super(),this._rect=YI.New(YI.Rect),this._rect.set(t,e,s,i),this._color=YI.New(YI.Color,r),this._color.premultiply()}Do(t,e){t.SetColorFillMode(),t.SetColor(this._color),this._rect.multiply(e,e),t.Rect(this._rect)}},KI.FillLinearGradient=class extends KI{constructor(t,e,s,i,r,n,a){super(),this._rect=YI.New(YI.Rect),this._rect.set(t,e,s,i),this._color1=YI.New(YI.Color,r),this._color2=YI.New(YI.Color,n),this._dir=a}Do(t,e){t.SetLinearGradientFillMode(),t.SetColor(this._color1),t.SetGradientColor(this._color2),this._rect.multiply(e,e),XI.setFromRect(this._rect),0===this._dir?JI.set(0,0,1,0,1,1,0,1):JI.set(0,1,0,0,1,0,1,1),t.Quad4(XI,JI)}},KI.FillEllipse=class extends KI{constructor(t,e,s,i,r,n){super(),this._rect=YI.New(YI.Rect),this._rect.set(t-s,e-i,t+s,e+i),this._color=YI.New(YI.Color,r),this._color.premultiply(),this._isSmooth=n}Do(t,e){this._rect.multiply(e,e),this._isSmooth?(t.SetSmoothEllipseFillMode(),t.SetColor(this._color),this._rect.inflate(.5,.5),t.SetEllipseParams(1/this._rect.width(),1/this._rect.height()),t.Rect(this._rect)):(t.SetHardEllipseFillMode(),t.SetColor(this._color),t.Rect(this._rect))}},KI.OutlineEllipse=class extends KI{constructor(t,e,s,i,r,n,a){super(),this._rect=YI.New(YI.Rect),this._rect.set(t-s,e-i,t+s,e+i),this._color=YI.New(YI.Color,r),this._color.premultiply(),this._thickness=n,this._isSmooth=a}Do(t,e){this._rect.multiply(e,e),this._isSmooth?(t.SetSmoothEllipseOutlineMode(),t.SetColor(this._color),this._rect.inflate(.5,.5),t.SetEllipseParams(1/this._rect.width(),1/this._rect.height(),this._thickness*e),t.Rect(this._rect)):(t.SetHardEllipseOutlineMode(),t.SetEllipseParams(1/this._rect.width(),1/this._rect.height(),this._thickness*e),t.SetColor(this._color),t.Rect(this._rect))}},KI.OutlineRect=class extends KI{constructor(t,e,s,i,r,n){super(),this._rect=YI.New(YI.Rect),this._rect.set(t,e,s,i),this._color=YI.New(YI.Color,r),this._color.premultiply(),this._thickness=n}Do(t,e){t.SetColorFillMode(),t.SetColor(this._color),t.PushLineCapZag(),t.PushLineWidth(this._thickness*e),this._rect.multiply(e,e),t.LineRect2(this._rect),t.PopLineCap(),t.PopLineWidth()}},KI.Line=class extends KI{constructor(t,e,s,i,r,n,a){super(),this._rect=YI.New(YI.Rect),this._rect.set(t,e,s,i),this._color=YI.New(YI.Color,r),this._color.premultiply(),this._thickness=n,this._cap=a}Do(t,e){t.SetColorFillMode(),t.SetColor(this._color),t.PushLineCap(this._cap),t.PushLineWidth(this._thickness*e);const s=this._rect;s.multiply(e,e),t.Line(s.getLeft(),s.getTop(),s.getRight(),s.getBottom()),t.PopLineCap(),t.PopLineWidth()}},KI.LinePoly=class extends KI{constructor(t,e,s,i){super(),this._poly=t,this._color=YI.New(YI.Color,e),this._color.premultiply(),this._thickness=s,this._cap=i}Do(t,e){t.SetColorFillMode(),t.SetColor(this._color),t.PushLineCap(this._cap),t.PushLineWidth(this._thickness*e);const s=this._poly;for(let i=0,r=s.length;i<r;++i){const n=(i+1)%r,a=s[i][0]*e,o=s[i][1]*e,h=s[n][0]*e,l=s[n][1]*e;t.Line(a,o,h,l)}t.PopLineCap(),t.PopLineWidth()}},KI.LineDashed=class extends KI{constructor(t,e,s,i,r,n,a,o,h){super(),this._rect=YI.New(YI.Rect),this._rect.set(t,e,s,i),this._color=YI.New(YI.Color,r),this._color.premultiply(),this._thickness=n,this._dashLength=a,this._dashTex=o,this._cap=h}Do(t,e){t.SetTextureFillMode(),t.SetTexture(this._dashTex),t.SetColor(this._color),t.PushLineCap(this._cap),t.PushLineWidth(this._thickness*e);const s=this._rect,i=YI.distanceTo(s.getLeft(),s.getTop(),s.getRight(),s.getBottom())/(2*this._dashLength);s.multiply(e,e),t.TexturedLine(s.getLeft(),s.getTop(),s.getRight(),s.getBottom(),0,i),t.PopLineCap(),t.PopLineWidth()}},KI.LineDashedPoly=class extends KI{constructor(t,e,s,i,r,n){super(),this._poly=t,this._color=YI.New(YI.Color,e),this._color.premultiply(),this._thickness=s,this._dashLength=i,this._dashTex=r,this._cap=n}Do(t,e){t.SetTextureFillMode(),t.SetTexture(this._dashTex),t.SetColor(this._color),t.PushLineCap(this._cap),t.PushLineWidth(this._thickness*e);let s=0;const i=this._poly;for(let r=0,n=i.length;r<n;++r){const a=(r+1)%n,o=i[r][0],h=i[r][1],l=i[a][0],c=i[a][1],u=s+YI.distanceTo(o,h,l,c)/(2*this._dashLength);t.TexturedLine(o*e,h*e,l*e,c*e,s,u),s=u-Math.floor(u)}t.PopLineCap(),t.PopLineWidth()}},KI.FillPoly=class extends KI{constructor(t,e,s){super(),this._poly=t,this._isConvex=s,this._color=YI.New(YI.Color,e),this._color.premultiply()}Do(t,e){t.SetColorFillMode(),t.SetColor(this._color);const s=this._poly;for(let t=0,i=s.length;t<i;++t){const i=s[t];i[0]*=e,i[1]*=e}if(this._isConvex)t.ConvexPoly(s.flat());else{const e=self.polyDecomp;if(!e.isSimple(s))return;e.makeCCW(s),e.removeCollinearPoints(s,YI.toRadians(.1));const i=e.quickDecomp(s,[],[],[],25,1e3);for(const e of i)t.ConvexPoly(e.flat())}}},KI.SetDrawBlend=class extends KI{constructor(t){super(),this._blendIndex=t}Do(t,e,s){s._SetDrawingBlendMode(this._blendIndex),s._ApplyCurrentDrawingBlendMode(t)}},KI.DrawInstances=class extends KI{constructor(t,e,s,i){super();const r=s.GetLayer();this._includeFx=e,this._resolve=i,this._layoutTransform=r.GetLayout().SaveTransform(),this._layerTransforms=new Map,this._layerTransforms.set(r,r.SaveTransform()),this._instances=t.map(t=>this._SaveInstanceState(t,s))}_SaveInstanceState(t,e){const s=e.GetAngle(),i=e.GetLayer(),r=t.GetWorldInfo(),n=r.GetLayer(),a=r.GetX(),o=r.GetY(),h=r.GetWidth(),l=r.GetHeight(),c=r.GetAngle();this._layerTransforms.has(n)||this._layerTransforms.set(n,n.SaveTransform());const u=i.IsTransformCompatibleWith(n);if(!u){const[t,e]=n.LayerToDrawSurface(a,o),[s,c]=i.DrawSurfaceToLayer(t,e);r.SetXY(s,c);const u=n.GetNormalScale()/i.GetNormalScale();r.SetSize(h*u,l*u);const _=i.GetOwnAngle()-n.GetOwnAngle();r.OffsetAngle(_)}if(0!==s){const t=e.GetBoundingQuad(),i=t.midX(),n=t.midY(),h=-e.GetSinAngle(),l=e.GetCosAngle();QI.set(a,o),QI.offset(-i,-n),QI.rotatePrecalc(h,l),QI.offset(i,n),r.SetXY(QI.getX(),QI.getY()),r.OffsetAngle(-s)}0===s&&u||r.SetBboxChanged();const _=[t,t.SaveToJson("visual-state")];return 0===s&&u||(r.SetXY(a,o),r.SetSize(h,l),r.SetAngle(c),r.SetBboxChanged()),_}Do(t,e,s){const i=s.GetRuntime().GetCanvasManager(),r=s.GetWorldInfo().GetLayer(),n=r.GetLayout(),a=r.GetViewport(),o=s.GetWorldInfo().GetBoundingBox(),h=s._GetRenderTarget(),l=s.GetMultisampling()>=2,c=this._includeFx,u=n.SaveTransform();n.RestoreTransform(this._layoutTransform);const _=new Map;for(const[t,e]of this._layerTransforms)_.set(t,t.SaveTransform()),t.RestoreTransform(e);i.SetIsPastingToDrawingCanvas(!0);const d=(a.width()-o.width())/-2,p=(a.height()-o.height())/-2,[f,g]=r.LayerToDrawSurface(o.getLeft(),o.getTop());i.SetDeviceTransformOffset(f,g);const m=d+(o.getLeft()-a.getLeft()),S=p+(o.getTop()-a.getTop()),y=h.GetHeight();let G=1;G=s.IsFixedResolutionMode()?h.GetWidth()/Math.floor(o.width())/r.GetNormalScale():i.GetRenderScale()*self.devicePixelRatio;const T=y/G;t.SetProjectionMatrix(h.GetProjectionMatrix()),r._SetTransform(t,!1,m,S,T);for(let e=0,n=this._instances.length;e<n;++e){const n=this._instances[e],a=n[0],o=n[1];if(a.IsDestroyed())continue;const u=a.GetWorldInfo(),_=a.SaveToJson("visual-state");if(a.LoadFromJson(o,"visual-state"),u.GetBoundingBox(),!c||!u.HasAnyActiveEffect()||l&&u.GetInstanceEffectList().HasAnyActiveBackgroundBlendingEffect())r._DrawInstance(a,u,t);else{const e={drawContentHook:(t,e,s)=>{i.SetDeviceTransformOffset(0,0),r._SetTransform(e),s(),i.SetDeviceTransformOffset(f,g),t._SetDeviceTransform(e)},compositOffX:f,compositOffY:g,updateOwnProjection:!0};s.IsFixedResolutionMode()&&(s._CalculateRotatedDeviceCoords(XI),XI.getBoundingBox(qI),e.compositRtWidth=qI.width(),e.compositRtHeight=qI.height()),a._SetIsDrawingWithEffects(!0),r._DrawInstanceWithEffects(a,u,t,h,e)&&r._SetTransform(t,!1,m,S,T),a._SetIsDrawingWithEffects(!1)}a.LoadFromJson(_,"visual-state")}i.SetDeviceTransformOffset(0,0),i.SetIsPastingToDrawingCanvas(!1),s._SetRenderTargetDeviceTransform(t),s._ApplyCurrentDrawingBlendMode(t),n.RestoreTransform(u);for(const[t,e]of _)t.RestoreTransform(e);this._resolve()}}}{const ZI=self.C3;ZI.Plugins.NinePatch=class extends ZI.SDKPluginBase{constructor(t){super(t)}Release(){super.Release()}}}{const $I=self.C3;$I.Plugins.NinePatch.Type=class extends $I.SDKTypeBase{constructor(t){super(t),this._textureSet=null,this._leftMargin=16,this._rightMargin=16,this._topMargin=16,this._bottomMargin=16,this._drawable=null}Release(){this.ReleaseTextures(),super.Release()}OnCreate(){this.GetImageInfo().LoadAsset(this._runtime)}async LoadTextures(t){const e=this.GetImageInfo();this._drawable=await e.ExtractImageToCanvas()}ShouldCreatePatch(){return!(this._textureSet||!this._drawable)}CreatePatch(){this.ShouldCreatePatch()&&(this._textureSet=new self.NinePatchTextureSet(this._runtime),this._textureSet.CreateTextures(this._drawable,this._leftMargin,this._rightMargin,this._topMargin,this._bottomMargin))}ReleaseTextures(){this._textureSet&&(this._textureSet.Release(),this._textureSet=null)}_OnTextureSetChanged(){this.ReleaseTextures()}GetTextureSet(){return this._textureSet}_SetLeftMargin(t){t=Math.max(+t,0),this._leftMargin!==t&&(this._leftMargin=t,this._OnTextureSetChanged(),this._runtime.UpdateRender())}_GetLeftMargin(){return this._leftMargin}_SetRightMargin(t){t=Math.max(+t,0),this._rightMargin!==t&&(this._rightMargin=t,this._OnTextureSetChanged(),this._runtime.UpdateRender())}_GetRightMargin(){return this._rightMargin}_SetTopMargin(t){t=Math.max(+t,0),this._topMargin!==t&&(this._topMargin=t,this._OnTextureSetChanged(),this._runtime.UpdateRender())}_GetTopMargin(){return this._topMargin}_SetBottomMargin(t){t=Math.max(+t,0),this._bottomMargin!==t&&(this._bottomMargin=t,this._OnTextureSetChanged(),this._runtime.UpdateRender())}_GetBottomMargin(){return this._bottomMargin}}}{const tC=globalThis.C3,eC=globalThis.C3X,sC=0,iC=1,rC=2,nC=3,aC=4,oC=5,hC=6,lC=7,cC=8,uC=10,_C=0,dC=1,pC=2,fC=4,gC=8,mC=tC.New(tC.Rect),SC=tC.New(tC.Rect),yC=tC.New(tC.Quad);tC.Plugins.NinePatch.Instance=class extends tC.SDKWorldInstanceBase{constructor(t,e){super(t),this._leftMargin=16,this._rightMargin=16,this._topMargin=16,this._bottomMargin=16,this._edges=1,this._fill=1,this._imageScaleX=1,this._imageScaleY=1,this._seams=1,this._ownImageInfo=null,this._ownDrawable=null,this._ownTextureSet=null,this._callback3d=null,e&&(this._leftMargin=e[sC],this._rightMargin=e[iC],this._topMargin=e[rC],this._bottomMargin=e[nC],this._edges=e[aC],this._fill=e[oC],this._imageScaleX=e[hC],this._imageScaleY=e[lC],this._seams=e[uC],this.GetWorldInfo().SetVisible(!!e[cC]));const s=this._sdkType;s.ShouldCreatePatch()&&(s._SetLeftMargin(this._leftMargin),s._SetRightMargin(this._rightMargin),s._SetTopMargin(this._topMargin),s._SetBottomMargin(this._bottomMargin),s.CreatePatch())}Release(){this._ReleaseOwnImage(),super.Release()}_ReleaseOwnImage(){this._ownTextureSet&&(this._ownTextureSet.Release(),this._ownTextureSet=null),this._ownDrawable=null,this._ownImageInfo&&(this._ownImageInfo.GetImageAsset().DecRefCount(),this._ownImageInfo.Release(),this._ownImageInfo=null)}_Set3DCallback(t){this._callback3d=t}Draw(t){const e=this.GetWorldInfo(),s=e.GetBoundingQuad();this._Draw(t,s.getTlx(),s.getTly(),e.GetWidth(),e.GetHeight())}_Draw(t,e,s,i,r){let n=null;if(this._ownImageInfo)this._ownTextureSet||(this._ownTextureSet=new globalThis.NinePatchTextureSet(this._runtime),this._ownTextureSet.CreateTextures(this._ownDrawable,this._leftMargin,this._rightMargin,this._topMargin,this._bottomMargin)),n=this._ownTextureSet;else{const t=this._sdkType;if(n=t.GetTextureSet(),!n&&(t._SetLeftMargin(this._leftMargin),t._SetRightMargin(this._rightMargin),t._SetTopMargin(this._topMargin),t._SetBottomMargin(this._bottomMargin),t.CreatePatch(),n=t.GetTextureSet(),!n))return}const a=this.GetWorldInfo(),o=a.GetWidth(),h=a.GetHeight(),l=n.GetImageWidth(),c=n.GetImageHeight(),u=Math.min(this._GetLeftMargin(),l),_=Math.min(this._GetRightMargin(),l),d=Math.min(this._GetTopMargin(),c),p=Math.min(this._GetBottomMargin(),c),f=l-_,g=c-p,m=Math.min(this._GetLeftMargin()*this._imageScaleX,l),S=Math.min(this._GetRightMargin()*this._imageScaleX,l),y=Math.min(this._GetTopMargin()*this._imageScaleY,c),G=Math.min(this._GetBottomMargin()*this._imageScaleY,c),T=this._seams,I=tC.clamp(o-m,0,T),C=tC.clamp(o-S,0,T),b=tC.clamp(h-y,0,T),x=tC.clamp(h-G,0,T),w=I/this._imageScaleX,M=C/this._imageScaleX,P=b/this._imageScaleY,v=x/this._imageScaleY,R=this._edges,A=this._fill,D=2===A?0:I,E=2===A?0:C,F=2===A?0:b,O=2===A?0:x;u>0&&d>0&&this._DrawPatch(t,n.GetTexture(),dC|pC,0,0,u+w,d+P,e,s,m+I,y+b),0===R&&u>0&&g>d?this._TilePatch(t,n.GetLeftTexture(),dC,e,s+y,m+D,r-y-G,0,0):1===R&&u>0&&g>d&&this._DrawPatch(t,n.GetTexture(),dC,0,d,u,g-d,e,s+y,m,r-y-G),0===R&&d>0&&f>u?this._TilePatch(t,n.GetTopTexture(),pC,e+m,s,i-m-S,y+F,0,0):1===R&&d>0&&f>u&&this._DrawPatch(t,n.GetTexture(),pC,u,0,f-u,d,e+m,s,i-m-S,y),g>d&&f>u&&(0===A?this._TilePatch(t,n.GetFillTexture(),_C,e+m,s+y,i-m-S,r-y-G,0,0):1===A&&this._DrawPatch(t,n.GetTexture(),_C,u,d,f-u,g-d,e+m,s+y,i-m-S,r-y-G)),u>0&&p>0&&this._DrawPatch(t,n.GetTexture(),dC|gC,0,g-v,u+w,p+v,e,s+r-G-x,m+I,G+x),_>0&&d>0&&this._DrawPatch(t,n.GetTexture(),fC|pC,f-M,0,_+M,d+P,e+i-S-C,s,S+C,y+b),0===R&&p>0&&f>u?this._TilePatch(t,n.GetBottomTexture(),gC,e+m,s+r-G-O,i-m-S,G+O,0,O):1===R&&p>0&&f>u&&this._DrawPatch(t,n.GetTexture(),gC,u,g,f-u,p,e+m,s+r-G,i-m-S,G),0===R&&_>0&&g>d?this._TilePatch(t,n.GetRightTexture(),fC,e+i-S-E,s+y,S+E,r-y-G,E,0):1===R&&_>0&&g>d&&this._DrawPatch(t,n.GetTexture(),fC,f,d,_,g-d,e+i-S,s+y,S,r-y-G),_>0&&p>0&&this._DrawPatch(t,n.GetTexture(),fC|gC,f-M,g-v,_+M,p+v,e+i-S-C,s+r-G-x,S+C,G+x)}_DrawPatch(t,e,s,i,r,n,a,o,h,l,c){if(({sx:i,sy:r,sw:n,sh:a,dx:o,dy:h,dw:l,dh:c}=this._ClipEdges(s,i,r,n,a,o,h,l,c)),l<=0||c<=0||!e)return;const u=e.GetWidth(),_=e.GetHeight();if(t.SetTexture(e),mC.set(o,h,o+l,h+c),SC.set(i/u,r/_,(i+n)/u,(r+a)/_),null===this._callback3d){const e=this.GetWorldInfo(),s=e.GetBoundingQuad(),i=s.getTlx(),r=s.getTly();mC.offset(-i,-r),yC.setFromRotatedRect(mC,e.GetAngle()),yC.offset(i,r),t.Quad3(yC,SC)}else this._callback3d(mC,SC)}_TilePatch(t,e,s,i,r,n,a,o,h){let l=0,c=0,u=0,_=0;if(({sx:l,sy:c,sw:u,sh:_,dx:i,dy:r,dw:n,dh:a}=this._ClipEdges(s,l,c,u,_,i,r,n,a)),o-=l*this._imageScaleX,h-=c*this._imageScaleY,n<=0||a<=0||!e)return;const d=e.GetWidth(),p=e.GetHeight();if(t.SetTexture(e),mC.set(i,r,i+n,r+a),SC.set(-o/(d*this._imageScaleX),-h/(p*this._imageScaleY),(n-o)/(d*this._imageScaleX),(a-h)/(p*this._imageScaleY)),null===this._callback3d){const e=this.GetWorldInfo(),s=e.GetBoundingQuad(),i=s.getTlx(),r=s.getTly();mC.offset(-i,-r),yC.setFromRotatedRect(mC,e.GetAngle()),yC.offset(i,r),t.Quad3(yC,SC)}else this._callback3d(mC,SC)}_ClipEdges(t,e,s,i,r,n,a,o,h){const l=this.GetWorldInfo(),c=l.GetWidth(),u=l.GetHeight(),_=this._imageScaleX,d=this._imageScaleY,p=this.GetTextureSet(),f=p.GetImageWidth(),g=p.GetImageHeight(),m=Math.min(this._GetLeftMargin()*_,f),S=Math.min(this._GetRightMargin()*_,f),y=Math.min(this._GetTopMargin()*d,g),G=Math.min(this._GetBottomMargin()*d,g);if(t&dC){const t=c-S-m;t<-m?o=0:t<0&&(i+=t/_,o+=t)}if(t&pC){const t=u-G-y;t<-y?h=0:t<0&&(r+=t/d,h+=t)}if(t&fC){const t=c-S;t<-S?o=0:t<0&&(i+=t/_,o+=t,e-=t/_,n-=t)}if(t&gC){const t=u-G;t<-G?h=0:t<0&&(r+=t/d,h+=t,s-=t/d,a-=t)}return{sx:e,sy:s,sw:i,sh:r,dx:n,dy:a,dw:o,dh:h}}GetTextureSet(){return this._ownTextureSet||this._sdkType.GetTextureSet()}_OnTextureSetChanged(){this._ownImageInfo&&(this._ownTextureSet&&(this._ownTextureSet.Release(),this._ownTextureSet=null),this._runtime.UpdateRender())}GetCurrentImageInfo(){return this._ownImageInfo||this._objectClass.GetImageInfo()}_SetLeftMargin(t){this._ownImageInfo||this._sdkType._SetLeftMargin(t),t=Math.max(+t,0),this._leftMargin!==t&&(this._leftMargin=t,this._OnTextureSetChanged())}_GetLeftMargin(){return this._ownImageInfo?this._leftMargin:this._sdkType._GetLeftMargin()}_SetRightMargin(t){this._ownImageInfo||this._sdkType._SetRightMargin(t),t=Math.max(+t,0),this._rightMargin!==t&&(this._rightMargin=t,this._OnTextureSetChanged())}_GetRightMargin(){return this._ownImageInfo?this._rightMargin:this._sdkType._GetRightMargin()}_SetTopMargin(t){this._ownImageInfo||this._sdkType._SetTopMargin(t),t=Math.max(+t,0),this._topMargin!==t&&(this._topMargin=t,this._OnTextureSetChanged())}_GetTopMargin(){return this._ownImageInfo?this._topMargin:this._sdkType._GetTopMargin()}_SetBottomMargin(t){this._ownImageInfo||this._sdkType._SetBottomMargin(t),t=Math.max(+t,0),this._bottomMargin!==t&&(this._bottomMargin=t,this._OnTextureSetChanged())}_GetBottomMargin(){return this._ownImageInfo?this._bottomMargin:this._sdkType._GetBottomMargin()}_SetEdges(t){this._edges!==t&&(this._edges=t,this._runtime.UpdateRender())}_GetEdges(){return this._edges}_SetFill(t){this._fill!==t&&(this._fill=t,this._runtime.UpdateRender())}_GetFill(){return this._fill}_SetImageScaleX(t){this._imageScaleX!==t&&(this._imageScaleX=t,this._runtime.UpdateRender())}_GetImageScaleX(){return this._imageScaleX}_SetImageScaleY(t){this._imageScaleY!==t&&(this._imageScaleY=t,this._runtime.UpdateRender())}_GetImageScaleY(){return this._imageScaleY}_SetSeams(t){this._seams!==t&&(this._seams=t,this._runtime.UpdateRender())}_GetSeams(){return this._seams}GetPropertyValueByIndex(t){switch(t){case sC:return this._GetLeftMargin();case iC:return this._GetRightMargin();case rC:return this._GetTopMargin();case nC:return this._GetBottomMargin();case hC:return this._GetImageScaleX();case lC:return this._GetImageScaleY()}}SetPropertyValueByIndex(t,e){switch(t){case sC:this._SetLeftMargin(e);break;case iC:this._SetRightMargin(e);break;case rC:this._SetTopMargin(e);break;case nC:this._SetBottomMargin(e);break;case hC:this._SetImageScaleX(e);break;case lC:this._SetImageScaleY(e)}}GetDebuggerProperties(){const t="plugins.ninepatch.properties";return[{title:"plugins.ninepatch.name",properties:[{name:t+".left-margin.name",value:this._GetLeftMargin(),onedit:t=>this._SetLeftMargin(t)},{name:t+".right-margin.name",value:this._GetRightMargin(),onedit:t=>this._SetRightMargin(t)},{name:t+".top-margin.name",value:this._GetTopMargin(),onedit:t=>this._SetTopMargin(t)},{name:t+".bottom-margin.name",value:this._GetBottomMargin(),onedit:t=>this._SetBottomMargin(t)},{name:t+".image-scale-x.name",value:100*this._GetImageScaleX(),onedit:t=>this._SetImageScaleX(t/100)},{name:t+".image-scale-y.name",value:100*this._GetImageScaleY(),onedit:t=>this._SetImageScaleY(t/100)}]}]}GetScriptInterfaceClass(){return globalThis.I9PatchInstance}};const GC=["tile","stretch"],TC=["tile","stretch","transparent"],IC=["exact","overlap"];globalThis.I9PatchInstance=class extends self.IWorldInstance{#e;constructor(){super(),this.#e=globalThis.IInstance._GetInitInst().GetSdkInstance()}set leftMargin(t){eC.RequireFiniteNumber(t),this.#e._SetLeftMargin(t)}get leftMargin(){return this.#e._GetLeftMargin()}set rightMargin(t){eC.RequireFiniteNumber(t),this.#e._SetRightMargin(t)}get rightMargin(){return this.#e._GetRightMargin()}set topMargin(t){eC.RequireFiniteNumber(t),this.#e._SetTopMargin(t)}get topMargin(){return this.#e._GetTopMargin()}set bottomMargin(t){eC.RequireFiniteNumber(t),this.#e._SetBottomMargin(t)}get bottomMargin(){return this.#e._GetBottomMargin()}set edges(t){const e=GC.indexOf(t);if(-1===e)throw new Error("invalid edge");this.#e._SetEdges(e)}get edges(){return GC[this.#e._GetEdges()]}set fill(t){const e=TC.indexOf(t);if(-1===e)throw new Error("invalid fill");this.#e._SetFill(e)}get fill(){return TC[this.#e._GetFill()]}set imageScaleX(t){eC.RequireFiniteNumber(t),this.#e._SetImageScaleX(t)}get imageScaleX(){return this.#e._GetImageScaleX()}set imageScaleY(t){eC.RequireFiniteNumber(t),this.#e._SetImageScaleY(t)}get imageScaleY(){return this.#e._GetImageScaleY()}set seams(t){const e=IC.indexOf(t);if(-1===e)throw new Error("invalid seams");this.#e._SetSeams(e)}get seams(){return IC[this.#e._GetSeams()]}async replaceImage(t){eC.RequireInstanceOf(t,Blob);const e=this.#e,s=e.GetRuntime(),i=tC.New(tC.ImageInfo);await i.LoadDynamicBlobAsset(s,t),i.GetImageAsset().IncRefCount();const r=await i.ExtractImageToCanvas();e.WasReleased()?i.Release():(e._ReleaseOwnImage(),e._ownImageInfo=i,e._ownDrawable=r,s.UpdateRender())}}}self.C3.Plugins.NinePatch.Cnds={OnURLLoaded:()=>!0,OnURLFailed:()=>!0};{const CC=self.C3;CC.Plugins.NinePatch.Acts={SetEffect(t){this.GetWorldInfo().SetBlendMode(t),this._runtime.UpdateRender()},SetMargins(t,e,s,i){this._SetLeftMargin(t),this._SetRightMargin(e),this._SetTopMargin(s),this._SetBottomMargin(i)},SetEdges(t){this._SetEdges(t)},SetFill(t){this._SetFill(t)},SetImageScaleX(t){this._SetImageScaleX(t/100)},SetImageScaleY(t){this._SetImageScaleY(t/100)},SetSeams(t){this._SetSeams(t)},async LoadURL(t){if(this._ownImageInfo&&this._ownImageInfo.GetURL()===t)return;const e=this._runtime,s=CC.New(CC.ImageInfo);let i=null;try{if(await s.LoadDynamicAsset(e,t),!s.IsLoaded())throw new Error("image failed to load");if(this.WasReleased())return s.Release(),null;s.GetImageAsset().IncRefCount(),i=await s.ExtractImageToCanvas()}catch(t){return console.error("Load image from URL failed: ",t),void(this.WasReleased()||this.Trigger(CC.Plugins.NinePatch.Cnds.OnURLFailed))}this.WasReleased()?s.Release():(this._ReleaseOwnImage(),this._ownImageInfo=s,this._ownDrawable=i,e.UpdateRender(),await this.TriggerAsync(CC.Plugins.NinePatch.Cnds.OnURLLoaded))}}}self.C3.Plugins.NinePatch.Exps={LeftMargin(){return this._GetLeftMargin()},RightMargin(){return this._GetRightMargin()},TopMargin(){return this._GetTopMargin()},BottomMargin(){return this._GetBottomMargin()},ImageScaleX(){return 100*this._GetImageScaleX()},ImageScaleY(){return 100*this._GetImageScaleY()}};{let bC=function(t){const e=xC.CreateCanvas(t.width,t.height);return e.getContext("2d").drawImage(t,0,0),e};0;const xC=self.C3;self.NinePatchTextureSet=class{constructor(t){this._runtime=t,this._texture=null,this._fillTexture=null,this._leftTexture=null,this._rightTexture=null,this._topTexture=null,this._bottomTexture=null,this._imageWidth=0,this._imageHeight=0,this._renderer=t.GetRenderer(),this._isLoading=!1,this._wasReleased=!1}Release(){this._renderer.IsContextLost()||(this._renderer.DeleteTexture(this._texture),this._renderer.DeleteTexture(this._fillTexture),this._renderer.DeleteTexture(this._leftTexture),this._renderer.DeleteTexture(this._rightTexture),this._renderer.DeleteTexture(this._topTexture),this._renderer.DeleteTexture(this._bottomTexture)),this._texture=null,this._fillTexture=null,this._leftTexture=null,this._rightTexture=null,this._topTexture=null,this._bottomTexture=null,this._renderer=null,this._wasReleased=!0}WasReleased(){return this._wasReleased}CreateTextures(t,e,s,i,r){this._SliceImage(t,e,s,i,r)}HasCreatedTextures(){return!!this._texture}_SliceImage(t,e,s,i,r){if(this._wasReleased)return;const n=t.width,a=t.height;this._imageWidth=n,this._imageHeight=a,e=Math.min(Math.floor(e),n),s=Math.min(Math.floor(s),n),i=Math.min(Math.floor(i),a);const o=n-s,h=a-(r=Math.min(Math.floor(r),a)),l=this._runtime.GetSampling(),c=this._runtime.GetCanvasManager().GetTextureAnisotropy();this._texture=this._renderer.CreateStaticTexture(bC(t),{sampling:l,anisotropy:c}),o>e&&h>i&&(this._fillTexture=this._renderer.CreateStaticTexture(this._SliceSubImage(bC(t),e,i,o,h),{wrapX:"repeat",wrapY:"repeat",sampling:l,anisotropy:c})),e>0&&h>i&&(this._leftTexture=this._renderer.CreateStaticTexture(this._SliceSubImage(bC(t),0,i,e,h),{wrapY:"repeat",sampling:l,anisotropy:c})),s>0&&h>i&&(this._rightTexture=this._renderer.CreateStaticTexture(this._SliceSubImage(bC(t),o,i,n,h),{wrapY:"repeat",sampling:l,anisotropy:c})),i>0&&o>e&&(this._topTexture=this._renderer.CreateStaticTexture(this._SliceSubImage(bC(t),e,0,o,i),{wrapX:"repeat",sampling:l,anisotropy:c})),r>0&&o>e&&(this._bottomTexture=this._renderer.CreateStaticTexture(this._SliceSubImage(bC(t),e,h,o,a),{wrapX:"repeat",sampling:l,anisotropy:c}))}_SliceSubImage(t,e,s,i,r){const n=i-e,a=r-s,o=xC.CreateCanvas(n,a);return o.getContext("2d").drawImage(t,e,s,n,a,0,0,n,a),o}GetImageWidth(){return this._imageWidth}GetImageHeight(){return this._imageHeight}GetTexture(){return this._texture}GetFillTexture(){return this._fillTexture}GetLeftTexture(){return this._leftTexture}GetRightTexture(){return this._rightTexture}GetTopTexture(){return this._topTexture}GetBottomTexture(){return this._bottomTexture}}}{const wC=self.C3;wC.Plugins.Text=class extends wC.SDKPluginBase{constructor(t){super(t)}Release(){super.Release()}}}{const MC=self.C3;MC.Plugins.Text.Type=class extends MC.SDKTypeBase{constructor(t){super(t)}Release(){super.Release()}OnCreate(){}LoadTextures(t){}ReleaseTextures(){}}}{const PC=self.C3,vC=self.C3X,RC=[0,0,0],AC=0,DC=1,EC=2,FC=3,OC=4,BC=5,LC=6,kC=7,NC=8,UC=9,WC=10,jC=11,VC=12,zC=13,HC=15,YC=["left","center","right"],XC=["top","center","bottom"],qC=["ltr","rtl"],JC=["word","cjk","character"],QC=new PC.Rect,KC=new PC.Quad,ZC=new PC.Color,$C=PC.New(PC.Vector2),tb=new Map([["b","strong"],["i","em"],["s","s"],["u","u"],["iconoffsety",null]]);PC.Plugins.Text.Instance=class extends PC.SDKWorldInstanceBase{constructor(t,e){if(super(t),this._text="",this._enableBBcode=!0,this._faceName="Arial",this._ptSize=12,this._lineHeightOffset=0,this._isBold=!1,this._isItalic=!1,this._color=PC.New(PC.Color),this._horizontalAlign=0,this._verticalAlign=0,this._wrapMode="word",this._textDirection=0,this._resolutionMode="auto",this._fixedScaleFactor=1,this._iconObjectClass=null,this._htmlString="",this._isHtmlStringUpToDate=!1,this._readAloud=!1,this._screenReaderText=null,this._typewriterStartTime=-1,this._typewriterEndTime=-1,this._typewriterLength=0,this._rendererText=PC.New(PC.Gfx.RendererText,this._runtime.GetRenderer(),{timeout:5}),this._rendererText.ontextureupdate=()=>this._runtime.UpdateRender(),this._animationframeimagechange_handler=()=>this._OnIconObjectClassImageChanged(),this._pendingUpdateIconSet=!1,this._beforerender_handler=()=>this._OnBeforeRender(),e){this._text=e[AC],this._enableBBcode=!!e[DC],this._faceName=e[EC],this._ptSize=e[FC],this._lineHeightOffset=e[OC],this._isBold=!!e[BC],this._isItalic=!!e[LC],this._horizontalAlign=e[NC],this._verticalAlign=e[UC],this._wrapMode=JC[e[WC]],this._textDirection=e[jC],this._SetIconObjectClass(this._runtime.GetObjectClassBySID(e[VC]));const t=e[kC];this._color.setRgb(t[0],t[1],t[2]),this.GetWorldInfo().SetVisible(e[zC]),this._readAloud=!!e[HC]}this._UpdateTextSettings(),this._UpdateScreenReaderText(),this._runtime.Dispatcher().addEventListener("beforerender",this._beforerender_handler)}Release(){this._runtime.Dispatcher().removeEventListener("beforerender",this._beforerender_handler),this._beforerender_handler=null,this._SetIconObjectClass(null),this._CancelTypewriter(),this._screenReaderText&&(this._screenReaderText.Release(),this._screenReaderText=null),this._rendererText.Release(),this._rendererText=null,super.Release()}_UpdateTextSettings(){const t=this._rendererText;t.SetText(this._text),t.SetBBCodeEnabled(this._enableBBcode),this._rendererText.IsBBCodeEnabled()&&this._iconObjectClass?this._rendererText.SetIconSet(this.GetRuntime().GetTextIconSet(this._iconObjectClass)):this._rendererText.SetIconSet(null),t.SetIconSmoothing("nearest"!==this._runtime.GetSampling()),t.SetFontName(this._faceName),t.SetLineHeight(this._lineHeightOffset),t.SetBold(this._isBold),t.SetItalic(this._isItalic),t.SetColor(this._color),t.SetHorizontalAlignment(YC[this._horizontalAlign]),t.SetVerticalAlignment(XC[this._verticalAlign]),t.SetWordWrapMode(this._wrapMode),t.SetTextDirection(qC[this._textDirection])}_UpdateTextSize(){const t=this.GetWorldInfo();this._rendererText.SetText(this._text),this._rendererText.SetFontSize(this._ptSize),this._rendererText.SetFontSizeScale(t.GetSceneGraphScale());const e=t.GetLayer();let s;"auto"===this._resolutionMode?(s=e.GetResolutionScaleFactorToZ(t.GetTotalZElevation()),this._rendererText.SetMipMapEnabled(!1)):"fixed"===this._resolutionMode&&(s=this._fixedScaleFactor,this._rendererText.SetMipMapEnabled(!0)),t.HasMesh()&&s!==this._rendererText.GetZoom()&&t.SetMeshChanged(!0),this._rendererText.SetSize(t.GetWidth(),t.GetHeight(),s)}_SetIconObjectClass(t){t&&(t.IsFamily()||t.GetPlugin().constructor!==PC.Plugins.Sprite)||t!==this._iconObjectClass&&(this._iconObjectClass&&this._iconObjectClass.Dispatcher().removeEventListener("animationframeimagechange",this._animationframeimagechange_handler),this._iconObjectClass=t,this._iconObjectClass&&this._iconObjectClass.Dispatcher().addEventListener("animationframeimagechange",this._animationframeimagechange_handler),this._UpdateTextSettings(),this._isHtmlStringUpToDate=!1,this._runtime.UpdateRender())}_OnIconObjectClassImageChanged(){this._runtime.DeleteTextIconSet(this._iconObjectClass),this._runtime.UpdateRender(),this._pendingUpdateIconSet=!0}_UpdateScreenReaderText(){if(this._readAloud){let t=this._text;this._enableBBcode&&(t=PC.BBString.StripAnyTags(t)),this._screenReaderText?this._screenReaderText.SetText(t):this._screenReaderText=PC.New(PC.ScreenReaderText,this._runtime,t)}else this._screenReaderText&&(this._screenReaderText.Release(),this._screenReaderText=null)}_OnBeforeRender(){const t=this.GetWorldInfo(),e=t.GetLayer(),s=t.GetLayout();t.IsVisible()&&t.IsInViewport(e.GetViewport(),s.HasVanishingPointOutsideViewport(),s.IsOrthographicProjection())&&(this._UpdateTextForDraw(),this._rendererText.GetTexture())}_UpdateTextForDraw(){this._UpdateTextSize(),this._pendingUpdateIconSet&&(this._pendingUpdateIconSet=!1,this._rendererText.IsBBCodeEnabled()&&this._iconObjectClass&&this._rendererText.SetIconSet(this.GetRuntime().GetTextIconSet(this._iconObjectClass)))}Draw(t){const e=this._runtime.GetCanvasManager().IsPastingToDrawingCanvas();e&&this._UpdateTextForDraw();const s=this._rendererText.GetTexture();if(!s)return;const i=this.GetWorldInfo(),r=i.GetLayer();if(0!==i.GetAngle()||0!==r.GetAngle()||0!==i.GetTotalZElevation()||i.HasMesh()||!r.RendersIn2DMode()||e)t.SetTexture(s),i.HasMesh()?this._DrawMesh(i,t):this._DrawStandard(i,t);else{const e=i.GetBoundingQuad(),[n,a]=r.LayerToDrawSurface(e.getTlx(),e.getTly()),[o,h]=r.LayerToDrawSurface(e.getBrx(),e.getBry()),l=n-Math.round(n),c=a-Math.round(a);QC.set(n,a,o,h),QC.offset(-l,-c),KC.setFromRect(QC);const[u,_]=t.GetRenderTargetSize(t.GetRenderTarget());t.IsWebGL()?this._runtime.GetCanvasManager().SetDeviceTransform(t,u,_):(t.SetNormalizedCoordsProgramVariant(!0),KC.divide(u,_)),t.SetTexture(s),t.Quad3(KC,this._rendererText.GetTexRect()),t.IsWebGL()?r._SetTransform(t):t.SetNormalizedCoordsProgramVariant(!1)}}_DrawStandard(t,e){let s=t.GetBoundingQuad();this._runtime.IsPixelRoundingEnabled()&&(s=this._PixelRoundQuad(s)),e.Quad3(s,this._rendererText.GetTexRect())}_DrawMesh(t,e){const s=t.GetTransformedMesh();if(t.IsMeshChanged()){t.CalculateBbox(QC,KC,!1);let e=KC;this._runtime.IsPixelRoundingEnabled()&&(e=this._PixelRoundQuad(e)),s.CalculateTransformedMesh(t.GetSourceMesh(),e,this._rendererText.GetTexRect()),t.SetMeshChanged(!1)}s.Draw(e,t.GetTotalZElevation())}_PixelRoundQuad(t){const e=t.getTlx()-Math.round(t.getTlx()),s=t.getTly()-Math.round(t.getTly());return 0===e&&0===s?t:(KC.copy(t),KC.offset(-e,-s),KC)}GetCurrentSurfaceSize(){const t=this._rendererText.GetTexture();return t?[t.GetWidth(),t.GetHeight()]:[100,100]}GetCurrentTexRect(){return this._rendererText.GetTexRect()}IsCurrentTexRotated(){return!1}SaveToJson(){const t={t:this._text,c:this._color.toJSON(),fn:this._faceName,ps:this._ptSize};return this._enableBBcode&&(t.bbc=this._enableBBcode),0!==this._horizontalAlign&&(t.ha=this._horizontalAlign),0!==this._verticalAlign&&(t.va=this._verticalAlign),"word"!==this._wrapMode&&(t.wr=this._wrapMode),0!==this._lineHeightOffset&&(t.lho=this._lineHeightOffset),this._isBold&&(t.b=this._isBold),this._isItalic&&(t.i=this._isItalic),-1!==this._typewriterEndTime&&(t.tw={st:this._typewriterStartTime,en:this._typewriterEndTime,l:this._typewriterLength}),this._iconObjectClass&&(t.ioc=this._iconObjectClass.GetSID()),"fixed"===this._resolutionMode&&(t.fs=this._fixedScaleFactor),t}LoadFromJson(t){if(this._CancelTypewriter(),this._text=t.t,this._color.setFromJSON(t.c),this._faceName=t.fn,this._ptSize=t.ps,this._enableBBcode=!!t.hasOwnProperty("bbc")&&t.bbc,this._horizontalAlign=t.hasOwnProperty("ha")?t.ha:0,this._verticalAlign=t.hasOwnProperty("va")?t.va:0,t.hasOwnProperty("wr")){const e=t.wr;this._wrapMode="boolean"==typeof e?e?"word":"character":e}else this._wrapMode="word";if(this._lineHeightOffset=t.hasOwnProperty("lho")?t.lho:0,this._isBold=!!t.hasOwnProperty("b")&&t.b,this._isItalic=!!t.hasOwnProperty("i")&&t.i,t.hasOwnProperty("tw")){const e=t.tw;this._typewriterStartTime=e.st,this._typewriterEndTime=e.en,this._typewriterLength=e.l}if(t.hasOwnProperty("ioc")){const e=this.GetRuntime().GetObjectClassBySID(t.ioc);e&&this._SetIconObjectClass(e)}else this._SetIconObjectClass(null);t.hasOwnProperty("fs")?(this._resolutionMode="fixed",this._fixedScaleFactor=t.fs):this._resolutionMode="auto",this._UpdateTextSettings(),this._UpdateScreenReaderText(),this._isHtmlStringUpToDate=!1,-1!==this._typewriterEndTime&&this._StartTicking()}GetPropertyValueByIndex(t){switch(t){case AC:return this.GetText();case DC:return this._enableBBcode;case EC:return this._GetFontFace();case FC:return this._GetFontSize();case OC:return this._GetLineHeight();case BC:return this._IsBold();case LC:return this._IsItalic();case kC:return RC[0]=this._color.getR(),RC[1]=this._color.getG(),RC[2]=this._color.getB(),RC;case NC:return this._GetHAlign();case UC:return this._GetVAlign();case WC:return this._GetWrapMode();case HC:return this._IsReadAloud()}}SetPropertyValueByIndex(t,e){switch(t){case AC:this._SetText(e);break;case DC:if(this._enableBBcode===!!e)return;this._enableBBcode=!!e,this._UpdateTextSettings();break;case EC:this._SetFontFace(e);break;case FC:this._SetFontSize(e);break;case OC:this._SetLineHeight(e);break;case BC:this._SetBold(e);break;case LC:this._SetItalic(e);break;case kC:const t=this._color,s=e;if(t.getR()===s[0]&&t.getG()===s[1]&&t.getB()===s[2])return;this._color.setRgb(s[0],s[1],s[2]),this._UpdateTextSettings();break;case NC:this._SetHAlign(e);break;case UC:this._SetVAlign(e);break;case WC:this._SetWrapMode(e)}}SetPropertyColorOffsetValueByIndex(t,e,s,i){0===e&&0===s&&0===i||t!==kC||(this._color.addRgb(e,s,i),this._UpdateTextSettings())}_SetText(t){this._text!==t&&(this._text=t,this._UpdateScreenReaderText(),this._isHtmlStringUpToDate=!1,this._runtime.UpdateRender())}GetText(){return this._text}_StartTypewriter(t,e){this._SetText(t),this._UpdateTextSize(),this._typewriterStartTime=this._runtime.GetWallTime(),this._typewriterEndTime=this._typewriterStartTime+e/this.GetInstance().GetActiveTimeScale(),this._typewriterLength=this._rendererText.GetLengthInGraphemes(),this._rendererText.SetDrawMaxCharacterCount(0),this._StartTicking()}_CancelTypewriter(){this._typewriterStartTime=-1,this._typewriterEndTime=-1,this._typewriterLength=0,this._rendererText.SetDrawMaxCharacterCount(-1),this._StopTicking()}_FinishTypewriter(){-1!==this._typewriterEndTime&&(this._CancelTypewriter(),this.Trigger(PC.Plugins.Text.Cnds.OnTypewriterTextFinished),this._runtime.UpdateRender())}_SetFontFace(t){this._faceName!==t&&(this._faceName=t,this._rendererText.SetFontName(t),this._runtime.UpdateRender())}_GetFontFace(){return this._faceName}_SetBold(t){t=!!t,this._isBold!==t&&(this._isBold=t,this._rendererText.SetBold(t),this._runtime.UpdateRender())}_IsBold(){return this._isBold}_SetItalic(t){t=!!t,this._isItalic!==t&&(this._isItalic=t,this._rendererText.SetItalic(t),this._runtime.UpdateRender())}_IsItalic(){return this._isItalic}_SetFontSize(t){this._ptSize!==t&&(this._ptSize=t,this._runtime.UpdateRender())}_GetFontSize(){return this._ptSize}_SetFontColor(t){this._color.equalsIgnoringAlpha(t)||(this._color.copyRgb(t),this._rendererText.SetColor(this._color),this._runtime.UpdateRender())}_GetFontColor(){return this._color}_SetLineHeight(t){this._lineHeightOffset!==t&&(this._lineHeightOffset=t,this._UpdateTextSettings(),this._runtime.UpdateRender())}_GetLineHeight(){return this._lineHeightOffset}_SetHAlign(t){this._horizontalAlign!==t&&(this._horizontalAlign=t,this._UpdateTextSettings(),this._runtime.UpdateRender())}_GetHAlign(){return this._horizontalAlign}_SetVAlign(t){this._verticalAlign!==t&&(this._verticalAlign=t,this._UpdateTextSettings(),this._runtime.UpdateRender())}_GetVAlign(){return this._verticalAlign}_SetWrapModeByIndex(t){this._SetWrapMode(JC[t])}_SetWrapMode(t){this._wrapMode!==t&&(this._wrapMode=t,this._UpdateTextSettings(),this._runtime.UpdateRender())}_GetWrapMode(){return this._wrapMode}_SetTextDirection(t){this._textDirection!==t&&(this._textDirection=t,this._UpdateTextSettings(),this._runtime.UpdateRender())}_GetTextDirection(){return this._textDirection}_SetReadAloud(t){this._readAloud=!!t,this._UpdateScreenReaderText()}_IsReadAloud(){return this._readAloud}_SetResolutionMode(t){this._resolutionMode!==t&&(this._resolutionMode=t,this._runtime.UpdateRender())}_GetResolutionMode(){return this._resolutionMode}_SetFixedScaleFactor(t){this._fixedScaleFactor!==t&&(this._fixedScaleFactor=t,"fixed"===this._resolutionMode&&this._runtime.UpdateRender())}_GetFixedScaleFactor(){return this._fixedScaleFactor}_GetTextWidth(){return this._UpdateTextSize(),this._rendererText.GetTextWidth()}_GetTextHeight(){return this._UpdateTextSize(),this._rendererText.GetTextHeight()}_GetTagAtPosition(t,e){this._UpdateTextSize();const s=this.GetWorldInfo();$C.set(t-s.GetX(),e-s.GetY()),$C.rotate(-s.GetAngle()),$C.offset(s.GetWidth()*s.GetOriginX(),s.GetHeight()*s.GetOriginY()),$C.divide(s.GetWidth(),s.GetHeight()),$C.scale(this._rendererText.GetWidth(),this._rendererText.GetHeight());const i=this._rendererText.HitTestFragment($C.getX(),$C.getY());if(i){const t=i.GetStyleTag("tag");if(t)return t.param}return""}_HasTagAtPosition(t,e,s){const i=this._GetTagAtPosition(e,s);return i&&PC.equalsNoCase(t,i)}_GetTagPosition(t,e){this._UpdateTextSize(),e=Math.floor(e);const s=this._rendererText.FindFragmentWithTag(t,e);if(!s)return null;const i=this.GetWorldInfo(),r=this._rendererText.GetDrawScale(),n=s.GetPosX(),a=s.GetPosY()-(s.GetHeight()-s.GetFontBoundingBoxDescent())*r,o=s.GetWidth()*r/this._rendererText.GetWidth()*i.GetWidth(),h=s.GetHeight()*r/this._rendererText.GetHeight()*i.GetHeight();return $C.set(n,a),$C.divide(this._rendererText.GetWidth(),this._rendererText.GetHeight()),$C.scale(i.GetWidth(),i.GetHeight()),$C.offset(-i.GetWidth()*i.GetOriginX(),-i.GetHeight()*i.GetOriginY()),$C.rotate(i.GetAngle()),$C.offset(i.GetX(),i.GetY()),{x:$C.getX(),y:$C.getY(),width:o,height:h}}_GetTagCount(t){return this._UpdateTextSize(),this._rendererText.CountFragmentsWithTag(t)}_GetHTMLCloseTag(t){let e=tb.get(t);return null===e?"":(e||(e="span"),`</${e||"span"}>`)}_GetHTMLOpenTag(t,e){let s=tb.get(t);if(null===s)return"";switch(s||(s="span"),t){case"color":return`<${s} style="color: ${e}">`;case"font":return`<${s} style="font-family: '${e}'">`;case"opacity":return`<${s} style="opacity: ${e}%">`;case"size":return`<${s} style="font-size: ${e}pt">`;case"background":return`<${s} style="background-color: ${e}">`;case"hide":return`<${s} style="visibility: hidden">`;case"class":return`<${s} class="${e}">`;case"tag":return`<${s} data-tag="${e}">`;default:return`<${s}>`}}async _UpdateHTMLString(){if(this._isHtmlStringUpToDate)return this._htmlString;const t=new PC.BBString(this._text,{noEscape:!0}).toFragmentList(),e=new Map;let s='<span class="c3-text"';const i=[];i.push(`font-family: '${this._GetFontFace()}';`),this._IsBold()&&i.push("font-weight: bold;"),this._IsItalic()&&i.push("font-style: italic;"),"character"===this._GetWrapMode()&&i.push("word-break: break-all;"),s+=` style="${i.join(" ")}">`;const r=this._iconObjectClass?this.GetRuntime().GetTextIconSet(this._iconObjectClass):null;if(this._iconObjectClass){const s=PC.New(PC.PromiseThrottle),i=[],n=new Map;for(const e of t)if(e.IsIcon()){const t=e.GetTextIcon(r);if(t){const e=t.GetSource().GetImageInfo().GetImageAsset();if(n.has(e))continue;n.set(e,null),i.push(s.Add(async()=>{const t=await e.LoadToDrawable();n.set(e,t)}))}}await Promise.all(i);const a=[];for(const i of t)if(i.IsIcon()){const t=i.GetTextIcon(r);if(t){const i=t.GetSource(),r=i.GetImageInfo().GetImageAsset();a.push(s.Add(async()=>{const s=await i.GetImageInfo().ExtractImageToBlobURL(n.get(r));e.set(t,s)}))}}await Promise.all(a);for(const t of n.values())t instanceof ImageBitmap&&t.close&&t.close()}const n=new Map;for(const i of t){const t=i.GetStyleMap();let a=[...n.keys()];a.reverse();for(const e of a)t.has(e)&&t.get(e)===n.get(e)||(n.delete(e),s+=this._GetHTMLCloseTag(e));for(const[e,i]of t)n.has(e)||(n.set(e,i),s+=this._GetHTMLOpenTag(e,i));if(i.IsText()&&(s+=PC.ReplaceAll(PC.EscapeHTML(i.GetCharacterArray().join("")),"\n","<br>")),i.IsIcon()&&r){const n=i.GetTextIcon(r);if(n){const r=e.get(n);if(r){const e=[];let a="0.2em";const o=t.get("iconoffsety");if(o){let t=o.trim();a=t.endsWith("%")?parseFloat(t)/100+"em":t+"px"}e.push(`top: ${a}`),"nearest"===this._runtime.GetSampling()&&e.push("image-rendering: pixelated"),s+=`<img class="c3-text-icon" data-icon="${i.GetIconParameter()}" width="${n.GetWidth()}" height="${n.GetHeight()}" style="${e.join(";")}" src="${r}">`}}}}const a=[...n.keys()];a.reverse();for(const t of a)s+=this._GetHTMLCloseTag(t);return s+="</span>",this._htmlString=s,this._isHtmlStringUpToDate=!0,this._htmlString}Tick(){const t=this._runtime.GetWallTime();if(t>=this._typewriterEndTime)this._CancelTypewriter(),this.Trigger(PC.Plugins.Text.Cnds.OnTypewriterTextFinished),this._runtime.UpdateRender();else{let e=PC.relerp(this._typewriterStartTime,this._typewriterEndTime,t,0,this._typewriterLength);e=Math.floor(e),e!==this._rendererText.GetDrawMaxCharacterCount()&&(this._rendererText.SetDrawMaxCharacterCount(e),this._runtime.UpdateRender())}}GetDebuggerProperties(){const t="plugins.text";return[{title:t+".name",properties:[{name:t+".properties.text.name",value:this.GetText(),onedit:t=>this._SetText(t)},{name:t+".properties.font.name",value:this._GetFontFace(),onedit:t=>this._SetFontFace(t)},{name:t+".properties.size.name",value:this._GetFontSize(),onedit:t=>this._SetFontSize(t)},{name:t+".properties.line-height.name",value:this._GetLineHeight(),onedit:t=>this._SetLineHeight(t)},{name:t+".properties.bold.name",value:this._IsBold(),onedit:t=>this._SetBold(t)},{name:t+".properties.italic.name",value:this._IsItalic(),onedit:t=>this._SetItalic(t)},{name:t+".debugger.text-width",value:this._GetTextWidth()},{name:t+".debugger.text-height",value:this._GetTextHeight()}]}]}GetScriptInterfaceClass(){return self.ITextInstance}};const eb=new WeakMap,sb=new Map([["left",0],["center",1],["right",2]]),ib=new Map([["top",0],["center",1],["bottom",2]]),rb=["ltr","rtl"];self.ITextInstance=class extends self.IWorldInstance{constructor(){super(),eb.set(this,self.IInstance._GetInitInst().GetSdkInstance())}get text(){return eb.get(this).GetText()}set text(t){vC.RequireString(t);const e=eb.get(this);e._CancelTypewriter(),e._SetText(t)}typewriterText(t,e){vC.RequireString(t),vC.RequireFiniteNumber(e);const s=eb.get(this);s._CancelTypewriter(),s._StartTypewriter(t,e)}typewriterFinish(){eb.get(this)._FinishTypewriter()}set fontFace(t){vC.RequireString(t),eb.get(this)._SetFontFace(t)}get fontFace(){return eb.get(this)._GetFontFace()}set isBold(t){eb.get(this)._SetBold(t)}get isBold(){return eb.get(this)._IsBold()}set isItalic(t){eb.get(this)._SetItalic(t)}get isItalic(){return eb.get(this)._IsItalic()}set sizePt(t){vC.RequireFiniteNumber(t),eb.get(this)._SetFontSize(t)}get sizePt(){return eb.get(this)._GetFontSize()}set fontColor(t){if(vC.RequireArray(t),t.length<3)throw new Error("expected 3 elements");ZC.setRgb(t[0],t[1],t[2]),eb.get(this)._SetFontColor(ZC)}get fontColor(){const t=eb.get(this)._GetFontColor();return[t.getR(),t.getG(),t.getB()]}set lineHeight(t){vC.RequireFiniteNumber(t),eb.get(this)._SetLineHeight(t)}get lineHeight(){return eb.get(this)._GetLineHeight()}set horizontalAlign(t){vC.RequireString(t);const e=sb.get(t);if(void 0===e)throw new Error("invalid mode");eb.get(this)._SetHAlign(e)}get horizontalAlign(){return YC[eb.get(this)._GetHAlign()]}set verticalAlign(t){vC.RequireString(t);const e=ib.get(t);if(void 0===e)throw new Error("invalid mode");eb.get(this)._SetVAlign(e)}get verticalAlign(){return XC[eb.get(this)._GetVAlign()]}set wordWrapMode(t){if(!JC.includes(t))throw new Error("invalid mode");eb.get(this)._SetWrapMode(t)}get wordWrapMode(){return eb.get(this)._GetWrapMode()}set textDirection(t){vC.RequireString(t);const e=rb.indexOf(t);if(-1===e)throw new Error("invalid text direction");eb.get(this)._SetTextDirection(e)}get textDirection(){return rb[eb.get(this)._GetTextDirection()]}set readAloud(t){eb.get(this)._SetReadAloud(!!t)}get readAloud(){return eb.get(this)._IsReadAloud()}setFixedResolutionMode(t){vC.RequireFiniteNumber(t);const e=eb.get(this);e._SetResolutionMode("fixed"),e._SetFixedScaleFactor(t)}setAutoResolutionMode(){eb.get(this)._SetResolutionMode("auto")}get textWidth(){return eb.get(this)._GetTextWidth()}get textHeight(){return eb.get(this)._GetTextHeight()}getTextSize(){const t=eb.get(this);return[t._GetTextWidth(),t._GetTextHeight()]}hasTagAtPosition(t,e,s){return vC.RequireString(t),vC.RequireFiniteNumber(e),vC.RequireFiniteNumber(s),eb.get(this)._HasTagAtPosition(t,e,s)}getTagAtPosition(t,e){return vC.RequireFiniteNumber(t),vC.RequireFiniteNumber(e),eb.get(this)._GetTagAtPosition(t,e)}getTagPositionAndSize(t,e=0){return vC.RequireString(t),vC.RequireFiniteNumber(e),eb.get(this)._GetTagPosition(t,e)}getTagCount(t){return vC.RequireString(t),eb.get(this)._GetTagCount(t)}changeIconSet(t){const e=eb.get(this),s=e.GetRuntime()._UnwrapIObjectClass(t);e._SetIconObjectClass(s)}getAsHtmlString(){return eb.get(this)._UpdateHTMLString()}}}{const nb=self.C3;nb.Plugins.Text.Cnds={CompareText(t,e){return e?this._text===t:nb.equalsNoCase(this._text,t)},IsRunningTypewriterText(){return-1!==this._typewriterEndTime},OnTypewriterTextFinished:()=>!0,HasTagAtPosition(t,e,s){return this._HasTagAtPosition(t,e,s)}}}{const ab=self.C3,ob=ab.New(ab.Color);ab.Plugins.Text.Acts={SetText(t){this._CancelTypewriter(),"number"==typeof t&&t<1e9&&(t=Math.round(1e10*t)/1e10),this._SetText(t.toString())},AppendText(t){this._CancelTypewriter(),"number"==typeof t&&t<1e9&&(t=Math.round(1e10*t)/1e10),(t=t.toString())&&this._SetText(this._text+t)},TypewriterText(t,e){this._CancelTypewriter(),"number"==typeof t&&t<1e9&&(t=Math.round(1e10*t)/1e10),this._StartTypewriter(t.toString(),e)},SetFontFace(t,e){let s=!1,i=!1;switch(e){case 1:s=!0;break;case 2:i=!0;break;case 3:s=!0,i=!0}t===this._faceName&&s===this._isBold&&i===this._isItalic||(this._SetFontFace(t),this._SetBold(s),this._SetItalic(i))},SetFontSize(t){this._SetFontSize(t)},SetFontColor(t){ob.setFromRgbValue(t),ob.clamp(),this._SetFontColor(ob)},SetWebFont(t,e){console.warn("[Text] 'Set web font' action is deprecated and no longer has any effect")},SetEffect(t){this.GetWorldInfo().SetBlendMode(t),this._runtime.UpdateRender()},TypewriterFinish(){this._FinishTypewriter()},SetLineHeight(t){this._SetLineHeight(t)},SetHAlign(t){this._SetHAlign(t)},SetVAlign(t){this._SetVAlign(t)},SetWrapping(t){this._SetWrapModeByIndex(t)},SetTextDirection(t){this._SetTextDirection(t)},ChangeIconSet(t){this._SetIconObjectClass(t)},UpdateHTML(){return this._UpdateHTMLString()},SetReadAloud(t){this._SetReadAloud(t)},SetResolutionMode(t,e){this._SetResolutionMode(["auto","fixed"][t]),this._SetFixedScaleFactor(e)}}}{const hb=self.C3;hb.Plugins.Text.Exps={Text(){return this._text},PlainText(){return this._enableBBcode?hb.BBString.StripAnyTags(this._text):this._text},FaceName(){return this._faceName},FaceSize(){return this._ptSize},TextWidth(){return this._GetTextWidth()},TextHeight(){return this._GetTextHeight()},LineHeight(){return this._lineHeightOffset},TagAtPosition(t,e){return this._GetTagAtPosition(t,e)},TagCount(t){return this._GetTagCount(t)},TagX(t,e){const s=this._GetTagPosition(t,e);return s?s.x:0},TagY(t,e){const s=this._GetTagPosition(t,e);return s?s.y:0},TagWidth(t,e){const s=this._GetTagPosition(t,e);return s?s.width:0},TagHeight(t,e){const s=this._GetTagPosition(t,e);return s?s.height:0},AsHTML(){return this._htmlString}}}{const lb=self.C3;lb.Plugins.Particles=class extends lb.SDKPluginBase{constructor(t){super(t)}Release(){super.Release()}}}{const cb=self.C3;cb.Plugins.Particles.Type=class extends cb.SDKTypeBase{constructor(t){super(t)}Release(){super.Release()}OnCreate(){this.GetImageInfo().LoadAsset(this._runtime)}LoadTextures(t){return this.GetImageInfo().LoadStaticTexture(t,{sampling:this._runtime.GetSampling()})}ReleaseTextures(){this.GetImageInfo().ReleaseTexture()}}}{let ub=function(t){return kb.get(t).GetParticleEngine()};0;const _b=self.C3,db=self.C3X,pb=0,fb=1,gb=2,mb=3,Sb=4,yb=5,Gb=6,Tb=7,Ib=8,Cb=9,bb=10,xb=11,wb=12,Mb=13,Pb=14,vb=15,Rb=16,Ab=17,Db=18,Eb=19,Fb=20,Ob=0,Bb=1,Lb=_b.New(_b.Rect);_b.Plugins.Particles.Instance=class extends _b.SDKWorldInstanceBase{constructor(t,e){super(t),this._isFirstTick=!0;const s=_b.New(self.ParticleEngine);this._particleEngine=s,s.ononeshotfinish=()=>this._OnOneShotFinish(),this._spawnObjectClass=null,this._particleUpdateCallback=(t,e,s,i,r,n)=>this._OnParticleUpdate(t,e,s,i,r,n),this._particleDestroyCallback=t=>this._OnParticleDestroy(t),this._hasAnyDefaultParticle=!0;let i=!0;e&&(s.SetRate(e[pb]),s.SetSprayCone(_b.toRadians(e[fb])),s.SetSprayType(e[gb]?"one-shot":"continuous-spray"),this._SetParticleObjectClass(this._runtime.GetObjectClassBySID(e[mb])),i=e[Sb],s.SetInitSpeed(e[yb]),s.SetInitSize(e[Gb]),s.SetInitOpacity(e[Tb]/100),s.SetGrowRate(e[Ib]),s.SetInitXRandom(e[Cb]),s.SetInitYRandom(e[bb]),s.SetInitSpeedRandom(e[xb]),s.SetInitSizeRandom(e[wb]),s.SetGrowRandom(e[Mb]),s.SetAcceleration(e[Pb]),s.SetGravity(e[vb]),s.SetLifeAngleRandom(e[Rb]),s.SetLifeSpeedRandom(e[Ab]),s.SetLifeOpacityRandom(e[Db]),s.SetDestroyModeIndex(e[Eb]),s.SetTimeout(e[Fb])),this._UpdateEngineParameters(),this._spawnObjectClass&&(this._hasAnyDefaultParticle=!1),"one-shot"===s.GetSprayType()?s.CreateOneShotSpray():s.SetSpraying(!0);const r=this.GetWorldInfo();r.SetVisible(i),r.SetBboxChangeEventEnabled(!0),this._inst.Dispatcher().addEventListener("bboxchange",()=>{r.OverwriteBoundingBox(this._particleEngine.GetBoundingBox())}),this.GetRuntime().GetRenderer().IsWebGPU()&&r.SetUsePointsShaderProgram(),this._afterLoad=t=>this._OnAfterLoad(t),this.GetRuntime().Dispatcher().addEventListener("afterload",this._afterLoad),this._StartTicking()}Release(){this.GetRuntime().Dispatcher().removeEventListener("afterload",this._afterLoad),this._afterLoad=null,this._particleEngine.Release(),this._particleEngine=null,this._particleUpdateCallback=null,this._particleDestroyCallback=null,super.Release()}GetParticleEngine(){return this._particleEngine}_SetRate(t){this._particleEngine.SetRate(t),"one-shot"===this._particleEngine.GetSprayType()&&this._isFirstTick&&this._particleEngine.SetParticleCount(t)}_SetParticleObjectClass(t){t===this.GetObjectClass()&&(t=null),t!==this._spawnObjectClass&&(this._spawnObjectClass=t,this._particleEngine.onparticlecreate=t?t=>this._OnParticleCreate(t):null,this._spawnObjectClass||(this._hasAnyDefaultParticle=!0))}_UpdateEngineParameters(){const t=this._particleEngine,e=this.GetWorldInfo();t.SetMasterOpacity(e.GetOpacity()),t.SetPixelRounding(this._runtime.IsPixelRoundingEnabled()),t.SetSpawnX(e.GetX()),t.SetSpawnY(e.GetY()),t.SetSpawnAngle(e.GetAngle()),t.SetInitSizeScale(Math.abs(e.GetSceneGraphScale()))}_OnOneShotFinish(){this._runtime.DestroyInstance(this._inst)}Draw(t){if(!this._hasAnyDefaultParticle)return;const e=this._objectClass.GetImageInfo(),s=e.GetTexture();if(!s)return;const i=this.GetWorldInfo(),r=i.GetLayer(),n=Lb;this._runtime.GetCanvasManager().IsPastingToDrawingCanvas()?n.set(-1/0,-1/0,1/0,1/0):r.Has3DCamera()?r.CalculateViewport3D(i.GetTotalZElevation(),n):r.GetViewportForZ(i.GetTotalZElevation(),n),t.SetTexture(s);const a=r.Get2DScaleFactorToZ(i.GetTotalZElevation());this._particleEngine.SetParticleScale(r.GetRenderScale()*a),this._particleEngine.Draw(t,e.GetTexQuad(),n,r.Has3DCamera())}SaveToJson(){const t=this._particleEngine;return{r:t.GetRate(),sc:t.GetSprayCone(),st:t.GetSprayType(),isp:t.GetInitSpeed(),isz:t.GetInitSize(),io:t.GetInitOpacity(),gr:t.GetGrowRate(),xr:t.GetInitXRandom(),yr:t.GetInitYRandom(),spr:t.GetInitSpeedRandom(),szr:t.GetInitSizeRandom(),grnd:t.GetGrowRandom(),acc:t.GetAcceleration(),g:t.GetGravity(),lar:t.GetLifeAngleRandom(),lsr:t.GetLifeSpeedRandom(),lor:t.GetLifeOpacityRandom(),dm:t.GetDestroyModeIndex(),to:t.GetTimeout(),s:t.IsSpraying(),pcc:t._GetCreateCounter(),ft:this._isFirstTick,soc:this._spawnObjectClass?this._spawnObjectClass.GetSID():null,p:t.GetParticles().map(t=>t.toJSON())}}LoadFromJson(t,e){const s=this._particleEngine;if(s.SetRate(t.r),s.SetSprayCone(t.sc),s.SetSprayType(t.st),s.SetInitSpeed(t.isp),s.SetInitSize(t.isz),s.SetInitOpacity(t.io),s.SetGrowRate(t.gr),s.SetInitXRandom(t.xr),s.SetInitYRandom(t.yr),s.SetInitSpeedRandom(t.spr),s.SetInitSizeRandom(t.szr),s.SetGrowRandom(t.grnd),s.SetAcceleration(t.acc),s.SetGravity(t.g),s.SetLifeAngleRandom(t.lar),s.SetLifeSpeedRandom(t.lsr),s.SetLifeOpacityRandom(t.lor),s.SetDestroyModeIndex(t.dm),s.SetTimeout(t.to),s.SetSpraying(t.s),s._SetCreateCounter(t.pcc),this._isFirstTick=t.ft,t.hasOwnProperty("soc")){const e=this.GetRuntime().GetObjectClassBySID(t.soc);e&&this._SetParticleObjectClass(e)}const i=t.p;s.SetParticleCount(i.length,!1);const r=s.GetParticles();for(let t=0,e=r.length;t<e;++t)r[t].setFromJSON(i[t]);"state"===e&&this._spawnObjectClass&&(s.UpdateAllParticlesUserData(),s.ApplyParticleDataToUserData(this))}_OnAfterLoad(){const t=this._particleEngine;t.UpdateAllParticlesUserData(),t.ApplyParticleDataToUserData(this);const e=t.GetParticles();for(let t=0,s=e.length;t<s;++t){const s=e[t],i=s.GetUserData();if(!i)continue;const r=i.GetWorldInfo();if(!r)continue;const n=r.GetInstance();if(!n)continue;const a=s.GetUserDataUID(),o=n.GetUID();if(("number"!=typeof a||"number"!=typeof o||a!==o)&&"number"==typeof a){const t=this.GetRuntime(),e=t.GetInstanceByUID(a);e&&t.DestroyInstance(e)}}}Tick(){const t=this._runtime.GetDt(this._inst);this._UpdateEngineParameters(),this._isFirstTick&&"one-shot"===this._particleEngine.GetSprayType()&&this._particleEngine.ReInitAllParticles(),this._particleEngine.Tick(t),this._particleEngine.IsSpraying()&&this._runtime.UpdateRender(),this.GetWorldInfo().SetBboxChanged(),this._isFirstTick=!1}_FastForward(t){const e=1/60;for(this._isFirstTick&&"one-shot"===this._particleEngine.GetSprayType()&&this._particleEngine.ReInitAllParticles();t>0;)this._particleEngine.Tick(e),t-=e;this._particleEngine.IsSpraying()&&this._runtime.UpdateRender(),this.GetWorldInfo().SetBboxChanged(),this._isFirstTick=!1}_OnParticleCreate(t,e){let s;"number"==typeof e&&(s=this._runtime.GetInstanceByUID(e)),s&&s.GetObjectClass()!==this._spawnObjectClass&&(s=null),s||(s=this._runtime.CreateInstance(this._spawnObjectClass,this.GetWorldInfo().GetLayer(),t.GetX(),t.GetY()));const i=s.GetWorldInfo();return i.SetSize(t.GetSize(),t.GetSize()),i.SetAngle(t.GetAngle()),i.SetOpacity(t.GetOpacity()),i.SetUnpremultipliedColor(this.GetWorldInfo().GetUnpremultipliedColor()),i.SetBboxChanged(),i.ZOrderMoveAdjacentToInstance(this.GetInstance(),!0),s._TriggerOnCreated(),t.SetUpdateCallback(this._particleUpdateCallback),t.SetDestroyCallback(this._particleDestroyCallback),s}_OnParticleUpdate(t,e,s,i,r,n){if(t.IsDestroyed())return;const a=t.GetWorldInfo();a.OffsetXY(e,s),a.SetSize(a.GetWidth()+i,a.GetHeight()+i),a.SetAngle(a.GetAngle()+r),a.SetOpacity(a.GetOpacity()+n),a.SetBboxChanged()}_OnParticleDestroy(t){t.IsDestroyed()||this._runtime.DestroyInstance(t)}GetPropertyValueByIndex(t){const e=this._particleEngine;switch(t){case pb:return e.GetRate();case fb:return _b.toDegrees(e.GetSprayCone());case gb:return"one-shot"===e.GetSprayType()?Bb:Ob;case yb:return e.GetInitSpeed();case Gb:return e.GetInitSize();case Tb:return 100*e.GetInitOpacity();case Ib:return e.GetGrowRate();case Cb:return e.GetInitXRandom();case bb:return e.GetInitYRandom();case xb:return e.GetInitSpeedRandom();case wb:return e.GetInitSizeRandom();case Mb:return e.GetGrowRandom();case Pb:return e.GetAcceleration();case vb:return e.GetGravity();case Rb:return e.GetLifeAngleRandom();case Ab:return e.GetLifeSpeedRandom();case Db:return e.GetLifeOpacityRandom();case Eb:return e.GetDestroyModeIndex();case Fb:return e.GetTimeout()}}SetPropertyValueByIndex(t,e){const s=this._particleEngine;switch(t){case pb:s.SetRate(e);break;case fb:s.SetSprayCone(_b.toRadians(e));break;case gb:s.SetSprayType(e?"one-shot":"continuous-spray");break;case yb:s.SetInitSpeed(e);break;case Gb:s.SetInitSize(e);break;case Tb:s.SetInitOpacity(e/100);break;case Ib:s.SetGrowRate(e);break;case Cb:s.SetInitXRandom(e);break;case bb:s.SetInitYRandom(e);break;case xb:s.SetInitSpeedRandom(e);break;case wb:s.SetInitSizeRandom(e);break;case Mb:s.SetGrowRandom(e);break;case Pb:s.SetAcceleration(e);break;case vb:s.SetGravity(e);break;case Rb:s.SetLifeAngleRandom(e);break;case Ab:s.SetLifeSpeedRandom(e);break;case Db:s.SetLifeOpacityRandom(e);break;case Eb:s.SetDestroyModeIndex(e);break;case Fb:s.SetTimeout(e)}}GetDebuggerProperties(){const t="plugins.particles",e=t+".properties",s=t+".debugger",i=this._particleEngine;return[{title:t+".name",properties:[{name:s+".particle-count",value:i.GetParticleCount()},{name:e+".type.name",value:[e+".type.items."+i.GetSprayType()]},{name:s+".is-spraying",value:i.IsSpraying(),onedit:t=>i.SetSpraying(t)},{name:e+".rate.name",value:i.GetRate(),onedit:t=>i.SetRate(t)},{name:e+".spray-cone.name",value:_b.toDegrees(i.GetSprayCone()),onedit:t=>i.SetSprayCone(_b.toRadians(t))},{name:e+".speed.name",value:i.GetInitSpeed(),onedit:t=>i.SetInitSpeed(t)},{name:e+".size.name",value:i.GetInitSize(),onedit:t=>i.SetInitSize(t)},{name:e+".opacity.name",value:i.GetInitOpacity(),onedit:t=>i.SetInitOpacity(t)},{name:e+".grow-rate.name",value:i.GetGrowRate(),onedit:t=>i.SetGrowRate(t)},{name:e+".x-randomiser.name",value:i.GetInitXRandom(),onedit:t=>i.SetInitXRandom(t)},{name:e+".y-randomiser.name",value:i.GetInitYRandom(),onedit:t=>i.SetInitYRandom(t)},{name:e+".initial-speed-randomiser.name",value:i.GetInitSpeedRandom(),onedit:t=>i.SetInitSpeedRandom(t)},{name:e+".size-randomiser.name",value:i.GetInitSizeRandom(),onedit:t=>i.SetInitSizeRandom(t)},{name:e+".grow-rate-randomiser.name",value:i.GetGrowRandom(),onedit:t=>i.SetGrowRandom(t)},{name:e+".acceleration.name",value:i.GetAcceleration(),onedit:t=>i.SetAcceleration(t)},{name:e+".gravity.name",value:i.GetGravity(),onedit:t=>i.SetGravity(t)},{name:e+".angle-randomiser.name",value:i.GetLifeAngleRandom(),onedit:t=>i.SetLifeAngleRandom(t)},{name:e+".life-speed-randomiser.name",value:i.GetLifeSpeedRandom(),onedit:t=>i.SetLifeSpeedRandom(t)},{name:e+".opacity-randomiser.name",value:i.GetLifeOpacityRandom(),onedit:t=>i.SetLifeOpacityRandom(t)},{name:e+".timeout.name",value:i.GetTimeout(),onedit:t=>i.SetTimeout(t)}]}]}GetScriptInterfaceClass(){return self.IParticlesInstance}};const kb=new WeakMap;self.IParticlesInstance=class extends self.IWorldInstance{constructor(){super(),kb.set(this,self.IInstance._GetInitInst().GetSdkInstance())}set isSpraying(t){ub(this).SetSpraying(!!t)}get isSpraying(){return ub(this).IsSpraying()}set rate(t){db.RequireFiniteNumber(t),kb.get(this)._SetRate(t)}get rate(){return ub(this).GetRate()}set sprayCone(t){db.RequireFiniteNumber(t),ub(this).SetSprayCone(t)}get sprayCone(){return ub(this).GetSprayCone()}set initSpeed(t){db.RequireFiniteNumber(t),ub(this).SetInitSpeed(t)}get initSpeed(){return ub(this).GetInitSpeed()}set initSize(t){db.RequireFiniteNumber(t),ub(this).SetInitSize(t)}get initSize(){return ub(this).GetInitSize()}set initOpacity(t){db.RequireFiniteNumber(t),ub(this).SetInitOpacity(t)}get initOpacity(){return ub(this).GetInitOpacity()}set initXRandom(t){db.RequireFiniteNumber(t),ub(this).SetInitXRandom(t)}get initXRandom(){return ub(this).GetInitXRandom()}set initYRandom(t){db.RequireFiniteNumber(t),ub(this).SetInitYRandom(t)}get initYRandom(){return ub(this).GetInitYRandom()}set initSpeedRandom(t){db.RequireFiniteNumber(t),ub(this).SetInitSpeedRandom(t)}get initSpeedRandom(){return ub(this).GetInitSpeedRandom()}set initSizeRandom(t){db.RequireFiniteNumber(t),ub(this).SetInitSizeRandom(t)}get initSizeRandom(){return ub(this).GetInitSizeRandom()}set initGrowRate(t){db.RequireFiniteNumber(t),ub(this).SetGrowRate(t)}get initGrowRate(){return ub(this).GetGrowRate()}set initGrowRandom(t){db.RequireFiniteNumber(t),ub(this).SetGrowRandom(t)}get initGrowRandom(){return ub(this).GetGrowRandom()}set acceleration(t){db.RequireFiniteNumber(t),ub(this).SetAcceleration(t)}get acceleration(){return ub(this).GetAcceleration()}set gravity(t){db.RequireFiniteNumber(t),ub(this).SetGravity(t)}get gravity(){return ub(this).GetGravity()}set lifeAngleRandom(t){db.RequireFiniteNumber(t),ub(this).SetLifeAngleRandom(t)}get lifeAngleRandom(){return ub(this).GetLifeAngleRandom()}set lifeSpeedRandom(t){db.RequireFiniteNumber(t),ub(this).SetLifeSpeedRandom(t)}get lifeSpeedRandom(){return ub(this).GetLifeSpeedRandom()}set lifeOpacityRandom(t){db.RequireFiniteNumber(t),ub(this).SetLifeOpacityRandom(t)}get lifeOpacityRandom(){return ub(this).GetLifeOpacityRandom()}set timeout(t){db.RequireFiniteNumber(t),ub(this).SetTimeout(t)}get timeout(){return ub(this).GetTimeout()}fastForward(t){db.RequireFiniteNumber(t),kb.get(this)._FastForward(t)}setParticleObjectClass(t){const e=kb.get(this);t?e._SetParticleObjectClass(e.GetRuntime()._UnwrapIObjectClass(t)):e._SetParticleObjectClass(null)}}}self.C3.Plugins.Particles.Cnds={IsSpraying(){return this._particleEngine.IsSpraying()}};{const Nb=self.C3;Nb.Plugins.Particles.Acts={SetSpraying(t){this._particleEngine.SetSpraying(0!==t)},SetRate(t){this._SetRate(t)},SetParticleObject(t){this._SetParticleObjectClass(t)},UnsetParticleObject(){this._SetParticleObjectClass(null)},SetSprayCone(t){this._particleEngine.SetSprayCone(Nb.toRadians(t))},SetInitSpeed(t){this._particleEngine.SetInitSpeed(t)},SetInitSize(t){this._particleEngine.SetInitSize(t)},SetInitOpacity(t){this._particleEngine.SetInitOpacity(t/100)},SetGrowRate(t){this._particleEngine.SetGrowRate(t)},SetXRandomiser(t){this._particleEngine.SetInitXRandom(t)},SetYRandomiser(t){this._particleEngine.SetInitYRandom(t)},SetSpeedRandomiser(t){this._particleEngine.SetInitSpeedRandom(t)},SetSizeRandomiser(t){this._particleEngine.SetInitSizeRandom(t)},SetGrowRateRandomiser(t){this._particleEngine.SetGrowRandom(t)},SetParticleAcc(t){this._particleEngine.SetAcceleration(t)},SetGravity(t){this._particleEngine.SetGravity(t)},SetAngleRandomiser(t){this._particleEngine.SetLifeAngleRandom(t)},SetLifeSpeedRandomiser(t){this._particleEngine.SetLifeSpeedRandom(t)},SetOpacityRandomiser(t){this._particleEngine.SetLifeOpacityRandom(t)},SetTimeout(t){this._particleEngine.SetTimeout(t)},FastForward(t){this._FastForward(t)},SetEffect(t){this.GetWorldInfo().SetBlendMode(t),this._runtime.UpdateRender()}}}{const Ub=self.C3;Ub.Plugins.Particles.Exps={ParticleCount(){return this._particleEngine.GetParticleCount()},Rate(){return this._particleEngine.GetRate()},SprayCone(){return Ub.toDegrees(this._particleEngine.GetSprayCone())},InitSpeed(){return this._particleEngine.GetInitSpeed()},InitSize(){return this._particleEngine.GetInitSize()},InitOpacity(){return 100*this._particleEngine.GetInitOpacity()},InitGrowRate(){return this._particleEngine.GetGrowRate()},XRandom(){return this._particleEngine.GetInitXRandom()},YRandom(){return this._particleEngine.GetInitYRandom()},InitSizeRandom(){return this._particleEngine.GetInitSizeRandom()},InitSpeedRandom(){return this._particleEngine.GetInitSpeedRandom()},InitGrowRandom(){return this._particleEngine.GetGrowRandom()},ParticleAcceleration(){return this._particleEngine.GetAcceleration()},Gravity(){return this._particleEngine.GetGravity()},ParticleAngleRandom(){return this._particleEngine.GetLifeAngleRandom()},ParticleSpeedRandom(){return this._particleEngine.GetLifeSpeedRandom()},ParticleOpacityRandom(){return this._particleEngine.GetLifeOpacityRandom()},Timeout(){return this._particleEngine.GetTimeout()}}}{const Wb=self.C3,jb=[],Vb=new Set(["continuous-spray","one-shot"]),zb=["fade-to-invisible","timeout-expired","particle-stopped"],Hb=Wb.New(Wb.Rect);self.ParticleEngine=class{constructor(){this._rate=0,this._sprayCone=0,this._sprayType="continuous-spray",this._isSpraying=!1,this._masterOpacity=0,this._isPixelRounding=!1,this._spawnX=0,this._spawnY=0,this._spawnAngle=0,this._initSpeed=0,this._initSize=0,this._initSizeScale=1,this._initOpacity=0,this._growRate=0,this._xRandom=0,this._yRandom=0,this._initSpeedRandom=0,this._initSizeRandom=0,this._growRandom=0,this._acceleration=0,this._gravity=0,this._lifeAngleRandom=0,this._lifeSpeedRandom=0,this._lifeOpacityRandom=0,this._destroyMode=0,this._timeout=0,this._createCounter=0,this._particleScale=1,this.ononeshotfinish=null,this.onparticlecreate=null,this._particles=[],this._boundingBox=new Wb.Rect,this._color=new Wb.Color,this._devicePixelRatio=globalThis.devicePixelRatio||1}Release(){this.Cancel(),Wb.clearArray(this._particles),this._particles=null,this.ononeshotfinish=null,this.onparticlecreate=null,this._boundingBox=null,this._color=null}Cancel(){const t=this._particles;for(let e=0,s=t.length;e<s;++e)t[e].Destroy();Wb.appendArray(jb,t),Wb.clearArray(t),jb.length>1e3&&Wb.truncateArray(jb,1e3),this._isSpraying=!1}CreateOneShotSpray(){for(let t=0,e=this._rate;t<e;++t)this._CreateParticle();this._particles.length&&(this._isSpraying=!0)}_CreateParticle(t=!0){let e=null;return jb.length?(e=jb.pop(),e.SetEngine(this)):e=Wb.New(self.Particle,this),this._particles.push(e),t?e.Init(this.onparticlecreate):e.Init(),e}ReInitAllParticles(){const t=this._particles,e=this.onparticlecreate;for(let s=0,i=t.length;s<i;++s)t[s].Init(e)}UpdateAllParticlesUserData(){const t=this._particles,e=this.onparticlecreate;for(let s=0,i=t.length;s<i;++s)t[s].UpdateUserData(e)}ApplyParticleDataToUserData(t){const e=this._particles;for(let s=0,i=e.length;s<i;++s){const i=e[s],r=i.GetUserData();if(r){const e=r.GetWorldInfo();e.SetX(i.GetX()),e.SetY(i.GetY()),e.SetSize(i.GetSize(),i.GetSize()),e.SetOpacity(i.GetOpacity()),e.SetAngle(i.GetAngle()),e.SetUnpremultipliedColor(t.GetWorldInfo().GetUnpremultipliedColor()),e.SetBboxChanged()}}}SetParticleCount(t,e=!0){const s=this._particles;if(t<s.length){const e=s.length-t;for(let t=0;t<e;++t){const t=s.pop();t.Destroy(),jb.push(t)}jb.length>1e3&&Wb.truncateArray(jb,1e3)}else if(t>s.length){const i=t-s.length;for(let t=0;t<i;++t)this._CreateParticle(e)}}GetParticles(){return this._particles}GetParticleCount(){return this._particles.length}Tick(t){this._SpawnContinuous(t),this._TickParticles(t),this._MaybeFinishOneShot()}_SpawnContinuous(t){if("continuous-spray"===this._sprayType&&this._isSpraying){this._createCounter+=t*this._rate;const e=Math.floor(this._createCounter);this._createCounter-=e;for(let t=0;t<e;++t)this._CreateParticle()}}_SetCreateCounter(t){this._createCounter=t}_GetCreateCounter(){return this._createCounter}_TickParticles(t){const e=this._boundingBox;e.set(this._spawnX,this._spawnY,this._spawnX,this._spawnY);const s=this._particles;let i=0;for(let r=0,n=s.length;r<n;++r){const n=s[r];s[i]=n,n.Tick(t),n.IsActive()?(++i,e.expandToContain(n.GetBoundingBox())):(n.Destroy(),jb.push(n))}Wb.truncateArray(s,i),jb.length>1e3&&Wb.truncateArray(jb,1e3)}_MaybeFinishOneShot(){"one-shot"===this._sprayType&&0===this._particles.length&&this._isSpraying&&(this.ononeshotfinish&&this.ononeshotfinish(),this._isSpraying=!1)}Draw(t,e,s,i){this._devicePixelRatio=globalThis.devicePixelRatio||1,Hb.set(e.getTlx(),e.getTly(),e.getBrx(),e.getBry()),t.StartRenderingPoints(Hb),this._color.copy(t.GetColor());const r=this._particles;for(let n=0,a=r.length;n<a;++n){const a=r[n];s.intersectsRect(a.GetBoundingBox())&&a.Draw(t,e,i)}t.FinishRenderingPoints()}GetColor(){return this._color}SetRate(t){this._rate=+t}GetRate(){return this._rate}SetSprayCone(t){this._sprayCone=+t}GetSprayCone(){return this._sprayCone}SetSprayType(t){if(!Vb.has(t))throw new Error("invalid spray type");this._sprayType=t}GetSprayType(){return this._sprayType}SetSpraying(t){this._isSpraying=!!t}IsSpraying(){return this._isSpraying}SetMasterOpacity(t){this._masterOpacity=+t}GetMasterOpacity(){return this._masterOpacity}SetPixelRounding(t){this._isPixelRounding=!!t}IsPixelRounding(){return this._isPixelRounding}SetSpawnX(t){this._spawnX=+t}GetSpawnX(){return this._spawnX}SetSpawnY(t){this._spawnY=+t}GetSpawnY(){return this._spawnY}SetSpawnAngle(t){this._spawnAngle=+t}GetInitAngle(){return this._spawnAngle}SetInitSpeed(t){this._initSpeed=+t}GetInitSpeed(){return this._initSpeed}SetInitSize(t){this._initSize=+t}GetInitSize(){return this._initSize}SetInitSizeScale(t){this._initSizeScale=+t}GetInitSizeScale(){return this._initSizeScale}SetInitOpacity(t){this._initOpacity=+t}GetInitOpacity(){return this._initOpacity}SetGrowRate(t){this._growRate=+t}GetGrowRate(){return this._growRate}SetInitXRandom(t){this._xRandom=+t}GetInitXRandom(){return this._xRandom}SetInitYRandom(t){this._yRandom=+t}GetInitYRandom(){return this._yRandom}SetInitSpeedRandom(t){this._initSpeedRandom=+t}GetInitSpeedRandom(){return this._initSpeedRandom}SetInitSizeRandom(t){this._initSizeRandom=+t}GetInitSizeRandom(){return this._initSizeRandom}SetGrowRandom(t){this._growRandom=+t}GetGrowRandom(){return this._growRandom}SetAcceleration(t){this._acceleration=+t}GetAcceleration(){return this._acceleration}SetGravity(t){this._gravity=+t}GetGravity(){return this._gravity}SetLifeAngleRandom(t){this._lifeAngleRandom=+t}GetLifeAngleRandom(){return this._lifeAngleRandom}SetLifeSpeedRandom(t){this._lifeSpeedRandom=+t}GetLifeSpeedRandom(){return this._lifeSpeedRandom}SetLifeOpacityRandom(t){this._lifeOpacityRandom=+t}GetLifeOpacityRandom(){return this._lifeOpacityRandom}SetDestroyMode(t){let e=zb.indexOf(t);if(-1===e)throw new Error("invalid destroy mode");this._destroyMode=e}SetDestroyModeIndex(t){this.SetDestroyMode(zb[t])}GetDestroyMode(){return zb[this._destroyMode]}GetDestroyModeIndex(){return this._destroyMode}SetTimeout(t){this._timeout=+t}GetTimeout(){return this._timeout}SetParticleScale(t){this._particleScale=+t}GetParticleScale(){return this._particleScale}GetBoundingBox(){return this._boundingBox}GetDevicePixelRatio(){return this._devicePixelRatio}}}{let Yb=function(t){return Math.random()*t-t/2};0;const Xb=self.C3,qb=(self.ParticleEngine,new Xb.Quad),Jb=new Xb.Color;let Qb=!1;self.Particle=class{constructor(t){this._engine=t,this._isActive=!1,this._x=0,this._y=0,this._speed=0,this._angle=0,this._opacity=1,this._lastOpacity=0,this._grow=0,this._size=0,this._halfSize=0,this._gs=0,this._age=0,this._bbox=new Xb.Rect,this._userData=null,this._userDataUid=NaN,this._updateCallback=null,this._destroyCallback=null}SetEngine(t){this._engine=t}Init(t){const e=this._engine;this._isActive=!0,this._x=e.GetSpawnX()+Yb(e.GetInitXRandom()),this._y=e.GetSpawnY()+Yb(e.GetInitYRandom()),this._speed=e.GetInitSpeed()+Yb(e.GetInitSpeedRandom()),this._angle=e.GetInitAngle()+Yb(e.GetSprayCone()),this._opacity=e.GetInitOpacity(),this._lastOpacity=this._opacity,this._size=(e.GetInitSize()+Yb(e.GetInitSizeRandom()))*e.GetInitSizeScale(),this._halfSize=this._size/2,this._grow=e.GetGrowRate()+Yb(e.GetGrowRandom()),this._gs=0,this._age=0,this._UpdateBoundingBox(),t?this._userData||(this._userData=t(this)):(this._userData=null,this._updateCallback=null,this._destroyCallback=null)}UpdateUserData(t){t?this._userData&&!this._userData.IsDestroyed()||(this._userData=t(this,this._userDataUid)):(this._userData=null,this._updateCallback=null,this._destroyCallback=null)}SetUpdateCallback(t){this._updateCallback=t}SetDestroyCallback(t){this._destroyCallback=t}Destroy(){const t=this._destroyCallback;t&&t(this._userData),this._userData=null,this._updateCallback=null,this._destroyCallback=null}toJSON(){let t;return this._userData&&this._userData.GetWorldInfo()&&(t=this._userData.GetWorldInfo().GetInstance().GetUID()),[this._x,this._y,this._speed,this._angle,this._opacity,this._grow,this._size,this._gs,this._age,t]}setFromJSON(t){this._x=t[0],this._y=t[1],this._speed=t[2],this._angle=t[3],this._opacity=t[4],this._lastOpacity=this._opacity,this._grow=t[5],this._size=t[6],this._gs=t[7],this._age=t[8],this._userDataUid=t[9],this._halfSize=this._size/2,this._UpdateBoundingBox()}Tick(t){const e=this._engine,s=this._speed*t,i=this._angle,r=Math.cos(i)*s,n=Math.sin(i)*s+this._gs*t;this._x+=r,this._y+=n;const a=this._grow*t;this._size+=a,this._halfSize=this._size/2,this._speed+=e.GetAcceleration()*t,this._gs+=e.GetGravity()*t,this._age+=t,this._UpdateBoundingBox();const o=e.GetLifeAngleRandom(),h=e.GetLifeSpeedRandom(),l=e.GetLifeOpacityRandom();let c=0;0!==o&&(c=Yb(o*t),this._angle+=c),0!==h&&(this._speed+=Yb(h*t)),0!==l&&(this._opacity=Xb.clamp(this._opacity+Yb(l*t),0,1));const u=this._size>=1&&(2===e.GetDestroyModeIndex()?this._speed>0:this._age<e.GetTimeout()),_=this._updateCallback;if(_&&u){let t=e.GetMasterOpacity()*this._opacity;0===e.GetDestroyModeIndex()&&(t*=1-this._age/e.GetTimeout());const s=t-this._lastOpacity;this._lastOpacity=t,_(this._userData,r,n,a,c,s)}this._isActive=u}IsActive(){return this._isActive}GetBoundingBox(){return this._bbox}_UpdateBoundingBox(){const t=this._x,e=this._y,s=this._halfSize;this._bbox.set(t-s,e-s,t+s,e+s)}Draw(t,e,s){if(this._userData)return;const i=this._engine;let r=i.GetMasterOpacity()*this._opacity;if(0===i.GetDestroyModeIndex()&&(r*=1-this._age/i.GetTimeout()),r<=0)return;const n=this._size,a=n*i.GetParticleScale()*i.GetDevicePixelRatio();if(a<1)return;let o=this._x,h=this._y;i.IsPixelRounding()&&(o=o+.5|0,h=h+.5|0),t.IsWebGPU()?t.Point(o,h,n,r):s||a>t.GetMaxPointSize()||a<t.GetMinPointSize()?(Jb.copy(i.GetColor()),Jb.multiplyAlpha(r),t.SetColor(Jb),Qb=!0,qb.setFromRect(this._bbox),t.Quad4(qb,e)):(Qb&&(t.SetColor(i.GetColor()),Qb=!1),t.Point(o,h,a,r))}GetUserData(){return this._userData}GetUserDataUID(){return this._userDataUid}GetX(){return this._x}GetY(){return this._y}GetSize(){return this._size}GetAngle(){return this._angle}GetOpacity(){return this._opacity}}}{const Kb=self.C3,Zb=[];Kb.Plugins.Audio=class extends Kb.SDKPluginBase{constructor(t){super(t)}_AddActionPromise(t){Zb.push(t)}static async WaitForAllActionPromises(){await Promise.all(Zb),Kb.clearArray(Zb)}Release(){super.Release()}}}{let $b=function(){return ix.GetSingleGlobalInstance().GetSdkInstance()},tx=function(){if(self.C3Audio_DOMInterface)return self.C3Audio_DOMInterface;throw new Error("audio scripting API cannot be used here - make sure the project is using DOM mode, not worker mode")};0;const ex=self.C3,sx=self.C3X;ex.Plugins.Audio.Type=class extends ex.SDKTypeBase{constructor(t){super(t)}Release(){super.Release()}OnCreate(){}GetScriptInterfaceClass(){return self.IAudioObjectType}};let ix=null;self.IAudioObjectType=class extends self.IObjectType{constructor(t){super(t),ix=t}get audioContext(){return tx().GetAudioContextExtern()}get destinationNode(){return tx().GetDestinationNodeExtern()}get isSilent(){return $b()._IsSilent()}set isSilent(t){$b()._SetSilent(t)}get masterVolume(){return $b()._GetMasterVolume()}set masterVolume(t){sx.RequireFiniteNumber(t),$b()._SetMasterVolume(t)}stopAll(){$b()._StopAll()}}}{const rx=self.C3,nx="audio",ax=["interactive","balanced","playback"];rx.Plugins.Audio.Instance=class extends rx.SDKInstanceBase{constructor(t,e){super(t,nx),this._nextPlayTime=0,this._nextPlayOffset=0,this._triggerTags=[],this._enableMultiTags=!0,this._timeScaleMode=0,this._saveLoadMode=0,this._playInBackground=!1,this._panningModel=1,this._distanceModel=1,this._listenerPos=[this._runtime.GetViewportWidth()/2,this._runtime.GetViewportHeight()/2,600],this._listenerForwardVec=[0,0,-1],this._listenerUpVec=[0,1,0],this._referenceDistance=600,this._maxDistance=1e4,this._rolloffFactor=1,this._listenerInst=null,this._loadListenerUid=-1,this._masterVolume=1,this._isSilent=!1,this._sampleRate=0,this._audioContextState="suspended",this._outputLatency=0,this._effectCount=new Map,this._preloadTotal=0,this._preloadCount=0,this._bufferMetadata=new Map,this._remoteUrls=new Map;let s="interactive";e&&(this._timeScaleMode=e[0],this._saveLoadMode=e[1],this._playInBackground=e[2],s=ax[e[3]],this._enableMultiTags=e[4],this._panningModel=e[5],this._distanceModel=e[6],this._listenerPos[2]=e[7],this._referenceDistance=e[8],this._maxDistance=e[9],this._rolloffFactor=e[10]),this._lastAIState=[],this._lastFxState=[],this._lastAnalysersData=[],this.AddDOMMessageHandlers([["state",t=>this._OnUpdateState(t)],["audiocontext-state",t=>this._OnAudioContextStateChanged(t)],["fxstate",t=>this._OnUpdateFxState(t)],["trigger",t=>this._OnTrigger(t)],["buffer-metadata",t=>this._OnBufferMetadata(t)]]);const i=this.GetRuntime().Dispatcher();this._disposables=new rx.CompositeDisposable(rx.Disposable.From(i,"instancedestroy",t=>this._OnInstanceDestroyed(t.instance)),rx.Disposable.From(i,"afterload",()=>this._OnAfterLoad()),rx.Disposable.From(i,"suspend",()=>this._OnSuspend()),rx.Disposable.From(i,"resume",()=>this._OnResume()));const r=this._runtime.GetExportType(),n="Safari"===rx.Platform.Browser,a=this._runtime.IsiOSWebView()||"macos-wkwebview"===r,o="playable-ad-single-file"===r,h="cordova"===r&&"Android"===rx.Platform.OS,l=n||a||o||h;this._runtime.AddLoadPromise(this.PostToDOMAsync("create-audio-context",{preloadList:this._runtime.GetAssetManager().GetAudioToPreload().map(t=>({originalUrl:t.originalUrl,url:t.url,type:t.type,fileSize:t.fileSize})),timeScaleMode:this._timeScaleMode,latencyHint:s,panningModel:this._panningModel,distanceModel:this._distanceModel,refDistance:this._referenceDistance,maxDistance:this._maxDistance,rolloffFactor:this._rolloffFactor,listenerPos:this._listenerPos,usePlayMusicAsSoundWorkaround:l}).then(t=>{this._sampleRate=t.sampleRate,this._audioContextState=t.audioContextState,this._outputLatency=t.outputLatency})),this._StartTicking()}Release(){this._listenerInst=null,super.Release()}_SplitTags(t){return this._enableMultiTags?t.split(" ").filter(t=>!!t):t?[t]:[]}_MatchTagLists(t,e){for(const s of e){let e=!1;for(const i of t)if(rx.equalsNoCase(i,s)){e=!0;break}if(!e)return!1}return!0}_MatchTagListToStr(t,e){return this._MatchTagLists(t,this._SplitTags(e))}_AddActionPromise(t){this.GetPlugin()._AddActionPromise(t)}_OnInstanceDestroyed(t){this._listenerInst===t&&(this._listenerInst=null)}DbToLinearNoCap(t){return Math.pow(10,t/20)}DbToLinear(t){const e=this.DbToLinearNoCap(t);return isFinite(e)?Math.max(Math.min(e,1),0):0}LinearToDbNoCap(t){return Math.log(t)/Math.log(10)*20}LinearToDb(t){return this.LinearToDbNoCap(Math.max(Math.min(t,1),0))}_GetScheduledPlayInfo(){let t=0;const e=!!self.C3_GetAudioContextCurrentTime;return t=e?this._nextPlayTime:this._nextPlayOffset,this._nextPlayTime=0,this._nextPlayOffset=0,{playOffset:t,isTrueClock:e}}_OnSuspend(){this._playInBackground||this.PostToDOM("set-suspended",{isSuspended:!0})}_OnResume(){this._playInBackground||this.PostToDOM("set-suspended",{isSuspended:!1})}_OnUpdateState(t){const e=t.tickCount;this._outputLatency=t.outputLatency;const s=this._lastAIState.filter(t=>t.hasOwnProperty("placeholder")&&(t.placeholder>e||-1===t.placeholder));this._lastAIState=t.audioInstances,this._lastAnalysersData=t.analysers,s.length>0&&rx.appendArray(this._lastAIState,s)}_OnBufferMetadata(t){this._bufferMetadata.set(t.originalUrl,{duration:t.duration})}_OnAudioContextStateChanged(t){this._audioContextState=t.audioContextState}GetAudioContextState(){return this._runtime.IsExportToVideo()?"running":this._audioContextState}_OnUpdateFxState(t){this._lastFxState=t.fxstate}_GetFirstAudioStateByTags(t){const e=this._SplitTags(t);for(const t of this._lastAIState)if(this._MatchTagLists(t.tags,e))return t;return null}_IsTagPlaying(t){const e=this._SplitTags(t);return this._lastAIState.some(t=>this._MatchTagLists(t.tags,e)&&t.isPlaying)}_MaybeMarkAsPlaying(t,e,s,i,r){if(this._IsTagPlaying(e))return null;const n=this._bufferMetadata.get(t),a={tags:this._SplitTags(e),duration:n?n.duration:0,volume:r,isPlaying:!0,playbackTime:0,playbackRate:1,uid:-1,bufferOriginalUrl:t,bufferUrl:"",bufferType:"",isMusic:s,isLooping:i,isMuted:!1,resumePosition:0,pan:null,placeholder:-1};return this._lastAIState.push(a),a}_MaybeMarkAsStopped(t){const e=this._SplitTags(t);for(const t of this._lastAIState)this._MatchTagLists(t.tags,e)&&(t.isPlaying=!1)}async _OnTrigger(t){const e=t.type;this._triggerTags=t.tags;const s=t.aiid;if("ended"===e){for(const t of this._lastAIState)if(t.aiid===s){t.isPlaying=!1;break}await this.TriggerAsync(rx.Plugins.Audio.Cnds.OnEnded)}else"fade-ended"===e&&await this.TriggerAsync(rx.Plugins.Audio.Cnds.OnFadeEnded)}_MatchTriggerTag(t){return this._MatchTagListToStr(this._triggerTags,t)}Tick(){const t={timeScale:this._runtime.GetTimeScale(),gameTime:this._runtime.GetGameTimeRaw(),instPans:this.GetInstancePans(),tickCount:this._runtime.GetTickCountNoSave()};if(this._listenerInst){const e=this._listenerInst.GetWorldInfo();this._listenerPos[0]=e.GetX(),this._listenerPos[1]=e.GetY(),t.listenerPos=this._listenerPos,t.listenerOrientation=[...this._listenerForwardVec,...this._listenerUpVec]}this.PostToDOM("tick",t)}rotatePtAround(t,e,s,i,r){if(0===s)return[t,e];const n=Math.sin(s),a=Math.cos(s),o=(t-=i)*n;return t=t*a-(e-=r)*n,e=e*a+o,[t+=i,e+=r]}GetInstancePans(){return this._lastAIState.filter(t=>-1!==t.uid).map(t=>this._runtime.GetInstanceByUID(t.uid)).filter(t=>t).map(t=>{const e=t.GetWorldInfo(),s=e.GetLayer().GetAngle(),[i,r]=this.rotatePtAround(e.GetX(),e.GetY(),-s,this._listenerPos[0],this._listenerPos[1]);return{uid:t.GetUID(),x:i,y:r,z:e.GetTotalZElevation(),angle:e.GetAngle()-s}})}GetAnalyserData(t,e){for(const s of this._lastAnalysersData)if(s.index===e&&rx.equalsNoCase(s.tag,t))return s;return null}_IncrementEffectCount(t){for(const e of this._SplitTags(t)){const t=e.toLowerCase();this._effectCount.set(t,(this._effectCount.get(t)||0)+1)}}_IsSilent(){return this._isSilent}_SetSilent(t){t=!!t,this._isSilent!==t&&(this._isSilent=t,this.PostToDOM("set-silent",{isSilent:t}))}_GetMasterVolume(){return this._masterVolume}_SetMasterVolume(t){this._masterVolume!==t&&(this._masterVolume=t,this.PostToDOM("set-master-volume",{vol:t}))}_StopAll(){this.PostToDOM("stop-all");for(const t of this._lastAIState)t.isPlaying=!1}_ShouldSave(t){return!(t.hasOwnProperty("placeholder")||3===this._saveLoadMode||t.isMusic&&1===this._saveLoadMode||!t.isMusic&&2===this._saveLoadMode)}SaveToJson(){return{isSilent:this._isSilent,masterVolume:this._masterVolume,listenerZ:this._listenerPos[2],listenerForwardVec:this._listenerForwardVec,listenerUpVec:this._listenerUpVec,listenerUid:this._listenerInst?this._listenerInst.GetUID():-1,remoteUrls:[...this._remoteUrls.entries()],playing:this._lastAIState.filter(t=>this._ShouldSave(t)),effects:this._lastFxState,analysers:this._lastAnalysersData}}LoadFromJson(t){if(this._isSilent=t.isSilent,this._masterVolume=t.masterVolume,this._listenerPos[2]=t.listenerZ,this._listenerInst=null,this._loadListenerUid=t.listenerUid,t.hasOwnProperty("listenerForwardVec")?this._listenerForwardVec=t.listenerForwardVec:this._listenerForwardVec=[0,0,-1],t.hasOwnProperty("listenerUpVec")?this._listenerUpVec=t.listenerUpVec:this._listenerUpVec=[0,1,0],this._remoteUrls.clear(),t.remoteUrls)for(const[e,s]of t.remoteUrls)this._remoteUrls.set(e,s);this._lastAIState=t.playing;for(const t of this._lastAIState)t.hasOwnProperty("tag")&&!t.hasOwnProperty("tags")&&(t.tags=[t.tag].filter(t=>!!t));this._lastFxState=t.effects,this._lastAnalysersData=t.analysers}_OnAfterLoad(){if(-1!==this._loadListenerUid&&(this._listenerInst=this._runtime.GetInstanceByUID(this._loadListenerUid),this._loadListenerUid=-1,this._listenerInst)){const t=this._listenerInst.GetWorldInfo();this._listenerPos[0]=t.GetX(),this._listenerPos[1]=t.GetY()}for(const t of this._lastAIState){const e=this._runtime.GetAssetManager().GetProjectAudioFileUrl(t.bufferOriginalUrl);e?(t.bufferUrl=e.url,t.bufferType=e.type):t.bufferUrl=null}for(const t of Object.values(this._lastFxState))for(const e of t)if(e.hasOwnProperty("bufferOriginalUrl")){const t=this._runtime.GetAssetManager().GetProjectAudioFileUrl(e.bufferOriginalUrl);t&&(e.bufferUrl=t.url,e.bufferType=t.type)}this.PostToDOM("load-state",{saveLoadMode:this._saveLoadMode,timeScale:this._runtime.GetTimeScale(),gameTime:this._runtime.GetGameTimeRaw(),listenerPos:this._listenerPos,listenerOrientation:[...this._listenerForwardVec,...this._listenerUpVec],isSilent:this._isSilent,masterVolume:this._masterVolume,playing:this._lastAIState.filter(t=>null!==t.bufferUrl),effects:this._lastFxState})}GetDebuggerProperties(){const t=[];for(const[e,s]of Object.entries(this._lastFxState))t.push({name:"$"+e,value:s.map(t=>t.type).join(", ")});const e="plugins.audio.debugger";return[{title:e+".tag-effects",properties:t},{title:e+".currently-playing",properties:[{name:e+".currently-playing-count",value:this._lastAIState.length},...this._lastAIState.map((t,e)=>({name:"$#"+e,value:`${t.bufferOriginalUrl} ("${t.tags}") ${Math.round(10*t.playbackTime)/10} / ${Math.round(10*t.duration)/10}`}))]}]}}}self.C3.Plugins.Audio.Cnds={OnEnded(t){return this._MatchTriggerTag(t)},OnFadeEnded(t){return this._MatchTriggerTag(t)},PreloadsComplete(){return this._preloadCount===this._preloadTotal},AdvancedAudioSupported:()=>!0,IsSilent(){return this._IsSilent()},IsAnyPlaying(){for(const t of this._lastAIState)if(t.isPlaying)return!0;return!1},IsTagPlaying(t){return this._IsTagPlaying(t)}};{const ox=self.C3,hx=["lowpass","highpass","bandpass","lowshelf","highshelf","peaking","notch","allpass"];ox.Plugins.Audio.Acts={Play(t,e,s,i,r){const n=ox.Plugins.Audio.Acts._DoPlay.call(this,t,e,s,i,r);return this._AddActionPromise(n),n},PlayFromTimeline(t,e,s,i){ox.Plugins.Audio.Acts._DoPlay.call(this,t,0,e,0,s,i)},async _DoPlay(t,e,s,i,r,n){if(this._isSilent)return;const a=t[1],o=this._runtime.GetAssetManager().GetProjectAudioFileUrl(t[0]);if(!o)return;const{playOffset:h,isTrueClock:l}=this._GetScheduledPlayInfo(),c=this._MaybeMarkAsPlaying(t[0],r,a,0!==e,this.DbToLinear(s));try{await this.PostToDOMAsync("play",{originalUrl:t[0],url:o.url,type:o.type,isMusic:a,tags:this._SplitTags(r),isLooping:0!==e,vol:this.DbToLinear(s),stereoPan:ox.clamp(i/100,-1,1),pos:n||0,off:h,trueClock:l})}finally{c&&(c.placeholder=this._runtime.GetTickCountNoSave())}},async PlayAtPosition(t,e,s,i,r,n,a,o,h,l,c){if(this._isSilent)return;const u=t[1],_=this._runtime.GetAssetManager().GetProjectAudioFileUrl(t[0]);if(!_)return;const{playOffset:d,isTrueClock:p}=this._GetScheduledPlayInfo(),f=this._MaybeMarkAsPlaying(t[0],c,u,0!==e,this.DbToLinear(s));try{await this.PostToDOMAsync("play",{originalUrl:t[0],url:_.url,type:_.type,isMusic:u,tags:this._SplitTags(c),isLooping:0!==e,vol:this.DbToLinear(s),pos:0,off:d,trueClock:p,panning:{x:i,y:r,z:n,angle:ox.toRadians(a),innerAngle:ox.toRadians(o),outerAngle:ox.toRadians(h),outerGain:this.DbToLinear(l)}})}finally{f&&(f.placeholder=this._runtime.GetTickCountNoSave())}},async PlayAtObject(t,e,s,i,r,n,a,o){if(this._isSilent)return;if(!i)return;const h=i.GetFirstPicked();if(!h||!h.GetWorldInfo())return;const l=h.GetWorldInfo(),c=l.GetLayer().GetAngle(),[u,_]=this.rotatePtAround(l.GetX(),l.GetY(),-c,this._listenerPos[0],this._listenerPos[1]),d=t[1],p=this._runtime.GetAssetManager().GetProjectAudioFileUrl(t[0]);if(!p)return;const{playOffset:f,isTrueClock:g}=this._GetScheduledPlayInfo(),m=this._MaybeMarkAsPlaying(t[0],o,d,0!==e,this.DbToLinear(s));try{await this.PostToDOMAsync("play",{originalUrl:t[0],url:p.url,type:p.type,isMusic:d,tags:this._SplitTags(o),isLooping:0!==e,vol:this.DbToLinear(s),pos:0,off:f,trueClock:g,panning:{x:u,y:_,z:l.GetTotalZElevation(),angle:l.GetAngle()-c,innerAngle:ox.toRadians(r),outerAngle:ox.toRadians(n),outerGain:this.DbToLinear(a),uid:h.GetUID()}})}finally{m&&(m.placeholder=this._runtime.GetTickCountNoSave())}},async PlayByName(t,e,s,i,r,n){if(this._isSilent)return;const a=1===t,o=this._runtime.GetAssetManager().GetProjectAudioFileUrl(e)||this._remoteUrls.get(e.toLowerCase());if(!o)return;const{playOffset:h,isTrueClock:l}=this._GetScheduledPlayInfo(),c=this._MaybeMarkAsPlaying(e,n,a,0!==s,this.DbToLinear(i));try{await this.PostToDOMAsync("play",{originalUrl:e,url:o.url,type:o.type,isMusic:a,tags:this._SplitTags(n),isLooping:0!==s,vol:this.DbToLinear(i),stereoPan:ox.clamp(r/100,-1,1),pos:0,off:h,trueClock:l})}finally{c&&(c.placeholder=this._runtime.GetTickCountNoSave())}},async PlayAtPositionByName(t,e,s,i,r,n,a,o,h,l,c,u){if(this._isSilent)return;const _=1===t,d=this._runtime.GetAssetManager().GetProjectAudioFileUrl(e)||this._remoteUrls.get(e.toLowerCase());if(!d)return;const{playOffset:p,isTrueClock:f}=this._GetScheduledPlayInfo(),g=this._MaybeMarkAsPlaying(e,u,_,0!==s,this.DbToLinear(i));try{await this.PostToDOMAsync("play",{originalUrl:e,url:d.url,type:d.type,isMusic:_,tags:this._SplitTags(u),isLooping:0!==s,vol:this.DbToLinear(i),pos:0,off:p,trueClock:f,panning:{x:r,y:n,z:a,angle:ox.toRadians(o),innerAngle:ox.toRadians(h),outerAngle:ox.toRadians(l),outerGain:this.DbToLinear(c)}})}finally{g&&(g.placeholder=this._runtime.GetTickCountNoSave())}},async PlayAtObjectByName(t,e,s,i,r,n,a,o,h){if(this._isSilent)return;if(this._isSilent)return;if(!r)return;const l=r.GetFirstPicked();if(!l||!l.GetWorldInfo())return;const c=l.GetWorldInfo(),u=c.GetLayer().GetAngle(),[_,d]=this.rotatePtAround(c.GetX(),c.GetY(),-u,this._listenerPos[0],this._listenerPos[1]),p=1===t,f=this._runtime.GetAssetManager().GetProjectAudioFileUrl(e)||this._remoteUrls.get(e.toLowerCase());if(!f)return;const{playOffset:g,isTrueClock:m}=this._GetScheduledPlayInfo(),S=this._MaybeMarkAsPlaying(e,h,p,0!==s,this.DbToLinear(i));try{await this.PostToDOMAsync("play",{originalUrl:e,url:f.url,type:f.type,isMusic:p,tags:this._SplitTags(h),isLooping:0!==s,vol:this.DbToLinear(i),pos:0,off:g,trueClock:m,panning:{x:_,y:d,z:c.GetTotalZElevation(),angle:c.GetAngle()-u,innerAngle:ox.toRadians(n),outerAngle:ox.toRadians(a),outerGain:this.DbToLinear(o),uid:l.GetUID()}})}finally{S&&(S.placeholder=this._runtime.GetTickCountNoSave())}},SetLooping(t,e){this.PostToDOM("set-looping",{tags:this._SplitTags(t),isLooping:0===e})},SetMuted(t,e){this.PostToDOM("set-muted",{tags:this._SplitTags(t),isMuted:0===e})},SetVolume(t,e){this.PostToDOM("set-volume",{tags:this._SplitTags(t),vol:this.DbToLinear(e)})},FadeVolume(t,e,s,i){this.PostToDOM("fade-volume",{tags:this._SplitTags(t),vol:this.DbToLinear(e),duration:s,stopOnEnd:0===i})},SetStereoPan(t,e){this.PostToDOM("set-stereo-pan",{tags:this._SplitTags(t),p:ox.clamp(e/100,-1,1)})},async Preload(t){const e=t[1],s=this._runtime.GetAssetManager().GetProjectAudioFileUrl(t[0]);s&&(this._preloadTotal++,await this.PostToDOMAsync("preload",{originalUrl:t[0],url:s.url,type:s.type,isMusic:e}),this._preloadCount++)},async PreloadByName(t,e){const s=1===t,i=this._runtime.GetAssetManager().GetProjectAudioFileUrl(e)||this._remoteUrls.get(e.toLowerCase());i&&(this._preloadTotal++,await this.PostToDOMAsync("preload",{originalUrl:e,url:i.url,type:i.type,isMusic:s}),this._preloadCount++)},SetPlaybackRate(t,e){this.PostToDOM("set-playback-rate",{tags:this._SplitTags(t),rate:Math.max(e,0)})},Stop(t){this._MaybeMarkAsStopped(t),this.PostToDOM("stop",{tags:this._SplitTags(t)})},StopAll(){this._StopAll()},SetPaused(t,e){this.PostToDOM("set-paused",{tags:this._SplitTags(t),paused:0===e})},Seek(t,e){this.PostToDOM("seek",{tags:this._SplitTags(t),pos:e})},SetSilent(t){2===t&&(t=this._IsSilent()?1:0),this._SetSilent(0===t)},SetMasterVolume(t){const e=this.DbToLinear(t);this._SetMasterVolume(e)},AddFilterEffect(t,e,s,i,r,n,a){const o=hx[e];this._IncrementEffectCount(t),this.PostToDOM("add-effect",{type:"filter",tags:this._SplitTags(t),params:[o,s,i,r,n,ox.clamp(a/100,0,1)]})},AddDelayEffect(t,e,s,i){this._IncrementEffectCount(t),this.PostToDOM("add-effect",{type:"delay",tags:this._SplitTags(t),params:[e,this.DbToLinear(s),ox.clamp(i/100,0,1)]})},AddFlangerEffect(t,e,s,i,r,n){this._IncrementEffectCount(t),this.PostToDOM("add-effect",{type:"flanger",tags:this._SplitTags(t),params:[e/1e3,s/1e3,i,r/100,ox.clamp(n/100,0,1)]})},AddPhaserEffect(t,e,s,i,r,n,a){this._IncrementEffectCount(t),this.PostToDOM("add-effect",{type:"phaser",tags:this._SplitTags(t),params:[e,s,i,r,n,ox.clamp(a/100,0,1)]})},AddConvolutionEffect(t,e,s,i){const r=this._runtime.GetAssetManager().GetProjectAudioFileUrl(e[0]);r&&(this._IncrementEffectCount(t),this.PostToDOM("add-effect",{type:"convolution",tags:this._SplitTags(t),bufferOriginalUrl:e[0],bufferUrl:r.url,bufferType:r.type,params:[0===s,ox.clamp(i/100,0,1)]}))},AddGainEffect(t,e){this._IncrementEffectCount(t),this.PostToDOM("add-effect",{type:"gain",tags:this._SplitTags(t),params:[this.DbToLinear(e)]})},AddStereoPanEffect(t,e){this._IncrementEffectCount(t),this.PostToDOM("add-effect",{type:"stereopan",tags:this._SplitTags(t),params:[ox.clamp(e/100,-1,1)]})},AddMuteEffect(t){this._IncrementEffectCount(t),this.PostToDOM("add-effect",{type:"gain",tags:this._SplitTags(t),params:[0]})},AddTremoloEffect(t,e,s){this._IncrementEffectCount(t),this.PostToDOM("add-effect",{type:"tremolo",tags:this._SplitTags(t),params:[e,ox.clamp(s/100,0,1)]})},AddRingModEffect(t,e,s){this._IncrementEffectCount(t),this.PostToDOM("add-effect",{type:"ringmod",tags:this._SplitTags(t),params:[e,ox.clamp(s/100,0,1)]})},AddDistortionEffect(t,e,s,i,r,n){this._IncrementEffectCount(t),this.PostToDOM("add-effect",{type:"distortion",tags:this._SplitTags(t),params:[this.DbToLinearNoCap(e),this.DbToLinearNoCap(s),i,this.DbToLinearNoCap(r),ox.clamp(n/100,0,1)]})},AddCompressorEffect(t,e,s,i,r,n){this._IncrementEffectCount(t),this.PostToDOM("add-effect",{type:"compressor",tags:this._SplitTags(t),params:[e,s,i,r/1e3,n/1e3]})},AddAnalyserEffect(t,e,s){this._IncrementEffectCount(t),this.PostToDOM("add-effect",{type:"analyser",tags:this._SplitTags(t),params:[e,s]})},RemoveEffects(t){const e=this._SplitTags(t);for(const t of e)this._effectCount.set(t.toLowerCase(),0);this.PostToDOM("remove-effects",{tags:e}),this._lastFxState={}},SetEffectParameter(t,e,s,i,r,n){this.PostToDOM("set-effect-param",{tags:this._SplitTags(t),index:Math.floor(e),param:s,value:i,ramp:r,time:n})},SetListenerObject(t){if(!t)return;const e=t.GetFirstPicked();e&&e.GetWorldInfo()&&(this._listenerInst=e)},SetListenerZ(t){this._listenerPos[2]=t},SetListenerOrientation(t,e,s,i,r,n){this._listenerForwardVec[0]=t,this._listenerForwardVec[1]=e,this._listenerForwardVec[2]=-s,this._listenerUpVec[0]=i,this._listenerUpVec[1]=r,this._listenerUpVec[2]=-n},ScheduleNextPlay(t){this._nextPlayTime=Math.max(t,0),this._nextPlayOffset=Math.max(t-performance.now()/1e3,0)},UnloadAudio(t){const e=t[1],s=this._runtime.GetAssetManager().GetProjectAudioFileUrl(t[0]);s&&this.PostToDOM("unload",{url:s.url,type:s.type,isMusic:e})},UnloadAudioByName(t,e){const s=1===t,i=this._runtime.GetAssetManager().GetProjectAudioFileUrl(e)||this._remoteUrls.get(e.toLowerCase());i&&this.PostToDOM("unload",{url:i.url,type:i.type,isMusic:s})},UnloadAll(){this.PostToDOM("unload-all")},AddRemoteURL(t,e,s){this._remoteUrls.set(s.toLowerCase(),{url:t,type:e})}}}{const lx=self.C3;lx.Plugins.Audio.Exps={Duration(t){const e=this._GetFirstAudioStateByTags(t);return e?e.duration:0},PlaybackTime(t){const e=this._GetFirstAudioStateByTags(t);return e?e.playbackTime:0},PlaybackRate(t){const e=this._GetFirstAudioStateByTags(t);return e?e.playbackRate:0},Volume(t){const e=this._GetFirstAudioStateByTags(t);return e?this.LinearToDb(e.volume):0},MasterVolume(){return this.LinearToDb(this._GetMasterVolume())},EffectCount(t){return this._effectCount.get(t.toLowerCase())||0},AnalyserFreqBinCount(t,e){const s=this.GetAnalyserData(t,Math.floor(e));return s?s.binCount:0},AnalyserFreqBinAt(t,e,s){const i=this.GetAnalyserData(t,Math.floor(e));return i?(s=Math.floor(s))<0||s>=i.binCount?0:i.freqBins[s]:0},AnalyserPeakLevel(t,e){const s=this.GetAnalyserData(t,Math.floor(e));return s?s.peak:0},AnalyserRMSLevel(t,e){const s=this.GetAnalyserData(t,Math.floor(e));return s?s.rms:0},SampleRate(){return this._sampleRate},CurrentTime:()=>self.C3_GetAudioContextCurrentTime?self.C3_GetAudioContextCurrentTime():performance.now()/1e3,OutputLatency(){return this._outputLatency},NormalizedVolume(t,e){return 0==(t=lx.clamp(+t,0,100)/100)?-1/0:t<.1?this.LinearToDb(lx.lerp(0,this.DbToLinear(e),10*t)):lx.lerp(e,0,(t-.1)/.9)}}}{const cx=self.C3,ux="button";cx.Plugins.Button=class extends cx.SDKDOMPluginBase{constructor(t){super(t,ux),this.AddElementMessageHandler("click",(t,e)=>t._OnClick(e))}Release(){super.Release()}}}{const _x=self.C3;_x.Plugins.Button.Type=class extends _x.SDKTypeBase{constructor(t){super(t)}Release(){super.Release()}OnCreate(){}}}{const dx=self.C3,px=self.C3X,fx=0,gx=1,mx=2,Sx=3,yx=4,Gx=5,Tx=6,Ix=7,Cx=8,bx="button";dx.Plugins.Button.Instance=class extends dx.SDKDOMInstanceBase{constructor(t,e){super(t,bx),this._text="OK",this._isCheckbox=!1,this._isChecked=!1,this._title="",this._id="",this._className="",this._isEnabled=!0,this._autoFontSize=!0,e&&(this._isCheckbox=1===e[fx],this._text=e[gx],this._title=e[mx],this.GetWorldInfo().SetVisible(e[Sx]),this._isEnabled=e[yx],this._autoFontSize=e[Gx],this._isChecked=e[Tx],this._id=e[Ix],this._className=e[Cx]),this.CreateElement({id:this._id,className:this._className,usesAutoFontSize:this._autoFontSize})}Release(){super.Release()}GetElementState(){return{text:this._text,isCheckbox:this._isCheckbox,isChecked:this._isChecked,title:this._title,isVisible:this.GetWorldInfo().IsVisible(),isEnabled:this._isEnabled}}async _OnClick(t){this._isChecked=t.isChecked,this.DispatchScriptEvent("click",!0),await this.TriggerAsync(dx.Plugins.Button.Cnds.OnClicked)}_SetText(t){this._text!==t&&(this._text=t,this.UpdateElementState())}_GetText(){return this._text}_SetTooltip(t){this._title!==t&&(this._title=t,this.UpdateElementState())}_GetTooltip(){return this._title}_SetEnabled(t){t=!!t,this._isEnabled!==t&&(this._isEnabled=t,this.UpdateElementState())}_IsEnabled(){return this._isEnabled}_SetChecked(t){this._isCheckbox&&(t=!!t,this._isChecked!==t&&(this._isChecked=t,this.UpdateElementState()))}_IsChecked(){return this._isChecked}Draw(t){}SaveToJson(){return{text:this._text,checked:this._isChecked,title:this._title,enabled:this._isEnabled}}LoadFromJson(t){this._text=t.text,this._isChecked=t.checked,this._title=t.title,this._isEnabled=t.enabled,this.UpdateElementState()}GetPropertyValueByIndex(t){switch(t){case gx:return this._GetText();case mx:return this._GetTooltip();case yx:return this._IsEnabled();case Gx:return this._autoFontSize;case Tx:return this._IsChecked()}}SetPropertyValueByIndex(t,e){switch(t){case gx:this._SetText(e);break;case mx:this._SetTooltip(e);break;case yx:this._SetEnabled(!!e);break;case Gx:this._autoFontSize=!!e;break;case Tx:this._SetChecked(!!e)}}GetDebuggerProperties(){const t="plugins.button";return[{title:t+".name",properties:[{name:t+".properties.text.name",value:this._GetText(),onedit:t=>this._SetText(t)},{name:t+".properties.enabled.name",value:this._IsEnabled(),onedit:t=>this._SetEnabled(t)},{name:t+".properties.checked.name",value:this._IsChecked(),onedit:t=>this._SetChecked(t)}]}]}GetScriptInterfaceClass(){return self.IButtonInstance}};const xx=new WeakMap;self.IButtonInstance=class extends self.IDOMInstance{constructor(){super(),xx.set(this,self.IInstance._GetInitInst().GetSdkInstance())}set text(t){px.RequireString(t),xx.get(this)._SetText(t)}get text(){return xx.get(this)._GetText()}set tooltip(t){px.RequireString(t),xx.get(this)._SetTooltip(t)}get tooltip(){return xx.get(this)._GetTooltip()}set isEnabled(t){xx.get(this)._SetEnabled(t)}get isEnabled(){return xx.get(this)._IsEnabled()}set isChecked(t){xx.get(this)._SetChecked(t)}get isChecked(){return xx.get(this)._IsChecked()}}}{const wx=self.C3;wx.Plugins.Button.Cnds={OnClicked:()=>!0,IsChecked(){return this._isChecked},CompareText(t,e){return e?this._text===t:wx.equalsNoCase(this._text,t)}}}self.C3.Plugins.Button.Acts={SetText(t){this._SetText(t)},SetTooltip(t){this._SetTooltip(t)},SetChecked(t){this._SetChecked(0!==t)},ToggleChecked(){this._isCheckbox&&(this._isChecked=!this._isChecked,this.UpdateElementState())}},self.C3.Plugins.Button.Exps={Text(){return this._text}};{const Mx=self.C3;Mx.Plugins.Keyboard=class extends Mx.SDKPluginBase{constructor(t){super(t)}Release(){super.Release()}}}{let Px=function(){return Rx.GetSingleGlobalInstance().GetSdkInstance()};0;const vx=self.C3;self.C3X,vx.Plugins.Keyboard.Type=class extends vx.SDKTypeBase{constructor(t){super(t)}Release(){super.Release()}OnCreate(){}GetScriptInterfaceClass(){return self.IKeyboardObjectType}};let Rx=null;self.IKeyboardObjectType=class extends self.IObjectType{constructor(t){super(t),Rx=t,t.GetRuntime()._GetCommonScriptInterfaces().keyboard=this}isKeyDown(t){const e=Px();if("string"==typeof t)return e.IsKeyDown(t);if("number"==typeof t)return e.IsKeyCodeDown(t);throw new TypeError("expected string or number")}}}{const Ax=self.C3,Dx="keyboard";Ax.Plugins.Keyboard.Instance=class extends Ax.SDKInstanceBase{constructor(t,e){super(t,Dx),this._keysDownByString=new Set,this._keysDownByWhich=new Set,this._triggerWhich=0,this._triggerString="",this._triggerTypedKey="",this._isKeyboardLockSupported=!1;const s=this.GetRuntime().Dispatcher();this._disposables=new Ax.CompositeDisposable(Ax.Disposable.From(s,"keydown",t=>this._OnKeyDown(t.data)),Ax.Disposable.From(s,"keyup",t=>this._OnKeyUp(t.data)),Ax.Disposable.From(s,"window-blur",()=>this._OnWindowOrKeyboardBlur()),Ax.Disposable.From(s,"keyboard-blur",()=>this._OnWindowOrKeyboardBlur())),this._runtime.AddLoadPromise(this._Init())}Release(){super.Release()}async _Init(){const t=await this.PostToDOMAsync("init");this._isKeyboardLockSupported=t.isKeyboardLockSupported}_OnKeyDown(t){const e=t.which,s=t.code||e.toString(),i=t.key;this._keysDownByString.has(s)||(this._keysDownByString.add(s),this._keysDownByWhich.add(e),this._triggerString=s,this._triggerWhich=e,this._triggerTypedKey=i,this.Trigger(Ax.Plugins.Keyboard.Cnds.OnAnyKey),this.Trigger(Ax.Plugins.Keyboard.Cnds.OnKey),this.Trigger(Ax.Plugins.Keyboard.Cnds.OnLeftRightKeyPressed),this.Trigger(Ax.Plugins.Keyboard.Cnds.OnKeyCode))}_OnKeyUp(t){const e=t.which,s=t.code||e.toString(),i=t.key;this._keysDownByString.delete(s),this._keysDownByWhich.delete(e),this._triggerString=s,this._triggerWhich=e,this._triggerTypedKey=i,this.Trigger(Ax.Plugins.Keyboard.Cnds.OnAnyKeyReleased),this.Trigger(Ax.Plugins.Keyboard.Cnds.OnKeyReleased),this.Trigger(Ax.Plugins.Keyboard.Cnds.OnLeftRightKeyReleased),this.Trigger(Ax.Plugins.Keyboard.Cnds.OnKeyCodeReleased)}_OnWindowOrKeyboardBlur(){for(const t of this._keysDownByWhich)this._keysDownByWhich.delete(t),this._triggerWhich=t,this.Trigger(Ax.Plugins.Keyboard.Cnds.OnAnyKeyReleased),this.Trigger(Ax.Plugins.Keyboard.Cnds.OnKeyReleased),this.Trigger(Ax.Plugins.Keyboard.Cnds.OnKeyCodeReleased);this._keysDownByString.clear()}IsKeyDown(t){return this._keysDownByString.has(t)}IsKeyCodeDown(t){return this._keysDownByWhich.has(t)}SaveToJson(){return{tk:this._triggerWhich,tkk:this._triggerTypedKey}}LoadFromJson(t){this._triggerWhich=t.tk,t.hasOwnProperty("tkk")&&(this._triggerTypedKey=t.tkk)}GetDebuggerProperties(){const t="plugins.keyboard";return[{title:t+".name",properties:[{name:t+".debugger.last-key-code",value:this._triggerWhich},{name:t+".debugger.last-key-string",value:Ax.Plugins.Keyboard.Exps.StringFromKeyCode(this._triggerWhich)},{name:t+".debugger.last-typed-key",value:this._triggerTypedKey}]}]}}}{const Ex=self.C3,Fx=["ShiftLeft","ShiftRight","ControlLeft","ControlRight","AltLeft","AltRight","MetaLeft","MetaRight"];Ex.Plugins.Keyboard.Cnds={IsKeyDown(t){return this._keysDownByWhich.has(t)},OnKey(t){return this._triggerWhich===t},OnAnyKey:()=>!0,OnAnyKeyReleased:()=>!0,OnKeyReleased(t){return this._triggerWhich===t},IsKeyCodeDown(t){return t=Math.floor(t),this._keysDownByWhich.has(t)},OnKeyCode(t){return this._triggerWhich===t},OnKeyCodeReleased(t){return this._triggerWhich===t},OnLeftRightKeyPressed(t){const e=Fx[t];return this._triggerString===e},OnLeftRightKeyReleased(t){const e=Fx[t];return this._triggerString===e},IsLeftRightKeyDown(t){const e=Fx[t];return this._keysDownByString.has(e)},IsKeyboardLockSupported(){return this._isKeyboardLockSupported},OnKeyboardLocked:()=>!0,OnKeyboardLockError:()=>!0}}{const Ox=self.C3;Ox.Plugins.Keyboard.Acts={async LockKeyboard(t){if(!this._isKeyboardLockSupported)return;let e=[];t&&(e=t.split(",")),(await this.PostToDOMAsync("lock-keyboard",{keysArr:e})).isOk?this.Trigger(Ox.Plugins.Keyboard.Cnds.OnKeyboardLocked):this.Trigger(Ox.Plugins.Keyboard.Cnds.OnKeyboardLockError)},UnlockKeyboard(){this._isKeyboardLockSupported&&this.PostToDOMAsync("unlock-keyboard")}}}{let Bx=function(t){switch(t=Math.floor(t)){case 8:return"backspace";case 9:return"tab";case 13:return"enter";case 16:return"shift";case 17:return"control";case 18:return"alt";case 19:return"pause";case 20:return"capslock";case 27:return"esc";case 33:return"pageup";case 34:return"pagedown";case 35:return"end";case 36:return"home";case 37:return"";case 38:return"";case 39:return"";case 40:return"";case 45:return"insert";case 46:return"del";case 91:return"left window key";case 92:return"right window key";case 93:return"select";case 96:return"numpad 0";case 97:return"numpad 1";case 98:return"numpad 2";case 99:return"numpad 3";case 100:return"numpad 4";case 101:return"numpad 5";case 102:return"numpad 6";case 103:return"numpad 7";case 104:return"numpad 8";case 105:return"numpad 9";case 106:return"numpad *";case 107:return"numpad +";case 109:return"numpad -";case 110:return"numpad .";case 111:return"numpad /";case 112:return"F1";case 113:return"F2";case 114:return"F3";case 115:return"F4";case 116:return"F5";case 117:return"F6";case 118:return"F7";case 119:return"F8";case 120:return"F9";case 121:return"F10";case 122:return"F11";case 123:return"F12";case 144:return"numlock";case 145:return"scroll lock";case 186:return";";case 187:return"=";case 188:return",";case 189:return"-";case 190:return".";case 191:return"/";case 192:return"'";case 219:return"[";case 220:return"\\";case 221:return"]";case 222:return"#";case 223:return"`";default:return String.fromCharCode(t)}};self.C3.Plugins.Keyboard.Exps={LastKeyCode(){return this._triggerWhich},StringFromKeyCode:t=>Bx(t),TypedKey(){return this._triggerTypedKey}}}{let Lx=function(t,e,s){const i=t.GetSavedDataMap(),r=e.GetSavedDataMap();if(s){const s=i.get(Hx);s&&s.delete(e.GetSID());const n=r.get(Hx);n&&n.delete(t.GetSID())}else{let s=i.get(Hx);s||(s=new Set,i.set(Hx,s));let n=r.get(Hx);n||(n=new Set,r.set(Hx,n)),s.add(e.GetSID()),n.add(t.GetSID())}};0;const kx=self.C3,Nx=self.C3X;let Ux=null,Wx=null,jx=[],Vx=null,zx=null;const Hx="Physics_DisabledCollisions";kx.Behaviors.Physics=class extends kx.SDKBehaviorBase{constructor(t){super(t),zx=this,this._world=null,this._worldG=10,this._worldScale=.02,this._worldManifold=null,this._lastUpdateTick=-1,this._steppingMode=1,this._velocityIterations=8,this._positionIterations=3,this._allCollisionsEnabled=!0,this._runtime.AddLoadPromise(this._LoadBox2DWasm())}GetScriptInterfaceClass(){return self.IPhysicsBehavior}async _LoadBox2DWasm(){const t=this._runtime.GetAssetManager().GetProjectFileUrl("box2d.wasm");await new Promise(e=>{self.Box2DWasmModule({wasmBinaryFile:t}).then(t=>{Vx=t,this._InitBox2DWorld(),e()})})}_InitBox2DWorld(){const t=this._runtime.GetCollisionEngine();Ux=kx.Behaviors.Physics.GetVec2(0,0),Wx=kx.Behaviors.Physics.GetVec2(0,0),this._world=new Vx.b2World(kx.Behaviors.Physics.GetTempVec2A(0,this._worldG),!0);const e=new Vx.JSContactListener;e.BeginContact=e=>{const s=Vx.wrapPointer(e,Vx.b2Contact),i=kx.Behaviors.Physics.Instance.LookupBehInstFromBody(s.GetFixtureA().GetBody()),r=kx.Behaviors.Physics.Instance.LookupBehInstFromBody(s.GetFixtureB().GetBody());t.RegisterCollision(i.GetObjectInstance(),r.GetObjectInstance())},e.EndContact=()=>{},e.PreSolve=()=>{},e.PostSolve=()=>{},this._world.SetContactListener(e);const s=new Vx.JSContactFilter;s.ShouldCollide=(t,e)=>{if(this._allCollisionsEnabled)return!0;const s=Vx.wrapPointer(t,Vx.b2Fixture),i=Vx.wrapPointer(e,Vx.b2Fixture),r=kx.Behaviors.Physics.Instance.LookupBehInstFromBody(s.GetBody()),n=kx.Behaviors.Physics.Instance.LookupBehInstFromBody(i.GetBody()),a=r.GetObjectInstance().GetObjectClass(),o=n.GetObjectInstance().GetObjectClass(),h=a.GetSID(),l=o.GetSID(),c=a.GetSavedDataMap().get(Hx);if(c&&c.has(l))return!1;const u=o.GetSavedDataMap().get(Hx);return(!u||!u.has(h))&&r._CheckCollisionAllowed(n)},this._world.SetContactFilter(s),this._worldManifold=new Vx.b2WorldManifold}Release(){super.Release()}GetBox2D(){return Vx}GetWorld(){return this._world}GetWorldScale(){return this._worldScale}GetSteppingMode(){return this._steppingMode}SetSteppingMode(t){this._steppingMode=t}SetLastUpdateTick(t){this._lastUpdateTick=t}GetLastUpdateTick(){return this._lastUpdateTick}SetVelocityIterations(t){this._velocityIterations=Math.max(t,1)}GetVelocityIterations(){return this._velocityIterations}SetPositionIterations(t){this._positionIterations=Math.max(t,1)}GetPositionIterations(){return this._positionIterations}SetIterations(t,e){this.SetVelocityIterations(t),this.SetPositionIterations(e)}GetGravity(){return this._worldG}SetGravity(t){t!==this._worldG&&(this._world.SetGravity(kx.Behaviors.Physics.GetTempVec2A(0,t)),this._worldG=t,this._WakeUpAllPhysicsBodies())}_WakeUpAllPhysicsBodies(){for(const t of this.GetInstances()){const e=kx.Behaviors.Physics.Instance.LookupBehInstFromInst(t);if(!e)continue;const s=e.GetBody();s&&s.SetAwake(!0)}}DisableShouldCollideFastPath(){this._allCollisionsEnabled=!1}SetCollisionsEnabled(t,e,s){if(s=!!s,t&&e){if(e.IsFamily())for(const i of e.GetFamilyMembers())Lx(t,i,s);else Lx(t,e,s);this.DisableShouldCollideFastPath()}}GetWorldManifold(){return this._worldManifold}static GetPhysicsCollisionKey(){return Hx}static GetVec2(t,e){if(jx.length){const s=jx.pop();return s.set_x(t),s.set_y(e),s}return new(0,Vx.b2Vec2)(t,e)}static FreeVec2(t){jx.push(t)}static GetTempVec2A(t,e){return Ux.set_x(t),Ux.set_y(e),Ux}static GetTempVec2B(t,e){return Wx.set_x(t),Wx.set_y(e),Wx}static CreatePolygonShape(t){const e=new(0,Vx.b2PolygonShape),s=Vx._malloc(8*t.length);let i=0;for(let e=0;e<t.length;++e)Vx.HEAPF32[s+i>>2]=t[e].get_x(),Vx.HEAPF32[s+(i+4)>>2]=t[e].get_y(),i+=8;const r=Vx.wrapPointer(s,Vx.b2Vec2);return e.Set(r,t.length),Vx._free(s),e}};const Yx=["fixed","variable"];self.IPhysicsBehavior=class extends self.IBehavior{constructor(){super()}set worldGravity(t){Nx.RequireFiniteNumber(t),zx.SetGravity(t)}get worldGravity(){return zx.GetGravity()}set steppingMode(t){const e=Yx.indexOf(t);if(e<0)throw new Error("invalid stepping mode");zx.SetSteppingMode(Yx[e])}get steppingMode(){return Yx[zx.GetSteppingMode()]}set velocityIterations(t){Nx.RequireFiniteNumber(t),zx.SetVelocityIterations(t)}get velocityIterations(){return zx.GetVelocityIterations()}set positionIterations(t){Nx.RequireFiniteNumber(t),zx.SetPositionIterations(t)}get positionIterations(){return zx.GetPositionIterations()}setCollisionsEnabled(t,e,s){const i=zx.GetRuntime(),r=i._UnwrapIObjectClass(t),n=i._UnwrapIObjectClass(e);s=!!s,zx.SetCollisionsEnabled(r,n,s)}}}{const Xx=self.C3;Xx.Behaviors.Physics.Type=class extends Xx.SDKBehaviorTypeBase{constructor(t){super(t)}Release(){super.Release()}OnCreate(){}}}{let qx=function(t,e,s){for(const i of e)if(t.has(i))return s;return!s},Jx=function(t,e){return Iw.get(t).GetRuntime()._UnwrapIWorldInstance(e)};0;const Qx=self.C3,Kx=self.C3X,Zx=self.IBehaviorInstance,$x=(self.assert,0),tw=1,ew=2,sw=3,iw=4,rw=5,nw=6,aw=7,ow=8,hw=9,lw=10,cw=11,uw=new WeakMap,_w=new WeakMap,dw=new WeakMap,pw=-2147483648,fw=1073741824,gw=536870912,mw=3758096384,Sw=Qx.Behaviors.Physics.GetTempVec2A,yw=Qx.Behaviors.Physics.GetTempVec2B,Gw=Qx.New(Qx.Rect),Tw=Qx.New(Qx.Quad);Qx.Behaviors.Physics.Instance=class extends Qx.SDKBehaviorInstanceBase{constructor(t,e){super(t);const s=this.GetBehavior(),i=this.GetWorldInfo();this._box2d=s.GetBox2D(),this._world=s.GetWorld(),this._worldScale=s.GetWorldScale(),this._isImmovable=!1,this._collisionMask=0,this._actualCollisionMask=0,this._preventRotation=!1,this._density=1,this._friction=.5,this._restitution=.2,this._linearDamping=0,this._angularDamping=.01,this._isBullet=!1,this._isEnabled=!0,this._body=null,this._fixtures=[],this._myJoints=[],this._myCreatedJoints=[],this._joiningMe=new Set,this._lastKnownX=i.GetX(),this._lastKnownY=i.GetY(),this._lastKnownAngle=i.GetAngle(),this._lastWidth=0,this._lastHeight=0,this._lastTickOverride=!1,this._collisionFilterTags=new Set,this._isCollisionFilterInclusive=!1,e&&(this._isImmovable=!!e[$x],this._collisionMask=e[tw],this._SetCollisionFilter(0===e[sw],Qx.splitStringAndNormalize(e[ew])),this._preventRotation=!!e[iw],this._density=e[rw],this._friction=e[nw],this._restitution=e[aw],this._linearDamping=e[ow],this._angularDamping=e[hw],this._isBullet=!!e[lw],this._isEnabled=!!e[cw]);const r=this._runtime.Dispatcher();this._disposables=new Qx.CompositeDisposable(Qx.Disposable.From(r,"instancedestroy",t=>this._OnInstanceDestroyed(t.instance)),Qx.Disposable.From(r,"beforeload",()=>this._OnBeforeLoad()),Qx.Disposable.From(r,"afterload",()=>this._OnAfterLoad())),_w.set(this._inst,this),this._isEnabled&&this._StartTicking()}PostCreate(){this._CreateBody()}Release(){this._DestroyMyJoints(),Qx.clearArray(this._myCreatedJoints),this._joiningMe.clear(),this._body&&(this._DestroyFixtures(),this._world.DestroyBody(this._body),this._body=null),super.Release()}_CreateFixture(t){if(!this._body)return;const e=this._body.CreateFixture(t);return this._fixtures.push(e),e}_DestroyFixtures(){if(this._body){for(const t of this._fixtures)this._body.DestroyFixture(t);Qx.clearArray(this._fixtures)}}_GetBoundingQuadExcludingMesh(){const t=this.GetWorldInfo();return t.HasMesh()?(t.CalculateBbox(Gw,Tw,!1),Tw):t.GetBoundingQuad()}_Destroy(t){this._box2d.destroy(t)}_CreateBody(){if(!this._isEnabled)return;const t=this._box2d.b2FixtureDef,e=this._box2d.b2BodyDef,s=this.GetWorldInfo(),i=s.HasOwnCollisionPoly();if(this._actualCollisionMask=this._collisionMask,i||this._inst.HasTilemap()||0!==this._actualCollisionMask||(this._actualCollisionMask=1),!this._body){const t=new e;t.set_type(this._isImmovable?0:2);let i=s.GetX()*this._worldScale,r=s.GetY()*this._worldScale;if(2===this._actualCollisionMask){const t=this._GetBoundingQuadExcludingMesh();i=t.midX()*this._worldScale,r=t.midY()*this._worldScale}t.set_position(yw(i,r)),t.set_angle(s.GetAngle()),t.set_fixedRotation(this._preventRotation),t.set_linearDamping(this._linearDamping),t.set_angularDamping(this._angularDamping),t.set_bullet(this._isBullet),this._body=this._world.CreateBody(t),this._Destroy(t),uw.set(this._body,this)}this._DestroyFixtures();const r=new t;r.set_density(this._density),r.set_friction(this._friction),r.set_restitution(this._restitution);const n=Math.max(Math.abs(s.GetWidth()),1),a=Math.max(Math.abs(s.GetHeight()),1);0===this._actualCollisionMask?this._inst.HasTilemap()?this._CreateTilemapFixtures(r):this._CreatePolygonFixture(r,n,a):1===this._actualCollisionMask?this._CreateBoundingBoxFixture(r,s,n,a):this._CreateCircleFixture(r,n,a),this._lastWidth=s.GetWidth(),this._lastHeight=s.GetHeight(),s.SetPhysicsBodyChanged(!1),this._Destroy(r)}_CreateBoundingBoxFixture(t,e,s,i){const r=new(0,this._box2d.b2PolygonShape),n=s*this._worldScale,a=i*this._worldScale;let o=e.GetOriginX(),h=e.GetOriginY();e.GetWidth()<0&&(o=1-o),e.GetHeight()<0&&(h=1-h);const l=(.5-o)*n,c=(.5-h)*a,u=Qx.Behaviors.Physics.GetVec2(l,c);r.SetAsBox(n/2,a/2,u,0),t.set_shape(r),this._CreateFixture(t),this._Destroy(r),Qx.Behaviors.Physics.FreeVec2(u)}_CreateCircleFixture(t,e,s){const i=new(0,this._box2d.b2CircleShape);i.set_m_radius(Math.min(e,s)*this._worldScale*.5),t.set_shape(i),this._CreateFixture(t),this._Destroy(i)}_CreatePolygonFixture(t,e,s){const i=this.GetWorldInfo(),r=i.GetWidth()<0,n=i.GetHeight()<0,a=this._worldScale,o=i.GetCustomTransformedCollisionPoly(r?-e:e,n?-s:s,0).pointsArr(),h=o.length/2,l=[];for(let t=0;t<h;++t)l.push(Qx.Behaviors.Physics.GetVec2(o[2*t],o[2*t+1]));r!==n&&l.reverse();const c=Qx.Behaviors.Physics.Separator.Separate(l,e*s);for(const t of l)Qx.Behaviors.Physics.FreeVec2(t);if(c.length)for(const e of c){for(const t of e)t.set_x(t.get_x()*a),t.set_y(t.get_y()*a);const s=Qx.Behaviors.Physics.CreatePolygonShape(e);t.set_shape(s),this._CreateFixture(t),this._Destroy(s);for(const t of e)Qx.Behaviors.Physics.FreeVec2(t)}else this._CreateBoundingBoxFixture(t,i,e,s)}_CreateTilemapFixtures(t){const e=this._worldScale,s=Qx.Behaviors.Physics.GetVec2,i=Qx.Behaviors.Physics.FreeVec2,r=[];this._inst.GetSdkInstance().GetAllCollisionRects(r);const n=[];for(let a=0,o=r.length;a<o;++a){const o=r[a],h=o.GetRect(),l=o.GetPoly();if(l){let r=dw.get(l);if(!r){const t=l.pointsArr(),e=l.pointCount();for(let i=0;i<e;++i)n.push(s(t[2*i],t[2*i+1]));const a=o.GetTileId()&mw;(a===pw||a===fw||a===gw||a&pw&&a&fw&&a&gw)&&n.reverse(),r=Qx.Behaviors.Physics.Separator.Separate(n,h.width()*h.height()),dw.set(l,r);for(const t of n)i(t);Qx.clearArray(n)}for(let a=0,o=r.length;a<o;++a){const o=r[a];for(let t=0,i=o.length;t<i;++t)n.push(s((h.getLeft()+o[t].get_x())*e,(h.getTop()+o[t].get_y())*e));const l=Qx.Behaviors.Physics.CreatePolygonShape(n);t.set_shape(l),this._CreateFixture(t),this._Destroy(l);for(const t of n)i(t);Qx.clearArray(n)}}else{n.push(s(h.getLeft()*e,h.getTop()*e)),n.push(s(h.getRight()*e,h.getTop()*e)),n.push(s(h.getRight()*e,h.getBottom()*e)),n.push(s(h.getLeft()*e,h.getBottom()*e));const i=Qx.Behaviors.Physics.CreatePolygonShape(n);t.set_shape(i),this._CreateFixture(t),this._Destroy(i)}for(const t of n)i(t);Qx.clearArray(n)}}_DestroyBody(){this._body&&(this._DestroyMyJoints(),uw.delete(this._body),this._DestroyFixtures(),this._world.DestroyBody(this._body),this._body=null)}_DestroyMyJoints(){for(const t of this._myJoints)this._world.DestroyJoint(t);Qx.clearArray(this._myJoints)}_RecreateMyJoints(){for(const t of this._myCreatedJoints)switch(t.type){case 0:this._DoCreateDistanceJoint(...t.params);break;case 1:this._DoCreateRevoluteJoint(...t.params);break;case 2:this._DoCreateLimitedRevoluteJoint(...t.params);break;case 3:this._DoCreatePrismaticJoint(...t.params)}}_GetInstImagePoint(t){const e=this.GetWorldInfo();if(-1===t)return[e.GetX(),e.GetY()];if(0===t&&this._body){const t=this._body.GetWorldCenter();return[t.get_x()/this._worldScale,t.get_y()/this._worldScale]}return this._inst.GetImagePoint(t)}_CreateDistanceJoint(t,e,s,i,r){if(!this._isEnabled||!e||e===this._inst)return;const n=Qx.Behaviors.Physics.Instance.LookupBehInstFromInst(e);n&&n._IsEnabled()&&(this._myCreatedJoints.push({type:0,params:[t,e.GetUID(),s,i,r]}),this._DoCreateDistanceJoint(t,e.GetUID(),s,i,r))}_DoCreateDistanceJoint(t,e,s,i,r){if(!this._isEnabled)return;const n=this._runtime.GetInstanceByUID(e);if(!n||n===this._inst)return;const a=Qx.Behaviors.Physics.Instance.LookupBehInstFromInst(n);if(!a||!a._IsEnabled())return;a._joiningMe.add(this._inst),this._UpdateBodyToMatchInstance(!1),a._UpdateBodyToMatchInstance(!1);const[o,h]=this._GetInstImagePoint(t),[l,c]=n.GetImagePoint(s),u=o-l,_=h-c,d=this._box2d.b2DistanceJointDef,p=this._worldScale,f=new d;f.Initialize(this._body,a.GetBody(),Sw(o*p,h*p),yw(l*p,c*p)),f.set_length(Math.hypot(u,_)*p),f.set_dampingRatio(i),f.set_frequencyHz(r),this._myJoints.push(this._world.CreateJoint(f)),this._Destroy(f)}_CreateRevoluteJoint(t,e){if(!this._isEnabled||!e||e===this._inst)return;const s=Qx.Behaviors.Physics.Instance.LookupBehInstFromInst(e);s&&s._IsEnabled()&&(this._myCreatedJoints.push({type:1,params:[t,e.GetUID()]}),this._DoCreateRevoluteJoint(t,e.GetUID()))}_DoCreateRevoluteJoint(t,e){if(!this._isEnabled)return;const s=this._runtime.GetInstanceByUID(e);if(!s||s===this._inst)return;const i=Qx.Behaviors.Physics.Instance.LookupBehInstFromInst(s);if(!i||!i._IsEnabled())return;i._joiningMe.add(this._inst),this._UpdateBodyToMatchInstance(!1),i._UpdateBodyToMatchInstance(!1);const[r,n]=this._GetInstImagePoint(t),a=this._box2d.b2RevoluteJointDef,o=this._worldScale,h=new a;h.Initialize(this._body,i.GetBody(),Sw(r*o,n*o)),this._myJoints.push(this._world.CreateJoint(h)),this._Destroy(h)}_CreateLimitedRevoluteJoint(t,e,s,i){if(!this._isEnabled||!e||e===this._inst)return;const r=Qx.Behaviors.Physics.Instance.LookupBehInstFromInst(e);r&&r._IsEnabled()&&(s=Qx.toDegrees(s),i=Qx.toDegrees(i),this._myCreatedJoints.push({type:2,params:[t,e.GetUID(),s,i]}),this._DoCreateLimitedRevoluteJoint(t,e.GetUID(),s,i))}_DoCreateLimitedRevoluteJoint(t,e,s,i){if(!this._isEnabled)return;const r=this._runtime.GetInstanceByUID(e);if(!r||r===this._inst)return;const n=Qx.Behaviors.Physics.Instance.LookupBehInstFromInst(r);if(!n||!n._IsEnabled())return;n._joiningMe.add(this._inst),this._UpdateBodyToMatchInstance(!1),n._UpdateBodyToMatchInstance(!1);const[a,o]=this._GetInstImagePoint(t),h=this._box2d.b2RevoluteJointDef,l=this._worldScale,c=new h;c.Initialize(this._body,n.GetBody(),Sw(a*l,o*l)),c.set_enableLimit(!0),c.set_lowerAngle(Qx.toRadians(s)),c.set_upperAngle(Qx.toRadians(i)),this._myJoints.push(this._world.CreateJoint(c)),this._Destroy(c)}_CreatePrismaticJoint(t,e,s,i,r,n,a,o,h){if(!this._isEnabled||!e||e===this._inst)return;const l=Qx.Behaviors.Physics.Instance.LookupBehInstFromInst(e);l&&l._IsEnabled()&&(s=Qx.toDegrees(s),o=Qx.toDegrees(o),this._myCreatedJoints.push({type:3,params:[t,e.GetUID(),s,i,r,n,a,o,h]}),this._DoCreatePrismaticJoint(t,e.GetUID(),s,i,r,n,a,o,h))}_DoCreatePrismaticJoint(t,e,s,i,r,n,a,o,h){if(!this._isEnabled)return;const l=this._runtime.GetInstanceByUID(e);if(!l||l===this._inst)return;const c=Qx.Behaviors.Physics.Instance.LookupBehInstFromInst(l);if(!c||!c._IsEnabled())return;c._joiningMe.add(this._inst),this._UpdateBodyToMatchInstance(!1),c._UpdateBodyToMatchInstance(!1);const[u,_]=this._GetInstImagePoint(t);s=Qx.toRadians(s);const d=Math.cos(s),p=Math.sin(s),f=this._box2d.b2PrismaticJointDef,g=this._worldScale,m=new f;m.Initialize(this._body,c.GetBody(),Sw(u*g,_*g),yw(d,p)),m.set_enableLimit(!!i),m.set_lowerTranslation(r*g),m.set_upperTranslation(n*g),m.set_enableMotor(!!a),m.set_motorSpeed(Qx.toRadians(o)),m.set_maxMotorForce(h),this._myJoints.push(this._world.CreateJoint(m)),this._Destroy(m)}_RemoveJoints(){this._isEnabled&&(this._DestroyMyJoints(),Qx.clearArray(this._myCreatedJoints),this._joiningMe.clear())}_RemoveOtherInstanceJointsToMe(){for(const t of this._joiningMe){const e=Qx.Behaviors.Physics.Instance.LookupBehInstFromInst(t);if(!e||!e._IsEnabled())return;e._DestroyJointsForInstance(this._inst)}this._joiningMe.clear()}_OnInstanceDestroyed(t){this._DestroyJointsForInstance(t)}_DestroyJointsForInstance(t){const e=t.GetUID();let s=0;for(let t=0,i=this._myCreatedJoints.length;t<i;++t)this._myCreatedJoints[s]=this._myCreatedJoints[t],s<this._myJoints.length&&(this._myJoints[s]=this._myJoints[t]),this._myCreatedJoints[t].params[1]===e?t<this._myJoints.length&&this._world.DestroyJoint(this._myJoints[t]):++s;Qx.truncateArray(this._myCreatedJoints,s),s<this._myJoints.length&&Qx.truncateArray(this._myJoints,s),this._joiningMe.delete(t)}GetBody(){return this._body}static LookupBehInstFromBody(t){return uw.get(t)||null}static LookupBehInstFromInst(t){return _w.get(t)||null}SaveToJson(){const t={e:this._isEnabled,im:this._isImmovable,pr:this._preventRotation,d:this._density,fr:this._friction,re:this._restitution,ld:this._linearDamping,ad:this._angularDamping,b:this._isBullet,mcj:this._myCreatedJoints};if(this._isCollisionFilterInclusive&&(t.cfi=this._isCollisionFilterInclusive),this._collisionFilterTags.size>0&&(t.cft=[...this._collisionFilterTags]),this._isEnabled){const e=this._body.GetLinearVelocity();t.vx=e.get_x(),t.vy=e.get_y(),t.om=this._body.GetAngularVelocity()}return t}_OnBeforeLoad(){this._DestroyMyJoints(),Qx.clearArray(this._myCreatedJoints),this._joiningMe.clear()}LoadFromJson(t){this._DestroyBody(),this._isEnabled=t.e,t.hasOwnProperty("im")&&(this._isImmovable=!!t.im),this._preventRotation=t.pr,this._density=t.d,this._friction=t.fr,this._restitution=t.re,this._linearDamping=t.ld,this._angularDamping=t.ad,this._isBullet=t.b,this._myCreatedJoints=t.mcj;const e=!!t.cfi,s=t.cft??[];this._SetCollisionFilter(e,s);const i=this.GetWorldInfo();this._lastKnownX=i.GetX(),this._lastKnownY=i.GetY(),this._lastKnownAngle=i.GetAngle(),this._lastWidth=i.GetWidth(),this._lastHeight=i.GetHeight(),this._isEnabled&&(this._CreateBody(),this._body.SetLinearVelocity(Sw(t.vx,t.vy)),this._body.SetAngularVelocity(t.om),0===t.vx&&0===t.vy&&0===t.om||this._body.SetAwake(!0),this._myCreatedJoints=t.mcj),this._isEnabled?this._StartTicking():this._StopTicking()}_OnAfterLoad(){this._isEnabled&&this._RecreateMyJoints()}Tick(){if(!this._isEnabled)return;const t=this._runtime,e=this.GetBehavior();let s=0;0===e.GetSteppingMode()?s=t.GetTimeScale()/60:(s=t.GetDt(this._inst),s>1/30&&(s=1/30));const i=t.GetTickCountNoSave();i>e.GetLastUpdateTick()&&t.GetTimeScale()>0&&(0!==s&&this._world.Step(s,e.GetVelocityIterations(),e.GetPositionIterations()),this._world.ClearForces(),e.SetLastUpdateTick(i)),this._UpdateBodyToMatchInstance(!0)}_UpdateBodyToMatchInstance(t){const e=this._inst.GetWorldInfo(),s=this._worldScale;(e.GetWidth()!==this._lastWidth||e.GetHeight()!==this._lastHeight||e.IsPhysicsBodyChanged())&&this._CreateBody();const i=this._body,r=e.GetX(),n=e.GetY(),a=r-this._lastKnownX,o=n-this._lastKnownY,h=Math.abs(a)>.001||Math.abs(o)>.001,l=e.GetAngle()!==this._lastKnownAngle;let c=r,u=n;if(2===this._actualCollisionMask){const t=this._GetBoundingQuadExcludingMesh();c=t.midX(),u=t.midY()}h?(l?i.SetTransform(Sw(c*s,u*s),e.GetAngle()):i.SetTransform(Sw(c*s,u*s),i.GetAngle()),t&&(i.SetLinearVelocity(Sw(a,o)),this._lastTickOverride=!0),i.SetAwake(!0)):t&&this._lastTickOverride&&(this._lastTickOverride=!1,i.SetLinearVelocity(Sw(0,0)),i.SetTransform(Sw(c*s,u*s),i.GetAngle())),!h&&l&&(i.SetTransform(i.GetPosition(),e.GetAngle()),i.SetAwake(!0));const _=i.GetPosition(),d=_.get_x()/s,p=_.get_y()/s,f=i.GetAngle();if((d!==e.GetX()||p!==e.GetY()||f!==e.GetAngle())&&(e.SetXY(d,p),e.SetAngle(f),e.SetBboxChanged(),2===this._actualCollisionMask)){const t=this._GetBoundingQuadExcludingMesh(),s=t.midX()-e.GetX(),i=t.midY()-e.GetY();0===s&&0===i||(e.OffsetXY(-s,-i),e.SetBboxChanged())}this._lastKnownX=e.GetX(),this._lastKnownY=e.GetY(),this._lastKnownAngle=e.GetAngle()}GetPropertyValueByIndex(t){switch(t){case iw:return this._IsPreventRotate();case rw:return this._GetDensity();case nw:return this._GetFriction();case aw:return this._GetElasticity();case ow:return this._GetLinearDamping();case hw:return this._GetAngularDamping();case lw:return this._IsBullet();case cw:return this._IsEnabled()}}SetPropertyValueByIndex(t,e){switch(t){case iw:this._SetPreventRotate(e);break;case rw:this._SetDensity(e);break;case nw:this._SetFriction(e);break;case aw:this._SetElasticity(e);break;case ow:this._SetLinearDamping(e);break;case hw:this._SetAngularDamping(e);break;case lw:this._SetBullet(e);break;case cw:this._SetEnabled(e)}}_SetEnabled(t){t=!!t,this._isEnabled&&!t?(this._RemoveOtherInstanceJointsToMe(),this._DestroyBody(),this._isEnabled=!1,this._StopTicking()):!this._isEnabled&&t&&(this._isEnabled=!0,this._CreateBody(),this._StartTicking())}_IsEnabled(){return this._isEnabled}GetDebuggerProperties(){const t="behaviors.physics",e=[{name:t+".properties.enabled.name",value:this._IsEnabled(),onedit:t=>this._SetEnabled(t)},{name:t+".properties.immovable.name",value:this._IsImmovable(),onedit:t=>this._SetImmovable(t)},{name:t+".properties.collision-filter-tags.name",value:[...this._GetCollisionFilterTagSet()].join(" "),onedit:t=>this._SetFilterTags(Qx.splitStringAndNormalize(t))},{name:t+".debugger.collision-filter-inclusive",value:this._IsCollisionFilterInclusive(),onedit:t=>this._SetFilterInclusive(t)},{name:t+".properties.density.name",value:this._GetDensity(),onedit:t=>this._SetDensity(t)},{name:t+".properties.friction.name",value:this._GetFriction(),onedit:t=>this._SetFriction(t)},{name:t+".properties.elasticity.name",value:this._GetElasticity(),onedit:t=>this._SetElasticity(t)},{name:t+".properties.linear-damping.name",value:this._GetLinearDamping(),onedit:t=>this._SetLinearDamping(t)},{name:t+".properties.angular-damping.name",value:this._GetAngularDamping(),onedit:t=>this._SetAngularDamping(t)}];return this._isEnabled&&(e.push({name:t+".debugger.is-sleeping",value:!this._IsAwake()}),e.push({name:t+".debugger.velocity-x",value:this._GetVelocityX(),onedit:t=>this._SetVelocity(t,this._GetVelocityY())}),e.push({name:t+".debugger.velocity-y",value:this._GetVelocityY(),onedit:t=>this._SetVelocity(this._GetVelocityX(),t)}),e.push({name:t+".debugger.angular-velocity",value:Qx.toDegrees(this._GetAngularVelocity()),onedit:t=>this._SetAngularVelocity(Qx.toRadians(t))}),e.push({name:t+".debugger.mass",value:this._GetMass()})),[{title:"$"+this.GetBehaviorType().GetName(),properties:e}]}_ApplyForce(t,e,s){const[i,r]=this._GetInstImagePoint(s);this._DoApplyForce(t,e,i,r)}_ApplyForceToward(t,e,s,i){const[r,n]=this._GetInstImagePoint(i),a=Qx.angleTo(r,n,e,s);this._DoApplyForce(Math.cos(a)*t,Math.sin(a)*t,r,n)}_ApplyForceAtAngle(t,e,s){const[i,r]=this._GetInstImagePoint(s);this._DoApplyForce(Math.cos(e)*t,Math.sin(e)*t,i,r)}_DoApplyForce(t,e,s,i){if(!this._isEnabled)return;const r=this._worldScale;this._body.ApplyForce(Sw(t,e),yw(s*r,i*r),!0)}_ApplyImpulse(t,e,s){const[i,r]=this._GetInstImagePoint(s);this._DoApplyImpulse(t,e,i,r)}_ApplyImpulseToward(t,e,s,i){const[r,n]=this._GetInstImagePoint(i),a=Qx.angleTo(r,n,e,s);this._DoApplyImpulse(Math.cos(a)*t,Math.sin(a)*t,r,n)}_ApplyImpulseAtAngle(t,e,s){const[i,r]=this._GetInstImagePoint(s);this._DoApplyImpulse(Math.cos(e)*t,Math.sin(e)*t,i,r)}_DoApplyImpulse(t,e,s,i){if(!this._isEnabled)return;const r=this._worldScale;this._body.ApplyLinearImpulse(Sw(t,e),yw(s*r,i*r),!0);const n=this.GetWorldInfo();this._lastKnownX=n.GetX(),this._lastKnownY=n.GetY(),this._lastTickOverride=!1}_ApplyTorque(t){this._isEnabled&&this._body.ApplyTorque(t,!0)}_ApplyTorqueToAngle(t,e){const s=Qx.angleClockwise(this.GetWorldInfo().GetAngle(),e)?-1:1;this._ApplyTorque(t*s)}_ApplyTorqueToPosition(t,e,s){const i=this.GetWorldInfo(),r=Qx.angleTo(i.GetX(),i.GetY(),e,s),n=Qx.angleClockwise(i.GetAngle(),r)?-1:1;this._ApplyTorque(t*n)}_SetAngularVelocity(t){this._isEnabled&&(this._body.SetAngularVelocity(t),this._body.SetAwake(!0))}_GetAngularVelocity(){return this._isEnabled?this._body.GetAngularVelocity():0}_SetVelocity(t,e){if(!this._isEnabled)return;const s=this._worldScale;this._body.SetLinearVelocity(Sw(t*s,e*s)),this._body.SetAwake(!0);const i=this.GetWorldInfo();this._lastKnownX=i.GetX(),this._lastKnownY=i.GetY(),this._lastTickOverride=!1}_GetVelocity(){if(!this._isEnabled)return[0,0];const t=this._worldScale,e=this._body.GetLinearVelocity();return[e.get_x()/t,e.get_y()/t]}_GetVelocityX(){return this._isEnabled?this._body.GetLinearVelocity().get_x()/this._worldScale:0}_GetVelocityY(){return this._isEnabled?this._body.GetLinearVelocity().get_y()/this._worldScale:0}_Teleport(t,e){if(!this._isEnabled)return;const s=this._worldScale;this._body.SetTransform(Sw(t*s,e*s),this._body.GetAngle());const i=this.GetWorldInfo();i.SetXY(t,e),i.SetBboxChanged(),this._lastKnownX=i.GetX(),this._lastKnownY=i.GetY()}_SetDensity(t){if(this._isEnabled&&this._density!==t){this._density=t;for(const e of this._fixtures)e.SetDensity(t);this._body.ResetMassData()}}_GetDensity(){return this._isEnabled?this._density:0}_SetFriction(t){if(this._isEnabled&&this._friction!==t){this._friction=t;for(const e of this._fixtures)e.SetFriction(t);if(this._body)for(let t=this._body.GetContactList();this._box2d.getPointer(t);t=t.get_next()){const e=t.get_contact();e&&e.ResetFriction()}}}_GetFriction(){return this._isEnabled?this._friction:0}_SetElasticity(t){if(this._isEnabled&&this._restitution!==t){this._restitution=t;for(const e of this._fixtures)e.SetRestitution(t)}}_GetElasticity(){return this._isEnabled?this._restitution:0}_SetLinearDamping(t){this._isEnabled&&this._linearDamping!==t&&(this._linearDamping=t,this._body.SetLinearDamping(t))}_GetLinearDamping(){return this._isEnabled?this._linearDamping:0}_SetAngularDamping(t){this._isEnabled&&this._angularDamping!==t&&(this._angularDamping=t,this._body.SetAngularDamping(t))}_GetAngularDamping(){return this._isEnabled?this._angularDamping:0}_SetImmovable(t){this._isEnabled&&(t=!!t,this._isImmovable!==t&&(this._isImmovable=t,this._body.SetType(this._isImmovable?0:2),this._body.SetAwake(!0)))}_IsImmovable(){return this._isImmovable}_SetPreventRotate(t){this._isEnabled&&(t=!!t,this._preventRotation!==t&&(this._preventRotation=t,this._body.SetFixedRotation(this._preventRotation),this._body.SetAngularVelocity(0),this._body.SetAwake(!0)))}_IsPreventRotate(){return this._preventRotation}_SetBullet(t){this._isEnabled&&(t=!!t,this._isBullet!==t&&(this._isBullet=t,this._body.SetBullet(this._isBullet),this._body.SetAwake(!0)))}_IsBullet(){return this._isBullet}_SetAwake(t){this._isEnabled&&this._body.SetAwake(!!t)}_IsAwake(){return!!this._isEnabled&&this._body.IsAwake()}_GetMass(){return this._isEnabled?this._body.GetMass()/this._worldScale:0}_GetCenterOfMassX(){return this._isEnabled?this._body.GetWorldCenter().get_x()/this._worldScale:0}_GetCenterOfMassY(){return this._isEnabled?this._body.GetWorldCenter().get_y()/this._worldScale:0}_GetCenterOfMass(){if(!this._isEnabled)return[0,0];const t=this._body.GetWorldCenter(),e=this._worldScale;return[t.get_x()/e,t.get_y()/e]}_GetContactCount(){if(!this._isEnabled)return 0;let t=0;for(let e=this._body.GetContactList();this._box2d.getPointer(e);e=e.get_next()){const s=e.get_contact();s&&(t+=s.GetManifold().get_pointCount())}return t}_GetContactPositionAt(t){if(t=Math.floor(t),!this._isEnabled)return[0,0];let e=0;for(let s=this._body.GetContactList();this._box2d.getPointer(s);s=s.get_next()){const i=s.get_contact();if(!i)continue;const r=i.GetManifold().get_pointCount();if(t>=e&&t<e+r){const s=t-e,r=this.GetBehavior().GetWorldManifold();i.GetWorldManifold(r);const n=r.get_points(s);return[n.get_x()/this._worldScale,n.get_y()/this._worldScale]}e+=r}return[0,0]}_SetCollisionFilter(t,e){this._isCollisionFilterInclusive=!!t,this._collisionFilterTags.clear();for(const t of e)this._collisionFilterTags.add(t.toLowerCase());(this._isCollisionFilterInclusive||this._collisionFilterTags.size>0)&&this.GetBehavior().DisableShouldCollideFastPath()}_GetCollisionFilterTagSet(){return this._collisionFilterTags}_IsCollisionFilterInclusive(){return this._isCollisionFilterInclusive}_CheckCollisionAllowed(t){return qx(this._inst.GetLowercaseTagsSet(),t._collisionFilterTags,t._isCollisionFilterInclusive)&&qx(t._inst.GetLowercaseTagsSet(),this._collisionFilterTags,this._isCollisionFilterInclusive)}GetScriptInterfaceClass(){return self.IPhysicsBehaviorInstance}};const Iw=new WeakMap;self.IPhysicsBehaviorInstance=class extends Zx{constructor(){super(),Iw.set(this,Zx._GetInitInst().GetSdkInstance())}get isEnabled(){return Iw.get(this)._IsEnabled()}set isEnabled(t){Iw.get(this)._SetEnabled(t)}applyForce(t,e,s=0){Kx.RequireFiniteNumber(t),Kx.RequireFiniteNumber(e),Iw.get(this)._ApplyForce(t,e,s)}applyForceTowardPosition(t,e,s,i=0){Kx.RequireFiniteNumber(t),Kx.RequireFiniteNumber(e),Kx.RequireFiniteNumber(s),Iw.get(this)._ApplyForceToward(t,e,s,i)}applyForceAtAngle(t,e,s=0){Kx.RequireFiniteNumber(t),Kx.RequireFiniteNumber(e),Iw.get(this)._ApplyForceAtAngle(t,e,s)}applyImpulse(t,e,s=0){Kx.RequireFiniteNumber(t),Kx.RequireFiniteNumber(e),Iw.get(this)._ApplyImpulse(t,e,s)}applyImpulseTowardPosition(t,e,s,i=0){Kx.RequireFiniteNumber(t),Kx.RequireFiniteNumber(e),Kx.RequireFiniteNumber(s),Iw.get(this)._ApplyImpulseToward(t,e,s,i)}applyImpulseAtAngle(t,e,s=0){Kx.RequireFiniteNumber(t),Kx.RequireFiniteNumber(e),Iw.get(this)._ApplyImpulseAtAngle(t,e,s)}applyTorque(t){Kx.RequireFiniteNumber(t),Iw.get(this)._ApplyTorque(t)}applyTorqueToAngle(t,e){Kx.RequireFiniteNumber(t),Kx.RequireFiniteNumber(e),Iw.get(this)._ApplyTorqueToAngle(t,e)}applyTorqueToPosition(t,e,s){Kx.RequireFiniteNumber(t),Kx.RequireFiniteNumber(e),Kx.RequireFiniteNumber(s),Iw.get(this)._ApplyTorqueToPosition(t,e,s)}set angularVelocity(t){Kx.RequireFiniteNumber(t),Iw.get(this)._SetAngularVelocity(t)}get angularVelocity(){return Iw.get(this)._GetAngularVelocity()}setVelocity(t,e){Kx.RequireFiniteNumber(t),Kx.RequireFiniteNumber(e),Iw.get(this)._SetVelocity(t,e)}getVelocityX(){return Iw.get(this)._GetVelocityX()}getVelocityY(){return Iw.get(this)._GetVelocityY()}getVelocity(){return Iw.get(this)._GetVelocity()}teleport(t,e){Kx.RequireFiniteNumber(t),Kx.RequireFiniteNumber(e),Iw.get(this)._Teleport(t,e)}set density(t){Kx.RequireFiniteNumber(t),Iw.get(this)._SetDensity(t)}get density(){return Iw.get(this)._GetDensity()}set friction(t){Kx.RequireFiniteNumber(t),Iw.get(this)._SetFriction(t)}get friction(){return Iw.get(this)._GetFriction()}set elasticity(t){Kx.RequireFiniteNumber(t),Iw.get(this)._SetElasticity(t)}get elasticity(){return Iw.get(this)._GetElasticity()}set linearDamping(t){Kx.RequireFiniteNumber(t),Iw.get(this)._SetLinearDamping(t)}get linearDamping(){return Iw.get(this)._GetLinearDamping()}set angularDamping(t){Kx.RequireFiniteNumber(t),Iw.get(this)._SetAngularDamping(t)}get angularDamping(){return Iw.get(this)._GetAngularDamping()}set isImmovable(t){Iw.get(this)._SetImmovable(t)}get isImmovable(){return Iw.get(this)._IsImmovable()}set isPreventRotation(t){Iw.get(this)._SetPreventRotate(t)}get isPreventRotation(){return Iw.get(this)._IsPreventRotate()}set isBullet(t){Iw.get(this)._SetBullet(t)}get isBullet(){return Iw.get(this)._IsBullet()}get mass(){return Iw.get(this)._GetMass()}getCenterOfMassX(){return Iw.get(this)._GetCenterOfMassX()}getCenterOfMassY(){return Iw.get(this)._GetCenterOfMassY()}getCenterOfMass(){return Iw.get(this)._GetCenterOfMass()}getContactCount(){return Iw.get(this)._GetContactCount()}getContactX(t){return Kx.RequireFiniteNumber(t),Iw.get(this)._GetContactPositionAt(t)[0]}getContactY(t){return Kx.RequireFiniteNumber(t),Iw.get(this)._GetContactPositionAt(t)[1]}getContact(t){return Kx.RequireFiniteNumber(t),Iw.get(this)._GetContactPositionAt(t)}set isAwake(t){Iw.get(this)._SetAwake(!!t)}get isAwake(){return Iw.get(this)._IsAwake()}get isSleeping(){return!Iw.get(this)._IsAwake()}createDistanceJoint(t,e,s,i,r){Kx.RequireFiniteNumber(i),Kx.RequireFiniteNumber(r);const n=Jx(this,e);Iw.get(this)._CreateDistanceJoint(t,n,s,i,r)}createRevoluteJoint(t,e){const s=Jx(this,e);Iw.get(this)._CreateRevoluteJoint(t,s)}createLimitedRevoluteJoint(t,e,s,i){Kx.RequireFiniteNumber(s),Kx.RequireFiniteNumber(i);const r=Jx(this,e);Iw.get(this)._CreateLimitedRevoluteJoint(t,r,s,i)}createPrismaticJoint(t,e,s,i,r,n,a,o,h){const l=Jx(this,e);Iw.get(this)._CreatePrismaticJoint(t,l,s,i,r,n,a,o,h)}removeAllJoints(){Iw.get(this)._RemoveJoints()}setCollisionFilter(t,e){"string"==typeof e&&(e=Qx.splitStringAndNormalize(e)),Iw.get(this)._SetCollisionFilter(t,e)}}}{const Cw=self.C3;Cw.Behaviors.Physics.Cnds={IsSleeping(){return!this._IsAwake()},IsImmovable(){return this._IsImmovable()},CompareVelocity(t,e,s){if(!this._isEnabled)return!1;let i=0;if(0===t)i=this._GetVelocityX();else if(1===t)i=this._GetVelocityY();else{const[t,e]=this._GetVelocity();i=Math.hypot(t,e)}return Cw.compare(i,e,s)},CompareAngularVelocity(t,e){if(!this._isEnabled)return!1;const s=Cw.toDegrees(this._GetAngularVelocity());return Cw.compare(s,t,e)},CompareMass(t,e){if(!this._isEnabled)return!1;const s=this._GetMass();return Cw.compare(s,t,e)},IsEnabled(){return this._IsEnabled()}}}{const bw=self.C3;bw.Behaviors.Physics.Acts={ApplyForce(t,e,s){this._ApplyForce(t,e,s)},ApplyForceToward(t,e,s,i){this._ApplyForceToward(t,e,s,i)},ApplyForceAtAngle(t,e,s){this._ApplyForceAtAngle(t,bw.toRadians(e),s)},ApplyImpulse(t,e,s){this._ApplyImpulse(t,e,s)},ApplyImpulseToward(t,e,s,i){this._ApplyImpulseToward(t,e,s,i)},ApplyImpulseAtAngle(t,e,s){this._ApplyImpulseAtAngle(t,bw.toRadians(e),s)},ApplyTorque(t){this._ApplyTorque(bw.toRadians(t))},ApplyTorqueToAngle(t,e){this._ApplyTorqueToAngle(bw.toRadians(t),bw.toRadians(e))},ApplyTorqueToPosition(t,e,s){this._ApplyTorqueToPosition(bw.toRadians(t),e,s)},SetAngularVelocity(t){this._SetAngularVelocity(bw.toRadians(t))},CreateDistanceJoint(t,e,s,i,r){if(!e)return;const n=e.GetFirstPicked(this._inst);this._CreateDistanceJoint(t,n,s,i,r)},CreateRevoluteJoint(t,e){if(!e)return;const s=e.GetFirstPicked(this._inst);this._CreateRevoluteJoint(t,s)},CreateLimitedRevoluteJoint(t,e,s,i){if(!e)return;const r=e.GetFirstPicked(this._inst);this._CreateLimitedRevoluteJoint(t,r,bw.toRadians(s),bw.toRadians(i))},CreatePrismaticJoint(t,e,s,i,r,n,a,o,h){if(!e)return;const l=e.GetFirstPicked(this._inst);this._CreatePrismaticJoint(t,l,bw.toRadians(s),i,r,n,a,bw.toRadians(o),h)},RemoveJoints(){this._RemoveJoints()},SetWorldGravity(t){this.GetBehavior().SetGravity(t)},SetSteppingMode(t){this.GetBehavior().SetSteppingMode(t)},SetIterations(t,e){this.GetBehavior().SetIterations(t,e)},SetVelocity(t,e){this._SetVelocity(t,e)},Teleport(t,e){this._Teleport(t,e)},SetDensity(t){this._SetDensity(t)},SetFriction(t){this._SetFriction(t)},SetElasticity(t){this._SetElasticity(t)},SetLinearDamping(t){this._SetLinearDamping(t)},SetAngularDamping(t){this._SetAngularDamping(t)},SetImmovable(t){this._SetImmovable(t)},EnableCollisions(t,e){this.GetBehavior().SetCollisionsEnabled(this.GetObjectClass(),t,0!==e)},SetPreventRotate(t){this._SetPreventRotate(0!==t)},SetBullet(t){this._SetBullet(0!==t)},SetAwake(t){this._SetAwake(!!t)},SetEnabled(t){this._SetEnabled(0!==t)},SetCollisionFilter(t,e){this._SetCollisionFilter(0===t,bw.splitStringAndNormalize(e))}}}{const xw=self.C3;xw.Behaviors.Physics.Exps={VelocityX(){return this._GetVelocityX()},VelocityY(){return this._GetVelocityY()},AngularVelocity(){return xw.toDegrees(this._GetAngularVelocity())},Mass(){return this._GetMass()},CenterOfMassX(){return this._GetCenterOfMassX()},CenterOfMassY(){return this._GetCenterOfMassY()},Density(){return this._GetDensity()},Friction(){return this._GetFriction()},Elasticity(){return this._GetElasticity()},LinearDamping(){return this._GetLinearDamping()},AngularDamping(){return this._GetAngularDamping()},ContactCount(){return this._GetContactCount()},ContactXAt(t){return this._GetContactPositionAt(t)[0]},ContactYAt(t){return this._GetContactPositionAt(t)[1]}}}{let ww=function(t){return Aw(t.get_x(),t.get_y())},Mw=function(t){const e=[];for(const s of t)s.length<=8?e.push(s):e.push.apply(e,Pw(s));return e},Pw=function(t){const e=[];e.push(t.splice(0,8));const s=e[0][0];let i=e[0][7];for(;t.length;){const r=t.splice(0,Math.min(t.length,6));let n=r.at(-1);r.push(ww(s)),r.push(ww(i)),e.push(r),i=n}return e};0;const vw=self.C3,Rw={};vw.Behaviors.Physics.Separator=Rw;const Aw=vw.Behaviors.Physics.GetVec2,Dw=vw.Behaviors.Physics.FreeVec2;Rw.det=function(t,e,s,i,r,n){return t*i+s*n+r*e-e*s-i*r-n*t},Rw.hitRay=function(t,e,s,i,r,n,a,o){const h=s-t,l=i-e,c=a-r,u=o-n,_=(c*(n-e)-u*(r-t))/(l*c-h*u),d=t+_*h,p=e+_*l,f=Rw.isOnSegment(s,i,t,e,d,p),g=Rw.isOnSegment(d,p,r,n,a,o);return f&&g?Aw(d,p):null},Rw.isOnSegment=function(t,e,s,i,r,n){return(s+.1>=t&&t>=r-.1||s-.1<=t&&t<=r+.1)&&(i+.1>=e&&e>=n-.1||i-.1<=e&&e<=n+.1)&&Rw.isOnLine(t,e,s,i,r,n)},Rw.isOnLine=function(t,e,s,i,r,n){if(Math.abs(r-s)>.1){const a=(n-i)/(r-s)*(t-s)+i;return Math.abs(a-e)<.1}return Math.abs(t-s)<.1},Rw.pointsMatch=function(t,e,s,i){return Math.abs(s-t)<.1&&Math.abs(i-e)<.1},Rw.Separate=function(t,e){if(3===t.length)return[t.map(t=>Aw(t.get_x(),t.get_y()))];const s=Rw.calcShapes(t);let i=[];for(let t=0,r=s.length;t<r;++t){const r=s[t],n=[];let a=0;for(let t=0,e=r.length;t<e;++t){const s=r[t],i=r[(t+1)%e];a+=s.get_x()*i.get_y()-s.get_y()*i.get_x(),n.push(Aw(s.get_x(),s.get_y()))}if(a=Math.abs(a/2),a>=.001*e)i.push(n);else for(let t=0,e=n.length;t<e;t++)Dw(n[t])}return i=Mw(i),i},Rw.calcShapes=function(t){let e,s,i,r,n,a,o,h=[],l=0,c=0,u=0,_=0,d=0,p=0,f=0,g=0,m=0,S=0,y=0,G=0,T=0,I=0,C=0,b=[],x=[],w=!1,M=[],P=[],v=!1;for(P.push(t);P.length;){for(h=P[0],c=h.length,w=!0,l=0;l<c;l++)if(m=l,S=l<c-1?l+1:l+1-c,y=l<c-2?l+2:l+2-c,e=h[m],s=h[S],i=h[y],_=Rw.det(e.get_x(),e.get_y(),s.get_x(),s.get_y(),i.get_x(),i.get_y()),_<0){for(w=!1,g=1e9,u=0;u<c;u++)u!==m&&u!==S&&(G=u,T=u<c-1?u+1:0,r=h[G],n=h[T],a=Rw.hitRay(e.get_x(),e.get_y(),s.get_x(),s.get_y(),r.get_x(),r.get_y(),n.get_x(),n.get_y()),a&&(p=s.get_x()-a.get_x(),f=s.get_y()-a.get_y(),d=p*p+f*f,d<g?(C=G,I=T,o=a,g=d):Dw(a)));if(1e9===g)return[];for(b=[],x=[],G=C,T=I,r=h[G],n=h[T],v=!1,Rw.pointsMatch(o.get_x(),o.get_y(),n.get_x(),n.get_y())||(b.push(o),v=!0),Rw.pointsMatch(o.get_x(),o.get_y(),r.get_x(),r.get_y())||(x.push(o),v=!0),v||Dw(o),C=-1,I=m;;){if(I===T){if(C<0||C>=c)return[];Rw.isOnSegment(n.get_x(),n.get_y(),h[C].get_x(),h[C].get_y(),e.get_x(),e.get_y())||b.push(h[I]);break}b.push(h[I]),C=I,I-1<0?I=c-1:I--}for(b.reverse(),C=-1,I=S;;){if(I===G){if(C<0||C>=c)return[];I!==G||Rw.isOnSegment(r.get_x(),r.get_y(),h[C].get_x(),h[C].get_y(),s.get_x(),s.get_y())||x.push(h[I]);break}x.push(h[I]),C=I,I+1>c-1?I=0:I++}P.push(b,x),P.shift();break}w&&M.push(P.shift())}return M}}{const Ew=self.C3;Ew.Behaviors.Fade=class extends Ew.SDKBehaviorBase{constructor(t){super(t)}Release(){super.Release()}}}{const Fw=self.C3;Fw.Behaviors.Fade.Type=class extends Fw.SDKBehaviorTypeBase{constructor(t){super(t)}Release(){super.Release()}OnCreate(){}}}{const Ow=self.C3,Bw=self.C3X,Lw=self.IBehaviorInstance,kw=0,Nw=1,Uw=2,Ww=3,jw=4;Ow.Behaviors.Fade.Instance=class extends Ow.SDKBehaviorInstanceBase{constructor(t,e){super(t),this._fadeInTime=0,this._waitTime=0,this._fadeOutTime=0,this._destroy=!0,this._activeAtStart=!0,this._setMaxOpacity=!1,this._stage=0,this._stageTime=Ow.New(Ow.KahanSum),this._maxOpacity=this._inst.GetWorldInfo().GetOpacity()||1,e&&(this._fadeInTime=e[kw],this._waitTime=e[Nw],this._fadeOutTime=e[Uw],this._destroy=!!e[Ww],this._activeAtStart=!!e[jw],this._stage=this._activeAtStart?0:3),this._activeAtStart&&(0===this._fadeInTime?(this._stage=1,0===this._waitTime&&(this._stage=2)):(this._inst.GetWorldInfo().SetOpacity(0),this._runtime.UpdateRender())),this._StartTicking()}Release(){super.Release()}SaveToJson(){return{fit:this._fadeInTime,wt:this._waitTime,fot:this._fadeOutTime,d:this._destroy,s:this._stage,st:this._stageTime.Get(),mo:this._maxOpacity}}LoadFromJson(t){this._fadeInTime=t.fit,this._waitTime=t.wt,this._fadeOutTime=t.fot,this._destroy=t.d,this._stage=t.s,this._stageTime.Set(t.st),this._maxOpacity=t.mo,3===this._stage?this._StopTicking():this._StartTicking()}Tick(){const t=this._runtime.GetDt(this._inst);this._stageTime.Add(t);const e=this._inst.GetWorldInfo();0===this._stage&&(e.SetOpacity(this._stageTime.Get()/this._fadeInTime*this._maxOpacity),this._runtime.UpdateRender(),e.GetOpacity()>=this._maxOpacity&&(e.SetOpacity(this._maxOpacity),this._stage=1,this._stageTime.Reset(),this.DispatchScriptEvent("fadeinend"),this.Trigger(Ow.Behaviors.Fade.Cnds.OnFadeInEnd))),1===this._stage&&this._stageTime.Get()>=this._waitTime&&(this._stage=2,this._stageTime.Reset(),this.DispatchScriptEvent("waitend"),this.Trigger(Ow.Behaviors.Fade.Cnds.OnWaitEnd)),2===this._stage&&(0!==this._fadeOutTime?(e.SetOpacity(this._maxOpacity-this._stageTime.Get()/this._fadeOutTime*this._maxOpacity),this._runtime.UpdateRender(),e.GetOpacity()<=0&&(this._stage=3,this._stageTime.Reset(),this.DispatchScriptEvent("fadeoutend"),this.Trigger(Ow.Behaviors.Fade.Cnds.OnFadeOutEnd),this._destroy&&this._runtime.DestroyInstance(this._inst))):(this._stage=3,this._stageTime.Reset())),3===this._stage&&this._StopTicking()}_StartFade(){this._activeAtStart||this._setMaxOpacity||(this._maxOpacity=this._inst.GetWorldInfo().GetOpacity()||1,this._setMaxOpacity=!0),3===this._stage&&this.Start()}_RestartFade(){this.Start()}Start(){this._stage=0,this._stageTime.Reset(),0===this._fadeInTime?(this._stage=1,0===this._waitTime&&(this._stage=2)):(this._inst.GetWorldInfo().SetOpacity(0),this._runtime.UpdateRender()),this._StartTicking()}_SetFadeInTime(t){this._fadeInTime=Math.max(t,0)}_GetFadeInTime(){return this._fadeInTime}_SetWaitTime(t){this._waitTime=Math.max(t,0)}_GetWaitTime(){return this._waitTime}_SetFadeOutTime(t){this._fadeOutTime=Math.max(t,0)}_GetFadeOutTime(){return this._fadeOutTime}GetPropertyValueByIndex(t){switch(t){case kw:return this._GetFadeInTime();case Nw:return this._GetWaitTime();case Uw:return this._GetFadeOutTime();case Ww:return this._destroy}}SetPropertyValueByIndex(t,e){switch(t){case kw:this._SetFadeInTime(e);break;case Nw:this._SetWaitTime(e);break;case Uw:this._SetFadeOutTime(e);break;case Ww:this._destroy=!!e}}GetDebuggerProperties(){const t="behaviors.fade";return[{title:"$"+this.GetBehaviorType().GetName(),properties:[{name:t+".properties.fade-in-time.name",value:this._GetFadeInTime(),onedit:t=>this._SetFadeInTime(t)},{name:t+".properties.wait-time.name",value:this._GetWaitTime(),onedit:t=>this._SetWaitTime(t)},{name:t+".properties.fade-out-time.name",value:this._GetFadeOutTime(),onedit:t=>this._SetFadeOutTime(t)},{name:t+".debugger.stage",value:[t+".debugger."+["fade-in","wait","fade-out","done"][this._stage]]}]}]}GetScriptInterfaceClass(){return self.IFadeBehaviorInstance}};const Vw=new WeakMap;self.IFadeBehaviorInstance=class extends Lw{constructor(){super(),Vw.set(this,Lw._GetInitInst().GetSdkInstance())}startFade(){Vw.get(this)._StartFade()}restartFade(){Vw.get(this)._RestartFade()}set fadeInTime(t){Bw.RequireFiniteNumber(t),Vw.get(this)._SetFadeInTime(t)}get fadeInTime(){return Vw.get(this)._GetFadeInTime()}set waitTime(t){Bw.RequireFiniteNumber(t),Vw.get(this)._SetWaitTime(t)}get waitTime(){return Vw.get(this)._GetWaitTime()}set fadeOutTime(t){Bw.RequireFiniteNumber(t),Vw.get(this)._SetFadeOutTime(t)}get fadeOutTime(){return Vw.get(this)._GetFadeOutTime()}}}self.C3.Behaviors.Fade.Cnds={OnFadeOutEnd:()=>!0,OnFadeInEnd:()=>!0,OnWaitEnd:()=>!0},self.C3.Behaviors.Fade.Acts={StartFade(){this._StartFade()},RestartFade(){this._RestartFade()},SetFadeInTime(t){this._SetFadeInTime(t)},SetWaitTime(t){this._SetWaitTime(t)},SetFadeOutTime(t){this._SetFadeOutTime(t)}},self.C3.Behaviors.Fade.Exps={FadeInTime(){return this._GetFadeInTime()},WaitTime(){return this._GetWaitTime()},FadeOutTime(){return this._GetFadeOutTime()}};{const zw=self.C3;zw.Behaviors.scrollto=class extends zw.SDKBehaviorBase{constructor(t){super(t),this._shakeMag=0,this._shakeStart=0,this._shakeEnd=0,this._shakeMode=0}Release(){super.Release()}SetShakeMagnitude(t){this._shakeMag=t}GetShakeMagnitude(){return this._shakeMag}SetShakeStart(t){this._shakeStart=t}GetShakeStart(){return this._shakeStart}SetShakeEnd(t){this._shakeEnd=t}GetShakeEnd(){return this._shakeEnd}SetShakeMode(t){this._shakeMode=t}GetShakeMode(){return this._shakeMode}}}{const Hw=self.C3;Hw.Behaviors.scrollto.Type=class extends Hw.SDKBehaviorTypeBase{constructor(t){super(t)}Release(){super.Release()}OnCreate(){}}}{const Yw=self.C3,Xw=0;Yw.Behaviors.scrollto.Instance=class extends Yw.SDKBehaviorInstanceBase{constructor(t,e){super(t),this._isEnabled=!0,e&&(this._isEnabled=e[Xw]),this._isEnabled&&this._StartTicking2()}Release(){super.Release()}SaveToJson(){const t=this.GetBehavior();return{e:this._isEnabled,smg:t.GetShakeMagnitude(),ss:t.GetShakeStart(),se:t.GetShakeEnd(),smd:t.GetShakeMode()}}LoadFromJson(t){const e=this.GetBehavior();e.SetShakeMagnitude(t.smg),e.SetShakeStart(t.ss),e.SetShakeEnd(t.se),e.SetShakeMode(t.smd),this._isEnabled=t.e,this._isEnabled?this._StartTicking2():this._StopTicking2()}_SetEnabled(t){this._isEnabled=!!t,this._isEnabled?this._StartTicking2():this._StopTicking2()}IsEnabled(){return this._isEnabled}Tick2(){if(!this.IsEnabled())return;this._runtime.GetDt(this._inst);const t=this.GetBehavior(),e=t.GetInstances();let s=0,i=0,r=0;for(const t of e){const e=t.GetBehaviorInstanceFromCtor(Yw.Behaviors.scrollto);if(!e||!e.GetSdkInstance().IsEnabled())continue;const n=t.GetWorldInfo();s+=n.GetX(),i+=n.GetY(),++r}const n=this._inst.GetWorldInfo().GetLayout(),a=this._runtime.GetGameTime();let o=0,h=0;if(a>=t.GetShakeStart()&&a<t.GetShakeEnd()){let e=t.GetShakeMagnitude()*Math.min(this._runtime.GetTimeScale(),1);0===t.GetShakeMode()&&(e*=1-(a-t.GetShakeStart())/(t.GetShakeEnd()-t.GetShakeStart()));const s=this._runtime.Random()*Math.PI*2,i=this._runtime.Random()*e;o=Math.cos(s)*i,h=Math.sin(s)*i}n.SetScrollX(s/r+o),n.SetScrollY(i/r+h)}GetPropertyValueByIndex(t){if(t===Xw)return this._isEnabled}SetPropertyValueByIndex(t,e){t===Xw&&(this._isEnabled=!!e,this._isEnabled?this._StartTicking2():this._StopTicking2())}GetDebuggerProperties(){return[{title:"$"+this.GetBehaviorType().GetName(),properties:[{name:"behaviors.scrollto.properties.enabled.name",value:this.IsEnabled(),onedit:t=>this._SetEnabled(t)}]}]}}}self.C3.Behaviors.scrollto.Cnds={IsEnabled(){return this.IsEnabled()}},self.C3.Behaviors.scrollto.Acts={Shake(t,e,s){const i=this.GetBehavior();i.SetShakeMagnitude(t),i.SetShakeStart(this._runtime.GetGameTime()),i.SetShakeEnd(this._runtime.GetGameTime()+e),i.SetShakeMode(s)},SetEnabled(t){this._SetEnabled(0!==t)}},self.C3.Behaviors.scrollto.Exps={};{const qw=self.C3;qw.Behaviors.Turret=class extends qw.SDKBehaviorBase{constructor(t){super(t)}Release(){super.Release()}}}{const Jw=self.C3;Jw.Behaviors.Turret.Type=class extends Jw.SDKBehaviorTypeBase{constructor(t){super(t),this._targetTypes=[]}Release(){Jw.clearArray(this._targetTypes),super.Release()}OnCreate(){}GetTargetTypes(){return this._targetTypes}}}{const Qw=self.C3,Kw=self.C3X,Zw=self.IBehaviorInstance,$w=0,tM=1,eM=2,sM=3,iM=4,rM=5,nM=6,aM=7,oM=8,hM=Qw.New(Qw.Rect),lM=[];Qw.Behaviors.Turret.Instance=class extends Qw.SDKBehaviorInstanceBase{constructor(t,e){super(t),this._range=300,this._rateOfFire=1,this._isRotateEnabled=!0,this._rotateSpeed=Qw.toRadians(180),this._targetMode=0,this._predictiveAim=!1,this._projectileSpeed=500,this._useCollisionCells=!0,this._isEnabled=!0,this._lastCheckTime=0,this._fireTimeCount=0,this._currentTarget=null,this._loadTargetUid=-1,this._oldTargetX=0,this._oldTargetY=0,e&&(this._range=e[$w],this._rateOfFire=e[tM],this._isRotateEnabled=!!e[eM],this._rotateSpeed=Qw.toRadians(e[sM]),this._targetMode=e[iM],this._predictiveAim=!!e[rM],this._projectileSpeed=e[nM],this._useCollisionCells=!!e[aM],this._isEnabled=!!e[oM]),this._fireTimeCount=this._rateOfFire;const s=this._runtime.Dispatcher();this._disposables=new Qw.CompositeDisposable(Qw.Disposable.From(s,"instancedestroy",t=>this._OnInstanceDestroyed(t.instance)),Qw.Disposable.From(s,"afterload",t=>this._OnAfterLoad())),this._isEnabled&&this._StartTicking()}Release(){this._currentTarget=null,super.Release()}_OnAfterLoad(){-1===this._loadTargetUid?this._currentTarget=null:this._currentTarget=this._runtime.GetInstanceByUID(this._loadTargetUid)}_OnInstanceDestroyed(t){this._currentTarget===t&&(this._currentTarget=null)}_MaybeAcquireTargetInstance(t){return!(this._currentTarget===t||this._inst===t||!this.IsInRange(t)||(this._currentTarget=t,this._OnTargetAcquired(),0))}_UnacquireTarget(){this._currentTarget=null}_SetRange(t){this._range=t}_GetRange(){return this._range}_SetRateOfFire(t){this._rateOfFire=t}_GetRateOfFire(){return this._rateOfFire}_SetRotateEnabled(t){this._isRotateEnabled=!!t}_IsRotateEnabled(){return this._isRotateEnabled}_SetRotateSpeed(t){this._rotateSpeed=t}_GetRotateSpeed(){return this._rotateSpeed}_SetTargetMode(t){this._targetMode=t}_GetTargetMode(){return this._targetMode}_SetPredictiveAim(t){this._predictiveAim=!!t}_IsPredictiveAim(){return this._predictiveAim}_SetProjectileSpeed(t){this._projectileSpeed=t}_GetProjectileSpeed(){return this._projectileSpeed}_SetEnabled(t){this._isEnabled=!!t,this._isEnabled?this._StartTicking():this._StopTicking()}_IsEnabled(){return this._isEnabled}SaveToJson(){return{r:this._range,rof:this._rateOfFire,re:this._isRotateEnabled,rs:this._rotateSpeed,tm:this._targetMode,pa:this._predictiveAim,ps:this._projectileSpeed,ucc:this._useCollisionCells,e:this._isEnabled,ftc:this._fireTimeCount,t:this._currentTarget?this._currentTarget.GetUID():-1,ox:this._oldTargetX,oy:this._oldTargetY,targs:this.GetSdkType().GetTargetTypes().map(t=>t.GetSID())}}LoadFromJson(t){this._range=t.r,this._rateOfFire=t.rof,this._isRotateEnabled=t.re,this._rotateSpeed=t.rs,this._targetMode=t.tm,this._predictiveAim=t.pa,this._projectileSpeed=t.ps,this._useCollisionCells=t.ucc,this._SetEnabled(t.e),this._fireTimeCount=t.ftc,this._loadTargetUid=t.t,this._oldTargetX=t.ox,this._oldTargetY=t.oy,this._lastCheckTime=0;const e=this.GetSdkType().GetTargetTypes();Qw.clearArray(e);for(const s of t.targs){const t=this._runtime.GetObjectClassBySID(s);t&&e.push(t)}}IsInRange(t){const e=this.GetWorldInfo(),s=t.GetWorldInfo(),i=s.GetX()-e.GetX(),r=s.GetY()-e.GetY();return i*i+r*r<=this._range*this._range}LookForFirstTarget(){const t=this.GetWorldInfo(),e=this.GetSdkType().GetTargetTypes(),s=this._runtime.GetCollisionEngine();if(this._useCollisionCells)hM.set(t.GetX()-this._range,t.GetY()-this._range,t.GetX()+this._range,t.GetY()+this._range),s.GetObjectClassesCollisionCandidates(t.GetLayer(),e,hM,lM);else for(const t of e)Qw.appendArray(lM,t.GetInstances());for(const t of lM)if(t!==this._inst&&this.IsInRange(t))return this._currentTarget=t,void Qw.clearArray(lM);Qw.clearArray(lM)}LookForNearestTarget(){const t=this.GetWorldInfo(),e=this.GetSdkType().GetTargetTypes(),s=this._runtime.GetCollisionEngine(),i=t.GetX(),r=t.GetY();let n=this._range*this._range;if(this._currentTarget=null,this._useCollisionCells)hM.set(i-this._range,r-this._range,i+this._range,r+this._range),s.GetObjectClassesCollisionCandidates(t.GetLayer(),e,hM,lM);else for(const t of e)Qw.appendArray(lM,t.GetInstances());for(const t of lM){if(t===this._inst)continue;const e=t.GetWorldInfo(),s=i-e.GetX(),a=r-e.GetY(),o=s*s+a*a;o<n&&(this._currentTarget=t,n=o)}Qw.clearArray(lM)}_OnTargetAcquired(){const t=this._currentTarget.GetWorldInfo();this._oldTargetX=t.GetX(),this._oldTargetY=t.GetY(),this.DispatchScriptEvent("targetacquired",!1,{targetInst:this._currentTarget.GetInterfaceClass()}),this.Trigger(Qw.Behaviors.Turret.Cnds.OnTargetAcquired)}Tick(){if(!this._isEnabled)return;const t=this._runtime.GetDt(this._inst),e=this._runtime.GetGameTime(),s=this.GetWorldInfo();if(this._currentTarget&&!this.IsInRange(this._currentTarget)&&(this._currentTarget=null),e>=this._lastCheckTime+.1)if(this._lastCheckTime=e,0!==this._targetMode||this._currentTarget){if(1===this._targetMode){const t=this._currentTarget;this.LookForNearestTarget(),this._currentTarget&&this._currentTarget!==t&&this._OnTargetAcquired()}}else this.LookForFirstTarget(),this._currentTarget&&this._OnTargetAcquired();if(this._fireTimeCount+=t,this._currentTarget){let e=this._currentTarget.GetWorldInfo();const i=s.GetX(),r=s.GetY(),n=e.GetX(),a=e.GetY(),o=Qw.angleTo(i,r,e.GetX(),e.GetY());let h=0;if(this._predictiveAim){const e=n-i,s=a-r,l=(n-this._oldTargetX)/t,c=(a-this._oldTargetY)/t,u=e*c-s*l,_=Math.asin(Qw.clamp(u/(this._projectileSpeed*Qw.hypot2DFast(e,s)),-1,1))+o;h=(Math.cos(_)*c-Math.sin(_)*l)*u>0?_:o}else h=o;this._isRotateEnabled&&(s.SetAngle(Qw.angleRotate(s.GetAngle(),h,this._rotateSpeed*t)),s.SetBboxChanged()),this._fireTimeCount>=this._rateOfFire&&(!this._isRotateEnabled||Qw.toDegrees(Qw.angleDiff(s.GetAngle(),h))<=.1)&&(this._fireTimeCount-=this._rateOfFire,this._fireTimeCount>=this._rateOfFire&&(this._fireTimeCount=0),this.DispatchScriptEvent("shoot",!1,{targetInst:this._currentTarget.GetInterfaceClass()}),this.Trigger(Qw.Behaviors.Turret.Cnds.OnShoot)),this._currentTarget&&(e=this._currentTarget.GetWorldInfo(),this._oldTargetX=e.GetX(),this._oldTargetY=e.GetY())}this._fireTimeCount>this._rateOfFire&&(this._fireTimeCount=this._rateOfFire)}GetPropertyValueByIndex(t){switch(t){case $w:return this._GetRange();case tM:return this._GetRateOfFire();case eM:return this._IsRotateEnabled();case sM:return Qw.toDegrees(this._GetRotateSpeed());case iM:return this._GetTargetMode();case rM:return this._IsPredictiveAim();case nM:return this._GetProjectileSpeed();case aM:return this._useCollisionCells;case oM:return this._IsEnabled()}}SetPropertyValueByIndex(t,e){switch(t){case $w:this._SetRange(e);break;case tM:this._SetRateOfFire(e);break;case eM:this._SetRotateEnabled(!!e);break;case sM:if(!this._IsRotateEnabled())return;this._SetRotateSpeed(Qw.toRadians(e));break;case iM:this._SetTargetMode(e);break;case rM:this._SetPredictiveAim(!!e);break;case nM:if(!this._IsPredictiveAim())return;this._SetProjectileSpeed(e);break;case aM:this._useCollisionCells=!!e;break;case oM:this._SetEnabled(e)}}GetDebuggerProperties(){const t="behaviors.turret";return[{title:"$"+this.GetBehaviorType().GetName(),properties:[{name:t+".properties.range.name",value:this._GetRange(),onedit:t=>this._SetRange(t)},{name:t+".properties.rate-of-fire.name",value:this._GetRateOfFire(),onedit:t=>this._SetRateOfFire(t)},{name:t+".properties.rotate-speed.name",value:Qw.toDegrees(this._GetRotateSpeed()),onedit:t=>this._SetRotateSpeed(Qw.toRadians(t))},{name:t+".properties.predictive-aim.name",value:this._IsPredictiveAim(),onedit:t=>this._SetPredictiveAim(t)},{name:t+".properties.projectile-speed.name",value:this._GetProjectileSpeed(),onedit:t=>this._SetProjectileSpeed(t)},{name:t+".debugger.has-target",value:!!this._currentTarget},{name:t+".debugger.target-uid",value:this._currentTarget?this._currentTarget.GetUID():0},{name:t+".properties.enabled.name",value:this._IsEnabled(),onedit:t=>this._SetEnabled(t)}]}]}GetScriptInterfaceClass(){return self.ITurretBehaviorInstance}};const cM=new WeakMap,uM=["first","nearest"];self.ITurretBehaviorInstance=class extends Zw{constructor(){super(),cM.set(this,Zw._GetInitInst().GetSdkInstance())}get currentTarget(){const t=cM.get(this)._currentTarget;return t?t.GetInterfaceClass():null}set currentTarget(t){const e=cM.get(this);t?e._MaybeAcquireTargetInstance(e.GetRuntime()._UnwrapIWorldInstance(t)):e._UnacquireTarget()}get range(){return cM.get(this)._GetRange()}set range(t){Kw.RequireFiniteNumber(t),cM.get(this)._SetRange(t)}get rateOfFire(){return cM.get(this)._GetRateOfFire()}set rateOfFire(t){Kw.RequireFiniteNumber(t),cM.get(this)._SetRateOfFire(t)}get isRotateEnabled(){return cM.get(this)._IsRotateEnabled()}set isRotateEnabled(t){cM.get(this)._SetRotateEnabled(!!t)}get rotateSpeed(){return cM.get(this)._GetRotateSpeed()}set rotateSpeed(t){Kw.RequireFiniteNumber(t),cM.get(this)._SetRotateSpeed(t)}get targetMode(){return uM[cM.get(this)._GetTargetMode()]}set targetMode(t){const e=uM.indexOf(t);if(-1===e)throw new Error("invalid targetMode");cM.get(this)._SetTargetMode(e)}get isPredictiveAimEnabled(){return cM.get(this)._IsPredictiveAim()}set isPredictiveAimEnabled(t){cM.get(this)._SetPredictiveAim(!!t)}get projectileSpeed(){return cM.get(this)._GetProjectileSpeed()}set projectileSpeed(t){Kw.RequireFiniteNumber(t),cM.get(this)._SetProjectileSpeed(t)}get isEnabled(){return cM.get(this)._IsEnabled()}set isEnabled(t){cM.get(this)._SetEnabled(t)}}}self.C3.Behaviors.Turret.Cnds={HasTarget(){return!!this._currentTarget},OnShoot:()=>!0,OnTargetAcquired:()=>!0,IsEnabled(){return this._IsEnabled()}};{const _M=self.C3;_M.Behaviors.Turret.Acts={AcquireTarget(t){if(!t)return;const e=t.GetCurrentSol().GetInstances();for(const t of e)if(this._MaybeAcquireTargetInstance(t))break},AddTarget(t){const e=this.GetSdkType().GetTargetTypes();if(!e.includes(t)){for(const s of e)if(s.IsFamily()&&s.FamilyHasMember(t))return;e.push(t)}},ClearTargets(){_M.clearArray(this.GetSdkType().GetTargetTypes())},UnacquireTarget(){this._UnacquireTarget()},SetEnabled(t){this._SetEnabled(0!==t)},SetRange(t){this._SetRange(t)},SetRateOfFire(t){this._SetRateOfFire(t)},SetRotate(t){this._SetRotateEnabled(0!==t)},SetRotateSpeed(t){this._SetRotateSpeed(_M.toRadians(t))},SetTargetMode(t){this._SetTargetMode(t)},SetPredictiveAim(t){this._SetPredictiveAim(0!==t)},SetProjectileSpeed(t){this._SetProjectileSpeed(t)}}}{const dM=self.C3;dM.Behaviors.Turret.Exps={TargetUID(){return this._currentTarget?this._currentTarget.GetUID():0},Range(){return this._GetRange()},RateOfFire(){return this._GetRateOfFire()},RotateSpeed(){return dM.toDegrees(this._GetRotateSpeed())}}}{const pM=self.C3;pM.Behaviors.Bullet=class extends pM.SDKBehaviorBase{constructor(t){super(t)}Release(){super.Release()}}}{const fM=self.C3;fM.Behaviors.Bullet.Type=class extends fM.SDKBehaviorTypeBase{constructor(t){super(t)}Release(){super.Release()}OnCreate(){}}}{const gM=self.C3,mM=self.C3X,SM=self.IBehaviorInstance,yM=0,GM=1,TM=2,IM=3,CM=4,bM=5,xM=6;gM.Behaviors.Bullet.Instance=class extends gM.SDKBehaviorInstanceBase{constructor(t,e){super(t);const s=this.GetWorldInfo();this._speed=0,this._acc=0,this._g=0,this._bounceOffSolid=!1,this._setAngle=!1,this._isStepping=!1,this._isEnabled=!0,this._dx=0,this._dy=0,this._lastX=s.GetX(),this._lastY=s.GetY(),this._lastKnownAngle=s.GetAngle(),this._travelled=0,this._stepSize=Math.min(Math.abs(s.GetWidth()),Math.abs(s.GetHeight())/2),this._stopStepping=!1,e&&(this._speed=e[yM],this._acc=e[GM],this._g=e[TM],this._bounceOffSolid=!!e[IM],this._setAngle=!!e[CM],this._isStepping=!!e[bM],this._isEnabled=!!e[xM]);const i=s.GetAngle();this._dx=Math.cos(i)*this._speed,this._dy=Math.sin(i)*this._speed,this._isEnabled&&(this._StartTicking(),this._bounceOffSolid&&this._StartPostTicking())}Release(){super.Release()}SaveToJson(){const t={dx:this._dx,dy:this._dy,lx:this._lastX,ly:this._lastY,lka:this._lastKnownAngle,t:this._travelled};return 0!==this._acc&&(t.acc=this._acc),0!==this._g&&(t.g=this._g),this._isStepping&&(t.st=this._isStepping),this._isEnabled||(t.e=this._isEnabled),this._bounceOffSolid&&(t.bos=this._bounceOffSolid),this._setAngle&&(t.sa=this._setAngle),t}LoadFromJson(t){this._dx=t.dx,this._dy=t.dy,this._lastX=t.lx,this._lastY=t.ly,this._lastKnownAngle=t.lka,this._travelled=t.t,this._acc=t.hasOwnProperty("acc")?t.acc:0,this._g=t.hasOwnProperty("g")?t.g:0,this._isStepping=!!t.hasOwnProperty("st")&&t.st,this._bounceOffSolid=!!t.hasOwnProperty("bos")&&t.bos,this._setAngle=!!t.hasOwnProperty("sa")&&t.sa,this._SetEnabled(!t.hasOwnProperty("e")||t.e)}Tick(){if(!this._isEnabled)return;const t=this._runtime.GetDt(this._inst),e=this._inst.GetWorldInfo();if(e.GetAngle()!==this._lastKnownAngle){const t=e.GetAngle();if(this._setAngle){const e=gM.distanceTo(0,0,this._dx,this._dy);this._dx=Math.cos(t)*e,this._dy=Math.sin(t)*e}this._lastKnownAngle=t}let s=0,i=0;if(0!==this._acc){let r=gM.distanceTo(0,0,this._dx,this._dy),n=0;n=0===this._dx&&0===this._dy?e.GetAngle():gM.angleTo(0,0,this._dx,this._dy),r+=this._acc*t,s=Math.cos(n)*this._acc,i=Math.sin(n)*this._acc,r<0&&(r=0,s=0,i=0),this._dx=Math.cos(n)*r,this._dy=Math.sin(n)*r}if(0!==this._g&&(this._dy+=this._g*t,i+=this._g),this._lastX=e.GetX(),this._lastY=e.GetY(),0!==this._dx||0!==this._dy){const r=this._dx*t+.5*s*t*t,n=this._dy*t+.5*i*t*t,a=gM.distanceTo(0,0,r,n);if(this._MoveBy(r,n,a),this._travelled+=a,this._setAngle&&(0!==r||0!==n)){const t=gM.angleTo(0,0,r,n);e.SetAngle(t),this._lastKnownAngle=e.GetAngle()}e.SetBboxChanged()}}_MoveBy(t,e,s){const i=this.GetWorldInfo();if(!this._isStepping||s<=this._stepSize)return i.OffsetXY(t,e),i.SetBboxChanged(),void(this._isStepping&&this.Trigger(gM.Behaviors.Bullet.Cnds.OnStep));this._stopStepping=!1;const r=i.GetX(),n=i.GetY(),a=r+t,o=n+e,h=gM.angleTo(0,0,t,e),l=Math.cos(h)*this._stepSize,c=Math.sin(h)*this._stepSize,u=Math.floor(s/this._stepSize);for(let t=1;t<=u;++t)if(i.SetXY(r+l*t,n+c*t),i.SetBboxChanged(),this.Trigger(gM.Behaviors.Bullet.Cnds.OnStep),this._inst.IsDestroyed()||this._stopStepping)return;i.SetXY(a,o),i.SetBboxChanged(),this.Trigger(gM.Behaviors.Bullet.Cnds.OnStep)}PostTick(){if(!this._isEnabled||!this._bounceOffSolid||0===this._dx&&0===this._dy)return;const t=this._runtime.GetDt(this._inst),e=this._inst.GetWorldInfo(),s=this._runtime.GetCollisionEngine(),i=s.TestOverlapSolid(this._inst);if(i){s.RegisterCollision(this._inst,i);const r=gM.distanceTo(0,0,this._dx,this._dy),n=s.CalculateBounceAngle(this._inst,this._lastX,this._lastY);this._dx=Math.cos(n)*r,this._dy=Math.sin(n)*r,e.OffsetXY(this._dx*t,this._dy*t),e.SetBboxChanged(),this._setAngle&&(e.SetAngle(n),this._lastKnownAngle=e.GetAngle(),e.SetBboxChanged()),s.PushOutSolid(this._inst,this._dx/r,this._dy/r,Math.max(2.5*r*t,30))||s.PushOutSolidNearest(this._inst,100)}}GetPropertyValueByIndex(t){switch(t){case yM:return this._GetSpeed();case GM:return this._GetAcceleration();case TM:return this._GetGravity();case CM:return this._setAngle;case bM:return this._isStepping;case xM:return this._IsEnabled()}}SetPropertyValueByIndex(t,e){switch(t){case yM:this._SetSpeed(e);break;case GM:this._acc=e;break;case TM:this._g=e;break;case CM:this._setAngle=!!e;break;case bM:this._isStepping=!!e;break;case xM:this._SetEnabled(!!e)}}_SetSpeed(t){const e=gM.angleTo(0,0,this._dx,this._dy);this._dx=Math.cos(e)*t,this._dy=Math.sin(e)*t}_GetSpeed(){return gM.roundToDp(gM.distanceTo(0,0,this._dx,this._dy),6)}_SetAcceleration(t){this._acc=t}_GetAcceleration(){return this._acc}_SetGravity(t){this._g=t}_GetGravity(){return this._g}_SetAngleOfMotion(t){const e=gM.distanceTo(0,0,this._dx,this._dy);this._dx=Math.cos(t)*e,this._dy=Math.sin(t)*e}_GetAngleOfMotion(){return gM.angleTo(0,0,this._dx,this._dy)}_SetBounceOffSolids(t){t=!!t,this._bounceOffSolid!==t&&(this._bounceOffSolid=t,this._isEnabled&&(this._bounceOffSolid?this._StartPostTicking():this._StopPostTicking()))}_IsBounceOffSolids(){return this._bounceOffSolid}_SetDistanceTravelled(t){this._travelled=t}_GetDistanceTravelled(){return this._travelled}_SetEnabled(t){this._isEnabled=!!t,this._isEnabled?(this._StartTicking(),this._bounceOffSolid&&this._StartPostTicking()):(this._StopTicking(),this._StopPostTicking())}_IsEnabled(){return this._isEnabled}GetDebuggerProperties(){const t="behaviors.bullet";return[{title:"$"+this.GetBehaviorType().GetName(),properties:[{name:t+".debugger.vector-x",value:this._dx,onedit:t=>this._dx=t},{name:t+".debugger.vector-y",value:this._dy,onedit:t=>this._dy=t},{name:t+".properties.speed.name",value:this._GetSpeed(),onedit:t=>this._SetSpeed(t)},{name:t+".debugger.angle-of-motion",value:gM.toDegrees(this._GetAngleOfMotion())},{name:t+".properties.gravity.name",value:this._GetGravity(),onedit:t=>this._SetGravity(t)},{name:t+".properties.acceleration.name",value:this._GetAcceleration(),onedit:t=>this._SetAcceleration(t)},{name:t+".debugger.distance-travelled",value:this._GetDistanceTravelled()},{name:t+".properties.enabled.name",value:this._IsEnabled(),onedit:t=>this._SetEnabled(t)}]}]}GetScriptInterfaceClass(){return self.IBulletBehaviorInstance}};const wM=new WeakMap;self.IBulletBehaviorInstance=class extends SM{constructor(){super(),wM.set(this,SM._GetInitInst().GetSdkInstance())}get speed(){return wM.get(this)._GetSpeed()}set speed(t){mM.RequireFiniteNumber(t),wM.get(this)._SetSpeed(t)}get acceleration(){return wM.get(this)._GetAcceleration()}set acceleration(t){mM.RequireFiniteNumber(t),wM.get(this)._SetAcceleration(t)}get gravity(){return wM.get(this)._GetGravity()}set gravity(t){mM.RequireFiniteNumber(t),wM.get(this)._SetGravity(t)}get angleOfMotion(){return wM.get(this)._GetAngleOfMotion()}set angleOfMotion(t){mM.RequireFiniteNumber(t),wM.get(this)._SetAngleOfMotion(t)}get bounceOffSolids(){return wM.get(this)._IsBounceOffSolids()}set bounceOffSolids(t){wM.get(this)._SetBounceOffSolids(!!t)}get distanceTravelled(){return wM.get(this)._GetDistanceTravelled()}set distanceTravelled(t){mM.RequireFiniteNumber(t),wM.get(this)._SetDistanceTravelled(t)}get isEnabled(){return wM.get(this)._IsEnabled()}set isEnabled(t){wM.get(this)._SetEnabled(t)}}}{const MM=self.C3;MM.Behaviors.Bullet.Cnds={CompareSpeed(t,e){const s=Math.hypot(this._dx,this._dy);return MM.compare(s,t,e)},CompareTravelled(t,e){return MM.compare(this._GetDistanceTravelled(),t,e)},OnStep:()=>!0,IsEnabled(){return this._IsEnabled()}}}{const PM=self.C3;PM.Behaviors.Bullet.Acts={SetSpeed(t){this._SetSpeed(t)},SetAcceleration(t){this._SetAcceleration(t)},SetGravity(t){this._SetGravity(t)},SetAngleOfMotion(t){this._SetAngleOfMotion(PM.toRadians(t))},Bounce(t){if(!t)return;const e=t.GetFirstPicked(this._inst);if(!e)return;const s=this._inst.GetWorldInfo(),i=this._runtime.GetCollisionEngine(),r=this._runtime.GetDt(this._inst),n=PM.distanceTo(0,0,this._dx,this._dy),a=i.CalculateBounceAngle(this._inst,this._lastX,this._lastY,e);this._dx=Math.cos(a)*n,this._dy=Math.sin(a)*n,s.OffsetXY(this._dx*r,this._dy*r),s.SetBboxChanged(),this._setAngle&&(s.SetAngle(a),this._lastKnownAngle=s.GetAngle(),s.SetBboxChanged()),0!==n&&(this._bounceOffSolid?i.PushOutSolid(this._inst,this._dx/n,this._dy/n,Math.max(2.5*n*r,30))||i.PushOutSolidNearest(this._inst,100):i.PushOut(this._inst,this._dx/n,this._dy/n,Math.max(2.5*n*r,30),e))},SetBounceOffSolids(t){this._SetBounceOffSolids(t)},SetDistanceTravelled(t){this._SetDistanceTravelled(t)},SetEnabled(t){this._SetEnabled(t)},StopStepping(){this._stopStepping=!0}}}{const vM=self.C3;vM.Behaviors.Bullet.Exps={Speed(){return this._GetSpeed()},Acceleration(){return this._GetAcceleration()},AngleOfMotion(){return vM.toDegrees(this._GetAngleOfMotion())},DistanceTravelled(){return this._GetDistanceTravelled()},Gravity(){return this._GetGravity()}}}{let RM=function(t,e){return"number"==typeof t&&"number"==typeof e},AM=function(t,e){return RM(t,e)?t+e:t},DM=function(t,e){return RM(t,e)?t-e:t},EM=function(t,e){return RM(t,e)?t*e:t},FM=function(t,e){return RM(t,e)?t/e:t},OM=function(t,e){return RM(t,e)?t%e:t},BM=function(t,e){return RM(t,e)?Math.pow(t,e):t},LM=function(t,e){if("string"==typeof t||"string"==typeof e){let s,i;return s="number"==typeof t?(Math.round(1e10*t)/1e10).toString():t,i="number"==typeof e?(Math.round(1e10*e)/1e10).toString():e,s+i}return t&&e?1:0},kM=function(t,e){return RM(t,e)?t||e?1:0:t};0;const NM=self.C3;self.C3_ExpressionFuncs=[()=>"GUI",()=>0,()=>"GUI2",()=>"",t=>{const e=t._GetNode(0).GetBoundMethod();return()=>e(0)},()=>100,t=>{const e=t._GetNode(0);return()=>e.ExpObject()},t=>{const e=t._GetNode(0).GetBoundMethod();return()=>e(0,360)},()=>1,t=>{const e=t._GetNode(0).GetBoundMethod();return()=>"victory"===e()?1:0},()=>151,()=>44,()=>24,()=>25,t=>{const e=t._GetNode(0).GetBoundMethod();return()=>"menu"===e()?1:0},()=>150,()=>125,()=>40,()=>95,()=>10,t=>{const e=t._GetNode(0).GetBoundMethod();return()=>e(0)-50},()=>-100,()=>20,()=>1950,()=>1085,t=>{const e=t._GetNode(0),s=t._GetNode(1);return()=>NM.lerp(e.ExpObject(),1.15*s.ExpInstVar_Family(),.4)},t=>{const e=t._GetNode(0),s=t._GetNode(1);return()=>NM.lerp(e.ExpObject(),1*s.ExpInstVar_Family(),.4)},t=>{const e=t._GetNode(0),s=t._GetNode(1).GetBoundMethod();return()=>e.ExpObject()>s("GUI2")?1:0},()=>"coveringWholeScreen",t=>{const e=t._GetNode(0),s=t._GetNode(1),i=t._GetNode(2).GetBoundMethod();return()=>NM.lerp(e.ExpObject(),s.ExpInstVar(),1-Math.exp(-11.9*i()))},t=>{const e=t._GetNode(0).GetBoundMethod(),s=t._GetNode(1).GetVar();return()=>e(s.GetValue(),2)},t=>{const e=t._GetNode(0).GetBoundMethod();return()=>e()},t=>{const e=t._GetNode(0).GetBoundMethod();return()=>e(0,0,0,0)},t=>{const e=t._GetNode(0).GetVar(),s=t._GetNode(1).GetBoundMethod();return()=>NM.lerp(e.GetValue(),100,1-Math.exp(-2.4*s()))},t=>{const e=t._GetNode(0).GetVar();return()=>e.GetValue()},t=>{const e=t._GetNode(0).GetBoundMethod(),s=t._GetNode(1),i=t._GetNode(2);return()=>e(0,"GUI",s.ExpObject(),i.ExpObject())},t=>{const e=t._GetNode(0).GetBoundMethod(),s=t._GetNode(1),i=t._GetNode(2).GetVar(),r=t._GetNode(3).GetBoundMethod(),n=t._GetNode(4);return()=>e(0,"GUI",s.ExpObject()-(i.GetValue()-r()),n.ExpObject())},t=>{const e=t._GetNode(0).GetBoundMethod(),s=t._GetNode(1),i=t._GetNode(2),r=t._GetNode(3).GetVar(),n=t._GetNode(4).GetBoundMethod();return()=>e(0,"GUI",s.ExpObject(),i.ExpObject()-(r.GetValue()-n()))},t=>{const e=t._GetNode(0).GetBoundMethod();return()=>e(255,255,255,20)},()=>15,t=>{const e=t._GetNode(0).GetVar(),s=t._GetNode(1).GetBoundMethod(),i=t._GetNode(2).GetVar();return()=>(e.GetValue()-s())*i.GetValue()},()=>-10,t=>{const e=t._GetNode(0).GetVar();return()=>e.GetValue()+1},()=>"level1",()=>"level",()=>"instructions",()=>"same",()=>"menu",()=>"next",t=>{const e=t._GetNode(0).GetBoundMethod(),s=t._GetNode(1).GetBoundMethod(),i=t._GetNode(2).GetVar(),r=t._GetNode(3).GetBoundMethod(),n=t._GetNode(4).GetBoundMethod(),a=t._GetNode(5).GetVar(),o=t._GetNode(6).GetBoundMethod(),h=t._GetNode(7).GetBoundMethod(),l=t._GetNode(8).GetVar(),c=t._GetNode(9).GetBoundMethod(),u=t._GetNode(10).GetVar();return()=>e(LM("0",Math.floor((s()-i.GetValue())/60)),2)+":"+r(LM("0",Math.floor((n()-a.GetValue())%60)),2)+"."+o(LM("0",Math.floor(100*(h()-l.GetValue()-Math.floor(c()-u.GetValue())))),2)},()=>"overlays",t=>{const e=t._GetNode(0);return()=>e.ExpObject()<1?1:0},t=>{const e=t._GetNode(0).GetVar();return()=>e.GetValue()-1},()=>500,()=>-1e3,()=>1e3,()=>.4,()=>32,()=>.3,t=>{const e=t._GetNode(0).GetVar();return()=>e.GetValue()<1?1:0},()=>"lose",t=>{const e=t._GetNode(0).GetBoundMethod();return()=>e(0)/2},t=>{const e=t._GetNode(0);return()=>.9*e.ExpObject()},t=>{const e=t._GetNode(0).GetVar(),s=t._GetNode(1).GetVar(),i=t._GetNode(2);return()=>LM(LM(LM("paused: ",e.GetValue())+" won: ",s.GetValue())+" balls: ",i.ExpObject())},()=>"bounce2",t=>{const e=t._GetNode(0).GetBoundMethod();return()=>-e(0)-100},t=>{const e=t._GetNode(0).GetVar();return()=>"next"===e.GetValue()?1:0},()=>.04,t=>{const e=t._GetNode(0);return()=>e.ExpObject()+100},t=>{const e=t._GetNode(0);return()=>e.ExpObject()+45},t=>{const e=t._GetNode(0).GetVar(),s=t._GetNode(1).GetVar();return()=>e.GetValue()/s.GetValue()},t=>{const e=t._GetNode(0),s=t._GetNode(1).GetVar();return()=>NM.lerp(e.ExpObject(),s.GetValue(),.05)},t=>{const e=t._GetNode(0),s=t._GetNode(1).GetVar(),i=t._GetNode(2);return()=>NM.lerp(e.ExpObject(),s.GetValue(),.05)+i.ExpInstVar()},t=>{const e=t._GetNode(0).GetVar();return()=>e.GetValue().toString()},t=>{const e=t._GetNode(0).GetVar();return()=>"menu"===e.GetValue()?1:0},t=>{const e=t._GetNode(0).GetVar();return()=>e.GetValue()>10?1:0},t=>{const e=t._GetNode(0).GetVar();return()=>e.GetValue()>3?1:0},()=>.05,()=>700,t=>{const e=t._GetNode(0);return()=>e.ExpBehavior()},()=>"victory",t=>{const e=t._GetNode(0),s=t._GetNode(1);return()=>e.ExpObject()<s.ExpObject()-15?1:0},t=>{const e=t._GetNode(0),s=t._GetNode(1);return()=>e.ExpObject()>s.ExpObject()?1:0},()=>5,()=>"5/5",()=>"Golden ball unlocked",()=>1925,t=>{const e=t._GetNode(0);return()=>e.ExpObject()+150},t=>{const e=t._GetNode(0);return()=>e.ExpObject()+255},t=>{const e=t._GetNode(0);return()=>e.ExpObject()-75},t=>{const e=t._GetNode(0);return()=>e.ExpObject()-120},()=>48,t=>{const e=t._GetNode(0);return()=>e.ExpObject()+10},t=>{const e=t._GetNode(0).GetBoundMethod();return()=>"lose"===e()?1:0},()=>960,()=>540,()=>.7,t=>{const e=t._GetNode(0);return()=>e.ExpObject()-150},t=>{const e=t._GetNode(0);return()=>NM.lerp(e.ExpObject(),100,.1)},t=>{const e=t._GetNode(0).GetBoundMethod();return()=>e("GUI")-67},()=>67,t=>{const e=t._GetNode(0).GetBoundMethod();return()=>e("GUI")-67-100.5-10},t=>{const e=t._GetNode(0).GetVar();return()=>e.GetValue()>0?1:0},()=>"BOSS",t=>{const e=t._GetNode(0);return()=>e.ExpObject()-3},()=>6e3]}var wt=self.C3;self.C3_GetObjectRefTable=function(){return[wt.Plugins.Sprite,wt.Behaviors.Physics,wt.Plugins.Mouse,wt.Plugins.DrawingCanvas,wt.Plugins.NinePatch,wt.Behaviors.Fade,wt.Plugins.Text,wt.Behaviors.scrollto,wt.Plugins.Particles,wt.Plugins.Audio,wt.Plugins.Button,wt.Plugins.Keyboard,wt.Behaviors.Turret,wt.Behaviors.Bullet,wt.Plugins.System.Cnds.OnLayoutStart,wt.Plugins.System.Acts.AddLayer,wt.Plugins.System.Acts.SetLayerParallax,wt.Plugins.Sprite.Acts.SetVisible,wt.Plugins.System.Acts.CreateObject,wt.Plugins.Sprite.Acts.SetSize,wt.Plugins.System.Exps.viewportwidth,wt.Plugins.System.Exps.viewportheight,wt.Behaviors.Physics.Acts.SetWorldGravity,wt.Plugins.Sprite.Acts.SetInstanceVar,wt.Plugins.Sprite.Exps.Width,wt.Plugins.System.Acts.SetBoolVar,wt.Plugins.Text.Acts.SetVisible,wt.Plugins.System.Acts.SetVar,wt.Behaviors.Physics.Acts.EnableCollisions,wt.Plugins.Sprite.Acts.SetAngle,wt.Plugins.System.Exps.random,wt.JavaScriptInEvents.Main_Event1_Act24,wt.Plugins.System.Cnds.CompareBoolVar,wt.Plugins.Sprite.Acts.SetAnimFrame,wt.Plugins.System.Cnds.EvaluateExpression,wt.Plugins.System.Exps.layoutname,wt.Plugins.DrawingCanvas.Acts.SetSize,wt.Plugins.System.Cnds.EveryTick,wt.Plugins.Sprite.Cnds.IsBoolInstanceVarSet,wt.Plugins.Sprite.Exps.Height,wt.Plugins.Sprite.Exps.BBoxRight,wt.Plugins.System.Acts.Signal,wt.Plugins.Sprite.Acts.SetX,wt.Plugins.Sprite.Exps.X,wt.Plugins.System.Exps.dt,wt.Plugins.Text.Acts.SetText,wt.Plugins.System.Exps.zeropad,wt.Plugins.Mouse.Cnds.OnClick,wt.Plugins.Mouse.Cnds.IsOverObject,wt.Plugins.Mouse.Exps.X,wt.Plugins.Mouse.Exps.Y,wt.Behaviors.Physics.Acts.SetLinearDamping,wt.Plugins.Mouse.Cnds.IsButtonDown,wt.Plugins.DrawingCanvas.Acts.ClearCanvas,wt.Plugins.System.Exps.rgba,wt.Plugins.Sprite.Acts.SetOpacity,wt.Plugins.System.Cnds.ForEach,wt.Plugins.DrawingCanvas.Acts.Line,wt.Plugins.System.Exps.layertolayerx,wt.Plugins.Sprite.Exps.Y,wt.Plugins.System.Exps.layertolayery,wt.Plugins.Mouse.Cnds.OnRelease,wt.Behaviors.Physics.Acts.ApplyImpulse,wt.Plugins.Audio.Acts.Play,wt.Plugins.System.Cnds.Compare,wt.Plugins.System.Exps.time,wt.Plugins.Sprite.Acts.SetBoolInstanceVar,wt.Plugins.System.Exps.right,wt.Plugins.Sprite.Cnds.OnCreated,wt.Plugins.Sprite.Acts.MoveToLayer,wt.Plugins.Sprite.Cnds.OnCollision,wt.Plugins.Sprite.Acts.Destroy,wt.Plugins.Sprite.Exps.Count,wt.Plugins.System.Cnds.TriggerOnce,wt.Plugins.Particles.Cnds.OnCreated,wt.Plugins.Particles.Acts.SetInitSpeed,wt.Plugins.Particles.Acts.SetOpacity,wt.Plugins.Particles.Acts.SetGrowRate,wt.Plugins.Particles.Acts.SetParticleAcc,wt.Plugins.Particles.Acts.SetSpeedRandomiser,wt.Plugins.Particles.Acts.SetTimeout,wt.Plugins.Particles.Acts.SetInitSize,wt.Plugins.Sprite.Acts.SetPosToObject,wt.Plugins.System.Acts.Wait,wt.Plugins.System.Cnds.Else,wt.Plugins.Text.Acts.SetPos,wt.Plugins.Text.Acts.MoveToLayer,wt.Plugins.Text.Exps.X,wt.Plugins.Text.Exps.Y,wt.Plugins.Sprite.Acts.SetPos,wt.Plugins.Text.Exps.BBoxLeft,wt.Plugins.Text.Exps.BBoxTop,wt.Plugins.Text.Exps.Width,wt.Plugins.Text.Exps.Height,wt.Plugins.Text.Acts.MoveToTop,wt.Plugins.Text.Acts.SetOpacity,wt.Plugins.Text.Exps.Opacity,wt.Plugins.Text.Cnds.IsVisible,wt.Behaviors.Physics.Cnds.CompareVelocity,wt.Plugins.Audio.Acts.PlayByName,wt.JavaScriptInEvents.Main_Event41_Act1,wt.JavaScriptInEvents.Main_Event41_Act2,wt.JavaScriptInEvents.Main_Event42_Act1,wt.JavaScriptInEvents.Main_Event42_Act2,wt.Plugins.Sprite.Acts.MoveToTop,wt.Plugins.System.Acts.WaitForSignal,wt.Plugins.System.Acts.NextPrevLayout,wt.Plugins.System.Acts.GoToLayoutByName,wt.Plugins.Keyboard.Cnds.OnKeyReleased,wt.Behaviors.Physics.Cnds.IsEnabled,wt.Behaviors.Physics.Acts.Teleport,wt.Plugins.NinePatch.Exps.X,wt.Plugins.NinePatch.Exps.Y,wt.Plugins.System.Acts.AddVar,wt.Plugins.Sprite.Cnds.IsVisible,wt.Plugins.Audio.Cnds.IsAnyPlaying,wt.Plugins.System.Cnds.CompareVar,wt.Plugins.Audio.Acts.StopAll,wt.Plugins.System.Acts.SetLayerVisible,wt.Plugins.Mouse.Cnds.OnObjectClicked,wt.Plugins.System.Acts.GoToLayout,wt.Plugins.NinePatch.Acts.RotateClockwise,wt.Plugins.Button.Cnds.OnClicked,wt.Plugins.Button.Acts.SetVisible,wt.JavaScriptInEvents.Instruct_Event5_Act2,wt.JavaScriptInEvents.Instruct_Event5_Act3,wt.Plugins.Text.Acts.Destroy,wt.Plugins.Sprite.Cnds.IsOverlapping,wt.Behaviors.Physics.Acts.SetVelocity,wt.Behaviors.Physics.Exps.VelocityY,wt.Plugins.Sprite.Exps.BBoxLeft,wt.Plugins.Audio.Acts.FadeVolume,wt.Plugins.Text.Cnds.CompareText,wt.JavaScriptInEvents.Victory_Event8_Act2,wt.Plugins.Text.Acts.SetFontSize,wt.Plugins.Sprite.Acts.SetScale,wt.Plugins.Sprite.Exps.Opacity,wt.Plugins.System.Acts.SetLayerScale,wt.Behaviors.Turret.Acts.AddTarget,wt.Behaviors.Turret.Acts.SetEnabled,wt.Behaviors.Turret.Acts.SetRotate,wt.Plugins.Sprite.Cnds.HasTags,wt.Plugins.Sprite.Cnds.IsOverlappingOffset,wt.Behaviors.Turret.Cnds.OnShoot,wt.Plugins.Sprite.Acts.Spawn]},self.C3_JsPropNameTable=[{Background:0},{Physics:0},{obj_coll:0},{dummy:0},{obj_ball:0},{Mouse:0},{hovered:0},{originalSize:0},{obj_playbutton:0},{obj_instructionsbutton:0},{ballLineCanvas:0},{obj_sepia_overlay:0},{BackgroundLevel:0},{Flag:0},{obj_wall:0},{Fade:0},{obj_level_complete:0},{targetX:0},{obj_full_background:0},{text_stopwatch:0},{obj_level_end_background:0},{buttonRestart:0},{buttonNext:0},{buttonMenu:0},{text_moves:0},{lvlbackground9patch:0},{offsetY:0},{ScrollTo:0},{obj_ball_follower:0},{obj_death:0},{ball_die_particles:0},{obj_bounce:0},{text_title:0},{obj_text_background:0},{text_debug:0},{Audio:0},{Text_ta_xi_haga:0},{sprexplain:0},{redGUI:0},{instructionsBack:0},{id:0},{Coin:0},{CoinText:0},{coinGUI:0},{Text:0},{ResetProgress:0},{obj_rock:0},{VictoryBack:0},{golden_ball_text:0},{credits:0},{slowBallDownVictoryTrigger:0},{lives_text:0},{heartGUI:0},{Keyboard:0},{thingybingy:0},{Turret:0},{Bullet:0},{triggeroflevel5:0},{Text3:0},{ls:0},{ls2:0},{ls3:0},{ls4:0},{fam_buttons:0},{fam_overlay:0},{startMouseX:0},{startMouseY:0},{opacityOfOverlaySepia:0},{startedDragOnValidArea:0},{allowedToShoot:0},{transitioningFullOverlay:0},{paused:0},{moves:0},{layoutToTransitionTo:0},{levelStartTime:0},{won:0},{fadeOutTitle:0},{powerFactor:0},{CoinsCollected:0},{userInputEnabled:0},{lives:0},{is_golden_ball:0},{layoutToGoToName:0},{sumX:0},{sumY:0},{count:0},{targetY:0},{song:0},{songSpesify:0},{instructionSlideNum:0}],self.InstanceType={Background:class extends self.ISpriteInstance{},obj_coll:class extends self.ISpriteInstance{},obj_ball:class extends self.ISpriteInstance{},Mouse:class extends self.IInstance{},obj_playbutton:class extends self.ISpriteInstance{},obj_instructionsbutton:class extends self.ISpriteInstance{},ballLineCanvas:class extends self.IDrawingCanvasInstance{},obj_sepia_overlay:class extends self.ISpriteInstance{},BackgroundLevel:class extends self.ISpriteInstance{},Flag:class extends self.ISpriteInstance{},obj_wall:class extends self.I9PatchInstance{},obj_level_complete:class extends self.ISpriteInstance{},obj_full_background:class extends self.ISpriteInstance{},text_stopwatch:class extends self.ITextInstance{},obj_level_end_background:class extends self.ISpriteInstance{},buttonRestart:class extends self.ISpriteInstance{},buttonNext:class extends self.ISpriteInstance{},buttonMenu:class extends self.ISpriteInstance{},text_moves:class extends self.ITextInstance{},lvlbackground9patch:class extends self.I9PatchInstance{},obj_ball_follower:class extends self.ISpriteInstance{},obj_death:class extends self.ISpriteInstance{},ball_die_particles:class extends self.IParticlesInstance{},obj_bounce:class extends self.I9PatchInstance{},text_title:class extends self.ITextInstance{},obj_text_background:class extends self.ISpriteInstance{},text_debug:class extends self.ITextInstance{},Audio:class extends self.IInstance{},Text_ta_xi_haga:class extends self.ITextInstance{},sprexplain:class extends self.ISpriteInstance{},redGUI:class extends self.ISpriteInstance{},instructionsBack:class extends self.I9PatchInstance{},Coin:class extends self.ISpriteInstance{},CoinText:class extends self.ITextInstance{},coinGUI:class extends self.ISpriteInstance{},Text:class extends self.ITextInstance{},ResetProgress:class extends self.IButtonInstance{},obj_rock:class extends self.ISpriteInstance{},VictoryBack:class extends self.ISpriteInstance{},golden_ball_text:class extends self.ITextInstance{},credits:class extends self.ISpriteInstance{},slowBallDownVictoryTrigger:class extends self.ISpriteInstance{},lives_text:class extends self.ITextInstance{},heartGUI:class extends self.ISpriteInstance{},Keyboard:class extends self.IInstance{},thingybingy:class extends self.ISpriteInstance{},Turret:class extends self.ISpriteInstance{},Bullet:class extends self.ISpriteInstance{},triggeroflevel5:class extends self.ISpriteInstance{},Text3:class extends self.ITextInstance{},ls:class extends self.ISpriteInstance{},ls2:class extends self.ISpriteInstance{},ls3:class extends self.ISpriteInstance{},ls4:class extends self.ISpriteInstance{},fam_buttons:class extends self.ISpriteInstance{},fam_overlay:class extends self.ISpriteInstance{}},runOnStartup(async t=>{t.addEventListener("beforeprojectstart",()=>async function(t){t.addEventListener("tick",()=>{})}(t))});var Mt="collected_coins";globalThis.initCoins=function(t){const e=localStorage.getItem(Mt),s=e?JSON.parse(e):[],i=t.objects.Coin.getAllInstances();for(const t of i)s.includes(t.instVars.id)&&t.destroy()},globalThis.collectCoin=function(t){const e=t.instVars.id,s=localStorage.getItem(Mt);let i=s?JSON.parse(s):[];i.includes(e)||(i.push(e),localStorage.setItem(Mt,JSON.stringify(i)))},globalThis.resetCoinSave=function(){localStorage.removeItem(Mt)},globalThis.updateCoinUI=function(t){const e=localStorage.getItem(Mt),s=e?JSON.parse(e):[],i=t.objects.CoinText.getAllInstances();for(const t of i)t.text=s.length+"/5"},globalThis.fetchGoldenBallData=function(t){const e=localStorage.getItem("golden_ball");t.globalVars.is_golden_ball="true"==e},globalThis.setGoldenBall=function(t){localStorage.setItem("golden_ball",t)};var Pt={async Main_Event41_Act1(t,e){collectCoin(t.objects.Coin.getFirstPickedInstance()),updateCoinUI(t)},async Main_Event41_Act2(t,e){updateCoinUI(t)},async Main_Event42_Act1(t,e){initCoins(t)},async Main_Event42_Act2(t,e){updateCoinUI(t)},async Instruct_Event5_Act2(t,e){resetCoinSave()},async Main_Event1_Act24(t,e){fetchGoldenBallData(t)},async Victory_Event8_Act2(t,e){setGoldenBall("true")},async Instruct_Event5_Act3(t,e){setGoldenBall("false")}};globalThis.C3.JavaScriptInEvents=Pt;
/*!
@fileoverview gl-matrix - High performance matrix and vector operations
@author Brandon Jones
@author Colin MacKenzie IV
@version 3.4.1

Copyright (c) 2015-2021, Brandon Jones, Colin MacKenzie IV.

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.

*/