<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Realtime POS & Ticket System</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@600&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pocketbase/0.25.0/pocketbase.umd.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/beercss@3.9.7/dist/cdn/beer.min.css" rel="stylesheet">
    <script type="module" src="https://cdn.jsdelivr.net/npm/beercss@3.9.7/dist/cdn/beer.min.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/material-dynamic-colors@1.1.2/dist/cdn/material-dynamic-colors.min.js"></script>

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=add,done_all,edit" />
    <link rel="stylesheet" href="style.css" />
</head>
<body class="light">
    <div class="ticket-grid" id="ticketGrid">
        <div class="add-ticket ripple" id="addTicketBtn">
            <div><span class="material-symbols-outlined">add</span></div>
            <div>Add Ticket</div>
        </div>
    </div>

    <dialog class="left" id="ticketDialog">
        <h5 style="margin-bottom: 0.5em;">Create Ticket</h5>

        <ul style="gap:0.2em;" class="list">
            <li data-price="90" class="ripple">
                Croissant
            </li>
            <li data-price="90" class="ripple">
                Coffee
            </li>
            <li data-price="90" class="ripple">
                Tea
            </li>
            <li data-price="90" class="ripple">
                Cinnamon Roll
            </li>
            <li data-price="90" class="ripple">
                Smoothie
            </li>
        </ul>

        <div class="field label border">
            <input id="noteField" type="text" autocomplete="off">
            <label>Note</label>
        </div>

        <div class="field label border">
            <input id="nameField" type="text" autocomplete="off">
            <label>Name</label>
        </div>

        <nav class="right-align">
            <button id="cancelBtn" class="border">Cancel</button>
            <button id="ticketFormConfirm">Create</button>
        </nav>
    </dialog>
    <script>
        const pb = new PocketBase('https://petition.pockethost.io');
        pb.autoCancellation(false);
        const ticketGrid = document.getElementById('ticketGrid');
        const addTicketBtn = document.getElementById('addTicketBtn');
        const ticketDialog = document.getElementById('ticketDialog');
        const cancelBtn = document.getElementById('cancelBtn');
        const ticketFormConfirm = document.getElementById("ticketFormConfirm");
        const noteField = document.getElementById('noteField');
        const nameField = document.getElementById('nameField');

        let itemCounts = {};
        const listItems = ticketDialog.querySelectorAll('.list li');
        listItems.forEach(item =>
        {
            const text = item.textContent.trim();
            itemCounts[text] = 0;

            item.innerHTML = `<span class="item-name">${text}</span> <span class="item-count">0</span> <button class="minus" style="display: none;">-</button>`;

            item.addEventListener('click', (e) =>
            {
                if (e.target.classList.contains('minus')) return;
                itemCounts[text]++;
                item.querySelector('.item-count').textContent = itemCounts[text];
                const price = Number(item.getAttribute('data-price')) || 0;

                item.querySelector('.minus').style.display = 'inline';
                item.classList.add('selected');
            });

            // Decrease count when clicking minus button
            item.querySelector('.minus').addEventListener('click', (e) =>
            {
                e.stopPropagation();
                if (itemCounts[text] > 0)
                {
                    itemCounts[text]--;
                    item.querySelector('.item-count').textContent = itemCounts[text];
                    const price = Number(item.getAttribute('data-price')) || 0;

                    if (itemCounts[text] === 0)
                    {
                        item.querySelector('.minus').style.display = 'none';
                        item.classList.remove('selected');
                    }
                }
            });
        });

        async function loadTickets()
        {
            const result = await pb.collection('cafe_tickets').getFullList();
            ticketGrid.innerHTML = '';
            result.forEach(ticket =>
            {
                // Split items string into an array and count frequencies
                let items = ticket.items.split(',');
                let itemFreq = {};
                items.forEach(item =>
                {
                    item = item.trim();
                    if (item)
                    {
                        itemFreq[item] = (itemFreq[item] || 0) + 1;
                    }
                });
                // Build list HTML: remove underscore for display if present and add selected class
                let listHtml = Object.entries(itemFreq).map(([item, count]) =>
                {
                    const displayName = item.startsWith('_') ? item.slice(1) : item;
                    const selectedClass = item.startsWith('_') ? 'selected' : '';
                    return `<li class="${selectedClass} ripple" style="margin:10px; flex-grow:0;">${count + 'x '}${displayName}</li>`;
                }).join("");
                const div = document.createElement('div');
                div.className = 'ticket-item';
                div.innerHTML = `
                    <div style="font-size:1.5em; padding: 0.4em; border-bottom: 2px solid var(--outline)">${ticket.name}</div>
                    <ul class="list border">
                        ${listHtml}
                    </ul>
                    ${ticket.note != "" ? `<div>Note: ${ticket.note}</div>` : ``}
                    <div style="display:flex;">
                        <button style="border-radius:0; width:100%; background:var(--background); color: var(--inverse-surface)" class="edit ripple" data-id="${ticket.id}">
                            <span class="material-symbols-outlined">edit</span>
                        </button>
                    </div>
                `;
                ticketGrid.appendChild(div);
                // NEW: Attach click event to each ticket list item to toggle done state and update db
                const liElements = div.querySelectorAll('ul.list li');
                liElements.forEach(li =>
                {
                    // Set selected if item text starts with underscore
                    const matchInit = li.textContent.match(/^\d+x\s+(_?)(.*)$/);
                    if (matchInit && matchInit[1] === '_')
                    {
                        li.classList.add('selected');
                    }
                    li.addEventListener('click', async () =>
                    {
                        // Use regex to extract count and base name from text
                        const text = li.textContent;
                        const match = text.match(/^(\d+)x\s+(_?)(.*)$/);
                        if (!match) return;
                        const baseName = match[3];
                        let originalItems = ticket.items.split(',').map(s => s.trim());
                        let newItems;
                        if (li.classList.contains('selected'))
                        {
                            // Already done; remove underscore to mark undone
                            li.classList.remove('selected');
                            newItems = originalItems.map(it => (it === '_' + baseName ? baseName : it));
                        } else
                        {
                            // Not done; mark as done by adding underscore
                            li.classList.add('selected');
                            newItems = originalItems.map(it => (it === baseName ? '_' + it : it));
                        }
                        await pb.collection('cafe_tickets').update(ticket.id, { items: newItems.toString() });
                    });
                });
            });
            ticketGrid.appendChild(addTicketBtn);
        }

        addTicketBtn.addEventListener('click', () =>
        {
            noteField.value = '';
            nameField.value = '';
            // Reset counts and UI for list items
            ticketDialog.querySelectorAll('.list li').forEach(item =>
            {
                const text = item.querySelector('.item-name').textContent;
                itemCounts[text] = 0;
                item.querySelector('.item-count').textContent = '0';
                item.querySelector('.minus').style.display = 'none';
                item.classList.remove('selected');
            });
            ticketDialog.showModal();
        });

        cancelBtn.addEventListener('click', () =>
        {
            ticketDialog.close();
        });

        ticketFormConfirm.addEventListener('click', async (e) =>
        {
            e.preventDefault();
            // Convert counts to an array with repeated entries
            let itemsArray = [];
            for (let key in itemCounts)
            {
                for (let i = 0; i < itemCounts[key]; i++)
                {
                    itemsArray.push(key);
                }
            }
            const newTicket = {
                note: noteField.value,
                name: nameField.value,
                items: itemsArray.toString()
            };
            await pb.collection('cafe_tickets').create(newTicket);
            ticketDialog.close();
            loadTickets();
        });

        ticketGrid.addEventListener('click', async (e) =>
        {
            const target = e.target;
            if (target.classList.contains('delete'))
            {
                const id = target.dataset.id;
                await pb.collection('cafe_tickets').delete(id);
                loadTickets();
            } else if (target.classList.contains('edit'))
            {
                const id = target.dataset.id;
                const newTicket = prompt('Enter new ticket value:');
                if (newTicket)
                {
                    await pb.collection('cafe_tickets').update(id, { ticket: newTicket });
                    loadTickets();
                }
            }
        });

        loadTickets();
    </script>
</body>
</html>