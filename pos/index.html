<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache">
    <title>Realtime POS & Ticket System</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@600&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pocketbase/0.25.0/pocketbase.umd.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/beercss@3.9.7/dist/cdn/beer.min.css" rel="stylesheet">
    <script type="module" src="https://cdn.jsdelivr.net/npm/beercss@3.9.7/dist/cdn/beer.min.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/material-dynamic-colors@1.1.2/dist/cdn/material-dynamic-colors.min.js"></script>

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=add,done_all,edit" />
    <link rel="stylesheet" href="style.css" />
</head>
<body class="light">
    <h1>SASSCUM</h1>
    <h6>(Cafe Ultimate Manager)</h6>
    <div class="ticket-grid" id="ticketGrid">
        <div class="add-ticket ripple" id="addTicketBtn">
            <div><span class="material-symbols-outlined">add</span></div>
            <div>Add Ticket</div>
        </div>
    </div>

    <div id="dialogOverlay"></div>
    <dialog class="bottom" id="ticketDialog">

        <h5 style="margin-bottom: 0.5em;">Create Ticket</h5>

        <!-- Modified: load food items dynamically from cafe_items -->
        <ul style="gap:0.2em;" class="list" id="foodList">
            <!-- Dynamic food items will be loaded from cafe_items -->
        </ul>

        <div class="field label border">
            <input id="noteField" type="text" autocomplete="off">
            <label>Note</label>
        </div>

        <div class="field label border">
            <input id="nameField" type="text" autocomplete="off">
            <label>Name</label>
        </div>

        <div id="ticketTotal" style="text-align: right; font-weight: bold; margin-top: 1em;">
            Total: $0.00
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1em;">
            <div style="flex: 1; margin-right: 1em;">
                <div class="field label border">
                    <input id="customerGave" type="number" style="width: 100%; padding: 0.5em;" />
                    <label>Customer Gave</label>
                </div>

            </div>
            <div id="changeAmount" style="flex: 1; text-align: right; font-weight: bold;">
                Change: $0.00
            </div>
        </div>
        <nav class="right-align">
            <button id="cancelBtn" class="border">Cancel</button>
            <button id="ticketFormConfirm">Create</button>
        </nav>
    </dialog>
    <script>
        const pb = new PocketBase('https://petition.pockethost.io');
        pb.autoCancellation(false);
        const ticketGrid = document.getElementById('ticketGrid');
        const addTicketBtn = document.getElementById('addTicketBtn');
        const ticketDialog = document.getElementById('ticketDialog');
        const cancelBtn = document.getElementById('cancelBtn');
        const ticketFormConfirm = document.getElementById("ticketFormConfirm");
        const noteField = document.getElementById('noteField');
        const nameField = document.getElementById('nameField');
        const ticketTotal = document.getElementById('ticketTotal');
        const customerGave = document.getElementById('customerGave');
        const changeAmount = document.getElementById('changeAmount');

        ticketDialog.addEventListener('close', () =>
        {
            dialogOverlay.style.opacity = "0";
        });

        let itemCounts = {}, itemMap = {};

        // Added: function to fetch and load food items from "cafe_items"
        async function loadFoodItems()
        {
            const foodList = document.getElementById('foodList');
            const items = await pb.collection('cafe_items').getFullList();
            foodList.innerHTML = '';
            itemCounts = {};
            itemMap = {};
            items.forEach(item =>
            {
                const li = document.createElement('li');
                li.className = 'ripple';
                li.setAttribute('data-id', item.id); // <-- new line for relationship id
                li.setAttribute('data-price', item.price);
                li.innerHTML = `<span class="item-name">${item.name}</span> <span class="item-count">0</span> <button class="minus" style="display: none;">-</button>`;
                const name = item.name;
                itemCounts[name] = 0;
                itemMap[name] = li;

                li.addEventListener('click', e =>
                {
                    if (e.target.classList.contains('minus')) return;
                    itemCounts[name]++;
                    li.querySelector('.item-count').textContent = itemCounts[name];
                    li.querySelector('.minus').style.display = 'inline';
                    li.classList.add('selected');
                    updateTotal();
                });

                li.querySelector('.minus').addEventListener('click', e =>
                {
                    e.stopPropagation();
                    if (itemCounts[name] > 0)
                    {
                        itemCounts[name]--;
                        li.querySelector('.item-count').textContent = itemCounts[name];
                        if (itemCounts[name] === 0)
                        {
                            li.querySelector('.minus').style.display = 'none';
                            li.classList.remove('selected');
                        }
                        updateTotal();
                    }
                });
                foodList.appendChild(li);
            });
        }

        async function loadTickets()
        {
            const result = await pb.collection('cafe_tickets').getFullList({ expand: "items, ready_items" });
            ticketGrid.innerHTML = '';

            result.forEach(ticket =>
            {
                // Build frequency maps for not-ready and ready items
                const getName = (itemId) =>
                {
                    let name = itemId;
                    if (ticket.expand)
                    {
                        if (ticket.expand.items)
                        {
                            const found = ticket.expand.items.find(exp => exp.id === itemId);
                            if (found) return found.name;
                        }
                        if (ticket.expand.ready_items)
                        {
                            const found = ticket.expand.ready_items.find(exp => exp.id === itemId);
                            if (found) return found.name;
                        }
                    }
                    return name;
                };

                const notReadyFreq = (ticket.items || []).reduce((acc, id) =>
                {
                    const name = getName(id);
                    if (!acc[name])
                    {
                        acc[name] = { count: 0, foodId: id };
                    }
                    acc[name].count++;
                    return acc;
                }, {});
                const readyFreq = (ticket.ready_items || []).reduce((acc, id) =>
                {
                    const name = getName(id);
                    if (!acc[name])
                    {
                        acc[name] = { count: 0, foodId: id };
                    }
                    acc[name].count++;
                    return acc;
                }, {});
                const notReadyHtml = Object.entries(notReadyFreq).map(([name, obj]) =>
                {
                    return `<li class="ripple" data-id="${obj.foodId}" data-food-name="${name}" data-ticket-id="${ticket.id}">${obj.count}x ${name}</li>`;
                }).join("");
                const readyHtml = Object.entries(readyFreq).map(([name, obj]) =>
                {
                    return `<li class="ripple selected" data-id="${obj.foodId}" data-food-name="${name}" data-ticket-id="${ticket.id}">${obj.count}x ${name}</li>`;
                }).join("");

                const listHtml = notReadyHtml + readyHtml;

                // Create ticket element
                const div = document.createElement('div');
                div.className = 'ticket-item';
                div.innerHTML = `
            <div style="font-size:1.5em; padding: 0.4em; border-bottom: 2px solid var(--outline)">${ticket.name}</div>
            <ul style="margin:10px; gap:5px;" class="list">${listHtml}</ul>
            ${ticket.note ? `<div>Note: ${ticket.note}</div>` : ''}
            <div style="display:flex;">
                <button class="edit ripple" style="border-radius:0; width:100%; background:var(--background); color:var(--inverse-surface)" data-id="${ticket.id}">
                    <span class="material-symbols-outlined">edit</span>
                </button>
            </div>
        `;
                ticketGrid.appendChild(div);

                // Attach click event to not-ready items to mark them as ready
                const liElements = div.querySelectorAll('ul.list li.ripple:not(.selected)');
                liElements.forEach(li =>
                {
                    li.addEventListener('click', async (e) =>
                    {
                        e.stopPropagation();
                        const foodId = li.getAttribute('data-id');
                        const ticketId = li.getAttribute('data-ticket-id');
                        // Remove one occurrence from items and add it to ready_items
                        const newItems = [...(ticket.items || [])];
                        const index = newItems.indexOf(foodId);
                        if (index > -1)
                        {
                            newItems.splice(index, 1);
                            const newReady = [...(ticket.ready_items || []), foodId];
                            e.target.classList.toggle("selected");
                            await pb.collection('cafe_tickets').update(ticketId, { items: newItems, ready_items: newReady });
                        }
                    });
                });
                // Added: Attach click event to ready items to mark them as not ready
                const readyLiElements = div.querySelectorAll('ul.list li.ripple.selected');
                readyLiElements.forEach(li =>
                {
                    li.addEventListener('click', async (e) =>
                    {
                        e.stopPropagation();
                        const foodId = li.getAttribute('data-id');
                        const ticketId = li.getAttribute('data-ticket-id');
                        // Remove one occurrence from ready_items and add it back to items
                        const newReady = [...(ticket.ready_items || [])];
                        const index = newReady.indexOf(foodId);
                        if (index > -1)
                        {
                            newReady.splice(index, 1);
                            const newItems = [...(ticket.items || []), foodId];
                            e.target.classList.toggle("selected");
                            await pb.collection('cafe_tickets').update(ticketId, { items: newItems, ready_items: newReady });
                        }
                    });
                });
            });

            ticketGrid.appendChild(addTicketBtn);
        }

        //OPEN TICKET DIALOG
        addTicketBtn.addEventListener('click', () =>
        {
            noteField.value = '';
            nameField.value = '';
            const foodList = document.getElementById('foodList');
            foodList.querySelectorAll('li').forEach(item =>
            {
                const n = item.querySelector('.item-name').textContent;
                itemCounts[n] = 0;
                item.querySelector('.item-count').textContent = '0';
                item.querySelector('.minus').style.display = 'none';
                item.classList.remove('selected');
            });
            customerGave.value = '';
            changeAmount.textContent = 'Change: €0.00';
            ticketDialog.showModal();
            dialogOverlay.style.opacity = "0.6";
            updateTotal();
        });

        //CANCEL TICKET CREATION
        cancelBtn.addEventListener('click', () =>
        {
            ticketDialog.close();
        });

        //CREATING TICKET
        ticketFormConfirm.addEventListener('click', async (e) =>
        {
            e.preventDefault();
            let itemsArray = [];
            const foodList = document.getElementById('foodList');
            foodList.querySelectorAll('li').forEach(li =>
            {
                const count = Number(li.querySelector('.item-count').textContent) || 0;
                if (count > 0)
                {
                    const foodId = li.getAttribute('data-id');
                    for (let i = 0; i < count; i++)
                    {
                        itemsArray.push(foodId);
                    }
                }
            });
            const newTicket = {
                note: noteField.value,
                name: nameField.value,
                items: itemsArray  // now an array of food IDs
            };
            await pb.collection('cafe_tickets').create(newTicket);
            ticketDialog.close();
            updateTotal();
            customerGave.value = '';
            changeAmount.textContent = 'Change: €0.00';
        });

        ticketGrid.addEventListener('click', async (e) =>
        {
            const target = e.target;
            if (target.classList.contains('delete'))
            {
                const id = target.dataset.id;
                await pb.collection('cafe_tickets').delete(id);
            }
        });

        const updateChange = () =>
        {
            const total = parseFloat(ticketTotal.textContent.replace('Total: €', '')) || 0;
            const given = parseFloat(customerGave.value) || 0;
            const change = (given - total).toFixed(2);
            changeAmount.textContent = `Change: €${change}`;
            changeAmount.style.color = given < total ? "var(--error)" : "";
        };

        customerGave.addEventListener('input', updateChange);

        const updateTotal = () =>
        {
            const total = Object.entries(itemCounts).reduce((sum, [name, count]) =>
            {
                const price = Number(itemMap[name].getAttribute('data-price')) || 0;
                return sum + count * price;
            }, 0);
            ticketTotal.textContent = `Total: €${total.toFixed(2)}`;
            updateChange();
        };

        // Add realtime subscription for cafe_tickets changes
        pb.collection('cafe_tickets').subscribe('*', (e) =>
        {
            loadTickets();
        });

        // Initial load of tickets
        loadTickets();

        // Fetch dynamic food items on initial load
        loadFoodItems();
    </script>
</body>
</html>